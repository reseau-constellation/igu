import{b as it,S as Oe,g as st,r as ge,i as Kt,e as yi,a as Vo,f as Uo,m as Nr,L as Dr,M as wt,c as pi,t as De,s as mi,d as me,h as oe,j as ce,k as de,l as Tt,n as Fo}from"./index-illcgN2a.js";import{x as Go,a0 as Yo,e as yn,H as cr,G as gi}from"./index-IvUeTVj7.js";import{d as kr}from"./browser-Lotc6lk-.js";import"./path-U4uEi1u4.js";function ue(e){return e!=null&&typeof e=="object"}var Wo="[object Symbol]";function Pr(e){return typeof e=="symbol"||ue(e)&&it(e)==Wo}function zo(e,t){for(var r=-1,n=e==null?0:e.length,i=Array(n);++r<n;)i[r]=t(e[r],r,e);return i}var re=Array.isArray,Jo=1/0,pn=Oe?Oe.prototype:void 0,mn=pn?pn.toString:void 0;function Ei(e){if(typeof e=="string")return e;if(re(e))return zo(e,Ei)+"";if(Pr(e))return mn?mn.call(e):"";var t=e+"";return t=="0"&&1/e==-Jo?"-0":t}function qo(e){return e}var ur=st(ge,"WeakMap"),gn=Object.create,Xo=function(){function e(){}return function(t){if(!Kt(t))return{};if(gn)return gn(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}();function Qo(){}function Zo(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t}var En=function(){try{var e=st(Object,"defineProperty");return e({},"",{}),e}catch{}}();function ea(e,t){for(var r=-1,n=e==null?0:e.length;++r<n&&t(e[r],r,e)!==!1;);return e}function ta(e,t,r,n){for(var i=e.length,s=r+(n?1:-1);n?s--:++s<i;)if(t(e[s],s,e))return s;return-1}function ra(e){return e!==e}function na(e,t,r){for(var n=r-1,i=e.length;++n<i;)if(e[n]===t)return n;return-1}function ia(e,t,r){return t===t?na(e,t,r):ta(e,ra,r)}function sa(e,t){var r=e==null?0:e.length;return!!r&&ia(e,t,0)>-1}var oa=9007199254740991,aa=/^(?:0|[1-9]\d*)$/;function bi(e,t){var r=typeof e;return t=t??oa,!!t&&(r=="number"||r!="symbol"&&aa.test(e))&&e>-1&&e%1==0&&e<t}function Ii(e,t,r){t=="__proto__"&&En?En(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}var ca=Object.prototype,ua=ca.hasOwnProperty;function Si(e,t,r){var n=e[t];(!(ua.call(e,t)&&yi(n,r))||r===void 0&&!(t in e))&&Ii(e,t,r)}function Bt(e,t,r,n){var i=!r;r||(r={});for(var s=-1,o=t.length;++s<o;){var a=t[s],c=n?n(r[a],e[a],a,r,e):void 0;c===void 0&&(c=e[a]),i?Ii(r,a,c):Si(r,a,c)}return r}var da=9007199254740991;function Cr(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=da}function wi(e){return e!=null&&Cr(e.length)&&!Vo(e)}var la=Object.prototype;function $r(e){var t=e&&e.constructor,r=typeof t=="function"&&t.prototype||la;return e===r}function fa(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}var ha="[object Arguments]";function bn(e){return ue(e)&&it(e)==ha}var Ti=Object.prototype,va=Ti.hasOwnProperty,ya=Ti.propertyIsEnumerable,_i=bn(function(){return arguments}())?bn:function(e){return ue(e)&&va.call(e,"callee")&&!ya.call(e,"callee")};function pa(){return!1}var Ai=typeof exports=="object"&&exports&&!exports.nodeType&&exports,In=Ai&&typeof module=="object"&&module&&!module.nodeType&&module,ma=In&&In.exports===Ai,Sn=ma?ge.Buffer:void 0,ga=Sn?Sn.isBuffer:void 0,_t=ga||pa,Ea="[object Arguments]",ba="[object Array]",Ia="[object Boolean]",Sa="[object Date]",wa="[object Error]",Ta="[object Function]",_a="[object Map]",Aa="[object Number]",Ma="[object Object]",xa="[object RegExp]",Oa="[object Set]",Ra="[object String]",La="[object WeakMap]",Na="[object ArrayBuffer]",Da="[object DataView]",ka="[object Float32Array]",Pa="[object Float64Array]",Ca="[object Int8Array]",$a="[object Int16Array]",Ka="[object Int32Array]",Ba="[object Uint8Array]",Ha="[object Uint8ClampedArray]",ja="[object Uint16Array]",Va="[object Uint32Array]",B={};B[ka]=B[Pa]=B[Ca]=B[$a]=B[Ka]=B[Ba]=B[Ha]=B[ja]=B[Va]=!0;B[Ea]=B[ba]=B[Na]=B[Ia]=B[Da]=B[Sa]=B[wa]=B[Ta]=B[_a]=B[Aa]=B[Ma]=B[xa]=B[Oa]=B[Ra]=B[La]=!1;function Ua(e){return ue(e)&&Cr(e.length)&&!!B[it(e)]}function Kr(e){return function(t){return e(t)}}var Mi=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Ve=Mi&&typeof module=="object"&&module&&!module.nodeType&&module,Fa=Ve&&Ve.exports===Mi,qt=Fa&&Uo.process,Re=function(){try{var e=Ve&&Ve.require&&Ve.require("util").types;return e||qt&&qt.binding&&qt.binding("util")}catch{}}(),wn=Re&&Re.isTypedArray,xi=wn?Kr(wn):Ua,Ga=Object.prototype,Ya=Ga.hasOwnProperty;function Oi(e,t){var r=re(e),n=!r&&_i(e),i=!r&&!n&&_t(e),s=!r&&!n&&!i&&xi(e),o=r||n||i||s,a=o?fa(e.length,String):[],c=a.length;for(var u in e)(t||Ya.call(e,u))&&!(o&&(u=="length"||i&&(u=="offset"||u=="parent")||s&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||bi(u,c)))&&a.push(u);return a}function Ri(e,t){return function(r){return e(t(r))}}var Wa=Ri(Object.keys,Object),za=Object.prototype,Ja=za.hasOwnProperty;function qa(e){if(!$r(e))return Wa(e);var t=[];for(var r in Object(e))Ja.call(e,r)&&r!="constructor"&&t.push(r);return t}function Ht(e){return wi(e)?Oi(e):qa(e)}function Xa(e){var t=[];if(e!=null)for(var r in Object(e))t.push(r);return t}var Qa=Object.prototype,Za=Qa.hasOwnProperty;function ec(e){if(!Kt(e))return Xa(e);var t=$r(e),r=[];for(var n in e)n=="constructor"&&(t||!Za.call(e,n))||r.push(n);return r}function Br(e){return wi(e)?Oi(e,!0):ec(e)}var tc=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,rc=/^\w*$/;function Hr(e,t){if(re(e))return!1;var r=typeof e;return r=="number"||r=="symbol"||r=="boolean"||e==null||Pr(e)?!0:rc.test(e)||!tc.test(e)||t!=null&&e in Object(t)}var nc=500;function ic(e){var t=Nr(e,function(n){return r.size===nc&&r.clear(),n}),r=t.cache;return t}var sc=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,oc=/\\(\\)?/g,ac=ic(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(sc,function(r,n,i,s){t.push(i?s.replace(oc,"$1"):n||r)}),t});function cc(e){return e==null?"":Ei(e)}function Li(e,t){return re(e)?e:Hr(e,t)?[e]:ac(cc(e))}var uc=1/0;function jt(e){if(typeof e=="string"||Pr(e))return e;var t=e+"";return t=="0"&&1/e==-uc?"-0":t}function Ni(e,t){t=Li(t,e);for(var r=0,n=t.length;e!=null&&r<n;)e=e[jt(t[r++])];return r&&r==n?e:void 0}function dc(e,t,r){var n=e==null?void 0:Ni(e,t);return n===void 0?r:n}function Di(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e}var lc=Ri(Object.getPrototypeOf,Object);const ki=lc;function fc(){this.__data__=new Dr,this.size=0}function hc(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r}function vc(e){return this.__data__.get(e)}function yc(e){return this.__data__.has(e)}var pc=200;function mc(e,t){var r=this.__data__;if(r instanceof Dr){var n=r.__data__;if(!wt||n.length<pc-1)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new pi(n)}return r.set(e,t),this.size=r.size,this}function te(e){var t=this.__data__=new Dr(e);this.size=t.size}te.prototype.clear=fc;te.prototype.delete=hc;te.prototype.get=vc;te.prototype.has=yc;te.prototype.set=mc;function gc(e,t){return e&&Bt(t,Ht(t),e)}function Ec(e,t){return e&&Bt(t,Br(t),e)}var Pi=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Tn=Pi&&typeof module=="object"&&module&&!module.nodeType&&module,bc=Tn&&Tn.exports===Pi,_n=bc?ge.Buffer:void 0,An=_n?_n.allocUnsafe:void 0;function Ic(e,t){if(t)return e.slice();var r=e.length,n=An?An(r):new e.constructor(r);return e.copy(n),n}function Sc(e,t){for(var r=-1,n=e==null?0:e.length,i=0,s=[];++r<n;){var o=e[r];t(o,r,e)&&(s[i++]=o)}return s}function Ci(){return[]}var wc=Object.prototype,Tc=wc.propertyIsEnumerable,Mn=Object.getOwnPropertySymbols,jr=Mn?function(e){return e==null?[]:(e=Object(e),Sc(Mn(e),function(t){return Tc.call(e,t)}))}:Ci;function _c(e,t){return Bt(e,jr(e),t)}var Ac=Object.getOwnPropertySymbols,$i=Ac?function(e){for(var t=[];e;)Di(t,jr(e)),e=ki(e);return t}:Ci;function Mc(e,t){return Bt(e,$i(e),t)}function Ki(e,t,r){var n=t(e);return re(e)?n:Di(n,r(e))}function dr(e){return Ki(e,Ht,jr)}function xc(e){return Ki(e,Br,$i)}var lr=st(ge,"DataView"),fr=st(ge,"Promise"),Ae=st(ge,"Set"),xn="[object Map]",Oc="[object Object]",On="[object Promise]",Rn="[object Set]",Ln="[object WeakMap]",Nn="[object DataView]",Rc=De(lr),Lc=De(wt),Nc=De(fr),Dc=De(Ae),kc=De(ur),he=it;(lr&&he(new lr(new ArrayBuffer(1)))!=Nn||wt&&he(new wt)!=xn||fr&&he(fr.resolve())!=On||Ae&&he(new Ae)!=Rn||ur&&he(new ur)!=Ln)&&(he=function(e){var t=it(e),r=t==Oc?e.constructor:void 0,n=r?De(r):"";if(n)switch(n){case Rc:return Nn;case Lc:return xn;case Nc:return On;case Dc:return Rn;case kc:return Ln}return t});const ze=he;var Pc=Object.prototype,Cc=Pc.hasOwnProperty;function $c(e){var t=e.length,r=new e.constructor(t);return t&&typeof e[0]=="string"&&Cc.call(e,"index")&&(r.index=e.index,r.input=e.input),r}var At=ge.Uint8Array;function Vr(e){var t=new e.constructor(e.byteLength);return new At(t).set(new At(e)),t}function Kc(e,t){var r=t?Vr(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}var Bc=/\w*$/;function Hc(e){var t=new e.constructor(e.source,Bc.exec(e));return t.lastIndex=e.lastIndex,t}var Dn=Oe?Oe.prototype:void 0,kn=Dn?Dn.valueOf:void 0;function jc(e){return kn?Object(kn.call(e)):{}}function Vc(e,t){var r=t?Vr(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}var Uc="[object Boolean]",Fc="[object Date]",Gc="[object Map]",Yc="[object Number]",Wc="[object RegExp]",zc="[object Set]",Jc="[object String]",qc="[object Symbol]",Xc="[object ArrayBuffer]",Qc="[object DataView]",Zc="[object Float32Array]",eu="[object Float64Array]",tu="[object Int8Array]",ru="[object Int16Array]",nu="[object Int32Array]",iu="[object Uint8Array]",su="[object Uint8ClampedArray]",ou="[object Uint16Array]",au="[object Uint32Array]";function cu(e,t,r){var n=e.constructor;switch(t){case Xc:return Vr(e);case Uc:case Fc:return new n(+e);case Qc:return Kc(e,r);case Zc:case eu:case tu:case ru:case nu:case iu:case su:case ou:case au:return Vc(e,r);case Gc:return new n;case Yc:case Jc:return new n(e);case Wc:return Hc(e);case zc:return new n;case qc:return jc(e)}}function uu(e){return typeof e.constructor=="function"&&!$r(e)?Xo(ki(e)):{}}var du="[object Map]";function lu(e){return ue(e)&&ze(e)==du}var Pn=Re&&Re.isMap,fu=Pn?Kr(Pn):lu,hu="[object Set]";function vu(e){return ue(e)&&ze(e)==hu}var Cn=Re&&Re.isSet,yu=Cn?Kr(Cn):vu,pu=1,mu=2,gu=4,Bi="[object Arguments]",Eu="[object Array]",bu="[object Boolean]",Iu="[object Date]",Su="[object Error]",Hi="[object Function]",wu="[object GeneratorFunction]",Tu="[object Map]",_u="[object Number]",ji="[object Object]",Au="[object RegExp]",Mu="[object Set]",xu="[object String]",Ou="[object Symbol]",Ru="[object WeakMap]",Lu="[object ArrayBuffer]",Nu="[object DataView]",Du="[object Float32Array]",ku="[object Float64Array]",Pu="[object Int8Array]",Cu="[object Int16Array]",$u="[object Int32Array]",Ku="[object Uint8Array]",Bu="[object Uint8ClampedArray]",Hu="[object Uint16Array]",ju="[object Uint32Array]",$={};$[Bi]=$[Eu]=$[Lu]=$[Nu]=$[bu]=$[Iu]=$[Du]=$[ku]=$[Pu]=$[Cu]=$[$u]=$[Tu]=$[_u]=$[ji]=$[Au]=$[Mu]=$[xu]=$[Ou]=$[Ku]=$[Bu]=$[Hu]=$[ju]=!0;$[Su]=$[Hi]=$[Ru]=!1;function gt(e,t,r,n,i,s){var o,a=t&pu,c=t&mu,u=t&gu;if(r&&(o=i?r(e,n,i,s):r(e)),o!==void 0)return o;if(!Kt(e))return e;var d=re(e);if(d){if(o=$c(e),!a)return Zo(e,o)}else{var f=ze(e),l=f==Hi||f==wu;if(_t(e))return Ic(e,a);if(f==ji||f==Bi||l&&!i){if(o=c||l?{}:uu(e),!a)return c?Mc(e,Ec(o,e)):_c(e,gc(o,e))}else{if(!$[f])return i?e:{};o=cu(e,f,a)}}s||(s=new te);var v=s.get(e);if(v)return v;s.set(e,o),yu(e)?e.forEach(function(y){o.add(gt(y,t,r,y,e,s))}):fu(e)&&e.forEach(function(y,g){o.set(g,gt(y,t,r,g,e,s))});var m=u?c?xc:dr:c?Br:Ht,p=d?void 0:m(e);return ea(p||e,function(y,g){p&&(g=y,y=e[g]),Si(o,g,gt(y,t,r,g,e,s))}),o}var Vu=4;function Uu(e){return gt(e,Vu)}var Fu="__lodash_hash_undefined__";function Gu(e){return this.__data__.set(e,Fu),this}function Yu(e){return this.__data__.has(e)}function Je(e){var t=-1,r=e==null?0:e.length;for(this.__data__=new pi;++t<r;)this.add(e[t])}Je.prototype.add=Je.prototype.push=Gu;Je.prototype.has=Yu;function Wu(e,t){for(var r=-1,n=e==null?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}function Vi(e,t){return e.has(t)}var zu=1,Ju=2;function Ui(e,t,r,n,i,s){var o=r&zu,a=e.length,c=t.length;if(a!=c&&!(o&&c>a))return!1;var u=s.get(e),d=s.get(t);if(u&&d)return u==t&&d==e;var f=-1,l=!0,v=r&Ju?new Je:void 0;for(s.set(e,t),s.set(t,e);++f<a;){var m=e[f],p=t[f];if(n)var y=o?n(p,m,f,t,e,s):n(m,p,f,e,t,s);if(y!==void 0){if(y)continue;l=!1;break}if(v){if(!Wu(t,function(g,E){if(!Vi(v,E)&&(m===g||i(m,g,r,n,s)))return v.push(E)})){l=!1;break}}else if(!(m===p||i(m,p,r,n,s))){l=!1;break}}return s.delete(e),s.delete(t),l}function qu(e){var t=-1,r=Array(e.size);return e.forEach(function(n,i){r[++t]=[i,n]}),r}function Ur(e){var t=-1,r=Array(e.size);return e.forEach(function(n){r[++t]=n}),r}var Xu=1,Qu=2,Zu="[object Boolean]",ed="[object Date]",td="[object Error]",rd="[object Map]",nd="[object Number]",id="[object RegExp]",sd="[object Set]",od="[object String]",ad="[object Symbol]",cd="[object ArrayBuffer]",ud="[object DataView]",$n=Oe?Oe.prototype:void 0,Xt=$n?$n.valueOf:void 0;function dd(e,t,r,n,i,s,o){switch(r){case ud:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case cd:return!(e.byteLength!=t.byteLength||!s(new At(e),new At(t)));case Zu:case ed:case nd:return yi(+e,+t);case td:return e.name==t.name&&e.message==t.message;case id:case od:return e==t+"";case rd:var a=qu;case sd:var c=n&Xu;if(a||(a=Ur),e.size!=t.size&&!c)return!1;var u=o.get(e);if(u)return u==t;n|=Qu,o.set(e,t);var d=Ui(a(e),a(t),n,i,s,o);return o.delete(e),d;case ad:if(Xt)return Xt.call(e)==Xt.call(t)}return!1}var ld=1,fd=Object.prototype,hd=fd.hasOwnProperty;function vd(e,t,r,n,i,s){var o=r&ld,a=dr(e),c=a.length,u=dr(t),d=u.length;if(c!=d&&!o)return!1;for(var f=c;f--;){var l=a[f];if(!(o?l in t:hd.call(t,l)))return!1}var v=s.get(e),m=s.get(t);if(v&&m)return v==t&&m==e;var p=!0;s.set(e,t),s.set(t,e);for(var y=o;++f<c;){l=a[f];var g=e[l],E=t[l];if(n)var w=o?n(E,g,l,t,e,s):n(g,E,l,e,t,s);if(!(w===void 0?g===E||i(g,E,r,n,s):w)){p=!1;break}y||(y=l=="constructor")}if(p&&!y){var S=e.constructor,A=t.constructor;S!=A&&"constructor"in e&&"constructor"in t&&!(typeof S=="function"&&S instanceof S&&typeof A=="function"&&A instanceof A)&&(p=!1)}return s.delete(e),s.delete(t),p}var yd=1,Kn="[object Arguments]",Bn="[object Array]",ft="[object Object]",pd=Object.prototype,Hn=pd.hasOwnProperty;function md(e,t,r,n,i,s){var o=re(e),a=re(t),c=o?Bn:ze(e),u=a?Bn:ze(t);c=c==Kn?ft:c,u=u==Kn?ft:u;var d=c==ft,f=u==ft,l=c==u;if(l&&_t(e)){if(!_t(t))return!1;o=!0,d=!1}if(l&&!d)return s||(s=new te),o||xi(e)?Ui(e,t,r,n,i,s):dd(e,t,c,r,n,i,s);if(!(r&yd)){var v=d&&Hn.call(e,"__wrapped__"),m=f&&Hn.call(t,"__wrapped__");if(v||m){var p=v?e.value():e,y=m?t.value():t;return s||(s=new te),i(p,y,r,n,s)}}return l?(s||(s=new te),vd(e,t,r,n,i,s)):!1}function Fr(e,t,r,n,i){return e===t?!0:e==null||t==null||!ue(e)&&!ue(t)?e!==e&&t!==t:md(e,t,r,n,Fr,i)}var gd=1,Ed=2;function bd(e,t,r,n){var i=r.length,s=i,o=!n;if(e==null)return!s;for(e=Object(e);i--;){var a=r[i];if(o&&a[2]?a[1]!==e[a[0]]:!(a[0]in e))return!1}for(;++i<s;){a=r[i];var c=a[0],u=e[c],d=a[1];if(o&&a[2]){if(u===void 0&&!(c in e))return!1}else{var f=new te;if(n)var l=n(u,d,c,e,t,f);if(!(l===void 0?Fr(d,u,gd|Ed,n,f):l))return!1}}return!0}function Fi(e){return e===e&&!Kt(e)}function Id(e){for(var t=Ht(e),r=t.length;r--;){var n=t[r],i=e[n];t[r]=[n,i,Fi(i)]}return t}function Gi(e,t){return function(r){return r==null?!1:r[e]===t&&(t!==void 0||e in Object(r))}}function Sd(e){var t=Id(e);return t.length==1&&t[0][2]?Gi(t[0][0],t[0][1]):function(r){return r===e||bd(r,e,t)}}function wd(e,t){return e!=null&&t in Object(e)}function Td(e,t,r){t=Li(t,e);for(var n=-1,i=t.length,s=!1;++n<i;){var o=jt(t[n]);if(!(s=e!=null&&r(e,o)))break;e=e[o]}return s||++n!=i?s:(i=e==null?0:e.length,!!i&&Cr(i)&&bi(o,i)&&(re(e)||_i(e)))}function _d(e,t){return e!=null&&Td(e,t,wd)}var Ad=1,Md=2;function xd(e,t){return Hr(e)&&Fi(t)?Gi(jt(e),t):function(r){var n=dc(r,e);return n===void 0&&n===t?_d(r,e):Fr(t,n,Ad|Md)}}function Od(e){return function(t){return t?.[e]}}function Rd(e){return function(t){return Ni(t,e)}}function Ld(e){return Hr(e)?Od(jt(e)):Rd(e)}function Nd(e){return typeof e=="function"?e:e==null?qo:typeof e=="object"?re(e)?xd(e[0],e[1]):Sd(e):Ld(e)}function Dd(e,t,r){for(var n=-1,i=e==null?0:e.length;++n<i;)if(r(t,e[n]))return!0;return!1}var kd=1/0,Pd=Ae&&1/Ur(new Ae([,-0]))[1]==kd?function(e){return new Ae(e)}:Qo,Cd=200;function Yi(e,t,r){var n=-1,i=sa,s=e.length,o=!0,a=[],c=a;if(r)o=!1,i=Dd;else if(s>=Cd){var u=t?null:Pd(e);if(u)return Ur(u);o=!1,i=Vi,c=new Je}else c=t?[]:a;e:for(;++n<s;){var d=e[n],f=t?t(d):d;if(d=r||d!==0?d:0,o&&f===f){for(var l=c.length;l--;)if(c[l]===f)continue e;t&&c.push(f),a.push(d)}else i(c,f,r)||(c!==a&&c.push(f),a.push(d))}return a}function Gr(e){return e&&e.length?Yi(e):[]}function $d(e,t){return e&&e.length?Yi(e,Nd(t)):[]}var le={},K={},W={};Object.defineProperty(W,"__esModule",{value:!0});W.output=W.exists=W.hash=W.bytes=W.bool=W.number=void 0;function Mt(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}W.number=Mt;function Wi(e){if(typeof e!="boolean")throw new Error(`Expected boolean, not ${e}`)}W.bool=Wi;function Kd(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}function Yr(e,...t){if(!Kd(e))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}W.bytes=Yr;function zi(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Mt(e.outputLen),Mt(e.blockLen)}W.hash=zi;function Ji(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}W.exists=Ji;function qi(e,t){Yr(e);const r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}W.output=qi;const Bd={number:Mt,bool:Wi,bytes:Yr,hash:zi,exists:Ji,output:qi};W.default=Bd;var T={};Object.defineProperty(T,"__esModule",{value:!0});T.add5L=T.add5H=T.add4H=T.add4L=T.add3H=T.add3L=T.add=T.rotlBL=T.rotlBH=T.rotlSL=T.rotlSH=T.rotr32L=T.rotr32H=T.rotrBL=T.rotrBH=T.rotrSL=T.rotrSH=T.shrSL=T.shrSH=T.toBig=T.split=T.fromBig=void 0;const ht=BigInt(2**32-1),hr=BigInt(32);function Wr(e,t=!1){return t?{h:Number(e&ht),l:Number(e>>hr&ht)}:{h:Number(e>>hr&ht)|0,l:Number(e&ht)|0}}T.fromBig=Wr;function Xi(e,t=!1){let r=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let i=0;i<e.length;i++){const{h:s,l:o}=Wr(e[i],t);[r[i],n[i]]=[s,o]}return[r,n]}T.split=Xi;const Qi=(e,t)=>BigInt(e>>>0)<<hr|BigInt(t>>>0);T.toBig=Qi;const Zi=(e,t,r)=>e>>>r;T.shrSH=Zi;const es=(e,t,r)=>e<<32-r|t>>>r;T.shrSL=es;const ts=(e,t,r)=>e>>>r|t<<32-r;T.rotrSH=ts;const rs=(e,t,r)=>e<<32-r|t>>>r;T.rotrSL=rs;const ns=(e,t,r)=>e<<64-r|t>>>r-32;T.rotrBH=ns;const is=(e,t,r)=>e>>>r-32|t<<64-r;T.rotrBL=is;const ss=(e,t)=>t;T.rotr32H=ss;const os=(e,t)=>e;T.rotr32L=os;const as=(e,t,r)=>e<<r|t>>>32-r;T.rotlSH=as;const cs=(e,t,r)=>t<<r|e>>>32-r;T.rotlSL=cs;const us=(e,t,r)=>t<<r-32|e>>>64-r;T.rotlBH=us;const ds=(e,t,r)=>e<<r-32|t>>>64-r;T.rotlBL=ds;function ls(e,t,r,n){const i=(t>>>0)+(n>>>0);return{h:e+r+(i/2**32|0)|0,l:i|0}}T.add=ls;const fs=(e,t,r)=>(e>>>0)+(t>>>0)+(r>>>0);T.add3L=fs;const hs=(e,t,r,n)=>t+r+n+(e/2**32|0)|0;T.add3H=hs;const vs=(e,t,r,n)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0);T.add4L=vs;const ys=(e,t,r,n,i)=>t+r+n+i+(e/2**32|0)|0;T.add4H=ys;const ps=(e,t,r,n,i)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0)+(i>>>0);T.add5L=ps;const ms=(e,t,r,n,i,s)=>t+r+n+i+s+(e/2**32|0)|0;T.add5H=ms;const Hd={fromBig:Wr,split:Xi,toBig:Qi,shrSH:Zi,shrSL:es,rotrSH:ts,rotrSL:rs,rotrBH:ns,rotrBL:is,rotr32H:ss,rotr32L:os,rotlSH:as,rotlSL:cs,rotlBH:us,rotlBL:ds,add:ls,add3L:fs,add3H:hs,add4L:vs,add4H:ys,add5H:ms,add5L:ps};T.default=Hd;var gs={};const jd=Go(Yo);(function(e){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.randomBytes=e.wrapXOFConstructorWithOpts=e.wrapConstructorWithOpts=e.wrapConstructor=e.checkOpts=e.Hash=e.concatBytes=e.toBytes=e.utf8ToBytes=e.asyncLoop=e.nextTick=e.hexToBytes=e.bytesToHex=e.isLE=e.rotr=e.createView=e.u32=e.u8=void 0;const t=jd,r=h=>new Uint8Array(h.buffer,h.byteOffset,h.byteLength);e.u8=r;const n=h=>new Uint32Array(h.buffer,h.byteOffset,Math.floor(h.byteLength/4));e.u32=n;function i(h){return h instanceof Uint8Array||h!=null&&typeof h=="object"&&h.constructor.name==="Uint8Array"}const s=h=>new DataView(h.buffer,h.byteOffset,h.byteLength);e.createView=s;const o=(h,I)=>h<<32-I|h>>>I;if(e.rotr=o,e.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68,!e.isLE)throw new Error("Non little-endian hardware is not supported");const a=Array.from({length:256},(h,I)=>I.toString(16).padStart(2,"0"));function c(h){if(!i(h))throw new Error("Uint8Array expected");let I="";for(let _=0;_<h.length;_++)I+=a[h[_]];return I}e.bytesToHex=c;const u={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function d(h){if(h>=u._0&&h<=u._9)return h-u._0;if(h>=u._A&&h<=u._F)return h-(u._A-10);if(h>=u._a&&h<=u._f)return h-(u._a-10)}function f(h){if(typeof h!="string")throw new Error("hex string expected, got "+typeof h);const I=h.length,_=I/2;if(I%2)throw new Error("padded hex string expected, got unpadded hex of length "+I);const x=new Uint8Array(_);for(let R=0,U=0;R<_;R++,U+=2){const X=d(h.charCodeAt(U)),Ce=d(h.charCodeAt(U+1));if(X===void 0||Ce===void 0){const G=h[U]+h[U+1];throw new Error('hex string expected, got non-hex character "'+G+'" at index '+U)}x[R]=X*16+Ce}return x}e.hexToBytes=f;const l=async()=>{};e.nextTick=l;async function v(h,I,_){let x=Date.now();for(let R=0;R<h;R++){_(R);const U=Date.now()-x;U>=0&&U<I||(await(0,e.nextTick)(),x+=U)}}e.asyncLoop=v;function m(h){if(typeof h!="string")throw new Error(`utf8ToBytes expected string, got ${typeof h}`);return new Uint8Array(new TextEncoder().encode(h))}e.utf8ToBytes=m;function p(h){if(typeof h=="string"&&(h=m(h)),!i(h))throw new Error(`expected Uint8Array, got ${typeof h}`);return h}e.toBytes=p;function y(...h){let I=0;for(let x=0;x<h.length;x++){const R=h[x];if(!i(R))throw new Error("Uint8Array expected");I+=R.length}const _=new Uint8Array(I);for(let x=0,R=0;x<h.length;x++){const U=h[x];_.set(U,R),R+=U.length}return _}e.concatBytes=y;class g{clone(){return this._cloneInto()}}e.Hash=g;const E={}.toString;function w(h,I){if(I!==void 0&&E.call(I)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(h,I)}e.checkOpts=w;function S(h){const I=x=>h().update(p(x)).digest(),_=h();return I.outputLen=_.outputLen,I.blockLen=_.blockLen,I.create=()=>h(),I}e.wrapConstructor=S;function A(h){const I=(x,R)=>h(R).update(p(x)).digest(),_=h({});return I.outputLen=_.outputLen,I.blockLen=_.blockLen,I.create=x=>h(x),I}e.wrapConstructorWithOpts=A;function N(h){const I=(x,R)=>h(R).update(p(x)).digest(),_=h({});return I.outputLen=_.outputLen,I.blockLen=_.blockLen,I.create=x=>h(x),I}e.wrapXOFConstructorWithOpts=N;function M(h=32){if(t.crypto&&typeof t.crypto.getRandomValues=="function")return t.crypto.getRandomValues(new Uint8Array(h));throw new Error("crypto.getRandomValues must be defined")}e.randomBytes=M})(gs);Object.defineProperty(K,"__esModule",{value:!0});K.shake256=K.shake128=K.keccak_512=K.keccak_384=K.keccak_256=K.keccak_224=K.sha3_512=K.sha3_384=K.sha3_256=K.sha3_224=K.Keccak=K.keccakP=void 0;const be=W,qe=T,Ue=gs,[Es,bs,Is]=[[],[],[]],Vd=BigInt(0),$e=BigInt(1),Ud=BigInt(2),Fd=BigInt(7),Gd=BigInt(256),Yd=BigInt(113);for(let e=0,t=$e,r=1,n=0;e<24;e++){[r,n]=[n,(2*r+3*n)%5],Es.push(2*(5*n+r)),bs.push((e+1)*(e+2)/2%64);let i=Vd;for(let s=0;s<7;s++)t=(t<<$e^(t>>Fd)*Yd)%Gd,t&Ud&&(i^=$e<<($e<<BigInt(s))-$e);Is.push(i)}const[Wd,zd]=(0,qe.split)(Is,!0),jn=(e,t,r)=>r>32?(0,qe.rotlBH)(e,t,r):(0,qe.rotlSH)(e,t,r),Vn=(e,t,r)=>r>32?(0,qe.rotlBL)(e,t,r):(0,qe.rotlSL)(e,t,r);function Ss(e,t=24){const r=new Uint32Array(10);for(let n=24-t;n<24;n++){for(let o=0;o<10;o++)r[o]=e[o]^e[o+10]^e[o+20]^e[o+30]^e[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,u=r[c],d=r[c+1],f=jn(u,d,1)^r[a],l=Vn(u,d,1)^r[a+1];for(let v=0;v<50;v+=10)e[o+v]^=f,e[o+v+1]^=l}let i=e[2],s=e[3];for(let o=0;o<24;o++){const a=bs[o],c=jn(i,s,a),u=Vn(i,s,a),d=Es[o];i=e[d],s=e[d+1],e[d]=c,e[d+1]=u}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)r[a]=e[o+a];for(let a=0;a<10;a++)e[o+a]^=~r[(a+2)%10]&r[(a+4)%10]}e[0]^=Wd[n],e[1]^=zd[n]}r.fill(0)}K.keccakP=Ss;class ot extends Ue.Hash{constructor(t,r,n,i=!1,s=24){if(super(),this.blockLen=t,this.suffix=r,this.outputLen=n,this.enableXOF=i,this.rounds=s,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,be.number)(n),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,Ue.u32)(this.state)}keccak(){Ss(this.state32,this.rounds),this.posOut=0,this.pos=0}update(t){(0,be.exists)(this);const{blockLen:r,state:n}=this;t=(0,Ue.toBytes)(t);const i=t.length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);for(let a=0;a<o;a++)n[this.pos++]^=t[s++];this.pos===r&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:t,suffix:r,pos:n,blockLen:i}=this;t[n]^=r,r&128&&n===i-1&&this.keccak(),t[i-1]^=128,this.keccak()}writeInto(t){(0,be.exists)(this,!1),(0,be.bytes)(t),this.finish();const r=this.state,{blockLen:n}=this;for(let i=0,s=t.length;i<s;){this.posOut>=n&&this.keccak();const o=Math.min(n-this.posOut,s-i);t.set(r.subarray(this.posOut,this.posOut+o),i),this.posOut+=o,i+=o}return t}xofInto(t){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(t)}xof(t){return(0,be.number)(t),this.xofInto(new Uint8Array(t))}digestInto(t){if((0,be.output)(t,this),this.finished)throw new Error("digest() was already called");return this.writeInto(t),this.destroy(),t}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(t){const{blockLen:r,suffix:n,outputLen:i,rounds:s,enableXOF:o}=this;return t||(t=new ot(r,n,i,o,s)),t.state32.set(this.state32),t.pos=this.pos,t.posOut=this.posOut,t.finished=this.finished,t.rounds=s,t.suffix=n,t.outputLen=i,t.enableXOF=o,t.destroyed=this.destroyed,t}}K.Keccak=ot;const fe=(e,t,r)=>(0,Ue.wrapConstructor)(()=>new ot(t,e,r));K.sha3_224=fe(6,144,224/8);K.sha3_256=fe(6,136,256/8);K.sha3_384=fe(6,104,384/8);K.sha3_512=fe(6,72,512/8);K.keccak_224=fe(1,144,224/8);K.keccak_256=fe(1,136,256/8);K.keccak_384=fe(1,104,384/8);K.keccak_512=fe(1,72,512/8);const ws=(e,t,r)=>(0,Ue.wrapXOFConstructorWithOpts)((n={})=>new ot(t,e,n.dkLen===void 0?r:n.dkLen,!0));K.shake128=ws(31,168,128/8);K.shake256=ws(31,136,256/8);const{sha3_512:Jd}=K,Ts=24,Fe=32,vr=(e=4,t=Math.random)=>{let r="";for(;r.length<e;)r=r+Math.floor(t()*36).toString(36);return r};function _s(e){let t=8n,r=0n;for(const n of e.values()){const i=BigInt(n);r=(r<<t)+i}return r}const As=(e="")=>_s(Jd(e)).toString(36).slice(1),Un=Array.from({length:26},(e,t)=>String.fromCharCode(t+97)),qd=e=>Un[Math.floor(e()*Un.length)],Ms=({globalObj:e=typeof yn<"u"?yn:typeof window<"u"?window:{},random:t=Math.random}={})=>{const r=Object.keys(e).toString(),n=r.length?r+vr(Fe,t):vr(Fe,t);return As(n).substring(0,Fe)},xs=e=>()=>e++,Xd=476782367,Os=({random:e=Math.random,counter:t=xs(Math.floor(e()*Xd)),length:r=Ts,fingerprint:n=Ms({random:e})}={})=>function(){const s=qd(e),o=Date.now().toString(36),a=t().toString(36),c=vr(r,e),u=`${o+c+a+n}`;return`${s+As(u).substring(1,r)}`},Qd=Os(),Zd=(e,{minLength:t=2,maxLength:r=Fe}={})=>{const n=e.length,i=/^[0-9a-z]+$/;try{if(typeof e=="string"&&n>=t&&n<=r&&i.test(e))return!0}finally{}return!1};le.getConstants=()=>({defaultLength:Ts,bigLength:Fe});le.init=Os;le.createId=Qd;le.bufToBigInt=_s;le.createCounter=xs;le.createFingerprint=Ms;le.isCuid=Zd;const{createId:el,init:Gv,getConstants:Yv,isCuid:Wv}=le;var Vt=el,tl=Object.create,Rs=Object.defineProperty,rl=Object.getOwnPropertyDescriptor,Ls=Object.getOwnPropertyNames,nl=Object.getPrototypeOf,il=Object.prototype.hasOwnProperty,sl=(e,t)=>function(){return t||(0,e[Ls(e)[0]])((t={exports:{}}).exports,t),t.exports},ol=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Ls(t))!il.call(e,i)&&i!==r&&Rs(e,i,{get:()=>t[i],enumerable:!(n=rl(t,i))||n.enumerable});return e},al=(e,t,r)=>(r=e!=null?tl(nl(e)):{},ol(t||!e||!e.__esModule?Rs(r,"default",{value:e,enumerable:!0}):r,e)),cl=sl({"../../node_modules/eventemitter3/index.js"(e,t){var r=Object.prototype.hasOwnProperty,n="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(n=!1));function s(u,d,f){this.fn=u,this.context=d,this.once=f||!1}function o(u,d,f,l,v){if(typeof f!="function")throw new TypeError("The listener must be a function");var m=new s(f,l||u,v),p=n?n+d:d;return u._events[p]?u._events[p].fn?u._events[p]=[u._events[p],m]:u._events[p].push(m):(u._events[p]=m,u._eventsCount++),u}function a(u,d){--u._eventsCount===0?u._events=new i:delete u._events[d]}function c(){this._events=new i,this._eventsCount=0}c.prototype.eventNames=function(){var d=[],f,l;if(this._eventsCount===0)return d;for(l in f=this._events)r.call(f,l)&&d.push(n?l.slice(1):l);return Object.getOwnPropertySymbols?d.concat(Object.getOwnPropertySymbols(f)):d},c.prototype.listeners=function(d){var f=n?n+d:d,l=this._events[f];if(!l)return[];if(l.fn)return[l.fn];for(var v=0,m=l.length,p=new Array(m);v<m;v++)p[v]=l[v].fn;return p},c.prototype.listenerCount=function(d){var f=n?n+d:d,l=this._events[f];return l?l.fn?1:l.length:0},c.prototype.emit=function(d,f,l,v,m,p){var y=n?n+d:d;if(!this._events[y])return!1;var g=this._events[y],E=arguments.length,w,S;if(g.fn){switch(g.once&&this.removeListener(d,g.fn,void 0,!0),E){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,f),!0;case 3:return g.fn.call(g.context,f,l),!0;case 4:return g.fn.call(g.context,f,l,v),!0;case 5:return g.fn.call(g.context,f,l,v,m),!0;case 6:return g.fn.call(g.context,f,l,v,m,p),!0}for(S=1,w=new Array(E-1);S<E;S++)w[S-1]=arguments[S];g.fn.apply(g.context,w)}else{var A=g.length,N;for(S=0;S<A;S++)switch(g[S].once&&this.removeListener(d,g[S].fn,void 0,!0),E){case 1:g[S].fn.call(g[S].context);break;case 2:g[S].fn.call(g[S].context,f);break;case 3:g[S].fn.call(g[S].context,f,l);break;case 4:g[S].fn.call(g[S].context,f,l,v);break;default:if(!w)for(N=1,w=new Array(E-1);N<E;N++)w[N-1]=arguments[N];g[S].fn.apply(g[S].context,w)}}return!0},c.prototype.on=function(d,f,l){return o(this,d,f,l,!1)},c.prototype.once=function(d,f,l){return o(this,d,f,l,!0)},c.prototype.removeListener=function(d,f,l,v){var m=n?n+d:d;if(!this._events[m])return this;if(!f)return a(this,m),this;var p=this._events[m];if(p.fn)p.fn===f&&(!v||p.once)&&(!l||p.context===l)&&a(this,m);else{for(var y=0,g=[],E=p.length;y<E;y++)(p[y].fn!==f||v&&!p[y].once||l&&p[y].context!==l)&&g.push(p[y]);g.length?this._events[m]=g.length===1?g[0]:g:a(this,m)}return this},c.prototype.removeAllListeners=function(d){var f;return d?(f=n?n+d:d,this._events[f]&&a(this,f)):(this._events=new i,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=n,c.EventEmitter=c,typeof t<"u"&&(t.exports=c)}}),ul="SIGNATURE",dl="ENCRYPTION",ll="SYMMETRIC",fl="LINK_HASH",Ns={SIGNATURE:ul,ENCRYPTION:dl,SYMMETRIC:ll,LINK_HASH:fl},Ut="ROOT",_e={isValid:!0},Ds={type:"EPHEMERAL",name:"EPHEMERAL"},{LINK_HASH:hl}=Ns,Xe=e=>oe(hl,e),ks=({graph:e,action:t,user:r,context:n={},keys:i})=>{const{publicKey:s,secretKey:o}=r.keys.encryption,{publicKey:a}=i.encryption,c={...t,...n,userId:r.userId,timestamp:Date.now(),prev:e.head??[]},u=ce.encrypt({secret:c,recipientPublicKey:a,senderSecretKey:o}),d=Xe(u),f={hash:d,body:c},l={senderPublicKey:s,recipientPublicKey:a,encryptedBody:u};return{root:e.root??d,head:[d],encryptedLinks:{...e.encryptedLinks,[d]:l},links:{...e.links,[d]:f}}},vl=e=>(t,r)=>{const n=typeof e=="function"?e(r):r[e];return{...t,[n]:r}};function xt(e,t="Assertion failed"){if(e===!1||e===null||e===void 0){const r=new Error(yl(t));throw r.stack=pl(r.stack,"assert.ts"),r}}var yl=e=>e.split(`
`).map(t=>t.trim()).join(`
`),pl=(e="",t)=>e.split(`
`).filter(r=>!r.includes(t)).join(`
`),at=Nr,Ot=(e,t)=>e.links[t],Ps=(e,t)=>ml(e)[t]||[],ml=at(e=>{const t={};for(const r of Object.values(e.links)){const n=r.body.prev;for(const i of n){const s=t[i]||[];s.push(r.hash),t[i]=s}}return t}),Rt=e=>Object.keys(e.links),gl=(e,t)=>`${e.head.join("")}:${t}`,Qe=at((e,t)=>{const r=Ot(e,t)?.body.prev??[],n=r.flatMap(i=>Qe(e,i));return Gr(r.concat(n))},gl),El=(e,t,r)=>t!==void 0&&r!==void 0&&t.hash in e.links&&r.hash in e.links&&Qe(e,r.hash).includes(t.hash),bl=(e,t,r)=>Qe(e,r).includes(t),Il=(e,t)=>`${e.head.join("")}:${t}`,Cs=at((e,t)=>{const r=Ps(e,t),n=r.flatMap(i=>Cs(e,i));return Gr(r.concat(n))},Il),Sl=(e,t,r)=>Cs(e,r).includes(t),wl=(e,t)=>Tl(e)[t],Tl=at(e=>{const t={};for(const r in e.links){const n=r;t[n]=Rt(e).filter(i=>_l(e,n,i)).sort()}return t}),_l=(e,t,r)=>t!==r&&!bl(e,t,r)&&!Sl(e,t,r),Al=e=>{const t={},r=i=>{const s=[i];for(const o of wl(e,i))t[o]||(t[o]=!0,s.push(...r(o)));return s},n=[];for(const i in e.links){const s=i;if(!t[s]){t[s]=!0;const o=r(s);o.length>1&&n.push(o)}}return n},Ml={root:void 0,head:void 0,encryptedLinks:{},links:{}},xl=({user:e,id:t=Vt(),name:r=t,rootPayload:n={},context:i={},keys:s})=>{const o={name:r,id:t,...n};return ks({graph:Ml,action:{type:Ut,prev:[],payload:o},user:e,context:i,keys:s})},Ol={GRAPH:"GRAPH",USER:"USER"},Rl=e=>e.encryption.hasOwnProperty("secretKey")&&e.signature.hasOwnProperty("secretKey")&&"secretKey"in e,Ft=e=>e!==void 0&&"secretKey"in e&&"encryption"in e&&"signature"in e,Ll=e=>!Array.isArray(e)&&!Ft(e),ke=e=>Ll(e)?e:(Ft(e)&&(e=[e]),e.reduce(vl(t=>t.encryption.publicKey),{})),$s=(e,t)=>{const{senderPublicKey:r,recipientPublicKey:n,encryptedBody:i}=e,o=ke(t)[n];xt(o,"Can't decrypt link: don't have the correct keyset");const a=ce.decrypt({cipher:i,recipientSecretKey:o.encryption.secretKey,senderPublicKey:r});return{hash:Xe(i),body:a}},zr=({encryptedGraph:e,keys:t})=>{const{encryptedLinks:r,root:n,childMap:i={}}=e,s=e.links??{},o=(c,u={})=>{const d=r[c],f=s[c]??$s(d,t);let l={[c]:f};const v=i[c]??[];for(const m of v)l={...l,...o(m,l)};return{...u,...l}},a=o(n);return{...e,links:a}},Nl=(e,t)=>Object.fromEntries(t.map(r=>[r,Dl(e,r)])),Dl=(e,t)=>e.encryptedLinks[t],kl=e=>e.head.map(t=>Ot(e,t));function yr(e,t){return typeof t=="string"?Ot(e,t).body.prev:t.body.prev.map(n=>Ot(e,n))}var Qt={},pr=({graph:e,depth:t,start:r=e.head,end:n=[],prev:i,hashes:s})=>s?s.reduce((o,a)=>({...o,[a]:yr(e,a)}),Qt):(i&&(r=Pl(i)),t===0?Qt:r.reduce((o,a)=>{const c=yr(e,a),u=c.filter(f=>!(f in o)).filter(f=>!n.includes(f)),d=pr({graph:e,depth:t?t-1:void 0,start:u,end:n});return{...o,[a]:c,...d}},Qt)),Pl=e=>Object.keys(e).flatMap(i=>e[i]).filter(i=>!(i in e)),Jr=e=>{const t={};for(const r of Rt(e))for(const n of yr(e,r))t[n]||(t[n]=[]),t[n].push(r);return t},Cl=e=>{const t={},r=Object.keys(e);for(const n of r)for(const i of e[n])t[i]||(t[i]=[]),t[i].push(n);return t},$l=e=>e.links[e.root],Kl=(e,t={})=>{const{comparator:r=Ks}=t;let n=Object.values(e.links);const i=Object.fromEntries(n.map(a=>[a.hash,a.body.prev.length])),s=[],o=a=>{s.push(a),n=n.filter(f=>f.hash!==a.hash);const c=Ps(e,a.hash);for(const f of c)i[f]--;if(c.length!==1)return;const u=c[0];if(i[u]>0)return;const d=e.links[u];o(d)};for(;n.length>0;){const c=n.filter(u=>i[u.hash]===0).sort(r).shift();o(c)}return s},Ks=(e,t)=>e.hash<t.hash?-1:e.hash>t.hash?1:0,Bl=(e,t=Bs)=>{const{sort:r=Ks,filter:n=Hl}=t(e);return Kl(e,{comparator:r}).map(s=>{const o=s.isInvalid??!n(s);return{...s,isInvalid:o}})},Bs=e=>({}),Hl=e=>!0,Et=(e,t)=>e===void 0||t===void 0||e.length!==t.length?!1:(e.sort(),t.sort(),e.every((r,n)=>r===t[n])),Hs=(e,t)=>{if(e.root!==t.root)throw new Error("Cannot merge two graphs with different roots");const r={...t.links,...e.links},n={...t.encryptedLinks,...e.encryptedLinks},s=Gr([...e.head,...t.head]).filter(jl(r)),o={root:e.root,head:s,encryptedLinks:n,links:r};return o.head=o.head.sort(),o},jl=e=>t=>!Object.values(e).some(Vl(t)),Vl=e=>t=>t.body.prev.includes(e),Ul=e=>{const{head:t,root:r,encryptedLinks:n}=e,i=Jr(e);return{head:t,root:r,encryptedLinks:n,childMap:i}},Fl=e=>JSON.stringify(Ul(e)),Gl=(e,t)=>{const r=JSON.parse(e);return zr({encryptedGraph:r,keys:t})},{SIGNATURE:Yl,ENCRYPTION:Wl,SYMMETRIC:zl}=Ns,ie=(e,t=de())=>{const{type:r,name:n=r}=e,i=mi(`${n}:${r}:${t}`);return{type:r,name:n,generation:0,signature:me.keyPair(oe(Yl,i).slice(0,32)),encryption:ce.keyPair(oe(Wl,i).slice(0,32)),secretKey:oe(zl,i)}},Jl=e=>{let t;for(const r in e){const n=e[r];(t===void 0||n.generation>t.generation)&&(t=n)}return t},ae=e=>Rl(e)?{type:e.type,name:e.name,generation:e.generation,encryption:e.encryption.publicKey,signature:e.signature.publicKey}:e,ql=al(cl(),1),Xl=class extends Error{name;details;constructor(t,r){super(),this.message=t,this.details=r}},Ql={validateHash(e,t){const{hash:r}=e,{encryptedBody:n}=t.encryptedLinks[r],i=Xe(n);return r===i?_e:ne("The hash calculated for this link does not match.",{link:e,hash:r,expected:i})},validatePrev(e,t){for(const r of e.body.prev)if(!(r in t.links))return ne("The link referenced by one of the hashes in the `prev` property does not exist.");return _e},validateRoot(e,t){const r=e.body.prev.length===0,n="type"in e.body&&e.body.type===Ut,i=$l(t)===e;return r===i&&i===n?_e:ne(n?r?"The ROOT link has to be the link referenced by the graph `root` property":"The ROOT link cannot have any predecessors":r?"Non-ROOT links must have predecessors":"The link referenced by the graph `root` property must be a ROOT link",{link:e,graph:t})},validateTimestamps(e,t){const{timestamp:r}=e.body,n=Date.now();if(r>n)return ne("The link's timestamp is in the future.",{link:e,now:n});for(const i of e.body.prev){const s=t.links[i];if(s.body.timestamp>r)return ne("This link's timestamp can't be earlier than a previous link.",{link:e,prevLink:s})}return _e}},ne=(e,t)=>({isValid:!1,error:new Xl(e,t)}),Zl=e=>{const t={},r=(n,i)=>`${oe("memoize",n)}:${oe("memoize",i)}`;for(const n in e)t[n]=at(e[n],r);return t},ef=Zl(Ql),qr=(e,t={})=>{{const o=e.root,a=e.encryptedLinks[o],c=Xe(a.encryptedBody);if(c!==o)return ne("Root hash does not match the hash of the root link",{rootHash:o,computedHash:c,rootLink:a})}for(const o of e.head){const a=e.encryptedLinks[o],c=Xe(a.encryptedBody);if(c!==o)return ne("Head hash does not match the hash of the head link",{headHash:o,computedHash:c,headLink:a})}const r=Object.keys(e.encryptedLinks),n=Object.keys(e.links);if(r.length!==n.length)return ne("Number of encrypted links does not match number of links",{encryptedLinkHashes:r,linkHashes:n});const s=((...o)=>a=>{const c=tf(o);for(const u in c){const d=c[u];try{const f=d(a,e);if(!f.isValid)return f}catch(f){return ne(f.message,f)}}return _e})(ef,t);for(const o of Object.values(e.links)){const a=s(o);if(!a.isValid)return a}return _e},tf=e=>e.reduce((t,r)=>Object.assign(t,r),{}),js=({initialState:e,reducer:t,resolver:r,validators:n})=>i=>(qr(i,n),Bl(i,r).reduce(t,e)),rf=class extends ql.EventEmitter{user;context;initialState;reducer;resolver;validators;keyring;graph;state;constructor({user:e,context:t={},graph:r,rootPayload:n,initialState:i={},reducer:s,validators:o,resolver:a=Bs,keys:c}){super(),r===void 0?(xt(Ft(c),"If no graph is provided, only pass a single keyset, not a keyring."),this.graph=xl({user:e,rootPayload:n,keys:c})):typeof r=="string"?(xt(c),this.graph=Gl(r,c)):this.graph=r,this.context=t,this.initialState=i,this.reducer=s,this.validators=o,this.resolver=a,this.user=e,this.keyring=ke(c),this.updateState()}getState(){return this.state}getGraph(){return this.graph}save(){return Fl(this.graph)}dispatch(e,t){const r={payload:void 0,...e};if(t===void 0){const i=this.graph.head.sort()[0],s=this.graph.encryptedLinks[i].recipientPublicKey;t=this.keyring[s]}else this.keyring[t.encryption.publicKey]=t;this.graph=ks({graph:this.graph,action:r,user:this.user,keys:t,context:this.context});const[n]=kl(this.graph);return this.state=this.reducer(this.state,n),this.emit("updated",{head:this.graph.head}),e}merge(e){this.graph=Hs(this.graph,e),this.updateState()}validate(){return qr(this.graph,this.validators)}updateState(){const e=js({initialState:this.initialState,reducer:this.reducer,resolver:this.resolver,validators:this.validators});this.state=e(this.graph),this.emit("updated",{head:this.graph.head})}},Fn=e=>new rf(e),Gn=(e,t)=>{const r={root:e.root,head:e.head},{their:n,our:i,lastCommonHead:s}=t,o={...t},a=e.head,c=n.head;if(i.reportedError)return r.error=i.reportedError,delete i.reportedError,[o,r];if(n.reportedError)return[o,void 0];if(Et(a,s))return[o,void 0];if(Et(a,c))return o.lastCommonHead=a,[o,r];const f=Object.fromEntries([...c,...c.flatMap(y=>Qe(e,y)),...s,...s.flatMap(y=>Qe(e,y)),...Object.keys(n.parentMap),...i.links].map(y=>[y,!0]));let l=[];if(c.length>0&&c.every(y=>y in e.links))l=Rt(e).filter(y=>!(y in f));else{if(n.parentMap){const y={...e.encryptedLinks,...n.encryptedLinks};r.need=Object.keys(f).filter(g=>!(g in y)),l=Rt(e).filter(g=>!(g in f))}Et(a,i.parentMapAtHead)||(r.parentMap=pr({graph:e,end:s}),o.our.parentMapAtHead=a)}const p=n.need.concat(l);if(p.length>0){r.links=Nl(e,p);const y=pr({graph:e,hashes:p});r.parentMap={...r.parentMap,...y}}return o.our.links=i.links.concat(p),o.their.need=[],[o,r]},Zt=()=>({their:{head:[],encryptedLinks:{},need:[],parentMap:{}},our:{head:[],links:[]},lastCommonHead:[],failedSyncCount:0}),nf=(e,t,r,n,i=zr)=>{const s=ke(n),o=r;xt(e.root===o.root,"Can't sync graphs with different roots");const a={...t,their:{head:o.head,need:o.need??[],encryptedLinks:{...t.their.encryptedLinks,...o.links},parentMap:{...t.their.parentMap,...o.parentMap},reportedError:o.error}};if(Object.keys(a.their.encryptedLinks).length>0){const{head:c}=o,u=Jr(e),d=Cl(a.their.parentMap),f={...u,...d},l={...e.encryptedLinks,...a.their.encryptedLinks},v={...e,head:c,encryptedLinks:l,childMap:f},m=i({encryptedGraph:v,keys:s}),p=Hs(e,m),y=qr(p);y.isValid?e=p:(a.failedSyncCount+=1,a.our.reportedError=y.error),a.their.encryptedLinks={},a.their.parentMap={}}return[e,a]},Jv=(e,t=Vt(),r=de())=>({userName:e,userId:t,keys:ie({type:Ol.USER,name:t},r)}),sf=e=>{const{userId:t,userName:r}=e;return{userId:t,userName:r,keys:ae(e.keys)}};/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var b=function(){return b=Object.assign||function(t){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t},b.apply(this,arguments)};function Xr(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r}function L(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function k(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,s=[],o;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(a){o={error:a}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return s}function V(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,s;n<i;n++)(s||!(n in t))&&(s||(s=Array.prototype.slice.call(t,0,n)),s[n]=t[n]);return e.concat(s||Array.prototype.slice.call(t))}var Vs=".",Yn={},mr="xstate.guard",of="";function H(e){return Object.keys(e)}function Qr(e,t,r){r===void 0&&(r=Vs);var n=Ge(e,r),i=Ge(t,r);return D(i)?D(n)?i===n:!1:D(n)?n in i:H(n).every(function(s){return s in i?Qr(n[s],i[s]):!1})}function Us(e){try{return D(e)||typeof e=="number"?"".concat(e):e.type}catch{throw new Error("Events must be strings or objects with a string event.type property.")}}function gr(e,t){try{return Pe(e)?e:e.toString().split(t)}catch{throw new Error("'".concat(e,"' is not a valid state path."))}}function af(e){return typeof e=="object"&&"value"in e&&"context"in e&&"event"in e&&"_event"in e}function Ge(e,t){if(af(e))return e.value;if(Pe(e))return Lt(e);if(typeof e!="string")return e;var r=gr(e,t);return Lt(r)}function Lt(e){if(e.length===1)return e[0];for(var t={},r=t,n=0;n<e.length-1;n++)n===e.length-2?r[e[n]]=e[n+1]:(r[e[n]]={},r=r[e[n]]);return t}function Be(e,t){for(var r={},n=H(e),i=0;i<n.length;i++){var s=n[i];r[s]=t(e[s],s,e,i)}return r}function Wn(e,t,r){var n,i,s={};try{for(var o=L(H(e)),a=o.next();!a.done;a=o.next()){var c=a.value,u=e[c];r(u)&&(s[c]=t(u,c,e))}}catch(d){n={error:d}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}var cf=function(e){return function(t){var r,n,i=t;try{for(var s=L(e),o=s.next();!o.done;o=s.next()){var a=o.value;i=i[a]}}catch(c){r={error:c}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i}};function uf(e,t){return function(r){var n,i,s=r;try{for(var o=L(e),a=o.next();!a.done;a=o.next()){var c=a.value;s=s[t][c]}}catch(u){n={error:u}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}}function bt(e){if(!e)return[[]];if(D(e))return[[e]];var t=j(H(e).map(function(r){var n=e[r];return typeof n!="string"&&(!n||!Object.keys(n).length)?[[r]]:bt(e[r]).map(function(i){return[r].concat(i)})}));return t}function j(e){var t;return(t=[]).concat.apply(t,V([],k(e),!1))}function Fs(e){return Pe(e)?e:[e]}function Z(e){return e===void 0?[]:Fs(e)}function Nt(e,t,r){var n,i;if(P(e))return e(t,r.data);var s={};try{for(var o=L(Object.keys(e)),a=o.next();!a.done;a=o.next()){var c=a.value,u=e[c];P(u)?s[c]=u(t,r.data):s[c]=u}}catch(d){n={error:d}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}function df(e){return/^(done|error)\./.test(e)}function zn(e){return!!(e instanceof Promise||e!==null&&(P(e)||typeof e=="object")&&P(e.then))}function lf(e){return e!==null&&typeof e=="object"&&"transition"in e&&typeof e.transition=="function"}function Gs(e,t){var r,n,i=k([[],[]],2),s=i[0],o=i[1];try{for(var a=L(e),c=a.next();!c.done;c=a.next()){var u=c.value;t(u)?s.push(u):o.push(u)}}catch(d){r={error:d}}finally{try{c&&!c.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return[s,o]}function Ys(e,t){return Be(e.states,function(r,n){if(r){var i=(D(t)?void 0:t[n])||(r?r.current:void 0);if(i)return{current:i,states:Ys(r,i)}}})}function ff(e,t){return{current:t,states:Ys(e,t)}}function Jn(e,t,r,n){var i=e&&r.reduce(function(s,o){var a,c,u=o.assignment,d={state:n,action:o,_event:t},f={};if(P(u))f=u(s,t.data,d);else try{for(var l=L(H(u)),v=l.next();!v.done;v=l.next()){var m=v.value,p=u[m];f[m]=P(p)?p(s,t.data,d):p}}catch(y){a={error:y}}finally{try{v&&!v.done&&(c=l.return)&&c.call(l)}finally{if(a)throw a.error}}return Object.assign({},s,f)},e);return i}var hf=function(){};function Pe(e){return Array.isArray(e)}function P(e){return typeof e=="function"}function D(e){return typeof e=="string"}function Ws(e,t){if(e)return D(e)?{type:mr,name:e,predicate:t?t[e]:void 0}:P(e)?{type:mr,name:e.name,predicate:e}:e}function vf(e){try{return"subscribe"in e&&P(e.subscribe)}catch{return!1}}var yf=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Le(e){try{return"__xstatenode"in e}catch{return!1}}function pf(e){return!!e&&typeof e.send=="function"}function Zr(e,t){return D(e)||typeof e=="number"?b({type:e},t):e}function Y(e,t){if(!D(e)&&"$$type"in e&&e.$$type==="scxml")return e;var r=Zr(e);return b({name:r.type,data:r,$$type:"scxml",type:"external"},t)}function Ie(e,t){var r=Fs(t).map(function(n){return typeof n>"u"||typeof n=="string"||Le(n)?{target:n,event:e}:b(b({},n),{event:e})});return r}function mf(e){if(!(e===void 0||e===of))return Z(e)}function zs(e,t,r,n,i){var s=e.options.guards,o={state:i,cond:t,_event:n};if(t.type===mr)return(s?.[t.name]||t.predicate)(r,n.data,o);var a=s[t.type];if(!a)throw new Error("Guard '".concat(t.type,"' is not implemented on machine '").concat(e.id,"'."));return a(r,n.data,o)}function Js(e){return typeof e=="string"?{type:e}:e}function qs(e,t,r){if(typeof e=="object")return e;var n=function(){};return{next:e,error:t||n,complete:r||n}}var C;(function(e){e.Start="xstate.start",e.Stop="xstate.stop",e.Raise="xstate.raise",e.Send="xstate.send",e.Cancel="xstate.cancel",e.NullEvent="",e.Assign="xstate.assign",e.After="xstate.after",e.DoneState="done.state",e.DoneInvoke="done.invoke",e.Log="xstate.log",e.Init="xstate.init",e.Invoke="xstate.invoke",e.ErrorExecution="error.execution",e.ErrorCommunication="error.communication",e.ErrorPlatform="error.platform",e.ErrorCustom="xstate.error",e.Update="xstate.update",e.Pure="xstate.pure",e.Choose="xstate.choose"})(C||(C={}));var Ze;(function(e){e.Parent="#_parent",e.Internal="#_internal"})(Ze||(Ze={}));var Er=C.Start,en=C.Stop,Gt=C.Raise,Yt=C.Send,Xs=C.Cancel,gf=C.NullEvent,br=C.Assign;C.After;C.DoneState;var Qs=C.Log,Ef=C.Init,Ir=C.Invoke;C.ErrorExecution;var qn=C.ErrorPlatform,bf=C.ErrorCustom,Zs=C.Update,If=C.Choose,Sf=C.Pure,Dt=Y({type:Ef});function Sr(e,t){return t&&t[e]||void 0}function et(e,t){var r;if(D(e)||typeof e=="number"){var n=Sr(e,t);P(n)?r={type:e,exec:n}:n?r=n:r={type:e,exec:void 0}}else if(P(e))r={type:e.name||e.toString(),exec:e};else{var n=Sr(e.type,t);if(P(n))r=b(b({},e),{exec:n});else if(n){var i=n.type||e.type;r=b(b(b({},n),e),{type:i})}else r=e}return r}var kt=function(e,t){if(!e)return[];var r=Pe(e)?e:[e];return r.map(function(n){return et(n,t)})};function tn(e){var t=et(e);return b(b({id:D(e)?e:t.id},t),{type:t.type})}function wf(e){return D(e)?{type:Gt,event:e}:eo(e,{to:Ze.Internal})}function Tf(e){return{type:Gt,_event:Y(e.event)}}function eo(e,t){return{to:t?t.to:void 0,type:Yt,event:P(e)?e:Zr(e),delay:t?t.delay:void 0,id:t&&t.id!==void 0?t.id:P(e)?e.name:Us(e)}}function _f(e,t,r,n){var i={_event:r},s=Y(P(e.event)?e.event(t,r.data,i):e.event),o;if(D(e.delay)){var a=n&&n[e.delay];o=P(a)?a(t,r.data,i):a}else o=P(e.delay)?e.delay(t,r.data,i):e.delay;var c=P(e.to)?e.to(t,r.data,i):e.to;return b(b({},e),{to:c,_event:s,event:s.data,delay:o})}var Af=function(e,t,r){return b(b({},e),{value:D(e.expr)?e.expr:e.expr(t,r.data,{_event:r})})},Mf=function(e){return{type:Xs,sendId:e}};function xf(e){var t=tn(e);return{type:C.Start,activity:t,exec:void 0}}function Of(e){var t=P(e)?e:tn(e);return{type:C.Stop,activity:t,exec:void 0}}function Rf(e,t,r){var n=P(e.activity)?e.activity(t,r.data):e.activity,i=typeof n=="string"?{id:n}:n,s={type:C.Stop,activity:i};return s}var J=function(e){return{type:br,assignment:e}};function Lf(e,t){var r=t?"#".concat(t):"";return"".concat(C.After,"(").concat(e,")").concat(r)}function vt(e,t){var r="".concat(C.DoneState,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function It(e,t){var r="".concat(C.DoneInvoke,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function He(e,t){var r="".concat(C.ErrorPlatform,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function wr(e,t,r,n,i,s){s===void 0&&(s=!1);var o=k(s?[[],i]:Gs(i,function(l){return l.type===br}),2),a=o[0],c=o[1],u=a.length?Jn(r,n,a,t):r,d=s?[r]:void 0,f=j(c.map(function(l){var v;switch(l.type){case Gt:return Tf(l);case Yt:var m=_f(l,u,n,e.options.delays);return m;case Qs:return Af(l,u,n);case If:{var p=l,y=(v=p.conds.find(function(_){var x=Ws(_.cond,e.options.guards);return!x||zs(e,x,u,n,t)}))===null||v===void 0?void 0:v.actions;if(!y)return[];var g=k(wr(e,t,u,n,kt(Z(y),e.options.actions),s),2),E=g[0],w=g[1];return u=w,d?.push(u),E}case Sf:{var y=l.get(u,n.data);if(!y)return[];var S=k(wr(e,t,u,n,kt(Z(y),e.options.actions),s),2),A=S[0],N=S[1];return u=N,d?.push(u),A}case en:return Rf(l,u,n);case br:{u=Jn(u,n,[l],t),d?.push(u);break}default:var M=et(l,e.options.actions),h=M.exec;if(h&&d){var I=d.length-1;M=b(b({},M),{exec:function(_){for(var x=[],R=1;R<arguments.length;R++)x[R-1]=arguments[R];h.apply(void 0,V([d[I]],k(x),!1))}})}return M}}).filter(function(l){return!!l}));return[f,u]}var Pt=function(e){return e.type==="atomic"||e.type==="final"};function Ne(e){return H(e.states).map(function(t){return e.states[t]})}function to(e){var t=[e];return Pt(e)?t:t.concat(j(Ne(e).map(to)))}function Te(e,t){var r,n,i,s,o,a,c,u,d=new Set(e),f=Tr(d),l=new Set(t);try{for(var v=L(l),m=v.next();!m.done;m=v.next())for(var p=m.value,y=p.parent;y&&!l.has(y);)l.add(y),y=y.parent}catch(I){r={error:I}}finally{try{m&&!m.done&&(n=v.return)&&n.call(v)}finally{if(r)throw r.error}}var g=Tr(l);try{for(var E=L(l),w=E.next();!w.done;w=E.next()){var p=w.value;if(p.type==="compound"&&(!g.get(p)||!g.get(p).length))f.get(p)?f.get(p).forEach(function(_){return l.add(_)}):p.initialStateNodes.forEach(function(_){return l.add(_)});else if(p.type==="parallel")try{for(var S=(o=void 0,L(Ne(p))),A=S.next();!A.done;A=S.next()){var N=A.value;N.type!=="history"&&(l.has(N)||(l.add(N),f.get(N)?f.get(N).forEach(function(_){return l.add(_)}):N.initialStateNodes.forEach(function(_){return l.add(_)})))}}catch(_){o={error:_}}finally{try{A&&!A.done&&(a=S.return)&&a.call(S)}finally{if(o)throw o.error}}}}catch(I){i={error:I}}finally{try{w&&!w.done&&(s=E.return)&&s.call(E)}finally{if(i)throw i.error}}try{for(var M=L(l),h=M.next();!h.done;h=M.next())for(var p=h.value,y=p.parent;y&&!l.has(y);)l.add(y),y=y.parent}catch(I){c={error:I}}finally{try{h&&!h.done&&(u=M.return)&&u.call(M)}finally{if(c)throw c.error}}return l}function ro(e,t){var r=t.get(e);if(!r)return{};if(e.type==="compound"){var n=r[0];if(n){if(Pt(n))return n.key}else return{}}var i={};return r.forEach(function(s){i[s.key]=ro(s,t)}),i}function Tr(e){var t,r,n=new Map;try{for(var i=L(e),s=i.next();!s.done;s=i.next()){var o=s.value;n.has(o)||n.set(o,[]),o.parent&&(n.has(o.parent)||n.set(o.parent,[]),n.get(o.parent).push(o))}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return n}function Nf(e,t){var r=Te([e],t);return ro(e,Tr(r))}function St(e,t){return Array.isArray(e)?e.some(function(r){return r===t}):e instanceof Set?e.has(t):!1}function Df(e){return V([],k(new Set(j(V([],k(e.map(function(t){return t.ownEvents})),!1)))),!1)}function Ye(e,t){return t.type==="compound"?Ne(t).some(function(r){return r.type==="final"&&St(e,r)}):t.type==="parallel"?Ne(t).every(function(r){return Ye(e,r)}):!1}function kf(e){return e===void 0&&(e=[]),e.reduce(function(t,r){return r.meta!==void 0&&(t[r.id]=r.meta),t},{})}function Xn(e){return new Set(j(e.map(function(t){return t.tags})))}function no(e,t){if(e===t)return!0;if(e===void 0||t===void 0)return!1;if(D(e)||D(t))return e===t;var r=H(e),n=H(t);return r.length===n.length&&r.every(function(i){return no(e[i],t[i])})}function Pf(e){return D(e)?!1:"value"in e&&"history"in e}function Cf(e,t){var r=e.exec,n=b(b({},e),{exec:r!==void 0?function(){return r(t.context,t.event,{action:e,state:t,_event:t._event})}:void 0});return n}var ve=function(){function e(t){var r=this,n;this.actions=[],this.activities=Yn,this.meta={},this.events=[],this.value=t.value,this.context=t.context,this._event=t._event,this._sessionid=t._sessionid,this.event=this._event.data,this.historyValue=t.historyValue,this.history=t.history,this.actions=t.actions||[],this.activities=t.activities||Yn,this.meta=kf(t.configuration),this.events=t.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=t.configuration,this.transitions=t.transitions,this.children=t.children,this.done=!!t.done,this.tags=(n=Array.isArray(t.tags)?new Set(t.tags):t.tags)!==null&&n!==void 0?n:new Set,this.machine=t.machine,Object.defineProperty(this,"nextEvents",{get:function(){return Df(r.configuration)}})}return e.from=function(t,r){if(t instanceof e)return t.context!==r?new e({value:t.value,context:r,_event:t._event,_sessionid:null,historyValue:t.historyValue,history:t.history,actions:[],activities:t.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):t;var n=Dt;return new e({value:t,context:r,_event:n,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},e.create=function(t){return new e(t)},e.inert=function(t,r){if(t instanceof e){if(!t.actions.length)return t;var n=Dt;return new e({value:t.value,context:r,_event:n,_sessionid:null,historyValue:t.historyValue,history:t.history,activities:t.activities,configuration:t.configuration,transitions:[],children:{}})}return e.from(t,r)},e.prototype.toStrings=function(t,r){var n=this;if(t===void 0&&(t=this.value),r===void 0&&(r="."),D(t))return[t];var i=H(t);return i.concat.apply(i,V([],k(i.map(function(s){return n.toStrings(t[s],r).map(function(o){return s+r+o})})),!1))},e.prototype.toJSON=function(){var t=this;t.configuration,t.transitions;var r=t.tags;t.machine;var n=Xr(t,["configuration","transitions","tags","machine"]);return b(b({},n),{tags:Array.from(r)})},e.prototype.matches=function(t){return Qr(t,this.value)},e.prototype.hasTag=function(t){return this.tags.has(t)},e.prototype.can=function(t){var r;return hf(!!this.machine),!!(!((r=this.machine)===null||r===void 0)&&r.transition(this,t).changed)},e}(),Qn=[],je=function(e,t){Qn.push(e);var r=t(e);return Qn.pop(),r};function io(e){return{id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:e}}}}function $f(e,t,r,n){var i,s=Js(e.src),o=(i=t?.options.services)===null||i===void 0?void 0:i[s.type],a=e.data?Nt(e.data,r,n):void 0,c=o?Kf(o,e.id,a):io(e.id);return c.meta=e,c}function Kf(e,t,r){var n=io(t);if(n.deferred=!0,Le(e)){var i=n.state=je(void 0,function(){return(r?e.withContext(r):e).initialState});n.getSnapshot=function(){return i}}return n}function Bf(e){try{return typeof e.send=="function"}catch{return!1}}function Hf(e){return Bf(e)&&"id"in e}function jf(e){return b({subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},e)}function Vf(e){if(typeof e=="string"){var t={type:e};return t.toString=function(){return e},t}return e}function yt(e){return b(b({type:Ir},e),{toJSON:function(){e.onDone,e.onError;var t=Xr(e,["onDone","onError"]);return b(b({},t),{type:Ir,src:Vf(e.src)})}})}var pt="",_r="#",er="*",Se={},we=function(e){return e[0]===_r},Uf=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},Ff=function(){function e(t,r,n){var i=this;n===void 0&&(n="context"in t?t.context:void 0);var s;this.config=t,this._context=n,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.tags=[],this.options=Object.assign(Uf(),r),this.parent=this.options._parent,this.key=this.config.key||this.options._key||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:Vs),this.id=this.config.id||V([this.machine.key],k(this.path),!1).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&H(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.schema=this.parent?this.machine.schema:(s=this.config.schema)!==null&&s!==void 0?s:{},this.description=this.config.description,this.initial=this.config.initial,this.states=this.config.states?Be(this.config.states,function(c,u){var d,f=new e(c,{_parent:i,_key:u});return Object.assign(i.idMap,b((d={},d[f.id]=f,d),f.idMap)),f}):Se;var o=0;function a(c){var u,d;c.order=o++;try{for(var f=L(Ne(c)),l=f.next();!l.done;l=f.next()){var v=l.value;a(v)}}catch(m){u={error:m}}finally{try{l&&!l.done&&(d=f.return)&&d.call(f)}finally{if(u)throw u.error}}}a(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(c){var u=c.event;return u===pt}):pt in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=Z(this.config.entry||this.config.onEntry).map(function(c){return et(c)}),this.onExit=Z(this.config.exit||this.config.onExit).map(function(c){return et(c)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=Z(this.config.invoke).map(function(c,u){var d,f;if(Le(c))return i.machine.options.services=b((d={},d[c.id]=c,d),i.machine.options.services),yt({src:c.id,id:c.id});if(D(c.src))return yt(b(b({},c),{id:c.id||c.src,src:c.src}));if(Le(c.src)||P(c.src)){var l="".concat(i.id,":invocation[").concat(u,"]");return i.machine.options.services=b((f={},f[l]=c.src,f),i.machine.options.services),yt(b(b({id:l},c),{src:l}))}else{var v=c.src;return yt(b(b({id:v.type},c),{src:v}))}}),this.activities=Z(this.config.activities).concat(this.invoke).map(function(c){return tn(c)}),this.transition=this.transition.bind(this),this.tags=Z(this.config.tags)}return e.prototype._init=function(){this.__cache.transitions||to(this).forEach(function(t){return t.on})},e.prototype.withConfig=function(t,r){var n=this.options,i=n.actions,s=n.activities,o=n.guards,a=n.services,c=n.delays;return new e(this.config,{actions:b(b({},i),t.actions),activities:b(b({},s),t.activities),guards:b(b({},o),t.guards),services:b(b({},a),t.services),delays:b(b({},c),t.delays)},r??this.context)},e.prototype.withContext=function(t){return new e(this.config,this.options,t)},Object.defineProperty(e.prototype,"context",{get:function(){return P(this._context)?this._context():this._context},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:Be(this.states,function(t){return t.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke,description:this.description,tags:this.tags}},enumerable:!1,configurable:!0}),e.prototype.toJSON=function(){return this.definition},Object.defineProperty(e.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var t=this.transitions;return this.__cache.on=t.reduce(function(r,n){return r[n.eventType]=r[n.eventType]||[],r[n.eventType].push(n),r},{})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),e.prototype.getCandidates=function(t){if(this.__cache.candidates[t])return this.__cache.candidates[t];var r=t===pt,n=this.transitions.filter(function(i){var s=i.eventType===t;return r?s:s||i.eventType===er});return this.__cache.candidates[t]=n,n},e.prototype.getDelayedTransitions=function(){var t=this,r=this.config.after;if(!r)return[];var n=function(s,o){var a=P(s)?"".concat(t.id,":delay[").concat(o,"]"):s,c=Lf(a,t.id);return t.onEntry.push(eo(c,{delay:s})),t.onExit.push(Mf(c)),c},i=Pe(r)?r.map(function(s,o){var a=n(s.delay,o);return b(b({},s),{event:a})}):j(H(r).map(function(s,o){var a=r[s],c=D(a)?{target:a}:a,u=isNaN(+s)?s:+s,d=n(u,o);return Z(c).map(function(f){return b(b({},f),{event:d,delay:u})})}));return i.map(function(s){var o=s.delay;return b(b({},t.formatTransition(s)),{delay:o})})},e.prototype.getStateNodes=function(t){var r,n=this;if(!t)return[];var i=t instanceof ve?t.value:Ge(t,this.delimiter);if(D(i)){var s=this.getStateNode(i).initial;return s!==void 0?this.getStateNodes((r={},r[i]=s,r)):[this,this.states[i]]}var o=H(i),a=o.map(function(c){return n.getStateNode(c)});return a.push(this),a.concat(o.reduce(function(c,u){var d=n.getStateNode(u).getStateNodes(i[u]);return c.concat(d)},[]))},e.prototype.handles=function(t){var r=Us(t);return this.events.includes(r)},e.prototype.resolveState=function(t){var r=Array.from(Te([],this.getStateNodes(t.value)));return new ve(b(b({},t),{value:this.resolve(t.value),configuration:r,done:Ye(r,this),tags:Xn(r)}))},e.prototype.transitionLeafNode=function(t,r,n){var i=this.getStateNode(t),s=i.next(r,n);return!s||!s.transitions.length?this.next(r,n):s},e.prototype.transitionCompoundNode=function(t,r,n){var i=H(t),s=this.getStateNode(i[0]),o=s._transition(t[i[0]],r,n);return!o||!o.transitions.length?this.next(r,n):o},e.prototype.transitionParallelNode=function(t,r,n){var i,s,o={};try{for(var a=L(H(t)),c=a.next();!c.done;c=a.next()){var u=c.value,d=t[u];if(d){var f=this.getStateNode(u),l=f._transition(d,r,n);l&&(o[u]=l)}}}catch(E){i={error:E}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}var v=H(o).map(function(E){return o[E]}),m=j(v.map(function(E){return E.transitions})),p=v.some(function(E){return E.transitions.length>0});if(!p)return this.next(r,n);var y=j(v.map(function(E){return E.entrySet})),g=j(H(o).map(function(E){return o[E].configuration}));return{transitions:m,entrySet:y,exitSet:j(v.map(function(E){return E.exitSet})),configuration:g,source:r,actions:j(H(o).map(function(E){return o[E].actions}))}},e.prototype._transition=function(t,r,n){return D(t)?this.transitionLeafNode(t,r,n):H(t).length===1?this.transitionCompoundNode(t,r,n):this.transitionParallelNode(t,r,n)},e.prototype.next=function(t,r){var n,i,s=this,o=r.name,a=[],c=[],u;try{for(var d=L(this.getCandidates(o)),f=d.next();!f.done;f=d.next()){var l=f.value,v=l.cond,m=l.in,p=t.context,y=m?D(m)&&we(m)?t.matches(Ge(this.getStateNodeById(m).path,this.delimiter)):Qr(Ge(m,this.delimiter),cf(this.path.slice(0,-2))(t.value)):!0,g=!1;try{g=!v||zs(this.machine,v,p,r,t)}catch(A){throw new Error("Unable to evaluate guard '".concat(v.name||v.type,"' in transition for event '").concat(o,"' in state node '").concat(this.id,`':
`).concat(A.message))}if(g&&y){l.target!==void 0&&(c=l.target),a.push.apply(a,V([],k(l.actions),!1)),u=l;break}}}catch(A){n={error:A}}finally{try{f&&!f.done&&(i=d.return)&&i.call(d)}finally{if(n)throw n.error}}if(u){if(!c.length)return{transitions:[u],entrySet:[],exitSet:[],configuration:t.value?[this]:[],source:t,actions:a};var E=j(c.map(function(A){return s.getRelativeStateNodes(A,t.historyValue)})),w=!!u.internal,S=w?[]:j(E.map(function(A){return s.nodesFromChild(A)}));return{transitions:[u],entrySet:S,exitSet:w?[]:[this],configuration:E,source:t,actions:a}}},e.prototype.nodesFromChild=function(t){if(t.escapes(this))return[];for(var r=[],n=t;n&&n!==this;)r.push(n),n=n.parent;return r.push(this),r},e.prototype.escapes=function(t){if(this===t)return!1;for(var r=this.parent;r;){if(r===t)return!1;r=r.parent}return!0},e.prototype.getActions=function(t,r,n,i){var s,o,a,c,u=Te([],i?this.getStateNodes(i.value):[this]),d=t.configuration.length?Te(u,t.configuration):u;try{for(var f=L(d),l=f.next();!l.done;l=f.next()){var v=l.value;St(u,v)||t.entrySet.push(v)}}catch(M){s={error:M}}finally{try{l&&!l.done&&(o=f.return)&&o.call(f)}finally{if(s)throw s.error}}try{for(var m=L(u),p=m.next();!p.done;p=m.next()){var v=p.value;(!St(d,v)||St(t.exitSet,v.parent))&&t.exitSet.push(v)}}catch(M){a={error:M}}finally{try{p&&!p.done&&(c=m.return)&&c.call(m)}finally{if(a)throw a.error}}t.source||(t.exitSet=[],t.entrySet.push(this));var y=j(t.entrySet.map(function(M){var h=[];if(M.type!=="final")return h;var I=M.parent;if(!I.parent)return h;h.push(vt(M.id,M.doneData),vt(I.id,M.doneData?Nt(M.doneData,r,n):void 0));var _=I.parent;return _.type==="parallel"&&Ne(_).every(function(x){return Ye(t.configuration,x)})&&h.push(vt(_.id)),h}));t.exitSet.sort(function(M,h){return h.order-M.order}),t.entrySet.sort(function(M,h){return M.order-h.order});var g=new Set(t.entrySet),E=new Set(t.exitSet),w=k([j(Array.from(g).map(function(M){return V(V([],k(M.activities.map(function(h){return xf(h)})),!1),k(M.onEntry),!1)})).concat(y.map(wf)),j(Array.from(E).map(function(M){return V(V([],k(M.onExit),!1),k(M.activities.map(function(h){return Of(h)})),!1)}))],2),S=w[0],A=w[1],N=kt(A.concat(t.actions).concat(S),this.machine.options.actions);return N},e.prototype.transition=function(t,r,n){t===void 0&&(t=this.initialState);var i=Y(r),s;if(t instanceof ve)s=n===void 0?t:this.resolveState(ve.from(t,n));else{var o=D(t)?this.resolve(Lt(this.getResolvedPath(t))):this.resolve(t),a=n??this.machine.context;s=this.resolveState(ve.from(o,a))}if(this.strict&&!this.events.includes(i.name)&&!df(i.name))throw new Error("Machine '".concat(this.id,"' does not accept event '").concat(i.name,"'"));var c=this._transition(s.value,s,i)||{transitions:[],configuration:[],entrySet:[],exitSet:[],source:s,actions:[]},u=Te([],this.getStateNodes(s.value)),d=c.configuration.length?Te(u,c.configuration):u;return c.configuration=V([],k(d),!1),this.resolveTransition(c,s,i)},e.prototype.resolveRaisedTransition=function(t,r,n){var i,s=t.actions;return t=this.transition(t,r),t._event=n,t.event=n.data,(i=t.actions).unshift.apply(i,V([],k(s),!1)),t},e.prototype.resolveTransition=function(t,r,n,i){var s,o,a=this;n===void 0&&(n=Dt),i===void 0&&(i=this.machine.context);var c=t.configuration,u=!r||t.transitions.length>0,d=u?Nf(this.machine,c):void 0,f=r?r.historyValue?r.historyValue:t.source?this.machine.historyValue(r.value):void 0:void 0,l=r?r.context:i,v=this.getActions(t,l,n,r),m=r?b({},r.activities):{};try{for(var p=L(v),y=p.next();!y.done;y=p.next()){var g=y.value;g.type===Er?m[g.activity.id||g.activity.type]=g:g.type===en&&(m[g.activity.id||g.activity.type]=!1)}}catch(z){s={error:z}}finally{try{y&&!y.done&&(o=p.return)&&o.call(p)}finally{if(s)throw s.error}}var E=k(wr(this,r,l,n,v,this.machine.config.preserveActionOrder),2),w=E[0],S=E[1],A=k(Gs(w,function(z){return z.type===Gt||z.type===Yt&&z.to===Ze.Internal}),2),N=A[0],M=A[1],h=w.filter(function(z){var Ee;return z.type===Er&&((Ee=z.activity)===null||Ee===void 0?void 0:Ee.type)===Ir}),I=h.reduce(function(z,Ee){return z[Ee.activity.id]=$f(Ee.activity,a.machine,S,n),z},r?b({},r.children):{}),_=d?t.configuration:r?r.configuration:[],x=Ye(_,this),R=new ve({value:d||r.value,context:S,_event:n,_sessionid:r?r._sessionid:null,historyValue:d?f?ff(f,d):void 0:r?r.historyValue:void 0,history:!d||t.source?r:void 0,actions:d?M:[],activities:d?m:r?r.activities:{},events:[],configuration:_,transitions:t.transitions,children:I,done:x,tags:r?.tags,machine:this}),U=l!==S;R.changed=n.name===Zs||U;var X=R.history;X&&delete X.history;var Ce=!x&&(this._transient||c.some(function(z){return z._transient}));if(!u&&(!Ce||n.name===pt))return R;var G=R;if(!x)for(Ce&&(G=this.resolveRaisedTransition(G,{type:gf},n));N.length;){var Ho=N.shift();G=this.resolveRaisedTransition(G,Ho._event,n)}var jo=G.changed||(X?!!G.actions.length||U||typeof X.value!=typeof G.value||!no(G.value,X.value):void 0);return G.changed=jo,G.history=X,G.tags=Xn(G.configuration),G},e.prototype.getStateNode=function(t){if(we(t))return this.machine.getStateNodeById(t);if(!this.states)throw new Error("Unable to retrieve child state '".concat(t,"' from '").concat(this.id,"'; no child states exist."));var r=this.states[t];if(!r)throw new Error("Child state '".concat(t,"' does not exist on '").concat(this.id,"'"));return r},e.prototype.getStateNodeById=function(t){var r=we(t)?t.slice(_r.length):t;if(r===this.id)return this;var n=this.machine.idMap[r];if(!n)throw new Error("Child state node '#".concat(r,"' does not exist on machine '").concat(this.id,"'"));return n},e.prototype.getStateNodeByPath=function(t){if(typeof t=="string"&&we(t))try{return this.getStateNodeById(t.slice(1))}catch{}for(var r=gr(t,this.delimiter).slice(),n=this;r.length;){var i=r.shift();if(!i.length)break;n=n.getStateNode(i)}return n},e.prototype.resolve=function(t){var r,n=this;if(!t)return this.initialStateValue||Se;switch(this.type){case"parallel":return Be(this.initialStateValue,function(s,o){return s?n.getStateNode(o).resolve(t[o]||s):Se});case"compound":if(D(t)){var i=this.getStateNode(t);return i.type==="parallel"||i.type==="compound"?(r={},r[t]=i.initialStateValue,r):t}return H(t).length?Be(t,function(s,o){return s?n.getStateNode(o).resolve(s):Se}):this.initialStateValue||{};default:return t||Se}},e.prototype.getResolvedPath=function(t){if(we(t)){var r=this.machine.idMap[t.slice(_r.length)];if(!r)throw new Error("Unable to find state node '".concat(t,"'"));return r.path}return gr(t,this.delimiter)},Object.defineProperty(e.prototype,"initialStateValue",{get:function(){var t;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var r;if(this.type==="parallel")r=Wn(this.states,function(n){return n.initialStateValue||Se},function(n){return n.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '".concat(this.initial,"' not found on '").concat(this.key,"'"));r=Pt(this.states[this.initial])?this.initial:(t={},t[this.initial]=this.states[this.initial].initialStateValue,t)}else r={};return this.__cache.initialStateValue=r,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),e.prototype.getInitialState=function(t,r){var n=this.getStateNodes(t);return this.resolveTransition({configuration:n,entrySet:n,exitSet:[],transitions:[],source:void 0,actions:[]},void 0,void 0,r)},Object.defineProperty(e.prototype,"initialState",{get:function(){this._init();var t=this.initialStateValue;if(!t)throw new Error("Cannot retrieve initial state from simple state '".concat(this.id,"'."));return this.getInitialState(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"target",{get:function(){var t;if(this.type==="history"){var r=this.config;D(r.target)?t=we(r.target)?Lt(this.machine.getStateNodeById(r.target).path.slice(this.path.length-1)):r.target:t=r.target}return t},enumerable:!1,configurable:!0}),e.prototype.getRelativeStateNodes=function(t,r,n){return n===void 0&&(n=!0),n?t.type==="history"?t.resolveHistory(r):t.initialStateNodes:[t]},Object.defineProperty(e.prototype,"initialStateNodes",{get:function(){var t=this;if(Pt(this))return[this];if(this.type==="compound"&&!this.initial)return[this];var r=bt(this.initialStateValue);return j(r.map(function(n){return t.getFromRelativePath(n)}))},enumerable:!1,configurable:!0}),e.prototype.getFromRelativePath=function(t){if(!t.length)return[this];var r=k(t),n=r[0],i=r.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '".concat(n,"' from node with no states"));var s=this.getStateNode(n);if(s.type==="history")return s.resolveHistory();if(!this.states[n])throw new Error("Child state '".concat(n,"' does not exist on '").concat(this.id,"'"));return this.states[n].getFromRelativePath(i)},e.prototype.historyValue=function(t){if(H(this.states).length)return{current:t||this.initialStateValue,states:Wn(this.states,function(r,n){if(!t)return r.historyValue();var i=D(t)?void 0:t[n];return r.historyValue(i||r.initialStateValue)},function(r){return!r.history})}},e.prototype.resolveHistory=function(t){var r=this;if(this.type!=="history")return[this];var n=this.parent;if(!t){var i=this.target;return i?j(bt(i).map(function(o){return n.getFromRelativePath(o)})):n.initialStateNodes}var s=uf(n.path,"states")(t).current;return D(s)?[n.getStateNode(s)]:j(bt(s).map(function(o){return r.history==="deep"?n.getFromRelativePath(o):[n.states[o[0]]]}))},Object.defineProperty(e.prototype,"stateIds",{get:function(){var t=this,r=j(H(this.states).map(function(n){return t.states[n].stateIds}));return[this.id].concat(r)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"events",{get:function(){var t,r,n,i;if(this.__cache.events)return this.__cache.events;var s=this.states,o=new Set(this.ownEvents);if(s)try{for(var a=L(H(s)),c=a.next();!c.done;c=a.next()){var u=c.value,d=s[u];if(d.states)try{for(var f=(n=void 0,L(d.events)),l=f.next();!l.done;l=f.next()){var v=l.value;o.add("".concat(v))}}catch(m){n={error:m}}finally{try{l&&!l.done&&(i=f.return)&&i.call(f)}finally{if(n)throw n.error}}}}catch(m){t={error:m}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return this.__cache.events=Array.from(o)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ownEvents",{get:function(){var t=new Set(this.transitions.filter(function(r){return!(!r.target&&!r.actions.length&&r.internal)}).map(function(r){return r.eventType}));return Array.from(t)},enumerable:!1,configurable:!0}),e.prototype.resolveTarget=function(t){var r=this;if(t!==void 0)return t.map(function(n){if(!D(n))return n;var i=n[0]===r.delimiter;if(i&&!r.parent)return r.getStateNodeByPath(n.slice(1));var s=i?r.key+n:n;if(r.parent)try{var o=r.parent.getStateNodeByPath(s);return o}catch(a){throw new Error("Invalid transition definition for state node '".concat(r.id,`':
`).concat(a.message))}else return r.getStateNodeByPath(s)})},e.prototype.formatTransition=function(t){var r=this,n=mf(t.target),i="internal"in t?t.internal:n?n.some(function(c){return D(c)&&c[0]===r.delimiter}):!0,s=this.machine.options.guards,o=this.resolveTarget(n),a=b(b({},t),{actions:kt(Z(t.actions)),cond:Ws(t.cond,s),target:o,source:this,internal:i,eventType:t.event,toJSON:function(){return b(b({},a),{target:a.target?a.target.map(function(c){return"#".concat(c.id)}):void 0,source:"#".concat(r.id)})}});return a},e.prototype.formatTransitions=function(){var t,r,n=this,i;if(!this.config.on)i=[];else if(Array.isArray(this.config.on))i=this.config.on;else{var s=this.config.on,o=er,a=s[o],c=a===void 0?[]:a,u=Xr(s,[typeof o=="symbol"?o:o+""]);i=j(H(u).map(function(E){var w=Ie(E,u[E]);return w}).concat(Ie(er,c)))}var d=this.config.always?Ie("",this.config.always):[],f=this.config.onDone?Ie(String(vt(this.id)),this.config.onDone):[],l=j(this.invoke.map(function(E){var w=[];return E.onDone&&w.push.apply(w,V([],k(Ie(String(It(E.id)),E.onDone)),!1)),E.onError&&w.push.apply(w,V([],k(Ie(String(He(E.id)),E.onError)),!1)),w})),v=this.after,m=j(V(V(V(V([],k(f),!1),k(l),!1),k(i),!1),k(d),!1).map(function(E){return Z(E).map(function(w){return n.formatTransition(w)})}));try{for(var p=L(v),y=p.next();!y.done;y=p.next()){var g=y.value;m.push(g)}}catch(E){t={error:E}}finally{try{y&&!y.done&&(r=p.return)&&r.call(p)}finally{if(t)throw t.error}}return m},e}();function Gf(e,t){return new Ff(e,t)}var Yf={deferEvents:!1},Zn=function(){function e(t){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=b(b({},Yf),t)}return e.prototype.initialize=function(t){if(this.initialized=!0,t){if(!this.options.deferEvents){this.schedule(t);return}this.process(t)}this.flushEvents()},e.prototype.schedule=function(t){if(!this.initialized||this.processingEvent){this.queue.push(t);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(t),this.flushEvents()},e.prototype.clear=function(){this.queue=[]},e.prototype.flushEvents=function(){for(var t=this.queue.shift();t;)this.process(t),t=this.queue.shift()},e.prototype.process=function(t){this.processingEvent=!0;try{t()}catch(r){throw this.clear(),r}finally{this.processingEvent=!1}},e}(),tr=new Map,Wf=0,mt={bookId:function(){return"x:".concat(Wf++)},register:function(e,t){return tr.set(e,t),e},get:function(e){return tr.get(e)},free:function(e){tr.delete(e)}};function rn(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof cr<"u")return cr}function zf(){var e=rn();if(e&&"__xstate__"in e)return e.__xstate__}function Jf(e){if(rn()){var t=zf();t&&t.register(e)}}function qf(e,t){t===void 0&&(t={});var r=e.initialState,n=new Set,i=[],s=!1,o=function(){if(!s){for(s=!0;i.length>0;){var u=i.shift();r=e.transition(r,u,c),n.forEach(function(d){return d.next(r)})}s=!1}},a=jf({id:t.id,send:function(u){i.push(u),o()},getSnapshot:function(){return r},subscribe:function(u,d,f){var l=qs(u,d,f);return n.add(l),l.next(r),{unsubscribe:function(){n.delete(l)}}}}),c={parent:t.parent,self:a,id:t.id||"anonymous",observers:n};return r=e.start?e.start(c):r,a}var Xf={sync:!1,autoForward:!1},q;(function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped"})(q||(q={}));var Qf=function(){function e(t,r){var n=this;r===void 0&&(r=e.defaultOptions),this.machine=t,this.scheduler=new Zn,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=q.NotStarted,this.children=new Map,this.forwardTo=new Set,this.init=this.start,this.send=function(d,f){if(Pe(d))return n.batch(d),n.state;var l=Y(Zr(d,f));if(n.status===q.Stopped)return n.state;if(n.status!==q.Running&&!n.options.deferEvents)throw new Error('Event "'.concat(l.name,'" was sent to uninitialized service "').concat(n.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(l.data)));return n.scheduler.schedule(function(){n.forward(l);var v=n.nextState(l);n.update(v,l)}),n._state},this.sendTo=function(d,f){var l=n.parent&&(f===Ze.Parent||n.parent.id===f),v=l?n.parent:D(f)?n.children.get(f)||mt.get(f):pf(f)?f:void 0;if(!v){if(!l)throw new Error("Unable to send event to child '".concat(f,"' from service '").concat(n.id,"'."));return}"machine"in v?v.send(b(b({},d),{name:d.name===bf?"".concat(He(n.id)):d.name,origin:n.sessionId})):v.send(d.data)};var i=b(b({},e.defaultOptions),r),s=i.clock,o=i.logger,a=i.parent,c=i.id,u=c!==void 0?c:t.id;this.id=u,this.logger=o,this.clock=s,this.parent=a,this.options=i,this.scheduler=new Zn({deferEvents:this.options.deferEvents}),this.sessionId=mt.bookId()}return Object.defineProperty(e.prototype,"initialState",{get:function(){var t=this;return this._initialState?this._initialState:je(this,function(){return t._initialState=t.machine.initialState,t._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),e.prototype.execute=function(t,r){var n,i;try{for(var s=L(t.actions),o=s.next();!o.done;o=s.next()){var a=o.value;this.exec(a,t,r)}}catch(c){n={error:c}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}},e.prototype.update=function(t,r){var n,i,s,o,a,c,u,d,f=this;if(t._sessionid=this.sessionId,this._state=t,this.options.execute&&this.execute(this.state),this.children.forEach(function(I){f.state.children[I.id]=I}),this.devTools&&this.devTools.send(r.data,t),t.event)try{for(var l=L(this.eventListeners),v=l.next();!v.done;v=l.next()){var m=v.value;m(t.event)}}catch(I){n={error:I}}finally{try{v&&!v.done&&(i=l.return)&&i.call(l)}finally{if(n)throw n.error}}try{for(var p=L(this.listeners),y=p.next();!y.done;y=p.next()){var m=y.value;m(t,t.event)}}catch(I){s={error:I}}finally{try{y&&!y.done&&(o=p.return)&&o.call(p)}finally{if(s)throw s.error}}try{for(var g=L(this.contextListeners),E=g.next();!E.done;E=g.next()){var w=E.value;w(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(I){a={error:I}}finally{try{E&&!E.done&&(c=g.return)&&c.call(g)}finally{if(a)throw a.error}}var S=Ye(t.configuration||[],this.machine);if(this.state.configuration&&S){var A=t.configuration.find(function(I){return I.type==="final"&&I.parent===f.machine}),N=A&&A.doneData?Nt(A.doneData,t.context,r):void 0;try{for(var M=L(this.doneListeners),h=M.next();!h.done;h=M.next()){var m=h.value;m(It(this.id,N))}}catch(I){u={error:I}}finally{try{h&&!h.done&&(d=M.return)&&d.call(M)}finally{if(u)throw u.error}}this.stop()}},e.prototype.onTransition=function(t){return this.listeners.add(t),this.status===q.Running&&t(this.state,this.state.event),this},e.prototype.subscribe=function(t,r,n){var i=this;if(!t)return{unsubscribe:function(){}};var s,o=n;return typeof t=="function"?s=t:(s=t.next.bind(t),o=t.complete.bind(t)),this.listeners.add(s),this.status===q.Running&&s(this.state),o&&this.onDone(o),{unsubscribe:function(){s&&i.listeners.delete(s),o&&i.doneListeners.delete(o)}}},e.prototype.onEvent=function(t){return this.eventListeners.add(t),this},e.prototype.onSend=function(t){return this.sendListeners.add(t),this},e.prototype.onChange=function(t){return this.contextListeners.add(t),this},e.prototype.onStop=function(t){return this.stopListeners.add(t),this},e.prototype.onDone=function(t){return this.doneListeners.add(t),this},e.prototype.off=function(t){return this.listeners.delete(t),this.eventListeners.delete(t),this.sendListeners.delete(t),this.stopListeners.delete(t),this.doneListeners.delete(t),this.contextListeners.delete(t),this},e.prototype.start=function(t){var r=this;if(this.status===q.Running)return this;mt.register(this.sessionId,this),this.initialized=!0,this.status=q.Running;var n=t===void 0?this.initialState:je(this,function(){return Pf(t)?r.machine.resolveState(t):r.machine.resolveState(ve.from(t,r.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){r.update(n,Dt)}),this},e.prototype.stop=function(){var t,r,n,i,s,o,a,c,u,d,f=this;try{for(var l=L(this.listeners),v=l.next();!v.done;v=l.next()){var m=v.value;this.listeners.delete(m)}}catch(h){t={error:h}}finally{try{v&&!v.done&&(r=l.return)&&r.call(l)}finally{if(t)throw t.error}}try{for(var p=L(this.stopListeners),y=p.next();!y.done;y=p.next()){var m=y.value;m(),this.stopListeners.delete(m)}}catch(h){n={error:h}}finally{try{y&&!y.done&&(i=p.return)&&i.call(p)}finally{if(n)throw n.error}}try{for(var g=L(this.contextListeners),E=g.next();!E.done;E=g.next()){var m=E.value;this.contextListeners.delete(m)}}catch(h){s={error:h}}finally{try{E&&!E.done&&(o=g.return)&&o.call(g)}finally{if(s)throw s.error}}try{for(var w=L(this.doneListeners),S=w.next();!S.done;S=w.next()){var m=S.value;this.doneListeners.delete(m)}}catch(h){a={error:h}}finally{try{S&&!S.done&&(c=w.return)&&c.call(w)}finally{if(a)throw a.error}}if(!this.initialized)return this;this.state.configuration.forEach(function(h){var I,_;try{for(var x=L(h.definition.exit),R=x.next();!R.done;R=x.next()){var U=R.value;f.exec(U,f.state)}}catch(X){I={error:X}}finally{try{R&&!R.done&&(_=x.return)&&_.call(x)}finally{if(I)throw I.error}}}),this.children.forEach(function(h){P(h.stop)&&h.stop()});try{for(var A=L(H(this.delayedEventsMap)),N=A.next();!N.done;N=A.next()){var M=N.value;this.clock.clearTimeout(this.delayedEventsMap[M])}}catch(h){u={error:h}}finally{try{N&&!N.done&&(d=A.return)&&d.call(A)}finally{if(u)throw u.error}}return this.scheduler.clear(),this.initialized=!1,this.status=q.Stopped,mt.free(this.sessionId),this},e.prototype.batch=function(t){var r=this;if(!(this.status===q.NotStarted&&this.options.deferEvents)){if(this.status!==q.Running)throw new Error("".concat(t.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'))}this.scheduler.schedule(function(){var n,i,s=r.state,o=!1,a=[],c=function(l){var v=Y(l);r.forward(v),s=je(r,function(){return r.machine.transition(s,v)}),a.push.apply(a,V([],k(s.actions.map(function(m){return Cf(m,s)})),!1)),o=o||!!s.changed};try{for(var u=L(t),d=u.next();!d.done;d=u.next()){var f=d.value;c(f)}}catch(l){n={error:l}}finally{try{d&&!d.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}s.changed=o,s.actions=a,r.update(s,Y(t[t.length-1]))})},e.prototype.sender=function(t){return this.send.bind(this,t)},e.prototype.nextState=function(t){var r=this,n=Y(t);if(n.name.indexOf(qn)===0&&!this.state.nextEvents.some(function(s){return s.indexOf(qn)===0}))throw n.data.data;var i=je(this,function(){return r.machine.transition(r.state,n)});return i},e.prototype.forward=function(t){var r,n;try{for(var i=L(this.forwardTo),s=i.next();!s.done;s=i.next()){var o=s.value,a=this.children.get(o);if(!a)throw new Error("Unable to forward event '".concat(t,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(o,"'."));a.send(t)}}catch(c){r={error:c}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}},e.prototype.defer=function(t){var r=this;this.delayedEventsMap[t.id]=this.clock.setTimeout(function(){t.to?r.sendTo(t._event,t.to):r.send(t._event)},t.delay)},e.prototype.cancel=function(t){this.clock.clearTimeout(this.delayedEventsMap[t]),delete this.delayedEventsMap[t]},e.prototype.exec=function(t,r,n){n===void 0&&(n=this.machine.options.actions);var i=r.context,s=r._event,o=t.exec||Sr(t.type,n),a=P(o)?o:o?o.exec:t.exec;if(a)try{return a(i,s.data,{action:t,state:this.state,_event:s})}catch(S){throw this.parent&&this.parent.send({type:"xstate.error",data:S}),S}switch(t.type){case Yt:var c=t;if(typeof c.delay=="number"){this.defer(c);return}else c.to?this.sendTo(c._event,c.to):this.send(c._event);break;case Xs:this.cancel(t.sendId);break;case Er:{var u=t.activity;if(!this.state.activities[u.id||u.type])break;if(u.type===C.Invoke){var d=Js(u.src),f=this.machine.options.services?this.machine.options.services[d.type]:void 0,l=u.id,v=u.data,m="autoForward"in u?u.autoForward:!!u.forward;if(!f)return;var p=v?Nt(v,i,s):void 0;if(typeof f=="string")return;var y=P(f)?f(i,s.data,{data:p,src:d,meta:u.meta}):f;if(!y)return;var g=void 0;Le(y)&&(y=p?y.withContext(p):y,g={autoForward:m}),this.spawn(y,l,g)}else this.spawnActivity(u);break}case en:{this.stopChild(t.activity.id);break}case Qs:var E=t.label,w=t.value;E?this.logger(E,w):this.logger(w);break}},e.prototype.removeChild=function(t){var r;this.children.delete(t),this.forwardTo.delete(t),(r=this.state)===null||r===void 0||delete r.children[t]},e.prototype.stopChild=function(t){var r=this.children.get(t);r&&(this.removeChild(t),P(r.stop)&&r.stop())},e.prototype.spawn=function(t,r,n){if(zn(t))return this.spawnPromise(Promise.resolve(t),r);if(P(t))return this.spawnCallback(t,r);if(Hf(t))return this.spawnActor(t,r);if(vf(t))return this.spawnObservable(t,r);if(Le(t))return this.spawnMachine(t,b(b({},n),{id:r}));if(lf(t))return this.spawnBehavior(t,r);throw new Error('Unable to spawn entity "'.concat(r,'" of type "').concat(typeof t,'".'))},e.prototype.spawnMachine=function(t,r){var n=this;r===void 0&&(r={});var i=new e(t,b(b({},this.options),{parent:this,id:r.id||t.id})),s=b(b({},Xf),r);s.sync&&i.onTransition(function(a){n.send(Zs,{state:a,id:i.id})});var o=i;return this.children.set(i.id,o),s.autoForward&&this.forwardTo.add(i.id),i.onDone(function(a){n.removeChild(i.id),n.send(Y(a,{origin:i.id}))}).start(),o},e.prototype.spawnBehavior=function(t,r){var n=qf(t,{id:r,parent:this});return this.children.set(r,n),n},e.prototype.spawnPromise=function(t,r){var n=this,i=!1,s;t.then(function(a){i||(s=a,n.removeChild(r),n.send(Y(It(r,a),{origin:r})))},function(a){if(!i){n.removeChild(r);var c=He(r,a);try{n.send(Y(c,{origin:r}))}catch{n.devTools&&n.devTools.send(c,n.state),n.machine.strict&&n.stop()}}});var o={id:r,send:function(){},subscribe:function(a,c,u){var d=qs(a,c,u),f=!1;return t.then(function(l){f||(d.next(l),!f&&d.complete())},function(l){f||d.error(l)}),{unsubscribe:function(){return f=!0}}},stop:function(){i=!0},toJSON:function(){return{id:r}},getSnapshot:function(){return s}};return this.children.set(r,o),o},e.prototype.spawnCallback=function(t,r){var n=this,i=!1,s=new Set,o=new Set,a,c=function(f){a=f,o.forEach(function(l){return l(f)}),!i&&n.send(Y(f,{origin:r}))},u;try{u=t(c,function(f){s.add(f)})}catch(f){this.send(He(r,f))}if(zn(u))return this.spawnPromise(u,r);var d={id:r,send:function(f){return s.forEach(function(l){return l(f)})},subscribe:function(f){return o.add(f),{unsubscribe:function(){o.delete(f)}}},stop:function(){i=!0,P(u)&&u()},toJSON:function(){return{id:r}},getSnapshot:function(){return a}};return this.children.set(r,d),d},e.prototype.spawnObservable=function(t,r){var n=this,i,s=t.subscribe(function(a){i=a,n.send(Y(a,{origin:r}))},function(a){n.removeChild(r),n.send(Y(He(r,a),{origin:r}))},function(){n.removeChild(r),n.send(Y(It(r),{origin:r}))}),o={id:r,send:function(){},subscribe:function(a,c,u){return t.subscribe(a,c,u)},stop:function(){return s.unsubscribe()},getSnapshot:function(){return i},toJSON:function(){return{id:r}}};return this.children.set(r,o),o},e.prototype.spawnActor=function(t,r){return this.children.set(r,t),t},e.prototype.spawnActivity=function(t){var r=this.machine.options&&this.machine.options.activities?this.machine.options.activities[t.type]:void 0;if(r){var n=r(this.state.context,t);this.spawnEffect(t.id,n)}},e.prototype.spawnEffect=function(t,r){this.children.set(t,{id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:r||void 0,getSnapshot:function(){},toJSON:function(){return{id:t}}})},e.prototype.attachDev=function(){var t=rn();if(this.options.devTools&&t){if(t.__REDUX_DEVTOOLS_EXTENSION__){var r=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=t.__REDUX_DEVTOOLS_EXTENSION__.connect(b(b({name:this.id,autoPause:!0,stateSanitizer:function(n){return{value:n.value,context:n.context,actions:n.actions}}},r),{features:b({jump:!1,skip:!1},r?r.features:void 0)}),this.machine),this.devTools.init(this.state)}Jf(this)}},e.prototype.toJSON=function(){return{id:this.id}},e.prototype[yf]=function(){return this},e.prototype.getSnapshot=function(){return this.status===q.NotStarted?this.initialState:this._state},e.defaultOptions=function(t){return{execute:!0,deferEvents:!0,clock:{setTimeout:function(r,n){return setTimeout(r,n)},clearTimeout:function(r){return clearTimeout(r)}},logger:t.console.log.bind(console),devTools:!1}}(typeof self<"u"?self:cr),e.interpret=so,e}();function so(e,t){var r=new Qf(e,t);return r}var Zf=Object.defineProperty,ct=(e,t)=>{for(var r in t)Zf(e,r,{get:t[r],enumerable:!0})},eh={};ct(eh,{ADMIN_SCOPE:()=>bo,ALL:()=>ye,EPHEMERAL_SCOPE:()=>Vh,TEAM_SCOPE:()=>nt,Team:()=>Jt,createTeam:()=>wv,decryptTeamGraph:()=>No,getDeviceUserFromGraph:()=>ko,initialState:()=>xe,isAdminOnlyAction:()=>nn,isNewTeam:()=>Lo,load:()=>Av,membershipResolver:()=>Ct,redactUser:()=>xr});var th=e=>{const t=r=>{switch(r.type){case"ADD_MEMBER":return r.payload.member.userId;case"REMOVE_MEMBER":return r.payload.userId;case"ADD_ROLE":return r.payload.roleName;case"ADD_MEMBER_ROLE":case"REMOVE_MEMBER_ROLE":return`${r.payload.roleName}:${r.payload.userId}`;case"ADD_DEVICE":return r.payload.device.deviceName;case"REMOVE_DEVICE":return r.payload.deviceId;case"INVITE_MEMBER":case"INVITE_DEVICE":return r.payload.invitation.id;case"REVOKE_INVITATION":return r.payload.id;case"ADMIT_MEMBER":case"ADMIT_DEVICE":return r.payload.id;case"CHANGE_MEMBER_KEYS":case"CHANGE_DEVICE_KEYS":return JSON.stringify(r.payload.keys);default:return JSON.stringify(r.payload)}};return e.body.type==="ROOT"?"ROOT":`${e.body.type}:${t(e.body)}`},oo=(e,t)=>{if(!e||!t)return!1;const r=n=>n.sort().join(",");return r(e)===r(t)};function O(e,t="Assertion failed"){if(e===!1||e===null||e===void 0){const r=new Error(rh(t));throw r.stack=nh(r.stack,"assert.ts"),r}}var rh=e=>e.split(`
`).map(t=>t.trim()).join(`
`),nh=(e="",t)=>e.split(`
`).filter(r=>!r.includes(t)).join(`
`),nn=e=>!["INVITE_DEVICE","ADD_DEVICE","CHANGE_MEMBER_KEYS","CHANGE_DEVICE_KEYS","CHANGE_SERVER_KEYS","ADMIT_MEMBER","ADMIT_DEVICE"].includes(e.type),ih={};ct(ih,{ADMIN:()=>ee});var ee="admin",sh=e=>(t,r)=>{if(ei(e,t))return-1;if(ei(e,r))return 1;const n=o=>{const a=u=>u.body.type==="ADD_MEMBER"&&u.body.payload.member.userId===o,c=Object.values(e.links).find(a);return O(c,`Could not find link that added member ${o}`),c},[i,s]=[t,r].map(n);return El(e,i,s)?-1:1},ei=(e,t)=>e.links[e.root].body.userId===t,Ct=e=>{const t=Al(e).map(n=>n.map(i=>e.links[i])),r=[];for(let n of t)for(const i in ti){const s=ti[i],o=s(n,e),a=o.flatMap(c=>ao(n,c));r.push(...o,...a),n=n.filter(ii(r))}return{filter:ii(r)}},ao=(e,t)=>{const r=[];switch(t.body.type){case"INVITE_MEMBER":case"INVITE_DEVICE":{const{invitation:i}=t.body.payload;r.push(...e.filter(vh(i)));break}case"ADMIT_MEMBER":{const i=t.body.payload.memberKeys.name;r.push(...e.filter(fo(i)));break}}const n=r.flatMap(i=>ao(e,i));return r.concat(n)},ti={resolveMutualRemovals(e,t){const r=ri(e),n=lo(e).map(on);return r.length>0&&oo(r,n)?e.filter(fo(oh(t,n))):[]},cantAddBackRemovedMember(e){const t=ri(e);return uh(e).filter(r=>t.includes(hh(r)))},cantDoAnythingWhenRemoved(e){const t=lh(e);return e.filter(ni(t))},cantDoAdminActionsWhenDemoted(e){const t=fh(e),r=ni(t),n=i=>nn(i.body);return e.filter(i=>r(i)&&n(i))}},oh=(e,t)=>t.sort(sh(e)).pop(),ah=e=>["ADD_MEMBER","ADD_MEMBER_ROLE","ADMIT_MEMBER"].includes(e.body.type),ch=e=>e.body.type==="REMOVE_MEMBER",uh=e=>e.filter(ah),co=e=>e.filter(ch),dh=e=>e.body.type==="REMOVE_MEMBER_ROLE"&&e.body.payload.roleName===ee,uo=e=>e.filter(dh),lo=e=>co(e).concat(uo(e)),ri=e=>lo(e).map(sn),lh=e=>co(e).map(sn),fh=e=>uo(e).map(sn),sn=e=>e.body.payload.userId,on=e=>e.body.userId,fo=e=>t=>on(t)===e,ni=e=>t=>e.includes(on(t)),hh=e=>{switch(e.body.type){case"ADD_MEMBER":return e.body.payload.member.userId;case"ADD_MEMBER_ROLE":return e.body.payload.userId;case"ADMIT_MEMBER":return e.body.payload.memberKeys.name}},ii=e=>t=>!e.includes(t),vh=e=>t=>(t.body.type==="ADMIT_MEMBER"||t.body.type==="ADMIT_DEVICE")&&t.body.payload.id===e.id,yh="SIGNATURE",ph="ENCRYPTION",mh="SYMMETRIC",gh="LINK_HASH",Eh="LINK_TO_PREVIOUS",bh="INVITATION",Ih="DEVICE_ID",Sh="SHARED_KEY",ho={SIGNATURE:yh,ENCRYPTION:ph,SYMMETRIC:mh,LINK_HASH:gh,LINK_TO_PREVIOUS:Eh,INVITATION:bh,DEVICE_ID:Ih,SHARED_KEY:Sh},se={isValid:!0},wh=e=>t=>e.reduce((r,n)=>n(r),t);function Me(e){if(typeof e=="string"){const t=/(?:[A-Za-z\d+/=]{32,9999999})?/g;return e.replaceAll(t,r=>r.slice(0,5))}if(Array.isArray(e))return e.map(Me);if(typeof e=="object"){const t={};for(const r in e){const n=e[r];t[Me(r)]=Me(n)}return t}return e}var Th=kr.formatArgs;kr.formatArgs=function(e){for(let t=0;t<e.length;t++)e[t]=Me(e[t]);Th.call(this,e)};var an=kr("lf:auth"),si=e=>({type:e.type,name:e.name}),_h=e=>`${e.recipient.name}(${Ah(e.recipient.publicKey)}):${e.contents.name}#${e.contents.generation}`,Ah=e=>e.slice(0,5),Wt=Nr,vo=(e,t)=>e.type===t.type&&e.name===t.name,oi=(e,t)=>{O(vo(e,t),`The scope of the new keys must match those of the old lockbox. 
     New scope: ${JSON.stringify(si(e))} 
     Old scope: ${JSON.stringify(si(t))}`)},F={GRAPH:"GRAPH",TEAM:"TEAM",ROLE:"ROLE",USER:"USER",DEVICE:"DEVICE",SERVER:"SERVER",EPHEMERAL:"EPHEMERAL"},Mh=class extends Error{constructor(e,t){super(),this.message=e,this.details=t}name;details},xh=e=>({...e,nonce:de(),timestamp:Date.now()}),Oh=(e,t)=>me.sign(e,t.signature.secretKey),Rh=(e,t,r)=>{const n={challenge:e,signature:t};return me.verify({payload:e,signature:t,publicKey:r.signature})?se:Lh("Signature is not valid",n)},Lh=(e,t)=>({isValid:!1,error:new Nh(e,t)}),Nh=class extends Error{constructor(e,t){super(),this.name="Identity challenge failed",this.message=e+`
`+JSON.stringify(t,null,2).replaceAll('"',""),this.details=t}details},Dh={};ct(Dh,{createDevice:()=>kh,createFirstUseDevice:()=>Ph,redactDevice:()=>tt});var kh=(e,t,r=de())=>{const n=Vt(),i=ie({type:F.DEVICE,name:n},r);return{userId:e,deviceId:n,deviceName:t,keys:i}},Ph=(e,t=de())=>{const r=Vt(),n=ie({type:F.DEVICE,name:r},t);return{deviceName:e,deviceId:r,keys:n}},tt=e=>({userId:e.userId,deviceId:e.deviceId,deviceName:e.deviceName,keys:ae(e.keys)}),Ch={};ct(Ch,{IKEY_LENGTH:()=>po,InvitationValidationError:()=>Eo,create:()=>Ar,fail:()=>pe,generateProof:()=>mo,generateStarterKeys:()=>ut,invitationCanBeUsed:()=>cn,randomSeed:()=>Mr,validate:()=>go});var rt=e=>e.toLowerCase().replaceAll(/[^a-z\d]/gi,""),ut=Wt(e=>(e=rt(e),ie(Ds,e)));function yo(e){const t=mi(e);return oe(ho.INVITATION,t).slice(0,15)}var po=16,Ar=({seed:e,maxUses:t=1,expiration:r=0,userId:n})=>{e=rt(e);const i=yo(e),s=ut(e),{publicKey:o}=s.signature;return{id:i,publicKey:o,expiration:r,maxUses:t,userId:n}},Mr=(e=po)=>de(e),mo=Wt(e=>{e=rt(e);const t=yo(e),r=ut(e),n={id:t},i=me.sign(n,r.signature.secretKey);return{id:t,signature:i}}),cn=(e,t)=>{const{revoked:r,maxUses:n,uses:i,expiration:s}=e;return r?pe("The invitation has been revoked"):n>0&&i>=n?pe("The invitation cannot be used again"):s>0&&s<t?pe("The invitation has expired"):se},go=Wt((e,t)=>{const{id:r,signature:n}=e;if(r!==t.id)return pe("IDs don't match",{proof:e,invitation:t});const{publicKey:i}=t;return me.verify({payload:{id:r},signature:n,publicKey:i})?se:pe("Signature provided is not valid",{proof:e,invitation:t})}),pe=(e,t)=>({isValid:!1,error:new Eo(e,t)}),Eo=class extends Error{constructor(e,t){super(),this.name="Invitation validation failed",this.message=e,this.details=t}index;details},ai=e=>e.hasOwnProperty("publicKey"),Q=(e,t)=>{const r=ai(t)?t:ae(t),n=ae(e),i=ce.keyPair(),s=ai(r)?r.publicKey:r.encryption,o=ce.encrypt({secret:e,recipientPublicKey:s,senderSecretKey:i.secretKey});return{encryptionKey:{...Ds,publicKey:i.publicKey},recipient:{...r,publicKey:s},contents:{...n,publicKey:e.encryption.publicKey},encryptedPayload:o}},$h=Wt((e,t)=>{const{encryptionKey:r,encryptedPayload:n}=e;return ce.decrypt({cipher:n,senderPublicKey:r.publicKey,recipientSecretKey:t.encryption.secretKey})}),Kh=({oldLockbox:e,newContents:t,updatedRecipientKeys:r})=>{oi(t,e.contents),r&&oi(e.recipient,r),t.generation=e.contents.generation+1;const n=r??e.recipient;return Q(t,n)},Bh=e=>({userId:e.host,userName:e.host,keys:e.keys,roles:[]}),Hh=e=>({userId:e.host,userName:e.host,keys:e.keys}),jh=e=>({userId:e.host,deviceName:e.host,deviceId:e.host,keys:e.keys}),We={toMember:Bh,toUser:Hh,toDevice:jh},ye="ALL",xe={head:[],teamName:"",members:[],servers:[],roles:[],lockboxes:[],invitations:{},messages:[],removedMembers:[],removedDevices:[],removedServers:[],pendingKeyRotations:[]},nt={type:F.TEAM,name:F.TEAM},bo={type:F.ROLE,name:ee},Vh={type:F.EPHEMERAL,name:F.EPHEMERAL},xr=e=>({...sf(e),roles:[]}),Uh=(e,t)=>{switch(t.body.type){case"ADMIT_MEMBER":{const r=t.body.payload.memberKeys,n=r.name,i={userName:"",userId:n,keys:r,roles:[]},s=[...e.removedMembers,i],o=[...e.pendingKeyRotations];return o.includes(n)||o.push(n),{...e,removedMembers:s,pendingKeyRotations:o}}}return e},Fh=e=>t=>({...t,head:[e.hash]}),rr=e=>t=>{const{userId:r}=e;return{...t,members:t.members.map(n=>{if(n.userId===r){const{devices:i=[]}=n;return i.find(s=>s.deviceId===e.deviceId)?n:{...n,devices:[...i,e]}}return n}),removedDevices:t.removedDevices.filter(n=>n.keys.name===e.deviceId)}},nr=e=>t=>({...t,members:[...t.members,{...e,roles:[]}],removedMembers:t.removedMembers.filter(r=>r.userId===e.userId)}),ir=(e,t=[])=>t.map(r=>n=>({...n,members:n.members.map(i=>({...i,roles:i.userId!==e||i.roles.includes(r)?i.roles:[...i.roles,r]}))})),Gh=e=>t=>({...t,messages:[...t.messages,e]}),ci=e=>t=>({...t,roles:[...t.roles,e]}),Yh=e=>t=>({...t,servers:[...t.servers,{...e,roles:[]}],removedservers:t.removedServers.filter(r=>r.host===e.host)}),un=(e,t,r={includeRemoved:!1})=>{const i=[...e.servers,...r.includeRemoved?e.removedServers:[]].find(s=>s.host===t);if(i===void 0)throw new Error(`A server with host '${t}' was not found`);return i},dn=(e,t)=>e.servers.find(r=>r.host===t)!==void 0,Io=(e,t,r={includeRemoved:!1})=>So(e,t,r)!==void 0,dt=(e,t,r={includeRemoved:!1})=>{const n=So(e,t,r);return O(n,`Device ${t} not found`),n},So=(e,t,r={includeRemoved:!1})=>dn(e,t)?We.toDevice(un(e,t)):e.members.concat(r.includeRemoved?e.removedMembers??[]:[]).flatMap(s=>s.devices??[]).find(s=>s.deviceId===t)??(r.includeRemoved?e.removedDevices.find(s=>s.deviceId===t):void 0),Wh=(e,t)=>Io(e,t,{includeRemoved:!0})?e.removedDevices.some(r=>r.keys.name===t):!1,wo=(e,t)=>e.members.find(r=>r.userId===t)!==void 0,zh=(e,t)=>e.roles.find(r=>r.roleName===t)!==void 0;function ln(e,t){return t in e.invitations}function fn(e,t){return O(ln(e,t),`No invitation with id '${t}' found.`),e.invitations[t]}var To=(e,t)=>{const{lockboxes:r}=e,{publicKey:n}=t.encryption,s=r.filter(({recipient:a})=>a.publicKey===n).map(a=>$h(a,t)),o=s.flatMap(a=>To(e,a));return[...s,...o]},_o=(e,t)=>To(e,t).reduce(Jh,{}),Jh=(e,t)=>{const{type:r,name:n,generation:i}=t,s=e[r]??{},o=s[n]??[];return o[i]=t,{...e,[r]:{...s,[n]:o}}},hn=(e,t,r)=>{const{type:n,name:i}=r,s=_o(e,t),o=s[n]?s[n][i]:void 0;O(o,`Couldn't find keys: ${JSON.stringify(r)}
     Device: ${t.name}
     Available lockboxes: 
- ${e.lockboxes.map(_h).join(`
- `)} 
     Keymap: ${JSON.stringify(s,null,2)}`);const a="generation"in r&&r.generation!==void 0?r.generation:o.length-1;return o[a]},qh=(e,t)=>{const r=e.lockboxes.filter(({contents:s})=>s.type===t.type&&s.name===t.name),n=r.reduce(Xh,0);return r.filter(({contents:s})=>s.generation===n)},Xh=(e,t)=>{const{generation:r}=t.contents;return r>e?r:e},zt=(e,t,r={includeRemoved:!1})=>{const i=[...e.members,...r.includeRemoved?e.removedMembers:[]].find(s=>s.userId===t);if(i===void 0)throw new Error(`A member named '${t}' was not found`);return i},Ao=(e,t,r={includeRemoved:!1})=>{if(dn(e,t))return We.toMember(un(e,t));const{userId:n}=dt(e,t,r);return zt(e,n,r)},Mo=(e,t,r)=>{if(!wo(e,t))return!1;const n=zt(e,t),{roles:i=[]}=n;return i.includes(r)},Or=(e,t)=>Mo(e,t,ee),Qh=(e,t)=>e.removedMembers.some(r=>r.userId===t),xo=(e,t)=>e.members.filter(r=>r.roles?.includes(t)),Zh=e=>xo(e,ee),ev=e=>e.messages,tv=(e,t)=>{const r=e.roles.find(n=>n.roleName===t);if(!r)throw new Error(`A role called '${t}' was not found`);return r},rv=(e,t=r=>r)=>$d(e,t),Oo=(e,{type:t,name:r})=>{const n=e.lockboxes.filter(({recipient:o})=>o.type===t&&o.name===r).map(({contents:{type:o,name:a}})=>({type:o,name:a})),i=n.flatMap(o=>Oo(e,o)),s=[...n,...i];return rv(s,o=>o.name+o.type)},nv=(e,t)=>e.removedServers.some(r=>r.host===t),{TEAM:ui}=F,iv=(e,t)=>{const r=_o(e,t)[ui][ui];return ke(r)},sv=e=>t=>{const r=e.name,n=dt(t,r),{userId:i,deviceName:s}=n;return{...t,members:t.members.map(o=>o.userId===i?{...o,devices:o.devices?.map(a=>a.deviceName===s?{...a,keys:e}:a)}:o)}},ov=e=>t=>({...t,members:t.members.map(r=>r.userId===e.name?{...r,keys:e}:r)}),av=e=>t=>({...t,servers:t.servers.map(r=>r.host===e.name?{...r,keys:e}:r)}),cv=e=>t=>{const{lockboxes:r}=t;return e?{...t,lockboxes:r.concat(e)}:t},di=e=>t=>{const r={...e,uses:0,revoked:!1};return{...t,invitations:{...t.invitations,[e.id]:r}}},uv=e=>t=>{const r=dt(t,e),{userId:n}=Ao(t,e),i=a=>a.userId===n?{...a,devices:a.devices?.filter(c=>c.deviceName!==r.deviceName)}:a,s=t.members.map(i),o=[...t.removedDevices,r];return{...t,members:s,removedDevices:o}},dv=e=>t=>{const r=t.members.filter(s=>s.userId!==e),n=t.members.find(s=>s.userId===e),i=[...t.removedMembers];return n&&i.push(n),{...t,members:r,removedMembers:i}},lv=(e,t)=>r=>({...r,members:r.members.map(n=>({...n,roles:n.userId===e?n.roles.filter(i=>i!==t):n.roles})),lockboxes:r.lockboxes.filter(n=>!(n.recipient.name===e&&n.contents.type===F.ROLE&&n.contents.name===t))}),fv=e=>t=>({...t,roles:t.roles.filter(r=>r.roleName!==e),lockboxes:t.lockboxes.filter(r=>!(r.contents.type===F.ROLE&&r.contents.name===e))}),hv=e=>t=>{const r=t.servers.filter(s=>s.host!==e),n=t.servers.find(s=>s.host===e),i=[...t.removedServers];return n&&i.push(n),{...t,servers:r,removedServers:i}},vv=e=>t=>{const r={...t.invitations},n={...r[e],revoked:!0};return{...t,invitations:{...r,[e]:n}}},yv=e=>t=>{const r=t.pendingKeyRotations.filter(n=>n!==e);return{...t,pendingKeyRotations:r}},li=e=>t=>({...t,teamName:e}),fi=e=>t=>{const r={...t.invitations},n=r[e],i=n.uses+1;return{...t,invitations:{...r,[e]:{...n,uses:i}}}},pv=an.extend("validate"),mv=(...e)=>{for(const t in hi){const r=hi[t],n=r(...e);if(!n.isValid)return n}return se},hi={mustBeAdmin(...e){const[t,r]=e,n=r.body,{type:i,userId:s}=n;return i===Ut?se:nn(n)&&!Or(t,s)?sr(`Member '${s}' is not an admin`,...e):se},canOnlyChangeYourOwnKeys(...e){const[t,r]=e,n=r.body.userId;if(!Or(t,n)){if(r.body.type==="CHANGE_MEMBER_KEYS"){const s=r.body.payload.keys.name;if(n!==s)return sr("Can't change another user's keys.",...e)}else if(r.body.type==="CHANGE_DEVICE_KEYS"){const s=r.body.payload.keys.name,o=dt(t,s),{userId:a}=o;if(n!==a)return sr("Can't change another user's device keys.",...e)}}return se},cantAdmitWithInvalidInvitation(...e){const[t,r]=e;if(r.body.type==="ADMIT_MEMBER"||r.body.type==="ADMIT_DEVICE"){const{id:n}=r.body.payload,i=fn(t,n);return cn(i,r.body.timestamp)}return se}},sr=(e,t,r)=>(e=Me(`${th(r)} ${e}`),pv(e),{isValid:!1,error:new Mh(e,{prevState:t,link:r})}),$t=(e,t)=>{if(t.isInvalid)return Uh(e,t);e=Uu(e);const r=mv(e,t);if(!r.isValid)throw r.error;const n=t.body;return wh([Fh(t),cv(n.payload.lockboxes),...gv(n)])(e)},gv=e=>{switch(e.type){case Ut:{const{name:t,rootMember:r,rootDevice:n}=e.payload;return[li(t),ci({roleName:ee}),nr(r),rr(n),...ir(r.userId,[ee])]}case"ADD_MEMBER":{const{member:t,roles:r}=e.payload;return[nr(t),...ir(t.userId,r)]}case"ADD_ROLE":{const t=e.payload;return[ci(t)]}case"ADD_MEMBER_ROLE":{const{userId:t,roleName:r}=e.payload;return[...ir(t,[r])]}case"REMOVE_MEMBER":{const{userId:t}=e.payload;return[dv(t)]}case"ADD_DEVICE":{const{device:t}=e.payload;return[rr(t)]}case"REMOVE_DEVICE":{const{deviceId:t}=e.payload;return[uv(t)]}case"REMOVE_ROLE":{const{roleName:t}=e.payload;return[fv(t)]}case"REMOVE_MEMBER_ROLE":{const{userId:t,roleName:r}=e.payload;return[lv(t,r)]}case"INVITE_MEMBER":{const{invitation:t}=e.payload;return[di(t)]}case"INVITE_DEVICE":{const{invitation:t}=e.payload;return[di(t)]}case"REVOKE_INVITATION":{const{id:t}=e.payload;return[vv(t)]}case"ADMIT_MEMBER":{const{id:t,memberKeys:r,userName:n}=e.payload,s={userId:r.name,userName:n,keys:r,roles:[]};return[fi(t),nr(s)]}case"ADMIT_DEVICE":{const{id:t,device:r}=e.payload;return[fi(t),rr(r)]}case"CHANGE_MEMBER_KEYS":{const{keys:t}=e.payload;return[ov(t)]}case"CHANGE_DEVICE_KEYS":{const{keys:t}=e.payload;return[sv(t)]}case"ROTATE_KEYS":{const{userId:t}=e.payload;return[yv(t)]}case"ADD_SERVER":{const{server:t}=e.payload;return[Yh(t)]}case"REMOVE_SERVER":{const{host:t}=e.payload;return[hv(t)]}case"CHANGE_SERVER_KEYS":{const{keys:t}=e.payload;return[av(t)]}case"MESSAGE":{const{message:t}=e.payload;return[Gh(t)]}case"SET_TEAM_NAME":{const{teamName:t}=e.payload;return[li(t)]}default:throw Ev(e)}};function Ev(e){const{type:t}=e;return new Error(`Unrecognized link type: ${t}`)}var bv=e=>{const t=Jr(e),{encryptedLinks:r,head:n,root:i}=e;return JSON.stringify({encryptedLinks:r,childMap:t,head:n,root:i})},Ro=(e,t)=>{const r=JSON.parse(e);return zr({encryptedGraph:r,keys:t})},Iv=(e,t)=>Sv(e)?e:Ro(e,t),Sv=e=>e?.hasOwnProperty("root"),Lo=e=>"teamName"in e,{DEVICE:or,USER:ar}=F,Jt=class extends gi{state=xe;store;context;log;seed;constructor(e){if(super(),this.seed=e.seed??de(),"user"in e.context)this.context=e.context;else{const{server:n}=e.context;this.context={...e.context,device:We.toDevice(n),user:We.toUser(n)}}const{device:t,user:r}=this.context;if(this.log=an.extend(`team:${this.userName}`),Lo(e)){O(!this.isServer,"Servers can't create teams");const n=Q(e.teamKeys,r.keys),i=ie(bo,this.seed),s=Q(i,r.keys),o=Q(r.keys,this.context.device.keys),a={name:e.teamName,rootMember:xr(r),rootDevice:tt(t),lockboxes:[n,s,o]};this.store=Fn({user:r,reducer:$t,resolver:Ct,initialState:xe,rootPayload:a,keys:e.teamKeys})}else this.store=Fn({user:r,reducer:$t,resolver:Ct,initialState:xe,graph:Iv(e.source,e.teamKeyring),keys:e.teamKeyring});this.state=this.store.getState(),this.on("updated",()=>{this.checkForPendingKeyRotations()})}get graph(){return this.store.getGraph()}get id(){return this.graph.root}get teamName(){return this.state.teamName}setTeamName(e){this.dispatch({type:"SET_TEAM_NAME",payload:{teamName:e}})}get userName(){return this.context.user?this.context.user.userId:this.context.device.userId}get userId(){return this.context.user?this.context.user.userId:this.context.device.userId}get isServer(){return"server"in this.context}save=()=>bv(this.graph);merge=e=>(this.store.merge(e),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head}),this);dispatch(e,t=this.teamKeys()){this.store.dispatch(e,t),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head})}has=e=>wo(this.state,e);members(e=ye,t={includeRemoved:!0}){return e===ye?this.state.members:zt(this.state,e,t)}addForTesting=(e,t=[],r)=>{const n={...xr(e),roles:t},i=this.createMemberLockboxes(n);if(this.dispatch({type:"ADD_MEMBER",payload:{member:n,roles:t,lockboxes:i}}),r){const s=Q(e.keys,r.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:r,lockboxes:[s]}})}};remove=e=>{const t=this.rotateKeys({type:ar,name:e});this.dispatch({type:"REMOVE_MEMBER",payload:{userId:e,lockboxes:t}})};memberWasRemoved=e=>Qh(this.state,e);roles(e=ye){return e===ye?this.state.roles:tv(this.state,e)}memberHasRole=(e,t)=>Mo(this.state,e,t);memberIsAdmin=e=>Or(this.state,e);hasRole=e=>zh(this.state,e);membersInRole=e=>xo(this.state,e);admins=()=>Zh(this.state);addRole=e=>{typeof e=="string"&&(e={roleName:e});const t=ie({type:F.ROLE,name:e.roleName},this.seed),r=Q(t,this.adminKeys());this.dispatch({type:"ADD_ROLE",payload:{...e,lockboxes:[r]}})};removeRole=e=>{O(e!==ee,"Cannot remove admin role"),this.dispatch({type:"REMOVE_ROLE",payload:{roleName:e}})};addMemberRole=(e,t)=>{const r=this.members(e),n=Q(this.roleKeys(t),r.keys);this.dispatch({type:"ADD_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:[n]}})};removeMemberRole=(e,t)=>{if(t===ee){const n=this.membersInRole(ee).length;O(n>1,"Can't remove the last admin")}const r=this.rotateKeys({type:F.ROLE,name:t});this.dispatch({type:"REMOVE_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:r}})};hasDevice=(e,t)=>Io(this.state,e,t);device(e,t){return dt(this.state,e,t)}removeDevice=e=>{if(!this.hasDevice(e))return;const t=this.rotateKeys({type:or,name:e});this.dispatch({type:"REMOVE_DEVICE",payload:{deviceId:e,lockboxes:t}})};deviceWasRemoved=e=>Wh(this.state,e);memberByDeviceId=(e,t)=>Ao(this.state,e,t);verifyIdentityProof=(e,t)=>{O(e.type===or);const r=e.name,n=this.hasServer(r)?this.servers(r):this.device(r,{includeRemoved:!0});return Rh(e,t,n.keys).isValid};inviteMember({seed:e=Mr(),expiration:t,maxUses:r}={}){e=rt(e);const n=Ar({seed:e,expiration:t,maxUses:r}),{id:i}=n;return this.dispatch({type:"INVITE_MEMBER",payload:{invitation:n}}),{id:i,seed:e}}inviteDevice({seed:e=Mr(),expiration:t=Date.now()+30*60*1e3}={}){O(!this.isServer,"Servers can't invite a device"),e=rt(e);const n=Ar({seed:e,expiration:t,maxUses:1,userId:this.userId}),i=ut(e),s=Q(this.context.user.keys,i),{id:o}=n;return this.dispatch({type:"INVITE_DEVICE",payload:{invitation:n,lockboxes:[s]}}),{id:o,seed:e}}revokeInvitation=e=>{this.dispatch({type:"REVOKE_INVITATION",payload:{id:e}})};hasInvitation(e){const t=typeof e=="string"?e:e.id;return ln(this.state,t)}getInvitation=e=>fn(this.state,e);validateInvitation=e=>{const{id:t}=e;if(!this.hasInvitation(t))return pe("This invitation code doesn't match.");const r=this.getInvitation(t),n=cn(r,Date.now());return n!==se?n:go(e,r)};admitMember=(e,t,r)=>{const n=this.validateInvitation(e);if(!n.isValid)throw n.error;const{id:i}=e,s=Q(this.teamKeys(),t);this.dispatch({type:"ADMIT_MEMBER",payload:{id:i,userName:r,memberKeys:ae(t),lockboxes:[s]}})};admitDevice=(e,t)=>{const r=this.validateInvitation(e);if(!r.isValid)throw r.error;const{id:n}=e,s=this.getInvitation(n).userId,o={...t,userId:s};this.dispatch({type:"ADMIT_DEVICE",payload:{id:n,device:o}})};join=e=>{O(!this.isServer,"Can't join as member on server");const{user:t,device:r}=this.context,n=Jl(e),i=Q(t.keys,r.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:tt(r),lockboxes:[i]}},n)};addServer=e=>{const t=this.createMemberLockboxes(We.toMember(e));this.dispatch({type:"ADD_SERVER",payload:{server:e,lockboxes:t}})};removeServer=e=>{this.dispatch({type:"REMOVE_SERVER",payload:{host:e}})};servers(e=ye,t={includeRemoved:!0}){return e===ye?this.state.servers:un(this.state,e,t)}serverWasRemoved=e=>nv(this.state,e);hasServer=e=>dn(this.state,e);addMessage=e=>{this.dispatch({type:"MESSAGE",payload:{message:e}})};messages=()=>ev(this.state);encrypt=(e,t)=>{const r=t?{type:F.ROLE,name:t}:nt,{secretKey:n,generation:i}=this.keys(r);return{contents:Tt.encrypt(e,n),recipient:{...r,generation:i}}};decrypt=e=>{const{secretKey:t}=this.keys(e.recipient);return Tt.decrypt(e.contents,t)};sign=e=>{O(this.context.user);const{keys:{type:t,name:r,generation:n,signature:{secretKey:i}}}=this.context.user;return{contents:e,signature:me.sign(e,i),author:{type:t,name:r,generation:n}}};verify=e=>me.verify({payload:e.contents,signature:e.signature,publicKey:this.members(e.author.name).keys.signature});keys=e=>hn(this.state,this.context.device.keys,e);roleKeys=(e,t)=>this.keys({type:F.ROLE,name:e,generation:t});teamKeys=e=>this.keys({...nt,generation:e});teamKeyring=()=>iv(this.state,this.context.device.keys);adminKeys=e=>this.roleKeys(ee,e);changeKeys=e=>{const{device:t,user:r}=this.context,n=e.type===ar,i=e.type===or,s=e.type===F.SERVER,o=i?t.keys:r.keys;e.generation=o.generation+1;const a=this.rotateKeys(e),c=i?"CHANGE_DEVICE_KEYS":n?"CHANGE_MEMBER_KEYS":"CHANGE_SERVER_KEYS",u=ae(e);this.dispatch({type:c,payload:{keys:u,lockboxes:a}}),(s||i)&&(t.keys=e),(s||n)&&(r.keys=e)};checkForPendingKeyRotations(){if(this.memberIsAdmin(this.userId))for(const e of this.state.pendingKeyRotations){const t=this.rotateKeys({type:ar,name:this.userId});this.dispatch({type:"ROTATE_KEYS",payload:{userId:e,lockboxes:t}})}}createMemberLockboxes=e=>{const t=e.roles.map(this.roleKeys),r=n=>Q(n,e.keys);return[...t,this.teamKeys()].map(r)};rotateKeys=e=>{const t=Ft(e)?e:ie(e),n=Oo(this.state,e).map(o=>ie(o)),i=[t,...n];return i.flatMap(o=>qh(this.state,o).map(c=>{const u=i.find(d=>vo(d,c.recipient));return Kh({oldLockbox:c,newContents:o,updatedRecipientKeys:u?ae(u):void 0})}))}};function wv(e,t,r){const n=ie(nt,r);return new Jt({teamName:e,context:t,teamKeys:n})}var No=({encryptedGraph:e,teamKeys:t,deviceKeys:r})=>{const n=ke(t),{encryptedLinks:i,childMap:s,root:o}=e,a=e.links??{},c=(l,v,m={},p=xe)=>{const y=i[l],g=a[l]??$s(y,v);let E={[l]:g};const w=$t(p,g);let S;try{S=hn(w,r,nt),n[S.encryption.publicKey]=S}catch{S=v}const A=s[l];if(A)for(const N of A)E={...E,...c(N,S,E,w)};return{...m,...E}},u=i[o].recipientPublicKey,d=n[u],f=c(o,d);return{...e,links:f}},Tv=js({initialState:xe,reducer:$t,resolver:Ct}),Do=(e,t)=>{const r=Ro(e,t);return Tv(r)},{USER:_v}=F,ko=({serializedGraph:e,teamKeyring:t,starterKeys:r,invitationId:n})=>{const i=Do(e,t),{userId:s}=fn(i,n);O(s);const{userName:o}=zt(i,s);O(o);const a=hn(i,r,{type:_v,name:s});return{userName:o,userId:s,keys:a}},Av=(e,t,r)=>{const n=ke(r);return new Jt({source:e,context:t,teamKeyring:n})},Mv={};ct(Mv,{Connection:()=>$v,buildError:()=>Rr,connectionErrors:()=>Po,isInvitee:()=>lt,isInviteeDevice:()=>$o,isInviteeMember:()=>vn,isMember:()=>Pv,isNumberedConnectionMessage:()=>Co,isServer:()=>Ko});var xv=(e,t)=>{const r=[e,t].sort().map(i=>Fo.decode(i)).reduce((i,s)=>new Uint8Array([...i,...s]),new Uint8Array);return oe(ho.SHARED_KEY,r)},Po={MEMBER_UNKNOWN:{localMessage:"The peer is not a member of this team",remoteMessage:"You are not a member of this team"},MEMBER_REMOVED:{localMessage:"The peer was removed from this team",remoteMessage:"You were removed from this team"},DEVICE_UNKNOWN:{localMessage:"The peer's device isn't listed on this team",remoteMessage:"Your device isn't listed on this team"},DEVICE_REMOVED:{localMessage:"The peer's device was removed from this team",remoteMessage:"Your device was removed from this team"},NEITHER_IS_MEMBER:{localMessage:"The peer is also holding an invitation and cannot admit you to the team",remoteMessage:"The peer is also holding an invitation and cannot admit you to the team"},IDENTITY_PROOF_INVALID:{localMessage:"The peer's proof of identity is not valid",remoteMessage:"Your proof of identity isn't valid"},INVITATION_PROOF_INVALID:{localMessage:"The peer's invitation wasn't accepted",remoteMessage:"Your invitation wasn't accepted"},JOINED_WRONG_TEAM:{localMessage:"This isn't the team you were invited to",remoteMessage:"This isn't the team the peer was invited to"},TIMEOUT:{localMessage:"We didn't hear back from the peer; giving up",remoteMessage:"The peer didn't hear back from us, so they gave up"}},Rr=(e,t,r="LOCAL")=>{const{localMessage:n,remoteMessage:i}=Po[e];return{type:r==="LOCAL"?"LOCAL_ERROR":"ERROR",payload:{type:e,message:r==="LOCAL"?n:i,details:t}}},Ov=new Set(["ACCEPT_IDENTITY","ACCEPT_INVITATION","CHALLENGE_IDENTITY","CLAIM_IDENTITY","DISCONNECT","ENCRYPTED_MESSAGE","ERROR","LOCAL_ERROR","LOCAL_UPDATE","PROVE_IDENTITY","REJECT_IDENTITY","REQUEST_IDENTITY","SEED","SYNC"]);function Co(e){return"index"in e&&typeof e.index=="number"&&"type"in e&&Ov.has(e.type)}var Rv=(e,t)=>{const{index:r}=t,n={...e,[r]:t},i=Nv(n),s=[];let o=Lv(e);for(;o in n&&o<=i;)s.push(n[o]),o+=1;return{queue:n,nextMessages:s}},Lv=e=>{let t=0;for(;t in e;)t+=1;return t},Nv=e=>Math.max(...Object.keys(e).map(Number)),Lr=e=>{if(e===void 0)return"DONE";const{head:t,links:r,need:n}=e,i={head:t};return r&&(i.links=Object.keys(r).join(", ")),n&&(i.need=n.join(", ")),Me(JSON.stringify(i))},Dv=7e3,Ke={after:{[Dv]:{actions:"failTimeout",target:"#disconnected"}}},kv={id:"connection",initial:"awaitingIdentityClaim",on:{REQUEST_IDENTITY:{actions:"sendIdentityClaim",target:"awaitingIdentityClaim"},ERROR:{actions:"receiveError",target:"#disconnected"},LOCAL_ERROR:{actions:"sendError",target:"#disconnected"}},states:{awaitingIdentityClaim:{id:"awaitingIdentityClaim",on:{CLAIM_IDENTITY:{actions:["receiveIdentityClaim"],target:"authenticating"}}},authenticating:{id:"authenticating",initial:"checkingInvitations",states:{checkingInvitations:{initial:"checkingForInvitations",states:{checkingForInvitations:{always:[{cond:"bothHaveInvitation",actions:"failNeitherIsMember",target:"#disconnected"},{cond:"iHaveInvitation",target:"awaitingInvitationAcceptance"},{cond:"theyHaveInvitation",target:"validatingInvitation"},{target:"#checkingIdentity"}]},awaitingInvitationAcceptance:{on:{ACCEPT_INVITATION:[{cond:"joinedTheRightTeam",actions:["joinTeam","onJoined"],target:"#checkingIdentity"},{actions:"rejectTeam",target:"#disconnected"}]},...Ke},validatingInvitation:{always:[{cond:"invitationProofIsValid",actions:"acceptInvitation",target:"#checkingIdentity"},{actions:"rejectInvitation",target:"#disconnected"}]}}},checkingIdentity:{id:"checkingIdentity",type:"parallel",states:{provingMyIdentity:{initial:"awaitingIdentityChallenge",states:{awaitingIdentityChallenge:{always:{cond:"iHaveInvitation",target:"doneProvingMyIdentity"},on:{CHALLENGE_IDENTITY:{actions:["proveIdentity"],target:"awaitingIdentityAcceptance"}},...Ke},awaitingIdentityAcceptance:{on:{ACCEPT_IDENTITY:{target:"doneProvingMyIdentity"}},...Ke},doneProvingMyIdentity:{type:"final"}}},verifyingTheirIdentity:{initial:"challengingIdentity",states:{challengingIdentity:{always:[{cond:"theyHaveInvitation",target:"doneVerifyingTheirIdentity"},{actions:["confirmIdentityExists","challengeIdentity"],target:"awaitingIdentityProof"}]},awaitingIdentityProof:{on:{PROVE_IDENTITY:[{cond:"identityProofIsValid",actions:"acceptIdentity",target:"doneVerifyingTheirIdentity"},{actions:"rejectIdentityProof",target:"#disconnected"}]},...Ke},doneVerifyingTheirIdentity:{type:"final"}}}},onDone:{target:"doneAuthenticating"}},doneAuthenticating:{type:"final"}},onDone:{actions:["listenForTeamUpdates"],target:"#negotiating"}},negotiating:{id:"negotiating",entry:["generateSeed"],initial:"awaitingSeed",states:{awaitingSeed:{entry:["sendSeed"],on:{SEED:{actions:"receiveSeed",target:"doneNegotiating"}},...Ke},doneNegotiating:{entry:"deriveSharedKey",type:"final"}},onDone:{actions:["sendSyncMessage"],target:"#synchronizing"}},synchronizing:{id:"synchronizing",always:[{cond:"headsAreEqual",actions:"onConnected",target:"#connected"}],on:{SYNC:{actions:["receiveSyncMessage","sendSyncMessage"],target:"#synchronizing"}}},connected:{id:"connected",always:[{cond:"peerWasRemoved",actions:"failPeerWasRemoved",target:"disconnected"}],on:{LOCAL_UPDATE:{actions:["sendSyncMessage"],target:"#connected"},SYNC:{actions:["receiveSyncMessage","sendSyncMessage"],target:"#connected"},ENCRYPTED_MESSAGE:{actions:"receiveEncryptedMessage",target:"#connected"},DISCONNECT:"#disconnected"}},disconnected:{id:"disconnected",entry:"onDisconnected"}}},Pv=e=>!lt(e),lt=e=>"invitationSeed"in e,vn=e=>lt(e)&&"user"in e,$o=e=>lt(e)&&!vn(e),Ko=e=>"server"in e,{DEVICE:Cv}=F,$v=class extends gi{sendFn;machine;incomingMessageQueue={};outgoingMessageIndex=0;started=!1;log=an.extend("connection");constructor({sendMessage:e,context:t}){super(),this.sendFn=e;const r=Ko(t)?Hv(t):t,n="userName"in r?r.userName:"user"in r?r.user.userName:"";this.log=this.log.extend(n),this.machine=so(Gf(kv,{actions:this.actions,guards:this.guards}).withContext(r)).onTransition((i,s)=>{const o=Bo(i.value);this.emit("change",o),this.log(`${vi(s)} ⏩ ${o} `)})}start=(e=[])=>{this.log("starting"),this.machine.start(),this.started=!0,this.sendMessage({type:"REQUEST_IDENTITY"});for(const t of e)this.deliver(t);return this};stop=()=>{if(this.started&&!this.machine.state.done){const e={type:"DISCONNECT"};this.sendMessage(e),this.machine.send(e)}return this.removeAllListeners(),this.machine.stop(),this.machine.state.done=!0,this.log("machine stopped"),this};get state(){return this.started?this.machine.state.value:"not started"}get context(){if(!this.started)throw new Error("Can't get context; machine not started");return this.machine.state.context}get user(){return this.context.user}get error(){return this.context.error}get team(){return this.context.team}get sessionKey(){return this.context.sessionKey}get peer(){return this.context.peer}send=e=>{const{sessionKey:t}=this.context;O(t);const r=Tt.encrypt(e,t);this.sendMessage({type:"ENCRYPTED_MESSAGE",payload:r})};sendSyncMessage(e,t=Zt()){const[r,n]=Gn(e,t);return n?(this.log("sending sync message",Lr(n)),this.sendMessage({type:"SYNC",payload:n})):this.log("no sync message to send"),r}deliver(e){const t=JSON.parse(e);O(Co(t),`Can only deliver numbered connection messages; received 
      ${JSON.stringify(t,null,2)}`),this.logMessage("in",t,t.index);const{queue:r,nextMessages:n}=Rv(this.incomingMessageQueue,t);this.incomingMessageQueue=r;for(const i of n)if(this.started&&!this.machine.state.done){const s=this.context.peer?.userName??"?";this.log(`delivering #${i.index} from ${s} %o`,i),this.machine.send(i)}else this.log(`stopped, not delivering #${i.index}`)}actions={sendIdentityClaim:async e=>{const t=r=>{if(Kv(r))return{deviceId:r.device.deviceId};if(vn(r)){const{userName:n,keys:i}=r.user;return{proofOfInvitation:this.myProofOfInvitation(r),userName:n,userKeys:ae(i),device:tt(r.device)}}if($o(r)){const{userName:n,device:i}=r;return{proofOfInvitation:this.myProofOfInvitation(r),userName:n,device:tt(i)}}throw new Error("Invalid context")};this.sendMessage({type:"CLAIM_IDENTITY",payload:t(e)})},receiveIdentityClaim:J((e,t)=>{const{payload:r}=t;return"userName"in r&&(this.log=this.log.extend(r.userName)),{theirDeviceId:"deviceId"in r?r.deviceId:void 0,theyHaveInvitation:"proofOfInvitation"in r,theirProofOfInvitation:"proofOfInvitation"in r?r.proofOfInvitation:void 0,theirUserKeys:"userKeys"in r?r.userKeys:void 0,theirDevice:"device"in r?r.device:void 0,theirUserName:"userName"in r?r.userName:void 0}}),acceptInvitation:J(e=>{const{team:t,theirProofOfInvitation:r,theirUserKeys:n,theirUserName:i,theirDevice:s}=e;O(t),O(r);const a=(()=>{if(n!==void 0){O(i),t.admitMember(r,n,i);const c=n.name;return t.members(c)}else{O(s),t.admitDevice(r,s);const{deviceId:c}=s,{userId:u}=t.memberByDeviceId(c);return t.members(u)}})();return this.sendMessage({type:"ACCEPT_INVITATION",payload:{serializedGraph:t.save(),teamKeyring:t.teamKeyring()}}),{peer:a}}),joinTeam:J((e,t)=>{const{payload:r}=t,{serializedGraph:n,teamKeyring:i}=r,{device:s,invitationSeed:o}=e,a=()=>{const{id:d}=this.myProofOfInvitation(e),f=ut(o);return ko({serializedGraph:n,teamKeyring:i,starterKeys:f,invitationId:d})},c=e.user??a(),u=new Jt({source:n,context:{user:c,device:s},teamKeyring:i});return u.join(i),{user:c,team:u}}),confirmIdentityExists:J(e=>{const t=e.theirDeviceId;if(t===void 0)return{};if(e.team===void 0)return{};try{const r=e.team.device(t,{includeRemoved:!0}),n=e.team.memberByDeviceId(t,{includeRemoved:!0});return this.log=this.log.extend(n.userName),{theirDevice:r,peer:n}}catch{return{error:this.throwError("DEVICE_UNKNOWN",{message:`Device ${t} not found.`})}}}),challengeIdentity:J({challenge:e=>{const{theirDeviceId:t}=e;O(t);const r=xh({type:Cv,name:t});return this.sendMessage({type:"CHALLENGE_IDENTITY",payload:{challenge:r}}),r}}),proveIdentity:(e,t)=>{O(e.user);const{challenge:r}=t.payload,n=Oh(r,e.device.keys);this.sendMessage({type:"PROVE_IDENTITY",payload:{challenge:r,proof:n}})},acceptIdentity:()=>{this.sendMessage({type:"ACCEPT_IDENTITY"})},listenForTeamUpdates:e=>{O(e.team),e.team.addListener("updated",({head:t})=>{this.machine.state.done||this.machine.send({type:"LOCAL_UPDATE",payload:{head:t}})})},sendSyncMessage:J({syncState:e=>{O(e.team);const t=e.syncState??Zt(),[r,n]=Gn(e.team.graph,t);return n?(this.log("sending sync message",Lr(n)),this.sendMessage({type:"SYNC",payload:n})):this.log("no sync message to send"),r}}),receiveSyncMessage:J((e,t)=>{const{team:r,device:n}=e;O(r);const i=e.syncState??Zt(),s=t.payload,o=r.teamKeys(),a=n.keys,c=({encryptedGraph:l,keys:v})=>No({encryptedGraph:l,teamKeys:v,deviceKeys:a}),[u,d]=nf(r.graph,i,s,o,c);return Et(u.head,r.graph.head)?{syncState:d}:(this.emit("updated"),{team:r.merge(u),syncState:d})}),generateSeed:J({seed:e=>de()}),sendSeed:e=>{const{user:t,peer:r,seed:n}=e,i=ce.encrypt({secret:n,recipientPublicKey:r.keys.encryption,senderSecretKey:t.keys.encryption.secretKey});this.sendMessage({type:"SEED",payload:{encryptedSeed:i}})},receiveSeed:J((e,t)=>{const{payload:r}=t;return{theirEncryptedSeed:r.encryptedSeed}}),deriveSharedKey:J({sessionKey:e=>{const{user:t,seed:r,theirEncryptedSeed:n,peer:i}=e;O(r),O(n);const s=ce.decrypt({cipher:n,senderPublicKey:i.keys.encryption,recipientSecretKey:t.keys.encryption.secretKey});return xv(r,s)}}),receiveEncryptedMessage:(e,t)=>{const{sessionKey:r}=e;O(r);const{payload:n}=t,i=Tt.decrypt(n,r);this.emit("message",i)},receiveError:J({error:(e,t)=>{const r=t.payload;return this.log("receiveError %o",r),this.emit("remoteError",r),r}}),sendError:J({error:(e,t)=>{const r=t.payload;this.log("sendError %o",r);const n=Rr(r.type,r.details,"REMOTE");return this.sendMessage(n),this.emit("localError",r),r}}),rejectIdentityProof:this.fail("IDENTITY_PROOF_INVALID"),failNeitherIsMember:this.fail("NEITHER_IS_MEMBER"),rejectInvitation:this.fail("INVITATION_PROOF_INVALID"),rejectTeam:this.fail("JOINED_WRONG_TEAM"),failPeerWasRemoved:this.fail("MEMBER_REMOVED"),failDeviceWasRemoved:this.fail("DEVICE_REMOVED"),failTimeout:this.fail("TIMEOUT"),onConnected:()=>this.emit("connected"),onJoined:()=>this.emit("joined",{team:this.team,user:this.user}),onUpdated:()=>this.emit("updated"),onDisconnected:(e,t)=>this.emit("disconnected",t)};guards={iHaveInvitation:e=>lt(e),theyHaveInvitation:e=>e.theyHaveInvitation,bothHaveInvitation:(...e)=>this.guards.iHaveInvitation(...e)&&this.guards.theyHaveInvitation(...e),invitationProofIsValid:e=>{const{team:t,theirProofOfInvitation:r}=e;O(t),O(r);const n=t.validateInvitation(r);return n.isValid?!0:(e.error=n.error,!1)},joinedTheRightTeam:(e,t)=>{const{payload:r}=t,{serializedGraph:n,teamKeyring:i}=r,s=Do(n,i),{id:o}=this.myProofOfInvitation(e);return ln(s,o)},peerWasRemoved(e){const{team:t,peer:r,theirDevice:n}=e;O(t),O(r),O(n);const i=t.serverWasRemoved(r.userId),s=t.memberWasRemoved(r.userId),o=t.deviceWasRemoved(n.deviceId);return i||s||o},identityProofIsValid(e,t){const{team:r}=e;O(r);const{payload:n}=t,{challenge:i,proof:s}=n;return r.verifyIdentityProof(i,s)},headsAreEqual(e){const{team:t,syncState:r}=e;O(t);const n=t.graph.head,i=r?.lastCommonHead;return oo(n,i)},headsAreDifferent:(...e)=>!this.guards.headsAreEqual(...e)};sendMessage=e=>{const t=this.outgoingMessageIndex++,r={...e,index:t};this.logMessage("out",e,t),this.sendFn(JSON.stringify(r))};throwError=(e,t)=>{const r=t&&"message"in t?t.message:void 0,n=Rr(e,r,"LOCAL");return this.machine.send(n),n.payload};fail(e){return J({error:t=>{const r=t.error;return this.throwError(e,r)}})}logMessage(e,t,r){const n=e==="in"?"<-":"->",i=this.context.peer?.userName??"?";this.log(`${n}${i} #${r} ${vi(t)}`)}myProofOfInvitation(e){return O(e.invitationSeed),mo(e.invitationSeed)}},Kv=e=>e.team!==void 0,vi=e=>e.type==="SYNC"?`SYNC ${Lr(e.payload)}`:`${e.type} ${e.payload?.head?.slice(0,5)||e.payload?.message||""}`,Bv=e=>typeof e=="string",Bo=(e="disconnected")=>Bv(e)?e==="done"?"":e:Object.keys(e).map(t=>`${t}:${Bo(e[t])}`).filter(t=>t.length).join(","),Hv=e=>{const{keys:t,host:r}=e.server;return{...e,user:{userId:r,userName:r,keys:t},device:{userId:r,deviceId:r,deviceName:r,keys:t}}},qv={};export{ee as ADMIN,bo as ADMIN_SCOPE,ye as ALL,$v as Connection,Ih as DEVICE_ID,ph as ENCRYPTION,Vh as EPHEMERAL_SCOPE,ho as HashPurpose,bh as INVITATION,gh as LINK_HASH,Eh as LINK_TO_PREVIOUS,Sh as SHARED_KEY,yh as SIGNATURE,mh as SYMMETRIC,nt as TEAM_SCOPE,Jt as Team,se as VALID,ce as asymmetric,Rr as buildError,Mv as connection,Po as connectionErrors,qv as context,kh as createDevice,ie as createKeyset,wv as createTeam,Jv as createUser,Dh as device,mo as generateProof,xe as initialState,Ch as invitation,lt as isInvitee,$o as isInviteeDevice,vn as isInviteeMember,Pv as isMember,Lo as isNewTeam,Co as isNumberedConnectionMessage,Ko as isServer,Av as loadTeam,tt as redactDevice,ae as redactKeys,sf as redactUser,ih as role,me as signatures,Tt as symmetric,eh as team};
//# sourceMappingURL=index-ueax31Kx.js.map

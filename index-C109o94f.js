import{m as Yi,a as Y,s as ks,b as ne,h as te,c as W,r as pe,d as b,p as Ht,u as Ut,e as tt,f as Ue,g as je,i as Gi,t as As,j as Fi}from"./index-GKbtOUE2.js";import{dV as jt,dW as Wi,dX as Ye,dY as ve,dZ as nt,d_ as zi,d$ as qi,e0 as ws,e1 as Ji,e2 as Xi,e3 as Zi,e4 as Yt,e5 as Qi,e6 as Rs,e7 as eo,e8 as to,e9 as no,ea as Nn,eb as Gt,ec as Ge,ed as Os,ee as so,ef as xs,eg as ro,eh as Ls,ei as io,ej as oo,ek as ao,el as co,em as mt,en as Cs,eo as uo,ep as ho,cf as Kn,cy as $n}from"./index-CND5Lrss.js";var lo="[object Symbol]";function Ft(e){return typeof e=="symbol"||jt(e)&&Wi(e)==lo}function fo(e,t){for(var n=-1,s=e==null?0:e.length,r=Array(s);++n<s;)r[n]=t(e[n],n,e);return r}var yo=1/0,Bn=Ye?Ye.prototype:void 0,Pn=Bn?Bn.toString:void 0;function Ds(e){if(typeof e=="string")return e;if(ve(e))return fo(e,Ds)+"";if(Ft(e))return Pn?Pn.call(e):"";var t=e+"";return t=="0"&&1/e==-yo?"-0":t}var Vn=Object.create,po=function(){function e(){}return function(t){if(!nt(t))return{};if(Vn)return Vn(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();function vo(){}function mo(e,t){var n=-1,s=e.length;for(t||(t=Array(s));++n<s;)t[n]=e[n];return t}var Hn=function(){try{var e=zi(Object,"defineProperty");return e({},"",{}),e}catch{}}();function go(e,t){for(var n=-1,s=e==null?0:e.length;++n<s&&t(e[n],n,e)!==!1;);return e}function Eo(e,t,n,s){for(var r=e.length,i=n+-1;++i<r;)if(t(e[i],i,e))return i;return-1}function bo(e){return e!==e}function Io(e,t,n){for(var s=n-1,r=e.length;++s<r;)if(e[s]===t)return s;return-1}function _o(e,t,n){return t===t?Io(e,t,n):Eo(e,bo,n)}function So(e,t){var n=e==null?0:e.length;return!!n&&_o(e,t,0)>-1}function Ns(e,t,n){t=="__proto__"&&Hn?Hn(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}var To=Object.prototype,Mo=To.hasOwnProperty;function Ks(e,t,n){var s=e[t];(!(Mo.call(e,t)&&qi(s,n))||n===void 0&&!(t in e))&&Ns(e,t,n)}function st(e,t,n,s){var r=!n;n||(n={});for(var i=-1,o=t.length;++i<o;){var a=t[i],c=void 0;c===void 0&&(c=e[a]),r?Ns(n,a,c):Ks(n,a,c)}return n}function ko(e){var t=[];if(e!=null)for(var n in Object(e))t.push(n);return t}var Ao=Object.prototype,wo=Ao.hasOwnProperty;function Ro(e){if(!nt(e))return ko(e);var t=ws(e),n=[];for(var s in e)s=="constructor"&&(t||!wo.call(e,s))||n.push(s);return n}function Wt(e){return Ji(e)?Xi(e,!0):Ro(e)}var Oo=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,xo=/^\w*$/;function zt(e,t){if(ve(e))return!1;var n=typeof e;return n=="number"||n=="symbol"||n=="boolean"||e==null||Ft(e)?!0:xo.test(e)||!Oo.test(e)||t!=null&&e in Object(t)}var Lo=500;function Co(e){var t=Yi(e,function(s){return n.size===Lo&&n.clear(),s}),n=t.cache;return t}var Do=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,No=/\\(\\)?/g,Ko=Co(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(Do,function(n,s,r,i){t.push(r?i.replace(No,"$1"):s||n)}),t});function $o(e){return e==null?"":Ds(e)}function $s(e,t){return ve(e)?e:zt(e,t)?[e]:Ko($o(e))}var Bo=1/0;function rt(e){if(typeof e=="string"||Ft(e))return e;var t=e+"";return t=="0"&&1/e==-Bo?"-0":t}function Bs(e,t){t=$s(t,e);for(var n=0,s=t.length;e!=null&&n<s;)e=e[rt(t[n++])];return n&&n==s?e:void 0}function Po(e,t,n){var s=e==null?void 0:Bs(e,t);return s===void 0?n:s}var Ps=Zi(Object.getPrototypeOf,Object);function Vo(e,t){return e&&st(t,Yt(t),e)}function Ho(e,t){return e&&st(t,Wt(t),e)}var Vs=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Un=Vs&&typeof module=="object"&&module&&!module.nodeType&&module,Uo=Un&&Un.exports===Vs,jn=Uo?Qi.Buffer:void 0,Yn=jn?jn.allocUnsafe:void 0;function jo(e,t){if(t)return e.slice();var n=e.length,s=Yn?Yn(n):new e.constructor(n);return e.copy(s),s}function Yo(e,t){return st(e,Rs(e),t)}var Go=Object.getOwnPropertySymbols,Hs=Go?function(e){for(var t=[];e;)to(t,Rs(e)),e=Ps(e);return t}:eo;function Fo(e,t){return st(e,Hs(e),t)}function Wo(e){return no(e,Wt,Hs)}var zo=Object.prototype,qo=zo.hasOwnProperty;function Jo(e){var t=e.length,n=new e.constructor(t);return t&&typeof e[0]=="string"&&qo.call(e,"index")&&(n.index=e.index,n.input=e.input),n}function qt(e){var t=new e.constructor(e.byteLength);return new Nn(t).set(new Nn(e)),t}function Xo(e,t){var n=t?qt(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}var Zo=/\w*$/;function Qo(e){var t=new e.constructor(e.source,Zo.exec(e));return t.lastIndex=e.lastIndex,t}var Gn=Ye?Ye.prototype:void 0,Fn=Gn?Gn.valueOf:void 0;function ea(e){return Fn?Object(Fn.call(e)):{}}function ta(e,t){var n=t?qt(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}var na="[object Boolean]",sa="[object Date]",ra="[object Map]",ia="[object Number]",oa="[object RegExp]",aa="[object Set]",ca="[object String]",da="[object Symbol]",ua="[object ArrayBuffer]",ha="[object DataView]",la="[object Float32Array]",fa="[object Float64Array]",ya="[object Int8Array]",pa="[object Int16Array]",va="[object Int32Array]",ma="[object Uint8Array]",ga="[object Uint8ClampedArray]",Ea="[object Uint16Array]",ba="[object Uint32Array]";function Ia(e,t,n){var s=e.constructor;switch(t){case ua:return qt(e);case na:case sa:return new s(+e);case ha:return Xo(e,n);case la:case fa:case ya:case pa:case va:case ma:case ga:case Ea:case ba:return ta(e,n);case ra:return new s;case ia:case ca:return new s(e);case oa:return Qo(e);case aa:return new s;case da:return ea(e)}}function _a(e){return typeof e.constructor=="function"&&!ws(e)?po(Ps(e)):{}}var Sa="[object Map]";function Ta(e){return jt(e)&&Gt(e)==Sa}var Wn=Ge&&Ge.isMap,Ma=Wn?Os(Wn):Ta,ka="[object Set]";function Aa(e){return jt(e)&&Gt(e)==ka}var zn=Ge&&Ge.isSet,wa=zn?Os(zn):Aa,Ra=1,Oa=2,xa=4,Us="[object Arguments]",La="[object Array]",Ca="[object Boolean]",Da="[object Date]",Na="[object Error]",js="[object Function]",Ka="[object GeneratorFunction]",$a="[object Map]",Ba="[object Number]",Ys="[object Object]",Pa="[object RegExp]",Va="[object Set]",Ha="[object String]",Ua="[object Symbol]",ja="[object WeakMap]",Ya="[object ArrayBuffer]",Ga="[object DataView]",Fa="[object Float32Array]",Wa="[object Float64Array]",za="[object Int8Array]",qa="[object Int16Array]",Ja="[object Int32Array]",Xa="[object Uint8Array]",Za="[object Uint8ClampedArray]",Qa="[object Uint16Array]",ec="[object Uint32Array]",I={};I[Us]=I[La]=I[Ya]=I[Ga]=I[Ca]=I[Da]=I[Fa]=I[Wa]=I[za]=I[qa]=I[Ja]=I[$a]=I[Ba]=I[Ys]=I[Pa]=I[Va]=I[Ha]=I[Ua]=I[Xa]=I[Za]=I[Qa]=I[ec]=!0;I[Na]=I[js]=I[ja]=!1;function Be(e,t,n,s,r,i){var o,a=t&Ra,c=t&Oa,u=t&xa;if(o!==void 0)return o;if(!nt(e))return e;var l=ve(e);if(l){if(o=Jo(e),!a)return mo(e,o)}else{var d=Gt(e),h=d==js||d==Ka;if(so(e))return jo(e,a);if(d==Ys||d==Us||h&&!r){if(o=c||h?{}:_a(e),!a)return c?Fo(e,Ho(o,e)):Yo(e,Vo(o,e))}else{if(!I[d])return r?e:{};o=Ia(e,d,a)}}i||(i=new xs);var f=i.get(e);if(f)return f;i.set(e,o),wa(e)?e.forEach(function(m){o.add(Be(m,t,n,m,e,i))}):Ma(e)&&e.forEach(function(m,M){o.set(M,Be(m,t,n,M,e,i))});var p=u?c?Wo:ro:c?Wt:Yt,v=l?void 0:p(e);return go(v||e,function(m,M){v&&(M=m,m=e[M]),Ks(o,M,Be(m,t,n,M,e,i))}),o}var tc=4;function nc(e){return Be(e,tc)}var sc=1,rc=2;function ic(e,t,n,s){var r=n.length,i=r;if(e==null)return!i;for(e=Object(e);r--;){var o=n[r];if(o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++r<i;){o=n[r];var a=o[0],c=e[a],u=o[1];if(o[2]){if(c===void 0&&!(a in e))return!1}else{var l=new xs,d;if(!(d===void 0?Ls(u,c,sc|rc,s,l):d))return!1}}return!0}function Gs(e){return e===e&&!nt(e)}function oc(e){for(var t=Yt(e),n=t.length;n--;){var s=t[n],r=e[s];t[n]=[s,r,Gs(r)]}return t}function Fs(e,t){return function(n){return n==null?!1:n[e]===t&&(t!==void 0||e in Object(n))}}function ac(e){var t=oc(e);return t.length==1&&t[0][2]?Fs(t[0][0],t[0][1]):function(n){return n===e||ic(n,e,t)}}function cc(e,t){return e!=null&&t in Object(e)}function dc(e,t,n){t=$s(t,e);for(var s=-1,r=t.length,i=!1;++s<r;){var o=rt(t[s]);if(!(i=e!=null&&n(e,o)))break;e=e[o]}return i||++s!=r?i:(r=e==null?0:e.length,!!r&&io(r)&&oo(o,r)&&(ve(e)||ao(e)))}function uc(e,t){return e!=null&&dc(e,t,cc)}var hc=1,lc=2;function fc(e,t){return zt(e)&&Gs(t)?Fs(rt(e),t):function(n){var s=Po(n,e);return s===void 0&&s===t?uc(n,e):Ls(t,s,hc|lc)}}function yc(e){return function(t){return t?.[e]}}function pc(e){return function(t){return Bs(t,e)}}function vc(e){return zt(e)?yc(rt(e)):pc(e)}function mc(e){return typeof e=="function"?e:e==null?co:typeof e=="object"?ve(e)?fc(e[0],e[1]):ac(e):vc(e)}var gc=1/0,Ec=mt&&1/Cs(new mt([,-0]))[1]==gc?function(e){return new mt(e)}:vo,bc=200;function Ws(e,t,n){var s=-1,r=So,i=e.length,o=!0,a=[],c=a;if(i>=bc){var u=t?null:Ec(e);if(u)return Cs(u);o=!1,r=ho,c=new uo}else c=t?[]:a;e:for(;++s<i;){var l=e[s],d=t?t(l):l;if(l=l!==0?l:0,o&&d===d){for(var h=c.length;h--;)if(c[h]===d)continue e;t&&c.push(d),a.push(l)}else r(c,d,n)||(c!==a&&c.push(d),a.push(l))}return a}function Jt(e){return e&&e.length?Ws(e):[]}function Ic(e,t){return e&&e.length?Ws(e,mc(t)):[]}class it{#e={};#t=0;emit(t,...n){if(!this.#e[t])return!1;const s=[...this.#e[t]];for(let r=0;r<s.length;r++){const{once:i,fn:o}=s[r];i&&this.removeListener(t,o),o(...n)}return!0}addListener(t,n){return this.#r(t,n,!1)}on=this.addListener;once(t,n){return this.#r(t,n,!0)}removeListener(t,n){const s=this.#e[t];if(s){if(!n)this.removeAllListeners(t);else{const r=[];for(let i=0;i<s.length;i++)s[i].fn===n&&(s[i],this.#t-=1,this.#t===0?(this.#e={},this.#t=0):s.length===1?delete this.#e[t]:r.push(i));for(let i=r.length-1;i>=0;i--)s.splice(r[i],1)}return this}}off=this.removeListener;removeAllListeners(t){if(t){const n=this.#e[t];n&&(this.#t-=n.length,this.#t===0?this.#e={}:delete this.#e[t])}else this.#e={},this.#t=0;return this}#r(t,n,s=!1){const r={fn:n,once:s},i=this.#e[t]??[];return i.push(r),this.#e[t]=i,this.#t++,this}}var q={},_={},N={};Object.defineProperty(N,"__esModule",{value:!0});N.anumber=Me;N.number=Me;N.abytes=ot;N.bytes=ot;N.ahash=zs;N.aexists=qs;N.aoutput=Js;function Me(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function _c(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function ot(e,...t){if(!_c(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error("Uint8Array expected of length "+t+", got length="+e.length)}function zs(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Me(e.outputLen),Me(e.blockLen)}function qs(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Js(e,t){ot(e);const n=t.outputLen;if(e.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}const Sc={number:Me,bytes:ot,hash:zs,exists:qs,output:Js};N.default=Sc;var g={};Object.defineProperty(g,"__esModule",{value:!0});g.add5L=g.add5H=g.add4H=g.add4L=g.add3H=g.add3L=g.rotlBL=g.rotlBH=g.rotlSL=g.rotlSH=g.rotr32L=g.rotr32H=g.rotrBL=g.rotrBH=g.rotrSL=g.rotrSH=g.shrSL=g.shrSH=g.toBig=void 0;g.fromBig=Xt;g.split=Xs;g.add=hr;const Ke=BigInt(2**32-1),kt=BigInt(32);function Xt(e,t=!1){return t?{h:Number(e&Ke),l:Number(e>>kt&Ke)}:{h:Number(e>>kt&Ke)|0,l:Number(e&Ke)|0}}function Xs(e,t=!1){let n=new Uint32Array(e.length),s=new Uint32Array(e.length);for(let r=0;r<e.length;r++){const{h:i,l:o}=Xt(e[r],t);[n[r],s[r]]=[i,o]}return[n,s]}const Zs=(e,t)=>BigInt(e>>>0)<<kt|BigInt(t>>>0);g.toBig=Zs;const Qs=(e,t,n)=>e>>>n;g.shrSH=Qs;const er=(e,t,n)=>e<<32-n|t>>>n;g.shrSL=er;const tr=(e,t,n)=>e>>>n|t<<32-n;g.rotrSH=tr;const nr=(e,t,n)=>e<<32-n|t>>>n;g.rotrSL=nr;const sr=(e,t,n)=>e<<64-n|t>>>n-32;g.rotrBH=sr;const rr=(e,t,n)=>e>>>n-32|t<<64-n;g.rotrBL=rr;const ir=(e,t)=>t;g.rotr32H=ir;const or=(e,t)=>e;g.rotr32L=or;const ar=(e,t,n)=>e<<n|t>>>32-n;g.rotlSH=ar;const cr=(e,t,n)=>t<<n|e>>>32-n;g.rotlSL=cr;const dr=(e,t,n)=>t<<n-32|e>>>64-n;g.rotlBH=dr;const ur=(e,t,n)=>e<<n-32|t>>>64-n;g.rotlBL=ur;function hr(e,t,n,s){const r=(t>>>0)+(s>>>0);return{h:e+n+(r/2**32|0)|0,l:r|0}}const lr=(e,t,n)=>(e>>>0)+(t>>>0)+(n>>>0);g.add3L=lr;const fr=(e,t,n,s)=>t+n+s+(e/2**32|0)|0;g.add3H=fr;const yr=(e,t,n,s)=>(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0);g.add4L=yr;const pr=(e,t,n,s,r)=>t+n+s+r+(e/2**32|0)|0;g.add4H=pr;const vr=(e,t,n,s,r)=>(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0)+(r>>>0);g.add5L=vr;const mr=(e,t,n,s,r,i)=>t+n+s+r+i+(e/2**32|0)|0;g.add5H=mr;const Tc={fromBig:Xt,split:Xs,toBig:Zs,shrSH:Qs,shrSL:er,rotrSH:tr,rotrSL:nr,rotrBH:sr,rotrBL:rr,rotr32H:ir,rotr32L:or,rotlSH:ar,rotlSL:cr,rotlBH:dr,rotlBL:ur,add:hr,add3L:lr,add3H:fr,add4L:yr,add4H:pr,add5H:mr,add5L:vr};g.default=Tc;var gr={},at={};Object.defineProperty(at,"__esModule",{value:!0});at.crypto=void 0;at.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;(function(e){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.Hash=e.nextTick=e.byteSwapIfBE=e.byteSwap=e.isLE=e.rotl=e.rotr=e.createView=e.u32=e.u8=void 0,e.isBytes=s,e.byteSwap32=l,e.bytesToHex=h,e.hexToBytes=v,e.asyncLoop=M,e.utf8ToBytes=R,e.toBytes=$,e.concatBytes=X,e.checkOpts=vt,e.wrapConstructor=Pi,e.wrapConstructorWithOpts=Vi,e.wrapXOFConstructorWithOpts=Hi,e.randomBytes=Ui;const t=at,n=N;function s(y){return y instanceof Uint8Array||ArrayBuffer.isView(y)&&y.constructor.name==="Uint8Array"}const r=y=>new Uint8Array(y.buffer,y.byteOffset,y.byteLength);e.u8=r;const i=y=>new Uint32Array(y.buffer,y.byteOffset,Math.floor(y.byteLength/4));e.u32=i;const o=y=>new DataView(y.buffer,y.byteOffset,y.byteLength);e.createView=o;const a=(y,E)=>y<<32-E|y>>>E;e.rotr=a;const c=(y,E)=>y<<E|y>>>32-E>>>0;e.rotl=c,e.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;const u=y=>y<<24&4278190080|y<<8&16711680|y>>>8&65280|y>>>24&255;e.byteSwap=u,e.byteSwapIfBE=e.isLE?y=>y:y=>(0,e.byteSwap)(y);function l(y){for(let E=0;E<y.length;E++)y[E]=(0,e.byteSwap)(y[E])}const d=Array.from({length:256},(y,E)=>E.toString(16).padStart(2,"0"));function h(y){(0,n.abytes)(y);let E="";for(let T=0;T<y.length;T++)E+=d[y[T]];return E}const f={_0:48,_9:57,A:65,F:70,a:97,f:102};function p(y){if(y>=f._0&&y<=f._9)return y-f._0;if(y>=f.A&&y<=f.F)return y-(f.A-10);if(y>=f.a&&y<=f.f)return y-(f.a-10)}function v(y){if(typeof y!="string")throw new Error("hex string expected, got "+typeof y);const E=y.length,T=E/2;if(E%2)throw new Error("hex string expected, got unpadded hex of length "+E);const S=new Uint8Array(T);for(let A=0,x=0;A<T;A++,x+=2){const Cn=p(y.charCodeAt(x)),Dn=p(y.charCodeAt(x+1));if(Cn===void 0||Dn===void 0){const ji=y[x]+y[x+1];throw new Error('hex string expected, got non-hex character "'+ji+'" at index '+x)}S[A]=Cn*16+Dn}return S}const m=async()=>{};e.nextTick=m;async function M(y,E,T){let S=Date.now();for(let A=0;A<y;A++){T(A);const x=Date.now()-S;x>=0&&x<E||(await(0,e.nextTick)(),S+=x)}}function R(y){if(typeof y!="string")throw new Error("utf8ToBytes expected string, got "+typeof y);return new Uint8Array(new TextEncoder().encode(y))}function $(y){return typeof y=="string"&&(y=R(y)),(0,n.abytes)(y),y}function X(...y){let E=0;for(let S=0;S<y.length;S++){const A=y[S];(0,n.abytes)(A),E+=A.length}const T=new Uint8Array(E);for(let S=0,A=0;S<y.length;S++){const x=y[S];T.set(x,A),A+=x.length}return T}class Ne{clone(){return this._cloneInto()}}e.Hash=Ne;function vt(y,E){if(E!==void 0&&{}.toString.call(E)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(y,E)}function Pi(y){const E=S=>y().update($(S)).digest(),T=y();return E.outputLen=T.outputLen,E.blockLen=T.blockLen,E.create=()=>y(),E}function Vi(y){const E=(S,A)=>y(A).update($(S)).digest(),T=y({});return E.outputLen=T.outputLen,E.blockLen=T.blockLen,E.create=S=>y(S),E}function Hi(y){const E=(S,A)=>y(A).update($(S)).digest(),T=y({});return E.outputLen=T.outputLen,E.blockLen=T.blockLen,E.create=S=>y(S),E}function Ui(y=32){if(t.crypto&&typeof t.crypto.getRandomValues=="function")return t.crypto.getRandomValues(new Uint8Array(y));if(t.crypto&&typeof t.crypto.randomBytes=="function")return t.crypto.randomBytes(y);throw new Error("crypto.getRandomValues must be defined")}})(gr);Object.defineProperty(_,"__esModule",{value:!0});_.shake256=_.shake128=_.keccak_512=_.keccak_384=_.keccak_256=_.keccak_224=_.sha3_512=_.sha3_384=_.sha3_256=_.sha3_224=_.Keccak=void 0;_.keccakP=_r;const ie=N,ke=g,V=gr,Er=[],br=[],Ir=[],Mc=BigInt(0),me=BigInt(1),kc=BigInt(2),Ac=BigInt(7),wc=BigInt(256),Rc=BigInt(113);for(let e=0,t=me,n=1,s=0;e<24;e++){[n,s]=[s,(2*n+3*s)%5],Er.push(2*(5*s+n)),br.push((e+1)*(e+2)/2%64);let r=Mc;for(let i=0;i<7;i++)t=(t<<me^(t>>Ac)*Rc)%wc,t&kc&&(r^=me<<(me<<BigInt(i))-me);Ir.push(r)}const[Oc,xc]=(0,ke.split)(Ir,!0),qn=(e,t,n)=>n>32?(0,ke.rotlBH)(e,t,n):(0,ke.rotlSH)(e,t,n),Jn=(e,t,n)=>n>32?(0,ke.rotlBL)(e,t,n):(0,ke.rotlSL)(e,t,n);function _r(e,t=24){const n=new Uint32Array(10);for(let s=24-t;s<24;s++){for(let o=0;o<10;o++)n[o]=e[o]^e[o+10]^e[o+20]^e[o+30]^e[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,u=n[c],l=n[c+1],d=qn(u,l,1)^n[a],h=Jn(u,l,1)^n[a+1];for(let f=0;f<50;f+=10)e[o+f]^=d,e[o+f+1]^=h}let r=e[2],i=e[3];for(let o=0;o<24;o++){const a=br[o],c=qn(r,i,a),u=Jn(r,i,a),l=Er[o];r=e[l],i=e[l+1],e[l]=c,e[l+1]=u}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)n[a]=e[o+a];for(let a=0;a<10;a++)e[o+a]^=~n[(a+2)%10]&n[(a+4)%10]}e[0]^=Oc[s],e[1]^=xc[s]}n.fill(0)}class Le extends V.Hash{constructor(t,n,s,r=!1,i=24){if(super(),this.blockLen=t,this.suffix=n,this.outputLen=s,this.enableXOF=r,this.rounds=i,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,ie.anumber)(s),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,V.u32)(this.state)}keccak(){V.isLE||(0,V.byteSwap32)(this.state32),_r(this.state32,this.rounds),V.isLE||(0,V.byteSwap32)(this.state32),this.posOut=0,this.pos=0}update(t){(0,ie.aexists)(this);const{blockLen:n,state:s}=this;t=(0,V.toBytes)(t);const r=t.length;for(let i=0;i<r;){const o=Math.min(n-this.pos,r-i);for(let a=0;a<o;a++)s[this.pos++]^=t[i++];this.pos===n&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:t,suffix:n,pos:s,blockLen:r}=this;t[s]^=n,n&128&&s===r-1&&this.keccak(),t[r-1]^=128,this.keccak()}writeInto(t){(0,ie.aexists)(this,!1),(0,ie.abytes)(t),this.finish();const n=this.state,{blockLen:s}=this;for(let r=0,i=t.length;r<i;){this.posOut>=s&&this.keccak();const o=Math.min(s-this.posOut,i-r);t.set(n.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return t}xofInto(t){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(t)}xof(t){return(0,ie.anumber)(t),this.xofInto(new Uint8Array(t))}digestInto(t){if((0,ie.aoutput)(t,this),this.finished)throw new Error("digest() was already called");return this.writeInto(t),this.destroy(),t}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(t){const{blockLen:n,suffix:s,outputLen:r,rounds:i,enableXOF:o}=this;return t||(t=new Le(n,s,r,o,i)),t.state32.set(this.state32),t.pos=this.pos,t.posOut=this.posOut,t.finished=this.finished,t.rounds=i,t.suffix=s,t.outputLen=r,t.enableXOF=o,t.destroyed=this.destroyed,t}}_.Keccak=Le;const J=(e,t,n)=>(0,V.wrapConstructor)(()=>new Le(t,e,n));_.sha3_224=J(6,144,224/8);_.sha3_256=J(6,136,256/8);_.sha3_384=J(6,104,384/8);_.sha3_512=J(6,72,512/8);_.keccak_224=J(1,144,224/8);_.keccak_256=J(1,136,256/8);_.keccak_384=J(1,104,384/8);_.keccak_512=J(1,72,512/8);const Sr=(e,t,n)=>(0,V.wrapXOFConstructorWithOpts)((s={})=>new Le(t,e,s.dkLen===void 0?n:s.dkLen,!0));_.shake128=Sr(31,168,128/8);_.shake256=Sr(31,136,256/8);const{sha3_512:Lc}=_,Tr=24,Ie=32,At=(e=4,t=Math.random)=>{let n="";for(;n.length<e;)n=n+Math.floor(t()*36).toString(36);return n};function Mr(e){let t=8n,n=0n;for(const s of e.values()){const r=BigInt(s);n=(n<<t)+r}return n}const kr=(e="")=>Mr(Lc(e)).toString(36).slice(1),Xn=Array.from({length:26},(e,t)=>String.fromCharCode(t+97)),Cc=e=>Xn[Math.floor(e()*Xn.length)],Ar=({globalObj:e=typeof Kn<"u"?Kn:typeof window<"u"?window:{},random:t=Math.random}={})=>{const n=Object.keys(e).toString(),s=n.length?n+At(Ie,t):At(Ie,t);return kr(s).substring(0,Ie)},wr=e=>()=>e++,Dc=476782367,Rr=({random:e=Math.random,counter:t=wr(Math.floor(e()*Dc)),length:n=Tr,fingerprint:s=Ar({random:e})}={})=>function(){const i=Cc(e),o=Date.now().toString(36),a=t().toString(36),c=At(n,e),u=`${o+c+a+s}`;return`${i+kr(u).substring(1,n)}`},Nc=Rr(),Kc=(e,{minLength:t=2,maxLength:n=Ie}={})=>{const s=e.length,r=/^[0-9a-z]+$/;try{if(typeof e=="string"&&s>=t&&s<=n&&r.test(e))return!0}finally{}return!1};q.getConstants=()=>({defaultLength:Tr,bigLength:Ie});q.init=Rr;q.createId=Nc;q.bufToBigInt=Mr;q.createCounter=wr;q.createFingerprint=Ar;q.isCuid=Kc;const{createId:$c,init:El,getConstants:bl,isCuid:Il}=q;var Zt=$c,Bc="SIGNATURE",Pc="ENCRYPTION",Vc="SYMMETRIC",Hc="LINK_HASH",Or={SIGNATURE:Bc,ENCRYPTION:Pc,SYMMETRIC:Vc,LINK_HASH:Hc},ct="ROOT",de={isValid:!0},xr={type:"EPHEMERAL",name:"EPHEMERAL"},{LINK_HASH:Uc}=Or,Ae=e=>te(Uc,e),Lr=({graph:e,action:t,user:n,context:s={},keys:r})=>{const{publicKey:i,secretKey:o}=n.keys.encryption,{publicKey:a}=r.encryption,c={...t,...s,userId:n.userId,timestamp:Date.now(),prev:e.head??[]},u=W.encryptBytes({secret:c,recipientPublicKey:a,senderSecretKey:o}),l=Ae(u),d={hash:l,body:c},h={senderPublicKey:i,recipientPublicKey:a,encryptedBody:u};return{root:e.root??l,head:[l],encryptedLinks:{...e.encryptedLinks,[l]:h},links:{...e.links,[l]:d}}},Fe=(e,t)=>e.links[t],Cr=(e,t)=>jc(e)[t]||[],jc=Y(e=>{const t={};for(const n of Object.values(e.links)){const s=n.body.prev;for(const r of s){const i=t[r]||[];i.push(n.hash),t[r]=i}}return t}),We=e=>Object.keys(e.links),Yc=(e,t)=>`${e.head.join("")}:${t}`,we=Y((e,t)=>{const n=Fe(e,t);b(n);const s=n.body.prev,r=s.flatMap(i=>we(e,i));return Jt(s.concat(r))},Yc),Gc=(e,t,n)=>t!==void 0&&n!==void 0&&t.hash in e.links&&n.hash in e.links&&we(e,n.hash).includes(t.hash),Fc=(e,t,n)=>we(e,n).includes(t),Wc=(e,t)=>`${e.head.join("")}:${t}`,Dr=Y((e,t)=>{const n=Cr(e,t),s=n.flatMap(r=>Dr(e,r));return Jt(n.concat(s))},Wc),zc=(e,t,n)=>Dr(e,n).includes(t),qc=(e,t)=>Jc(e)[t],Jc=Y(e=>{const t={};for(const n in e.links){const s=n;t[s]=We(e).filter(r=>Xc(e,s,r)).sort()}return t}),Xc=(e,t,n)=>t!==n&&!Fc(e,t,n)&&!zc(e,t,n),Zc=e=>{const t={},n=r=>{const i=[r];for(const o of qc(e,r))t[o]||(t[o]=!0,i.push(...n(o)));return i},s=[];for(const r in e.links){const i=r;if(!t[i]){t[i]=!0;const o=n(i);o.length>1&&s.push(o)}}return s},Qc={root:void 0,head:void 0,encryptedLinks:{},links:{}},ed=({user:e,id:t=Zt(),name:n=t,rootPayload:s={},context:r={},keys:i})=>{const o={name:n,id:t,...s};return Lr({graph:Qc,action:{type:ct,prev:[],payload:o},user:e,context:r,keys:i})},td=e=>(t,n)=>{const s=typeof e=="function"?e(n):n[e];return{...t,[s]:n}},nd={GRAPH:"GRAPH",USER:"USER"},sd=e=>e.encryption.hasOwnProperty("secretKey")&&e.signature.hasOwnProperty("secretKey")&&"secretKey"in e,dt=e=>e!==void 0&&"secretKey"in e&&"encryption"in e&&"signature"in e,rd=e=>!Array.isArray(e)&&!dt(e),re=e=>rd(e)?e:(dt(e)&&(e=[e]),e.reduce(td(t=>t.encryption.publicKey),{})),Nr=(e,t)=>{const{senderPublicKey:n,recipientPublicKey:s,encryptedBody:r}=e,o=re(t)[s];b(o,"Can't decrypt link: don't have the correct keyset");const a=id(r),c=W.decryptBytes({cipher:a,recipientSecretKey:o.encryption.secretKey,senderPublicKey:n});return{hash:Ae(r),body:c}},Qt=({encryptedGraph:e,keys:t})=>{const{encryptedLinks:n,root:s,childMap:r={}}=e,i=e.links??{},o=(c,u={})=>{const l=n[c],d=i[c]??Nr(l,t);let h={[c]:d};const f=r[c]??[];for(const p of f)h={...h,...o(p,h)};return{...u,...h}},a=o(s);return{...e,links:a}},id=e=>od(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e),od=e=>"buffer"in e&&"byteOffset"in e&&"byteLength"in e,ad=(e,t)=>Object.fromEntries(t.map(n=>[n,cd(e,n)])),cd=(e,t)=>e.encryptedLinks[t],dd=e=>e.head.map(t=>Fe(e,t));function wt(e,t){return typeof t=="string"?Fe(e,t).body.prev:t.body.prev.map(s=>Fe(e,s))}var gt={},Rt=({graph:e,depth:t,start:n=e.head,end:s=[],prev:r,hashes:i})=>i?i.reduce((o,a)=>({...o,[a]:wt(e,a)}),gt):(r&&(n=ud(r)),t===0?gt:n.reduce((o,a)=>{const c=wt(e,a),u=c.filter(d=>!(d in o)).filter(d=>!s.includes(d)),l=Rt({graph:e,depth:t?t-1:void 0,start:u,end:s});return{...o,[a]:c,...l}},gt)),ud=e=>Object.keys(e).flatMap(r=>e[r]).filter(r=>!(r in e)),en=e=>{const t={};for(const n of We(e))for(const s of wt(e,n))t[s]||(t[s]=[]),t[s].push(n);return t},hd=e=>{const t={},n=Object.keys(e);for(const s of n)for(const r of e[s])t[r]||(t[r]=[]),t[r].push(s);return t},ld=e=>e.links[e.root],fd=(e,t={})=>{const{comparator:n=Kr}=t;let s=Object.values(e.links);const r=Object.fromEntries(s.map(a=>[a.hash,a.body.prev.length])),i=[],o=a=>{i.push(a),s=s.filter(d=>d.hash!==a.hash);const c=Cr(e,a.hash);for(const d of c)r[d]--;if(c.length!==1)return;const u=c[0];if(r[u]>0)return;const l=e.links[u];o(l)};for(;s.length>0;){const c=s.filter(u=>r[u.hash]===0).sort(n).shift();o(c)}return i},Kr=(e,t)=>e.hash<t.hash?-1:e.hash>t.hash?1:0,$r=(e,t=Br)=>{const{sort:n=Kr,filter:s=yd}=t(e);return fd(e,{comparator:n}).map(i=>{const o=i.isInvalid??!s(i);return{...i,isInvalid:o}})},Br=e=>({}),yd=e=>!0,Pe=(e,t)=>e===void 0||t===void 0||e.length!==t.length?!1:(e.sort(),t.sort(),e.every((n,s)=>n===t[s])),Pr=(e,t)=>{if(e.root!==t.root)throw new Error("Cannot merge two graphs with different roots");const n={...t.links,...e.links},s={...t.encryptedLinks,...e.encryptedLinks},i=Jt([...e.head,...t.head]).filter(pd(n)),o={root:e.root,head:i,encryptedLinks:s,links:n};return o.head=o.head.sort(),o},pd=e=>t=>!Object.values(e).some(vd(t)),vd=e=>t=>t.body.prev.includes(e),md=e=>{const{head:t,root:n,encryptedLinks:s}=e,r=en(e);return{head:t,root:n,encryptedLinks:s,childMap:r}},gd=e=>Ht(md(e)),Ed=(e,t)=>{const n=Ut(e);return Qt({encryptedGraph:n,keys:t})},{SIGNATURE:bd,ENCRYPTION:Id,SYMMETRIC:_d}=Or,G=(e,t=pe())=>{const{type:n,name:s=n}=e,r=ks(`${s}:${n}:${t}`);return{type:n,name:s,generation:0,signature:ne.keyPair(te(bd,r).slice(0,32)),encryption:W.keyPair(te(Id,r).slice(0,32)),secretKey:te(_d,r)}},Ot=e=>{let t;for(const n in e){const s=e[n];(t===void 0||s.generation>t.generation)&&(t=s)}return t},F=e=>sd(e)?{type:e.type,name:e.name,generation:e.generation,encryption:e.encryption.publicKey,signature:e.signature.publicKey}:e,Sd=class extends Error{type;details;constructor(t,n){super(),this.message=t,this.details=n}},Td={validateHash(e,t){const{hash:n}=e,{encryptedBody:s}=t.encryptedLinks[n],r=Ae(s);return n===r?de:H("The hash calculated for this link does not match.",{link:e,hash:n,expected:r})},validatePrev(e,t){for(const n of e.body.prev)if(!(n in t.links))return H("The link referenced by one of the hashes in the `prev` property does not exist.");return de},validateRoot(e,t){const n=e.body.prev.length===0,s="type"in e.body&&e.body.type===ct,r=ld(t)===e;return n===r&&r===s?de:H(s?n?"The ROOT link has to be the link referenced by the graph `root` property":"The ROOT link cannot have any predecessors":n?"Non-ROOT links must have predecessors":"The link referenced by the graph `root` property must be a ROOT link",{link:e,graph:t})},validateTimestamps(e,t){const{timestamp:n}=e.body,s=Date.now();if(n>s)return H("The link's timestamp is in the future.",{link:e,now:s});for(const r of e.body.prev){const i=t.links[r];if(i.body.timestamp>n)return H("This link's timestamp can't be earlier than a previous link.",{link:e,prevLink:i})}return de}},H=(e,t)=>({isValid:!1,error:new Sd(e,t)}),Md=(e,t={})=>{{const o=e.root,a=e.encryptedLinks[o],c=Ae(a.encryptedBody);if(c!==o)return H("Root hash does not match the hash of the root link",{rootHash:o,computedHash:c,rootLink:a})}for(const o of e.head){const a=e.encryptedLinks[o],c=Ae(a.encryptedBody);if(c!==o)return H("Head hash does not match the hash of the head link",{headHash:o,computedHash:c,headLink:a})}const n=Object.keys(e.encryptedLinks),s=Object.keys(e.links);if(n.length!==s.length)return H("Number of encrypted links does not match number of links",{encryptedLinkHashes:n,linkHashes:s});const i=((...o)=>a=>{const c=kd(o);for(const u in c){const l=c[u];try{const d=l(a,e);if(!d.isValid)return d}catch(d){const{message:h}=d;return H(h,d)}}return de})(Td,t);for(const o of Object.values(e.links)){const a=i(o);if(!a.isValid)return a}return de},tn=Y(Md,e=>te("memoize",e)),kd=e=>e.reduce((t,n)=>Object.assign(t,n),{}),Vr=({initialState:e,reducer:t,resolver:n,validators:s})=>r=>(tn(r,s),$r(r,n).reduce(t,e)),Ad=class extends it{user;context;initialState;reducer;resolver;validators;keyring;graph;state;constructor({user:e,context:t={},graph:n,rootPayload:s,initialState:r={},reducer:i,validators:o,resolver:a=Br,keys:c}){super(),n===void 0?(b(dt(c),"If no graph is provided, only pass a single keyset, not a keyring."),this.graph=ed({user:e,rootPayload:s,keys:c})):wd(n)?this.graph=n:(b(c),this.graph=Ed(n,c)),this.context=t,this.initialState=r,this.reducer=i,this.validators=o,this.resolver=a,this.user=e,this.keyring=re(c),this.updateState()}getState(){return this.state}getGraph(){return this.graph}save(){return gd(this.graph)}dispatch(e,t){const n={payload:void 0,...e};if(t===void 0){const r=this.graph.head.sort()[0],i=this.graph.encryptedLinks[r].recipientPublicKey;t=this.keyring[i]}else this.keyring[t.encryption.publicKey]=t;this.graph=Lr({graph:this.graph,action:n,user:this.user,keys:t,context:this.context});const[s]=dd(this.graph);return this.state=this.reducer(this.state,s),this.emit("updated",{head:this.graph.head}),e}merge(e){this.graph=Pr(this.graph,e),this.updateState()}validate(){return tn(this.graph,this.validators)}updateState(){const e=Vr({initialState:this.initialState,reducer:this.reducer,resolver:this.resolver,validators:this.validators});this.state=e(this.graph),this.emit("updated",{head:this.graph.head})}},wd=e=>e?.hasOwnProperty("root"),Zn=e=>new Ad(e),Rd=(e,t)=>{const n={root:e.root,head:e.head},{their:s,our:r,lastCommonHead:i}=t,o={...t},a=e.head,c=s.head;if(r.reportedError)return n.error=r.reportedError,delete r.reportedError,[o,n];if(Pe(a,i))return[o,void 0];if(Pe(a,c))return o.lastCommonHead=a,[o,n];const d=Object.fromEntries([...c,...c.flatMap(m=>we(e,m)),...i,...i.flatMap(m=>we(e,m)),...Object.keys(s.parentMap),...r.links].map(m=>[m,!0]));let h=[];if(c.length>0&&c.every(m=>m in e.links))h=We(e).filter(m=>!(m in d));else{if(s.parentMap){const m={...e.encryptedLinks,...s.encryptedLinks};n.need=Object.keys(d).filter(M=>!(M in m)),h=We(e).filter(M=>!(M in d))}Pe(a,r.parentMapAtHead)||(n.parentMap=Rt({graph:e,end:i}),o.our.parentMapAtHead=a)}const v=s.need.concat(h);if(v.length>0){n.links=ad(e,v);const m=Rt({graph:e,hashes:v});n.parentMap={...n.parentMap,...m}}return o.our.links=r.links.concat(v),o.their.need=[],[o,n]},Qn=()=>({their:{head:[],encryptedLinks:{},need:[],parentMap:{}},our:{head:[],links:[]},lastCommonHead:[],failedSyncCount:0}),Od=(e,t,n,s,r=Qt)=>{const i=re(s),o=n;b(e.root===o.root,"Can't sync graphs with different roots");const a={...t,their:{head:o.head,need:o.need??[],encryptedLinks:{...t.their.encryptedLinks,...o.links},parentMap:{...t.their.parentMap,...o.parentMap}}};if(Object.keys(a.their.encryptedLinks).length>0){const{head:c}=o,u=en(e),l=hd(a.their.parentMap),d={...u,...l},h={...e.encryptedLinks,...a.their.encryptedLinks},f={...e,head:c,encryptedLinks:h,childMap:d},p=r({encryptedGraph:f,keys:i}),v=Pr(e,p),m=tn(v);m.isValid?e=v:(a.failedSyncCount+=1,a.our.reportedError=m.error),a.their.encryptedLinks={},a.their.parentMap={}}return[e,a]},Sl=(e,t=Zt(),n=pe())=>({userName:e,userId:t,keys:G({type:nd.USER,name:t},n)}),xd=e=>{const{userId:t,userName:n}=e;return{userId:t,userName:n,keys:F(e.keys)}};function Ld(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof $n<"u")return $n}function Cd(){const e=Ld();if(e.__xstate__)return e.__xstate__}const Dd=e=>{if(typeof window>"u")return;const t=Cd();t&&t.register(e)};class es{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const n={value:t,next:null};if(this._current){this._last.next=n,this._last=n;return}this._current=n,this._last=n,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const Hr=".",Nd="",Ur="",Kd="#",$d="*",jr="xstate.init",xt="xstate.stop";function Bd(e,t){return{type:`xstate.after.${e}.${t}`}}function Lt(e,t){return{type:`xstate.done.state.${e}`,output:t}}function Pd(e,t){return{type:`xstate.done.actor.${e}`,output:t,actorId:e}}function Vd(e,t){return{type:`xstate.error.actor.${e}`,error:t,actorId:e}}function Yr(e){return{type:jr,input:e}}function B(e){setTimeout(()=>{throw e})}const Hd=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Gr(e,t){const n=ts(e),s=ts(t);return typeof s=="string"?typeof n=="string"?s===n:!1:typeof n=="string"?n in s:Object.keys(n).every(r=>r in s?Gr(n[r],s[r]):!1)}function nn(e){if(Wr(e))return e;const t=[];let n="";for(let s=0;s<e.length;s++){switch(e.charCodeAt(s)){case 92:n+=e[s+1],s++;continue;case 46:t.push(n),n="";continue}n+=e[s]}return t.push(n),t}function ts(e){if(_u(e))return e.value;if(typeof e!="string")return e;const t=nn(e);return Ud(t)}function Ud(e){if(e.length===1)return e[0];const t={};let n=t;for(let s=0;s<e.length-1;s++)if(s===e.length-2)n[e[s]]=e[s+1];else{const r=n;n={},r[e[s]]=n}return t}function ns(e,t){const n={},s=Object.keys(e);for(let r=0;r<s.length;r++){const i=s[r];n[i]=t(e[i],i,e,r)}return n}function Fr(e){return Wr(e)?e:[e]}function U(e){return e===void 0?[]:Fr(e)}function Ct(e,t,n,s){return typeof e=="function"?e({context:t,event:n,self:s}):e}function Wr(e){return Array.isArray(e)}function jd(e){return e.type.startsWith("xstate.error.actor")}function ce(e){return Fr(e).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function zr(e){if(!(e===void 0||e===Nd))return U(e)}function Dt(e,t,n){const s=typeof e=="object",r=s?e:void 0;return{next:(s?e.next:e)?.bind(r),error:(s?e.error:t)?.bind(r),complete:(s?e.complete:n)?.bind(r)}}function ss(e,t){return`${t}.${e}`}function sn(e,t){const n=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!n)return e.implementations.actors[t];const[,s,r]=n,o=e.getStateNodeById(r).config.invoke;return(Array.isArray(o)?o[s]:o).src}function rs(e,t){return`${e.sessionId}.${t}`}let Yd=0;function Gd(e,t){const n=new Map,s=new Map,r=new WeakMap,i=new Set,o={},{clock:a,logger:c}=t,u={schedule:(h,f,p,v,m=Math.random().toString(36).slice(2))=>{const M={source:h,target:f,event:p,delay:v,id:m,startedAt:Date.now()},R=rs(h,m);d._snapshot._scheduledEvents[R]=M;const $=a.setTimeout(()=>{delete o[R],delete d._snapshot._scheduledEvents[R],d._relay(h,f,p)},v);o[R]=$},cancel:(h,f)=>{const p=rs(h,f),v=o[p];delete o[p],delete d._snapshot._scheduledEvents[p],v!==void 0&&a.clearTimeout(v)},cancelAll:h=>{for(const f in d._snapshot._scheduledEvents){const p=d._snapshot._scheduledEvents[f];p.source===h&&u.cancel(h,p.id)}}},l=h=>{if(!i.size)return;const f={...h,rootId:e.sessionId};i.forEach(p=>p.next?.(f))},d={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${Yd++}`,_register:(h,f)=>(n.set(h,f),h),_unregister:h=>{n.delete(h.sessionId);const f=r.get(h);f!==void 0&&(s.delete(f),r.delete(h))},get:h=>s.get(h),_set:(h,f)=>{const p=s.get(h);if(p&&p!==f)throw new Error(`Actor with system ID '${h}' already exists.`);s.set(h,f),r.set(f,h)},inspect:h=>{const f=Dt(h);return i.add(f),{unsubscribe(){i.delete(f)}}},_sendInspectionEvent:l,_relay:(h,f,p)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:h,actorRef:f,event:p}),f._send(p)},scheduler:u,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{const h=d._snapshot._scheduledEvents;d._snapshot._scheduledEvents={};for(const f in h){const{source:p,target:v,event:m,delay:M,id:R}=h[f];u.schedule(p,v,m,M,R)}},_clock:a,_logger:c};return d}let Et=!1;const rn=1;let O=function(e){return e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped",e}({});const Fd={clock:{setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e)},logger:console.log.bind(console),devTools:!1};class Wd{constructor(t,n){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new es(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=O.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const s={...Fd,...n},{clock:r,logger:i,parent:o,syncSnapshot:a,id:c,systemId:u,inspect:l}=s;this.system=o?o.system:Gd(this,{clock:r,logger:i}),l&&!o&&this.system.inspect(Dt(l)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=n?.logger??this.system._logger,this.clock=n?.clock??this.system._clock,this._parent=o,this._syncSnapshot=a,this.options=s,this.src=s.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:d=>{this._deferred.push(d)},system:this.system,stopChild:d=>{if(d._parent!==this)throw new Error(`Cannot stop child actor ${d.id} of ${this.id} because it is not a child`);d._stop()},emit:d=>{const h=this.eventListeners.get(d.type),f=this.eventListeners.get("*");if(!h&&!f)return;const p=[...h?h.values():[],...f?f.values():[]];for(const v of p)v(d)},actionExecutor:d=>{const h=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:d.type,params:d.params}}),!d.exec)return;const f=Et;try{Et=!0,d.exec(d.info,d.params)}finally{Et=f}};this._processingStatus===O.Running?h():this._deferred.push(h)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),u&&(this._systemId=u,this.system._set(u,this)),this._initState(n?.snapshot??n?.state),u&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(n){this._snapshot={status:"error",output:void 0,error:n}}}update(t,n){this._snapshot=t;let s;for(;s=this._deferred.shift();)try{s()}catch(r){this._deferred.length=0,this._snapshot={...t,status:"error",error:r}}switch(this._snapshot.status){case"active":for(const r of this.observers)try{r.next?.(t)}catch(i){B(i)}break;case"done":for(const r of this.observers)try{r.next?.(t)}catch(i){B(i)}this._stopProcedure(),this._complete(),this._doneEvent=Pd(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:n,snapshot:t})}subscribe(t,n,s){const r=Dt(t,n,s);if(this._processingStatus!==O.Stopped)this.observers.add(r);else switch(this._snapshot.status){case"done":try{r.complete?.()}catch(i){B(i)}break;case"error":{const i=this._snapshot.error;if(!r.error)B(i);else try{r.error(i)}catch(o){B(o)}break}}return{unsubscribe:()=>{this.observers.delete(r)}}}on(t,n){let s=this.eventListeners.get(t);s||(s=new Set,this.eventListeners.set(t,s));const r=n.bind(void 0);return s.add(r),{unsubscribe:()=>{s.delete(r)}}}start(){if(this._processingStatus===O.Running)return this;this._syncSnapshot&&this.subscribe({next:s=>{s.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:s})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=O.Running;const t=Yr(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(s){return this._snapshot={...this._snapshot,status:"error",error:s},this._error(s),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let n,s;try{n=this.logic.transition(this._snapshot,t,this._actorScope)}catch(r){s={err:r}}if(s){const{err:r}=s;this._snapshot={...this._snapshot,status:"error",error:r},this._error(r);return}this.update(n,t),t.type===xt&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===O.Stopped?this:(this.mailbox.clear(),this._processingStatus===O.NotStarted?(this._processingStatus=O.Stopped,this):(this.mailbox.enqueue({type:xt}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(const t of this.observers)try{t.complete?.()}catch(n){B(n)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||B(t);return}let n=!1;for(const s of this.observers){const r=s.error;n||=!r;try{r?.(t)}catch(i){B(i)}}this.observers.clear(),n&&B(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,Vd(this.id,t))}_stopProcedure(){return this._processingStatus!==O.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new es(this._process.bind(this)),this._processingStatus=O.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==O.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:Dd)(this)}toJSON(){return{xstate$$type:rn,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[Hd](){return this}getSnapshot(){return this._snapshot}}function Re(e,...[t]){return new Wd(e,t)}function zd(e,t,n,s,{sendId:r}){const i=typeof r=="function"?r(n,s):r;return[t,{sendId:i},void 0]}function qd(e,t){e.defer(()=>{e.system.scheduler.cancel(e.self,t.sendId)})}function Jd(e){function t(n,s){}return t.type="xstate.cancel",t.sendId=e,t.resolve=zd,t.execute=qd,t}function Xd(e,t,n,s,{id:r,systemId:i,src:o,input:a,syncSnapshot:c}){const u=typeof o=="string"?sn(t.machine,o):o,l=typeof r=="function"?r(n):r;let d,h;return u&&(h=typeof a=="function"?a({context:t.context,event:n.event,self:e.self}):a,d=Re(u,{id:l,src:o,parent:e.self,syncSnapshot:c,systemId:i,input:h})),[se(t,{children:{...t.children,[l]:d}}),{id:r,systemId:i,actorRef:d,src:o,input:h},void 0]}function Zd(e,{actorRef:t}){t&&e.defer(()=>{t._processingStatus!==O.Stopped&&t.start()})}function Qd(...[e,{id:t,systemId:n,input:s,syncSnapshot:r=!1}={}]){function i(o,a){}return i.type="xstate.spawnChild",i.id=t,i.systemId=n,i.src=e,i.input=s,i.syncSnapshot=r,i.resolve=Xd,i.execute=Zd,i}function eu(e,t,n,s,{actorRef:r}){const i=typeof r=="function"?r(n,s):r,o=typeof i=="string"?t.children[i]:i;let a=t.children;return o&&(a={...a},delete a[o.id]),[se(t,{children:a}),o,void 0]}function tu(e,t){if(t){if(e.system._unregister(t),t._processingStatus!==O.Running){e.stopChild(t);return}e.defer(()=>{e.stopChild(t)})}}function qr(e){function t(n,s){}return t.type="xstate.stopChild",t.actorRef=e,t.resolve=eu,t.execute=tu,t}function nu(e,{context:t,event:n},{guards:s}){return s.every(r=>ut(r,t,n,e))}function is(e){function t(n,s){return!1}return t.check=nu,t.guards=e,t}function ut(e,t,n,s){const{machine:r}=s,i=typeof e=="function",o=i?e:r.implementations.guards[typeof e=="string"?e:e.type];if(!i&&!o)throw new Error(`Guard '${typeof e=="string"?e:e.type}' is not implemented.'.`);if(typeof o!="function")return ut(o,t,n,s);const a={context:t,event:n},c=i||typeof e=="string"?void 0:"params"in e?typeof e.params=="function"?e.params({context:t,event:n}):e.params:void 0;return"check"in o?o.check(s,a,o):o(a,c)}const on=e=>e.type==="atomic"||e.type==="final";function le(e){return Object.values(e.states).filter(t=>t.type!=="history")}function Ce(e,t){const n=[];if(t===e)return n;let s=e.parent;for(;s&&s!==t;)n.push(s),s=s.parent;return n}function ze(e){const t=new Set(e),n=Xr(t);for(const s of t)if(s.type==="compound"&&(!n.get(s)||!n.get(s).length))os(s).forEach(r=>t.add(r));else if(s.type==="parallel"){for(const r of le(s))if(r.type!=="history"&&!t.has(r)){const i=os(r);for(const o of i)t.add(o)}}for(const s of t){let r=s.parent;for(;r;)t.add(r),r=r.parent}return t}function Jr(e,t){const n=t.get(e);if(!n)return{};if(e.type==="compound"){const r=n[0];if(r){if(on(r))return r.key}else return{}}const s={};for(const r of n)s[r.key]=Jr(r,t);return s}function Xr(e){const t=new Map;for(const n of e)t.has(n)||t.set(n,[]),n.parent&&(t.has(n.parent)||t.set(n.parent,[]),t.get(n.parent).push(n));return t}function Zr(e,t){const n=ze(t);return Jr(e,Xr(n))}function an(e,t){return t.type==="compound"?le(t).some(n=>n.type==="final"&&e.has(n)):t.type==="parallel"?le(t).every(n=>an(e,n)):t.type==="final"}const ht=e=>e[0]===Kd;function su(e,t){return e.transitions.get(t)||[...e.transitions.keys()].filter(s=>{if(s===$d)return!0;if(!s.endsWith(".*"))return!1;const r=s.split("."),i=t.split(".");for(let o=0;o<r.length;o++){const a=r[o],c=i[o];if(a==="*")return o===r.length-1;if(a!==c)return!1}return!0}).sort((s,r)=>r.length-s.length).flatMap(s=>e.transitions.get(s))}function ru(e){const t=e.config.after;if(!t)return[];const n=r=>{const i=Bd(r,e.id),o=i.type;return e.entry.push(xu(i,{id:o,delay:r})),e.exit.push(Jd(o)),o};return Object.keys(t).flatMap(r=>{const i=t[r],o=typeof i=="string"?{target:i}:i,a=Number.isNaN(+r)?r:+r,c=n(a);return U(o).map(u=>({...u,event:c,delay:a}))}).map(r=>{const{delay:i}=r;return{...Q(e,r.event,r),delay:i}})}function Q(e,t,n){const s=zr(n.target),r=n.reenter??!1,i=au(e,s),o={...n,actions:U(n.actions),guard:n.guard,target:i,source:e,reenter:r,eventType:t,toJSON:()=>({...o,source:`#${e.id}`,target:i?i.map(a=>`#${a.id}`):void 0})};return o}function iu(e){const t=new Map;if(e.config.on)for(const n of Object.keys(e.config.on)){if(n===Ur)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const s=e.config.on[n];t.set(n,ce(s).map(r=>Q(e,n,r)))}if(e.config.onDone){const n=`xstate.done.state.${e.id}`;t.set(n,ce(e.config.onDone).map(s=>Q(e,n,s)))}for(const n of e.invoke){if(n.onDone){const s=`xstate.done.actor.${n.id}`;t.set(s,ce(n.onDone).map(r=>Q(e,s,r)))}if(n.onError){const s=`xstate.error.actor.${n.id}`;t.set(s,ce(n.onError).map(r=>Q(e,s,r)))}if(n.onSnapshot){const s=`xstate.snapshot.${n.id}`;t.set(s,ce(n.onSnapshot).map(r=>Q(e,s,r)))}}for(const n of e.after){let s=t.get(n.eventType);s||(s=[],t.set(n.eventType,s)),s.push(n)}return t}function ou(e,t){const n=typeof t=="string"?e.states[t]:t?e.states[t.target]:void 0;if(!n&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${e.id}`);const s={source:e,actions:!t||typeof t=="string"?[]:U(t.actions),eventType:null,reenter:!1,target:n?[n]:[],toJSON:()=>({...s,source:`#${e.id}`,target:n?[`#${n.id}`]:[]})};return s}function au(e,t){if(t!==void 0)return t.map(n=>{if(typeof n!="string")return n;if(ht(n))return e.machine.getStateNodeById(n);const s=n[0]===Hr;if(s&&!e.parent)return qe(e,n.slice(1));const r=s?e.key+n:n;if(e.parent)try{return qe(e.parent,r)}catch(i){throw new Error(`Invalid transition definition for state node '${e.id}':
${i.message}`)}else throw new Error(`Invalid target: "${n}" is not a valid target from the root node. Did you mean ".${n}"?`)})}function Qr(e){const t=zr(e.config.target);return t?{target:t.map(n=>typeof n=="string"?qe(e.parent,n):n)}:e.parent.initial}function ee(e){return e.type==="history"}function os(e){const t=ei(e);for(const n of t)for(const s of Ce(n,e))t.add(s);return t}function ei(e){const t=new Set;function n(s){if(!t.has(s)){if(t.add(s),s.type==="compound")n(s.initial.target[0]);else if(s.type==="parallel")for(const r of le(s))n(r)}}return n(e),t}function fe(e,t){if(ht(t))return e.machine.getStateNodeById(t);if(!e.states)throw new Error(`Unable to retrieve child state '${t}' from '${e.id}'; no child states exist.`);const n=e.states[t];if(!n)throw new Error(`Child state '${t}' does not exist on '${e.id}'`);return n}function qe(e,t){if(typeof t=="string"&&ht(t))try{return e.machine.getStateNodeById(t)}catch{}const n=nn(t).slice();let s=e;for(;n.length;){const r=n.shift();if(!r.length)break;s=fe(s,r)}return s}function Je(e,t){if(typeof t=="string"){const r=e.states[t];if(!r)throw new Error(`State '${t}' does not exist on '${e.id}'`);return[e,r]}const n=Object.keys(t),s=n.map(r=>fe(e,r)).filter(Boolean);return[e.machine.root,e].concat(s,n.reduce((r,i)=>{const o=fe(e,i);if(!o)return r;const a=Je(o,t[i]);return r.concat(a)},[]))}function cu(e,t,n,s){const i=fe(e,t).next(n,s);return!i||!i.length?e.next(n,s):i}function du(e,t,n,s){const r=Object.keys(t),i=fe(e,r[0]),o=cn(i,t[r[0]],n,s);return!o||!o.length?e.next(n,s):o}function uu(e,t,n,s){const r=[];for(const i of Object.keys(t)){const o=t[i];if(!o)continue;const a=fe(e,i),c=cn(a,o,n,s);c&&r.push(...c)}return r.length?r:e.next(n,s)}function cn(e,t,n,s){return typeof t=="string"?cu(e,t,n,s):Object.keys(t).length===1?du(e,t,n,s):uu(e,t,n,s)}function hu(e){return Object.keys(e.states).map(t=>e.states[t]).filter(t=>t.type==="history")}function z(e,t){let n=e;for(;n.parent&&n.parent!==t;)n=n.parent;return n.parent===t}function lu(e,t){const n=new Set(e),s=new Set(t);for(const r of n)if(s.has(r))return!0;for(const r of s)if(n.has(r))return!0;return!1}function ti(e,t,n){const s=new Set;for(const r of e){let i=!1;const o=new Set;for(const a of s)if(lu(Nt([r],t,n),Nt([a],t,n)))if(z(r.source,a.source))o.add(a);else{i=!0;break}if(!i){for(const a of o)s.delete(a);s.add(r)}}return Array.from(s)}function fu(e){const[t,...n]=e;for(const s of Ce(t,void 0))if(n.every(r=>z(r,s)))return s}function dn(e,t){if(!e.target)return[];const n=new Set;for(const s of e.target)if(ee(s))if(t[s.id])for(const r of t[s.id])n.add(r);else for(const r of dn(Qr(s),t))n.add(r);else n.add(s);return[...n]}function ni(e,t){const n=dn(e,t);if(!n)return;if(!e.reenter&&n.every(r=>r===e.source||z(r,e.source)))return e.source;const s=fu(n.concat(e.source));if(s)return s;if(!e.reenter)return e.source.machine.root}function Nt(e,t,n){const s=new Set;for(const r of e)if(r.target?.length){const i=ni(r,n);r.reenter&&r.source===i&&s.add(i);for(const o of t)z(o,i)&&s.add(o)}return[...s]}function yu(e,t){if(e.length!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function Kt(e,t,n,s,r,i){if(!e.length)return t;const o=new Set(t._nodes);let a=t.historyValue;const c=ti(e,o,a);let u=t;r||([u,a]=gu(u,s,n,c,o,a,i,n.actionExecutor)),u=ye(u,s,n,c.flatMap(d=>d.actions),i,void 0),u=vu(u,s,n,c,o,i,a,r);const l=[...o];u.status==="done"&&(u=ye(u,s,n,l.sort((d,h)=>h.order-d.order).flatMap(d=>d.exit),i,void 0));try{return a===t.historyValue&&yu(t._nodes,o)?u:se(u,{_nodes:l,historyValue:a})}catch(d){throw d}}function pu(e,t,n,s,r){if(s.output===void 0)return;const i=Lt(r.id,r.output!==void 0&&r.parent?Ct(r.output,e.context,t,n.self):void 0);return Ct(s.output,e.context,i,n.self)}function vu(e,t,n,s,r,i,o,a){let c=e;const u=new Set,l=new Set;mu(s,o,l,u),a&&l.add(e.machine.root);const d=new Set;for(const h of[...u].sort((f,p)=>f.order-p.order)){r.add(h);const f=[];f.push(...h.entry);for(const p of h.invoke)f.push(Qd(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(l.has(h)){const p=h.initial.actions;f.push(...p)}if(c=ye(c,t,n,f,i,h.invoke.map(p=>p.id)),h.type==="final"){const p=h.parent;let v=p?.type==="parallel"?p:p?.parent,m=v||h;for(p?.type==="compound"&&i.push(Lt(p.id,h.output!==void 0?Ct(h.output,c.context,t,n.self):void 0));v?.type==="parallel"&&!d.has(v)&&an(r,v);)d.add(v),i.push(Lt(v.id)),m=v,v=v.parent;if(v)continue;c=se(c,{status:"done",output:pu(c,t,n,c.machine.root,m)})}}return c}function mu(e,t,n,s){for(const r of e){const i=ni(r,t);for(const a of r.target||[])!ee(a)&&(r.source!==a||r.source!==i||r.reenter)&&(s.add(a),n.add(a)),ue(a,t,n,s);const o=dn(r,t);for(const a of o){const c=Ce(a,i);i?.type==="parallel"&&c.push(i),si(s,t,n,c,!r.source.parent&&r.reenter?void 0:i)}}}function ue(e,t,n,s){if(ee(e))if(t[e.id]){const r=t[e.id];for(const i of r)s.add(i),ue(i,t,n,s);for(const i of r)bt(i,e.parent,s,t,n)}else{const r=Qr(e);for(const i of r.target)s.add(i),r===e.parent?.initial&&n.add(e.parent),ue(i,t,n,s);for(const i of r.target)bt(i,e.parent,s,t,n)}else if(e.type==="compound"){const[r]=e.initial.target;ee(r)||(s.add(r),n.add(r)),ue(r,t,n,s),bt(r,e,s,t,n)}else if(e.type==="parallel")for(const r of le(e).filter(i=>!ee(i)))[...s].some(i=>z(i,r))||(ee(r)||(s.add(r),n.add(r)),ue(r,t,n,s))}function si(e,t,n,s,r){for(const i of s)if((!r||z(i,r))&&e.add(i),i.type==="parallel")for(const o of le(i).filter(a=>!ee(a)))[...e].some(a=>z(a,o))||(e.add(o),ue(o,t,n,e))}function bt(e,t,n,s,r){si(n,s,r,Ce(e,t))}function gu(e,t,n,s,r,i,o,a){let c=e;const u=Nt(s,r,i);u.sort((d,h)=>h.order-d.order);let l;for(const d of u)for(const h of hu(d)){let f;h.history==="deep"?f=p=>on(p)&&z(p,d):f=p=>p.parent===d,l??={...i},l[h.id]=Array.from(r).filter(f)}for(const d of u)c=ye(c,t,n,[...d.exit,...d.invoke.map(h=>qr(h.id))],o,void 0),r.delete(d);return[c,l||i]}function Eu(e,t){return e.implementations.actions[t]}function ri(e,t,n,s,r,i){const{machine:o}=e;let a=e;for(const c of s){const u=typeof c=="function",l=u?c:Eu(o,typeof c=="string"?c:c.type),d={context:a.context,event:t,self:n.self,system:n.system},h=u||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:t}):c.params:void 0;if(!l||!("resolve"in l)){n.actionExecutor({type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",info:d,params:h,exec:l});continue}const f=l,[p,v,m]=f.resolve(n,a,d,h,l,r);a=p,"retryResolve"in f&&i?.push([f,v]),"execute"in f&&n.actionExecutor({type:f.type,info:d,params:v,exec:f.execute.bind(null,n,v)}),m&&(a=ri(a,t,n,m,r,i))}return a}function ye(e,t,n,s,r,i){const o=i?[]:void 0,a=ri(e,t,n,s,{internalQueue:r,deferredActorIds:i},o);return o?.forEach(([c,u])=>{c.retryResolve(n,a,u)}),a}function It(e,t,n,s){let r=e;const i=[];function o(u,l,d){n.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:n.self,event:l,snapshot:u,_transitions:d}),i.push(u)}if(t.type===xt)return r=se(as(r,t,n),{status:"stopped"}),o(r,t,[]),{snapshot:r,microstates:i};let a=t;if(a.type!==jr){const u=a,l=jd(u),d=cs(u,r);if(l&&!d.length)return r=se(e,{status:"error",error:u.error}),o(r,u,[]),{snapshot:r,microstates:i};r=Kt(d,e,n,a,!1,s),o(r,u,d)}let c=!0;for(;r.status==="active";){let u=c?bu(r,a):[];const l=u.length?r:void 0;if(!u.length){if(!s.length)break;a=s.shift(),u=cs(a,r)}r=Kt(u,r,n,a,!1,s),c=r!==l,o(r,a,u)}return r.status!=="active"&&as(r,a,n),{snapshot:r,microstates:i}}function as(e,t,n){return ye(e,t,n,Object.values(e.children).map(s=>qr(s)),[],void 0)}function cs(e,t){return t.machine.getTransitionData(t,e)}function bu(e,t){const n=new Set,s=e._nodes.filter(on);for(const r of s)e:for(const i of[r].concat(Ce(r,void 0)))if(i.always){for(const o of i.always)if(o.guard===void 0||ut(o.guard,e.context,t,e)){n.add(o);break e}}return ti(Array.from(n),new Set(e._nodes),e.historyValue)}function Iu(e,t){const n=ze(Je(e,t));return Zr(e,[...n])}function _u(e){return!!e&&typeof e=="object"&&"machine"in e&&"value"in e}const Su=function(t){return Gr(t,this.value)},Tu=function(t){return this.tags.has(t)},Mu=function(t){const n=this.machine.getTransitionData(this,t);return!!n?.length&&n.some(s=>s.target!==void 0||s.actions.length)},ku=function(){const{_nodes:t,tags:n,machine:s,getMeta:r,toJSON:i,can:o,hasTag:a,matches:c,...u}=this;return{...u,tags:Array.from(n)}},Au=function(){return this._nodes.reduce((t,n)=>(n.meta!==void 0&&(t[n.id]=n.meta),t),{})};function Ve(e,t){return{status:e.status,output:e.output,error:e.error,machine:t,context:e.context,_nodes:e._nodes,value:Zr(t.root,e._nodes),tags:new Set(e._nodes.flatMap(n=>n.tags)),children:e.children,historyValue:e.historyValue||{},matches:Su,hasTag:Tu,can:Mu,getMeta:Au,toJSON:ku}}function se(e,t={}){return Ve({...e,...t},e.machine)}function wu(e,t){const{_nodes:n,tags:s,machine:r,children:i,context:o,can:a,hasTag:c,matches:u,getMeta:l,toJSON:d,...h}=e,f={};for(const v in i){const m=i[v];f[v]={snapshot:m.getPersistedSnapshot(t),src:m.src,systemId:m._systemId,syncSnapshot:m._syncSnapshot}}return{...h,context:ii(o),children:f}}function ii(e){let t;for(const n in e){const s=e[n];if(s&&typeof s=="object")if("sessionId"in s&&"send"in s&&"ref"in s)t??=Array.isArray(e)?e.slice():{...e},t[n]={xstate$$type:rn,id:s.id};else{const r=ii(s);r!==s&&(t??=Array.isArray(e)?e.slice():{...e},t[n]=r)}}return t??e}function Ru(e,t,n,s,{event:r,id:i,delay:o},{internalQueue:a}){const c=t.machine.implementations.delays;if(typeof r=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${r}" }) instead`);const u=typeof r=="function"?r(n,s):r;let l;if(typeof o=="string"){const d=c&&c[o];l=typeof d=="function"?d(n,s):d}else l=typeof o=="function"?o(n,s):o;return typeof l!="number"&&a.push(u),[t,{event:u,id:i,delay:l},void 0]}function Ou(e,t){const{event:n,delay:s,id:r}=t;if(typeof s=="number"){e.defer(()=>{const i=e.self;e.system.scheduler.schedule(i,i,n,s,r)});return}}function xu(e,t){function n(s,r){}return n.type="xstate.raise",n.event=e,n.id=t?.id,n.delay=t?.delay,n.resolve=Ru,n.execute=Ou,n}function Lu(e,{machine:t,context:n},s,r){const i=(o,a={})=>{const{systemId:c,input:u}=a;if(typeof o=="string"){const l=sn(t,o);if(!l)throw new Error(`Actor logic '${o}' not implemented in machine '${t.id}'`);const d=Re(l,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:typeof u=="function"?u({context:n,event:s,self:e.self}):u,src:o,systemId:c});return r[d.id]=d,d}else return Re(o,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:a.input,src:o,systemId:c})};return(o,a)=>{const c=i(o,a);return r[c.id]=c,e.defer(()=>{c._processingStatus!==O.Stopped&&c.start()}),c}}function Cu(e,t,n,s,{assignment:r}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const i={},o={context:t.context,event:n.event,spawn:Lu(e,t,n.event,i),self:e.self,system:e.system};let a={};if(typeof r=="function")a=r(o,s);else for(const u of Object.keys(r)){const l=r[u];a[u]=typeof l=="function"?l(o,s):l}const c=Object.assign({},t.context,a);return[se(t,{context:c,children:Object.keys(i).length?{...t.children,...i}:t.children}),void 0,void 0]}function L(e){function t(n,s){}return t.type="xstate.assign",t.assignment=e,t.resolve=Cu,t}function K(e,t){const n=U(t);if(!n.includes(e.type)){const s=n.length===1?`type "${n[0]}"`:`one of types "${n.join('", "')}"`;throw new Error(`Expected event ${JSON.stringify(e)} to have ${s}`)}}const ds=new WeakMap;function oe(e,t,n){let s=ds.get(e);return s?t in s||(s[t]=n()):(s={[t]:n()},ds.set(e,s)),s[t]}const Du={},ge=e=>typeof e=="string"?{type:e}:typeof e=="function"?"resolve"in e?{type:e.type}:{type:e.name}:e;class un{constructor(t,n){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=n._parent,this.key=n._key,this.machine=n._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(Hr),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?ns(this.config.states,(s,r)=>new un(s,{_parent:this,_key:r,_machine:this.machine})):Du,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=U(this.config.entry).slice(),this.exit=U(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=U(t.tags).slice()}_initialize(){this.transitions=iu(this),this.config.always&&(this.always=ce(this.config.always).map(t=>Q(this,Ur,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(ge),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(ge),eventType:null})}:void 0,history:this.history,states:ns(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(ge)})),entry:this.entry.map(ge),exit:this.exit.map(ge),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return oe(this,"invoke",()=>U(this.config.invoke).map((t,n)=>{const{src:s,systemId:r}=t,i=t.id??ss(this.id,n),o=typeof s=="string"?s:`xstate.invoke.${ss(this.id,n)}`;return{...t,src:o,id:i,systemId:r,toJSON(){const{onDone:a,onError:c,...u}=t;return{...u,type:"xstate.invoke",src:o,id:i}}}}))}get on(){return oe(this,"on",()=>[...this.transitions].flatMap(([n,s])=>s.map(r=>[n,r])).reduce((n,[s,r])=>(n[s]=n[s]||[],n[s].push(r),n),{}))}get after(){return oe(this,"delayedTransitions",()=>ru(this))}get initial(){return oe(this,"initial",()=>ou(this,this.config.initial))}next(t,n){const s=n.type,r=[];let i;const o=oe(this,`candidates-${s}`,()=>su(this,s));for(const a of o){const{guard:c}=a,u=t.context;let l=!1;try{l=!c||ut(c,u,n,t)}catch(d){const h=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${h?`'${h}' `:""}in transition for event '${s}' in state node '${this.id}':
${d.message}`)}if(l){r.push(...a.actions),i=a;break}}return i?[i]:void 0}get events(){return oe(this,"events",()=>{const{states:t}=this,n=new Set(this.ownEvents);if(t)for(const s of Object.keys(t)){const r=t[s];if(r.states)for(const i of r.events)n.add(`${i}`)}return Array.from(n)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(n=>this.transitions.get(n).some(s=>!(!s.target&&!s.actions.length&&!s.reenter))));return Array.from(t)}}const Nu="#";class hn{constructor(t,n){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=t.id||"(machine)",this.implementations={actors:n?.actors??{},actions:n?.actions??{},delays:n?.delays??{},guards:n?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new un(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:n,guards:s,actors:r,delays:i}=this.implementations;return new hn(this.config,{actions:{...n,...t.actions},guards:{...s,...t.guards},actors:{...r,...t.actors},delays:{...i,...t.delays}})}resolveState(t){const n=Iu(this.root,t.value),s=ze(Je(this.root,n));return Ve({_nodes:[...s],context:t.context||{},children:{},status:an(s,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,n,s){return It(t,n,s,[]).snapshot}microstep(t,n,s){return It(t,n,s,[]).microstates}getTransitionData(t,n){return cn(this.root,t.value,t,n)||[]}getPreInitialState(t,n,s){const{context:r}=this.config,i=Ve({context:typeof r!="function"&&r?r:{},_nodes:[this.root],children:{},status:"active"},this);return typeof r=="function"?ye(i,n,t,[L(({spawn:a,event:c,self:u})=>r({spawn:a,input:c.input,self:u}))],s,void 0):i}getInitialSnapshot(t,n){const s=Yr(n),r=[],i=this.getPreInitialState(t,s,r),o=Kt([{target:[...ei(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],i,t,s,!0,r),{snapshot:a}=It(o,s,t,r);return a}start(t){Object.values(t.children).forEach(n=>{n.getSnapshot().status==="active"&&n.start()})}getStateNodeById(t){const n=nn(t),s=n.slice(1),r=ht(n[0])?n[0].slice(Nu.length):n[0],i=this.idMap.get(r);if(!i)throw new Error(`Child state node '#${r}' does not exist on machine '${this.id}'`);return qe(i,s)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,n){return wu(t,n)}restoreSnapshot(t,n){const s={},r=t.children;Object.keys(r).forEach(c=>{const u=r[c],l=u.snapshot,d=u.src,h=typeof d=="string"?sn(this,d):d;if(!h)return;const f=Re(h,{id:c,parent:n.self,syncSnapshot:u.syncSnapshot,snapshot:l,src:d,systemId:u.systemId});s[c]=f});const i=Ve({...t,children:s,_nodes:Array.from(ze(Je(this.root,t.value)))},this),o=new Set;function a(c,u){if(!o.has(c)){o.add(c);for(const l in c){const d=c[l];if(d&&typeof d=="object"){if("xstate$$type"in d&&d.xstate$$type===rn){c[l]=u[d.id];continue}a(d,u)}}}}return a(i.context,s),i}}function Ku(e,t){return new hn(e,t)}function $u({schemas:e,actors:t,actions:n,guards:s,delays:r}){return{createMachine:i=>Ku({...i,schemas:e},{actors:t,actions:n,guards:s,delays:r})}}var Bu=Object.defineProperty,lt=(e,t)=>{for(var n in t)Bu(e,n,{get:t[n],enumerable:!0})},Pu={};lt(Pu,{Connection:()=>pl,DEVICE_REMOVED:()=>yn,DEVICE_UNKNOWN:()=>pn,ENCRYPTION_FAILURE:()=>Ze,IDENTITY_PROOF_INVALID:()=>vn,INVITATION_PROOF_INVALID:()=>mn,JOINED_WRONG_TEAM:()=>gn,MEMBER_REMOVED:()=>En,NEITHER_IS_MEMBER:()=>bn,SERVER_REMOVED:()=>In,TIMEOUT:()=>_n,UNHANDLED:()=>Sn,connectionErrors:()=>vi,createErrorMessage:()=>$t,isInviteeClaim:()=>he,isInviteeContext:()=>pt,isInviteeDeviceClaim:()=>yl,isInviteeDeviceContext:()=>Ki,isInviteeMemberClaim:()=>Bi,isInviteeMemberContext:()=>Ln,isMemberClaim:()=>Vt,isMemberContext:()=>Ni,isServerContext:()=>$i});var oi=e=>{const t=n=>{switch(n.type){case"ADD_MEMBER":return n.payload.member.userId;case"REMOVE_MEMBER":return n.payload.userId;case"ADD_ROLE":return n.payload.roleName;case"ADD_MEMBER_ROLE":case"REMOVE_MEMBER_ROLE":return`${n.payload.roleName}:${n.payload.userId}`;case"ADD_DEVICE":return n.payload.device.deviceId;case"REMOVE_DEVICE":return n.payload.deviceId;case"INVITE_MEMBER":case"INVITE_DEVICE":return n.payload.invitation.id;case"REVOKE_INVITATION":return n.payload.id;case"ADMIT_MEMBER":case"ADMIT_DEVICE":return n.payload.id;case"CHANGE_MEMBER_KEYS":return JSON.stringify(n.payload.keys);default:return JSON.stringify(n.payload)}};return e.body.type==="ROOT"?"ROOT":`${e.body.type}:${t(e.body)}`},ai=(e,t)=>{if(!e||!t)return!1;const n=s=>s.sort().join(",");return n(e)===n(t)},ci=e=>!["INVITE_DEVICE","ADD_DEVICE","REMOVE_DEVICE","CHANGE_MEMBER_KEYS","CHANGE_SERVER_KEYS","ADMIT_MEMBER","ADMIT_DEVICE"].includes(e.type),Vu={};lt(Vu,{ADMIN:()=>D});var D="admin",Hu=e=>(t,n)=>{if(us(e,t))return-1;if(us(e,n))return 1;const s=o=>{const a=u=>u.body.type==="ADD_MEMBER"&&u.body.payload.member.userId===o,c=Object.values(e.links).find(a);return b(c,`Could not find link that added member ${o}`),c},[r,i]=[t,n].map(s);return Gc(e,r,i)?-1:1},us=(e,t)=>e.links[e.root].body.userId===t,Xe=e=>{const t=Zc(e).map(s=>s.map(r=>e.links[r])),n=[];for(let s of t)for(const r in hs){const i=hs[r],o=i(s,e),a=o.flatMap(c=>di(s,c));n.push(...o,...a),s=s.filter(ys(n))}return{filter:ys(n)}},di=(e,t)=>{const n=[];switch(t.body.type){case"INVITE_MEMBER":case"INVITE_DEVICE":{const{invitation:r}=t.body.payload;n.push(...e.filter(Ju(r)));break}case"ADMIT_MEMBER":{const r=t.body.payload.memberKeys.name;n.push(...e.filter(fi(r)));break}}const s=n.flatMap(r=>di(e,r));return n.concat(s)},hs={resolveMutualRemovals(e,t){const n=ls(e),s=li(e).map(fn);return n.length>0&&ai(n,s)?e.filter(fi(Uu(t,s))):[]},cantAddBackRemovedMember(e){const t=ls(e);return Gu(e).filter(n=>t.includes(qu(n)))},cantDoAnythingWhenRemoved(e){const t=Wu(e);return e.filter(fs(t))},cantDoAdminActionsWhenDemoted(e){const t=zu(e),n=fs(t),s=r=>ci(r.body);return e.filter(r=>n(r)&&s(r))}},Uu=(e,t)=>t.sort(Hu(e)).pop(),ju=e=>["ADD_MEMBER","ADD_MEMBER_ROLE","ADMIT_MEMBER"].includes(e.body.type),Yu=e=>e.body.type==="REMOVE_MEMBER",Gu=e=>e.filter(ju),ui=e=>e.filter(Yu),Fu=e=>e.body.type==="REMOVE_MEMBER_ROLE"&&e.body.payload.roleName===D,hi=e=>e.filter(Fu),li=e=>ui(e).concat(hi(e)),ls=e=>li(e).map(ln),Wu=e=>ui(e).map(ln),zu=e=>hi(e).map(ln),ln=e=>e.body.payload.userId,fn=e=>e.body.userId,fi=e=>t=>fn(t)===e,fs=e=>t=>e.includes(fn(t)),qu=e=>{switch(e.body.type){case"ADD_MEMBER":return e.body.payload.member.userId;case"ADD_MEMBER_ROLE":return e.body.payload.userId;case"ADMIT_MEMBER":return e.body.payload.memberKeys.name}},ys=e=>t=>!e.includes(t),Ju=e=>t=>(t.body.type==="ADMIT_MEMBER"||t.body.type==="ADMIT_DEVICE")&&t.body.payload.id===e.id,Tl=e=>$r(e,Xe).filter(n=>!n.isInvalid).map(n=>oi(n)).join(","),Xu="SIGNATURE",Zu="ENCRYPTION",Qu="SYMMETRIC",eh="LINK_HASH",th="LINK_TO_PREVIOUS",nh="INVITATION",sh="DEVICE_ID",rh="SHARED_KEY",yi={SIGNATURE:Xu,ENCRYPTION:Zu,SYMMETRIC:Qu,LINK_HASH:eh,LINK_TO_PREVIOUS:th,INVITATION:nh,DEVICE_ID:sh,SHARED_KEY:rh},w={isValid:!0},ih=e=>t=>e.reduce((n,s)=>s(n),t),ps=e=>({type:e.type,name:e.name}),oh=e=>`${e.recipient.name}(${ah(e.recipient.publicKey)}):${e.contents.name}#${e.contents.generation}`,ah=e=>e.slice(0,5),pi=(e,t)=>e.type===t.type&&e.name===t.name,vs=(e,t)=>{b(pi(e,t),`The scope of the new keys must match those of the old lockbox. 
     New scope: ${JSON.stringify(ps(e))} 
     Old scope: ${JSON.stringify(ps(t))}`)},k={GRAPH:"GRAPH",TEAM:"TEAM",ROLE:"ROLE",USER:"USER",DEVICE:"DEVICE",SERVER:"SERVER",EPHEMERAL:"EPHEMERAL"},ch=class extends Error{constructor(e,t){super(),this.message=e,this.details=t}name;details},dh=(e,t)=>{const n=typeof e=="string"?je.decode(e):e,s=typeof t=="string"?je.decode(t):t,r=[n,s].sort(uh).reduce((o,a)=>new Uint8Array([...o,...a]),new Uint8Array);return(typeof e=="string"?te:Fi)(yi.SHARED_KEY,r)},uh=(e,t)=>{const n=e.toString(),s=t.toString();return n<s?-1:n>s?1:0},yn="DEVICE_REMOVED",pn="DEVICE_UNKNOWN",Ze="ENCRYPTION_FAILURE",vn="IDENTITY_PROOF_INVALID",mn="INVITATION_PROOF_INVALID",gn="JOINED_WRONG_TEAM",En="MEMBER_REMOVED",bn="NEITHER_IS_MEMBER",In="SERVER_REMOVED",_n="TIMEOUT",Sn="UNHANDLED",vi={[yn]:{localMessage:"The peer's device was removed from this team",remoteMessage:"Your device was removed from this team"},[pn]:{localMessage:"The peer's device isn't listed on this team",remoteMessage:"Your device isn't listed on this team"},[Ze]:{localMessage:"Unable to establish a secure connection"},[vn]:{localMessage:"The peer's proof of identity is not valid",remoteMessage:"Your proof of identity isn't valid"},[mn]:{localMessage:"The peer's invitation wasn't accepted",remoteMessage:"Your invitation wasn't accepted"},[gn]:{localMessage:"This isn't the team you were invited to",remoteMessage:"This isn't the team the peer was invited to"},[En]:{localMessage:"The peer was removed from this team",remoteMessage:"You were removed from this team"},[bn]:{localMessage:"The peer is also holding an invitation and cannot admit you to the team"},[In]:{localMessage:"The server was removed from this team",remoteMessage:"You (a server) were removed from this team"},[_n]:{localMessage:"We didn't hear back from the peer; giving up",remoteMessage:"The peer didn't hear back from you, so they gave up"},[Sn]:{localMessage:"An unhandled error occurred"}},$t=(e,t="LOCAL")=>{const{localMessage:n,remoteMessage:s=n}=vi[e];return{type:t==="LOCAL"?"LOCAL_ERROR":"ERROR",payload:{type:e,message:t==="LOCAL"?n:s}}};function Tn(e){const t=ks(e);return te(yi.INVITATION,t).slice(0,15)}var Oe=e=>e.replaceAll(/[^a-z\d]/gi,""),De=Y(e=>(e=Oe(e),G(xr,e))),_e=Y(e=>{e=Oe(e);const t=Tn(e),n=De(e),s={id:t},r=ne.sign(s,n.signature.secretKey);return{id:t,signature:r}}),hh=e=>{const t=en(e),{encryptedLinks:n,head:s,root:r}=e,o=Ht({encryptedLinks:n,childMap:t,head:s,root:r});return yh(o)},mi=(e,t)=>{const n=Ut(e);return Qt({encryptedGraph:n,keys:t})},lh=(e,t)=>fh(e)?e:mi(e,t),fh=e=>e?.hasOwnProperty("root"),yh=e=>new Uint8Array(e.buffer,e.byteOffset,e.byteLength),ae="ALL",Se={head:[],teamName:"",members:[],servers:[],roles:[],lockboxes:[],invitations:{},messages:[],removedMembers:[],removedDevices:[],removedServers:[],pendingKeyRotations:[]},Qe={type:k.TEAM,name:k.TEAM},ph={type:k.ROLE,name:D},Ml={type:k.EPHEMERAL,name:k.EPHEMERAL},vh=(e,t)=>{switch(t.body.type){case"ADMIT_MEMBER":{const n=t.body.payload.memberKeys,s=n.name,r={userName:"",userId:s,keys:n,roles:[]},i=[...e.removedMembers,r],o=[...e.pendingKeyRotations];return o.includes(s)||o.push(s),{...e,removedMembers:i,pendingKeyRotations:o}}}return e},mh=e=>t=>({...t,head:[e.hash]}),_t=e=>t=>{const{userId:n}=e;return{...t,members:t.members.map(s=>{if(s.userId===n){const{devices:r=[]}=s;return r.find(i=>i.deviceId===e.deviceId)?s:{...s,devices:[...r,e]}}return s}),removedDevices:t.removedDevices.filter(s=>s.keys.name===e.deviceId)}},St=e=>t=>({...t,members:[...t.members,{...e,roles:[]}],removedMembers:t.removedMembers.filter(n=>n.userId===e.userId)}),Tt=(e,t=[])=>t.map(n=>s=>({...s,members:s.members.map(r=>({...r,roles:r.userId!==e||r.roles.includes(n)?r.roles:[...r.roles,n]}))})),gh=e=>t=>({...t,messages:[...t.messages,e]}),ms=e=>t=>({...t,roles:[...t.roles,e]}),gi=Ic,Eh=e=>t=>({...t,servers:gi([...t.servers,e]),removedServers:t.removedServers.filter(s=>s.host!==e.host)}),bh=e=>t=>({...t,members:t.members.map(n=>n.userId===e.name?{...n,keys:e}:n)}),Ih=e=>t=>({...t,servers:t.servers.map(n=>n.host===e.name?{...n,keys:e}:n)}),_h=e=>t=>{const{lockboxes:n}=t;return e?{...t,lockboxes:n.concat(e)}:t},gs=e=>t=>{const n={...e,uses:0,revoked:!1};return{...t,invitations:{...t.invitations,[e.id]:n}}},Mn=(e,t,n={includeRemoved:!1})=>{const r=[...e.servers,...n.includeRemoved?e.removedServers:[]].find(i=>i.host===t);if(r===void 0)throw new Error(`A server with host '${t}' was not found`);return r},kn=(e,t)=>e.servers.find(n=>n.host===t)!==void 0,Sh=e=>({userId:e.host,userName:e.host,keys:e.keys,roles:[]}),Th=e=>({userId:e.host,userName:e.host,keys:e.keys}),Mh=e=>({userId:e.host,deviceName:e.host,deviceId:e.host,keys:e.keys}),Te={toMember:Sh,toUser:Th,toDevice:Mh},Ei=(e,t,n={includeRemoved:!1})=>bi(e,t,n)!==void 0,ft=(e,t,n={includeRemoved:!1})=>{const s=bi(e,t,n);return b(s,`Device ${t} not found`),s},bi=(e,t,n={includeRemoved:!1})=>kn(e,t)?Te.toDevice(Mn(e,t)):e.members.concat(n.includeRemoved?e.removedMembers:[]).flatMap(i=>i.devices??[]).find(i=>i.deviceId===t)??(n.includeRemoved?e.removedDevices.find(i=>i.deviceId===t):void 0),kh=(e,t)=>Ei(e,t,{includeRemoved:!0})?e.removedDevices.some(n=>n.keys.name===t):!1,Ii=(e,t)=>e.members.find(n=>n.userId===t)!==void 0,Ah=(e,t)=>e.roles.find(n=>n.roleName===t)!==void 0;function An(e,t){return t in e.invitations}function wn(e,t){return b(An(e,t),`No invitation with id '${t}' found.`),e.invitations[t]}var Es=e=>e.hasOwnProperty("publicKey"),C=(e,t)=>{const n=Es(t)?t:F(t),s=F(e),r=W.keyPair(),i=Es(n)?n.publicKey:n.encryption,o=W.encryptBytes({secret:e,recipientPublicKey:i,senderSecretKey:r.secretKey});return{encryptionKey:{...xr,publicKey:r.publicKey},recipient:{...n,publicKey:i},contents:{...s,publicKey:e.encryption.publicKey},encryptedPayload:o}},wh=Y((e,t)=>{const{encryptionKey:n,encryptedPayload:s}=e;return W.decryptBytes({cipher:s,senderPublicKey:n.publicKey,recipientSecretKey:t.encryption.secretKey})}),Rh=({oldLockbox:e,newContents:t,updatedRecipientKeys:n})=>{vs(t,e.contents),n&&vs(e.recipient,n),t.generation=e.contents.generation+1;const s=n??e.recipient;return C(t,s)},_i=(e,t)=>{const{lockboxes:n}=e,{publicKey:s}=t.encryption,i=n.filter(({recipient:a})=>a.publicKey===s).map(a=>wh(a,t)),o=i.flatMap(a=>_i(e,a));return[...i,...o]},Si=(e,t)=>_i(e,t).reduce(Oh,{}),Oh=(e,t)=>{const{type:n,name:s,generation:r}=t,i=e[n]??{},o=i[s]??[];return o[r]=t,{...e,[n]:{...i,[s]:o}}},Rn=(e,t,n)=>{const r=Si(e,n)[t.type]?.[t.name];return re(r)},Ti=(e,t,n)=>{const{type:s,name:r}=n,i=Si(e,t),o=i[s]?i[s][r]:void 0;b(o,`Couldn't find keys: ${JSON.stringify(n)}
     Device: ${t.name}
     Available lockboxes: 
- ${e.lockboxes.map(oh).join(`
- `)} 
     Keymap: ${JSON.stringify(i,null,2)}`);const a="generation"in n&&n.generation!==void 0?n.generation:o.length-1;return o[a]},xh=(e,t)=>{const n=e.lockboxes.filter(({contents:i})=>i.type===t.type&&i.name===t.name),s=n.reduce(Lh,0);return n.filter(({contents:i})=>i.generation===s)},Lh=(e,t)=>{const{generation:n}=t.contents;return n>e?n:e},yt=(e,t,n={includeRemoved:!1})=>{const r=[...e.members,...n.includeRemoved?e.removedMembers:[]].find(i=>i.userId===t);if(r===void 0)throw new Error(`A member named '${t}' was not found`);return r},Mi=(e,t,n={includeRemoved:!1})=>{if(kn(e,t))return Te.toMember(Mn(e,t));const{userId:s}=ft(e,t,n);return yt(e,s,n)},ki=(e,t,n)=>{if(!Ii(e,t))return!1;const s=yt(e,t),{roles:r=[]}=s;return r.includes(n)},He=(e,t)=>ki(e,t,D),Ch=(e,t)=>e.removedMembers.some(n=>n.userId===t),Ai=(e,t)=>e.members.filter(n=>n.roles?.includes(t)),Dh=e=>Ai(e,D),Nh=e=>e.messages,Kh=(e,t)=>{const n=e.roles.find(s=>s.roleName===t);if(!n)throw new Error(`A role called '${t}' was not found`);return n},$h=(e,t)=>e.removedServers.some(n=>n.host===t),{TEAM:bs}=k,Bh=(e,t)=>Rn(e,{type:bs,name:bs},t),wi=(e,{type:t,name:n})=>{const s=e.lockboxes.filter(({recipient:o})=>o.type===t&&o.name===n).map(({contents:{type:o,name:a}})=>({type:o,name:a})),r=s.flatMap(o=>wi(e,o)),i=[...s,...r];return gi(i,o=>o.name+o.type)},Ph=(e,t=[])=>n=>{const s=ft(n,e),r=Mi(n,e),{userId:i}=r;let{keys:o}=r;const a=t.find(({contents:d})=>d.type===k.USER&&d.name===i);if(a){const{type:d,name:h,generation:f,encryption:p,signature:v}=a.contents;o.generation<f&&p!==void 0&&v!==void 0&&(o={type:d,name:h,generation:f,encryption:p,signature:v})}const c=d=>d.userId===i?{...d,devices:d.devices?.filter(h=>h.deviceId!==s.deviceId),keys:o}:d,u=n.members.map(c),l=[...n.removedDevices,s];return{...n,members:u,removedDevices:l}},Vh=e=>t=>{const n=t.members.filter(i=>i.userId!==e),s=t.members.find(i=>i.userId===e),r=[...t.removedMembers];return s&&r.push(s),{...t,members:n,removedMembers:r}},Hh=(e,t)=>n=>({...n,members:n.members.map(s=>({...s,roles:s.userId===e?s.roles.filter(r=>r!==t):s.roles})),lockboxes:n.lockboxes.filter(s=>!(s.recipient.name===e&&s.contents.type===k.ROLE&&s.contents.name===t))}),Uh=e=>t=>({...t,roles:t.roles.filter(n=>n.roleName!==e),lockboxes:t.lockboxes.filter(n=>!(n.contents.type===k.ROLE&&n.contents.name===e))}),jh=e=>t=>{const n=t.servers.filter(i=>i.host!==e),s=t.servers.find(i=>i.host===e),r=[...t.removedServers];return s&&r.push(s),{...t,servers:n,removedServers:r}},Yh=e=>t=>{const n={...t.invitations},s={...n[e],revoked:!0};return{...t,invitations:{...n,[e]:s}}},Gh=e=>t=>{const n=t.pendingKeyRotations.filter(s=>s!==e);return{...t,pendingKeyRotations:n}},Is=e=>t=>({...t,teamName:e}),_s=e=>t=>{const n={...t.invitations},s=n[e],r=s.uses+1;return{...t,invitations:{...n,[e]:{...s,uses:r}}}},Fh={};lt(Fh,{IKEY_LENGTH:()=>Ri,InvitationValidationError:()=>xi,create:()=>Bt,deriveId:()=>Tn,fail:()=>j,generateProof:()=>_e,generateStarterKeys:()=>De,invitationCanBeUsed:()=>On,randomSeed:()=>Pt,validate:()=>Oi});var Ri=16,Bt=({seed:e,maxUses:t=1,expiration:n=0,userId:s})=>{e=Oe(e);const r=Tn(e),i=De(e),{publicKey:o}=i.signature;return{id:r,publicKey:o,expiration:n,maxUses:t,userId:s}},Pt=(e=Ri)=>pe(e),On=(e,t)=>{const{revoked:n,maxUses:s,uses:r,expiration:i}=e;return n?j("The invitation has been revoked"):s>0&&r>=s?j("The invitation cannot be used again"):i>0&&i<t?j("The invitation has expired"):w},Oi=Y((e,t)=>{const{id:n,signature:s}=e;if(n!==t.id)return j("IDs don't match",{proof:e,invitation:t});const{publicKey:r}=t;return ne.verify({payload:{id:n},signature:s,publicKey:r})?w:j("Signature provided is not valid",{proof:e,invitation:t})}),j=(e,t)=>({isValid:!1,error:new xi(e,t)}),xi=class extends Error{constructor(e,t){super(),this.name="Invitation validation failed",this.message=e,this.details=t}index;details},Wh=tt.extend("auth:validate"),zh=(...e)=>{for(const t in Ss){const n=Ss[t],s=n(...e);if(!s.isValid)return s}return w},Ss={rootDeviceBelongsToRootUser(...e){const[t,n]=e,{type:s,payload:r}=n.body;if(s!=="ROOT")return w;const{rootDevice:i,rootMember:o}=r;return i.userId!==o.userId?Z("The founding device must belong to the founding member (userIds must match).",...e):w},mustBeAdmin(...e){const[t,n]=e,s=n.body,{type:r,userId:i}=s;return r===ct?w:ci(s)&&!He(t,i)?Z(`Member '${i}' is not an admin`,...e):w},canOnlyRemoveYourOwnDevices(...e){const[t,n]=e,s=n.body.userId;if(He(t,s))return w;if(n.body.type==="REMOVE_DEVICE"){const i=n.body.payload.deviceId,a=ft(t,i).userId;if(s!==a)return Z("Can't remove another user's device.",...e)}return w},canOnlyChangeYourOwnKeys(...e){const[t,n]=e,s=n.body.userId;if(!He(t,s)){if(n.body.type==="CHANGE_MEMBER_KEYS"){const i=n.body.payload.keys.name;if(s!==i)return Z("Can't change another user's keys.",...e)}else if(n.body.type==="CHANGE_SERVER_KEYS"){const i=n.body.payload.keys.name;if(s!==i)return Z("Can't change another server's keys.",...e)}}return w},cantAdmitWithInvalidInvitation(...e){const[t,n]=e;if(n.body.type==="ADMIT_MEMBER"||n.body.type==="ADMIT_DEVICE"){const{id:s}=n.body.payload,r=wn(t,s);return On(r,n.body.timestamp)}return w},uniqueUserNameAndId(...e){const[t,n]=e;if(n.body.type==="ADMIT_MEMBER"){const{userName:s,memberKeys:r}=n.body.payload;if(t.members.find(a=>a.userId===r.name)!==void 0)return Z("userId is not unique within the team.",...e);if(t.members.find(a=>a.userName.toLowerCase()===s.toLowerCase())!==void 0)return Z("Username is not unique within the team.",...e)}return w}},Z=(e,t,n)=>(e=As(`${oi(n)} ${e}`),Wh(e),{isValid:!1,error:new ch(e,{prevState:t,link:n})}),et=(e,t)=>{if(t.isInvalid)return vh(e,t);e=nc(e);const n=zh(e,t);if(!n.isValid)throw n.error;const s=t.body;return ih([mh(t),_h(s.payload.lockboxes),...qh(s)])(e)},qh=e=>{switch(e.type){case ct:{const{name:t,rootMember:n,rootDevice:s}=e.payload;return[Is(t),ms({roleName:D}),St(n),_t(s),...Tt(n.userId,[D])]}case"ADD_MEMBER":{const{member:t,roles:n}=e.payload;return[St(t),...Tt(t.userId,n)]}case"ADD_ROLE":{const t=e.payload;return[ms(t)]}case"ADD_MEMBER_ROLE":{const{userId:t,roleName:n}=e.payload;return[...Tt(t,[n])]}case"REMOVE_MEMBER":{const{userId:t}=e.payload;return[Vh(t)]}case"ADD_DEVICE":{const{device:t}=e.payload;return[_t(t)]}case"REMOVE_DEVICE":{const{deviceId:t,lockboxes:n}=e.payload;return[Ph(t,n)]}case"REMOVE_ROLE":{const{roleName:t}=e.payload;return[Uh(t)]}case"REMOVE_MEMBER_ROLE":{const{userId:t,roleName:n}=e.payload;return[Hh(t,n)]}case"INVITE_MEMBER":{const{invitation:t}=e.payload;return[gs(t)]}case"INVITE_DEVICE":{const{invitation:t}=e.payload;return[gs(t)]}case"REVOKE_INVITATION":{const{id:t}=e.payload;return[Yh(t)]}case"ADMIT_MEMBER":{const{id:t,memberKeys:n,userName:s}=e.payload,i={userId:n.name,userName:s,keys:n,roles:[]};return[_s(t),St(i)]}case"ADMIT_DEVICE":{const{id:t,device:n}=e.payload;return[_s(t),_t(n)]}case"CHANGE_MEMBER_KEYS":{const{keys:t}=e.payload;return[bh(t)]}case"ROTATE_KEYS":{const{userId:t}=e.payload;return[Gh(t)]}case"ADD_SERVER":{const{server:t}=e.payload;return[Eh(t)]}case"REMOVE_SERVER":{const{host:t}=e.payload;return[jh(t)]}case"CHANGE_SERVER_KEYS":{const{keys:t}=e.payload;return[Ih(t)]}case"MESSAGE":{const{message:t}=e.payload;return[gh(t)]}case"SET_TEAM_NAME":{const{teamName:t}=e.payload;return[Is(t)]}default:throw Jh(e)}};function Jh(e){const{type:t}=e;return new Error(`Unrecognized link type: ${t}`)}var Xh=Vr({initialState:Se,reducer:et,resolver:Xe}),Li=(e,t)=>{const n=mi(e,t);return Xh(n)},{USER:Zh}=k,Qh=({serializedGraph:e,teamKeyring:t,invitationSeed:n})=>{const s=De(n),r=_e(n).id,i=Li(e,t),{userId:o}=wn(i,r);b(o);const{userName:a}=yt(i,o);b(a);const c=Rn(i,{type:Zh,name:o},s),u=Ot(c);return{user:{userName:a,userId:o,keys:u},userKeyring:c}},el=e=>({...e,nonce:pe(),timestamp:Date.now()}),tl=(e,t)=>ne.sign(e,t.signature.secretKey),nl=(e,t,n)=>{const s={challenge:e,signature:t};return ne.verify({payload:e,signature:t,publicKey:n.signature})?w:sl("Signature is not valid",s)},sl=(e,t)=>({isValid:!1,error:new rl(e,t)}),rl=class extends Error{constructor(e,t){super(),this.name="Identity challenge failed",this.message=e+`
`+JSON.stringify(t,null,2).replaceAll('"',""),this.details=t}details},il={};lt(il,{createDevice:()=>ol,redactDevice:()=>xe});var ol=({userId:e,deviceName:t,deviceInfo:n={},created:s=Date.now(),seed:r=pe()})=>{const i=Zt(),o=G({type:k.DEVICE,name:i},r);return{userId:e,deviceId:i,deviceName:t,keys:o,created:s,deviceInfo:n}},xe=e=>({...e,keys:F(e.keys)}),Ts=e=>({...xd(e),roles:[]}),al=e=>"teamName"in e,{DEVICE:Mt,USER:$e}=k,xn=class extends it{state=Se;store;context;log;seed;constructor(e){if(super(),this.seed=e.seed??pe(),"user"in e.context)this.context=e.context;else{const{server:s}=e.context;this.context={...e.context,device:Te.toDevice(s),user:Te.toUser(s)}}const{device:t,user:n}=this.context;if(this.log=tt.extend(`auth:team:${this.userName}`),al(e)){b(!this.isServer,"Servers can't create teams");const s=C(e.teamKeys,n.keys),r=G(ph,this.seed),i=C(r,n.keys),o=C(n.keys,this.context.device.keys),a={name:e.teamName,rootMember:Ts(n),rootDevice:xe(t),lockboxes:[s,i,o]};this.store=Zn({user:n,reducer:et,resolver:Xe,initialState:Se,rootPayload:a,keys:e.teamKeys})}else this.store=Zn({user:n,reducer:et,resolver:Xe,initialState:Se,graph:lh(e.source,e.teamKeyring),keys:e.teamKeyring});this.state=this.store.getState(),this.updateUserKeys(),this.on("updated",()=>{this.updateUserKeys(),this.checkForPendingKeyRotations()})}get graph(){return this.store.getGraph()}get id(){return this.graph.root}get teamName(){return this.state.teamName}setTeamName(e){this.dispatch({type:"SET_TEAM_NAME",payload:{teamName:e}})}get userName(){return this.context.user.userId}get userId(){return this.context.user.userId}get isServer(){return"server"in this.context}save=()=>hh(this.graph);merge=e=>(this.store.merge(e),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head}),this);dispatch(e,t=this.teamKeys()){this.store.dispatch(e,t),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head})}has=e=>Ii(this.state,e);members(e=ae,t={includeRemoved:!0}){return e===ae?this.state.members:yt(this.state,e,t)}addForTesting=(e,t=[],n)=>{const s={...Ts(e),roles:t};if(!this.has(s.userId)){const r=this.createMemberLockboxes(s);this.dispatch({type:"ADD_MEMBER",payload:{member:s,roles:t,lockboxes:r}})}if(n){const r=C(e.keys,n.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:n,lockboxes:[r]}})}};remove=e=>{const t=this.rotateKeys({type:$e,name:e});this.dispatch({type:"REMOVE_MEMBER",payload:{userId:e,lockboxes:t}})};memberWasRemoved=e=>Ch(this.state,e);roles(e=ae){return e===ae?this.state.roles:Kh(this.state,e)}memberHasRole=(e,t)=>ki(this.state,e,t);memberIsAdmin=e=>He(this.state,e);hasRole=e=>Ah(this.state,e);membersInRole=e=>Ai(this.state,e);admins=()=>Dh(this.state);addRole=e=>{typeof e=="string"&&(e={roleName:e});const t=G({type:k.ROLE,name:e.roleName},this.seed),n=C(t,this.adminKeys());this.dispatch({type:"ADD_ROLE",payload:{...e,lockboxes:[n]}})};removeRole=e=>{b(e!==D,"Cannot remove admin role"),this.dispatch({type:"REMOVE_ROLE",payload:{roleName:e}})};addMemberRole=(e,t)=>{const n=this.members(e),s=C(this.roleKeys(t),n.keys);this.dispatch({type:"ADD_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:[s]}})};removeMemberRole=(e,t)=>{if(t===D){const s=this.membersInRole(D).length;b(s>1,"Can't remove the last admin")}const n=this.rotateKeys({type:k.ROLE,name:t});this.dispatch({type:"REMOVE_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:n}})};hasDevice=(e,t)=>Ei(this.state,e,t);device(e,t){return ft(this.state,e,t)}removeDevice=e=>{if(!this.hasDevice(e))throw new Error(`Device ${e} not found`);const t=this.rotateKeys({type:Mt,name:e});this.dispatch({type:"REMOVE_DEVICE",payload:{deviceId:e,lockboxes:t}})};deviceWasRemoved=e=>kh(this.state,e);memberByDeviceId=(e,t)=>Mi(this.state,e,t);verifyIdentityProof=(e,t)=>{b(e.type===Mt);const n=e.name,s=this.hasServer(n)?this.servers(n):this.device(n,{includeRemoved:!0});return nl(e,t,s.keys).isValid};inviteMember({seed:e=Pt(),expiration:t,maxUses:n}={}){e=Oe(e);const s=Bt({seed:e,expiration:t,maxUses:n}),{id:r}=s;return this.dispatch({type:"INVITE_MEMBER",payload:{invitation:s}}),{id:r,seed:e}}inviteDevice({seed:e=Pt(),expiration:t=Date.now()+30*60*1e3}={}){b(!this.isServer,"Servers can't invite a device"),e=Oe(e);const s=Bt({seed:e,expiration:t,maxUses:1,userId:this.userId}),r=De(e),o=Object.values(this.userKeyring()).map(c=>C(c,r)),{id:a}=s;return this.dispatch({type:"INVITE_DEVICE",payload:{invitation:s,lockboxes:o}}),{id:a,seed:e}}revokeInvitation=e=>{this.dispatch({type:"REVOKE_INVITATION",payload:{id:e}})};hasInvitation(e){return An(this.state,e)}getInvitation=e=>wn(this.state,e);validateInvitation=e=>{const{id:t}=e;if(!this.hasInvitation(t))return j("This invitation code doesn't match.");const n=this.getInvitation(t),s=On(n,Date.now());return s!==w?s:Oi(e,n)};validateUser=(e,t)=>this.members().find(r=>r.userId===e)!==void 0?j("userId is not unique within the team."):this.members().find(r=>r.userName.toLowerCase()===t.toLowerCase())!==void 0?j("Username is not unique within the team."):w;admitMember=(e,t,n)=>{const s=this.validateInvitation(e);if(!s.isValid)throw s.error;const r=this.validateUser(t.name,n);if(!r.isValid)throw r.error;const{id:i}=e,a=Object.values(this.teamKeyring()).map(c=>C(c,t));this.dispatch({type:"ADMIT_MEMBER",payload:{id:i,userName:n,memberKeys:F(t),lockboxes:a}})};admitDevice=(e,t)=>{const n=this.validateInvitation(e);if(!n.isValid)throw n.error;const{id:s}=e,i=this.getInvitation(s).userId,o={...t,userId:i};this.dispatch({type:"ADMIT_DEVICE",payload:{id:s,device:o}})};join=(e,t=re(this.context.user.keys))=>{b(!this.isServer,"Can't join as member on server");const{device:n}=this.context,s=Ot(e),r=Object.values(t).map(i=>C(i,n.keys));this.dispatch({type:"ADD_DEVICE",payload:{device:xe(n),lockboxes:r}},s)};addServer=e=>{const t=this.createMemberLockboxes(Te.toMember(e));this.dispatch({type:"ADD_SERVER",payload:{server:e,lockboxes:t}})};removeServer=e=>{this.dispatch({type:"REMOVE_SERVER",payload:{host:e}})};servers(e=ae,t={includeRemoved:!0}){return e===ae?this.state.servers:Mn(this.state,e,t)}serverWasRemoved=e=>$h(this.state,e);hasServer=e=>kn(this.state,e);addMessage=e=>{this.dispatch({type:"MESSAGE",payload:{message:e}})};messages=()=>Nh(this.state);encrypt=(e,t)=>{const n=t?{type:k.ROLE,name:t}:Qe,{secretKey:s,generation:r}=this.keys(n);return{contents:Ue.encryptBytes(e,s),recipient:{...n,generation:r}}};decrypt=e=>{const{secretKey:t}=this.keys(e.recipient);return Ue.decryptBytes(e.contents,t)};sign=e=>{b(this.context.user);const{keys:{type:t,name:n,generation:s,signature:{secretKey:r}}}=this.context.user;return{contents:e,signature:ne.sign(e,r),author:{type:t,name:n,generation:s}}};verify=e=>ne.verify({payload:e.contents,signature:e.signature,publicKey:this.members(e.author.name).keys.signature});keys=e=>Ti(this.state,this.context.device.keys,e);userKeyring=(e=this.userId)=>Rn(this.state,{type:$e,name:e},this.context.device.keys);roleKeys=(e,t)=>this.keys({type:k.ROLE,name:e,generation:t});teamKeys=e=>this.keys({...Qe,generation:e});teamKeyring=()=>Bh(this.state,this.context.device.keys);adminKeys=e=>this.roleKeys(D,e);changeKeys=e=>{const{device:t,user:n}=this.context,{type:s}=e;b(s!==Mt,"Can't change device keys");const r=s===$e,i=s===k.SERVER,o=n.keys;e.generation=o.generation+1;const a=this.rotateKeys(e),c=r?"CHANGE_MEMBER_KEYS":"CHANGE_SERVER_KEYS",u=F(e);this.dispatch({type:c,payload:{keys:u,lockboxes:a}}),(i||r)&&(n.keys=e),i&&(t.keys=e)};updateUserKeys(){const{user:e}=this.context,t=Ot(this.userKeyring());t&&e.keys.generation<t.generation&&(e.keys=t)}checkForPendingKeyRotations(){if(this.memberIsAdmin(this.userId))for(const e of this.state.pendingKeyRotations){const t=this.rotateKeys({type:$e,name:this.userId});this.dispatch({type:"ROTATE_KEYS",payload:{userId:e,lockboxes:t}})}}createMemberLockboxes=e=>{const t=e.roles.map(this.roleKeys),n=s=>C(s,e.keys);return[...t,this.teamKeys()].map(n)};rotateKeys=e=>{const t=dt(e)?e:G(e),s=wi(this.state,e).map(o=>G(o)),r=[t,...s];return r.flatMap(o=>xh(this.state,o).map(c=>{const u=r.find(l=>pi(l,c.recipient));return Rh({oldLockbox:c,newContents:o,updatedRecipientKeys:u?F(u):void 0})}))}};function kl(e,t,n){const s=G(Qe,n);return new xn({teamName:e,context:t,teamKeys:s})}var cl=({encryptedGraph:e,teamKeys:t,deviceKeys:n})=>{const s=re(t),{encryptedLinks:r,childMap:i,root:o}=e,a=e.links??{},c=(h,f,p={},v=Se)=>{const m=r[h],M=a[h]??Nr(m,f);let R={[h]:M};const $=et(v,M);let X;try{X=Ti($,n,Qe),s[X.encryption.publicKey]=X}catch{X=f}const Ne=i[h];if(Ne)for(const vt of Ne)R={...R,...c(vt,X,R,$)};return{...p,...R}},u=r[o].recipientPublicKey,l=s[u],d=c(o,l);return{...e,links:d}},Al=(e,t,n)=>{const s=re(n);return new xn({source:e,context:t,teamKeyring:s})},Ci=e=>{if(e===void 0)return"DONE";const{head:t,links:n,need:s}=e,r={head:t};return n&&(r.links=Object.keys(n).join(", ")),s&&(r.need=s.join(", ")),As(JSON.stringify(r))},Ee=tt.extend("message-queue"),dl=class extends it{#e=!1;#t={};#r=0;#n={};#a;#i={};#s=0;#o;constructor({sendMessage:e,timeout:t=1e3}){super(),this.#o=n=>{this.#s=n.index+1,e(n)},this.#a=t}start(){return this.#e=!0,this.#c(),this.#d(),this}stop(){return this.#e=!1,this}send(e){const t=Ms(this.#i)+1,n={...e,index:t};return this.#i[t]=n,Ee("send %o",n),this.#e&&this.#o(n),this}resend(e){const t=this.#i[e];if(!t)throw new Error(`Received resend request for message #${e}, which doesn't exist.`);return Ee("resend %o",t),this.#o(t),this}receive(e){const{index:t}=e;return Ee("receive %o",e),this.#t[t]||(this.#t[t]=e,this.#e&&this.#c()),this}#d(){for(Ee("processOutbound");this.#i[this.#s];){const e=this.#i[this.#s];this.#o(e)}}#c(){for(Ee("processInbound");this.#t[this.#r];){const t=this.#t[this.#r];this.#r++,this.emit("message",t)}const e=Ms(this.#t);for(let t=this.#r;t<e;t++)this.#n[t]||(this.#n[t]=setTimeout(()=>{this.#t[t]||this.emit("request",t),delete this.#n[t]},this.#a))}};function Ms(e){return Math.max(...Object.keys(e).map(Number),-1)}var ul=e=>e.type==="SYNC"?`SYNC ${Ci(e.payload)}`:`${e.type} ${e.payload?.head?.slice(0,5)||e.payload?.message||""}`,hl=e=>typeof e=="string",Di=e=>hl(e)?e:Object.keys(e).map(t=>`${t}:${Di(e[t])}`).filter(t=>t.length).join(","),ll=e=>{const{keys:t,host:n}=e.server;return{...e,user:{userId:n,userName:n,keys:t},device:{userId:n,deviceId:n,deviceName:n,keys:t}}},fl=e=>"server"in e?e.server.host:"userName"in e?e.userName:"user"in e?e.user.userName:"",Ni=e=>"team"in e&&e.team!==void 0,pt=e=>"invitationSeed"in e&&e.invitationSeed!==void 0,Ln=e=>pt(e)&&"user"in e&&e.user!==void 0,Ki=e=>pt(e)&&!Ln(e),$i=e=>"server"in e&&e.server!==void 0,Vt=e=>"deviceId"in e&&e.deviceId!==void 0,Bi=e=>he(e)&&"userKeys"in e&&e.userKeys!==void 0,yl=e=>he(e)&&!("userKeys"in e),he=e=>"proofOfInvitation"in e&&e.proofOfInvitation!==void 0,pl=class extends it{#e;#t;#r=!1;#n=tt.extend("auth:connection");constructor({sendMessage:e,context:t}){super(),this.#t=this.#a(e),this.#n=this.#n.extend(fl(t));const n=$i(t)?ll(t):t,s=$u({types:{context:{},events:{}},actions:{requestIdentityClaim:()=>{this.#s("REQUEST_IDENTITY")},sendIdentityClaim:L(({context:r})=>{const o=(a=>{if(Ni(a))return{deviceId:a.device.deviceId};if(Ln(a)){b(a.invitationSeed);const{userName:c,keys:u}=a.user;return{proofOfInvitation:_e(a.invitationSeed),userName:c,userKeys:F(u),device:xe(a.device)}}if(Ki(a)){b(a.invitationSeed);const{userName:c,device:u}=a;return{proofOfInvitation:_e(a.invitationSeed),userName:c,device:xe(u)}}throw new Error("Invalid context")})(r);return this.#s("CLAIM_IDENTITY",o),{ourIdentityClaim:o}}),receiveIdentityClaim:L(({event:r})=>{K(r,"CLAIM_IDENTITY");const i=r.payload,o="device"in i?i.device:void 0;return{theirIdentityClaim:i,theirDevice:o}}),acceptInvitation:L(({context:r})=>{const{team:i,theirIdentityClaim:o}=r;b(i),b(o),b(he(o));const{proofOfInvitation:a}=o,u=(()=>{if(Bi(o)){const{userName:l,userKeys:d}=o;i.admitMember(a,d,l);const h=d.name;return i.members(h)}else{const{device:l}=o;i.admitDevice(a,l);const{deviceId:d}=l,{userId:h}=i.memberByDeviceId(d);return i.members(h)}})();return this.#s("ACCEPT_INVITATION",{serializedGraph:i.save(),teamKeyring:i.teamKeyring()}),{peer:u}}),joinTeam:L(({context:r,event:i})=>{K(i,"ACCEPT_INVITATION");const{serializedGraph:o,teamKeyring:a}=i.payload,{device:c,invitationSeed:u}=r;b(u);const{user:l,userKeyring:d}=r.user===void 0?Qh({serializedGraph:o,teamKeyring:a,invitationSeed:u}):{user:r.user,userKeyring:void 0},h=new xn({source:o,context:{user:l,device:c},teamKeyring:a});return h.join(a,d),this.emit("joined",{team:h,user:l,teamKeyring:a}),{user:l,team:h}}),challengeIdentity:L(({context:r})=>{const{team:i,theirIdentityClaim:o}=r;b(i),b(Vt(o));const{deviceId:a}=o,c=i.device(a,{includeRemoved:!0}),u=i.memberByDeviceId(a,{includeRemoved:!0});this.#n=this.#n.extend(u.userName);const l=el({type:k.DEVICE,name:a});return this.#s("CHALLENGE_IDENTITY",{challenge:l}),{theirDevice:c,peer:u,challenge:l}}),proveIdentity:({context:r,event:i})=>{K(i,"CHALLENGE_IDENTITY");const{challenge:o}=i.payload,{keys:a}=r.device,c=tl(o,a);this.#s("PROVE_IDENTITY",{challenge:o,proof:c})},acceptIdentity:()=>this.#s("ACCEPT_IDENTITY"),listenForTeamUpdates:({context:r})=>{b(r.team),r.team.on("updated",({head:i})=>{this.#e.getSnapshot().status!=="done"&&this.#e.send({type:"LOCAL_UPDATE",payload:{head:i}}),this.emit("updated")})},sendSyncMessage:L(({context:r})=>{b(r.team);const i=r.syncState??Qn(),[o,a]=Rd(r.team.graph,i);return a?(this.#n("sending sync message",Ci(a)),this.#s("SYNC",a)):this.#n("no sync message to send"),{syncState:o}}),receiveSyncMessage:L(({context:r,event:i})=>{K(i,"SYNC");const o=i.payload,{syncState:a=Qn(),team:c,device:u}=r;b(c);const l=c.teamKeys(),d=u.keys,h=({encryptedGraph:v,keys:m})=>cl({encryptedGraph:v,teamKeys:m,deviceKeys:d}),[f,p]=Od(c.graph,a,o,l,h);return Pe(f.head,c.graph.head)?{syncState:p}:(this.emit("updated"),{team:c.merge(f),syncState:p})}),sendSeed:L(({context:r})=>{const{user:i,peer:o,seed:a=Gi()}=r,c=o.keys.encryption,u=i.keys.encryption.secretKey;this.#n(`encrypting seed with key ${c}`);const l=W.encryptBytes({secret:a,recipientPublicKey:c,senderSecretKey:u});return this.#s("SEED",{encryptedSeed:l}),{seed:a}}),deriveSharedKey:L(({context:r,event:i})=>{K(i,"SEED");const{encryptedSeed:o}=i.payload,{seed:a,user:c,peer:u}=r,l=o,d=u.keys.encryption,h=c.keys.encryption.secretKey;try{const f=W.decryptBytes({cipher:l,senderPublicKey:d,recipientSecretKey:h});return{sessionKey:dh(a,f)}}catch(f){if(String(f).includes("incorrect key pair"))return this.#n(`failed to decrypt seed using public key ${d}`,f),this.#i(Ze);throw f}}),receiveEncryptedMessage:({context:r,event:i})=>{K(i,"ENCRYPTED_MESSAGE");const o=r.sessionKey,a=i.payload;try{const c=Ue.decryptBytes(a,o);this.emit("message",c)}catch(c){if(String(c).includes("wrong secret key"))return this.#n(`failed to decrypt message using session key ${je.encode(o)}`,c),this.#i(Ze);throw c}},fail:L((r,{error:i})=>this.#i(i)),receiveError:L(({event:r})=>{K(r,"ERROR");const i=r.payload;return this.#n("receiveError: %o",i),this.emit("remoteError",i),{error:i}}),sendError:L(({event:r})=>{K(r,"LOCAL_ERROR");const i=r.payload;return this.#n("sendError %o",i),this.#t.send($t(i.type,"REMOTE")),this.emit("localError",i),{error:i}}),onConnected:()=>this.emit("connected"),onDisconnected:({event:r})=>this.emit("disconnected",r)},guards:{theySentIdentityClaim:({context:r})=>r.theirIdentityClaim!==void 0,weSentIdentityClaim:({context:r})=>r.ourIdentityClaim!==void 0,bothSentIdentityClaim:is(["theySentIdentityClaim","weSentIdentityClaim"]),weHaveInvitation:({context:r})=>pt(r),theyHaveInvitation:({context:r})=>he(r.theirIdentityClaim),neitherIsMember:is(["weHaveInvitation","theyHaveInvitation"]),invitationIsValid:({context:r})=>{const{team:i,theirIdentityClaim:o}=r;return b(he(o)),i.validateInvitation(o.proofOfInvitation).isValid},joinedTheRightTeam:({context:r,event:i})=>{K(i,"ACCEPT_INVITATION");const o=r.invitationSeed,{serializedGraph:a,teamKeyring:c}=i.payload,u=Li(a,c),{id:l}=_e(o);return An(u,l)},deviceUnknown:({context:r})=>{const{theirIdentityClaim:i}=r;return b(Vt(i)),!r.team.hasDevice(i.deviceId,{includeRemoved:!0})},identityIsValid:({context:r,event:i})=>{K(i,"PROVE_IDENTITY");const{challenge:o,proof:a}=i.payload;return r.team.verifyIdentityProof(o,a)},memberWasRemoved:({context:r})=>r.team.memberWasRemoved(r.peer.userId),deviceWasRemoved:({context:r})=>r.team.deviceWasRemoved(r.theirDevice.deviceId),serverWasRemoved:({context:r})=>r.team.serverWasRemoved(r.peer.userId),headsAreEqual:({context:r})=>ai(r.team.graph.head,r.syncState?.lastCommonHead)}}).createMachine({context:n,id:"connection",entry:"requestIdentityClaim",initial:"awaitingIdentityClaim",on:{REQUEST_IDENTITY:{actions:"sendIdentityClaim",target:".awaitingIdentityClaim"},ERROR:{actions:"receiveError",target:"#disconnected"},LOCAL_ERROR:{actions:"sendError",target:"#disconnected"}},states:{awaitingIdentityClaim:{always:{guard:"bothSentIdentityClaim",target:"authenticating"},on:{CLAIM_IDENTITY:{actions:"receiveIdentityClaim"}}},authenticating:{initial:"checkingInvitations",states:{checkingInvitations:{always:[{guard:"neitherIsMember",...P(bn)},{guard:"weHaveInvitation",target:"awaitingInvitationAcceptance"},{guard:"theyHaveInvitation",target:"validatingInvitation"},{target:"#checkingIdentity"}]},awaitingInvitationAcceptance:{on:{ACCEPT_INVITATION:[{guard:"joinedTheRightTeam",actions:"joinTeam",target:"#checkingIdentity"},P(gn)]},...be},validatingInvitation:{always:[{guard:"invitationIsValid",actions:"acceptInvitation",target:"#checkingIdentity"},P(mn)]},checkingIdentity:{id:"checkingIdentity",type:"parallel",states:{provingMyIdentity:{initial:"awaitingIdentityChallenge",states:{awaitingIdentityChallenge:{always:{guard:"weHaveInvitation",target:"done"},on:{CHALLENGE_IDENTITY:{actions:"proveIdentity",target:"awaitingIdentityAcceptance"}},...be},awaitingIdentityAcceptance:{on:{ACCEPT_IDENTITY:{target:"done"}},...be},done:{type:"final"}}},verifyingTheirIdentity:{initial:"challengingIdentity",states:{challengingIdentity:{always:[{guard:"theyHaveInvitation",target:"done"},{guard:"deviceUnknown",...P(pn)},{actions:"challengeIdentity",target:"awaitingIdentityProof"}]},awaitingIdentityProof:{on:{PROVE_IDENTITY:[{guard:"identityIsValid",actions:"acceptIdentity",target:"done"},P(vn)]},...be},done:{type:"final"}}}},onDone:{target:"done"}},done:{type:"final"}},onDone:{target:"#negotiating"}},negotiating:{id:"negotiating",entry:"sendSeed",on:{SEED:{actions:"deriveSharedKey",target:"synchronizing"}},...be},synchronizing:{entry:"sendSyncMessage",always:{guard:"headsAreEqual",target:"connected"},on:{SYNC:{actions:["receiveSyncMessage","sendSyncMessage"]}}},connected:{id:"connected",entry:["onConnected","listenForTeamUpdates"],always:[{guard:"memberWasRemoved",...P(En)},{guard:"deviceWasRemoved",...P(yn)},{guard:"serverWasRemoved",...P(In)}],on:{LOCAL_UPDATE:{actions:"sendSyncMessage"},SYNC:{actions:["receiveSyncMessage","sendSyncMessage"]},ENCRYPTED_MESSAGE:{actions:"receiveEncryptedMessage"},DISCONNECT:"#disconnected"}},disconnected:{id:"disconnected",always:{actions:"onDisconnected"}}}});this.#e=Re(s),this.#e.subscribe({next:r=>{const i=Di(r.value);this.emit("change",i),this.#n(`⏩ ${i} `)},error:r=>{console.error("Connection encountered an unhandled error",r),this.#i(Sn)}}),this.emit=(r,...i)=>(this.#n(`emit ${r} %o`,...i),super.emit(r,...i))}start=(e=[])=>{this.#n("starting"),this.#e.start(),this.#t.start(),this.#r=!0;for(const t of e)this.deliver(t);return this};stop=()=>{if(this.#r&&this.#e.getSnapshot().status!=="done"){const e={type:"DISCONNECT"};this.#e.send(e),this.#t.send(e)}return this.removeAllListeners(),this.#t.stop(),this.#n("connection stopped"),this};deliver(e){const t=Ut(e);this.#t.receive(t)}send=e=>{b(this._sessionKey,"Can't send encrypted messages until we've finished connecting");const t=Ue.encryptBytes(e,this._sessionKey);this.#n(`encrypted message with session key ${je.encode(this._sessionKey)}`),this.#s("ENCRYPTED_MESSAGE",t)};get state(){return b(this.#r),this.#e.getSnapshot().value}get team(){return this._context.team}get _sessionKey(){return this._context.sessionKey}get _context(){return b(this.#r),this.#e.getSnapshot().context}#a(e){return new dl({sendMessage:t=>{this.#o("out",t);const n=Ht(t);e(n)}}).on("message",t=>{if(this.#o("in",t),t.type==="REQUEST_RESEND"){const{index:n}=t.payload;this.#t.resend(n)}else this.#e.send(t)}).on("request",t=>{this.#s("REQUEST_RESEND",{index:t})})}#i(e){this.#n("error: %o",e);const t=$t(e,"LOCAL");return this.#e.send(t),{error:t.payload}}#s(e,t){this.#t.send({type:e,payload:t})}#o(e,t){const n=e==="in"?"<-":"->",s=this.#r?this._context.peer?.userName??"?":"?";this.#n(`${n}${s} #${t.index} ${ul(t)}`)}},P=e=>({actions:[{type:"fail",params:{error:e}},"onDisconnected"],target:"#disconnected"}),vl=7e3,be={after:{[vl]:P(_n)}};export{D as ADMIN,ph as ADMIN_SCOPE,ae as ALL,pl as Connection,sh as DEVICE_ID,Zu as ENCRYPTION,Ml as EPHEMERAL_SCOPE,yi as HashPurpose,nh as INVITATION,eh as LINK_HASH,th as LINK_TO_PREVIOUS,rh as SHARED_KEY,Xu as SIGNATURE,Qu as SYMMETRIC,Qe as TEAM_SCOPE,xn as Team,w as VALID,W as asymmetric,Te as castServer,Pu as connection,ol as createDevice,G as createKeyset,kl as createTeam,Sl as createUser,il as device,_e as generateProof,Tl as graphSummary,Se as initialState,Fh as invitation,Al as loadTeam,xe as redactDevice,F as redactKeys,xd as redactUser,Vu as role,ne as signatures,Ue as symmetric};
//# sourceMappingURL=index-C109o94f.js.map

var ny=Object.defineProperty;var ry=(_,P,F)=>P in _?ny(_,P,{enumerable:!0,configurable:!0,writable:!0,value:F}):_[P]=F;var b=(_,P,F)=>(ry(_,typeof P!="symbol"?P+"":P,F),F),Ci=(_,P,F)=>{if(!P.has(_))throw TypeError("Cannot "+F)};var B=(_,P,F)=>(Ci(_,P,"read from private field"),F?F.call(_):P.get(_)),st=(_,P,F)=>{if(P.has(_))throw TypeError("Cannot add the same private member more than once");P instanceof WeakSet?P.add(_):P.set(_,F)},jt=(_,P,F,tt)=>(Ci(_,P,"write to private field"),tt?tt.call(_,F):P.set(_,F),F);var du=(_,P,F,tt)=>({set _(Fn){jt(_,P,Fn,F)},get _(){return B(_,P,tt)}}),Pn=(_,P,F)=>(Ci(_,P,"access private method"),F);import{b as Be,S as oe,g as He,r as Dt,i as Bn,e as hu,a as iy,f as oy,m as sy,L as Vi,M as Hn,c as lu,t as se,d as yt,s as fu,h as xt,j as St,k as vt,l as ae,p as Ki,u as Pi,n as Un,o as Ue,q as pu,v as ay,w as yu,x as cy,__tla as uy}from"./index-3tibyKMx.js";import{x as dy,a1 as hy,e as vu,G as $n,H as mu,__tla as ly}from"./index-aicZefrG.js";import{__tla as fy}from"./path-wXZ93Fmk.js";import{__tla as py}from"./browser-ntcpwhPk.js";let et,Bi,kt,Hi,Ui,$i,gu,Yn,Yi,Gi,Fi,zi,Wi,Ji,ce,$e,Z,Lt,qi,Qi,lt,bu,Eu,Xi,Gn,Iu,Ct,Zi,_u,Vt,ft,to,eo,yy=Promise.all([(()=>{try{return uy}catch{}})(),(()=>{try{return ly}catch{}})(),(()=>{try{return fy}catch{}})(),(()=>{try{return py}catch{}})()]).then(async()=>{var At,pt,Rt,te,Ke,_t,ee,Nt,Kn,wu,Pe,no,cu;function _(t,e="Assertion failed"){if(t===!1||t===null||t===void 0){const n=new Error(P(e));throw n.stack=F(n.stack,"assert.js"),n}}const P=t=>t.split(`
`).map(e=>e.trim()).join(`
`),F=(t="",e)=>t.split(`
`).filter(n=>!n.includes(e)).join(`
`);function tt(t){return t!=null&&typeof t=="object"}var Fn="[object Symbol]";function zn(t){return typeof t=="symbol"||tt(t)&&Be(t)==Fn}function xu(t,e){for(var n=-1,r=t==null?0:t.length,i=Array(r);++n<r;)i[n]=e(t[n],n,t);return i}var at=Array.isArray,Su=1/0,ro=oe?oe.prototype:void 0,io=ro?ro.toString:void 0;function oo(t){if(typeof t=="string")return t;if(at(t))return xu(t,oo)+"";if(zn(t))return io?io.call(t):"";var e=t+"";return e=="0"&&1/t==-Su?"-0":e}function ku(t){return t}var Wn=He(Dt,"WeakMap"),so=Object.create,Ou=function(){function t(){}return function(e){if(!Bn(e))return{};if(so)return so(e);t.prototype=e;var n=new t;return t.prototype=void 0,n}}();function Mu(){}function Au(t,e){var n=-1,r=t.length;for(e||(e=Array(r));++n<r;)e[n]=t[n];return e}var ao=function(){try{var t=He(Object,"defineProperty");return t({},"",{}),t}catch{}}();function Ru(t,e){for(var n=-1,r=t==null?0:t.length;++n<r&&e(t[n],n,t)!==!1;);return t}function Nu(t,e,n,r){for(var i=t.length,o=n+(r?1:-1);r?o--:++o<i;)if(e(t[o],o,t))return o;return-1}function Tu(t){return t!==t}function ju(t,e,n){for(var r=n-1,i=t.length;++r<i;)if(t[r]===e)return r;return-1}function Du(t,e,n){return e===e?ju(t,e,n):Nu(t,Tu,n)}function Lu(t,e){var n=t==null?0:t.length;return!!n&&Du(t,e,0)>-1}var Cu=9007199254740991,Vu=/^(?:0|[1-9]\d*)$/;function co(t,e){var n=typeof t;return e=e??Cu,!!e&&(n=="number"||n!="symbol"&&Vu.test(t))&&t>-1&&t%1==0&&t<e}function uo(t,e,n){e=="__proto__"&&ao?ao(t,e,{configurable:!0,enumerable:!0,value:n,writable:!0}):t[e]=n}var Ku=Object.prototype,Pu=Ku.hasOwnProperty;function ho(t,e,n){var r=t[e];(!(Pu.call(t,e)&&hu(r,n))||n===void 0&&!(e in t))&&uo(t,e,n)}function Ye(t,e,n,r){var i=!n;n||(n={});for(var o=-1,s=e.length;++o<s;){var a=e[o],c=r?r(n[a],t[a],a,n,t):void 0;c===void 0&&(c=t[a]),i?uo(n,a,c):ho(n,a,c)}return n}var Bu=9007199254740991;function Jn(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=Bu}function lo(t){return t!=null&&Jn(t.length)&&!iy(t)}var Hu=Object.prototype;function qn(t){var e=t&&t.constructor,n=typeof e=="function"&&e.prototype||Hu;return t===n}function Uu(t,e){for(var n=-1,r=Array(t);++n<t;)r[n]=e(n);return r}var $u="[object Arguments]";function fo(t){return tt(t)&&Be(t)==$u}var po=Object.prototype,Yu=po.hasOwnProperty,Gu=po.propertyIsEnumerable,yo=fo(function(){return arguments}())?fo:function(t){return tt(t)&&Yu.call(t,"callee")&&!Gu.call(t,"callee")};function Fu(){return!1}var vo=typeof exports=="object"&&exports&&!exports.nodeType&&exports,mo=vo&&typeof module=="object"&&module&&!module.nodeType&&module,zu=mo&&mo.exports===vo,go=zu?Dt.Buffer:void 0,Wu=go?go.isBuffer:void 0,Ge=Wu||Fu,Ju="[object Arguments]",qu="[object Array]",Qu="[object Boolean]",Xu="[object Date]",Zu="[object Error]",td="[object Function]",ed="[object Map]",nd="[object Number]",rd="[object Object]",id="[object RegExp]",od="[object Set]",sd="[object String]",ad="[object WeakMap]",cd="[object ArrayBuffer]",ud="[object DataView]",dd="[object Float32Array]",hd="[object Float64Array]",ld="[object Int8Array]",fd="[object Int16Array]",pd="[object Int32Array]",yd="[object Uint8Array]",vd="[object Uint8ClampedArray]",md="[object Uint16Array]",gd="[object Uint32Array]",$={};$[dd]=$[hd]=$[ld]=$[fd]=$[pd]=$[yd]=$[vd]=$[md]=$[gd]=!0,$[Ju]=$[qu]=$[cd]=$[Qu]=$[ud]=$[Xu]=$[Zu]=$[td]=$[ed]=$[nd]=$[rd]=$[id]=$[od]=$[sd]=$[ad]=!1;function bd(t){return tt(t)&&Jn(t.length)&&!!$[Be(t)]}function Qn(t){return function(e){return t(e)}}var bo=typeof exports=="object"&&exports&&!exports.nodeType&&exports,ue=bo&&typeof module=="object"&&module&&!module.nodeType&&module,Ed=ue&&ue.exports===bo,Xn=Ed&&oy.process,Kt=function(){try{var t=ue&&ue.require&&ue.require("util").types;return t||Xn&&Xn.binding&&Xn.binding("util")}catch{}}(),Eo=Kt&&Kt.isTypedArray,Io=Eo?Qn(Eo):bd,Id=Object.prototype,_d=Id.hasOwnProperty;function _o(t,e){var n=at(t),r=!n&&yo(t),i=!n&&!r&&Ge(t),o=!n&&!r&&!i&&Io(t),s=n||r||i||o,a=s?Uu(t.length,String):[],c=a.length;for(var u in t)(e||_d.call(t,u))&&!(s&&(u=="length"||i&&(u=="offset"||u=="parent")||o&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||co(u,c)))&&a.push(u);return a}function wo(t,e){return function(n){return t(e(n))}}var wd=wo(Object.keys,Object),xd=Object.prototype,Sd=xd.hasOwnProperty;function kd(t){if(!qn(t))return wd(t);var e=[];for(var n in Object(t))Sd.call(t,n)&&n!="constructor"&&e.push(n);return e}function Fe(t){return lo(t)?_o(t):kd(t)}function Od(t){var e=[];if(t!=null)for(var n in Object(t))e.push(n);return e}var Md=Object.prototype,Ad=Md.hasOwnProperty;function Rd(t){if(!Bn(t))return Od(t);var e=qn(t),n=[];for(var r in t)r=="constructor"&&(e||!Ad.call(t,r))||n.push(r);return n}function Zn(t){return lo(t)?_o(t,!0):Rd(t)}var Nd=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Td=/^\w*$/;function tr(t,e){if(at(t))return!1;var n=typeof t;return n=="number"||n=="symbol"||n=="boolean"||t==null||zn(t)?!0:Td.test(t)||!Nd.test(t)||e!=null&&t in Object(e)}var jd=500;function Dd(t){var e=sy(t,function(r){return n.size===jd&&n.clear(),r}),n=e.cache;return e}var Ld=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Cd=/\\(\\)?/g,Vd=Dd(function(t){var e=[];return t.charCodeAt(0)===46&&e.push(""),t.replace(Ld,function(n,r,i,o){e.push(i?o.replace(Cd,"$1"):r||n)}),e});function Kd(t){return t==null?"":oo(t)}function xo(t,e){return at(t)?t:tr(t,e)?[t]:Vd(Kd(t))}var Pd=1/0;function ze(t){if(typeof t=="string"||zn(t))return t;var e=t+"";return e=="0"&&1/t==-Pd?"-0":e}function So(t,e){e=xo(e,t);for(var n=0,r=e.length;t!=null&&n<r;)t=t[ze(e[n++])];return n&&n==r?t:void 0}function Bd(t,e,n){var r=t==null?void 0:So(t,e);return r===void 0?n:r}function ko(t,e){for(var n=-1,r=e.length,i=t.length;++n<r;)t[i+n]=e[n];return t}var Hd=wo(Object.getPrototypeOf,Object);const Oo=Hd;function Ud(){this.__data__=new Vi,this.size=0}function $d(t){var e=this.__data__,n=e.delete(t);return this.size=e.size,n}function Yd(t){return this.__data__.get(t)}function Gd(t){return this.__data__.has(t)}var Fd=200;function zd(t,e){var n=this.__data__;if(n instanceof Vi){var r=n.__data__;if(!Hn||r.length<Fd-1)return r.push([t,e]),this.size=++n.size,this;n=this.__data__=new lu(r)}return n.set(t,e),this.size=n.size,this}function ct(t){var e=this.__data__=new Vi(t);this.size=e.size}ct.prototype.clear=Ud,ct.prototype.delete=$d,ct.prototype.get=Yd,ct.prototype.has=Gd,ct.prototype.set=zd;function Wd(t,e){return t&&Ye(e,Fe(e),t)}function Jd(t,e){return t&&Ye(e,Zn(e),t)}var Mo=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Ao=Mo&&typeof module=="object"&&module&&!module.nodeType&&module,qd=Ao&&Ao.exports===Mo,Ro=qd?Dt.Buffer:void 0,No=Ro?Ro.allocUnsafe:void 0;function Qd(t,e){if(e)return t.slice();var n=t.length,r=No?No(n):new t.constructor(n);return t.copy(r),r}function Xd(t,e){for(var n=-1,r=t==null?0:t.length,i=0,o=[];++n<r;){var s=t[n];e(s,n,t)&&(o[i++]=s)}return o}function To(){return[]}var Zd=Object.prototype,th=Zd.propertyIsEnumerable,jo=Object.getOwnPropertySymbols,er=jo?function(t){return t==null?[]:(t=Object(t),Xd(jo(t),function(e){return th.call(t,e)}))}:To;function eh(t,e){return Ye(t,er(t),e)}var nh=Object.getOwnPropertySymbols,Do=nh?function(t){for(var e=[];t;)ko(e,er(t)),t=Oo(t);return e}:To;function rh(t,e){return Ye(t,Do(t),e)}function Lo(t,e,n){var r=e(t);return at(t)?r:ko(r,n(t))}function nr(t){return Lo(t,Fe,er)}function ih(t){return Lo(t,Zn,Do)}var rr=He(Dt,"DataView"),ir=He(Dt,"Promise"),Pt=He(Dt,"Set"),Co="[object Map]",oh="[object Object]",Vo="[object Promise]",Ko="[object Set]",Po="[object WeakMap]",Bo="[object DataView]",sh=se(rr),ah=se(Hn),ch=se(ir),uh=se(Pt),dh=se(Wn),Ot=Be;(rr&&Ot(new rr(new ArrayBuffer(1)))!=Bo||Hn&&Ot(new Hn)!=Co||ir&&Ot(ir.resolve())!=Vo||Pt&&Ot(new Pt)!=Ko||Wn&&Ot(new Wn)!=Po)&&(Ot=function(t){var e=Be(t),n=e==oh?t.constructor:void 0,r=n?se(n):"";if(r)switch(r){case sh:return Bo;case ah:return Co;case ch:return Vo;case uh:return Ko;case dh:return Po}return e});const de=Ot;var hh=Object.prototype,lh=hh.hasOwnProperty;function fh(t){var e=t.length,n=new t.constructor(e);return e&&typeof t[0]=="string"&&lh.call(t,"index")&&(n.index=t.index,n.input=t.input),n}var We=Dt.Uint8Array;function or(t){var e=new t.constructor(t.byteLength);return new We(e).set(new We(t)),e}function ph(t,e){var n=e?or(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.byteLength)}var yh=/\w*$/;function vh(t){var e=new t.constructor(t.source,yh.exec(t));return e.lastIndex=t.lastIndex,e}var Ho=oe?oe.prototype:void 0,Uo=Ho?Ho.valueOf:void 0;function mh(t){return Uo?Object(Uo.call(t)):{}}function gh(t,e){var n=e?or(t.buffer):t.buffer;return new t.constructor(n,t.byteOffset,t.length)}var bh="[object Boolean]",Eh="[object Date]",Ih="[object Map]",_h="[object Number]",wh="[object RegExp]",xh="[object Set]",Sh="[object String]",kh="[object Symbol]",Oh="[object ArrayBuffer]",Mh="[object DataView]",Ah="[object Float32Array]",Rh="[object Float64Array]",Nh="[object Int8Array]",Th="[object Int16Array]",jh="[object Int32Array]",Dh="[object Uint8Array]",Lh="[object Uint8ClampedArray]",Ch="[object Uint16Array]",Vh="[object Uint32Array]";function Kh(t,e,n){var r=t.constructor;switch(e){case Oh:return or(t);case bh:case Eh:return new r(+t);case Mh:return ph(t,n);case Ah:case Rh:case Nh:case Th:case jh:case Dh:case Lh:case Ch:case Vh:return gh(t,n);case Ih:return new r;case _h:case Sh:return new r(t);case wh:return vh(t);case xh:return new r;case kh:return mh(t)}}function Ph(t){return typeof t.constructor=="function"&&!qn(t)?Ou(Oo(t)):{}}var Bh="[object Map]";function Hh(t){return tt(t)&&de(t)==Bh}var $o=Kt&&Kt.isMap,Uh=$o?Qn($o):Hh,$h="[object Set]";function Yh(t){return tt(t)&&de(t)==$h}var Yo=Kt&&Kt.isSet,Gh=Yo?Qn(Yo):Yh,Fh=1,zh=2,Wh=4,Go="[object Arguments]",Jh="[object Array]",qh="[object Boolean]",Qh="[object Date]",Xh="[object Error]",Fo="[object Function]",Zh="[object GeneratorFunction]",tl="[object Map]",el="[object Number]",zo="[object Object]",nl="[object RegExp]",rl="[object Set]",il="[object String]",ol="[object Symbol]",sl="[object WeakMap]",al="[object ArrayBuffer]",cl="[object DataView]",ul="[object Float32Array]",dl="[object Float64Array]",hl="[object Int8Array]",ll="[object Int16Array]",fl="[object Int32Array]",pl="[object Uint8Array]",yl="[object Uint8ClampedArray]",vl="[object Uint16Array]",ml="[object Uint32Array]",H={};H[Go]=H[Jh]=H[al]=H[cl]=H[qh]=H[Qh]=H[ul]=H[dl]=H[hl]=H[ll]=H[fl]=H[tl]=H[el]=H[zo]=H[nl]=H[rl]=H[il]=H[ol]=H[pl]=H[yl]=H[vl]=H[ml]=!0,H[Xh]=H[Fo]=H[sl]=!1;function Je(t,e,n,r,i,o){var s,a=e&Fh,c=e&zh,u=e&Wh;if(n&&(s=i?n(t,r,i,o):n(t)),s!==void 0)return s;if(!Bn(t))return t;var h=at(t);if(h){if(s=fh(t),!a)return Au(t,s)}else{var l=de(t),d=l==Fo||l==Zh;if(Ge(t))return Qd(t,a);if(l==zo||l==Go||d&&!i){if(s=c||d?{}:Ph(t),!a)return c?rh(t,Jd(s,t)):eh(t,Wd(s,t))}else{if(!H[l])return i?t:{};s=Kh(t,l,a)}}o||(o=new ct);var f=o.get(t);if(f)return f;o.set(t,s),Gh(t)?t.forEach(function(E){s.add(Je(E,e,n,E,t,o))}):Uh(t)&&t.forEach(function(E,m){s.set(m,Je(E,e,n,m,t,o))});var v=u?c?ih:nr:c?Zn:Fe,y=h?void 0:v(t);return Ru(y||t,function(E,m){y&&(m=E,E=t[m]),ho(s,m,Je(E,e,n,m,t,o))}),s}var gl=4;function bl(t){return Je(t,gl)}var El="__lodash_hash_undefined__";function Il(t){return this.__data__.set(t,El),this}function _l(t){return this.__data__.has(t)}function he(t){var e=-1,n=t==null?0:t.length;for(this.__data__=new lu;++e<n;)this.add(t[e])}he.prototype.add=he.prototype.push=Il,he.prototype.has=_l;function wl(t,e){for(var n=-1,r=t==null?0:t.length;++n<r;)if(e(t[n],n,t))return!0;return!1}function Wo(t,e){return t.has(e)}var xl=1,Sl=2;function Jo(t,e,n,r,i,o){var s=n&xl,a=t.length,c=e.length;if(a!=c&&!(s&&c>a))return!1;var u=o.get(t),h=o.get(e);if(u&&h)return u==e&&h==t;var l=-1,d=!0,f=n&Sl?new he:void 0;for(o.set(t,e),o.set(e,t);++l<a;){var v=t[l],y=e[l];if(r)var E=s?r(y,v,l,e,t,o):r(v,y,l,t,e,o);if(E!==void 0){if(E)continue;d=!1;break}if(f){if(!wl(e,function(m,I){if(!Wo(f,I)&&(v===m||i(v,m,n,r,o)))return f.push(I)})){d=!1;break}}else if(!(v===y||i(v,y,n,r,o))){d=!1;break}}return o.delete(t),o.delete(e),d}function kl(t){var e=-1,n=Array(t.size);return t.forEach(function(r,i){n[++e]=[i,r]}),n}function sr(t){var e=-1,n=Array(t.size);return t.forEach(function(r){n[++e]=r}),n}var Ol=1,Ml=2,Al="[object Boolean]",Rl="[object Date]",Nl="[object Error]",Tl="[object Map]",jl="[object Number]",Dl="[object RegExp]",Ll="[object Set]",Cl="[object String]",Vl="[object Symbol]",Kl="[object ArrayBuffer]",Pl="[object DataView]",qo=oe?oe.prototype:void 0,ar=qo?qo.valueOf:void 0;function Bl(t,e,n,r,i,o,s){switch(n){case Pl:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case Kl:return!(t.byteLength!=e.byteLength||!o(new We(t),new We(e)));case Al:case Rl:case jl:return hu(+t,+e);case Nl:return t.name==e.name&&t.message==e.message;case Dl:case Cl:return t==e+"";case Tl:var a=kl;case Ll:var c=r&Ol;if(a||(a=sr),t.size!=e.size&&!c)return!1;var u=s.get(t);if(u)return u==e;r|=Ml,s.set(t,e);var h=Jo(a(t),a(e),r,i,o,s);return s.delete(t),h;case Vl:if(ar)return ar.call(t)==ar.call(e)}return!1}var Hl=1,Ul=Object.prototype,$l=Ul.hasOwnProperty;function Yl(t,e,n,r,i,o){var s=n&Hl,a=nr(t),c=a.length,u=nr(e),h=u.length;if(c!=h&&!s)return!1;for(var l=c;l--;){var d=a[l];if(!(s?d in e:$l.call(e,d)))return!1}var f=o.get(t),v=o.get(e);if(f&&v)return f==e&&v==t;var y=!0;o.set(t,e),o.set(e,t);for(var E=s;++l<c;){d=a[l];var m=t[d],I=e[d];if(r)var x=s?r(I,m,d,e,t,o):r(m,I,d,t,e,o);if(!(x===void 0?m===I||i(m,I,n,r,o):x)){y=!1;break}E||(E=d=="constructor")}if(y&&!E){var k=t.constructor,A=e.constructor;k!=A&&"constructor"in t&&"constructor"in e&&!(typeof k=="function"&&k instanceof k&&typeof A=="function"&&A instanceof A)&&(y=!1)}return o.delete(t),o.delete(e),y}var Gl=1,Qo="[object Arguments]",Xo="[object Array]",qe="[object Object]",Fl=Object.prototype,Zo=Fl.hasOwnProperty;function zl(t,e,n,r,i,o){var s=at(t),a=at(e),c=s?Xo:de(t),u=a?Xo:de(e);c=c==Qo?qe:c,u=u==Qo?qe:u;var h=c==qe,l=u==qe,d=c==u;if(d&&Ge(t)){if(!Ge(e))return!1;s=!0,h=!1}if(d&&!h)return o||(o=new ct),s||Io(t)?Jo(t,e,n,r,i,o):Bl(t,e,c,n,r,i,o);if(!(n&Gl)){var f=h&&Zo.call(t,"__wrapped__"),v=l&&Zo.call(e,"__wrapped__");if(f||v){var y=f?t.value():t,E=v?e.value():e;return o||(o=new ct),i(y,E,n,r,o)}}return d?(o||(o=new ct),Yl(t,e,n,r,i,o)):!1}function cr(t,e,n,r,i){return t===e?!0:t==null||e==null||!tt(t)&&!tt(e)?t!==t&&e!==e:zl(t,e,n,r,cr,i)}var Wl=1,Jl=2;function ql(t,e,n,r){var i=n.length,o=i,s=!r;if(t==null)return!o;for(t=Object(t);i--;){var a=n[i];if(s&&a[2]?a[1]!==t[a[0]]:!(a[0]in t))return!1}for(;++i<o;){a=n[i];var c=a[0],u=t[c],h=a[1];if(s&&a[2]){if(u===void 0&&!(c in t))return!1}else{var l=new ct;if(r)var d=r(u,h,c,t,e,l);if(!(d===void 0?cr(h,u,Wl|Jl,r,l):d))return!1}}return!0}function ts(t){return t===t&&!Bn(t)}function Ql(t){for(var e=Fe(t),n=e.length;n--;){var r=e[n],i=t[r];e[n]=[r,i,ts(i)]}return e}function es(t,e){return function(n){return n==null?!1:n[t]===e&&(e!==void 0||t in Object(n))}}function Xl(t){var e=Ql(t);return e.length==1&&e[0][2]?es(e[0][0],e[0][1]):function(n){return n===t||ql(n,t,e)}}function Zl(t,e){return t!=null&&e in Object(t)}function tf(t,e,n){e=xo(e,t);for(var r=-1,i=e.length,o=!1;++r<i;){var s=ze(e[r]);if(!(o=t!=null&&n(t,s)))break;t=t[s]}return o||++r!=i?o:(i=t==null?0:t.length,!!i&&Jn(i)&&co(s,i)&&(at(t)||yo(t)))}function ef(t,e){return t!=null&&tf(t,e,Zl)}var nf=1,rf=2;function of(t,e){return tr(t)&&ts(e)?es(ze(t),e):function(n){var r=Bd(n,t);return r===void 0&&r===e?ef(n,t):cr(e,r,nf|rf)}}function sf(t){return function(e){return e?.[t]}}function af(t){return function(e){return So(e,t)}}function cf(t){return tr(t)?sf(ze(t)):af(t)}function uf(t){return typeof t=="function"?t:t==null?ku:typeof t=="object"?at(t)?of(t[0],t[1]):Xl(t):cf(t)}function df(t,e,n){for(var r=-1,i=t==null?0:t.length;++r<i;)if(n(e,t[r]))return!0;return!1}var hf=1/0,lf=Pt&&1/sr(new Pt([,-0]))[1]==hf?function(t){return new Pt(t)}:Mu,ff=200;function ns(t,e,n){var r=-1,i=Lu,o=t.length,s=!0,a=[],c=a;if(n)s=!1,i=df;else if(o>=ff){var u=e?null:lf(t);if(u)return sr(u);s=!1,i=Wo,c=new he}else c=e?[]:a;t:for(;++r<o;){var h=t[r],l=e?e(h):h;if(h=n||h!==0?h:0,s&&l===l){for(var d=c.length;d--;)if(c[d]===l)continue t;e&&c.push(l),a.push(h)}else i(c,l,n)||(c!==a&&c.push(l),a.push(h))}return a}function ur(t){return t&&t.length?ns(t):[]}function pf(t,e){return t&&t.length?ns(t,uf(e)):[]}var mt={},U={},q={};Object.defineProperty(q,"__esModule",{value:!0}),q.output=q.exists=q.hash=q.bytes=q.bool=q.number=void 0;function Qe(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}q.number=Qe;function rs(t){if(typeof t!="boolean")throw new Error(`Expected boolean, not ${t}`)}q.bool=rs;function yf(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function dr(t,...e){if(!yf(t))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}q.bytes=dr;function is(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Qe(t.outputLen),Qe(t.blockLen)}q.hash=is;function os(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}q.exists=os;function ss(t,e){dr(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}q.output=ss;const vf={number:Qe,bool:rs,bytes:dr,hash:is,exists:os,output:ss};q.default=vf;var M={};Object.defineProperty(M,"__esModule",{value:!0}),M.add5L=M.add5H=M.add4H=M.add4L=M.add3H=M.add3L=M.add=M.rotlBL=M.rotlBH=M.rotlSL=M.rotlSH=M.rotr32L=M.rotr32H=M.rotrBL=M.rotrBH=M.rotrSL=M.rotrSH=M.shrSL=M.shrSH=M.toBig=M.split=M.fromBig=void 0;const Xe=BigInt(2**32-1),hr=BigInt(32);function lr(t,e=!1){return e?{h:Number(t&Xe),l:Number(t>>hr&Xe)}:{h:Number(t>>hr&Xe)|0,l:Number(t&Xe)|0}}M.fromBig=lr;function as(t,e=!1){let n=new Uint32Array(t.length),r=new Uint32Array(t.length);for(let i=0;i<t.length;i++){const{h:o,l:s}=lr(t[i],e);[n[i],r[i]]=[o,s]}return[n,r]}M.split=as;const cs=(t,e)=>BigInt(t>>>0)<<hr|BigInt(e>>>0);M.toBig=cs;const us=(t,e,n)=>t>>>n;M.shrSH=us;const ds=(t,e,n)=>t<<32-n|e>>>n;M.shrSL=ds;const hs=(t,e,n)=>t>>>n|e<<32-n;M.rotrSH=hs;const ls=(t,e,n)=>t<<32-n|e>>>n;M.rotrSL=ls;const fs=(t,e,n)=>t<<64-n|e>>>n-32;M.rotrBH=fs;const ps=(t,e,n)=>t>>>n-32|e<<64-n;M.rotrBL=ps;const ys=(t,e)=>e;M.rotr32H=ys;const vs=(t,e)=>t;M.rotr32L=vs;const ms=(t,e,n)=>t<<n|e>>>32-n;M.rotlSH=ms;const gs=(t,e,n)=>e<<n|t>>>32-n;M.rotlSL=gs;const bs=(t,e,n)=>e<<n-32|t>>>64-n;M.rotlBH=bs;const Es=(t,e,n)=>t<<n-32|e>>>64-n;M.rotlBL=Es;function Is(t,e,n,r){const i=(e>>>0)+(r>>>0);return{h:t+n+(i/2**32|0)|0,l:i|0}}M.add=Is;const _s=(t,e,n)=>(t>>>0)+(e>>>0)+(n>>>0);M.add3L=_s;const ws=(t,e,n,r)=>e+n+r+(t/2**32|0)|0;M.add3H=ws;const xs=(t,e,n,r)=>(t>>>0)+(e>>>0)+(n>>>0)+(r>>>0);M.add4L=xs;const Ss=(t,e,n,r,i)=>e+n+r+i+(t/2**32|0)|0;M.add4H=Ss;const ks=(t,e,n,r,i)=>(t>>>0)+(e>>>0)+(n>>>0)+(r>>>0)+(i>>>0);M.add5L=ks;const Os=(t,e,n,r,i,o)=>e+n+r+i+o+(t/2**32|0)|0;M.add5H=Os;const mf={fromBig:lr,split:as,toBig:cs,shrSH:us,shrSL:ds,rotrSH:hs,rotrSL:ls,rotrBH:fs,rotrBL:ps,rotr32H:ys,rotr32L:vs,rotlSH:ms,rotlSL:gs,rotlBH:bs,rotlBL:Es,add:Is,add3L:_s,add3H:ws,add4L:xs,add4H:Ss,add5H:Os,add5L:ks};M.default=mf;var Ms={};const gf=dy(hy);(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.randomBytes=t.wrapXOFConstructorWithOpts=t.wrapConstructorWithOpts=t.wrapConstructor=t.checkOpts=t.Hash=t.concatBytes=t.toBytes=t.utf8ToBytes=t.asyncLoop=t.nextTick=t.hexToBytes=t.bytesToHex=t.isLE=t.rotr=t.createView=t.u32=t.u8=void 0;const e=gf,n=p=>new Uint8Array(p.buffer,p.byteOffset,p.byteLength);t.u8=n;const r=p=>new Uint32Array(p.buffer,p.byteOffset,Math.floor(p.byteLength/4));t.u32=r;function i(p){return p instanceof Uint8Array||p!=null&&typeof p=="object"&&p.constructor.name==="Uint8Array"}const o=p=>new DataView(p.buffer,p.byteOffset,p.byteLength);t.createView=o;const s=(p,w)=>p<<32-w|p>>>w;if(t.rotr=s,t.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68,!t.isLE)throw new Error("Non little-endian hardware is not supported");const a=Array.from({length:256},(p,w)=>w.toString(16).padStart(2,"0"));function c(p){if(!i(p))throw new Error("Uint8Array expected");let w="";for(let R=0;R<p.length;R++)w+=a[p[R]];return w}t.bytesToHex=c;const u={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function h(p){if(p>=u._0&&p<=u._9)return p-u._0;if(p>=u._A&&p<=u._F)return p-(u._A-10);if(p>=u._a&&p<=u._f)return p-(u._a-10)}function l(p){if(typeof p!="string")throw new Error("hex string expected, got "+typeof p);const w=p.length,R=w/2;if(w%2)throw new Error("padded hex string expected, got unpadded hex of length "+w);const S=new Uint8Array(R);for(let O=0,V=0;O<R;O++,V+=2){const X=h(p.charCodeAt(V)),wt=h(p.charCodeAt(V+1));if(X===void 0||wt===void 0){const ne=p[V]+p[V+1];throw new Error('hex string expected, got non-hex character "'+ne+'" at index '+V)}S[O]=X*16+wt}return S}t.hexToBytes=l;const d=async()=>{};t.nextTick=d;async function f(p,w,R){let S=Date.now();for(let O=0;O<p;O++){R(O);const V=Date.now()-S;V>=0&&V<w||(await(0,t.nextTick)(),S+=V)}}t.asyncLoop=f;function v(p){if(typeof p!="string")throw new Error(`utf8ToBytes expected string, got ${typeof p}`);return new Uint8Array(new TextEncoder().encode(p))}t.utf8ToBytes=v;function y(p){if(typeof p=="string"&&(p=v(p)),!i(p))throw new Error(`expected Uint8Array, got ${typeof p}`);return p}t.toBytes=y;function E(...p){let w=0;for(let S=0;S<p.length;S++){const O=p[S];if(!i(O))throw new Error("Uint8Array expected");w+=O.length}const R=new Uint8Array(w);for(let S=0,O=0;S<p.length;S++){const V=p[S];R.set(V,O),O+=V.length}return R}t.concatBytes=E;class m{clone(){return this._cloneInto()}}t.Hash=m;const I={}.toString;function x(p,w){if(w!==void 0&&I.call(w)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(p,w)}t.checkOpts=x;function k(p){const w=S=>p().update(y(S)).digest(),R=p();return w.outputLen=R.outputLen,w.blockLen=R.blockLen,w.create=()=>p(),w}t.wrapConstructor=k;function A(p){const w=(S,O)=>p(O).update(y(S)).digest(),R=p({});return w.outputLen=R.outputLen,w.blockLen=R.blockLen,w.create=S=>p(S),w}t.wrapConstructorWithOpts=A;function C(p){const w=(S,O)=>p(O).update(y(S)).digest(),R=p({});return w.outputLen=R.outputLen,w.blockLen=R.blockLen,w.create=S=>p(S),w}t.wrapXOFConstructorWithOpts=C;function T(p=32){if(e.crypto&&typeof e.crypto.getRandomValues=="function")return e.crypto.getRandomValues(new Uint8Array(p));throw new Error("crypto.getRandomValues must be defined")}t.randomBytes=T})(Ms),Object.defineProperty(U,"__esModule",{value:!0}),U.shake256=U.shake128=U.keccak_512=U.keccak_384=U.keccak_256=U.keccak_224=U.sha3_512=U.sha3_384=U.sha3_256=U.sha3_224=U.Keccak=U.keccakP=void 0;const Bt=q,le=M,fe=Ms,[As,Rs,Ns]=[[],[],[]],bf=BigInt(0),pe=BigInt(1),Ef=BigInt(2),If=BigInt(7),_f=BigInt(256),wf=BigInt(113);for(let t=0,e=pe,n=1,r=0;t<24;t++){[n,r]=[r,(2*n+3*r)%5],As.push(2*(5*r+n)),Rs.push((t+1)*(t+2)/2%64);let i=bf;for(let o=0;o<7;o++)e=(e<<pe^(e>>If)*wf)%_f,e&Ef&&(i^=pe<<(pe<<BigInt(o))-pe);Ns.push(i)}const[xf,Sf]=(0,le.split)(Ns,!0),Ts=(t,e,n)=>n>32?(0,le.rotlBH)(t,e,n):(0,le.rotlSH)(t,e,n),js=(t,e,n)=>n>32?(0,le.rotlBL)(t,e,n):(0,le.rotlSL)(t,e,n);function Ds(t,e=24){const n=new Uint32Array(10);for(let r=24-e;r<24;r++){for(let s=0;s<10;s++)n[s]=t[s]^t[s+10]^t[s+20]^t[s+30]^t[s+40];for(let s=0;s<10;s+=2){const a=(s+8)%10,c=(s+2)%10,u=n[c],h=n[c+1],l=Ts(u,h,1)^n[a],d=js(u,h,1)^n[a+1];for(let f=0;f<50;f+=10)t[s+f]^=l,t[s+f+1]^=d}let i=t[2],o=t[3];for(let s=0;s<24;s++){const a=Rs[s],c=Ts(i,o,a),u=js(i,o,a),h=As[s];i=t[h],o=t[h+1],t[h]=c,t[h+1]=u}for(let s=0;s<50;s+=10){for(let a=0;a<10;a++)n[a]=t[s+a];for(let a=0;a<10;a++)t[s+a]^=~n[(a+2)%10]&n[(a+4)%10]}t[0]^=xf[r],t[1]^=Sf[r]}n.fill(0)}U.keccakP=Ds;class ye extends fe.Hash{constructor(e,n,r,i=!1,o=24){if(super(),this.blockLen=e,this.suffix=n,this.outputLen=r,this.enableXOF=i,this.rounds=o,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,Bt.number)(r),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,fe.u32)(this.state)}keccak(){Ds(this.state32,this.rounds),this.posOut=0,this.pos=0}update(e){(0,Bt.exists)(this);const{blockLen:n,state:r}=this;e=(0,fe.toBytes)(e);const i=e.length;for(let o=0;o<i;){const s=Math.min(n-this.pos,i-o);for(let a=0;a<s;a++)r[this.pos++]^=e[o++];this.pos===n&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:e,suffix:n,pos:r,blockLen:i}=this;e[r]^=n,n&128&&r===i-1&&this.keccak(),e[i-1]^=128,this.keccak()}writeInto(e){(0,Bt.exists)(this,!1),(0,Bt.bytes)(e),this.finish();const n=this.state,{blockLen:r}=this;for(let i=0,o=e.length;i<o;){this.posOut>=r&&this.keccak();const s=Math.min(r-this.posOut,o-i);e.set(n.subarray(this.posOut,this.posOut+s),i),this.posOut+=s,i+=s}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return(0,Bt.number)(e),this.xofInto(new Uint8Array(e))}digestInto(e){if((0,Bt.output)(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(e){const{blockLen:n,suffix:r,outputLen:i,rounds:o,enableXOF:s}=this;return e||(e=new ye(n,r,i,s,o)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=o,e.suffix=r,e.outputLen=i,e.enableXOF=s,e.destroyed=this.destroyed,e}}U.Keccak=ye;const gt=(t,e,n)=>(0,fe.wrapConstructor)(()=>new ye(e,t,n));U.sha3_224=gt(6,144,224/8),U.sha3_256=gt(6,136,256/8),U.sha3_384=gt(6,104,384/8),U.sha3_512=gt(6,72,512/8),U.keccak_224=gt(1,144,224/8),U.keccak_256=gt(1,136,256/8),U.keccak_384=gt(1,104,384/8),U.keccak_512=gt(1,72,512/8);const Ls=(t,e,n)=>(0,fe.wrapXOFConstructorWithOpts)((r={})=>new ye(e,t,r.dkLen===void 0?n:r.dkLen,!0));U.shake128=Ls(31,168,128/8),U.shake256=Ls(31,136,256/8);const{sha3_512:kf}=U,Cs=24,ve=32,fr=(t=4,e=Math.random)=>{let n="";for(;n.length<t;)n=n+Math.floor(e()*36).toString(36);return n};function Vs(t){let e=8n,n=0n;for(const r of t.values()){const i=BigInt(r);n=(n<<e)+i}return n}const Ks=(t="")=>Vs(kf(t)).toString(36).slice(1),Ps=Array.from({length:26},(t,e)=>String.fromCharCode(e+97)),Of=t=>Ps[Math.floor(t()*Ps.length)],Bs=({globalObj:t=typeof vu<"u"?vu:typeof window<"u"?window:{},random:e=Math.random}={})=>{const n=Object.keys(t).toString(),r=n.length?n+fr(ve,e):fr(ve,e);return Ks(r).substring(0,ve)},Hs=t=>()=>t++,Mf=476782367,Us=({random:t=Math.random,counter:e=Hs(Math.floor(t()*Mf)),length:n=Cs,fingerprint:r=Bs({random:t})}={})=>function(){const i=Of(t),o=Date.now().toString(36),s=e().toString(36),a=fr(n,t),c=`${o+a+s+r}`;return`${i+Ks(c).substring(1,n)}`},Af=Us(),Rf=(t,{minLength:e=2,maxLength:n=ve}={})=>{const r=t.length,i=/^[0-9a-z]+$/;try{if(typeof t=="string"&&r>=e&&r<=n&&i.test(t))return!0}finally{}return!1};mt.getConstants=()=>({defaultLength:Cs,bigLength:ve}),mt.init=Us,mt.createId=Af,mt.bufToBigInt=Vs,mt.createCounter=Hs,mt.createFingerprint=Bs,mt.isCuid=Rf;const{createId:Nf,init:vy,getConstants:my,isCuid:gy}=mt;var pr=Nf,Tf="SIGNATURE",jf="ENCRYPTION",Df="SYMMETRIC",Lf="LINK_HASH",$s={SIGNATURE:Tf,ENCRYPTION:jf,SYMMETRIC:Df,LINK_HASH:Lf},Ze="ROOT",Ht={isValid:!0},Ys={type:"EPHEMERAL",name:"EPHEMERAL"},{LINK_HASH:Cf}=$s,me=t=>St(Cf,t),Gs=({graph:t,action:e,user:n,context:r={},keys:i})=>{const{publicKey:o,secretKey:s}=n.keys.encryption,{publicKey:a}=i.encryption,c={...e,...r,userId:n.userId,timestamp:Date.now(),prev:t.head??[]},u=vt.encryptBytes({secret:c,recipientPublicKey:a,senderSecretKey:s}),h=me(u),l={hash:h,body:c},d={senderPublicKey:o,recipientPublicKey:a,encryptedBody:u};return{root:t.root??h,head:[h],encryptedLinks:{...t.encryptedLinks,[h]:d},links:{...t.links,[h]:l}}},tn=(t,e)=>t.links[e],Fs=(t,e)=>Vf(t)[e]||[],Vf=yt(t=>{const e={};for(const n of Object.values(t.links)){const r=n.body.prev;for(const i of r){const o=e[i]||[];o.push(n.hash),e[i]=o}}return e}),en=t=>Object.keys(t.links),Kf=(t,e)=>`${t.head.join("")}:${e}`,ge=yt((t,e)=>{const n=tn(t,e);_(n);const r=n.body.prev,i=r.flatMap(o=>ge(t,o));return ur(r.concat(i))},Kf),Pf=(t,e,n)=>e!==void 0&&n!==void 0&&e.hash in t.links&&n.hash in t.links&&ge(t,n.hash).includes(e.hash),Bf=(t,e,n)=>ge(t,n).includes(e),Hf=(t,e)=>`${t.head.join("")}:${e}`,zs=yt((t,e)=>{const n=Fs(t,e),r=n.flatMap(i=>zs(t,i));return ur(n.concat(r))},Hf),Uf=(t,e,n)=>zs(t,n).includes(e),$f=(t,e)=>Yf(t)[e],Yf=yt(t=>{const e={};for(const n in t.links){const r=n;e[r]=en(t).filter(i=>Gf(t,r,i)).sort()}return e}),Gf=(t,e,n)=>e!==n&&!Bf(t,e,n)&&!Uf(t,e,n),Ff=t=>{const e={},n=i=>{const o=[i];for(const s of $f(t,i))e[s]||(e[s]=!0,o.push(...n(s)));return o},r=[];for(const i in t.links){const o=i;if(!e[o]){e[o]=!0;const s=n(o);s.length>1&&r.push(s)}}return r},zf={root:void 0,head:void 0,encryptedLinks:{},links:{}},Wf=({user:t,id:e=pr(),name:n=e,rootPayload:r={},context:i={},keys:o})=>{const s={name:n,id:e,...r};return Gs({graph:zf,action:{type:Ze,prev:[],payload:s},user:t,context:i,keys:o})},Jf=t=>(e,n)=>{const r=typeof t=="function"?t(n):n[t];return{...e,[r]:n}},qf={GRAPH:"GRAPH",USER:"USER"},Qf=t=>t.encryption.hasOwnProperty("secretKey")&&t.signature.hasOwnProperty("secretKey")&&"secretKey"in t,nn=t=>t!==void 0&&"secretKey"in t&&"encryption"in t&&"signature"in t,Xf=t=>!Array.isArray(t)&&!nn(t),Ut=t=>Xf(t)?t:(nn(t)&&(t=[t]),t.reduce(Jf(e=>e.encryption.publicKey),{})),Ws=(t,e)=>{const{senderPublicKey:n,recipientPublicKey:r,encryptedBody:i}=t,o=Ut(e)[r];_(o,"Can't decrypt link: don't have the correct keyset");const s=Zf(i),a=vt.decryptBytes({cipher:s,recipientSecretKey:o.encryption.secretKey,senderPublicKey:n});return{hash:me(i),body:a}},yr=({encryptedGraph:t,keys:e})=>{const{encryptedLinks:n,root:r,childMap:i={}}=t,o=t.links??{},s=(c,u={})=>{const h=n[c],l=o[c]??Ws(h,e);let d={[c]:l};const f=i[c]??[];for(const v of f)d={...d,...s(v,d)};return{...u,...d}},a=s(r);return{...t,links:a}},Zf=t=>tp(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):new Uint8Array(t),tp=t=>"buffer"in t&&"byteOffset"in t&&"byteLength"in t,ep=(t,e)=>Object.fromEntries(e.map(n=>[n,np(t,n)])),np=(t,e)=>t.encryptedLinks[e],rp=t=>t.head.map(e=>tn(t,e));function vr(t,e){return typeof e=="string"?tn(t,e).body.prev:e.body.prev.map(n=>tn(t,n))}let rn,on,Js,sn,qs,Qs,Xs,mr,gr,br,Zs,be,Er,ta,ea,na,ra,ia,oa,sa,aa,ca,ua,da,ut,ha,la,an,fa,Ir,pa,ya,_r,va,wr,ma;rn={},on=({graph:t,depth:e,start:n=t.head,end:r=[],prev:i,hashes:o})=>o?o.reduce((s,a)=>({...s,[a]:vr(t,a)}),rn):(i&&(n=Js(i)),e===0?rn:n.reduce((s,a)=>{const c=vr(t,a),u=c.filter(l=>!(l in s)).filter(l=>!r.includes(l)),h=on({graph:t,depth:e?e-1:void 0,start:u,end:r});return{...s,[a]:c,...h}},rn)),Js=t=>Object.keys(t).flatMap(e=>t[e]).filter(e=>!(e in t)),sn=t=>{const e={};for(const n of en(t))for(const r of vr(t,n))e[r]||(e[r]=[]),e[r].push(n);return e},qs=t=>{const e={},n=Object.keys(t);for(const r of n)for(const i of t[r])e[i]||(e[i]=[]),e[i].push(r);return e},Qs=t=>t.links[t.root],Xs=(t,e={})=>{const{comparator:n=mr}=e;let r=Object.values(t.links);const i=Object.fromEntries(r.map(a=>[a.hash,a.body.prev.length])),o=[],s=a=>{o.push(a),r=r.filter(l=>l.hash!==a.hash);const c=Fs(t,a.hash);for(const l of c)i[l]--;if(c.length!==1)return;const u=c[0];if(i[u]>0)return;const h=t.links[u];s(h)};for(;r.length>0;){const a=r.filter(c=>i[c.hash]===0).sort(n).shift();s(a)}return o},mr=(t,e)=>t.hash<e.hash?-1:t.hash>e.hash?1:0,gr=(t,e=br)=>{const{sort:n=mr,filter:r=Zs}=e(t);return Xs(t,{comparator:n}).map(i=>{const o=i.isInvalid??!r(i);return{...i,isInvalid:o}})},br=t=>({}),Zs=t=>!0,be=(t,e)=>t===void 0||e===void 0||t.length!==e.length?!1:(t.sort(),e.sort(),t.every((n,r)=>n===e[r])),Er=(t,e)=>{if(t.root!==e.root)throw new Error("Cannot merge two graphs with different roots");const n={...e.links,...t.links},r={...e.encryptedLinks,...t.encryptedLinks},i=ur([...t.head,...e.head]).filter(ta(n)),o={root:t.root,head:i,encryptedLinks:r,links:n};return o.head=o.head.sort(),o},ta=t=>e=>!Object.values(t).some(ea(e)),ea=t=>e=>e.body.prev.includes(t),na=t=>{const{head:e,root:n,encryptedLinks:r}=t,i=sn(t);return{head:e,root:n,encryptedLinks:r,childMap:i}},ra=t=>Ki(na(t)),ia=(t,e)=>{const n=Pi(t);return yr({encryptedGraph:n,keys:e})},{SIGNATURE:oa,ENCRYPTION:sa,SYMMETRIC:aa}=$s,lt=(t,e=ae())=>{const{type:n,name:r=n}=t,i=fu(`${r}:${n}:${e}`);return{type:n,name:r,generation:0,signature:xt.keyPair(St(oa,i).slice(0,32)),encryption:vt.keyPair(St(sa,i).slice(0,32)),secretKey:St(aa,i)}},ca=t=>{let e;for(const n in t){const r=t[n];(e===void 0||r.generation>e.generation)&&(e=r)}return e},ft=t=>Qf(t)?{type:t.type,name:t.name,generation:t.generation,encryption:t.encryption.publicKey,signature:t.signature.publicKey}:t,ua=class extends Error{constructor(e,n){super();b(this,"name");b(this,"details");this.message=e,this.details=n}},da={validateHash(t,e){const{hash:n}=t,{encryptedBody:r}=e.encryptedLinks[n],i=me(r);return n===i?Ht:ut("The hash calculated for this link does not match.",{link:t,hash:n,expected:i})},validatePrev(t,e){for(const n of t.body.prev)if(!(n in e.links))return ut("The link referenced by one of the hashes in the `prev` property does not exist.");return Ht},validateRoot(t,e){const n=t.body.prev.length===0,r="type"in t.body&&t.body.type===Ze,i=Qs(e)===t;return n===i&&i===r?Ht:ut(r?n?"The ROOT link has to be the link referenced by the graph `root` property":"The ROOT link cannot have any predecessors":n?"Non-ROOT links must have predecessors":"The link referenced by the graph `root` property must be a ROOT link",{link:t,graph:e})},validateTimestamps(t,e){const{timestamp:n}=t.body,r=Date.now();if(n>r)return ut("The link's timestamp is in the future.",{link:t,now:r});for(const i of t.body.prev){const o=e.links[i];if(o.body.timestamp>n)return ut("This link's timestamp can't be earlier than a previous link.",{link:t,prevLink:o})}return Ht}},ut=(t,e)=>({isValid:!1,error:new ua(t,e)}),ha=t=>{const e={},n=(r,i)=>`${St("memoize",r)}:${St("memoize",i)}`;for(const r in t)e[r]=yt(t[r],n);return e},la=ha(da),an=(t,e={})=>{{const o=t.root,s=t.encryptedLinks[o],a=me(s.encryptedBody);if(a!==o)return ut("Root hash does not match the hash of the root link",{rootHash:o,computedHash:a,rootLink:s})}for(const o of t.head){const s=t.encryptedLinks[o],a=me(s.encryptedBody);if(a!==o)return ut("Head hash does not match the hash of the head link",{headHash:o,computedHash:a,headLink:s})}const n=Object.keys(t.encryptedLinks),r=Object.keys(t.links);if(n.length!==r.length)return ut("Number of encrypted links does not match number of links",{encryptedLinkHashes:n,linkHashes:r});const i=((...o)=>s=>{const a=fa(o);for(const c in a){const u=a[c];try{const h=u(s,t);if(!h.isValid)return h}catch(h){const{message:l}=h;return ut(l,h)}}return Ht})(la,e);for(const o of Object.values(t.links)){const s=i(o);if(!s.isValid)return s}return Ht},fa=t=>t.reduce((e,n)=>Object.assign(e,n),{}),Ir=({initialState:t,reducer:e,resolver:n,validators:r})=>i=>(an(i,r),gr(i,n).reduce(e,t)),pa=class extends $n{constructor({user:e,context:n={},graph:r,rootPayload:i,initialState:o={},reducer:s,validators:a,resolver:c=br,keys:u}){super();b(this,"user");b(this,"context");b(this,"initialState");b(this,"reducer");b(this,"resolver");b(this,"validators");b(this,"keyring");b(this,"graph");b(this,"state");r===void 0?(_(nn(u),"If no graph is provided, only pass a single keyset, not a keyring."),this.graph=Wf({user:e,rootPayload:i,keys:u})):ya(r)?this.graph=r:(_(u),this.graph=ia(r,u)),this.context=n,this.initialState=o,this.reducer=s,this.validators=a,this.resolver=c,this.user=e,this.keyring=Ut(u),this.updateState()}getState(){return this.state}getGraph(){return this.graph}save(){return ra(this.graph)}dispatch(e,n){const r={payload:void 0,...e};if(n===void 0){const o=this.graph.head.sort()[0],s=this.graph.encryptedLinks[o].recipientPublicKey;n=this.keyring[s]}else this.keyring[n.encryption.publicKey]=n;this.graph=Gs({graph:this.graph,action:r,user:this.user,keys:n,context:this.context});const[i]=rp(this.graph);return this.state=this.reducer(this.state,i),this.emit("updated",{head:this.graph.head}),e}merge(e){this.graph=Er(this.graph,e),this.updateState()}validate(){return an(this.graph,this.validators)}updateState(){const e=Ir({initialState:this.initialState,reducer:this.reducer,resolver:this.resolver,validators:this.validators});this.state=e(this.graph),this.emit("updated",{head:this.graph.head})}},ya=t=>t?.hasOwnProperty("root"),_r=t=>new pa(t),va=(t,e)=>{const n={root:t.root,head:t.head},{their:r,our:i,lastCommonHead:o}=e,s={...e},a=t.head,c=r.head;if(i.reportedError)return n.error=i.reportedError,delete i.reportedError,[s,n];if(be(a,o))return[s,void 0];if(be(a,c))return s.lastCommonHead=a,[s,n];const u=Object.fromEntries([...c,...c.flatMap(d=>ge(t,d)),...o,...o.flatMap(d=>ge(t,d)),...Object.keys(r.parentMap),...i.links].map(d=>[d,!0]));let h=[];if(c.length>0&&c.every(d=>d in t.links))h=en(t).filter(d=>!(d in u));else{if(r.parentMap){const d={...t.encryptedLinks,...r.encryptedLinks};n.need=Object.keys(u).filter(f=>!(f in d)),h=en(t).filter(f=>!(f in u))}be(a,i.parentMapAtHead)||(n.parentMap=on({graph:t,end:o}),s.our.parentMapAtHead=a)}const l=r.need.concat(h);if(l.length>0){n.links=ep(t,l);const d=on({graph:t,hashes:l});n.parentMap={...n.parentMap,...d}}return s.our.links=i.links.concat(l),s.their.need=[],[s,n]},wr=()=>({their:{head:[],encryptedLinks:{},need:[],parentMap:{}},our:{head:[],links:[]},lastCommonHead:[],failedSyncCount:0}),ma=(t,e,n,r,i=yr)=>{const o=Ut(r),s=n;_(t.root===s.root,"Can't sync graphs with different roots");const a={...e,their:{head:s.head,need:s.need??[],encryptedLinks:{...e.their.encryptedLinks,...s.links},parentMap:{...e.their.parentMap,...s.parentMap}}};if(Object.keys(a.their.encryptedLinks).length>0){const{head:c}=s,u=sn(t),h=qs(a.their.parentMap),l={...u,...h},d={...t.encryptedLinks,...a.their.encryptedLinks},f={...t,head:c,encryptedLinks:d,childMap:l},v=i({encryptedGraph:f,keys:o}),y=Er(t,v),E=an(y);E.isValid?t=y:(a.failedSyncCount+=1,a.our.reportedError=E.error),a.their.encryptedLinks={},a.their.parentMap={}}return[t,a]},Eu=(t,e=pr(),n=ae())=>({userName:t,userId:e,keys:lt({type:qf.USER,name:e},n)}),to=t=>{const{userId:e,userName:n}=t;return{userId:e,userName:n,keys:ft(t.keys)}};var g=function(){return g=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++){e=arguments[n];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t},g.apply(this,arguments)};function xr(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]]);return n}function N(t){var e=typeof Symbol=="function"&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function j(t,e){var n=typeof Symbol=="function"&&t[Symbol.iterator];if(!n)return t;var r=n.call(t),i,o=[],s;try{for(;(e===void 0||e-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(a){s={error:a}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o}function Y(t,e,n){if(n||arguments.length===2)for(var r=0,i=e.length,o;r<i;r++)(o||!(r in e))&&(o||(o=Array.prototype.slice.call(e,0,r)),o[r]=e[r]);return t.concat(o||Array.prototype.slice.call(e))}var K;(function(t){t.Start="xstate.start",t.Stop="xstate.stop",t.Raise="xstate.raise",t.Send="xstate.send",t.Cancel="xstate.cancel",t.NullEvent="",t.Assign="xstate.assign",t.After="xstate.after",t.DoneState="done.state",t.DoneInvoke="done.invoke",t.Log="xstate.log",t.Init="xstate.init",t.Invoke="xstate.invoke",t.ErrorExecution="error.execution",t.ErrorCommunication="error.communication",t.ErrorPlatform="error.platform",t.ErrorCustom="xstate.error",t.Update="xstate.update",t.Pure="xstate.pure",t.Choose="xstate.choose"})(K||(K={}));var $t;(function(t){t.Parent="#_parent",t.Internal="#_internal"})($t||($t={}));var Sr=K.Start,kr=K.Stop,Ee=K.Raise,cn=K.Send,ga=K.Cancel,ip=K.NullEvent,Or=K.Assign;K.After,K.DoneState;var ba=K.Log,op=K.Init,Mr=K.Invoke;K.ErrorExecution;var Ea=K.ErrorPlatform,sp=K.ErrorCustom,Ia=K.Update,ap=K.Choose,cp=K.Pure,_a=".",wa={},Ar="xstate.guard",up="",Rr;function Nr(t,e,n){n===void 0&&(n=_a);var r=Ie(t,n),i=Ie(e,n);return L(i)?L(r)?i===r:!1:L(r)?r in i:Object.keys(r).every(function(o){return o in i?Nr(r[o],i[o]):!1})}function xa(t){try{return L(t)||typeof t=="number"?"".concat(t):t.type}catch{throw new Error("Events must be strings or objects with a string event.type property.")}}function Tr(t,e){try{return Yt(t)?t:t.toString().split(e)}catch{throw new Error("'".concat(t,"' is not a valid state path."))}}function dp(t){return typeof t=="object"&&"value"in t&&"context"in t&&"event"in t&&"_event"in t}function Ie(t,e){if(dp(t))return t.value;if(Yt(t))return un(t);if(typeof t!="string")return t;var n=Tr(t,e);return un(n)}function un(t){if(t.length===1)return t[0];for(var e={},n=e,r=0;r<t.length-1;r++)r===t.length-2?n[t[r]]=t[r+1]:(n[t[r]]={},n=n[t[r]]);return e}function _e(t,e){for(var n={},r=Object.keys(t),i=0;i<r.length;i++){var o=r[i];n[o]=e(t[o],o,t,i)}return n}function Sa(t,e,n){var r,i,o={};try{for(var s=N(Object.keys(t)),a=s.next();!a.done;a=s.next()){var c=a.value,u=t[c];n(u)&&(o[c]=e(u,c,t))}}catch(h){r={error:h}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return o}var hp=function(t){return function(e){var n,r,i=e;try{for(var o=N(t),s=o.next();!s.done;s=o.next()){var a=s.value;i=i[a]}}catch(c){n={error:c}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return i}};function lp(t,e){return function(n){var r,i,o=n;try{for(var s=N(t),a=s.next();!a.done;a=s.next()){var c=a.value;o=o[e][c]}}catch(u){r={error:u}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return o}}function dn(t){if(!t)return[[]];if(L(t))return[[t]];var e=G(Object.keys(t).map(function(n){var r=t[n];return typeof r!="string"&&(!r||!Object.keys(r).length)?[[n]]:dn(t[n]).map(function(i){return[n].concat(i)})}));return e}function G(t){var e;return(e=[]).concat.apply(e,Y([],j(t),!1))}function ka(t){return Yt(t)?t:[t]}function rt(t){return t===void 0?[]:ka(t)}function hn(t,e,n){var r,i;if(D(t))return t(e,n.data);var o={};try{for(var s=N(Object.keys(t)),a=s.next();!a.done;a=s.next()){var c=a.value,u=t[c];D(u)?o[c]=u(e,n.data):o[c]=u}}catch(h){r={error:h}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return o}function fp(t){return/^(done|error)\./.test(t)}function Oa(t){return!!(t instanceof Promise||t!==null&&(D(t)||typeof t=="object")&&D(t.then))}function pp(t){return t!==null&&typeof t=="object"&&"transition"in t&&typeof t.transition=="function"}function yp(t,e){var n,r,i=j([[],[]],2),o=i[0],s=i[1];try{for(var a=N(t),c=a.next();!c.done;c=a.next()){var u=c.value;e(u)?o.push(u):s.push(u)}}catch(h){n={error:h}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}return[o,s]}function Ma(t,e){return _e(t.states,function(n,r){if(n){var i=(L(e)?void 0:e[r])||(n?n.current:void 0);if(i)return{current:i,states:Ma(n,i)}}})}function vp(t,e){return{current:e,states:Ma(t,e)}}function Aa(t,e,n,r){var i=t&&n.reduce(function(o,s){var a,c,u=s.assignment,h={state:r,action:s,_event:e},l={};if(D(u))l=u(o,e.data,h);else try{for(var d=N(Object.keys(u)),f=d.next();!f.done;f=d.next()){var v=f.value,y=u[v];l[v]=D(y)?y(o,e.data,h):y}}catch(E){a={error:E}}finally{try{f&&!f.done&&(c=d.return)&&c.call(d)}finally{if(a)throw a.error}}return Object.assign({},o,l)},t);return i}var mp=function(){};function Yt(t){return Array.isArray(t)}function D(t){return typeof t=="function"}function L(t){return typeof t=="string"}function Ra(t,e){if(t)return L(t)?{type:Ar,name:t,predicate:e?e[t]:void 0}:D(t)?{type:Ar,name:t.name,predicate:t}:t}function gp(t){try{return"subscribe"in t&&D(t.subscribe)}catch{return!1}}var bt=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();Rr={},Rr[bt]=function(){return this},Rr[Symbol.observable]=function(){return this};function Gt(t){return!!t&&"__xstatenode"in t}function bp(t){return!!t&&typeof t.send=="function"}function ln(t,e){return L(t)||typeof t=="number"?g({type:t},e):t}function J(t,e){if(!L(t)&&"$$type"in t&&t.$$type==="scxml")return t;var n=ln(t);return g({name:n.type,data:n,$$type:"scxml",type:"external"},e)}function Ft(t,e){var n=ka(e).map(function(r){return typeof r>"u"||typeof r=="string"||Gt(r)?{target:r,event:t}:g(g({},r),{event:t})});return n}function Ep(t){if(!(t===void 0||t===up))return rt(t)}function Na(t,e,n,r,i){var o=t.options.guards,s={state:i,cond:e,_event:r};if(e.type===Ar)return(o?.[e.name]||e.predicate)(n,r.data,s);var a=o?.[e.type];if(!a)throw new Error("Guard '".concat(e.type,"' is not implemented on machine '").concat(t.id,"'."));return a(n,r.data,s)}function Ta(t){return typeof t=="string"?{type:t}:t}function fn(t,e,n){var r=function(){},i=typeof t=="object",o=i?t:null;return{next:((i?t.next:t)||r).bind(o),error:((i?t.error:e)||r).bind(o),complete:((i?t.complete:n)||r).bind(o)}}function pn(t,e){return"".concat(t,":invocation[").concat(e,"]")}function jr(t){return(t.type===Ee||t.type===cn&&t.to===$t.Internal)&&typeof t.delay!="number"}var zt=J({type:op});function Dr(t,e){return e&&e[t]||void 0}function we(t,e){var n;if(L(t)||typeof t=="number"){var r=Dr(t,e);D(r)?n={type:t,exec:r}:r?n=r:n={type:t,exec:void 0}}else if(D(t))n={type:t.name||t.toString(),exec:t};else{var r=Dr(t.type,e);if(D(r))n=g(g({},t),{exec:r});else if(r){var i=r.type||t.type;n=g(g(g({},r),t),{type:i})}else n=t}return n}var Et=function(t,e){if(!t)return[];var n=Yt(t)?t:[t];return n.map(function(r){return we(r,e)})};function Lr(t){var e=we(t);return g(g({id:L(t)?t:e.id},e),{type:e.type})}function Ip(t,e){return{type:Ee,event:typeof t=="function"?t:ln(t),delay:e?e.delay:void 0,id:e?.id}}function _p(t,e,n,r){var i={_event:n},o=J(D(t.event)?t.event(e,n.data,i):t.event),s;if(L(t.delay)){var a=r&&r[t.delay];s=D(a)?a(e,n.data,i):a}else s=D(t.delay)?t.delay(e,n.data,i):t.delay;return g(g({},t),{type:Ee,_event:o,delay:s})}function wp(t,e){return{to:e?e.to:void 0,type:cn,event:D(t)?t:ln(t),delay:e?e.delay:void 0,id:e&&e.id!==void 0?e.id:D(t)?t.name:xa(t)}}function xp(t,e,n,r){var i={_event:n},o=J(D(t.event)?t.event(e,n.data,i):t.event),s;if(L(t.delay)){var a=r&&r[t.delay];s=D(a)?a(e,n.data,i):a}else s=D(t.delay)?t.delay(e,n.data,i):t.delay;var c=D(t.to)?t.to(e,n.data,i):t.to;return g(g({},t),{to:c,_event:o,event:o.data,delay:s})}var Sp=function(t,e,n){return g(g({},t),{value:L(t.expr)?t.expr:t.expr(e,n.data,{_event:n})})},kp=function(t){return{type:ga,sendId:t}};function Op(t){var e=Lr(t);return{type:K.Start,activity:e,exec:void 0}}function Mp(t){var e=D(t)?t:Lr(t);return{type:K.Stop,activity:e,exec:void 0}}function Ap(t,e,n){var r=D(t.activity)?t.activity(e,n.data):t.activity,i=typeof r=="string"?{id:r}:r,o={type:K.Stop,activity:i};return o}var Rp=function(t){return{type:Or,assignment:t}};function Np(t,e){var n=e?"#".concat(e):"";return"".concat(K.After,"(").concat(t,")").concat(n)}function yn(t,e){var n="".concat(K.DoneState,".").concat(t),r={type:n,data:e};return r.toString=function(){return n},r}function vn(t,e){var n="".concat(K.DoneInvoke,".").concat(t),r={type:n,data:e};return r.toString=function(){return n},r}function xe(t,e){var n="".concat(K.ErrorPlatform,".").concat(t),r={type:n,data:e};return r.toString=function(){return n},r}var Tp=function(t){var e,n,r=[];try{for(var i=N(t),o=i.next();!o.done;o=i.next())for(var s=o.value,a=0;a<s.actions.length;){if(s.actions[a].type===Or){r.push(s.actions[a]),s.actions.splice(a,1);continue}a++}}catch(c){e={error:c}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r};function mn(t,e,n,r,i,o,s){s===void 0&&(s=!1);var a=s?[]:Tp(i),c=a.length?Aa(n,r,a,e):n,u=s?[n]:void 0,h=[];function l(v,y){var E;switch(y.type){case Ee:{var m=_p(y,c,r,t.options.delays);return o&&typeof m.delay=="number"&&o(m,c,r),m}case cn:var I=xp(y,c,r,t.options.delays);return o&&I.to!==$t.Internal&&(v==="entry"?h.push(I):o(I,c,r)),I;case ba:{var x=Sp(y,c,r);return o?.(x,c,r),x}case ap:{var k=y,A=(E=k.conds.find(function(ne){var ht=Ra(ne.cond,t.options.guards);return!ht||Na(t,ht,c,r,o?void 0:e)}))===null||E===void 0?void 0:E.actions;if(!A)return[];var C=j(mn(t,e,c,r,[{type:v,actions:Et(rt(A),t.options.actions)}],o,s),2),T=C[0],p=C[1];return c=p,u?.push(c),T}case cp:{var A=y.get(c,r.data);if(!A)return[];var w=j(mn(t,e,c,r,[{type:v,actions:Et(rt(A),t.options.actions)}],o,s),2),R=w[0],S=w[1];return c=S,u?.push(c),R}case kr:{var x=Ap(y,c,r);return o?.(x,n,r),x}case Or:{c=Aa(c,r,[y],o?void 0:e),u?.push(c);break}default:var O=we(y,t.options.actions),V=O.exec;if(o)o(O,c,r);else if(V&&u){var X=u.length-1,wt=g(g({},O),{exec:function(ne){for(var ht=[],Tt=1;Tt<arguments.length;Tt++)ht[Tt-1]=arguments[Tt];V.apply(void 0,Y([u[X]],j(ht),!1))}});O=wt}return O}}function d(v){var y,E,m=[];try{for(var I=N(v.actions),x=I.next();!x.done;x=I.next()){var k=x.value,A=l(v.type,k);A&&(m=m.concat(A))}}catch(C){y={error:C}}finally{try{x&&!x.done&&(E=I.return)&&E.call(I)}finally{if(y)throw y.error}}return h.forEach(function(C){o(C,c,r)}),h.length=0,m}var f=G(i.map(d));return[f,c]}var ja=[],Wt=function(t,e){ja.push(t);var n=e(t);return ja.pop(),n};function Da(t){var e;return e={id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:t}}},e[bt]=function(){return this},e}function jp(t,e,n,r){var i,o=Ta(t.src),s=(i=e?.options.services)===null||i===void 0?void 0:i[o.type],a=t.data?hn(t.data,n,r):void 0,c=s?La(s,t.id,a):Da(t.id);return c.meta=t,c}function La(t,e,n){var r=Da(e);if(r.deferred=!0,Gt(t)){var i=r.state=Wt(void 0,function(){return(n?t.withContext(n):t).initialState});r.getSnapshot=function(){return i}}return r}function Dp(t){try{return typeof t.send=="function"}catch{return!1}}function Lp(t){return Dp(t)&&"id"in t}function Cp(t){var e;return g((e={subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},e[bt]=function(){return this},e),t)}var gn=function(t){return t.type==="atomic"||t.type==="final"};function Ca(t){return Object.keys(t.states).map(function(e){return t.states[e]})}function Se(t){return Ca(t).filter(function(e){return e.type!=="history"})}function Va(t){var e=[t];return gn(t)?e:e.concat(G(Se(t).map(Va)))}function ke(t,e){var n,r,i,o,s,a,c,u,h=new Set(t),l=Cr(h),d=new Set(e);try{for(var f=N(d),v=f.next();!v.done;v=f.next())for(var y=v.value,E=y.parent;E&&!d.has(E);)d.add(E),E=E.parent}catch(w){n={error:w}}finally{try{v&&!v.done&&(r=f.return)&&r.call(f)}finally{if(n)throw n.error}}var m=Cr(d);try{for(var I=N(d),x=I.next();!x.done;x=I.next()){var y=x.value;if(y.type==="compound"&&(!m.get(y)||!m.get(y).length))l.get(y)?l.get(y).forEach(function(R){return d.add(R)}):y.initialStateNodes.forEach(function(R){return d.add(R)});else if(y.type==="parallel")try{for(var k=(s=void 0,N(Se(y))),A=k.next();!A.done;A=k.next()){var C=A.value;d.has(C)||(d.add(C),l.get(C)?l.get(C).forEach(function(R){return d.add(R)}):C.initialStateNodes.forEach(function(R){return d.add(R)}))}}catch(R){s={error:R}}finally{try{A&&!A.done&&(a=k.return)&&a.call(k)}finally{if(s)throw s.error}}}}catch(w){i={error:w}}finally{try{x&&!x.done&&(o=I.return)&&o.call(I)}finally{if(i)throw i.error}}try{for(var T=N(d),p=T.next();!p.done;p=T.next())for(var y=p.value,E=y.parent;E&&!d.has(E);)d.add(E),E=E.parent}catch(w){c={error:w}}finally{try{p&&!p.done&&(u=T.return)&&u.call(T)}finally{if(c)throw c.error}}return d}function Ka(t,e){var n=e.get(t);if(!n)return{};if(t.type==="compound"){var r=n[0];if(r){if(gn(r))return r.key}else return{}}var i={};return n.forEach(function(o){i[o.key]=Ka(o,e)}),i}function Cr(t){var e,n,r=new Map;try{for(var i=N(t),o=i.next();!o.done;o=i.next()){var s=o.value;r.has(s)||r.set(s,[]),s.parent&&(r.has(s.parent)||r.set(s.parent,[]),r.get(s.parent).push(s))}}catch(a){e={error:a}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(e)throw e.error}}return r}function Vp(t,e){var n=ke([t],e);return Ka(t,Cr(n))}function Oe(t,e){return Array.isArray(t)?t.some(function(n){return n===e}):t instanceof Set?t.has(e):!1}function Kp(t){return Y([],j(new Set(G(Y([],j(t.map(function(e){return e.ownEvents})),!1)))),!1)}function bn(t,e){return e.type==="compound"?Se(e).some(function(n){return n.type==="final"&&Oe(t,n)}):e.type==="parallel"?Se(e).every(function(n){return bn(t,n)}):!1}function Pp(t){return t===void 0&&(t=[]),t.reduce(function(e,n){return n.meta!==void 0&&(e[n.id]=n.meta),e},{})}function Pa(t){return new Set(G(t.map(function(e){return e.tags})))}function Ba(t,e){if(t===e)return!0;if(t===void 0||e===void 0)return!1;if(L(t)||L(e))return t===e;var n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&n.every(function(i){return Ba(t[i],e[i])})}function Bp(t){return typeof t!="object"||t===null?!1:"value"in t&&"_event"in t}function Hp(t,e){var n=t.exec,r=g(g({},t),{exec:n!==void 0?function(){return n(e.context,e.event,{action:t,state:e,_event:e._event})}:void 0});return r}var dt=function(){function t(e){var n=this,r;this.actions=[],this.activities=wa,this.meta={},this.events=[],this.value=e.value,this.context=e.context,this._event=e._event,this._sessionid=e._sessionid,this.event=this._event.data,this.historyValue=e.historyValue,this.history=e.history,this.actions=e.actions||[],this.activities=e.activities||wa,this.meta=Pp(e.configuration),this.events=e.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=e.configuration,this.transitions=e.transitions,this.children=e.children,this.done=!!e.done,this.tags=(r=Array.isArray(e.tags)?new Set(e.tags):e.tags)!==null&&r!==void 0?r:new Set,this.machine=e.machine,Object.defineProperty(this,"nextEvents",{get:function(){return Kp(n.configuration)}})}return t.from=function(e,n){if(e instanceof t)return e.context!==n?new t({value:e.value,context:n,_event:e._event,_sessionid:null,historyValue:e.historyValue,history:e.history,actions:[],activities:e.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):e;var r=zt;return new t({value:e,context:n,_event:r,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},t.create=function(e){return new t(e)},t.inert=function(e,n){if(e instanceof t){if(!e.actions.length)return e;var r=zt;return new t({value:e.value,context:n,_event:r,_sessionid:null,historyValue:e.historyValue,history:e.history,activities:e.activities,configuration:e.configuration,transitions:[],children:{}})}return t.from(e,n)},t.prototype.toStrings=function(e,n){var r=this;if(e===void 0&&(e=this.value),n===void 0&&(n="."),L(e))return[e];var i=Object.keys(e);return i.concat.apply(i,Y([],j(i.map(function(o){return r.toStrings(e[o],n).map(function(s){return o+n+s})})),!1))},t.prototype.toJSON=function(){var e=this;e.configuration,e.transitions;var n=e.tags;e.machine;var r=xr(e,["configuration","transitions","tags","machine"]);return g(g({},r),{tags:Array.from(n)})},t.prototype.matches=function(e){return Nr(e,this.value)},t.prototype.hasTag=function(e){return this.tags.has(e)},t.prototype.can=function(e){var n;mp(!!this.machine);var r=(n=this.machine)===null||n===void 0?void 0:n.getTransitionData(this,e);return!!r?.transitions.length&&r.transitions.some(function(i){return i.target!==void 0||i.actions.length})},t}(),Up={deferEvents:!1},Ha=function(){function t(e){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=g(g({},Up),e)}return t.prototype.initialize=function(e){if(this.initialized=!0,e){if(!this.options.deferEvents){this.schedule(e);return}this.process(e)}this.flushEvents()},t.prototype.schedule=function(e){if(!this.initialized||this.processingEvent){this.queue.push(e);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(e),this.flushEvents()},t.prototype.clear=function(){this.queue=[]},t.prototype.flushEvents=function(){for(var e=this.queue.shift();e;)this.process(e),e=this.queue.shift()},t.prototype.process=function(e){this.processingEvent=!0;try{e()}catch(n){throw this.clear(),n}finally{this.processingEvent=!1}},t}(),Vr=new Map,$p=0,Me={bookId:function(){return"x:".concat($p++)},register:function(t,e){return Vr.set(t,e),t},get:function(t){return Vr.get(t)},free:function(t){Vr.delete(t)}};function Kr(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof mu<"u")return mu}function Yp(){var t=Kr();if(t&&"__xstate__"in t)return t.__xstate__}function Gp(t){if(Kr()){var e=Yp();e&&e.register(t)}}function Fp(t,e){e===void 0&&(e={});var n=t.initialState,r=new Set,i=[],o=!1,s=function(){if(!o){for(o=!0;i.length>0;){var u=i.shift();n=t.transition(n,u,c),r.forEach(function(h){return h.next(n)})}o=!1}},a=Cp({id:e.id,send:function(u){i.push(u),s()},getSnapshot:function(){return n},subscribe:function(u,h,l){var d=fn(u,h,l);return r.add(d),d.next(n),{unsubscribe:function(){r.delete(d)}}}}),c={parent:e.parent,self:a,id:e.id||"anonymous",observers:r};return n=t.start?t.start(c):n,a}var zp={sync:!1,autoForward:!1},z;(function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"})(z||(z={}));var Wp=function(){function t(e,n){n===void 0&&(n=t.defaultOptions);var r=this;this.machine=e,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=z.NotStarted,this.children=new Map,this.forwardTo=new Set,this._outgoingQueue=[],this.init=this.start,this.send=function(h,l){if(Yt(h))return r.batch(h),r.state;var d=J(ln(h,l));if(r.status===z.Stopped)return r.state;if(r.status!==z.Running&&!r.options.deferEvents)throw new Error('Event "'.concat(d.name,'" was sent to uninitialized service "').concat(r.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(d.data)));return r.scheduler.schedule(function(){r.forward(d);var f=r._nextState(d);r.update(f,d)}),r._state},this.sendTo=function(h,l,d){var f=r.parent&&(l===$t.Parent||r.parent.id===l),v=f?r.parent:L(l)?l===$t.Internal?r:r.children.get(l)||Me.get(l):bp(l)?l:void 0;if(!v){if(!f)throw new Error("Unable to send event to child '".concat(l,"' from service '").concat(r.id,"'."));return}if("machine"in v){if(r.status!==z.Stopped||r.parent!==v||r.state.done){var y=g(g({},h),{name:h.name===sp?"".concat(xe(r.id)):h.name,origin:r.sessionId});!d&&r.machine.config.predictableActionArguments?r._outgoingQueue.push([v,y]):v.send(y)}}else!d&&r.machine.config.predictableActionArguments?r._outgoingQueue.push([v,h.data]):v.send(h.data)},this._exec=function(h,l,d,f){f===void 0&&(f=r.machine.options.actions);var v=h.exec||Dr(h.type,f),y=D(v)?v:v?v.exec:h.exec;if(y)try{return y(l,d.data,r.machine.config.predictableActionArguments?{action:h,_event:d}:{action:h,state:r.state,_event:d})}catch(X){throw r.parent&&r.parent.send({type:"xstate.error",data:X}),X}switch(h.type){case Ee:{var E=h;r.defer(E);break}case cn:var m=h;if(typeof m.delay=="number"){r.defer(m);return}else m.to?r.sendTo(m._event,m.to,d===zt):r.send(m._event);break;case ga:r.cancel(h.sendId);break;case Sr:{if(r.status!==z.Running)return;var I=h.activity;if(!r.machine.config.predictableActionArguments&&!r.state.activities[I.id||I.type])break;if(I.type===K.Invoke){var x=Ta(I.src),k=r.machine.options.services?r.machine.options.services[x.type]:void 0,A=I.id,C=I.data,T="autoForward"in I?I.autoForward:!!I.forward;if(!k)return;var p=C?hn(C,l,d):void 0;if(typeof k=="string")return;var w=D(k)?k(l,d.data,{data:p,src:x,meta:I.meta}):k;if(!w)return;var R=void 0;Gt(w)&&(w=p?w.withContext(p):w,R={autoForward:T}),r.spawn(w,A,R)}else r.spawnActivity(I);break}case kr:{r.stopChild(h.activity.id);break}case ba:var S=h,O=S.label,V=S.value;O?r.logger(O,V):r.logger(V);break}};var i=g(g({},t.defaultOptions),n),o=i.clock,s=i.logger,a=i.parent,c=i.id,u=c!==void 0?c:e.id;this.id=u,this.logger=s,this.clock=o,this.parent=a,this.options=i,this.scheduler=new Ha({deferEvents:this.options.deferEvents}),this.sessionId=Me.bookId()}return Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this;return this._initialState?this._initialState:Wt(this,function(){return e._initialState=e.machine.initialState,e._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),t.prototype.execute=function(e,n){var r,i;try{for(var o=N(e.actions),s=o.next();!s.done;s=o.next()){var a=s.value;this.exec(a,e,n)}}catch(c){r={error:c}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}},t.prototype.update=function(e,n){var r,i,o,s,a,c,u,h,l=this;if(e._sessionid=this.sessionId,this._state=e,(!this.machine.config.predictableActionArguments||n===zt)&&this.options.execute)this.execute(this.state);else for(var d=void 0;d=this._outgoingQueue.shift();)d[0].send(d[1]);if(this.children.forEach(function(w){l.state.children[w.id]=w}),this.devTools&&this.devTools.send(n.data,e),e.event)try{for(var f=N(this.eventListeners),v=f.next();!v.done;v=f.next()){var y=v.value;y(e.event)}}catch(w){r={error:w}}finally{try{v&&!v.done&&(i=f.return)&&i.call(f)}finally{if(r)throw r.error}}try{for(var E=N(this.listeners),m=E.next();!m.done;m=E.next()){var y=m.value;y(e,e.event)}}catch(w){o={error:w}}finally{try{m&&!m.done&&(s=E.return)&&s.call(E)}finally{if(o)throw o.error}}try{for(var I=N(this.contextListeners),x=I.next();!x.done;x=I.next()){var k=x.value;k(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(w){a={error:w}}finally{try{x&&!x.done&&(c=I.return)&&c.call(I)}finally{if(a)throw a.error}}if(this.state.done){var A=e.configuration.find(function(w){return w.type==="final"&&w.parent===l.machine}),C=A&&A.doneData?hn(A.doneData,e.context,n):void 0;this._doneEvent=vn(this.id,C);try{for(var T=N(this.doneListeners),p=T.next();!p.done;p=T.next()){var y=p.value;y(this._doneEvent)}}catch(w){u={error:w}}finally{try{p&&!p.done&&(h=T.return)&&h.call(T)}finally{if(u)throw u.error}}this._stop(),this._stopChildren(),Me.free(this.sessionId)}},t.prototype.onTransition=function(e){return this.listeners.add(e),this.status===z.Running&&e(this.state,this.state.event),this},t.prototype.subscribe=function(e,n,r){var i=this,o=fn(e,n,r);this.listeners.add(o.next),this.status!==z.NotStarted&&o.next(this.state);var s=function(){i.doneListeners.delete(s),i.stopListeners.delete(s),o.complete()};return this.status===z.Stopped?o.complete():(this.onDone(s),this.onStop(s)),{unsubscribe:function(){i.listeners.delete(o.next),i.doneListeners.delete(s),i.stopListeners.delete(s)}}},t.prototype.onEvent=function(e){return this.eventListeners.add(e),this},t.prototype.onSend=function(e){return this.sendListeners.add(e),this},t.prototype.onChange=function(e){return this.contextListeners.add(e),this},t.prototype.onStop=function(e){return this.stopListeners.add(e),this},t.prototype.onDone=function(e){return this.status===z.Stopped&&this._doneEvent?e(this._doneEvent):this.doneListeners.add(e),this},t.prototype.off=function(e){return this.listeners.delete(e),this.eventListeners.delete(e),this.sendListeners.delete(e),this.stopListeners.delete(e),this.doneListeners.delete(e),this.contextListeners.delete(e),this},t.prototype.start=function(e){var n=this;if(this.status===z.Running)return this;this.machine._init(),Me.register(this.sessionId,this),this.initialized=!0,this.status=z.Running;var r=e===void 0?this.initialState:Wt(this,function(){return Bp(e)?n.machine.resolveState(e):n.machine.resolveState(dt.from(e,n.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){n.update(r,zt)}),this},t.prototype._stopChildren=function(){this.children.forEach(function(e){D(e.stop)&&e.stop()}),this.children.clear()},t.prototype._stop=function(){var e,n,r,i,o,s,a,c,u,h;try{for(var l=N(this.listeners),d=l.next();!d.done;d=l.next()){var f=d.value;this.listeners.delete(f)}}catch(T){e={error:T}}finally{try{d&&!d.done&&(n=l.return)&&n.call(l)}finally{if(e)throw e.error}}try{for(var v=N(this.stopListeners),y=v.next();!y.done;y=v.next()){var f=y.value;f(),this.stopListeners.delete(f)}}catch(T){r={error:T}}finally{try{y&&!y.done&&(i=v.return)&&i.call(v)}finally{if(r)throw r.error}}try{for(var E=N(this.contextListeners),m=E.next();!m.done;m=E.next()){var f=m.value;this.contextListeners.delete(f)}}catch(T){o={error:T}}finally{try{m&&!m.done&&(s=E.return)&&s.call(E)}finally{if(o)throw o.error}}try{for(var I=N(this.doneListeners),x=I.next();!x.done;x=I.next()){var f=x.value;this.doneListeners.delete(f)}}catch(T){a={error:T}}finally{try{x&&!x.done&&(c=I.return)&&c.call(I)}finally{if(a)throw a.error}}if(!this.initialized)return this;this.initialized=!1,this.status=z.Stopped,this._initialState=void 0;try{for(var k=N(Object.keys(this.delayedEventsMap)),A=k.next();!A.done;A=k.next()){var C=A.value;this.clock.clearTimeout(this.delayedEventsMap[C])}}catch(T){u={error:T}}finally{try{A&&!A.done&&(h=k.return)&&h.call(k)}finally{if(u)throw u.error}}this.scheduler.clear(),this.scheduler=new Ha({deferEvents:this.options.deferEvents})},t.prototype.stop=function(){var e=this,n=this.scheduler;return this._stop(),n.schedule(function(){var r;if(!(!((r=e._state)===null||r===void 0)&&r.done)){var i=J({type:"xstate.stop"}),o=Wt(e,function(){var s=G(Y([],j(e.state.configuration),!1).sort(function(l,d){return d.order-l.order}).map(function(l){return Et(l.onExit,e.machine.options.actions)})),a=j(mn(e.machine,e.state,e.state.context,i,[{type:"exit",actions:s}],e.machine.config.predictableActionArguments?e._exec:void 0,e.machine.config.predictableActionArguments||e.machine.config.preserveActionOrder),2),c=a[0],u=a[1],h=new dt({value:e.state.value,context:u,_event:i,_sessionid:e.sessionId,historyValue:void 0,history:e.state,actions:c.filter(function(l){return!jr(l)}),activities:{},events:[],configuration:[],transitions:[],children:{},done:e.state.done,tags:e.state.tags,machine:e.machine});return h.changed=!0,h});e.update(o,i),e._stopChildren(),Me.free(e.sessionId)}}),this},t.prototype.batch=function(e){var n=this;if(!(this.status===z.NotStarted&&this.options.deferEvents)&&this.status!==z.Running)throw new Error("".concat(e.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'));if(e.length){var r=!!this.machine.config.predictableActionArguments&&this._exec;this.scheduler.schedule(function(){var i,o,s=n.state,a=!1,c=[],u=function(f){var v=J(f);n.forward(v),s=Wt(n,function(){return n.machine.transition(s,v,void 0,r||void 0)}),c.push.apply(c,Y([],j(n.machine.config.predictableActionArguments?s.actions:s.actions.map(function(y){return Hp(y,s)})),!1)),a=a||!!s.changed};try{for(var h=N(e),l=h.next();!l.done;l=h.next()){var d=l.value;u(d)}}catch(f){i={error:f}}finally{try{l&&!l.done&&(o=h.return)&&o.call(h)}finally{if(i)throw i.error}}s.changed=a,s.actions=c,n.update(s,J(e[e.length-1]))})}},t.prototype.sender=function(e){return this.send.bind(this,e)},t.prototype._nextState=function(e,n){var r=this;n===void 0&&(n=!!this.machine.config.predictableActionArguments&&this._exec);var i=J(e);if(i.name.indexOf(Ea)===0&&!this.state.nextEvents.some(function(s){return s.indexOf(Ea)===0}))throw i.data.data;var o=Wt(this,function(){return r.machine.transition(r.state,i,void 0,n||void 0)});return o},t.prototype.nextState=function(e){return this._nextState(e,!1)},t.prototype.forward=function(e){var n,r;try{for(var i=N(this.forwardTo),o=i.next();!o.done;o=i.next()){var s=o.value,a=this.children.get(s);if(!a)throw new Error("Unable to forward event '".concat(e,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(s,"'."));a.send(e)}}catch(c){n={error:c}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}},t.prototype.defer=function(e){var n=this,r=this.clock.setTimeout(function(){"to"in e&&e.to?n.sendTo(e._event,e.to,!0):n.send(e._event)},e.delay);e.id&&(this.delayedEventsMap[e.id]=r)},t.prototype.cancel=function(e){this.clock.clearTimeout(this.delayedEventsMap[e]),delete this.delayedEventsMap[e]},t.prototype.exec=function(e,n,r){r===void 0&&(r=this.machine.options.actions),this._exec(e,n.context,n._event,r)},t.prototype.removeChild=function(e){var n;this.children.delete(e),this.forwardTo.delete(e),(n=this.state)===null||n===void 0||delete n.children[e]},t.prototype.stopChild=function(e){var n=this.children.get(e);n&&(this.removeChild(e),D(n.stop)&&n.stop())},t.prototype.spawn=function(e,n,r){if(this.status!==z.Running)return La(e,n);if(Oa(e))return this.spawnPromise(Promise.resolve(e),n);if(D(e))return this.spawnCallback(e,n);if(Lp(e))return this.spawnActor(e,n);if(gp(e))return this.spawnObservable(e,n);if(Gt(e))return this.spawnMachine(e,g(g({},r),{id:n}));if(pp(e))return this.spawnBehavior(e,n);throw new Error('Unable to spawn entity "'.concat(n,'" of type "').concat(typeof e,'".'))},t.prototype.spawnMachine=function(e,n){var r=this;n===void 0&&(n={});var i=new t(e,g(g({},this.options),{parent:this,id:n.id||e.id})),o=g(g({},zp),n);o.sync&&i.onTransition(function(a){r.send(Ia,{state:a,id:i.id})});var s=i;return this.children.set(i.id,s),o.autoForward&&this.forwardTo.add(i.id),i.onDone(function(a){r.removeChild(i.id),r.send(J(a,{origin:i.id}))}).start(),s},t.prototype.spawnBehavior=function(e,n){var r=Fp(e,{id:n,parent:this});return this.children.set(n,r),r},t.prototype.spawnPromise=function(e,n){var r,i=this,o=!1,s;e.then(function(c){o||(s=c,i.removeChild(n),i.send(J(vn(n,c),{origin:n})))},function(c){if(!o){i.removeChild(n);var u=xe(n,c);try{i.send(J(u,{origin:n}))}catch{i.devTools&&i.devTools.send(u,i.state),i.machine.strict&&i.stop()}}});var a=(r={id:n,send:function(){},subscribe:function(c,u,h){var l=fn(c,u,h),d=!1;return e.then(function(f){d||(l.next(f),!d&&l.complete())},function(f){d||l.error(f)}),{unsubscribe:function(){return d=!0}}},stop:function(){o=!0},toJSON:function(){return{id:n}},getSnapshot:function(){return s}},r[bt]=function(){return this},r);return this.children.set(n,a),a},t.prototype.spawnCallback=function(e,n){var r,i=this,o=!1,s=new Set,a=new Set,c,u=function(d){c=d,a.forEach(function(f){return f(d)}),!o&&i.send(J(d,{origin:n}))},h;try{h=e(u,function(d){s.add(d)})}catch(d){this.send(xe(n,d))}if(Oa(h))return this.spawnPromise(h,n);var l=(r={id:n,send:function(d){return s.forEach(function(f){return f(d)})},subscribe:function(d){var f=fn(d);return a.add(f.next),{unsubscribe:function(){a.delete(f.next)}}},stop:function(){o=!0,D(h)&&h()},toJSON:function(){return{id:n}},getSnapshot:function(){return c}},r[bt]=function(){return this},r);return this.children.set(n,l),l},t.prototype.spawnObservable=function(e,n){var r,i=this,o,s=e.subscribe(function(c){o=c,i.send(J(c,{origin:n}))},function(c){i.removeChild(n),i.send(J(xe(n,c),{origin:n}))},function(){i.removeChild(n),i.send(J(vn(n),{origin:n}))}),a=(r={id:n,send:function(){},subscribe:function(c,u,h){return e.subscribe(c,u,h)},stop:function(){return s.unsubscribe()},getSnapshot:function(){return o},toJSON:function(){return{id:n}}},r[bt]=function(){return this},r);return this.children.set(n,a),a},t.prototype.spawnActor=function(e,n){return this.children.set(n,e),e},t.prototype.spawnActivity=function(e){var n=this.machine.options&&this.machine.options.activities?this.machine.options.activities[e.type]:void 0;if(n){var r=n(this.state.context,e);this.spawnEffect(e.id,r)}},t.prototype.spawnEffect=function(e,n){var r;this.children.set(e,(r={id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:n||void 0,getSnapshot:function(){},toJSON:function(){return{id:e}}},r[bt]=function(){return this},r))},t.prototype.attachDev=function(){var e=Kr();if(this.options.devTools&&e){if(e.__REDUX_DEVTOOLS_EXTENSION__){var n=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=e.__REDUX_DEVTOOLS_EXTENSION__.connect(g(g({name:this.id,autoPause:!0,stateSanitizer:function(r){return{value:r.value,context:r.context,actions:r.actions}}},n),{features:g({jump:!1,skip:!1},n?n.features:void 0)}),this.machine),this.devTools.init(this.state)}Gp(this)}},t.prototype.toJSON=function(){return{id:this.id}},t.prototype[bt]=function(){return this},t.prototype.getSnapshot=function(){return this.status===z.NotStarted?this.initialState:this._state},t.defaultOptions={execute:!0,deferEvents:!0,clock:{setTimeout:function(e,n){return setTimeout(e,n)},clearTimeout:function(e){return clearTimeout(e)}},logger:console.log.bind(console),devTools:!1},t.interpret=Ua,t}();function Ua(t,e){var n=new Wp(t,e);return n}function Jp(t){if(typeof t=="string"){var e={type:t};return e.toString=function(){return t},e}return t}function En(t){return g(g({type:Mr},t),{toJSON:function(){t.onDone,t.onError;var e=xr(t,["onDone","onError"]);return g(g({},e),{type:Mr,src:Jp(t.src)})}})}var In="",Pr="#",Br="*",Jt={},qt=function(t){return t[0]===Pr},qp=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},Qp=function(){function t(e,n,r,i){r===void 0&&(r="context"in e?e.context:void 0);var o=this,s;this.config=e,this._context=r,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.tags=[],this.options=Object.assign(qp(),n),this.parent=i?.parent,this.key=this.config.key||i?.key||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:_a),this.id=this.config.id||Y([this.machine.key],j(this.path),!1).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.schema=this.parent?this.machine.schema:(s=this.config.schema)!==null&&s!==void 0?s:{},this.description=this.config.description,this.initial=this.config.initial,this.states=this.config.states?_e(this.config.states,function(u,h){var l,d=new t(u,{},void 0,{parent:o,key:h});return Object.assign(o.idMap,g((l={},l[d.id]=d,l),d.idMap)),d}):Jt;var a=0;function c(u){var h,l;u.order=a++;try{for(var d=N(Ca(u)),f=d.next();!f.done;f=d.next()){var v=f.value;c(v)}}catch(y){h={error:y}}finally{try{f&&!f.done&&(l=d.return)&&l.call(d)}finally{if(h)throw h.error}}}c(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(u){var h=u.event;return h===In}):In in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=rt(this.config.entry||this.config.onEntry).map(function(u){return we(u)}),this.onExit=rt(this.config.exit||this.config.onExit).map(function(u){return we(u)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=rt(this.config.invoke).map(function(u,h){var l,d;if(Gt(u)){var f=pn(o.id,h);return o.machine.options.services=g((l={},l[f]=u,l),o.machine.options.services),En({src:f,id:f})}else if(L(u.src)){var f=u.id||pn(o.id,h);return En(g(g({},u),{id:f,src:u.src}))}else if(Gt(u.src)||D(u.src)){var f=u.id||pn(o.id,h);return o.machine.options.services=g((d={},d[f]=u.src,d),o.machine.options.services),En(g(g({id:f},u),{src:f}))}else{var v=u.src;return En(g(g({id:pn(o.id,h)},u),{src:v}))}}),this.activities=rt(this.config.activities).concat(this.invoke).map(function(u){return Lr(u)}),this.transition=this.transition.bind(this),this.tags=rt(this.config.tags)}return t.prototype._init=function(){this.__cache.transitions||Va(this).forEach(function(e){return e.on})},t.prototype.withConfig=function(e,n){var r=this.options,i=r.actions,o=r.activities,s=r.guards,a=r.services,c=r.delays;return new t(this.config,{actions:g(g({},i),e.actions),activities:g(g({},o),e.activities),guards:g(g({},s),e.guards),services:g(g({},a),e.services),delays:g(g({},c),e.delays)},n??this.context)},t.prototype.withContext=function(e){return new t(this.config,this.options,e)},Object.defineProperty(t.prototype,"context",{get:function(){return D(this._context)?this._context():this._context},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:_e(this.states,function(e){return e.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke,description:this.description,tags:this.tags}},enumerable:!1,configurable:!0}),t.prototype.toJSON=function(){return this.definition},Object.defineProperty(t.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var e=this.transitions;return this.__cache.on=e.reduce(function(n,r){return n[r.eventType]=n[r.eventType]||[],n[r.eventType].push(r),n},{})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),t.prototype.getCandidates=function(e){if(this.__cache.candidates[e])return this.__cache.candidates[e];var n=e===In,r=this.transitions.filter(function(i){var o=i.eventType===e;return n?o:o||i.eventType===Br});return this.__cache.candidates[e]=r,r},t.prototype.getDelayedTransitions=function(){var e=this,n=this.config.after;if(!n)return[];var r=function(o,s){var a=D(o)?"".concat(e.id,":delay[").concat(s,"]"):o,c=Np(a,e.id);return e.onEntry.push(wp(c,{delay:o})),e.onExit.push(kp(c)),c},i=Yt(n)?n.map(function(o,s){var a=r(o.delay,s);return g(g({},o),{event:a})}):G(Object.keys(n).map(function(o,s){var a=n[o],c=L(a)?{target:a}:a,u=isNaN(+o)?o:+o,h=r(u,s);return rt(c).map(function(l){return g(g({},l),{event:h,delay:u})})}));return i.map(function(o){var s=o.delay;return g(g({},e.formatTransition(o)),{delay:s})})},t.prototype.getStateNodes=function(e){var n,r=this;if(!e)return[];var i=e instanceof dt?e.value:Ie(e,this.delimiter);if(L(i)){var o=this.getStateNode(i).initial;return o!==void 0?this.getStateNodes((n={},n[i]=o,n)):[this,this.states[i]]}var s=Object.keys(i),a=[this];return a.push.apply(a,Y([],j(G(s.map(function(c){return r.getStateNode(c).getStateNodes(i[c])}))),!1)),a},t.prototype.handles=function(e){var n=xa(e);return this.events.includes(n)},t.prototype.resolveState=function(e){var n=e instanceof dt?e:dt.create(e),r=Array.from(ke([],this.getStateNodes(n.value)));return new dt(g(g({},n),{value:this.resolve(n.value),configuration:r,done:bn(r,this),tags:Pa(r),machine:this.machine}))},t.prototype.transitionLeafNode=function(e,n,r){var i=this.getStateNode(e),o=i.next(n,r);return!o||!o.transitions.length?this.next(n,r):o},t.prototype.transitionCompoundNode=function(e,n,r){var i=Object.keys(e),o=this.getStateNode(i[0]),s=o._transition(e[i[0]],n,r);return!s||!s.transitions.length?this.next(n,r):s},t.prototype.transitionParallelNode=function(e,n,r){var i,o,s={};try{for(var a=N(Object.keys(e)),c=a.next();!c.done;c=a.next()){var u=c.value,h=e[u];if(h){var l=this.getStateNode(u),d=l._transition(h,n,r);d&&(s[u]=d)}}}catch(m){i={error:m}}finally{try{c&&!c.done&&(o=a.return)&&o.call(a)}finally{if(i)throw i.error}}var f=Object.keys(s).map(function(m){return s[m]}),v=G(f.map(function(m){return m.transitions})),y=f.some(function(m){return m.transitions.length>0});if(!y)return this.next(n,r);var E=G(Object.keys(s).map(function(m){return s[m].configuration}));return{transitions:v,exitSet:G(f.map(function(m){return m.exitSet})),configuration:E,source:n,actions:G(Object.keys(s).map(function(m){return s[m].actions}))}},t.prototype._transition=function(e,n,r){return L(e)?this.transitionLeafNode(e,n,r):Object.keys(e).length===1?this.transitionCompoundNode(e,n,r):this.transitionParallelNode(e,n,r)},t.prototype.getTransitionData=function(e,n){return this._transition(e.value,e,J(n))},t.prototype.next=function(e,n){var r,i,o=this,s=n.name,a=[],c=[],u;try{for(var h=N(this.getCandidates(s)),l=h.next();!l.done;l=h.next()){var d=l.value,f=d.cond,v=d.in,y=e.context,E=v?L(v)&&qt(v)?e.matches(Ie(this.getStateNodeById(v).path,this.delimiter)):Nr(Ie(v,this.delimiter),hp(this.path.slice(0,-2))(e.value)):!0,m=!1;try{m=!f||Na(this.machine,f,y,n,e)}catch(k){throw new Error("Unable to evaluate guard '".concat(f.name||f.type,"' in transition for event '").concat(s,"' in state node '").concat(this.id,`':
`).concat(k.message))}if(m&&E){d.target!==void 0&&(c=d.target),a.push.apply(a,Y([],j(d.actions),!1)),u=d;break}}}catch(k){r={error:k}}finally{try{l&&!l.done&&(i=h.return)&&i.call(h)}finally{if(r)throw r.error}}if(u){if(!c.length)return{transitions:[u],exitSet:[],configuration:e.value?[this]:[],source:e,actions:a};var I=G(c.map(function(k){return o.getRelativeStateNodes(k,e.historyValue)})),x=!!u.internal;return{transitions:[u],exitSet:x?[]:G(c.map(function(k){return o.getPotentiallyReenteringNodes(k)})),configuration:I,source:e,actions:a}}},t.prototype.getPotentiallyReenteringNodes=function(e){if(this.order<e.order)return[this];for(var n=[],r=this,i=e;r&&r!==i;)n.push(r),r=r.parent;return r!==i?[]:(n.push(i),n)},t.prototype.getActions=function(e,n,r,i,o,s,a){var c,u,h,l,d=this,f=s?ke([],this.getStateNodes(s.value)):[],v=new Set;try{for(var y=N(Array.from(e).sort(function(S,O){return S.order-O.order})),E=y.next();!E.done;E=y.next()){var m=E.value;(!Oe(f,m)||Oe(r.exitSet,m)||m.parent&&v.has(m.parent))&&v.add(m)}}catch(S){c={error:S}}finally{try{E&&!E.done&&(u=y.return)&&u.call(y)}finally{if(c)throw c.error}}try{for(var I=N(f),x=I.next();!x.done;x=I.next()){var m=x.value;(!Oe(e,m)||Oe(r.exitSet,m.parent))&&r.exitSet.push(m)}}catch(S){h={error:S}}finally{try{x&&!x.done&&(l=I.return)&&l.call(I)}finally{if(h)throw h.error}}r.exitSet.sort(function(S,O){return O.order-S.order});var k=Array.from(v).sort(function(S,O){return S.order-O.order}),A=new Set(r.exitSet),C=G(k.map(function(S){var O=[];if(S.type!=="final")return O;var V=S.parent;if(!V.parent)return O;O.push(yn(S.id,S.doneData),yn(V.id,S.doneData?hn(S.doneData,i,o):void 0));var X=V.parent;return X.type==="parallel"&&Se(X).every(function(wt){return bn(r.configuration,wt)})&&O.push(yn(X.id)),O})),T=k.map(function(S){var O=S.onEntry,V=S.activities.map(function(X){return Op(X)});return{type:"entry",actions:Et(a?Y(Y([],j(O),!1),j(V),!1):Y(Y([],j(V),!1),j(O),!1),d.machine.options.actions)}}).concat({type:"state_done",actions:C.map(function(S){return Ip(S)})}),p=Array.from(A).map(function(S){return{type:"exit",actions:Et(Y(Y([],j(S.onExit),!1),j(S.activities.map(function(O){return Mp(O)})),!1),d.machine.options.actions)}}),w=p.concat({type:"transition",actions:Et(r.actions,this.machine.options.actions)}).concat(T);if(n){var R=Et(G(Y([],j(e),!1).sort(function(S,O){return O.order-S.order}).map(function(S){return S.onExit})),this.machine.options.actions).filter(function(S){return!jr(S)});return w.concat({type:"stop",actions:R})}return w},t.prototype.transition=function(e,n,r,i){e===void 0&&(e=this.initialState);var o=J(n),s;if(e instanceof dt)s=r===void 0?e:this.resolveState(dt.from(e,r));else{var a=L(e)?this.resolve(un(this.getResolvedPath(e))):this.resolve(e),c=r??this.machine.context;s=this.resolveState(dt.from(a,c))}if(this.strict&&!this.events.includes(o.name)&&!fp(o.name))throw new Error("Machine '".concat(this.id,"' does not accept event '").concat(o.name,"'"));var u=this._transition(s.value,s,o)||{transitions:[],configuration:[],exitSet:[],source:s,actions:[]},h=ke([],this.getStateNodes(s.value)),l=u.configuration.length?ke(h,u.configuration):h;return u.configuration=Y([],j(l),!1),this.resolveTransition(u,s,s.context,i,o)},t.prototype.resolveRaisedTransition=function(e,n,r,i){var o,s=e.actions;return e=this.transition(e,n,void 0,i),e._event=r,e.event=r.data,(o=e.actions).unshift.apply(o,Y([],j(s),!1)),e},t.prototype.resolveTransition=function(e,n,r,i,o){var s,a,c,u,h=this;o===void 0&&(o=zt);var l=e.configuration,d=!n||e.transitions.length>0,f=d?e.configuration:n?n.configuration:[],v=bn(f,this),y=d?Vp(this.machine,l):void 0,E=n?n.historyValue?n.historyValue:e.source?this.machine.historyValue(n.value):void 0:void 0,m=this.getActions(new Set(f),v,e,r,o,n,i),I=n?g({},n.activities):{};try{for(var x=N(m),k=x.next();!k.done;k=x.next()){var A=k.value;try{for(var C=(c=void 0,N(A.actions)),T=C.next();!T.done;T=C.next()){var p=T.value;p.type===Sr?I[p.activity.id||p.activity.type]=p:p.type===kr&&(I[p.activity.id||p.activity.type]=!1)}}catch(ot){c={error:ot}}finally{try{T&&!T.done&&(u=C.return)&&u.call(C)}finally{if(c)throw c.error}}}}catch(ot){s={error:ot}}finally{try{k&&!k.done&&(a=x.return)&&a.call(x)}finally{if(s)throw s.error}}var w=j(mn(this,n,r,o,m,i,this.machine.config.predictableActionArguments||this.machine.config.preserveActionOrder),2),R=w[0],S=w[1],O=j(yp(R,jr),2),V=O[0],X=O[1],wt=R.filter(function(ot){var ie;return ot.type===Sr&&((ie=ot.activity)===null||ie===void 0?void 0:ie.type)===Mr}),ne=wt.reduce(function(ot,ie){return ot[ie.activity.id]=jp(ie.activity,h.machine,S,o),ot},n?g({},n.children):{}),ht=new dt({value:y||n.value,context:S,_event:o,_sessionid:n?n._sessionid:null,historyValue:y?E?vp(E,y):void 0:n?n.historyValue:void 0,history:!y||e.source?n:void 0,actions:y?X:[],activities:y?I:n?n.activities:{},events:[],configuration:f,transitions:e.transitions,children:ne,done:v,tags:Pa(f),machine:this}),Tt=r!==S;ht.changed=o.name===Ia||Tt;var re=ht.history;re&&delete re.history;var uu=!v&&(this._transient||l.some(function(ot){return ot._transient}));if(!d&&(!uu||o.name===In))return ht;var it=ht;if(!v)for(uu&&(it=this.resolveRaisedTransition(it,{type:ip},o,i));V.length;){var ty=V.shift();it=this.resolveRaisedTransition(it,ty._event,o,i)}var ey=it.changed||(re?!!it.actions.length||Tt||typeof re.value!=typeof it.value||!Ba(it.value,re.value):void 0);return it.changed=ey,it.history=re,it},t.prototype.getStateNode=function(e){if(qt(e))return this.machine.getStateNodeById(e);if(!this.states)throw new Error("Unable to retrieve child state '".concat(e,"' from '").concat(this.id,"'; no child states exist."));var n=this.states[e];if(!n)throw new Error("Child state '".concat(e,"' does not exist on '").concat(this.id,"'"));return n},t.prototype.getStateNodeById=function(e){var n=qt(e)?e.slice(Pr.length):e;if(n===this.id)return this;var r=this.machine.idMap[n];if(!r)throw new Error("Child state node '#".concat(n,"' does not exist on machine '").concat(this.id,"'"));return r},t.prototype.getStateNodeByPath=function(e){if(typeof e=="string"&&qt(e))try{return this.getStateNodeById(e.slice(1))}catch{}for(var n=Tr(e,this.delimiter).slice(),r=this;n.length;){var i=n.shift();if(!i.length)break;r=r.getStateNode(i)}return r},t.prototype.resolve=function(e){var n,r=this;if(!e)return this.initialStateValue||Jt;switch(this.type){case"parallel":return _e(this.initialStateValue,function(o,s){return o?r.getStateNode(s).resolve(e[s]||o):Jt});case"compound":if(L(e)){var i=this.getStateNode(e);return i.type==="parallel"||i.type==="compound"?(n={},n[e]=i.initialStateValue,n):e}return Object.keys(e).length?_e(e,function(o,s){return o?r.getStateNode(s).resolve(o):Jt}):this.initialStateValue||{};default:return e||Jt}},t.prototype.getResolvedPath=function(e){if(qt(e)){var n=this.machine.idMap[e.slice(Pr.length)];if(!n)throw new Error("Unable to find state node '".concat(e,"'"));return n.path}return Tr(e,this.delimiter)},Object.defineProperty(t.prototype,"initialStateValue",{get:function(){var e;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var n;if(this.type==="parallel")n=Sa(this.states,function(r){return r.initialStateValue||Jt},function(r){return r.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '".concat(this.initial,"' not found on '").concat(this.key,"'"));n=gn(this.states[this.initial])?this.initial:(e={},e[this.initial]=this.states[this.initial].initialStateValue,e)}else n={};return this.__cache.initialStateValue=n,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),t.prototype.getInitialState=function(e,n){this._init();var r=this.getStateNodes(e);return this.resolveTransition({configuration:r,exitSet:[],transitions:[],source:void 0,actions:[]},void 0,n??this.machine.context,void 0)},Object.defineProperty(t.prototype,"initialState",{get:function(){var e=this.initialStateValue;if(!e)throw new Error("Cannot retrieve initial state from simple state '".concat(this.id,"'."));return this.getInitialState(e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){var e;if(this.type==="history"){var n=this.config;L(n.target)?e=qt(n.target)?un(this.machine.getStateNodeById(n.target).path.slice(this.path.length-1)):n.target:e=n.target}return e},enumerable:!1,configurable:!0}),t.prototype.getRelativeStateNodes=function(e,n,r){return r===void 0&&(r=!0),r?e.type==="history"?e.resolveHistory(n):e.initialStateNodes:[e]},Object.defineProperty(t.prototype,"initialStateNodes",{get:function(){var e=this;if(gn(this))return[this];if(this.type==="compound"&&!this.initial)return[this];var n=dn(this.initialStateValue);return G(n.map(function(r){return e.getFromRelativePath(r)}))},enumerable:!1,configurable:!0}),t.prototype.getFromRelativePath=function(e){if(!e.length)return[this];var n=j(e),r=n[0],i=n.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '".concat(r,"' from node with no states"));var o=this.getStateNode(r);if(o.type==="history")return o.resolveHistory();if(!this.states[r])throw new Error("Child state '".concat(r,"' does not exist on '").concat(this.id,"'"));return this.states[r].getFromRelativePath(i)},t.prototype.historyValue=function(e){if(Object.keys(this.states).length)return{current:e||this.initialStateValue,states:Sa(this.states,function(n,r){if(!e)return n.historyValue();var i=L(e)?void 0:e[r];return n.historyValue(i||n.initialStateValue)},function(n){return!n.history})}},t.prototype.resolveHistory=function(e){var n=this;if(this.type!=="history")return[this];var r=this.parent;if(!e){var i=this.target;return i?G(dn(i).map(function(s){return r.getFromRelativePath(s)})):r.initialStateNodes}var o=lp(r.path,"states")(e).current;return L(o)?[r.getStateNode(o)]:G(dn(o).map(function(s){return n.history==="deep"?r.getFromRelativePath(s):[r.states[s[0]]]}))},Object.defineProperty(t.prototype,"stateIds",{get:function(){var e=this,n=G(Object.keys(this.states).map(function(r){return e.states[r].stateIds}));return[this.id].concat(n)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"events",{get:function(){var e,n,r,i;if(this.__cache.events)return this.__cache.events;var o=this.states,s=new Set(this.ownEvents);if(o)try{for(var a=N(Object.keys(o)),c=a.next();!c.done;c=a.next()){var u=c.value,h=o[u];if(h.states)try{for(var l=(r=void 0,N(h.events)),d=l.next();!d.done;d=l.next()){var f=d.value;s.add("".concat(f))}}catch(v){r={error:v}}finally{try{d&&!d.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}}}catch(v){e={error:v}}finally{try{c&&!c.done&&(n=a.return)&&n.call(a)}finally{if(e)throw e.error}}return this.__cache.events=Array.from(s)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ownEvents",{get:function(){var e=new Set(this.transitions.filter(function(n){return!(!n.target&&!n.actions.length&&n.internal)}).map(function(n){return n.eventType}));return Array.from(e)},enumerable:!1,configurable:!0}),t.prototype.resolveTarget=function(e){var n=this;if(e!==void 0)return e.map(function(r){if(!L(r))return r;var i=r[0]===n.delimiter;if(i&&!n.parent)return n.getStateNodeByPath(r.slice(1));var o=i?n.key+r:r;if(n.parent)try{var s=n.parent.getStateNodeByPath(o);return s}catch(a){throw new Error("Invalid transition definition for state node '".concat(n.id,`':
`).concat(a.message))}else return n.getStateNodeByPath(o)})},t.prototype.formatTransition=function(e){var n=this,r=Ep(e.target),i="internal"in e?e.internal:r?r.some(function(c){return L(c)&&c[0]===n.delimiter}):!0,o=this.machine.options.guards,s=this.resolveTarget(r),a=g(g({},e),{actions:Et(rt(e.actions)),cond:Ra(e.cond,o),target:s,source:this,internal:i,eventType:e.event,toJSON:function(){return g(g({},a),{target:a.target?a.target.map(function(c){return"#".concat(c.id)}):void 0,source:"#".concat(n.id)})}});return a},t.prototype.formatTransitions=function(){var e,n,r=this,i;if(!this.config.on)i=[];else if(Array.isArray(this.config.on))i=this.config.on;else{var o=this.config.on,s=Br,a=o[s],c=a===void 0?[]:a,u=xr(o,[typeof s=="symbol"?s:s+""]);i=G(Object.keys(u).map(function(I){var x=Ft(I,u[I]);return x}).concat(Ft(Br,c)))}var h=this.config.always?Ft("",this.config.always):[],l=this.config.onDone?Ft(String(yn(this.id)),this.config.onDone):[],d=G(this.invoke.map(function(I){var x=[];return I.onDone&&x.push.apply(x,Y([],j(Ft(String(vn(I.id)),I.onDone)),!1)),I.onError&&x.push.apply(x,Y([],j(Ft(String(xe(I.id)),I.onError)),!1)),x})),f=this.after,v=G(Y(Y(Y(Y([],j(l),!1),j(d),!1),j(i),!1),j(h),!1).map(function(I){return rt(I).map(function(x){return r.formatTransition(x)})}));try{for(var y=N(f),E=y.next();!E.done;E=y.next()){var m=E.value;v.push(m)}}catch(I){e={error:I}}finally{try{E&&!E.done&&(n=y.return)&&n.call(y)}finally{if(e)throw e.error}}return v},t}();function Xp(t,e){return new Qp(t,e)}let Q,$a,Ae;Q=Rp,$a=Object.defineProperty,Ae=(t,e)=>{for(var n in e)$a(t,n,{get:e[n],enumerable:!0})},qi={},Ae(qi,{Connection:()=>Hi,buildError:()=>xn,connectionErrors:()=>ri,isInviteeClaim:()=>Mt,isInviteeContext:()=>Ve,isInviteeDeviceClaim:()=>iu,isInviteeDeviceContext:()=>Ni,isInviteeMemberClaim:()=>ji,isInviteeMemberContext:()=>Cn,isMemberClaim:()=>Vn,isMemberContext:()=>Ri,isServerContext:()=>Ti});let Hr,Ur,$r;Hr=t=>{const e=n=>{switch(n.type){case"ADD_MEMBER":return n.payload.member.userId;case"REMOVE_MEMBER":return n.payload.userId;case"ADD_ROLE":return n.payload.roleName;case"ADD_MEMBER_ROLE":case"REMOVE_MEMBER_ROLE":return`${n.payload.roleName}:${n.payload.userId}`;case"ADD_DEVICE":return n.payload.device.deviceName;case"REMOVE_DEVICE":return n.payload.deviceId;case"INVITE_MEMBER":case"INVITE_DEVICE":return n.payload.invitation.id;case"REVOKE_INVITATION":return n.payload.id;case"ADMIT_MEMBER":case"ADMIT_DEVICE":return n.payload.id;case"CHANGE_MEMBER_KEYS":return JSON.stringify(n.payload.keys);default:return JSON.stringify(n.payload)}};return t.body.type==="ROOT"?"ROOT":`${t.body.type}:${e(t.body)}`},Ur=(t,e)=>{if(!t||!e)return!1;const n=r=>r.sort().join(",");return n(t)===n(e)},$r=t=>!["INVITE_DEVICE","ADD_DEVICE","REMOVE_DEVICE","CHANGE_MEMBER_KEYS","CHANGE_SERVER_KEYS","ADMIT_MEMBER","ADMIT_DEVICE"].includes(t.type),eo={},Ae(eo,{ADMIN:()=>et});let Ya,Yr,Re,Gr,Fr,Ga,Fa,za,Wa,zr,Ja,Wr,Jr,qr,qa,Qa,_n,wn,Qr,Xr,Xa,Zr,Za,tc,ti,ec,nc,ei,ni,W,rc,ic,oc,ri,xn,sc,ii,ac,cc,uc,dc,hc,Sn,kn,On,lc,oi,si,fc,pc,yc,vc,ai,Mn,An,mc,gc,bc,ci,Ne,ui,Ec,di,Ic;et="admin",Ya=t=>(e,n)=>{if(Yr(t,e))return-1;if(Yr(t,n))return 1;const r=s=>{const a=u=>u.body.type==="ADD_MEMBER"&&u.body.payload.member.userId===s,c=Object.values(t.links).find(a);return _(c,`Could not find link that added member ${s}`),c},[i,o]=[e,n].map(r);return Pf(t,i,o)?-1:1},Yr=(t,e)=>t.links[t.root].body.userId===e,Re=t=>{const e=Ff(t).map(r=>r.map(i=>t.links[i])),n=[];for(let r of e)for(const i in Fr){const o=Fr[i],s=o(r,t),a=s.flatMap(c=>Gr(r,c));n.push(...s,...a),r=r.filter(Zr(n))}return{filter:Zr(n)}},Gr=(t,e)=>{const n=[];switch(e.body.type){case"INVITE_MEMBER":case"INVITE_DEVICE":{const{invitation:i}=e.body.payload;n.push(...t.filter(Za(i)));break}case"ADMIT_MEMBER":{const i=e.body.payload.memberKeys.name;n.push(...t.filter(Qr(i)));break}}const r=n.flatMap(i=>Gr(t,i));return n.concat(r)},Fr={resolveMutualRemovals(t,e){const n=qr(t),r=Jr(t).map(wn);return n.length>0&&Ur(n,r)?t.filter(Qr(Ga(e,r))):[]},cantAddBackRemovedMember(t){const e=qr(t);return Wa(t).filter(n=>e.includes(Xa(n)))},cantDoAnythingWhenRemoved(t){const e=qa(t);return t.filter(Xr(e))},cantDoAdminActionsWhenDemoted(t){const e=Qa(t),n=Xr(e),r=i=>$r(i.body);return t.filter(i=>n(i)&&r(i))}},Ga=(t,e)=>e.sort(Ya(t)).pop(),Fa=t=>["ADD_MEMBER","ADD_MEMBER_ROLE","ADMIT_MEMBER"].includes(t.body.type),za=t=>t.body.type==="REMOVE_MEMBER",Wa=t=>t.filter(Fa),zr=t=>t.filter(za),Ja=t=>t.body.type==="REMOVE_MEMBER_ROLE"&&t.body.payload.roleName===et,Wr=t=>t.filter(Ja),Jr=t=>zr(t).concat(Wr(t)),qr=t=>Jr(t).map(_n),qa=t=>zr(t).map(_n),Qa=t=>Wr(t).map(_n),_n=t=>t.body.payload.userId,wn=t=>t.body.userId,Qr=t=>e=>wn(e)===t,Xr=t=>e=>t.includes(wn(e)),Xa=t=>{switch(t.body.type){case"ADD_MEMBER":return t.body.payload.member.userId;case"ADD_MEMBER_ROLE":return t.body.payload.userId;case"ADMIT_MEMBER":return t.body.payload.memberKeys.name}},Zr=t=>e=>!t.includes(e),Za=t=>e=>(e.body.type==="ADMIT_MEMBER"||e.body.type==="ADMIT_DEVICE")&&e.body.payload.id===t.id,Iu=t=>gr(t,Re).filter(e=>!e.isInvalid).map(e=>Hr(e)).join(","),Wi="SIGNATURE",$i="ENCRYPTION",Ji="SYMMETRIC",Gi="LINK_HASH",Fi="LINK_TO_PREVIOUS",Yi="INVITATION",Ui="DEVICE_ID",zi="SHARED_KEY",Yn={SIGNATURE:Wi,ENCRYPTION:$i,SYMMETRIC:Ji,LINK_HASH:Gi,LINK_TO_PREVIOUS:Fi,INVITATION:Yi,DEVICE_ID:Ui,SHARED_KEY:zi},Z={isValid:!0},tc=t=>e=>t.reduce((n,r)=>r(n),e),ti=t=>({type:t.type,name:t.name}),ec=t=>`${t.recipient.name}(${nc(t.recipient.publicKey)}):${t.contents.name}#${t.contents.generation}`,nc=t=>t.slice(0,5),ei=(t,e)=>t.type===e.type&&t.name===e.name,ni=(t,e)=>{_(ei(t,e),`The scope of the new keys must match those of the old lockbox. 
     New scope: ${JSON.stringify(ti(t))} 
     Old scope: ${JSON.stringify(ti(e))}`)},W={GRAPH:"GRAPH",TEAM:"TEAM",ROLE:"ROLE",USER:"USER",DEVICE:"DEVICE",SERVER:"SERVER",EPHEMERAL:"EPHEMERAL"},rc=class extends Error{constructor(e,n){super();b(this,"name");b(this,"details");this.message=e,this.details=n}},ic=(t,e)=>{const n=typeof t=="string"?yu.decode(t):t,r=typeof e=="string"?yu.decode(e):e,i=[n,r].sort(oc).reduce((o,s)=>new Uint8Array([...o,...s]),new Uint8Array);return(typeof t=="string"?St:cy)(Yn.SHARED_KEY,i)},oc=(t,e)=>{const n=t.toString(),r=e.toString();return n<r?-1:n>r?1:0},ri={MEMBER_UNKNOWN:{localMessage:"The peer is not a member of this team",remoteMessage:"You are not a member of this team"},MEMBER_REMOVED:{localMessage:"The peer was removed from this team",remoteMessage:"You were removed from this team"},DEVICE_UNKNOWN:{localMessage:"The peer's device isn't listed on this team",remoteMessage:"Your device isn't listed on this team"},DEVICE_REMOVED:{localMessage:"The peer's device was removed from this team",remoteMessage:"Your device was removed from this team"},NEITHER_IS_MEMBER:{localMessage:"The peer is also holding an invitation and cannot admit you to the team",remoteMessage:"The peer is also holding an invitation and cannot admit you to the team"},IDENTITY_PROOF_INVALID:{localMessage:"The peer's proof of identity is not valid",remoteMessage:"Your proof of identity isn't valid"},INVITATION_PROOF_INVALID:{localMessage:"The peer's invitation wasn't accepted",remoteMessage:"Your invitation wasn't accepted"},JOINED_WRONG_TEAM:{localMessage:"This isn't the team you were invited to",remoteMessage:"This isn't the team the peer was invited to"},TIMEOUT:{localMessage:"We didn't hear back from the peer; giving up",remoteMessage:"The peer didn't hear back from us, so they gave up"}},xn=(t,e,n="LOCAL")=>{const{localMessage:r,remoteMessage:i}=ri[t];return{type:n==="LOCAL"?"LOCAL_ERROR":"ERROR",payload:{type:t,message:n==="LOCAL"?r:i,details:e}}},sc=t=>{const e=sn(t),{encryptedLinks:n,head:r,root:i}=t,o=Ki({encryptedLinks:n,childMap:e,head:r,root:i});return uc(o)},ii=(t,e)=>{const n=Pi(t);return yr({encryptedGraph:n,keys:e})},ac=(t,e)=>cc(t)?t:ii(t,e),cc=t=>t?.hasOwnProperty("root"),uc=t=>new Uint8Array(t.buffer,t.byteOffset,t.byteLength),kt="ALL",Ct={head:[],teamName:"",members:[],servers:[],roles:[],lockboxes:[],invitations:{},messages:[],removedMembers:[],removedDevices:[],removedServers:[],pendingKeyRotations:[]},ce={type:W.TEAM,name:W.TEAM},Bi={type:W.ROLE,name:et},gu={type:W.EPHEMERAL,name:W.EPHEMERAL},dc=(t,e)=>{switch(e.body.type){case"ADMIT_MEMBER":{const n=e.body.payload.memberKeys,r=n.name,i={userName:"",userId:r,keys:n,roles:[]},o=[...t.removedMembers,i],s=[...t.pendingKeyRotations];return s.includes(r)||s.push(r),{...t,removedMembers:o,pendingKeyRotations:s}}}return t},hc=t=>e=>({...e,head:[t.hash]}),Sn=t=>e=>{const{userId:n}=t;return{...e,members:e.members.map(r=>{if(r.userId===n){const{devices:i=[]}=r;return i.find(o=>o.deviceId===t.deviceId)?r:{...r,devices:[...i,t]}}return r}),removedDevices:e.removedDevices.filter(r=>r.keys.name===t.deviceId)}},kn=t=>e=>({...e,members:[...e.members,{...t,roles:[]}],removedMembers:e.removedMembers.filter(n=>n.userId===t.userId)}),On=(t,e=[])=>e.map(n=>r=>({...r,members:r.members.map(i=>({...i,roles:i.userId!==t||i.roles.includes(n)?i.roles:[...i.roles,n]}))})),lc=t=>e=>({...e,messages:[...e.messages,t]}),oi=t=>e=>({...e,roles:[...e.roles,t]}),si=pf,fc=t=>e=>({...e,servers:si([...e.servers,t]),removedServers:e.removedServers.filter(n=>n.host!==t.host)}),pc=t=>e=>({...e,members:e.members.map(n=>n.userId===t.name?{...n,keys:t}:n)}),yc=t=>e=>({...e,servers:e.servers.map(n=>n.host===t.name?{...n,keys:t}:n)}),vc=t=>e=>{const{lockboxes:n}=e;return t?{...e,lockboxes:n.concat(t)}:e},ai=t=>e=>{const n={...t,uses:0,revoked:!1};return{...e,invitations:{...e.invitations,[t.id]:n}}},Mn=(t,e,n={includeRemoved:!1})=>{const r=[...t.servers,...n.includeRemoved?t.removedServers:[]].find(i=>i.host===e);if(r===void 0)throw new Error(`A server with host '${e}' was not found`);return r},An=(t,e)=>t.servers.find(n=>n.host===e)!==void 0,mc=t=>({userId:t.host,userName:t.host,keys:t.keys,roles:[]}),gc=t=>({userId:t.host,userName:t.host,keys:t.keys}),bc=t=>({userId:t.host,deviceName:t.host,deviceId:t.host,keys:t.keys}),Lt={toMember:mc,toUser:gc,toDevice:bc},ci=(t,e,n={includeRemoved:!1})=>ui(t,e,n)!==void 0,Ne=(t,e,n={includeRemoved:!1})=>{const r=ui(t,e,n);return _(r,`Device ${e} not found`),r},ui=(t,e,n={includeRemoved:!1})=>An(t,e)?Lt.toDevice(Mn(t,e)):t.members.concat(n.includeRemoved?t.removedMembers:[]).flatMap(r=>r.devices??[]).find(r=>r.deviceId===e)??(n.includeRemoved?t.removedDevices.find(r=>r.deviceId===e):void 0),Ec=(t,e)=>ci(t,e,{includeRemoved:!0})?t.removedDevices.some(n=>n.keys.name===e):!1,di=(t,e)=>t.members.find(n=>n.userId===e)!==void 0,Ic=(t,e)=>t.roles.find(n=>n.roleName===e)!==void 0;function hi(t,e){return e in t.invitations}function li(t,e){return _(hi(t,e),`No invitation with id '${e}' found.`),t.invitations[e]}let fi,nt,_c,wc,pi,yi,xc,Rn,Sc,kc,Te,vi,mi,je,Oc,gi,Mc,Ac,Rc,Nc,bi,Tc,Ei,jc,Dc,Lc,Cc,Vc,Kc,Pc,Ii,_i;fi=t=>t.hasOwnProperty("publicKey"),nt=(t,e)=>{const n=fi(e)?e:ft(e),r=ft(t),i=vt.keyPair(),o=fi(n)?n.publicKey:n.encryption,s=vt.encryptBytes({secret:t,recipientPublicKey:o,senderSecretKey:i.secretKey});return{encryptionKey:{...Ys,publicKey:i.publicKey},recipient:{...n,publicKey:o},contents:{...r,publicKey:t.encryption.publicKey},encryptedPayload:s}},_c=yt((t,e)=>{const{encryptionKey:n,encryptedPayload:r}=t;return vt.decryptBytes({cipher:r,senderPublicKey:n.publicKey,recipientSecretKey:e.encryption.secretKey})}),wc=({oldLockbox:t,newContents:e,updatedRecipientKeys:n})=>{ni(e,t.contents),n&&ni(t.recipient,n),e.generation=t.contents.generation+1;const r=n??t.recipient;return nt(e,r)},pi=(t,e)=>{const{lockboxes:n}=t,{publicKey:r}=e.encryption,i=n.filter(({recipient:s})=>s.publicKey===r).map(s=>_c(s,e)),o=i.flatMap(s=>pi(t,s));return[...i,...o]},yi=(t,e)=>pi(t,e).reduce(xc,{}),xc=(t,e)=>{const{type:n,name:r,generation:i}=e,o=t[n]??{},s=o[r]??[];return s[i]=e,{...t,[n]:{...o,[r]:s}}},Rn=(t,e,n)=>{const{type:r,name:i}=n,o=yi(t,e),s=o[r]?o[r][i]:void 0;_(s,`Couldn't find keys: ${JSON.stringify(n)}
     Device: ${e.name}
     Available lockboxes: 
- ${t.lockboxes.map(ec).join(`
- `)} 
     Keymap: ${JSON.stringify(o,null,2)}`);const a="generation"in n&&n.generation!==void 0?n.generation:s.length-1;return s[a]},Sc=(t,e)=>{const n=t.lockboxes.filter(({contents:i})=>i.type===e.type&&i.name===e.name),r=n.reduce(kc,0);return n.filter(({contents:i})=>i.generation===r)},kc=(t,e)=>{const{generation:n}=e.contents;return n>t?n:t},Te=(t,e,n={includeRemoved:!1})=>{const r=[...t.members,...n.includeRemoved?t.removedMembers:[]].find(i=>i.userId===e);if(r===void 0)throw new Error(`A member named '${e}' was not found`);return r},vi=(t,e,n={includeRemoved:!1})=>{if(An(t,e))return Lt.toMember(Mn(t,e));const{userId:r}=Ne(t,e,n);return Te(t,r,n)},mi=(t,e,n)=>{if(!di(t,e))return!1;const r=Te(t,e),{roles:i=[]}=r;return i.includes(n)},je=(t,e)=>mi(t,e,et),Oc=(t,e)=>t.removedMembers.some(n=>n.userId===e),gi=(t,e)=>t.members.filter(n=>n.roles?.includes(e)),Mc=t=>gi(t,et),Ac=t=>t.messages,Rc=(t,e)=>{const n=t.roles.find(r=>r.roleName===e);if(!n)throw new Error(`A role called '${e}' was not found`);return n},Nc=(t,e)=>t.removedServers.some(n=>n.host===e),{TEAM:bi}=W,Tc=(t,e)=>{const n=yi(t,e)[bi][bi];return Ut(n)},Ei=(t,{type:e,name:n})=>{const r=t.lockboxes.filter(({recipient:s})=>s.type===e&&s.name===n).map(({contents:{type:s,name:a}})=>({type:s,name:a})),i=r.flatMap(s=>Ei(t,s)),o=[...r,...i];return si(o,s=>s.name+s.type)},jc=t=>e=>{const n=Ne(e,t),{userId:r}=vi(e,t),i=a=>a.userId===r?{...a,devices:a.devices?.filter(c=>c.deviceName!==n.deviceName)}:a,o=e.members.map(i),s=[...e.removedDevices,n];return{...e,members:o,removedDevices:s}},Dc=t=>e=>{const n=e.members.filter(o=>o.userId!==t),r=e.members.find(o=>o.userId===t),i=[...e.removedMembers];return r&&i.push(r),{...e,members:n,removedMembers:i}},Lc=(t,e)=>n=>({...n,members:n.members.map(r=>({...r,roles:r.userId===t?r.roles.filter(i=>i!==e):r.roles})),lockboxes:n.lockboxes.filter(r=>!(r.recipient.name===t&&r.contents.type===W.ROLE&&r.contents.name===e))}),Cc=t=>e=>({...e,roles:e.roles.filter(n=>n.roleName!==t),lockboxes:e.lockboxes.filter(n=>!(n.contents.type===W.ROLE&&n.contents.name===t))}),Vc=t=>e=>{const n=e.servers.filter(o=>o.host!==t),r=e.servers.find(o=>o.host===t),i=[...e.removedServers];return r&&i.push(r),{...e,servers:n,removedServers:i}},Kc=t=>e=>{const n={...e.invitations},r={...n[t],revoked:!0};return{...e,invitations:{...n,[t]:r}}},Pc=t=>e=>{const n=e.pendingKeyRotations.filter(r=>r!==t);return{...e,pendingKeyRotations:n}},Ii=t=>e=>({...e,teamName:t}),_i=t=>e=>{const n={...e.invitations},r=n[t],i=r.uses+1;return{...e,invitations:{...n,[t]:{...r,uses:i}}}},Zi={},Ae(Zi,{IKEY_LENGTH:()=>wi,InvitationValidationError:()=>Si,create:()=>Nn,fail:()=>It,generateProof:()=>Gn,generateStarterKeys:()=>Le,invitationCanBeUsed:()=>jn,randomSeed:()=>Tn,validate:()=>xi});var De=t=>t.toLowerCase().replaceAll(/[^a-z\d]/gi,""),Le=yt(t=>(t=De(t),lt(Ys,t)));function Bc(t){const e=fu(t);return St(Yn.INVITATION,e).slice(0,15)}let wi,Nn,Tn,jn,xi,It,Si,Hc,Uc,ki,Qt,Ce,$c;wi=16,Nn=({seed:t,maxUses:e=1,expiration:n=0,userId:r})=>{t=De(t);const i=Bc(t),o=Le(t),{publicKey:s}=o.signature;return{id:i,publicKey:s,expiration:n,maxUses:e,userId:r}},Tn=(t=wi)=>ae(t),Gn=yt(t=>{t=De(t);const e=Bc(t),n=Le(t),r={id:e},i=xt.sign(r,n.signature.secretKey);return{id:e,signature:i}}),jn=(t,e)=>{const{revoked:n,maxUses:r,uses:i,expiration:o}=t;return n?It("The invitation has been revoked"):r>0&&i>=r?It("The invitation cannot be used again"):o>0&&o<e?It("The invitation has expired"):Z},xi=yt((t,e)=>{const{id:n,signature:r}=t;if(n!==e.id)return It("IDs don't match",{proof:t,invitation:e});const{publicKey:i}=e;return xt.verify({payload:{id:n},signature:r,publicKey:i})?Z:It("Signature provided is not valid",{proof:t,invitation:e})}),It=(t,e)=>({isValid:!1,error:new Si(t,e)}),Si=class extends Error{constructor(e,n){super();b(this,"index");b(this,"details");this.name="Invitation validation failed",this.message=e,this.details=n}},Hc=Un.extend("auth:validate"),Uc=(...t)=>{for(const e in ki){const n=ki[e],r=n(...t);if(!r.isValid)return r}return Z},ki={rootDeviceBelongsToRootUser(...t){const[e,n]=t,{type:r,payload:i}=n.body;if(r!=="ROOT")return Z;const{rootDevice:o,rootMember:s}=i;return o.userId!==s.userId?Qt("The founding device must belong to the founding member (userIds must match).",...t):Z},mustBeAdmin(...t){const[e,n]=t,r=n.body,{type:i,userId:o}=r;return i===Ze?Z:$r(r)&&!je(e,o)?Qt(`Member '${o}' is not an admin`,...t):Z},canOnlyRemoveYourOwnDevices(...t){const[e,n]=t,r=n.body.userId;if(je(e,r))return Z;if(n.body.type==="REMOVE_DEVICE"){const i=n.body.payload.deviceId,o=Ne(e,i).userId;if(r!==o)return Qt("Can't remove another user's device.",...t)}return Z},canOnlyChangeYourOwnKeys(...t){const[e,n]=t,r=n.body.userId;if(!je(e,r)){if(n.body.type==="CHANGE_MEMBER_KEYS"){const i=n.body.payload.keys.name;if(r!==i)return Qt("Can't change another user's keys.",...t)}else if(n.body.type==="CHANGE_SERVER_KEYS"){const i=n.body.payload.keys.name;if(r!==i)return Qt("Can't change another server's keys.",...t)}}return Z},cantAdmitWithInvalidInvitation(...t){const[e,n]=t;if(n.body.type==="ADMIT_MEMBER"||n.body.type==="ADMIT_DEVICE"){const{id:r}=n.body.payload,i=li(e,r);return jn(i,n.body.timestamp)}return Z}},Qt=(t,e,n)=>(t=pu(`${Hr(n)} ${t}`),Hc(t),{isValid:!1,error:new rc(t,{prevState:e,link:n})}),Ce=(t,e)=>{if(e.isInvalid)return dc(t,e);t=bl(t);const n=Uc(t,e);if(!n.isValid)throw n.error;const r=e.body;return tc([hc(e),vc(r.payload.lockboxes),...$c(r)])(t)},$c=t=>{switch(t.type){case Ze:{const{name:e,rootMember:n,rootDevice:r}=t.payload;return[Ii(e),oi({roleName:et}),kn(n),Sn(r),...On(n.userId,[et])]}case"ADD_MEMBER":{const{member:e,roles:n}=t.payload;return[kn(e),...On(e.userId,n)]}case"ADD_ROLE":{const e=t.payload;return[oi(e)]}case"ADD_MEMBER_ROLE":{const{userId:e,roleName:n}=t.payload;return[...On(e,[n])]}case"REMOVE_MEMBER":{const{userId:e}=t.payload;return[Dc(e)]}case"ADD_DEVICE":{const{device:e}=t.payload;return[Sn(e)]}case"REMOVE_DEVICE":{const{deviceId:e}=t.payload;return[jc(e)]}case"REMOVE_ROLE":{const{roleName:e}=t.payload;return[Cc(e)]}case"REMOVE_MEMBER_ROLE":{const{userId:e,roleName:n}=t.payload;return[Lc(e,n)]}case"INVITE_MEMBER":{const{invitation:e}=t.payload;return[ai(e)]}case"INVITE_DEVICE":{const{invitation:e}=t.payload;return[ai(e)]}case"REVOKE_INVITATION":{const{id:e}=t.payload;return[Kc(e)]}case"ADMIT_MEMBER":{const{id:e,memberKeys:n,userName:r}=t.payload,i={userId:n.name,userName:r,keys:n,roles:[]};return[_i(e),kn(i)]}case"ADMIT_DEVICE":{const{id:e,device:n}=t.payload;return[_i(e),Sn(n)]}case"CHANGE_MEMBER_KEYS":{const{keys:e}=t.payload;return[pc(e)]}case"ROTATE_KEYS":{const{userId:e}=t.payload;return[Pc(e)]}case"ADD_SERVER":{const{server:e}=t.payload;return[fc(e)]}case"REMOVE_SERVER":{const{host:e}=t.payload;return[Vc(e)]}case"CHANGE_SERVER_KEYS":{const{keys:e}=t.payload;return[yc(e)]}case"MESSAGE":{const{message:e}=t.payload;return[lc(e)]}case"SET_TEAM_NAME":{const{teamName:e}=t.payload;return[Ii(e)]}default:throw Zp(t)}};function Zp(t){const{type:e}=t;return new Error(`Unrecognized link type: ${e}`)}let Yc,Oi,Gc,Fc,zc,Wc,Jc,qc,Qc;Yc=Ir({initialState:Ct,reducer:Ce,resolver:Re}),Oi=(t,e)=>{const n=ii(t,e);return Yc(n)},{USER:Gc}=W,Fc=({serializedGraph:t,teamKeyring:e,starterKeys:n,invitationId:r})=>{const i=Oi(t,e),{userId:o}=li(i,r);_(o);const{userName:s}=Te(i,o);_(s);const a=Rn(i,n,{type:Gc,name:o});return{userName:s,userId:o,keys:a}},zc=t=>({...t,nonce:ae(),timestamp:Date.now()}),Wc=(t,e)=>xt.sign(t,e.signature.secretKey),Jc=(t,e,n)=>{const r={challenge:t,signature:e};return xt.verify({payload:t,signature:e,publicKey:n.signature})?Z:qc("Signature is not valid",r)},qc=(t,e)=>({isValid:!1,error:new Qc(t,e)}),Qc=class extends Error{constructor(e,n){super();b(this,"details");this.name="Identity challenge failed",this.message=e+`
`+JSON.stringify(n,null,2).replaceAll('"',""),this.details=n}},Xi={},Ae(Xi,{createDevice:()=>Qi,redactDevice:()=>Vt});let Mi,Xc,Dn,Ln;Qi=(t,e,n=ae())=>{const r=pr(),i=lt({type:W.DEVICE,name:r},n);return{userId:t,deviceId:r,deviceName:e,keys:i}},Vt=t=>({userId:t.userId,deviceId:t.deviceId,deviceName:t.deviceName,keys:ft(t.keys)}),Mi=t=>({...to(t),roles:[]}),Xc=t=>"teamName"in t,{DEVICE:Dn,USER:Ln}=W,$e=class extends $n{constructor(e){super();b(this,"state",Ct);b(this,"store");b(this,"context");b(this,"log");b(this,"seed");b(this,"save",()=>sc(this.graph));b(this,"merge",e=>(this.store.merge(e),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head}),this));b(this,"has",e=>di(this.state,e));b(this,"addForTesting",(e,n=[],r)=>{const i={...Mi(e),roles:n};if(!this.has(i.userId)){const o=this.createMemberLockboxes(i);this.dispatch({type:"ADD_MEMBER",payload:{member:i,roles:n,lockboxes:o}})}if(r){const o=nt(e.keys,r.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:r,lockboxes:[o]}})}});b(this,"remove",e=>{const n=this.rotateKeys({type:Ln,name:e});this.dispatch({type:"REMOVE_MEMBER",payload:{userId:e,lockboxes:n}})});b(this,"memberWasRemoved",e=>Oc(this.state,e));b(this,"memberHasRole",(e,n)=>mi(this.state,e,n));b(this,"memberIsAdmin",e=>je(this.state,e));b(this,"hasRole",e=>Ic(this.state,e));b(this,"membersInRole",e=>gi(this.state,e));b(this,"admins",()=>Mc(this.state));b(this,"addRole",e=>{typeof e=="string"&&(e={roleName:e});const n=lt({type:W.ROLE,name:e.roleName},this.seed),r=nt(n,this.adminKeys());this.dispatch({type:"ADD_ROLE",payload:{...e,lockboxes:[r]}})});b(this,"removeRole",e=>{_(e!==et,"Cannot remove admin role"),this.dispatch({type:"REMOVE_ROLE",payload:{roleName:e}})});b(this,"addMemberRole",(e,n)=>{const r=this.members(e),i=nt(this.roleKeys(n),r.keys);this.dispatch({type:"ADD_MEMBER_ROLE",payload:{userId:e,roleName:n,lockboxes:[i]}})});b(this,"removeMemberRole",(e,n)=>{if(n===et){const i=this.membersInRole(et).length;_(i>1,"Can't remove the last admin")}const r=this.rotateKeys({type:W.ROLE,name:n});this.dispatch({type:"REMOVE_MEMBER_ROLE",payload:{userId:e,roleName:n,lockboxes:r}})});b(this,"hasDevice",(e,n)=>ci(this.state,e,n));b(this,"removeDevice",e=>{if(!this.hasDevice(e))throw new Error(`Device ${e} not found`);const n=this.rotateKeys({type:Dn,name:e});this.dispatch({type:"REMOVE_DEVICE",payload:{deviceId:e,lockboxes:n}})});b(this,"deviceWasRemoved",e=>Ec(this.state,e));b(this,"memberByDeviceId",(e,n)=>vi(this.state,e,n));b(this,"verifyIdentityProof",(e,n)=>{_(e.type===Dn);const r=e.name,i=this.hasServer(r)?this.servers(r):this.device(r,{includeRemoved:!0});return Jc(e,n,i.keys).isValid});b(this,"revokeInvitation",e=>{this.dispatch({type:"REVOKE_INVITATION",payload:{id:e}})});b(this,"getInvitation",e=>li(this.state,e));b(this,"validateInvitation",e=>{const{id:n}=e;if(!this.hasInvitation(n))return It("This invitation code doesn't match.");const r=this.getInvitation(n),i=jn(r,Date.now());return i!==Z?i:xi(e,r)});b(this,"admitMember",(e,n,r)=>{const i=this.validateInvitation(e);if(!i.isValid)throw i.error;const{id:o}=e,s=nt(this.teamKeys(),n);this.dispatch({type:"ADMIT_MEMBER",payload:{id:o,userName:r,memberKeys:ft(n),lockboxes:[s]}})});b(this,"admitDevice",(e,n)=>{const r=this.validateInvitation(e);if(!r.isValid)throw r.error;const{id:i}=e,o=this.getInvitation(i).userId,s={...n,userId:o};this.dispatch({type:"ADMIT_DEVICE",payload:{id:i,device:s}})});b(this,"join",e=>{_(!this.isServer,"Can't join as member on server");const{user:n,device:r}=this.context,i=ca(e),o=nt(n.keys,r.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:Vt(r),lockboxes:[o]}},i)});b(this,"addServer",e=>{const n=this.createMemberLockboxes(Lt.toMember(e));this.dispatch({type:"ADD_SERVER",payload:{server:e,lockboxes:n}})});b(this,"removeServer",e=>{this.dispatch({type:"REMOVE_SERVER",payload:{host:e}})});b(this,"serverWasRemoved",e=>Nc(this.state,e));b(this,"hasServer",e=>An(this.state,e));b(this,"addMessage",e=>{this.dispatch({type:"MESSAGE",payload:{message:e}})});b(this,"messages",()=>Ac(this.state));b(this,"encrypt",(e,n)=>{const r=n?{type:W.ROLE,name:n}:ce,{secretKey:i,generation:o}=this.keys(r);return{contents:Ue.encryptBytes(e,i),recipient:{...r,generation:o}}});b(this,"decrypt",e=>{const{secretKey:n}=this.keys(e.recipient);return Ue.decryptBytes(e.contents,n)});b(this,"sign",e=>{_(this.context.user);const{keys:{type:n,name:r,generation:i,signature:{secretKey:o}}}=this.context.user;return{contents:e,signature:xt.sign(e,o),author:{type:n,name:r,generation:i}}});b(this,"verify",e=>xt.verify({payload:e.contents,signature:e.signature,publicKey:this.members(e.author.name).keys.signature}));b(this,"keys",e=>Rn(this.state,this.context.device.keys,e));b(this,"roleKeys",(e,n)=>this.keys({type:W.ROLE,name:e,generation:n}));b(this,"teamKeys",e=>this.keys({...ce,generation:e}));b(this,"teamKeyring",()=>Tc(this.state,this.context.device.keys));b(this,"adminKeys",e=>this.roleKeys(et,e));b(this,"changeKeys",e=>{const{device:n,user:r}=this.context,{type:i}=e;_(i!==Dn,"Can't change device keys");const o=i===Ln,s=i===W.SERVER,a=r.keys;e.generation=a.generation+1;const c=this.rotateKeys(e),u=o?"CHANGE_MEMBER_KEYS":"CHANGE_SERVER_KEYS",h=ft(e);this.dispatch({type:u,payload:{keys:h,lockboxes:c}}),(s||o)&&(r.keys=e),s&&(n.keys=e)});b(this,"createMemberLockboxes",e=>{const n=e.roles.map(this.roleKeys),r=i=>nt(i,e.keys);return[...n,this.teamKeys()].map(r)});b(this,"rotateKeys",e=>{const n=nn(e)?e:lt(e),r=Ei(this.state,e).map(o=>lt(o)),i=[n,...r];return i.flatMap(o=>Sc(this.state,o).map(s=>{const a=i.find(c=>ei(c,s.recipient));return wc({oldLockbox:s,newContents:o,updatedRecipientKeys:a?ft(a):void 0})}))});if(this.seed=e.seed??ae(),"user"in e.context)this.context=e.context;else{const{server:i}=e.context;this.context={...e.context,device:Lt.toDevice(i),user:Lt.toUser(i)}}const{device:n,user:r}=this.context;if(this.log=Un.extend(`auth:team:${this.userName}`),Xc(e)){_(!this.isServer,"Servers can't create teams");const i=nt(e.teamKeys,r.keys),o=lt(Bi,this.seed),s=nt(o,r.keys),a=nt(r.keys,this.context.device.keys),c={name:e.teamName,rootMember:Mi(r),rootDevice:Vt(n),lockboxes:[i,s,a]};this.store=_r({user:r,reducer:Ce,resolver:Re,initialState:Ct,rootPayload:c,keys:e.teamKeys})}else this.store=_r({user:r,reducer:Ce,resolver:Re,initialState:Ct,graph:ac(e.source,e.teamKeyring),keys:e.teamKeyring});this.state=this.store.getState(),this.on("updated",()=>{this.checkForPendingKeyRotations()})}get graph(){return this.store.getGraph()}get id(){return this.graph.root}get teamName(){return this.state.teamName}setTeamName(e){this.dispatch({type:"SET_TEAM_NAME",payload:{teamName:e}})}get userName(){return this.context.user.userId}get userId(){return this.context.user.userId}get isServer(){return"server"in this.context}dispatch(e,n=this.teamKeys()){this.store.dispatch(e,n),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head})}members(e=kt,n={includeRemoved:!0}){return e===kt?this.state.members:Te(this.state,e,n)}roles(e=kt){return e===kt?this.state.roles:Rc(this.state,e)}device(e,n){return Ne(this.state,e,n)}inviteMember({seed:e=Tn(),expiration:n,maxUses:r}={}){e=De(e);const i=Nn({seed:e,expiration:n,maxUses:r}),{id:o}=i;return this.dispatch({type:"INVITE_MEMBER",payload:{invitation:i}}),{id:o,seed:e}}inviteDevice({seed:e=Tn(),expiration:n=Date.now()+30*60*1e3}={}){_(!this.isServer,"Servers can't invite a device"),e=De(e);const r=Nn({seed:e,expiration:n,maxUses:1,userId:this.userId}),i=Le(e),o=nt(this.context.user.keys,i),{id:s}=r;return this.dispatch({type:"INVITE_DEVICE",payload:{invitation:r,lockboxes:[o]}}),{id:s,seed:e}}hasInvitation(e){return hi(this.state,e)}servers(e=kt,n={includeRemoved:!0}){return e===kt?this.state.servers:Mn(this.state,e,n)}checkForPendingKeyRotations(){if(this.memberIsAdmin(this.userId))for(const e of this.state.pendingKeyRotations){const n=this.rotateKeys({type:Ln,name:this.userId});this.dispatch({type:"ROTATE_KEYS",payload:{userId:e,lockboxes:n}})}}},bu=function(t,e,n){const r=lt(ce,n);return new $e({teamName:t,context:e,teamKeys:r})};let Zc,Ai,Xt,tu;Zc=({encryptedGraph:t,teamKeys:e,deviceKeys:n})=>{const r=Ut(e),{encryptedLinks:i,childMap:o,root:s}=t,a=t.links??{},c=(d,f,v={},y=Ct)=>{const E=i[d],m=a[d]??Ws(E,f);let I={[d]:m};const x=Ce(y,m);let k;try{k=Rn(x,n,ce),r[k.encryption.publicKey]=k}catch{k=f}const A=o[d];if(A)for(const C of A)I={...I,...c(C,k,I,x)};return{...v,...I}},u=i[s].recipientPublicKey,h=r[u],l=c(s,h);return{...t,links:l}},_u=(t,e,n)=>{const r=Ut(n);return new $e({source:t,context:e,teamKeyring:r})},Ai=t=>{if(t===void 0)return"DONE";const{head:e,links:n,need:r}=t,i={head:e};return n&&(i.links=Object.keys(n).join(", ")),r&&(i.need=r.join(", ")),pu(JSON.stringify(i))},Xt=Un.extend("message-queue"),tu=(cu=class extends $n{constructor({sendMessage:e,timeout:n=1e3}){super();st(this,Kn);st(this,Pe);st(this,At,!1);st(this,pt,{});st(this,Rt,0);st(this,te,{});st(this,Ke,void 0);st(this,_t,{});st(this,ee,0);st(this,Nt,void 0);jt(this,Nt,r=>{jt(this,ee,r.index+1),e(r)}),jt(this,Ke,n)}start(){return jt(this,At,!0),Pn(this,Pe,no).call(this),Pn(this,Kn,wu).call(this),this}stop(){return jt(this,At,!1),this}send(e){const n=eu(B(this,_t))+1,r={...e,index:n};return B(this,_t)[n]=r,Xt("send %o",r),B(this,At)&&B(this,Nt).call(this,r),this}resend(e){const n=B(this,_t)[e];if(!n)throw new Error(`Received resend request for message #${e}, which doesn't exist.`);return Xt("resend %o",n),B(this,Nt).call(this,n),this}receive(e){const{index:n}=e;return Xt("receive %o",e),B(this,pt)[n]||(B(this,pt)[n]=e,B(this,At)&&Pn(this,Pe,no).call(this)),this}},At=new WeakMap,pt=new WeakMap,Rt=new WeakMap,te=new WeakMap,Ke=new WeakMap,_t=new WeakMap,ee=new WeakMap,Nt=new WeakMap,Kn=new WeakSet,wu=function(){for(Xt("processOutbound");B(this,_t)[B(this,ee)];){const e=B(this,_t)[B(this,ee)];B(this,Nt).call(this,e)}},Pe=new WeakSet,no=function(){for(Xt("processInbound");B(this,pt)[B(this,Rt)];){const n=B(this,pt)[B(this,Rt)];du(this,Rt)._++,this.emit("message",n)}const e=eu(B(this,pt));for(let n=B(this,Rt);n<e;n++)B(this,te)[n]||(B(this,te)[n]=setTimeout(()=>{B(this,pt)[n]||this.emit("request",n),delete B(this,te)[n]},B(this,Ke)))},cu);function eu(t){return Math.max(...Object.keys(t).map(Number),-1)}let nu,Zt,ru,Ri,Ve,Cn,Ni,Ti,Vn,ji,iu,Mt,ou,Di,su,Li,au;nu=7e3,Zt={after:{[nu]:{actions:"failTimeout",target:"#disconnected"}}},ru={predictableActionArguments:!0,id:"connection",initial:"awaitingIdentityClaim",on:{REQUEST_IDENTITY:{actions:"sendIdentityClaim",target:"awaitingIdentityClaim"},CLAIM_IDENTITY:{actions:["receiveIdentityClaim"],target:"awaitingIdentityClaim"},ERROR:{actions:"receiveError",target:"#disconnected"},LOCAL_ERROR:{actions:"sendError",target:"#disconnected"}},states:{awaitingIdentityClaim:{id:"awaitingIdentityClaim",always:{cond:"bothSentIdentityClaim",target:"authenticating"}},authenticating:{id:"authenticating",initial:"checkingInvitations",states:{checkingInvitations:{initial:"checkingForInvitations",states:{checkingForInvitations:{always:[{cond:"bothHaveInvitation",actions:"failNeitherIsMember",target:"#disconnected"},{cond:"weHaveInvitation",target:"awaitingInvitationAcceptance"},{cond:"theyHaveInvitation",target:"validatingInvitation"},{target:"#checkingIdentity"}]},awaitingInvitationAcceptance:{on:{ACCEPT_INVITATION:[{cond:"joinedTheRightTeam",actions:["joinTeam"],target:"#checkingIdentity"},{actions:"rejectTeam",target:"#disconnected"}]},...Zt},validatingInvitation:{always:[{cond:"invitationProofIsValid",actions:"acceptInvitation",target:"#checkingIdentity"},{actions:"rejectInvitation",target:"#disconnected"}]}}},checkingIdentity:{id:"checkingIdentity",type:"parallel",states:{provingMyIdentity:{initial:"awaitingIdentityChallenge",states:{awaitingIdentityChallenge:{always:{cond:"weHaveInvitation",target:"doneProvingMyIdentity"},on:{CHALLENGE_IDENTITY:{actions:["proveIdentity"],target:"awaitingIdentityAcceptance"}},...Zt},awaitingIdentityAcceptance:{on:{ACCEPT_IDENTITY:{target:"doneProvingMyIdentity"}},...Zt},doneProvingMyIdentity:{type:"final"}}},verifyingTheirIdentity:{initial:"challengingIdentity",states:{challengingIdentity:{always:[{cond:"theyHaveInvitation",target:"doneVerifyingTheirIdentity"},{actions:["confirmIdentityExists","challengeIdentity"],target:"awaitingIdentityProof"}]},awaitingIdentityProof:{on:{PROVE_IDENTITY:[{cond:"identityProofIsValid",actions:"acceptIdentity",target:"doneVerifyingTheirIdentity"},{actions:"rejectIdentityProof",target:"#disconnected"}]},...Zt},doneVerifyingTheirIdentity:{type:"final"}}}},onDone:{target:"doneAuthenticating"}},doneAuthenticating:{type:"final"}},onDone:{actions:["listenForTeamUpdates"],target:"#negotiating"}},negotiating:{id:"negotiating",entry:["generateSeed"],initial:"awaitingSeed",states:{awaitingSeed:{entry:["sendSeed"],on:{SEED:{actions:"receiveSeed",target:"doneNegotiating"}},...Zt},doneNegotiating:{entry:"deriveSharedKey",type:"final"}},onDone:{actions:["sendSyncMessage"],target:"#synchronizing"}},synchronizing:{id:"synchronizing",always:[{cond:"headsAreEqual",actions:"onConnected",target:"#connected"}],on:{SYNC:{actions:["receiveSyncMessage","sendSyncMessage"],target:"#synchronizing"}}},connected:{id:"connected",always:[{cond:"peerWasRemoved",actions:"failPeerWasRemoved",target:"disconnected"}],on:{LOCAL_UPDATE:{actions:["sendSyncMessage"],target:"#connected"},SYNC:{actions:["receiveSyncMessage","sendSyncMessage"],target:"#connected"},ENCRYPTED_MESSAGE:{actions:"receiveEncryptedMessage",target:"#connected"},DISCONNECT:"#disconnected"}},disconnected:{id:"disconnected",entry:"onDisconnected"}}},Ri=t=>"team"in t&&t.team!==void 0,Ve=t=>"invitationSeed"in t&&t.invitationSeed!==void 0,Cn=t=>Ve(t)&&"user"in t&&t.user!==void 0,Ni=t=>Ve(t)&&!Cn(t),Ti=t=>"server"in t&&t.server!==void 0,Vn=t=>"deviceId"in t&&t.deviceId!==void 0,ji=t=>Mt(t)&&"userKeys"in t&&t.userKeys!==void 0,iu=t=>Mt(t)&&!("userKeys"in t),Mt=t=>"proofOfInvitation"in t&&t.proofOfInvitation!==void 0,{DEVICE:ou}=W,Hi=class extends $n{constructor({sendMessage:e,context:n}){super();b(this,"machine");b(this,"started",!1);b(this,"messageQueue");b(this,"log",Un.extend("auth:connection"));b(this,"start",(e=[])=>{this.log("starting"),this.machine.start(),this.messageQueue.start(),this.started=!0,this.sendMessage({type:"REQUEST_IDENTITY"});for(const n of e)this.deliver(n);return this});b(this,"stop",()=>{if(this.started&&!this.machine.state.done){const e={type:"DISCONNECT"};this.machine.send(e);try{this.sendMessage(e)}catch{}}return this.removeAllListeners(),this.messageQueue.stop(),this.machine.stop(),this.machine.state.done=!0,this.log("machine stopped"),this});b(this,"send",e=>{_(this.sessionKey);const n=Ue.encryptBytes(e,this.sessionKey);this.sendMessage({type:"ENCRYPTED_MESSAGE",payload:n})});b(this,"actions",{sendIdentityClaim:Q(e=>{const n=(r=>{if(Ri(r))return{deviceId:r.device.deviceId};if(Cn(r)){const{userName:i,keys:o}=r.user;return{proofOfInvitation:this.myProofOfInvitation(r),userName:i,userKeys:ft(o),device:Vt(r.device)}}if(Ni(r)){const{userName:i,device:o}=r;return{proofOfInvitation:this.myProofOfInvitation(r),userName:i,device:Vt(o)}}throw new Error("Invalid context")})(e);return this.sendMessage({type:"CLAIM_IDENTITY",payload:n}),{ourIdentityClaim:n}}),receiveIdentityClaim:Q((e,n)=>{const{payload:r}=n;return"userName"in r&&(this.log=this.log.extend(r.userName)),{theirIdentityClaim:r,theirDevice:"device"in r?r.device:void 0}}),acceptInvitation:Q(e=>{const{team:n,theirIdentityClaim:r}=e;_(n),_(r),_(Mt(r));const{proofOfInvitation:i}=r,o=(()=>{if(ji(r)){const{userName:s,userKeys:a}=r;_(s),n.admitMember(i,a,s);const c=a.name;return n.members(c)}else{const{device:s}=r;n.admitDevice(i,s);const{deviceId:a}=s,{userId:c}=n.memberByDeviceId(a);return n.members(c)}})();return this.sendMessage({type:"ACCEPT_INVITATION",payload:{serializedGraph:n.save(),teamKeyring:n.teamKeyring()}}),{peer:o}}),joinTeam:Q((e,n)=>{const{payload:r}=n,{serializedGraph:i,teamKeyring:o}=r,{device:s,invitationSeed:a}=e,c=()=>{const{id:l}=this.myProofOfInvitation(e),d=Le(a);return Fc({serializedGraph:i,teamKeyring:o,starterKeys:d,invitationId:l})},u=e.user??c(),h=new $e({source:i,context:{user:u,device:s},teamKeyring:o});return h.join(o),this.emit("joined",{team:h,user:u}),{user:u,team:h}}),confirmIdentityExists:Q(e=>{const{team:n,theirIdentityClaim:r}=e;_(r),_(n),_(Vn(r));const{deviceId:i}=r;try{const o=n.device(i,{includeRemoved:!0}),s=n.memberByDeviceId(i,{includeRemoved:!0});return this.log=this.log.extend(s.userName),{theirDevice:o,peer:s}}catch{return{error:this.throwError("DEVICE_UNKNOWN",{message:`Device ${i} not found.`})}}}),challengeIdentity:Q(e=>{const{theirIdentityClaim:n}=e;_(n),_(Vn(n));const{deviceId:r}=n,i=zc({type:ou,name:r});return this.sendMessage({type:"CHALLENGE_IDENTITY",payload:{challenge:i}}),{challenge:i}}),proveIdentity:(e,n)=>{_(e.user);const{challenge:r}=n.payload,i=Wc(r,e.device.keys);this.sendMessage({type:"PROVE_IDENTITY",payload:{challenge:r,proof:i}})},acceptIdentity:()=>{this.sendMessage({type:"ACCEPT_IDENTITY"})},listenForTeamUpdates:e=>{_(e.team),e.team.on("updated",({head:n})=>{this.machine.state.done||this.machine.send({type:"LOCAL_UPDATE",payload:{head:n}}),this.emit("updated")})},sendSyncMessage:Q(e=>{_(e.team);const n=e.syncState??wr(),[r,i]=va(e.team.graph,n);return i?(this.log("sending sync message",Ai(i)),this.sendMessage({type:"SYNC",payload:i})):this.log("no sync message to send"),{syncState:r}}),receiveSyncMessage:Q((e,n)=>{const{team:r,device:i}=e;_(r);const o=e.syncState??wr(),s=n.payload,a=r.teamKeys(),c=i.keys,u=({encryptedGraph:d,keys:f})=>Zc({encryptedGraph:d,teamKeys:f,deviceKeys:c}),[h,l]=ma(r.graph,o,s,a,u);return be(h.head,r.graph.head)?{syncState:l}:(this.emit("updated"),{team:r.merge(h),syncState:l})}),generateSeed:Q(e=>({seed:ay()})),sendSeed:e=>{const{user:n,peer:r,seed:i}=e,o=vt.encryptBytes({secret:i,recipientPublicKey:r.keys.encryption,senderSecretKey:n.keys.encryption.secretKey});this.sendMessage({type:"SEED",payload:{encryptedSeed:o}})},receiveSeed:Q((e,n)=>{const{payload:r}=n;return{theirEncryptedSeed:r.encryptedSeed}}),deriveSharedKey:Q({sessionKey:e=>{const{user:n,seed:r,theirEncryptedSeed:i,peer:o}=e;_(r),_(i);const s=vt.decryptBytes({cipher:i,senderPublicKey:o.keys.encryption,recipientSecretKey:n.keys.encryption.secretKey});return ic(r,s)}}),receiveEncryptedMessage:(e,n)=>{const{sessionKey:r}=e;_(r);const{payload:i}=n,o=Ue.decryptBytes(i,r);this.emit("message",o)},receiveError:Q((e,n)=>{const r=n.payload;return this.log("receiveError %o",r),this.emit("remoteError",r),{error:r}}),sendError:Q((e,n)=>{const r=n.payload;this.log("sendError %o",r);const i=xn(r.type,r.details,"REMOTE");return this.sendMessage(i),this.emit("localError",r),{error:r}}),rejectIdentityProof:this.fail("IDENTITY_PROOF_INVALID"),failNeitherIsMember:this.fail("NEITHER_IS_MEMBER"),rejectInvitation:this.fail("INVITATION_PROOF_INVALID"),rejectTeam:this.fail("JOINED_WRONG_TEAM"),failPeerWasRemoved:this.fail("MEMBER_REMOVED"),failDeviceWasRemoved:this.fail("DEVICE_REMOVED"),failTimeout:this.fail("TIMEOUT"),onConnected:()=>this.emit("connected"),onDisconnected:(e,n)=>this.emit("disconnected",n)});b(this,"guards",{weHaveInvitation:e=>Ve(e),theyHaveInvitation:e=>Mt(e.theirIdentityClaim),bothHaveInvitation:(...e)=>{const n=this.guards.weHaveInvitation(...e),r=this.guards.theyHaveInvitation(...e);return n&&r},invitationProofIsValid:e=>{const{team:n,theirIdentityClaim:r}=e;_(n),_(r),_(Mt(r));const{proofOfInvitation:i}=r,o=n.validateInvitation(i);return o.isValid?!0:(e.error=o.error,!1)},joinedTheRightTeam:(e,n)=>{const{payload:r}=n,{serializedGraph:i,teamKeyring:o}=r,s=Oi(i,o),{id:a}=this.myProofOfInvitation(e);return hi(s,a)},bothSentIdentityClaim:e=>e.ourIdentityClaim!==void 0&&e.theirIdentityClaim!==void 0,identityProofIsValid(e,n){const{team:r}=e;_(r);const{payload:i}=n,{challenge:o,proof:s}=i;return r.verifyIdentityProof(o,s)},peerWasRemoved(e){const{team:n,peer:r,theirDevice:i}=e;_(n),_(r),_(i);const o=n.serverWasRemoved(r.userId),s=n.memberWasRemoved(r.userId),a=n.deviceWasRemoved(i.deviceId);return o||s||a},headsAreEqual(e){const{team:n,syncState:r}=e;_(n);const i=n.graph.head,o=r?.lastCommonHead;return Ur(i,o)}});b(this,"sendMessage",e=>{this.messageQueue.send(e)});b(this,"throwError",(e,n)=>{const r=n&&"message"in n?n.message:void 0;this.log("error: %s %o",e,n);const i=xn(e,r,"LOCAL");return this.machine.send(i),i.payload});this.messageQueue=new tu({sendMessage:o=>{this.logMessage("out",o);const s=Ki(o);e(s)}}).on("message",o=>{if(this.logMessage("in",o),o.type==="REQUEST_RESEND"){const{index:s}=o.payload;this.messageQueue.resend(s);return}this.machine.send(o)}).on("request",o=>{this.sendMessage({type:"REQUEST_RESEND",payload:{index:o}})});const r="server"in n?n.server.host:"userName"in n?n.userName:"user"in n?n.user.userName:"";this.log=this.log.extend(r);const i=Ti(n)?au(n):n;this.machine=Ua(Xp(ru,{actions:this.actions,guards:this.guards}).withContext(i)).onTransition((o,s)=>{const a=Li(o.value);this.emit("change",a),this.log(`${Di(s)} \u23E9 ${a} `)}),this.emit=(o,...s)=>(this.log(`emit ${o} %o`,...s),super.emit(o,...s))}get state(){return _(this.started),this.machine.state.value}get context(){return _(this.started),this.machine.state.context}get user(){return this.context.user}get error(){return this.context.error}get team(){return this.context.team}get sessionKey(){return this.context.sessionKey}deliver(e){const n=Pi(e);this.messageQueue.receive(n)}fail(e){return Q({error:n=>{const r=n.error;return this.throwError(e,r)}})}logMessage(e,n){const r=e==="in"?"<-":"->",i=this.started?this.context.peer?.userName??"?":"?";this.log(`${r}${i} #${n.index} ${Di(n)}`)}myProofOfInvitation(e){return _(e.invitationSeed),Gn(e.invitationSeed)}},Di=t=>t.type==="SYNC"?`SYNC ${Ai(t.payload)}`:`${t.type} ${t.payload?.head?.slice(0,5)||t.payload?.message||""}`,su=t=>typeof t=="string",Li=t=>su(t)?t:Object.keys(t).map(e=>`${e}:${Li(t[e])}`).filter(e=>e.length).join(","),au=t=>{const{keys:e,host:n}=t.server;return{...t,user:{userId:n,userName:n,keys:e},device:{userId:n,deviceId:n,deviceName:n,keys:e}}}});export{et as ADMIN,Bi as ADMIN_SCOPE,kt as ALL,Hi as Connection,Ui as DEVICE_ID,$i as ENCRYPTION,gu as EPHEMERAL_SCOPE,Yn as HashPurpose,Yi as INVITATION,Gi as LINK_HASH,Fi as LINK_TO_PREVIOUS,zi as SHARED_KEY,Wi as SIGNATURE,Ji as SYMMETRIC,ce as TEAM_SCOPE,$e as Team,Z as VALID,yy as __tla,vt as asymmetric,Lt as castServer,qi as connection,Qi as createDevice,lt as createKeyset,bu as createTeam,Eu as createUser,Xi as device,Gn as generateProof,Iu as graphSummary,Ct as initialState,Zi as invitation,_u as loadTeam,Vt as redactDevice,ft as redactKeys,to as redactUser,eo as role,xt as signatures,Ue as symmetric};

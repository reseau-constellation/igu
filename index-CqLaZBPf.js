import{m as ni,a as X,s as Sr,b as ae,h as oe,c as ee,r as be,d as A,p as Kt,u as $t,e as et,f as He,g as Ue,i as ri,t as Tr,j as si}from"./index-BuKK8T7e.js";import{dO as Bt,dP as ii,dQ as je,dR as Ie,dS as tt,dT as oi,dU as ai,dV as Mr,dW as ci,dX as di,dY as ui,dZ as Pt,d_ as hi,d$ as kr,e0 as li,e1 as fi,e2 as yi,e3 as wn,e4 as Vt,e5 as Ye,e6 as Ar,e7 as pi,e8 as wr,e9 as vi,ea as Rr,eb as mi,ec as gi,ed as Ei,ee as bi,ef as ft,eg as Or,eh as Ii,ei as _i,cb as Rn,ce as On}from"./index-BMIJjZMN.js";var Si="[object Symbol]";function Ht(e){return typeof e=="symbol"||Bt(e)&&ii(e)==Si}function Ti(e,t){for(var n=-1,r=e==null?0:e.length,s=Array(r);++n<r;)s[n]=t(e[n],n,e);return s}var Mi=1/0,xn=je?je.prototype:void 0,Ln=xn?xn.toString:void 0;function xr(e){if(typeof e=="string")return e;if(Ie(e))return Ti(e,xr)+"";if(Ht(e))return Ln?Ln.call(e):"";var t=e+"";return t=="0"&&1/e==-Mi?"-0":t}var Cn=Object.create,ki=function(){function e(){}return function(t){if(!tt(t))return{};if(Cn)return Cn(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();function Ai(){}function wi(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}var Dn=function(){try{var e=oi(Object,"defineProperty");return e({},"",{}),e}catch{}}();function Ri(e,t){for(var n=-1,r=e==null?0:e.length;++n<r&&t(e[n],n,e)!==!1;);return e}function Oi(e,t,n,r){for(var s=e.length,i=n+-1;++i<s;)if(t(e[i],i,e))return i;return-1}function xi(e){return e!==e}function Li(e,t,n){for(var r=n-1,s=e.length;++r<s;)if(e[r]===t)return r;return-1}function Ci(e,t,n){return t===t?Li(e,t,n):Oi(e,xi,n)}function Di(e,t){var n=e==null?0:e.length;return!!n&&Ci(e,t,0)>-1}function Lr(e,t,n){t=="__proto__"&&Dn?Dn(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}var Ni=Object.prototype,Ki=Ni.hasOwnProperty;function Cr(e,t,n){var r=e[t];(!(Ki.call(e,t)&&ai(r,n))||n===void 0&&!(t in e))&&Lr(e,t,n)}function nt(e,t,n,r){var s=!n;n||(n={});for(var i=-1,o=t.length;++i<o;){var a=t[i],c=void 0;c===void 0&&(c=e[a]),s?Lr(n,a,c):Cr(n,a,c)}return n}function $i(e){var t=[];if(e!=null)for(var n in Object(e))t.push(n);return t}var Bi=Object.prototype,Pi=Bi.hasOwnProperty;function Vi(e){if(!tt(e))return $i(e);var t=Mr(e),n=[];for(var r in e)r=="constructor"&&(t||!Pi.call(e,r))||n.push(r);return n}function Ut(e){return ci(e)?di(e,!0):Vi(e)}var Hi=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ui=/^\w*$/;function jt(e,t){if(Ie(e))return!1;var n=typeof e;return n=="number"||n=="symbol"||n=="boolean"||e==null||Ht(e)?!0:Ui.test(e)||!Hi.test(e)||t!=null&&e in Object(t)}var ji=500;function Yi(e){var t=ni(e,function(r){return n.size===ji&&n.clear(),r}),n=t.cache;return t}var Gi=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Fi=/\\(\\)?/g,Wi=Yi(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(Gi,function(n,r,s,i){t.push(s?i.replace(Fi,"$1"):r||n)}),t});function qi(e){return e==null?"":xr(e)}function Dr(e,t){return Ie(e)?e:jt(e,t)?[e]:Wi(qi(e))}var zi=1/0;function rt(e){if(typeof e=="string"||Ht(e))return e;var t=e+"";return t=="0"&&1/e==-zi?"-0":t}function Nr(e,t){t=Dr(t,e);for(var n=0,r=t.length;e!=null&&n<r;)e=e[rt(t[n++])];return n&&n==r?e:void 0}function Ji(e,t,n){var r=e==null?void 0:Nr(e,t);return r===void 0?n:r}var Kr=ui(Object.getPrototypeOf,Object);function Xi(e,t){return e&&nt(t,Pt(t),e)}function Zi(e,t){return e&&nt(t,Ut(t),e)}var $r=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Nn=$r&&typeof module=="object"&&module&&!module.nodeType&&module,Qi=Nn&&Nn.exports===$r,Kn=Qi?hi.Buffer:void 0,$n=Kn?Kn.allocUnsafe:void 0;function eo(e,t){if(t)return e.slice();var n=e.length,r=$n?$n(n):new e.constructor(n);return e.copy(r),r}function to(e,t){return nt(e,kr(e),t)}var no=Object.getOwnPropertySymbols,Br=no?function(e){for(var t=[];e;)fi(t,kr(e)),e=Kr(e);return t}:li;function ro(e,t){return nt(e,Br(e),t)}function so(e){return yi(e,Ut,Br)}var io=Object.prototype,oo=io.hasOwnProperty;function ao(e){var t=e.length,n=new e.constructor(t);return t&&typeof e[0]=="string"&&oo.call(e,"index")&&(n.index=e.index,n.input=e.input),n}function Yt(e){var t=new e.constructor(e.byteLength);return new wn(t).set(new wn(e)),t}function co(e,t){var n=t?Yt(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}var uo=/\w*$/;function ho(e){var t=new e.constructor(e.source,uo.exec(e));return t.lastIndex=e.lastIndex,t}var Bn=je?je.prototype:void 0,Pn=Bn?Bn.valueOf:void 0;function lo(e){return Pn?Object(Pn.call(e)):{}}function fo(e,t){var n=t?Yt(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}var yo="[object Boolean]",po="[object Date]",vo="[object Map]",mo="[object Number]",go="[object RegExp]",Eo="[object Set]",bo="[object String]",Io="[object Symbol]",_o="[object ArrayBuffer]",So="[object DataView]",To="[object Float32Array]",Mo="[object Float64Array]",ko="[object Int8Array]",Ao="[object Int16Array]",wo="[object Int32Array]",Ro="[object Uint8Array]",Oo="[object Uint8ClampedArray]",xo="[object Uint16Array]",Lo="[object Uint32Array]";function Co(e,t,n){var r=e.constructor;switch(t){case _o:return Yt(e);case yo:case po:return new r(+e);case So:return co(e,n);case To:case Mo:case ko:case Ao:case wo:case Ro:case Oo:case xo:case Lo:return fo(e,n);case vo:return new r;case mo:case bo:return new r(e);case go:return ho(e);case Eo:return new r;case Io:return lo(e)}}function Do(e){return typeof e.constructor=="function"&&!Mr(e)?ki(Kr(e)):{}}var No="[object Map]";function Ko(e){return Bt(e)&&Vt(e)==No}var Vn=Ye&&Ye.isMap,$o=Vn?Ar(Vn):Ko,Bo="[object Set]";function Po(e){return Bt(e)&&Vt(e)==Bo}var Hn=Ye&&Ye.isSet,Vo=Hn?Ar(Hn):Po,Ho=1,Uo=2,jo=4,Pr="[object Arguments]",Yo="[object Array]",Go="[object Boolean]",Fo="[object Date]",Wo="[object Error]",Vr="[object Function]",qo="[object GeneratorFunction]",zo="[object Map]",Jo="[object Number]",Hr="[object Object]",Xo="[object RegExp]",Zo="[object Set]",Qo="[object String]",ea="[object Symbol]",ta="[object WeakMap]",na="[object ArrayBuffer]",ra="[object DataView]",sa="[object Float32Array]",ia="[object Float64Array]",oa="[object Int8Array]",aa="[object Int16Array]",ca="[object Int32Array]",da="[object Uint8Array]",ua="[object Uint8ClampedArray]",ha="[object Uint16Array]",la="[object Uint32Array]",C={};C[Pr]=C[Yo]=C[na]=C[ra]=C[Go]=C[Fo]=C[sa]=C[ia]=C[oa]=C[aa]=C[ca]=C[zo]=C[Jo]=C[Hr]=C[Xo]=C[Zo]=C[Qo]=C[ea]=C[da]=C[ua]=C[ha]=C[la]=!0;C[Wo]=C[Vr]=C[ta]=!1;function $e(e,t,n,r,s,i){var o,a=t&Ho,c=t&Uo,h=t&jo;if(o!==void 0)return o;if(!tt(e))return e;var f=Ie(e);if(f){if(o=ao(e),!a)return wi(e,o)}else{var d=Vt(e),l=d==Vr||d==qo;if(pi(e))return eo(e,a);if(d==Hr||d==Pr||l&&!s){if(o=c||l?{}:Do(e),!a)return c?ro(e,Zi(o,e)):to(e,Xi(o,e))}else{if(!C[d])return s?e:{};o=Co(e,d,a)}}i||(i=new wr);var y=i.get(e);if(y)return y;i.set(e,o),Vo(e)?e.forEach(function(m){o.add($e(m,t,n,m,e,i))}):$o(e)&&e.forEach(function(m,k){o.set(k,$e(m,t,n,k,e,i))});var p=h?c?so:vi:c?Ut:Pt,E=f?void 0:p(e);return Ri(E||e,function(m,k){E&&(k=m,m=e[k]),Cr(o,k,$e(m,t,n,k,e,i))}),o}var fa=4;function ya(e){return $e(e,fa)}var pa=1,va=2;function ma(e,t,n,r){var s=n.length,i=s;if(e==null)return!i;for(e=Object(e);s--;){var o=n[s];if(o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++s<i;){o=n[s];var a=o[0],c=e[a],h=o[1];if(o[2]){if(c===void 0&&!(a in e))return!1}else{var f=new wr,d;if(!(d===void 0?Rr(h,c,pa|va,r,f):d))return!1}}return!0}function Ur(e){return e===e&&!tt(e)}function ga(e){for(var t=Pt(e),n=t.length;n--;){var r=t[n],s=e[r];t[n]=[r,s,Ur(s)]}return t}function jr(e,t){return function(n){return n==null?!1:n[e]===t&&(t!==void 0||e in Object(n))}}function Ea(e){var t=ga(e);return t.length==1&&t[0][2]?jr(t[0][0],t[0][1]):function(n){return n===e||ma(n,e,t)}}function ba(e,t){return e!=null&&t in Object(e)}function Ia(e,t,n){t=Dr(t,e);for(var r=-1,s=t.length,i=!1;++r<s;){var o=rt(t[r]);if(!(i=e!=null&&n(e,o)))break;e=e[o]}return i||++r!=s?i:(s=e==null?0:e.length,!!s&&mi(s)&&gi(o,s)&&(Ie(e)||Ei(e)))}function _a(e,t){return e!=null&&Ia(e,t,ba)}var Sa=1,Ta=2;function Ma(e,t){return jt(e)&&Ur(t)?jr(rt(e),t):function(n){var r=Ji(n,e);return r===void 0&&r===t?_a(n,e):Rr(t,r,Sa|Ta)}}function ka(e){return function(t){return t?.[e]}}function Aa(e){return function(t){return Nr(t,e)}}function wa(e){return jt(e)?ka(rt(e)):Aa(e)}function Ra(e){return typeof e=="function"?e:e==null?bi:typeof e=="object"?Ie(e)?Ma(e[0],e[1]):Ea(e):wa(e)}var Oa=1/0,xa=ft&&1/Or(new ft([,-0]))[1]==Oa?function(e){return new ft(e)}:Ai,La=200;function Yr(e,t,n){var r=-1,s=Di,i=e.length,o=!0,a=[],c=a;if(i>=La){var h=t?null:xa(e);if(h)return Or(h);o=!1,s=_i,c=new Ii}else c=t?[]:a;e:for(;++r<i;){var f=e[r],d=t?t(f):f;if(f=f!==0?f:0,o&&d===d){for(var l=c.length;l--;)if(c[l]===d)continue e;t&&c.push(d),a.push(f)}else s(c,d,n)||(c!==a&&c.push(d),a.push(f))}return a}function Gt(e){return e&&e.length?Yr(e):[]}function Ca(e,t){return e&&e.length?Yr(e,Ra(t)):[]}class st{#e={};#t=0;emit(t,...n){if(!this.#e[t])return!1;const r=[...this.#e[t]];for(let s=0;s<r.length;s++){const{once:i,fn:o}=r[s];i&&this.removeListener(t,o),o(...n)}return!0}addListener(t,n){return this.#s(t,n,!1)}on=this.addListener;once(t,n){return this.#s(t,n,!0)}removeListener(t,n){const r=this.#e[t];if(r){if(!n)this.removeAllListeners(t);else{const s=[];for(let i=0;i<r.length;i++)r[i].fn===n&&(r[i],this.#t-=1,this.#t===0?(this.#e={},this.#t=0):r.length===1?delete this.#e[t]:s.push(i));for(let i=s.length-1;i>=0;i--)r.splice(s[i],1)}return this}}off=this.removeListener;removeAllListeners(t){if(t){const n=this.#e[t];n&&(this.#t-=n.length,this.#t===0?this.#e={}:delete this.#e[t])}else this.#e={},this.#t=0;return this}#s(t,n,r=!1){const s={fn:n,once:r},i=this.#e[t]??[];return i.push(s),this.#e[t]=i,this.#t++,this}}var ue={},G={},L={},H={},Un;function Gr(){if(Un)return H;Un=1,Object.defineProperty(H,"__esModule",{value:!0}),H.anumber=e,H.number=e,H.abytes=n,H.bytes=n,H.ahash=r,H.aexists=s,H.aoutput=i;function e(a){if(!Number.isSafeInteger(a)||a<0)throw new Error("positive integer expected, got "+a)}function t(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&a.constructor.name==="Uint8Array"}function n(a,...c){if(!t(a))throw new Error("Uint8Array expected");if(c.length>0&&!c.includes(a.length))throw new Error("Uint8Array expected of length "+c+", got length="+a.length)}function r(a){if(typeof a!="function"||typeof a.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");e(a.outputLen),e(a.blockLen)}function s(a,c=!0){if(a.destroyed)throw new Error("Hash instance has been destroyed");if(c&&a.finished)throw new Error("Hash#digest() has already been called")}function i(a,c){n(a);const h=c.outputLen;if(a.length<h)throw new Error("digestInto() expects output buffer of length at least "+h)}const o={number:e,bytes:n,hash:r,exists:s,output:i};return H.default=o,H}var T={},jn;function Da(){if(jn)return T;jn=1,Object.defineProperty(T,"__esModule",{value:!0}),T.add5L=T.add5H=T.add4H=T.add4L=T.add3H=T.add3L=T.rotlBL=T.rotlBH=T.rotlSL=T.rotlSH=T.rotr32L=T.rotr32H=T.rotrBL=T.rotrBH=T.rotrSL=T.rotrSH=T.shrSL=T.shrSH=T.toBig=void 0,T.fromBig=n,T.split=r,T.add=k;const e=BigInt(2**32-1),t=BigInt(32);function n(g,v=!1){return v?{h:Number(g&e),l:Number(g>>t&e)}:{h:Number(g>>t&e)|0,l:Number(g&e)|0}}function r(g,v=!1){let u=new Uint32Array(g.length),I=new Uint32Array(g.length);for(let M=0;M<g.length;M++){const{h:w,l:D}=n(g[M],v);[u[M],I[M]]=[w,D]}return[u,I]}const s=(g,v)=>BigInt(g>>>0)<<t|BigInt(v>>>0);T.toBig=s;const i=(g,v,u)=>g>>>u;T.shrSH=i;const o=(g,v,u)=>g<<32-u|v>>>u;T.shrSL=o;const a=(g,v,u)=>g>>>u|v<<32-u;T.rotrSH=a;const c=(g,v,u)=>g<<32-u|v>>>u;T.rotrSL=c;const h=(g,v,u)=>g<<64-u|v>>>u-32;T.rotrBH=h;const f=(g,v,u)=>g>>>u-32|v<<64-u;T.rotrBL=f;const d=(g,v)=>v;T.rotr32H=d;const l=(g,v)=>g;T.rotr32L=l;const y=(g,v,u)=>g<<u|v>>>32-u;T.rotlSH=y;const p=(g,v,u)=>v<<u|g>>>32-u;T.rotlSL=p;const E=(g,v,u)=>v<<u-32|g>>>64-u;T.rotlBH=E;const m=(g,v,u)=>g<<u-32|v>>>64-u;T.rotlBL=m;function k(g,v,u,I){const M=(v>>>0)+(I>>>0);return{h:g+u+(M/2**32|0)|0,l:M|0}}const O=(g,v,u)=>(g>>>0)+(v>>>0)+(u>>>0);T.add3L=O;const K=(g,v,u,I)=>v+u+I+(g/2**32|0)|0;T.add3H=K;const S=(g,v,u,I)=>(g>>>0)+(v>>>0)+(u>>>0)+(I>>>0);T.add4L=S;const b=(g,v,u,I,M)=>v+u+I+M+(g/2**32|0)|0;T.add4H=b;const _=(g,v,u,I,M)=>(g>>>0)+(v>>>0)+(u>>>0)+(I>>>0)+(M>>>0);T.add5L=_;const R=(g,v,u,I,M,w)=>v+u+I+M+w+(g/2**32|0)|0;T.add5H=R;const x={fromBig:n,split:r,toBig:s,shrSH:i,shrSL:o,rotrSH:a,rotrSL:c,rotrBH:h,rotrBL:f,rotr32H:d,rotr32L:l,rotlSH:y,rotlSL:p,rotlBH:E,rotlBL:m,add:k,add3L:O,add3H:K,add4L:S,add4H:b,add5H:R,add5L:_};return T.default=x,T}var yt={},_e={},Yn;function Na(){return Yn||(Yn=1,Object.defineProperty(_e,"__esModule",{value:!0}),_e.crypto=void 0,_e.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0),_e}var Gn;function Ka(){return Gn||(Gn=1,function(e){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.Hash=e.nextTick=e.byteSwapIfBE=e.byteSwap=e.isLE=e.rotl=e.rotr=e.createView=e.u32=e.u8=void 0,e.isBytes=r,e.byteSwap32=f,e.bytesToHex=l,e.hexToBytes=E,e.asyncLoop=k,e.utf8ToBytes=O,e.toBytes=K,e.concatBytes=S,e.checkOpts=_,e.wrapConstructor=R,e.wrapConstructorWithOpts=x,e.wrapXOFConstructorWithOpts=g,e.randomBytes=v;const t=Na(),n=Gr();function r(u){return u instanceof Uint8Array||ArrayBuffer.isView(u)&&u.constructor.name==="Uint8Array"}const s=u=>new Uint8Array(u.buffer,u.byteOffset,u.byteLength);e.u8=s;const i=u=>new Uint32Array(u.buffer,u.byteOffset,Math.floor(u.byteLength/4));e.u32=i;const o=u=>new DataView(u.buffer,u.byteOffset,u.byteLength);e.createView=o;const a=(u,I)=>u<<32-I|u>>>I;e.rotr=a;const c=(u,I)=>u<<I|u>>>32-I>>>0;e.rotl=c,e.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;const h=u=>u<<24&4278190080|u<<8&16711680|u>>>8&65280|u>>>24&255;e.byteSwap=h,e.byteSwapIfBE=e.isLE?u=>u:u=>(0,e.byteSwap)(u);function f(u){for(let I=0;I<u.length;I++)u[I]=(0,e.byteSwap)(u[I])}const d=Array.from({length:256},(u,I)=>I.toString(16).padStart(2,"0"));function l(u){(0,n.abytes)(u);let I="";for(let M=0;M<u.length;M++)I+=d[u[M]];return I}const y={_0:48,_9:57,A:65,F:70,a:97,f:102};function p(u){if(u>=y._0&&u<=y._9)return u-y._0;if(u>=y.A&&u<=y.F)return u-(y.A-10);if(u>=y.a&&u<=y.f)return u-(y.a-10)}function E(u){if(typeof u!="string")throw new Error("hex string expected, got "+typeof u);const I=u.length,M=I/2;if(I%2)throw new Error("hex string expected, got unpadded hex of length "+I);const w=new Uint8Array(M);for(let D=0,$=0;D<M;D++,$+=2){const ne=p(u.charCodeAt($)),An=p(u.charCodeAt($+1));if(ne===void 0||An===void 0){const ti=u[$]+u[$+1];throw new Error('hex string expected, got non-hex character "'+ti+'" at index '+$)}w[D]=ne*16+An}return w}const m=async()=>{};e.nextTick=m;async function k(u,I,M){let w=Date.now();for(let D=0;D<u;D++){M(D);const $=Date.now()-w;$>=0&&$<I||(await(0,e.nextTick)(),w+=$)}}function O(u){if(typeof u!="string")throw new Error("utf8ToBytes expected string, got "+typeof u);return new Uint8Array(new TextEncoder().encode(u))}function K(u){return typeof u=="string"&&(u=O(u)),(0,n.abytes)(u),u}function S(...u){let I=0;for(let w=0;w<u.length;w++){const D=u[w];(0,n.abytes)(D),I+=D.length}const M=new Uint8Array(I);for(let w=0,D=0;w<u.length;w++){const $=u[w];M.set($,D),D+=$.length}return M}class b{clone(){return this._cloneInto()}}e.Hash=b;function _(u,I){if(I!==void 0&&{}.toString.call(I)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(u,I)}function R(u){const I=w=>u().update(K(w)).digest(),M=u();return I.outputLen=M.outputLen,I.blockLen=M.blockLen,I.create=()=>u(),I}function x(u){const I=(w,D)=>u(D).update(K(w)).digest(),M=u({});return I.outputLen=M.outputLen,I.blockLen=M.blockLen,I.create=w=>u(w),I}function g(u){const I=(w,D)=>u(D).update(K(w)).digest(),M=u({});return I.outputLen=M.outputLen,I.blockLen=M.blockLen,I.create=w=>u(w),I}function v(u=32){if(t.crypto&&typeof t.crypto.getRandomValues=="function")return t.crypto.getRandomValues(new Uint8Array(u));if(t.crypto&&typeof t.crypto.randomBytes=="function")return t.crypto.randomBytes(u);throw new Error("crypto.getRandomValues must be defined")}}(yt)),yt}var Fn;function $a(){if(Fn)return L;Fn=1,Object.defineProperty(L,"__esModule",{value:!0}),L.shake256=L.shake128=L.keccak_512=L.keccak_384=L.keccak_256=L.keccak_224=L.sha3_512=L.sha3_384=L.sha3_256=L.sha3_224=L.Keccak=void 0,L.keccakP=m;const e=Gr(),t=Da(),n=Ka(),r=[],s=[],i=[],o=BigInt(0),a=BigInt(1),c=BigInt(2),h=BigInt(7),f=BigInt(256),d=BigInt(113);for(let S=0,b=a,_=1,R=0;S<24;S++){[_,R]=[R,(2*_+3*R)%5],r.push(2*(5*R+_)),s.push((S+1)*(S+2)/2%64);let x=o;for(let g=0;g<7;g++)b=(b<<a^(b>>h)*d)%f,b&c&&(x^=a<<(a<<BigInt(g))-a);i.push(x)}const[l,y]=(0,t.split)(i,!0),p=(S,b,_)=>_>32?(0,t.rotlBH)(S,b,_):(0,t.rotlSH)(S,b,_),E=(S,b,_)=>_>32?(0,t.rotlBL)(S,b,_):(0,t.rotlSL)(S,b,_);function m(S,b=24){const _=new Uint32Array(10);for(let R=24-b;R<24;R++){for(let v=0;v<10;v++)_[v]=S[v]^S[v+10]^S[v+20]^S[v+30]^S[v+40];for(let v=0;v<10;v+=2){const u=(v+8)%10,I=(v+2)%10,M=_[I],w=_[I+1],D=p(M,w,1)^_[u],$=E(M,w,1)^_[u+1];for(let ne=0;ne<50;ne+=10)S[v+ne]^=D,S[v+ne+1]^=$}let x=S[2],g=S[3];for(let v=0;v<24;v++){const u=s[v],I=p(x,g,u),M=E(x,g,u),w=r[v];x=S[w],g=S[w+1],S[w]=I,S[w+1]=M}for(let v=0;v<50;v+=10){for(let u=0;u<10;u++)_[u]=S[v+u];for(let u=0;u<10;u++)S[v+u]^=~_[(u+2)%10]&_[(u+4)%10]}S[0]^=l[R],S[1]^=y[R]}_.fill(0)}class k extends n.Hash{constructor(b,_,R,x=!1,g=24){if(super(),this.blockLen=b,this.suffix=_,this.outputLen=R,this.enableXOF=x,this.rounds=g,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,e.anumber)(R),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,n.u32)(this.state)}keccak(){n.isLE||(0,n.byteSwap32)(this.state32),m(this.state32,this.rounds),n.isLE||(0,n.byteSwap32)(this.state32),this.posOut=0,this.pos=0}update(b){(0,e.aexists)(this);const{blockLen:_,state:R}=this;b=(0,n.toBytes)(b);const x=b.length;for(let g=0;g<x;){const v=Math.min(_-this.pos,x-g);for(let u=0;u<v;u++)R[this.pos++]^=b[g++];this.pos===_&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:b,suffix:_,pos:R,blockLen:x}=this;b[R]^=_,_&128&&R===x-1&&this.keccak(),b[x-1]^=128,this.keccak()}writeInto(b){(0,e.aexists)(this,!1),(0,e.abytes)(b),this.finish();const _=this.state,{blockLen:R}=this;for(let x=0,g=b.length;x<g;){this.posOut>=R&&this.keccak();const v=Math.min(R-this.posOut,g-x);b.set(_.subarray(this.posOut,this.posOut+v),x),this.posOut+=v,x+=v}return b}xofInto(b){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(b)}xof(b){return(0,e.anumber)(b),this.xofInto(new Uint8Array(b))}digestInto(b){if((0,e.aoutput)(b,this),this.finished)throw new Error("digest() was already called");return this.writeInto(b),this.destroy(),b}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(b){const{blockLen:_,suffix:R,outputLen:x,rounds:g,enableXOF:v}=this;return b||(b=new k(_,R,x,v,g)),b.state32.set(this.state32),b.pos=this.pos,b.posOut=this.posOut,b.finished=this.finished,b.rounds=g,b.suffix=R,b.outputLen=x,b.enableXOF=v,b.destroyed=this.destroyed,b}}L.Keccak=k;const O=(S,b,_)=>(0,n.wrapConstructor)(()=>new k(b,S,_));L.sha3_224=O(6,144,224/8),L.sha3_256=O(6,136,256/8),L.sha3_384=O(6,104,384/8),L.sha3_512=O(6,72,512/8),L.keccak_224=O(1,144,224/8),L.keccak_256=O(1,136,256/8),L.keccak_384=O(1,104,384/8),L.keccak_512=O(1,72,512/8);const K=(S,b,_)=>(0,n.wrapXOFConstructorWithOpts)((R={})=>new k(b,S,R.dkLen===void 0?_:R.dkLen,!0));return L.shake128=K(31,168,128/8),L.shake256=K(31,136,256/8),L}var Wn;function Ba(){if(Wn)return G;Wn=1;const{sha3_512:e}=$a(),t=24,n=32,r=(p=4,E=Math.random)=>{let m="";for(;m.length<p;)m=m+Math.floor(E()*36).toString(36);return m};function s(p){let E=8n,m=0n;for(const k of p.values()){const O=BigInt(k);m=(m<<E)+O}return m}const i=(p="")=>s(e(p)).toString(36).slice(1),o=Array.from({length:26},(p,E)=>String.fromCharCode(E+97)),a=p=>o[Math.floor(p()*o.length)],c=({globalObj:p=typeof Rn<"u"?Rn:typeof window<"u"?window:{},random:E=Math.random}={})=>{const m=Object.keys(p).toString(),k=m.length?m+r(n,E):r(n,E);return i(k).substring(0,n)},h=p=>()=>p++,f=476782367,d=({random:p=Math.random,counter:E=h(Math.floor(p()*f)),length:m=t,fingerprint:k=c({random:p})}={})=>function(){const K=a(p),S=Date.now().toString(36),b=E().toString(36),_=r(m,p),R=`${S+_+b+k}`;return`${K+i(R).substring(1,m)}`},l=d(),y=(p,{minLength:E=2,maxLength:m=n}={})=>{const k=p.length,O=/^[0-9a-z]+$/;try{if(typeof p=="string"&&k>=E&&k<=m&&O.test(p))return!0}finally{}return!1};return G.getConstants=()=>({defaultLength:t,bigLength:n}),G.init=d,G.createId=l,G.bufToBigInt=s,G.createCounter=h,G.createFingerprint=c,G.isCuid=y,G}var qn;function Pa(){if(qn)return ue;qn=1;const{createId:e,init:t,getConstants:n,isCuid:r}=Ba();return ue.createId=e,ue.init=t,ue.getConstants=n,ue.isCuid=r,ue}var Ft=Pa(),Va="SIGNATURE",Ha="ENCRYPTION",Ua="SYMMETRIC",ja="LINK_HASH",Fr={SIGNATURE:Va,ENCRYPTION:Ha,SYMMETRIC:Ua,LINK_HASH:ja},it="ROOT",ye={isValid:!0},Wr={type:"EPHEMERAL",name:"EPHEMERAL"},{LINK_HASH:Ya}=Fr,Re=e=>oe(Ya,e),qr=({graph:e,action:t,user:n,context:r={},keys:s})=>{const{publicKey:i,secretKey:o}=n.keys.encryption,{publicKey:a}=s.encryption,c={...t,...r,userId:n.userId,timestamp:Date.now(),prev:e.head??[]},h=ee.encryptBytes({secret:c,recipientPublicKey:a,senderSecretKey:o}),f=Re(h),d={hash:f,body:c},l={senderPublicKey:i,recipientPublicKey:a,encryptedBody:h};return{root:e.root??f,head:[f],encryptedLinks:{...e.encryptedLinks,[f]:l},links:{...e.links,[f]:d}}},Ge=(e,t)=>e.links[t],zr=(e,t)=>Ga(e)[t]||[],Ga=X(e=>{const t={};for(const n of Object.values(e.links)){const r=n.body.prev;for(const s of r){const i=t[s]||[];i.push(n.hash),t[s]=i}}return t}),Fe=e=>Object.keys(e.links),Fa=(e,t)=>`${e.head.join("")}:${t}`,Oe=X((e,t)=>{const n=Ge(e,t);A(n);const r=n.body.prev,s=r.flatMap(i=>Oe(e,i));return Gt(r.concat(s))},Fa),Wa=(e,t,n)=>t!==void 0&&n!==void 0&&t.hash in e.links&&n.hash in e.links&&Oe(e,n.hash).includes(t.hash),qa=(e,t,n)=>Oe(e,n).includes(t),za=(e,t)=>`${e.head.join("")}:${t}`,Jr=X((e,t)=>{const n=zr(e,t),r=n.flatMap(s=>Jr(e,s));return Gt(n.concat(r))},za),Ja=(e,t,n)=>Jr(e,n).includes(t),Xa=(e,t)=>Za(e)[t],Za=X(e=>{const t={};for(const n in e.links){const r=n;t[r]=Fe(e).filter(s=>Qa(e,r,s)).sort()}return t}),Qa=(e,t,n)=>t!==n&&!qa(e,t,n)&&!Ja(e,t,n),ec=e=>{const t={},n=s=>{const i=[s];for(const o of Xa(e,s))t[o]||(t[o]=!0,i.push(...n(o)));return i},r=[];for(const s in e.links){const i=s;if(!t[i]){t[i]=!0;const o=n(i);o.length>1&&r.push(o)}}return r},tc={root:void 0,head:void 0,encryptedLinks:{},links:{}},nc=({user:e,id:t=Ft.createId(),name:n=t,rootPayload:r={},context:s={},keys:i})=>{const o={name:n,id:t,...r};return qr({graph:tc,action:{type:it,prev:[],payload:o},user:e,context:s,keys:i})},rc=e=>(t,n)=>{const r=typeof e=="function"?e(n):n[e];return{...t,[r]:n}},sc={GRAPH:"GRAPH",USER:"USER"},ic=e=>e.encryption.hasOwnProperty("secretKey")&&e.signature.hasOwnProperty("secretKey")&&"secretKey"in e,ot=e=>e!==void 0&&"secretKey"in e&&"encryption"in e&&"signature"in e,oc=e=>!Array.isArray(e)&&!ot(e),de=e=>oc(e)?e:(ot(e)&&(e=[e]),e.reduce(rc(t=>t.encryption.publicKey),{})),Xr=(e,t)=>{const{senderPublicKey:n,recipientPublicKey:r,encryptedBody:s}=e,o=de(t)[r];A(o,"Can't decrypt link: don't have the correct keyset");const a=ac(s),c=ee.decryptBytes({cipher:a,recipientSecretKey:o.encryption.secretKey,senderPublicKey:n});return{hash:Re(s),body:c}},Wt=({encryptedGraph:e,keys:t})=>{const{encryptedLinks:n,root:r,childMap:s={}}=e,i=e.links??{},o=(c,h={})=>{const f=n[c],d=i[c]??Xr(f,t);let l={[c]:d};const y=s[c]??[];for(const p of y)l={...l,...o(p,l)};return{...h,...l}},a=o(r);return{...e,links:a}},ac=e=>cc(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e),cc=e=>"buffer"in e&&"byteOffset"in e&&"byteLength"in e,dc=(e,t)=>Object.fromEntries(t.map(n=>[n,uc(e,n)])),uc=(e,t)=>e.encryptedLinks[t],hc=e=>e.head.map(t=>Ge(e,t));function St(e,t){return typeof t=="string"?Ge(e,t).body.prev:t.body.prev.map(r=>Ge(e,r))}var pt={},Tt=({graph:e,depth:t,start:n=e.head,end:r=[],prev:s,hashes:i})=>i?i.reduce((o,a)=>({...o,[a]:St(e,a)}),pt):(s&&(n=lc(s)),t===0?pt:n.reduce((o,a)=>{const c=St(e,a),h=c.filter(d=>!(d in o)).filter(d=>!r.includes(d)),f=Tt({graph:e,depth:t?t-1:void 0,start:h,end:r});return{...o,[a]:c,...f}},pt)),lc=e=>Object.keys(e).flatMap(s=>e[s]).filter(s=>!(s in e)),qt=e=>{const t={};for(const n of Fe(e))for(const r of St(e,n))t[r]||(t[r]=[]),t[r].push(n);return t},fc=e=>{const t={},n=Object.keys(e);for(const r of n)for(const s of e[r])t[s]||(t[s]=[]),t[s].push(r);return t},yc=e=>e.links[e.root],pc=(e,t={})=>{const{comparator:n=Zr}=t;let r=Object.values(e.links);const s=Object.fromEntries(r.map(a=>[a.hash,a.body.prev.length])),i=[],o=a=>{i.push(a),r=r.filter(d=>d.hash!==a.hash);const c=zr(e,a.hash);for(const d of c)s[d]--;if(c.length!==1)return;const h=c[0];if(s[h]>0)return;const f=e.links[h];o(f)};for(;r.length>0;){const c=r.filter(h=>s[h.hash]===0).sort(n).shift();o(c)}return i},Zr=(e,t)=>e.hash<t.hash?-1:e.hash>t.hash?1:0,Qr=(e,t=es)=>{const{sort:n=Zr,filter:r=vc}=t(e);return pc(e,{comparator:n}).map(i=>{const o=i.isInvalid??!r(i);return{...i,isInvalid:o}})},es=e=>({}),vc=e=>!0,Be=(e,t)=>e===void 0||t===void 0||e.length!==t.length?!1:(e.sort(),t.sort(),e.every((n,r)=>n===t[r])),ts=(e,t)=>{if(e.root!==t.root)throw new Error("Cannot merge two graphs with different roots");const n={...t.links,...e.links},r={...t.encryptedLinks,...e.encryptedLinks},i=Gt([...e.head,...t.head]).filter(mc(n)),o={root:e.root,head:i,encryptedLinks:r,links:n};return o.head=o.head.sort(),o},mc=e=>t=>!Object.values(e).some(gc(t)),gc=e=>t=>t.body.prev.includes(e),Ec=e=>{const{head:t,root:n,encryptedLinks:r}=e,s=qt(e);return{head:t,root:n,encryptedLinks:r,childMap:s}},bc=e=>Kt(Ec(e)),Ic=(e,t)=>{const n=$t(e);return Wt({encryptedGraph:n,keys:t})},{SIGNATURE:_c,ENCRYPTION:Sc,SYMMETRIC:Tc}=Fr,Z=(e,t=be())=>{const{type:n,name:r=n}=e,s=Sr(`${r}:${n}:${t}`);return{type:n,name:r,generation:0,signature:ae.keyPair(oe(_c,s).slice(0,32)),encryption:ee.keyPair(oe(Sc,s).slice(0,32)),secretKey:oe(Tc,s)}},Mt=e=>{let t;for(const n in e){const r=e[n];(t===void 0||r.generation>t.generation)&&(t=r)}return t},Q=e=>ic(e)?{type:e.type,name:e.name,generation:e.generation,encryption:e.encryption.publicKey,signature:e.signature.publicKey}:e,Mc=class extends Error{type;details;constructor(t,n){super(),this.message=t,this.details=n}},kc={validateHash(e,t){const{hash:n}=e,{encryptedBody:r}=t.encryptedLinks[n],s=Re(r);return n===s?ye:q("The hash calculated for this link does not match.",{link:e,hash:n,expected:s})},validatePrev(e,t){for(const n of e.body.prev)if(!(n in t.links))return q("The link referenced by one of the hashes in the `prev` property does not exist.");return ye},validateRoot(e,t){const n=e.body.prev.length===0,r="type"in e.body&&e.body.type===it,s=yc(t)===e;return n===s&&s===r?ye:q(r?n?"The ROOT link has to be the link referenced by the graph `root` property":"The ROOT link cannot have any predecessors":n?"Non-ROOT links must have predecessors":"The link referenced by the graph `root` property must be a ROOT link",{link:e,graph:t})},validateTimestamps(e,t){const{timestamp:n}=e.body,r=Date.now();if(n>r)return q("The link's timestamp is in the future.",{link:e,now:r});for(const s of e.body.prev){const i=t.links[s];if(i.body.timestamp>n)return q("This link's timestamp can't be earlier than a previous link.",{link:e,prevLink:i})}return ye}},q=(e,t)=>({isValid:!1,error:new Mc(e,t)}),Ac=(e,t={})=>{{const o=e.root,a=e.encryptedLinks[o],c=Re(a.encryptedBody);if(c!==o)return q("Root hash does not match the hash of the root link",{rootHash:o,computedHash:c,rootLink:a})}for(const o of e.head){const a=e.encryptedLinks[o],c=Re(a.encryptedBody);if(c!==o)return q("Head hash does not match the hash of the head link",{headHash:o,computedHash:c,headLink:a})}const n=Object.keys(e.encryptedLinks),r=Object.keys(e.links);if(n.length!==r.length)return q("Number of encrypted links does not match number of links",{encryptedLinkHashes:n,linkHashes:r});const i=((...o)=>a=>{const c=wc(o);for(const h in c){const f=c[h];try{const d=f(a,e);if(!d.isValid)return d}catch(d){const{message:l}=d;return q(l,d)}}return ye})(kc,t);for(const o of Object.values(e.links)){const a=i(o);if(!a.isValid)return a}return ye},zt=X(Ac,e=>oe("memoize",e)),wc=e=>e.reduce((t,n)=>Object.assign(t,n),{}),ns=({initialState:e,reducer:t,resolver:n,validators:r})=>s=>(zt(s,r),Qr(s,n).reduce(t,e)),Rc=class extends st{user;context;initialState;reducer;resolver;validators;keyring;graph;state;constructor({user:e,context:t={},graph:n,rootPayload:r,initialState:s={},reducer:i,validators:o,resolver:a=es,keys:c}){super(),n===void 0?(A(ot(c),"If no graph is provided, only pass a single keyset, not a keyring."),this.graph=nc({user:e,rootPayload:r,keys:c})):Oc(n)?this.graph=n:(A(c),this.graph=Ic(n,c)),this.context=t,this.initialState=s,this.reducer=i,this.validators=o,this.resolver=a,this.user=e,this.keyring=de(c),this.updateState()}getState(){return this.state}getGraph(){return this.graph}save(){return bc(this.graph)}dispatch(e,t){const n={payload:void 0,...e};if(t===void 0){const s=this.graph.head.sort()[0],i=this.graph.encryptedLinks[s].recipientPublicKey;t=this.keyring[i]}else this.keyring[t.encryption.publicKey]=t;this.graph=qr({graph:this.graph,action:n,user:this.user,keys:t,context:this.context});const[r]=hc(this.graph);return this.state=this.reducer(this.state,r),this.emit("updated",{head:this.graph.head}),e}merge(e){this.graph=ts(this.graph,e),this.updateState()}validate(){return zt(this.graph,this.validators)}updateState(){const e=ns({initialState:this.initialState,reducer:this.reducer,resolver:this.resolver,validators:this.validators});this.state=e(this.graph),this.emit("updated",{head:this.graph.head})}},Oc=e=>e?.hasOwnProperty("root"),zn=e=>new Rc(e),xc=(e,t)=>{const n={root:e.root,head:e.head},{their:r,our:s,lastCommonHead:i}=t,o={...t},a=e.head,c=r.head;if(s.reportedError)return n.error=s.reportedError,delete s.reportedError,[o,n];if(Be(a,i))return[o,void 0];if(Be(a,c))return o.lastCommonHead=a,[o,n];const d=Object.fromEntries([...c,...c.flatMap(m=>Oe(e,m)),...i,...i.flatMap(m=>Oe(e,m)),...Object.keys(r.parentMap),...s.links].map(m=>[m,!0]));let l=[];if(c.length>0&&c.every(m=>m in e.links))l=Fe(e).filter(m=>!(m in d));else{if(r.parentMap){const m={...e.encryptedLinks,...r.encryptedLinks};n.need=Object.keys(d).filter(k=>!(k in m)),l=Fe(e).filter(k=>!(k in d))}Be(a,s.parentMapAtHead)||(n.parentMap=Tt({graph:e,end:i}),o.our.parentMapAtHead=a)}const E=r.need.concat(l);if(E.length>0){n.links=dc(e,E);const m=Tt({graph:e,hashes:E});n.parentMap={...n.parentMap,...m}}return o.our.links=s.links.concat(E),o.their.need=[],[o,n]},Jn=()=>({their:{head:[],encryptedLinks:{},need:[],parentMap:{}},our:{head:[],links:[]},lastCommonHead:[],failedSyncCount:0}),Lc=(e,t,n,r,s=Wt)=>{const i=de(r),o=n;A(e.root===o.root,"Can't sync graphs with different roots");const a={...t,their:{head:o.head,need:o.need??[],encryptedLinks:{...t.their.encryptedLinks,...o.links},parentMap:{...t.their.parentMap,...o.parentMap}}};if(Object.keys(a.their.encryptedLinks).length>0){const{head:c}=o,h=qt(e),f=fc(a.their.parentMap),d={...h,...f},l={...e.encryptedLinks,...a.their.encryptedLinks},y={...e,head:c,encryptedLinks:l,childMap:d},p=s({encryptedGraph:y,keys:i}),E=ts(e,p),m=zt(E);m.isValid?e=E:(a.failedSyncCount+=1,a.our.reportedError=m.error),a.their.encryptedLinks={},a.their.parentMap={}}return[e,a]},_h=(e,t=Ft.createId(),n=be())=>({userName:e,userId:t,keys:Z({type:sc.USER,name:t},n)}),Cc=e=>{const{userId:t,userName:n}=e;return{userId:t,userName:n,keys:Q(e.keys)}};function Dc(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof On<"u")return On}function Nc(){const e=Dc();if(e.__xstate__)return e.__xstate__}const Kc=e=>{if(typeof window>"u")return;const t=Nc();t&&t.register(e)};class Xn{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const n={value:t,next:null};if(this._current){this._last.next=n,this._last=n;return}this._current=n,this._last=n,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const rs=".",$c="",ss="",Bc="#",Pc="*",is="xstate.init",kt="xstate.stop";function Vc(e,t){return{type:`xstate.after.${e}.${t}`}}function At(e,t){return{type:`xstate.done.state.${e}`,output:t}}function Hc(e,t){return{type:`xstate.done.actor.${e}`,output:t,actorId:e}}function Uc(e,t){return{type:`xstate.error.actor.${e}`,error:t,actorId:e}}function os(e){return{type:is,input:e}}function F(e){setTimeout(()=>{throw e})}const jc=typeof Symbol=="function"&&Symbol.observable||"@@observable";function as(e,t){const n=Zn(e),r=Zn(t);return typeof r=="string"?typeof n=="string"?r===n:!1:typeof n=="string"?n in r:Object.keys(n).every(s=>s in r?as(n[s],r[s]):!1)}function Jt(e){if(ds(e))return e;const t=[];let n="";for(let r=0;r<e.length;r++){switch(e.charCodeAt(r)){case 92:n+=e[r+1],r++;continue;case 46:t.push(n),n="";continue}n+=e[r]}return t.push(n),t}function Zn(e){if(Td(e))return e.value;if(typeof e!="string")return e;const t=Jt(e);return Yc(t)}function Yc(e){if(e.length===1)return e[0];const t={};let n=t;for(let r=0;r<e.length-1;r++)if(r===e.length-2)n[e[r]]=e[r+1];else{const s=n;n={},s[e[r]]=n}return t}function Qn(e,t){const n={},r=Object.keys(e);for(let s=0;s<r.length;s++){const i=r[s];n[i]=t(e[i],i,e,s)}return n}function cs(e){return ds(e)?e:[e]}function z(e){return e===void 0?[]:cs(e)}function wt(e,t,n,r){return typeof e=="function"?e({context:t,event:n,self:r}):e}function ds(e){return Array.isArray(e)}function Gc(e){return e.type.startsWith("xstate.error.actor")}function fe(e){return cs(e).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function us(e){if(!(e===void 0||e===$c))return z(e)}function Rt(e,t,n){const r=typeof e=="object",s=r?e:void 0;return{next:(r?e.next:e)?.bind(s),error:(r?e.error:t)?.bind(s),complete:(r?e.complete:n)?.bind(s)}}function er(e,t){return`${t}.${e}`}function Xt(e,t){const n=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!n)return e.implementations.actors[t];const[,r,s]=n,o=e.getStateNodeById(s).config.invoke;return(Array.isArray(o)?o[r]:o).src}function tr(e,t){return`${e.sessionId}.${t}`}let Fc=0;function Wc(e,t){const n=new Map,r=new Map,s=new WeakMap,i=new Set,o={},{clock:a,logger:c}=t,h={schedule:(l,y,p,E,m=Math.random().toString(36).slice(2))=>{const k={source:l,target:y,event:p,delay:E,id:m,startedAt:Date.now()},O=tr(l,m);d._snapshot._scheduledEvents[O]=k;const K=a.setTimeout(()=>{delete o[O],delete d._snapshot._scheduledEvents[O],d._relay(l,y,p)},E);o[O]=K},cancel:(l,y)=>{const p=tr(l,y),E=o[p];delete o[p],delete d._snapshot._scheduledEvents[p],E!==void 0&&a.clearTimeout(E)},cancelAll:l=>{for(const y in d._snapshot._scheduledEvents){const p=d._snapshot._scheduledEvents[y];p.source===l&&h.cancel(l,p.id)}}},f=l=>{if(!i.size)return;const y={...l,rootId:e.sessionId};i.forEach(p=>p.next?.(y))},d={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${Fc++}`,_register:(l,y)=>(n.set(l,y),l),_unregister:l=>{n.delete(l.sessionId);const y=s.get(l);y!==void 0&&(r.delete(y),s.delete(l))},get:l=>r.get(l),_set:(l,y)=>{const p=r.get(l);if(p&&p!==y)throw new Error(`Actor with system ID '${l}' already exists.`);r.set(l,y),s.set(y,l)},inspect:l=>{const y=Rt(l);return i.add(y),{unsubscribe(){i.delete(y)}}},_sendInspectionEvent:f,_relay:(l,y,p)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:l,actorRef:y,event:p}),y._send(p)},scheduler:h,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{const l=d._snapshot._scheduledEvents;d._snapshot._scheduledEvents={};for(const y in l){const{source:p,target:E,event:m,delay:k,id:O}=l[y];h.schedule(p,E,m,k,O)}},_clock:a,_logger:c};return d}let vt=!1;const Zt=1;let P=function(e){return e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped",e}({});const qc={clock:{setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e)},logger:console.log.bind(console),devTools:!1};class zc{constructor(t,n){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new Xn(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=P.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const r={...qc,...n},{clock:s,logger:i,parent:o,syncSnapshot:a,id:c,systemId:h,inspect:f}=r;this.system=o?o.system:Wc(this,{clock:s,logger:i}),f&&!o&&this.system.inspect(Rt(f)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=n?.logger??this.system._logger,this.clock=n?.clock??this.system._clock,this._parent=o,this._syncSnapshot=a,this.options=r,this.src=r.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:d=>{this._deferred.push(d)},system:this.system,stopChild:d=>{if(d._parent!==this)throw new Error(`Cannot stop child actor ${d.id} of ${this.id} because it is not a child`);d._stop()},emit:d=>{const l=this.eventListeners.get(d.type),y=this.eventListeners.get("*");if(!l&&!y)return;const p=[...l?l.values():[],...y?y.values():[]];for(const E of p)E(d)},actionExecutor:d=>{const l=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:d.type,params:d.params}}),!d.exec)return;const y=vt;try{vt=!0,d.exec(d.info,d.params)}finally{vt=y}};this._processingStatus===P.Running?l():this._deferred.push(l)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),h&&(this._systemId=h,this.system._set(h,this)),this._initState(n?.snapshot??n?.state),h&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(n){this._snapshot={status:"error",output:void 0,error:n}}}update(t,n){this._snapshot=t;let r;for(;r=this._deferred.shift();)try{r()}catch(s){this._deferred.length=0,this._snapshot={...t,status:"error",error:s}}switch(this._snapshot.status){case"active":for(const s of this.observers)try{s.next?.(t)}catch(i){F(i)}break;case"done":for(const s of this.observers)try{s.next?.(t)}catch(i){F(i)}this._stopProcedure(),this._complete(),this._doneEvent=Hc(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:n,snapshot:t})}subscribe(t,n,r){const s=Rt(t,n,r);if(this._processingStatus!==P.Stopped)this.observers.add(s);else switch(this._snapshot.status){case"done":try{s.complete?.()}catch(i){F(i)}break;case"error":{const i=this._snapshot.error;if(!s.error)F(i);else try{s.error(i)}catch(o){F(o)}break}}return{unsubscribe:()=>{this.observers.delete(s)}}}on(t,n){let r=this.eventListeners.get(t);r||(r=new Set,this.eventListeners.set(t,r));const s=n.bind(void 0);return r.add(s),{unsubscribe:()=>{r.delete(s)}}}start(){if(this._processingStatus===P.Running)return this;this._syncSnapshot&&this.subscribe({next:r=>{r.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:r})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=P.Running;const t=os(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(r){return this._snapshot={...this._snapshot,status:"error",error:r},this._error(r),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let n,r;try{n=this.logic.transition(this._snapshot,t,this._actorScope)}catch(s){r={err:s}}if(r){const{err:s}=r;this._snapshot={...this._snapshot,status:"error",error:s},this._error(s);return}this.update(n,t),t.type===kt&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===P.Stopped?this:(this.mailbox.clear(),this._processingStatus===P.NotStarted?(this._processingStatus=P.Stopped,this):(this.mailbox.enqueue({type:kt}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(const t of this.observers)try{t.complete?.()}catch(n){F(n)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||F(t);return}let n=!1;for(const r of this.observers){const s=r.error;n||=!s;try{s?.(t)}catch(i){F(i)}}this.observers.clear(),n&&F(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,Uc(this.id,t))}_stopProcedure(){return this._processingStatus!==P.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new Xn(this._process.bind(this)),this._processingStatus=P.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==P.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:Kc)(this)}toJSON(){return{xstate$$type:Zt,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[jc](){return this}getSnapshot(){return this._snapshot}}function xe(e,...[t]){return new zc(e,t)}function Jc(e,t,n,r,{sendId:s}){const i=typeof s=="function"?s(n,r):s;return[t,{sendId:i},void 0]}function Xc(e,t){e.defer(()=>{e.system.scheduler.cancel(e.self,t.sendId)})}function Zc(e){function t(n,r){}return t.type="xstate.cancel",t.sendId=e,t.resolve=Jc,t.execute=Xc,t}function Qc(e,t,n,r,{id:s,systemId:i,src:o,input:a,syncSnapshot:c}){const h=typeof o=="string"?Xt(t.machine,o):o,f=typeof s=="function"?s(n):s;let d,l;return h&&(l=typeof a=="function"?a({context:t.context,event:n.event,self:e.self}):a,d=xe(h,{id:f,src:o,parent:e.self,syncSnapshot:c,systemId:i,input:l})),[ce(t,{children:{...t.children,[f]:d}}),{id:s,systemId:i,actorRef:d,src:o,input:l},void 0]}function ed(e,{actorRef:t}){t&&e.defer(()=>{t._processingStatus!==P.Stopped&&t.start()})}function td(...[e,{id:t,systemId:n,input:r,syncSnapshot:s=!1}={}]){function i(o,a){}return i.type="xstate.spawnChild",i.id=t,i.systemId=n,i.src=e,i.input=r,i.syncSnapshot=s,i.resolve=Qc,i.execute=ed,i}function nd(e,t,n,r,{actorRef:s}){const i=typeof s=="function"?s(n,r):s,o=typeof i=="string"?t.children[i]:i;let a=t.children;return o&&(a={...a},delete a[o.id]),[ce(t,{children:a}),o,void 0]}function rd(e,t){if(t){if(e.system._unregister(t),t._processingStatus!==P.Running){e.stopChild(t);return}e.defer(()=>{e.stopChild(t)})}}function hs(e){function t(n,r){}return t.type="xstate.stopChild",t.actorRef=e,t.resolve=nd,t.execute=rd,t}function sd(e,{context:t,event:n},{guards:r}){return r.every(s=>at(s,t,n,e))}function nr(e){function t(n,r){return!1}return t.check=sd,t.guards=e,t}function at(e,t,n,r){const{machine:s}=r,i=typeof e=="function",o=i?e:s.implementations.guards[typeof e=="string"?e:e.type];if(!i&&!o)throw new Error(`Guard '${typeof e=="string"?e:e.type}' is not implemented.'.`);if(typeof o!="function")return at(o,t,n,r);const a={context:t,event:n},c=i||typeof e=="string"?void 0:"params"in e?typeof e.params=="function"?e.params({context:t,event:n}):e.params:void 0;return"check"in o?o.check(r,a,o):o(a,c)}const Qt=e=>e.type==="atomic"||e.type==="final";function me(e){return Object.values(e.states).filter(t=>t.type!=="history")}function De(e,t){const n=[];if(t===e)return n;let r=e.parent;for(;r&&r!==t;)n.push(r),r=r.parent;return n}function We(e){const t=new Set(e),n=fs(t);for(const r of t)if(r.type==="compound"&&(!n.get(r)||!n.get(r).length))rr(r).forEach(s=>t.add(s));else if(r.type==="parallel"){for(const s of me(r))if(s.type!=="history"&&!t.has(s)){const i=rr(s);for(const o of i)t.add(o)}}for(const r of t){let s=r.parent;for(;s;)t.add(s),s=s.parent}return t}function ls(e,t){const n=t.get(e);if(!n)return{};if(e.type==="compound"){const s=n[0];if(s){if(Qt(s))return s.key}else return{}}const r={};for(const s of n)r[s.key]=ls(s,t);return r}function fs(e){const t=new Map;for(const n of e)t.has(n)||t.set(n,[]),n.parent&&(t.has(n.parent)||t.set(n.parent,[]),t.get(n.parent).push(n));return t}function ys(e,t){const n=We(t);return ls(e,fs(n))}function en(e,t){return t.type==="compound"?me(t).some(n=>n.type==="final"&&e.has(n)):t.type==="parallel"?me(t).every(n=>en(e,n)):t.type==="final"}const ct=e=>e[0]===Bc;function id(e,t){return e.transitions.get(t)||[...e.transitions.keys()].filter(r=>{if(r===Pc)return!0;if(!r.endsWith(".*"))return!1;const s=r.split("."),i=t.split(".");for(let o=0;o<s.length;o++){const a=s[o],c=i[o];if(a==="*")return o===s.length-1;if(a!==c)return!1}return!0}).sort((r,s)=>s.length-r.length).flatMap(r=>e.transitions.get(r))}function od(e){const t=e.config.after;if(!t)return[];const n=s=>{const i=Vc(s,e.id),o=i.type;return e.entry.push(Cd(i,{id:o,delay:s})),e.exit.push(Zc(o)),o};return Object.keys(t).flatMap(s=>{const i=t[s],o=typeof i=="string"?{target:i}:i,a=Number.isNaN(+s)?s:+s,c=n(a);return z(o).map(h=>({...h,event:c,delay:a}))}).map(s=>{const{delay:i}=s;return{...se(e,s.event,s),delay:i}})}function se(e,t,n){const r=us(n.target),s=n.reenter??!1,i=dd(e,r),o={...n,actions:z(n.actions),guard:n.guard,target:i,source:e,reenter:s,eventType:t,toJSON:()=>({...o,source:`#${e.id}`,target:i?i.map(a=>`#${a.id}`):void 0})};return o}function ad(e){const t=new Map;if(e.config.on)for(const n of Object.keys(e.config.on)){if(n===ss)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const r=e.config.on[n];t.set(n,fe(r).map(s=>se(e,n,s)))}if(e.config.onDone){const n=`xstate.done.state.${e.id}`;t.set(n,fe(e.config.onDone).map(r=>se(e,n,r)))}for(const n of e.invoke){if(n.onDone){const r=`xstate.done.actor.${n.id}`;t.set(r,fe(n.onDone).map(s=>se(e,r,s)))}if(n.onError){const r=`xstate.error.actor.${n.id}`;t.set(r,fe(n.onError).map(s=>se(e,r,s)))}if(n.onSnapshot){const r=`xstate.snapshot.${n.id}`;t.set(r,fe(n.onSnapshot).map(s=>se(e,r,s)))}}for(const n of e.after){let r=t.get(n.eventType);r||(r=[],t.set(n.eventType,r)),r.push(n)}return t}function cd(e,t){const n=typeof t=="string"?e.states[t]:t?e.states[t.target]:void 0;if(!n&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${e.id}`);const r={source:e,actions:!t||typeof t=="string"?[]:z(t.actions),eventType:null,reenter:!1,target:n?[n]:[],toJSON:()=>({...r,source:`#${e.id}`,target:n?[`#${n.id}`]:[]})};return r}function dd(e,t){if(t!==void 0)return t.map(n=>{if(typeof n!="string")return n;if(ct(n))return e.machine.getStateNodeById(n);const r=n[0]===rs;if(r&&!e.parent)return qe(e,n.slice(1));const s=r?e.key+n:n;if(e.parent)try{return qe(e.parent,s)}catch(i){throw new Error(`Invalid transition definition for state node '${e.id}':
${i.message}`)}else throw new Error(`Invalid target: "${n}" is not a valid target from the root node. Did you mean ".${n}"?`)})}function ps(e){const t=us(e.config.target);return t?{target:t.map(n=>typeof n=="string"?qe(e.parent,n):n)}:e.parent.initial}function ie(e){return e.type==="history"}function rr(e){const t=vs(e);for(const n of t)for(const r of De(n,e))t.add(r);return t}function vs(e){const t=new Set;function n(r){if(!t.has(r)){if(t.add(r),r.type==="compound")n(r.initial.target[0]);else if(r.type==="parallel")for(const s of me(r))n(s)}}return n(e),t}function ge(e,t){if(ct(t))return e.machine.getStateNodeById(t);if(!e.states)throw new Error(`Unable to retrieve child state '${t}' from '${e.id}'; no child states exist.`);const n=e.states[t];if(!n)throw new Error(`Child state '${t}' does not exist on '${e.id}'`);return n}function qe(e,t){if(typeof t=="string"&&ct(t))try{return e.machine.getStateNodeById(t)}catch{}const n=Jt(t).slice();let r=e;for(;n.length;){const s=n.shift();if(!s.length)break;r=ge(r,s)}return r}function ze(e,t){if(typeof t=="string"){const s=e.states[t];if(!s)throw new Error(`State '${t}' does not exist on '${e.id}'`);return[e,s]}const n=Object.keys(t),r=n.map(s=>ge(e,s)).filter(Boolean);return[e.machine.root,e].concat(r,n.reduce((s,i)=>{const o=ge(e,i);if(!o)return s;const a=ze(o,t[i]);return s.concat(a)},[]))}function ud(e,t,n,r){const i=ge(e,t).next(n,r);return!i||!i.length?e.next(n,r):i}function hd(e,t,n,r){const s=Object.keys(t),i=ge(e,s[0]),o=tn(i,t[s[0]],n,r);return!o||!o.length?e.next(n,r):o}function ld(e,t,n,r){const s=[];for(const i of Object.keys(t)){const o=t[i];if(!o)continue;const a=ge(e,i),c=tn(a,o,n,r);c&&s.push(...c)}return s.length?s:e.next(n,r)}function tn(e,t,n,r){return typeof t=="string"?ud(e,t,n,r):Object.keys(t).length===1?hd(e,t,n,r):ld(e,t,n,r)}function fd(e){return Object.keys(e.states).map(t=>e.states[t]).filter(t=>t.type==="history")}function te(e,t){let n=e;for(;n.parent&&n.parent!==t;)n=n.parent;return n.parent===t}function yd(e,t){const n=new Set(e),r=new Set(t);for(const s of n)if(r.has(s))return!0;for(const s of r)if(n.has(s))return!0;return!1}function ms(e,t,n){const r=new Set;for(const s of e){let i=!1;const o=new Set;for(const a of r)if(yd(Ot([s],t,n),Ot([a],t,n)))if(te(s.source,a.source))o.add(a);else{i=!0;break}if(!i){for(const a of o)r.delete(a);r.add(s)}}return Array.from(r)}function pd(e){const[t,...n]=e;for(const r of De(t,void 0))if(n.every(s=>te(s,r)))return r}function nn(e,t){if(!e.target)return[];const n=new Set;for(const r of e.target)if(ie(r))if(t[r.id])for(const s of t[r.id])n.add(s);else for(const s of nn(ps(r),t))n.add(s);else n.add(r);return[...n]}function gs(e,t){const n=nn(e,t);if(!n)return;if(!e.reenter&&n.every(s=>s===e.source||te(s,e.source)))return e.source;const r=pd(n.concat(e.source));if(r)return r;if(!e.reenter)return e.source.machine.root}function Ot(e,t,n){const r=new Set;for(const s of e)if(s.target?.length){const i=gs(s,n);s.reenter&&s.source===i&&r.add(i);for(const o of t)te(o,i)&&r.add(o)}return[...r]}function vd(e,t){if(e.length!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function xt(e,t,n,r,s,i){if(!e.length)return t;const o=new Set(t._nodes);let a=t.historyValue;const c=ms(e,o,a);let h=t;s||([h,a]=bd(h,r,n,c,o,a,i,n.actionExecutor)),h=Ee(h,r,n,c.flatMap(d=>d.actions),i,void 0),h=gd(h,r,n,c,o,i,a,s);const f=[...o];h.status==="done"&&(h=Ee(h,r,n,f.sort((d,l)=>l.order-d.order).flatMap(d=>d.exit),i,void 0));try{return a===t.historyValue&&vd(t._nodes,o)?h:ce(h,{_nodes:f,historyValue:a})}catch(d){throw d}}function md(e,t,n,r,s){if(r.output===void 0)return;const i=At(s.id,s.output!==void 0&&s.parent?wt(s.output,e.context,t,n.self):void 0);return wt(r.output,e.context,i,n.self)}function gd(e,t,n,r,s,i,o,a){let c=e;const h=new Set,f=new Set;Ed(r,o,f,h),a&&f.add(e.machine.root);const d=new Set;for(const l of[...h].sort((y,p)=>y.order-p.order)){s.add(l);const y=[];y.push(...l.entry);for(const p of l.invoke)y.push(td(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(f.has(l)){const p=l.initial.actions;y.push(...p)}if(c=Ee(c,t,n,y,i,l.invoke.map(p=>p.id)),l.type==="final"){const p=l.parent;let E=p?.type==="parallel"?p:p?.parent,m=E||l;for(p?.type==="compound"&&i.push(At(p.id,l.output!==void 0?wt(l.output,c.context,t,n.self):void 0));E?.type==="parallel"&&!d.has(E)&&en(s,E);)d.add(E),i.push(At(E.id)),m=E,E=E.parent;if(E)continue;c=ce(c,{status:"done",output:md(c,t,n,c.machine.root,m)})}}return c}function Ed(e,t,n,r){for(const s of e){const i=gs(s,t);for(const a of s.target||[])!ie(a)&&(s.source!==a||s.source!==i||s.reenter)&&(r.add(a),n.add(a)),pe(a,t,n,r);const o=nn(s,t);for(const a of o){const c=De(a,i);i?.type==="parallel"&&c.push(i),Es(r,t,n,c,!s.source.parent&&s.reenter?void 0:i)}}}function pe(e,t,n,r){if(ie(e))if(t[e.id]){const s=t[e.id];for(const i of s)r.add(i),pe(i,t,n,r);for(const i of s)mt(i,e.parent,r,t,n)}else{const s=ps(e);for(const i of s.target)r.add(i),s===e.parent?.initial&&n.add(e.parent),pe(i,t,n,r);for(const i of s.target)mt(i,e.parent,r,t,n)}else if(e.type==="compound"){const[s]=e.initial.target;ie(s)||(r.add(s),n.add(s)),pe(s,t,n,r),mt(s,e,r,t,n)}else if(e.type==="parallel")for(const s of me(e).filter(i=>!ie(i)))[...r].some(i=>te(i,s))||(ie(s)||(r.add(s),n.add(s)),pe(s,t,n,r))}function Es(e,t,n,r,s){for(const i of r)if((!s||te(i,s))&&e.add(i),i.type==="parallel")for(const o of me(i).filter(a=>!ie(a)))[...e].some(a=>te(a,o))||(e.add(o),pe(o,t,n,e))}function mt(e,t,n,r,s){Es(n,r,s,De(e,t))}function bd(e,t,n,r,s,i,o,a){let c=e;const h=Ot(r,s,i);h.sort((d,l)=>l.order-d.order);let f;for(const d of h)for(const l of fd(d)){let y;l.history==="deep"?y=p=>Qt(p)&&te(p,d):y=p=>p.parent===d,f??={...i},f[l.id]=Array.from(s).filter(y)}for(const d of h)c=Ee(c,t,n,[...d.exit,...d.invoke.map(l=>hs(l.id))],o,void 0),s.delete(d);return[c,f||i]}function Id(e,t){return e.implementations.actions[t]}function bs(e,t,n,r,s,i){const{machine:o}=e;let a=e;for(const c of r){const h=typeof c=="function",f=h?c:Id(o,typeof c=="string"?c:c.type),d={context:a.context,event:t,self:n.self,system:n.system},l=h||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:t}):c.params:void 0;if(!f||!("resolve"in f)){n.actionExecutor({type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",info:d,params:l,exec:f});continue}const y=f,[p,E,m]=y.resolve(n,a,d,l,f,s);a=p,"retryResolve"in y&&i?.push([y,E]),"execute"in y&&n.actionExecutor({type:y.type,info:d,params:E,exec:y.execute.bind(null,n,E)}),m&&(a=bs(a,t,n,m,s,i))}return a}function Ee(e,t,n,r,s,i){const o=i?[]:void 0,a=bs(e,t,n,r,{internalQueue:s,deferredActorIds:i},o);return o?.forEach(([c,h])=>{c.retryResolve(n,a,h)}),a}function gt(e,t,n,r){let s=e;const i=[];function o(h,f,d){n.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:n.self,event:f,snapshot:h,_transitions:d}),i.push(h)}if(t.type===kt)return s=ce(sr(s,t,n),{status:"stopped"}),o(s,t,[]),{snapshot:s,microstates:i};let a=t;if(a.type!==is){const h=a,f=Gc(h),d=ir(h,s);if(f&&!d.length)return s=ce(e,{status:"error",error:h.error}),o(s,h,[]),{snapshot:s,microstates:i};s=xt(d,e,n,a,!1,r),o(s,h,d)}let c=!0;for(;s.status==="active";){let h=c?_d(s,a):[];const f=h.length?s:void 0;if(!h.length){if(!r.length)break;a=r.shift(),h=ir(a,s)}s=xt(h,s,n,a,!1,r),c=s!==f,o(s,a,h)}return s.status!=="active"&&sr(s,a,n),{snapshot:s,microstates:i}}function sr(e,t,n){return Ee(e,t,n,Object.values(e.children).map(r=>hs(r)),[],void 0)}function ir(e,t){return t.machine.getTransitionData(t,e)}function _d(e,t){const n=new Set,r=e._nodes.filter(Qt);for(const s of r)e:for(const i of[s].concat(De(s,void 0)))if(i.always){for(const o of i.always)if(o.guard===void 0||at(o.guard,e.context,t,e)){n.add(o);break e}}return ms(Array.from(n),new Set(e._nodes),e.historyValue)}function Sd(e,t){const n=We(ze(e,t));return ys(e,[...n])}function Td(e){return!!e&&typeof e=="object"&&"machine"in e&&"value"in e}const Md=function(t){return as(t,this.value)},kd=function(t){return this.tags.has(t)},Ad=function(t){const n=this.machine.getTransitionData(this,t);return!!n?.length&&n.some(r=>r.target!==void 0||r.actions.length)},wd=function(){const{_nodes:t,tags:n,machine:r,getMeta:s,toJSON:i,can:o,hasTag:a,matches:c,...h}=this;return{...h,tags:Array.from(n)}},Rd=function(){return this._nodes.reduce((t,n)=>(n.meta!==void 0&&(t[n.id]=n.meta),t),{})};function Pe(e,t){return{status:e.status,output:e.output,error:e.error,machine:t,context:e.context,_nodes:e._nodes,value:ys(t.root,e._nodes),tags:new Set(e._nodes.flatMap(n=>n.tags)),children:e.children,historyValue:e.historyValue||{},matches:Md,hasTag:kd,can:Ad,getMeta:Rd,toJSON:wd}}function ce(e,t={}){return Pe({...e,...t},e.machine)}function Od(e,t){const{_nodes:n,tags:r,machine:s,children:i,context:o,can:a,hasTag:c,matches:h,getMeta:f,toJSON:d,...l}=e,y={};for(const E in i){const m=i[E];y[E]={snapshot:m.getPersistedSnapshot(t),src:m.src,systemId:m._systemId,syncSnapshot:m._syncSnapshot}}return{...l,context:Is(o),children:y}}function Is(e){let t;for(const n in e){const r=e[n];if(r&&typeof r=="object")if("sessionId"in r&&"send"in r&&"ref"in r)t??=Array.isArray(e)?e.slice():{...e},t[n]={xstate$$type:Zt,id:r.id};else{const s=Is(r);s!==r&&(t??=Array.isArray(e)?e.slice():{...e},t[n]=s)}}return t??e}function xd(e,t,n,r,{event:s,id:i,delay:o},{internalQueue:a}){const c=t.machine.implementations.delays;if(typeof s=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${s}" }) instead`);const h=typeof s=="function"?s(n,r):s;let f;if(typeof o=="string"){const d=c&&c[o];f=typeof d=="function"?d(n,r):d}else f=typeof o=="function"?o(n,r):o;return typeof f!="number"&&a.push(h),[t,{event:h,id:i,delay:f},void 0]}function Ld(e,t){const{event:n,delay:r,id:s}=t;if(typeof r=="number"){e.defer(()=>{const i=e.self;e.system.scheduler.schedule(i,i,n,r,s)});return}}function Cd(e,t){function n(r,s){}return n.type="xstate.raise",n.event=e,n.id=t?.id,n.delay=t?.delay,n.resolve=xd,n.execute=Ld,n}function Dd(e,{machine:t,context:n},r,s){const i=(o,a={})=>{const{systemId:c,input:h}=a;if(typeof o=="string"){const f=Xt(t,o);if(!f)throw new Error(`Actor logic '${o}' not implemented in machine '${t.id}'`);const d=xe(f,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:typeof h=="function"?h({context:n,event:r,self:e.self}):h,src:o,systemId:c});return s[d.id]=d,d}else return xe(o,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:a.input,src:o,systemId:c})};return(o,a)=>{const c=i(o,a);return s[c.id]=c,e.defer(()=>{c._processingStatus!==P.Stopped&&c.start()}),c}}function Nd(e,t,n,r,{assignment:s}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const i={},o={context:t.context,event:n.event,spawn:Dd(e,t,n.event,i),self:e.self,system:e.system};let a={};if(typeof s=="function")a=s(o,r);else for(const h of Object.keys(s)){const f=s[h];a[h]=typeof f=="function"?f(o,r):f}const c=Object.assign({},t.context,a);return[ce(t,{context:c,children:Object.keys(i).length?{...t.children,...i}:t.children}),void 0,void 0]}function V(e){function t(n,r){}return t.type="xstate.assign",t.assignment=e,t.resolve=Nd,t}function Y(e,t){const n=z(t);if(!n.includes(e.type)){const r=n.length===1?`type "${n[0]}"`:`one of types "${n.join('", "')}"`;throw new Error(`Expected event ${JSON.stringify(e)} to have ${r}`)}}const or=new WeakMap;function he(e,t,n){let r=or.get(e);return r?t in r||(r[t]=n()):(r={[t]:n()},or.set(e,r)),r[t]}const Kd={},Se=e=>typeof e=="string"?{type:e}:typeof e=="function"?"resolve"in e?{type:e.type}:{type:e.name}:e;class rn{constructor(t,n){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=n._parent,this.key=n._key,this.machine=n._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(rs),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?Qn(this.config.states,(r,s)=>new rn(r,{_parent:this,_key:s,_machine:this.machine})):Kd,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=z(this.config.entry).slice(),this.exit=z(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=z(t.tags).slice()}_initialize(){this.transitions=ad(this),this.config.always&&(this.always=fe(this.config.always).map(t=>se(this,ss,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(Se),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(Se),eventType:null})}:void 0,history:this.history,states:Qn(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(Se)})),entry:this.entry.map(Se),exit:this.exit.map(Se),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return he(this,"invoke",()=>z(this.config.invoke).map((t,n)=>{const{src:r,systemId:s}=t,i=t.id??er(this.id,n),o=typeof r=="string"?r:`xstate.invoke.${er(this.id,n)}`;return{...t,src:o,id:i,systemId:s,toJSON(){const{onDone:a,onError:c,...h}=t;return{...h,type:"xstate.invoke",src:o,id:i}}}}))}get on(){return he(this,"on",()=>[...this.transitions].flatMap(([n,r])=>r.map(s=>[n,s])).reduce((n,[r,s])=>(n[r]=n[r]||[],n[r].push(s),n),{}))}get after(){return he(this,"delayedTransitions",()=>od(this))}get initial(){return he(this,"initial",()=>cd(this,this.config.initial))}next(t,n){const r=n.type,s=[];let i;const o=he(this,`candidates-${r}`,()=>id(this,r));for(const a of o){const{guard:c}=a,h=t.context;let f=!1;try{f=!c||at(c,h,n,t)}catch(d){const l=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${l?`'${l}' `:""}in transition for event '${r}' in state node '${this.id}':
${d.message}`)}if(f){s.push(...a.actions),i=a;break}}return i?[i]:void 0}get events(){return he(this,"events",()=>{const{states:t}=this,n=new Set(this.ownEvents);if(t)for(const r of Object.keys(t)){const s=t[r];if(s.states)for(const i of s.events)n.add(`${i}`)}return Array.from(n)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(n=>this.transitions.get(n).some(r=>!(!r.target&&!r.actions.length&&!r.reenter))));return Array.from(t)}}const $d="#";class sn{constructor(t,n){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=t.id||"(machine)",this.implementations={actors:n?.actors??{},actions:n?.actions??{},delays:n?.delays??{},guards:n?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new rn(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:n,guards:r,actors:s,delays:i}=this.implementations;return new sn(this.config,{actions:{...n,...t.actions},guards:{...r,...t.guards},actors:{...s,...t.actors},delays:{...i,...t.delays}})}resolveState(t){const n=Sd(this.root,t.value),r=We(ze(this.root,n));return Pe({_nodes:[...r],context:t.context||{},children:{},status:en(r,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,n,r){return gt(t,n,r,[]).snapshot}microstep(t,n,r){return gt(t,n,r,[]).microstates}getTransitionData(t,n){return tn(this.root,t.value,t,n)||[]}getPreInitialState(t,n,r){const{context:s}=this.config,i=Pe({context:typeof s!="function"&&s?s:{},_nodes:[this.root],children:{},status:"active"},this);return typeof s=="function"?Ee(i,n,t,[V(({spawn:a,event:c,self:h})=>s({spawn:a,input:c.input,self:h}))],r,void 0):i}getInitialSnapshot(t,n){const r=os(n),s=[],i=this.getPreInitialState(t,r,s),o=xt([{target:[...vs(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],i,t,r,!0,s),{snapshot:a}=gt(o,r,t,s);return a}start(t){Object.values(t.children).forEach(n=>{n.getSnapshot().status==="active"&&n.start()})}getStateNodeById(t){const n=Jt(t),r=n.slice(1),s=ct(n[0])?n[0].slice($d.length):n[0],i=this.idMap.get(s);if(!i)throw new Error(`Child state node '#${s}' does not exist on machine '${this.id}'`);return qe(i,r)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,n){return Od(t,n)}restoreSnapshot(t,n){const r={},s=t.children;Object.keys(s).forEach(c=>{const h=s[c],f=h.snapshot,d=h.src,l=typeof d=="string"?Xt(this,d):d;if(!l)return;const y=xe(l,{id:c,parent:n.self,syncSnapshot:h.syncSnapshot,snapshot:f,src:d,systemId:h.systemId});r[c]=y});const i=Pe({...t,children:r,_nodes:Array.from(We(ze(this.root,t.value)))},this),o=new Set;function a(c,h){if(!o.has(c)){o.add(c);for(const f in c){const d=c[f];if(d&&typeof d=="object"){if("xstate$$type"in d&&d.xstate$$type===Zt){c[f]=h[d.id];continue}a(d,h)}}}}return a(i.context,r),i}}function Bd(e,t){return new sn(e,t)}function Pd({schemas:e,actors:t,actions:n,guards:r,delays:s}){return{createMachine:i=>Bd({...i,schemas:e},{actors:t,actions:n,guards:r,delays:s})}}var Vd=Object.defineProperty,dt=(e,t)=>{for(var n in t)Vd(e,n,{get:t[n],enumerable:!0})},Hd={};dt(Hd,{Connection:()=>mh,DEVICE_REMOVED:()=>cn,DEVICE_UNKNOWN:()=>dn,ENCRYPTION_FAILURE:()=>Xe,IDENTITY_PROOF_INVALID:()=>un,INVITATION_PROOF_INVALID:()=>hn,JOINED_WRONG_TEAM:()=>ln,MEMBER_REMOVED:()=>fn,NEITHER_IS_MEMBER:()=>yn,SERVER_REMOVED:()=>pn,TIMEOUT:()=>vn,UNHANDLED:()=>mn,connectionErrors:()=>Ls,createErrorMessage:()=>Lt,isInviteeClaim:()=>ve,isInviteeContext:()=>lt,isInviteeDeviceClaim:()=>vh,isInviteeDeviceContext:()=>Zs,isInviteeMemberClaim:()=>ei,isInviteeMemberContext:()=>kn,isMemberClaim:()=>Nt,isMemberContext:()=>Xs,isServerContext:()=>Qs});var _s=e=>{const t=n=>{switch(n.type){case"ADD_MEMBER":return n.payload.member.userId;case"REMOVE_MEMBER":return n.payload.userId;case"ADD_ROLE":return n.payload.roleName;case"ADD_MEMBER_ROLE":case"REMOVE_MEMBER_ROLE":return`${n.payload.roleName}:${n.payload.userId}`;case"ADD_DEVICE":return n.payload.device.deviceId;case"REMOVE_DEVICE":return n.payload.deviceId;case"INVITE_MEMBER":case"INVITE_DEVICE":return n.payload.invitation.id;case"REVOKE_INVITATION":return n.payload.id;case"ADMIT_MEMBER":case"ADMIT_DEVICE":return n.payload.id;case"CHANGE_MEMBER_KEYS":return JSON.stringify(n.payload.keys);default:return JSON.stringify(n.payload)}};return e.body.type==="ROOT"?"ROOT":`${e.body.type}:${t(e.body)}`},Ss=(e,t)=>{if(!e||!t)return!1;const n=r=>r.sort().join(",");return n(e)===n(t)},Ts=e=>!["INVITE_DEVICE","ADD_DEVICE","REMOVE_DEVICE","CHANGE_MEMBER_KEYS","CHANGE_SERVER_KEYS","ADMIT_MEMBER","ADMIT_DEVICE"].includes(e.type),Ud={};dt(Ud,{ADMIN:()=>j});var j="admin",jd=e=>(t,n)=>{if(ar(e,t))return-1;if(ar(e,n))return 1;const r=o=>{const a=h=>h.body.type==="ADD_MEMBER"&&h.body.payload.member.userId===o,c=Object.values(e.links).find(a);return A(c,`Could not find link that added member ${o}`),c},[s,i]=[t,n].map(r);return Wa(e,s,i)?-1:1},ar=(e,t)=>e.links[e.root].body.userId===t,Je=e=>{const t=ec(e).map(r=>r.map(s=>e.links[s])),n=[];for(let r of t)for(const s in cr){const i=cr[s],o=i(r,e),a=o.flatMap(c=>Ms(r,c));n.push(...o,...a),r=r.filter(hr(n))}return{filter:hr(n)}},Ms=(e,t)=>{const n=[];switch(t.body.type){case"INVITE_MEMBER":case"INVITE_DEVICE":{const{invitation:s}=t.body.payload;n.push(...e.filter(Zd(s)));break}case"ADMIT_MEMBER":{const s=t.body.payload.memberKeys.name;n.push(...e.filter(Rs(s)));break}}const r=n.flatMap(s=>Ms(e,s));return n.concat(r)},cr={resolveMutualRemovals(e,t){const n=dr(e),r=ws(e).map(an);return n.length>0&&Ss(n,r)?e.filter(Rs(Yd(t,r))):[]},cantAddBackRemovedMember(e){const t=dr(e);return Wd(e).filter(n=>t.includes(Xd(n)))},cantDoAnythingWhenRemoved(e){const t=zd(e);return e.filter(ur(t))},cantDoAdminActionsWhenDemoted(e){const t=Jd(e),n=ur(t),r=s=>Ts(s.body);return e.filter(s=>n(s)&&r(s))}},Yd=(e,t)=>t.sort(jd(e)).pop(),Gd=e=>["ADD_MEMBER","ADD_MEMBER_ROLE","ADMIT_MEMBER"].includes(e.body.type),Fd=e=>e.body.type==="REMOVE_MEMBER",Wd=e=>e.filter(Gd),ks=e=>e.filter(Fd),qd=e=>e.body.type==="REMOVE_MEMBER_ROLE"&&e.body.payload.roleName===j,As=e=>e.filter(qd),ws=e=>ks(e).concat(As(e)),dr=e=>ws(e).map(on),zd=e=>ks(e).map(on),Jd=e=>As(e).map(on),on=e=>e.body.payload.userId,an=e=>e.body.userId,Rs=e=>t=>an(t)===e,ur=e=>t=>e.includes(an(t)),Xd=e=>{switch(e.body.type){case"ADD_MEMBER":return e.body.payload.member.userId;case"ADD_MEMBER_ROLE":return e.body.payload.userId;case"ADMIT_MEMBER":return e.body.payload.memberKeys.name}},hr=e=>t=>!e.includes(t),Zd=e=>t=>(t.body.type==="ADMIT_MEMBER"||t.body.type==="ADMIT_DEVICE")&&t.body.payload.id===e.id,Sh=e=>Qr(e,Je).filter(n=>!n.isInvalid).map(n=>_s(n)).join(","),Qd="SIGNATURE",eu="ENCRYPTION",tu="SYMMETRIC",nu="LINK_HASH",ru="LINK_TO_PREVIOUS",su="INVITATION",iu="DEVICE_ID",ou="SHARED_KEY",Os={SIGNATURE:Qd,ENCRYPTION:eu,SYMMETRIC:tu,LINK_HASH:nu,LINK_TO_PREVIOUS:ru,INVITATION:su,DEVICE_ID:iu,SHARED_KEY:ou},B={isValid:!0},au=e=>t=>e.reduce((n,r)=>r(n),t),lr=e=>({type:e.type,name:e.name}),cu=e=>`${e.recipient.name}(${du(e.recipient.publicKey)}):${e.contents.name}#${e.contents.generation}`,du=e=>e.slice(0,5),xs=(e,t)=>e.type===t.type&&e.name===t.name,fr=(e,t)=>{A(xs(e,t),`The scope of the new keys must match those of the old lockbox. 
     New scope: ${JSON.stringify(lr(e))} 
     Old scope: ${JSON.stringify(lr(t))}`)},N={GRAPH:"GRAPH",TEAM:"TEAM",ROLE:"ROLE",USER:"USER",DEVICE:"DEVICE",SERVER:"SERVER",EPHEMERAL:"EPHEMERAL"},uu=class extends Error{constructor(e,t){super(),this.message=e,this.details=t}name;details},hu=(e,t)=>{const n=typeof e=="string"?Ue.decode(e):e,r=typeof t=="string"?Ue.decode(t):t,s=[n,r].sort(lu).reduce((o,a)=>new Uint8Array([...o,...a]),new Uint8Array);return(typeof e=="string"?oe:si)(Os.SHARED_KEY,s)},lu=(e,t)=>{const n=e.toString(),r=t.toString();return n<r?-1:n>r?1:0},cn="DEVICE_REMOVED",dn="DEVICE_UNKNOWN",Xe="ENCRYPTION_FAILURE",un="IDENTITY_PROOF_INVALID",hn="INVITATION_PROOF_INVALID",ln="JOINED_WRONG_TEAM",fn="MEMBER_REMOVED",yn="NEITHER_IS_MEMBER",pn="SERVER_REMOVED",vn="TIMEOUT",mn="UNHANDLED",Ls={[cn]:{localMessage:"The peer's device was removed from this team",remoteMessage:"Your device was removed from this team"},[dn]:{localMessage:"The peer's device isn't listed on this team",remoteMessage:"Your device isn't listed on this team"},[Xe]:{localMessage:"Unable to establish a secure connection"},[un]:{localMessage:"The peer's proof of identity is not valid",remoteMessage:"Your proof of identity isn't valid"},[hn]:{localMessage:"The peer's invitation wasn't accepted",remoteMessage:"Your invitation wasn't accepted"},[ln]:{localMessage:"This isn't the team you were invited to",remoteMessage:"This isn't the team the peer was invited to"},[fn]:{localMessage:"The peer was removed from this team",remoteMessage:"You were removed from this team"},[yn]:{localMessage:"The peer is also holding an invitation and cannot admit you to the team"},[pn]:{localMessage:"The server was removed from this team",remoteMessage:"You (a server) were removed from this team"},[vn]:{localMessage:"We didn't hear back from the peer; giving up",remoteMessage:"The peer didn't hear back from you, so they gave up"},[mn]:{localMessage:"An unhandled error occurred"}},Lt=(e,t="LOCAL")=>{const{localMessage:n,remoteMessage:r=n}=Ls[e];return{type:t==="LOCAL"?"LOCAL_ERROR":"ERROR",payload:{type:e,message:t==="LOCAL"?n:r}}};function gn(e){const t=Sr(e);return oe(Os.INVITATION,t).slice(0,15)}var Le=e=>e.replaceAll(/[^a-z\d]/gi,""),Ne=X(e=>(e=Le(e),Z(Wr,e))),ke=X(e=>{e=Le(e);const t=gn(e),n=Ne(e),r={id:t},s=ae.sign(r,n.signature.secretKey);return{id:t,signature:s}}),fu=e=>{const t=qt(e),{encryptedLinks:n,head:r,root:s}=e,o=Kt({encryptedLinks:n,childMap:t,head:r,root:s});return vu(o)},Cs=(e,t)=>{const n=$t(e);return Wt({encryptedGraph:n,keys:t})},yu=(e,t)=>pu(e)?e:Cs(e,t),pu=e=>e?.hasOwnProperty("root"),vu=e=>new Uint8Array(e.buffer,e.byteOffset,e.byteLength),le="ALL",Ae={head:[],teamName:"",members:[],servers:[],roles:[],lockboxes:[],invitations:{},messages:[],removedMembers:[],removedDevices:[],removedServers:[],pendingKeyRotations:[]},Ze={type:N.TEAM,name:N.TEAM},mu={type:N.ROLE,name:j},Th={type:N.EPHEMERAL,name:N.EPHEMERAL},gu=(e,t)=>{switch(t.body.type){case"ADMIT_MEMBER":{const n=t.body.payload.memberKeys,r=n.name,s={userName:"",userId:r,keys:n,roles:[]},i=[...e.removedMembers,s],o=[...e.pendingKeyRotations];return o.includes(r)||o.push(r),{...e,removedMembers:i,pendingKeyRotations:o}}}return e},Eu=e=>t=>({...t,head:[e.hash]}),Et=e=>t=>{const{userId:n}=e;return{...t,members:t.members.map(r=>{if(r.userId===n){const{devices:s=[]}=r;return s.find(i=>i.deviceId===e.deviceId)?r:{...r,devices:[...s,e]}}return r}),removedDevices:t.removedDevices.filter(r=>r.keys.name===e.deviceId)}},bt=e=>t=>({...t,members:[...t.members,{...e,roles:[]}],removedMembers:t.removedMembers.filter(n=>n.userId===e.userId)}),It=(e,t=[])=>t.map(n=>r=>({...r,members:r.members.map(s=>({...s,roles:s.userId!==e||s.roles.includes(n)?s.roles:[...s.roles,n]}))})),bu=e=>t=>({...t,messages:[...t.messages,e]}),yr=e=>t=>({...t,roles:[...t.roles,e]}),Ds=Ca,Iu=e=>t=>({...t,servers:Ds([...t.servers,e]),removedServers:t.removedServers.filter(r=>r.host!==e.host)}),_u=e=>t=>({...t,members:t.members.map(n=>n.userId===e.name?{...n,keys:e}:n)}),Su=e=>t=>({...t,servers:t.servers.map(n=>n.host===e.name?{...n,keys:e}:n)}),Tu=e=>t=>{const{lockboxes:n}=t;return e?{...t,lockboxes:n.concat(e)}:t},pr=e=>t=>{const n={...e,uses:0,revoked:!1};return{...t,invitations:{...t.invitations,[e.id]:n}}},En=(e,t,n={includeRemoved:!1})=>{const s=[...e.servers,...n.includeRemoved?e.removedServers:[]].find(i=>i.host===t);if(s===void 0)throw new Error(`A server with host '${t}' was not found`);return s},bn=(e,t)=>e.servers.find(n=>n.host===t)!==void 0,Mu=e=>({userId:e.host,userName:e.host,keys:e.keys,roles:[]}),ku=e=>({userId:e.host,userName:e.host,keys:e.keys}),Au=e=>({userId:e.host,deviceName:e.host,deviceId:e.host,keys:e.keys}),we={toMember:Mu,toUser:ku,toDevice:Au},Ns=(e,t,n={includeRemoved:!1})=>Ks(e,t,n)!==void 0,ut=(e,t,n={includeRemoved:!1})=>{const r=Ks(e,t,n);return A(r,`Device ${t} not found`),r},Ks=(e,t,n={includeRemoved:!1})=>bn(e,t)?we.toDevice(En(e,t)):e.members.concat(n.includeRemoved?e.removedMembers:[]).flatMap(i=>i.devices??[]).find(i=>i.deviceId===t)??(n.includeRemoved?e.removedDevices.find(i=>i.deviceId===t):void 0),wu=(e,t)=>Ns(e,t,{includeRemoved:!0})?e.removedDevices.some(n=>n.keys.name===t):!1,$s=(e,t)=>e.members.find(n=>n.userId===t)!==void 0,Ru=(e,t)=>e.roles.find(n=>n.roleName===t)!==void 0;function In(e,t){return t in e.invitations}function _n(e,t){return A(In(e,t),`No invitation with id '${t}' found.`),e.invitations[t]}var vr=e=>e.hasOwnProperty("publicKey"),U=(e,t)=>{const n=vr(t)?t:Q(t),r=Q(e),s=ee.keyPair(),i=vr(n)?n.publicKey:n.encryption,o=ee.encryptBytes({secret:e,recipientPublicKey:i,senderSecretKey:s.secretKey});return{encryptionKey:{...Wr,publicKey:s.publicKey},recipient:{...n,publicKey:i},contents:{...r,publicKey:e.encryption.publicKey},encryptedPayload:o}},Ou=X((e,t)=>{const{encryptionKey:n,encryptedPayload:r}=e;return ee.decryptBytes({cipher:r,senderPublicKey:n.publicKey,recipientSecretKey:t.encryption.secretKey})}),xu=({oldLockbox:e,newContents:t,updatedRecipientKeys:n})=>{fr(t,e.contents),n&&fr(e.recipient,n),t.generation=e.contents.generation+1;const r=n??e.recipient;return U(t,r)},Bs=(e,t)=>{const{lockboxes:n}=e,{publicKey:r}=t.encryption,i=n.filter(({recipient:a})=>a.publicKey===r).map(a=>Ou(a,t)),o=i.flatMap(a=>Bs(e,a));return[...i,...o]},Ps=(e,t)=>Bs(e,t).reduce(Lu,{}),Lu=(e,t)=>{const{type:n,name:r,generation:s}=t,i=e[n]??{},o=i[r]??[];return o[s]=t,{...e,[n]:{...i,[r]:o}}},Sn=(e,t,n)=>{const s=Ps(e,n)[t.type]?.[t.name];return de(s)},Vs=(e,t,n)=>{const{type:r,name:s}=n,i=Ps(e,t),o=i[r]?i[r][s]:void 0;A(o,`Couldn't find keys: ${JSON.stringify(n)}
     Device: ${t.name}
     Available lockboxes: 
- ${e.lockboxes.map(cu).join(`
- `)} 
     Keymap: ${JSON.stringify(i,null,2)}`);const a="generation"in n&&n.generation!==void 0?n.generation:o.length-1;return o[a]},Cu=(e,t)=>{const n=e.lockboxes.filter(({contents:i})=>i.type===t.type&&i.name===t.name),r=n.reduce(Du,0);return n.filter(({contents:i})=>i.generation===r)},Du=(e,t)=>{const{generation:n}=t.contents;return n>e?n:e},ht=(e,t,n={includeRemoved:!1})=>{const s=[...e.members,...n.includeRemoved?e.removedMembers:[]].find(i=>i.userId===t);if(s===void 0)throw new Error(`A member named '${t}' was not found`);return s},Hs=(e,t,n={includeRemoved:!1})=>{if(bn(e,t))return we.toMember(En(e,t));const{userId:r}=ut(e,t,n);return ht(e,r,n)},Us=(e,t,n)=>{if(!$s(e,t))return!1;const r=ht(e,t),{roles:s=[]}=r;return s.includes(n)},Ve=(e,t)=>Us(e,t,j),Nu=(e,t)=>e.removedMembers.some(n=>n.userId===t),js=(e,t)=>e.members.filter(n=>n.roles?.includes(t)),Ku=e=>js(e,j),$u=e=>e.messages,Bu=(e,t)=>{const n=e.roles.find(r=>r.roleName===t);if(!n)throw new Error(`A role called '${t}' was not found`);return n},Pu=(e,t)=>e.removedServers.some(n=>n.host===t),{TEAM:mr}=N,Vu=(e,t)=>Sn(e,{type:mr,name:mr},t),Ys=(e,{type:t,name:n})=>{const r=e.lockboxes.filter(({recipient:o})=>o.type===t&&o.name===n).map(({contents:{type:o,name:a}})=>({type:o,name:a})),s=r.flatMap(o=>Ys(e,o)),i=[...r,...s];return Ds(i,o=>o.name+o.type)},Hu=(e,t=[])=>n=>{const r=ut(n,e),s=Hs(n,e),{userId:i}=s;let{keys:o}=s;const a=t.find(({contents:d})=>d.type===N.USER&&d.name===i);if(a){const{type:d,name:l,generation:y,encryption:p,signature:E}=a.contents;o.generation<y&&p!==void 0&&E!==void 0&&(o={type:d,name:l,generation:y,encryption:p,signature:E})}const c=d=>d.userId===i?{...d,devices:d.devices?.filter(l=>l.deviceId!==r.deviceId),keys:o}:d,h=n.members.map(c),f=[...n.removedDevices,r];return{...n,members:h,removedDevices:f}},Uu=e=>t=>{const n=t.members.filter(i=>i.userId!==e),r=t.members.find(i=>i.userId===e),s=[...t.removedMembers];return r&&s.push(r),{...t,members:n,removedMembers:s}},ju=(e,t)=>n=>({...n,members:n.members.map(r=>({...r,roles:r.userId===e?r.roles.filter(s=>s!==t):r.roles})),lockboxes:n.lockboxes.filter(r=>!(r.recipient.name===e&&r.contents.type===N.ROLE&&r.contents.name===t))}),Yu=e=>t=>({...t,roles:t.roles.filter(n=>n.roleName!==e),lockboxes:t.lockboxes.filter(n=>!(n.contents.type===N.ROLE&&n.contents.name===e))}),Gu=e=>t=>{const n=t.servers.filter(i=>i.host!==e),r=t.servers.find(i=>i.host===e),s=[...t.removedServers];return r&&s.push(r),{...t,servers:n,removedServers:s}},Fu=e=>t=>{const n={...t.invitations},r={...n[e],revoked:!0};return{...t,invitations:{...n,[e]:r}}},Wu=e=>t=>{const n=t.pendingKeyRotations.filter(r=>r!==e);return{...t,pendingKeyRotations:n}},gr=e=>t=>({...t,teamName:e}),Er=e=>t=>{const n={...t.invitations},r=n[e],s=r.uses+1;return{...t,invitations:{...n,[e]:{...r,uses:s}}}},qu={};dt(qu,{IKEY_LENGTH:()=>Gs,InvitationValidationError:()=>Ws,create:()=>Ct,deriveId:()=>gn,fail:()=>J,generateProof:()=>ke,generateStarterKeys:()=>Ne,invitationCanBeUsed:()=>Tn,randomSeed:()=>Dt,validate:()=>Fs});var Gs=16,Ct=({seed:e,maxUses:t=1,expiration:n=0,userId:r})=>{e=Le(e);const s=gn(e),i=Ne(e),{publicKey:o}=i.signature;return{id:s,publicKey:o,expiration:n,maxUses:t,userId:r}},Dt=(e=Gs)=>be(e),Tn=(e,t)=>{const{revoked:n,maxUses:r,uses:s,expiration:i}=e;return n?J("The invitation has been revoked"):r>0&&s>=r?J("The invitation cannot be used again"):i>0&&i<t?J("The invitation has expired"):B},Fs=X((e,t)=>{const{id:n,signature:r}=e;if(n!==t.id)return J("IDs don't match",{proof:e,invitation:t});const{publicKey:s}=t;return ae.verify({payload:{id:n},signature:r,publicKey:s})?B:J("Signature provided is not valid",{proof:e,invitation:t})}),J=(e,t)=>({isValid:!1,error:new Ws(e,t)}),Ws=class extends Error{constructor(e,t){super(),this.name="Invitation validation failed",this.message=e,this.details=t}index;details},zu=et.extend("auth:validate"),Ju=(...e)=>{for(const t in br){const n=br[t],r=n(...e);if(!r.isValid)return r}return B},br={rootDeviceBelongsToRootUser(...e){const[t,n]=e,{type:r,payload:s}=n.body;if(r!=="ROOT")return B;const{rootDevice:i,rootMember:o}=s;return i.userId!==o.userId?re("The founding device must belong to the founding member (userIds must match).",...e):B},mustBeAdmin(...e){const[t,n]=e,r=n.body,{type:s,userId:i}=r;return s===it?B:Ts(r)&&!Ve(t,i)?re(`Member '${i}' is not an admin`,...e):B},canOnlyRemoveYourOwnDevices(...e){const[t,n]=e,r=n.body.userId;if(Ve(t,r))return B;if(n.body.type==="REMOVE_DEVICE"){const i=n.body.payload.deviceId,a=ut(t,i).userId;if(r!==a)return re("Can't remove another user's device.",...e)}return B},canOnlyChangeYourOwnKeys(...e){const[t,n]=e,r=n.body.userId;if(!Ve(t,r)){if(n.body.type==="CHANGE_MEMBER_KEYS"){const i=n.body.payload.keys.name;if(r!==i)return re("Can't change another user's keys.",...e)}else if(n.body.type==="CHANGE_SERVER_KEYS"){const i=n.body.payload.keys.name;if(r!==i)return re("Can't change another server's keys.",...e)}}return B},cantAdmitWithInvalidInvitation(...e){const[t,n]=e;if(n.body.type==="ADMIT_MEMBER"||n.body.type==="ADMIT_DEVICE"){const{id:r}=n.body.payload,s=_n(t,r);return Tn(s,n.body.timestamp)}return B},uniqueUserNameAndId(...e){const[t,n]=e;if(n.body.type==="ADMIT_MEMBER"){const{userName:r,memberKeys:s}=n.body.payload;if(t.members.find(a=>a.userId===s.name)!==void 0)return re("userId is not unique within the team.",...e);if(t.members.find(a=>a.userName.toLowerCase()===r.toLowerCase())!==void 0)return re("Username is not unique within the team.",...e)}return B}},re=(e,t,n)=>(e=Tr(`${_s(n)} ${e}`),zu(e),{isValid:!1,error:new uu(e,{prevState:t,link:n})}),Qe=(e,t)=>{if(t.isInvalid)return gu(e,t);e=ya(e);const n=Ju(e,t);if(!n.isValid)throw n.error;const r=t.body;return au([Eu(t),Tu(r.payload.lockboxes),...Xu(r)])(e)},Xu=e=>{switch(e.type){case it:{const{name:t,rootMember:n,rootDevice:r}=e.payload;return[gr(t),yr({roleName:j}),bt(n),Et(r),...It(n.userId,[j])]}case"ADD_MEMBER":{const{member:t,roles:n}=e.payload;return[bt(t),...It(t.userId,n)]}case"ADD_ROLE":{const t=e.payload;return[yr(t)]}case"ADD_MEMBER_ROLE":{const{userId:t,roleName:n}=e.payload;return[...It(t,[n])]}case"REMOVE_MEMBER":{const{userId:t}=e.payload;return[Uu(t)]}case"ADD_DEVICE":{const{device:t}=e.payload;return[Et(t)]}case"REMOVE_DEVICE":{const{deviceId:t,lockboxes:n}=e.payload;return[Hu(t,n)]}case"REMOVE_ROLE":{const{roleName:t}=e.payload;return[Yu(t)]}case"REMOVE_MEMBER_ROLE":{const{userId:t,roleName:n}=e.payload;return[ju(t,n)]}case"INVITE_MEMBER":{const{invitation:t}=e.payload;return[pr(t)]}case"INVITE_DEVICE":{const{invitation:t}=e.payload;return[pr(t)]}case"REVOKE_INVITATION":{const{id:t}=e.payload;return[Fu(t)]}case"ADMIT_MEMBER":{const{id:t,memberKeys:n,userName:r}=e.payload,i={userId:n.name,userName:r,keys:n,roles:[]};return[Er(t),bt(i)]}case"ADMIT_DEVICE":{const{id:t,device:n}=e.payload;return[Er(t),Et(n)]}case"CHANGE_MEMBER_KEYS":{const{keys:t}=e.payload;return[_u(t)]}case"ROTATE_KEYS":{const{userId:t}=e.payload;return[Wu(t)]}case"ADD_SERVER":{const{server:t}=e.payload;return[Iu(t)]}case"REMOVE_SERVER":{const{host:t}=e.payload;return[Gu(t)]}case"CHANGE_SERVER_KEYS":{const{keys:t}=e.payload;return[Su(t)]}case"MESSAGE":{const{message:t}=e.payload;return[bu(t)]}case"SET_TEAM_NAME":{const{teamName:t}=e.payload;return[gr(t)]}default:throw Zu(e)}};function Zu(e){const{type:t}=e;return new Error(`Unrecognized link type: ${t}`)}var Qu=ns({initialState:Ae,reducer:Qe,resolver:Je}),qs=(e,t)=>{const n=Cs(e,t);return Qu(n)},{USER:eh}=N,th=({serializedGraph:e,teamKeyring:t,invitationSeed:n})=>{const r=Ne(n),s=ke(n).id,i=qs(e,t),{userId:o}=_n(i,s);A(o);const{userName:a}=ht(i,o);A(a);const c=Sn(i,{type:eh,name:o},r),h=Mt(c);return{user:{userName:a,userId:o,keys:h},userKeyring:c}},nh=e=>({...e,nonce:be(),timestamp:Date.now()}),rh=(e,t)=>ae.sign(e,t.signature.secretKey),sh=(e,t,n)=>{const r={challenge:e,signature:t};return ae.verify({payload:e,signature:t,publicKey:n.signature})?B:ih("Signature is not valid",r)},ih=(e,t)=>({isValid:!1,error:new oh(e,t)}),oh=class extends Error{constructor(e,t){super(),this.name="Identity challenge failed",this.message=e+`
`+JSON.stringify(t,null,2).replaceAll('"',""),this.details=t}details},ah={};dt(ah,{createDevice:()=>ch,redactDevice:()=>Ce});var ch=({userId:e,deviceName:t,deviceInfo:n={},created:r=Date.now(),seed:s=be()})=>{const i=Ft.createId(),o=Z({type:N.DEVICE,name:i},s);return{userId:e,deviceId:i,deviceName:t,keys:o,created:r,deviceInfo:n}},Ce=e=>({...e,keys:Q(e.keys)}),Ir=e=>({...Cc(e),roles:[]}),dh=e=>"teamName"in e,{DEVICE:_t,USER:Ke}=N,Mn=class extends st{state=Ae;store;context;log;seed;constructor(e){if(super(),this.seed=e.seed??be(),"user"in e.context)this.context=e.context;else{const{server:r}=e.context;this.context={...e.context,device:we.toDevice(r),user:we.toUser(r)}}const{device:t,user:n}=this.context;if(this.log=et.extend(`auth:team:${this.userName}`),dh(e)){A(!this.isServer,"Servers can't create teams");const r=U(e.teamKeys,n.keys),s=Z(mu,this.seed),i=U(s,n.keys),o=U(n.keys,this.context.device.keys),a={name:e.teamName,rootMember:Ir(n),rootDevice:Ce(t),lockboxes:[r,i,o]};this.store=zn({user:n,reducer:Qe,resolver:Je,initialState:Ae,rootPayload:a,keys:e.teamKeys})}else this.store=zn({user:n,reducer:Qe,resolver:Je,initialState:Ae,graph:yu(e.source,e.teamKeyring),keys:e.teamKeyring});this.state=this.store.getState(),this.updateUserKeys(),this.on("updated",()=>{this.updateUserKeys(),this.checkForPendingKeyRotations()})}get graph(){return this.store.getGraph()}get id(){return this.graph.root}get teamName(){return this.state.teamName}setTeamName(e){this.dispatch({type:"SET_TEAM_NAME",payload:{teamName:e}})}get userName(){return this.context.user.userId}get userId(){return this.context.user.userId}get isServer(){return"server"in this.context}save=()=>fu(this.graph);merge=e=>(this.store.merge(e),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head}),this);dispatch(e,t=this.teamKeys()){this.store.dispatch(e,t),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head})}has=e=>$s(this.state,e);members(e=le,t={includeRemoved:!0}){return e===le?this.state.members:ht(this.state,e,t)}addForTesting=(e,t=[],n)=>{const r={...Ir(e),roles:t};if(!this.has(r.userId)){const s=this.createMemberLockboxes(r);this.dispatch({type:"ADD_MEMBER",payload:{member:r,roles:t,lockboxes:s}})}if(n){const s=U(e.keys,n.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:n,lockboxes:[s]}})}};remove=e=>{const t=this.rotateKeys({type:Ke,name:e});this.dispatch({type:"REMOVE_MEMBER",payload:{userId:e,lockboxes:t}})};memberWasRemoved=e=>Nu(this.state,e);roles(e=le){return e===le?this.state.roles:Bu(this.state,e)}memberHasRole=(e,t)=>Us(this.state,e,t);memberIsAdmin=e=>Ve(this.state,e);hasRole=e=>Ru(this.state,e);membersInRole=e=>js(this.state,e);admins=()=>Ku(this.state);addRole=e=>{typeof e=="string"&&(e={roleName:e});const t=Z({type:N.ROLE,name:e.roleName},this.seed),n=U(t,this.adminKeys());this.dispatch({type:"ADD_ROLE",payload:{...e,lockboxes:[n]}})};removeRole=e=>{A(e!==j,"Cannot remove admin role"),this.dispatch({type:"REMOVE_ROLE",payload:{roleName:e}})};addMemberRole=(e,t)=>{const n=this.members(e),r=U(this.roleKeys(t),n.keys);this.dispatch({type:"ADD_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:[r]}})};removeMemberRole=(e,t)=>{if(t===j){const r=this.membersInRole(j).length;A(r>1,"Can't remove the last admin")}const n=this.rotateKeys({type:N.ROLE,name:t});this.dispatch({type:"REMOVE_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:n}})};hasDevice=(e,t)=>Ns(this.state,e,t);device(e,t){return ut(this.state,e,t)}removeDevice=e=>{if(!this.hasDevice(e))throw new Error(`Device ${e} not found`);const t=this.rotateKeys({type:_t,name:e});this.dispatch({type:"REMOVE_DEVICE",payload:{deviceId:e,lockboxes:t}})};deviceWasRemoved=e=>wu(this.state,e);memberByDeviceId=(e,t)=>Hs(this.state,e,t);verifyIdentityProof=(e,t)=>{A(e.type===_t);const n=e.name,r=this.hasServer(n)?this.servers(n):this.device(n,{includeRemoved:!0});return sh(e,t,r.keys).isValid};inviteMember({seed:e=Dt(),expiration:t,maxUses:n}={}){e=Le(e);const r=Ct({seed:e,expiration:t,maxUses:n}),{id:s}=r;return this.dispatch({type:"INVITE_MEMBER",payload:{invitation:r}}),{id:s,seed:e}}inviteDevice({seed:e=Dt(),expiration:t=Date.now()+30*60*1e3}={}){A(!this.isServer,"Servers can't invite a device"),e=Le(e);const r=Ct({seed:e,expiration:t,maxUses:1,userId:this.userId}),s=Ne(e),o=Object.values(this.userKeyring()).map(c=>U(c,s)),{id:a}=r;return this.dispatch({type:"INVITE_DEVICE",payload:{invitation:r,lockboxes:o}}),{id:a,seed:e}}revokeInvitation=e=>{this.dispatch({type:"REVOKE_INVITATION",payload:{id:e}})};hasInvitation(e){return In(this.state,e)}getInvitation=e=>_n(this.state,e);validateInvitation=e=>{const{id:t}=e;if(!this.hasInvitation(t))return J("This invitation code doesn't match.");const n=this.getInvitation(t),r=Tn(n,Date.now());return r!==B?r:Fs(e,n)};validateUser=(e,t)=>this.members().find(s=>s.userId===e)!==void 0?J("userId is not unique within the team."):this.members().find(s=>s.userName.toLowerCase()===t.toLowerCase())!==void 0?J("Username is not unique within the team."):B;admitMember=(e,t,n)=>{const r=this.validateInvitation(e);if(!r.isValid)throw r.error;const s=this.validateUser(t.name,n);if(!s.isValid)throw s.error;const{id:i}=e,a=Object.values(this.teamKeyring()).map(c=>U(c,t));this.dispatch({type:"ADMIT_MEMBER",payload:{id:i,userName:n,memberKeys:Q(t),lockboxes:a}})};admitDevice=(e,t)=>{const n=this.validateInvitation(e);if(!n.isValid)throw n.error;const{id:r}=e,i=this.getInvitation(r).userId,o={...t,userId:i};this.dispatch({type:"ADMIT_DEVICE",payload:{id:r,device:o}})};join=(e,t=de(this.context.user.keys))=>{A(!this.isServer,"Can't join as member on server");const{device:n}=this.context,r=Mt(e),s=Object.values(t).map(i=>U(i,n.keys));this.dispatch({type:"ADD_DEVICE",payload:{device:Ce(n),lockboxes:s}},r)};addServer=e=>{const t=this.createMemberLockboxes(we.toMember(e));this.dispatch({type:"ADD_SERVER",payload:{server:e,lockboxes:t}})};removeServer=e=>{this.dispatch({type:"REMOVE_SERVER",payload:{host:e}})};servers(e=le,t={includeRemoved:!0}){return e===le?this.state.servers:En(this.state,e,t)}serverWasRemoved=e=>Pu(this.state,e);hasServer=e=>bn(this.state,e);addMessage=e=>{this.dispatch({type:"MESSAGE",payload:{message:e}})};messages=()=>$u(this.state);encrypt=(e,t)=>{const n=t?{type:N.ROLE,name:t}:Ze,{secretKey:r,generation:s}=this.keys(n);return{contents:He.encryptBytes(e,r),recipient:{...n,generation:s}}};decrypt=e=>{const{secretKey:t}=this.keys(e.recipient);return He.decryptBytes(e.contents,t)};sign=e=>{A(this.context.user);const{keys:{type:t,name:n,generation:r,signature:{secretKey:s}}}=this.context.user;return{contents:e,signature:ae.sign(e,s),author:{type:t,name:n,generation:r}}};verify=e=>ae.verify({payload:e.contents,signature:e.signature,publicKey:this.members(e.author.name).keys.signature});keys=e=>Vs(this.state,this.context.device.keys,e);userKeyring=(e=this.userId)=>Sn(this.state,{type:Ke,name:e},this.context.device.keys);roleKeys=(e,t)=>this.keys({type:N.ROLE,name:e,generation:t});teamKeys=e=>this.keys({...Ze,generation:e});teamKeyring=()=>Vu(this.state,this.context.device.keys);adminKeys=e=>this.roleKeys(j,e);changeKeys=e=>{const{device:t,user:n}=this.context,{type:r}=e;A(r!==_t,"Can't change device keys");const s=r===Ke,i=r===N.SERVER,o=n.keys;e.generation=o.generation+1;const a=this.rotateKeys(e),c=s?"CHANGE_MEMBER_KEYS":"CHANGE_SERVER_KEYS",h=Q(e);this.dispatch({type:c,payload:{keys:h,lockboxes:a}}),(i||s)&&(n.keys=e),i&&(t.keys=e)};updateUserKeys(){const{user:e}=this.context,t=Mt(this.userKeyring());t&&e.keys.generation<t.generation&&(e.keys=t)}checkForPendingKeyRotations(){if(this.memberIsAdmin(this.userId))for(const e of this.state.pendingKeyRotations){const t=this.rotateKeys({type:Ke,name:this.userId});this.dispatch({type:"ROTATE_KEYS",payload:{userId:e,lockboxes:t}})}}createMemberLockboxes=e=>{const t=e.roles.map(this.roleKeys),n=r=>U(r,e.keys);return[...t,this.teamKeys()].map(n)};rotateKeys=e=>{const t=ot(e)?e:Z(e),r=Ys(this.state,e).map(o=>Z(o)),s=[t,...r];return s.flatMap(o=>Cu(this.state,o).map(c=>{const h=s.find(f=>xs(f,c.recipient));return xu({oldLockbox:c,newContents:o,updatedRecipientKeys:h?Q(h):void 0})}))}};function Mh(e,t,n){const r=Z(Ze,n);return new Mn({teamName:e,context:t,teamKeys:r})}var uh=({encryptedGraph:e,teamKeys:t,deviceKeys:n})=>{const r=de(t),{encryptedLinks:s,childMap:i,root:o}=e,a=e.links??{},c=(l,y,p={},E=Ae)=>{const m=s[l],k=a[l]??Xr(m,y);let O={[l]:k};const K=Qe(E,k);let S;try{S=Vs(K,n,Ze),r[S.encryption.publicKey]=S}catch{S=y}const b=i[l];if(b)for(const _ of b)O={...O,...c(_,S,O,K)};return{...p,...O}},h=s[o].recipientPublicKey,f=r[h],d=c(o,f);return{...e,links:d}},kh=(e,t,n)=>{const r=de(n);return new Mn({source:e,context:t,teamKeyring:r})},zs=e=>{if(e===void 0)return"DONE";const{head:t,links:n,need:r}=e,s={head:t};return n&&(s.links=Object.keys(n).join(", ")),r&&(s.need=r.join(", ")),Tr(JSON.stringify(s))},Te=et.extend("message-queue"),hh=class extends st{#e=!1;#t={};#s=0;#n={};#a;#i={};#r=0;#o;constructor({sendMessage:e,timeout:t=1e3}){super(),this.#o=n=>{this.#r=n.index+1,e(n)},this.#a=t}start(){return this.#e=!0,this.#c(),this.#d(),this}stop(){return this.#e=!1,this}send(e){const t=_r(this.#i)+1,n={...e,index:t};return this.#i[t]=n,Te("send %o",n),this.#e&&this.#o(n),this}resend(e){const t=this.#i[e];if(!t)throw new Error(`Received resend request for message #${e}, which doesn't exist.`);return Te("resend %o",t),this.#o(t),this}receive(e){const{index:t}=e;return Te("receive %o",e),this.#t[t]||(this.#t[t]=e,this.#e&&this.#c()),this}#d(){for(Te("processOutbound");this.#i[this.#r];){const e=this.#i[this.#r];this.#o(e)}}#c(){for(Te("processInbound");this.#t[this.#s];){const t=this.#t[this.#s];this.#s++,this.emit("message",t)}const e=_r(this.#t);for(let t=this.#s;t<e;t++)this.#n[t]||(this.#n[t]=setTimeout(()=>{this.#t[t]||this.emit("request",t),delete this.#n[t]},this.#a))}};function _r(e){return Math.max(...Object.keys(e).map(Number),-1)}var lh=e=>e.type==="SYNC"?`SYNC ${zs(e.payload)}`:`${e.type} ${e.payload?.head?.slice(0,5)||e.payload?.message||""}`,fh=e=>typeof e=="string",Js=e=>fh(e)?e:Object.keys(e).map(t=>`${t}:${Js(e[t])}`).filter(t=>t.length).join(","),yh=e=>{const{keys:t,host:n}=e.server;return{...e,user:{userId:n,userName:n,keys:t},device:{userId:n,deviceId:n,deviceName:n,keys:t}}},ph=e=>"server"in e?e.server.host:"userName"in e?e.userName:"user"in e?e.user.userName:"",Xs=e=>"team"in e&&e.team!==void 0,lt=e=>"invitationSeed"in e&&e.invitationSeed!==void 0,kn=e=>lt(e)&&"user"in e&&e.user!==void 0,Zs=e=>lt(e)&&!kn(e),Qs=e=>"server"in e&&e.server!==void 0,Nt=e=>"deviceId"in e&&e.deviceId!==void 0,ei=e=>ve(e)&&"userKeys"in e&&e.userKeys!==void 0,vh=e=>ve(e)&&!("userKeys"in e),ve=e=>"proofOfInvitation"in e&&e.proofOfInvitation!==void 0,mh=class extends st{#e;#t;#s=!1;#n=et.extend("auth:connection");constructor({sendMessage:e,context:t}){super(),this.#t=this.#a(e),this.#n=this.#n.extend(ph(t));const n=Qs(t)?yh(t):t,r=Pd({types:{context:{},events:{}},actions:{requestIdentityClaim:()=>{this.#r("REQUEST_IDENTITY")},sendIdentityClaim:V(({context:s})=>{const o=(a=>{if(Xs(a))return{deviceId:a.device.deviceId};if(kn(a)){A(a.invitationSeed);const{userName:c,keys:h}=a.user;return{proofOfInvitation:ke(a.invitationSeed),userName:c,userKeys:Q(h),device:Ce(a.device)}}if(Zs(a)){A(a.invitationSeed);const{userName:c,device:h}=a;return{proofOfInvitation:ke(a.invitationSeed),userName:c,device:Ce(h)}}throw new Error("Invalid context")})(s);return this.#r("CLAIM_IDENTITY",o),{ourIdentityClaim:o}}),receiveIdentityClaim:V(({event:s})=>{Y(s,"CLAIM_IDENTITY");const i=s.payload,o="device"in i?i.device:void 0;return{theirIdentityClaim:i,theirDevice:o}}),acceptInvitation:V(({context:s})=>{const{team:i,theirIdentityClaim:o}=s;A(i),A(o),A(ve(o));const{proofOfInvitation:a}=o,h=(()=>{if(ei(o)){const{userName:f,userKeys:d}=o;i.admitMember(a,d,f);const l=d.name;return i.members(l)}else{const{device:f}=o;i.admitDevice(a,f);const{deviceId:d}=f,{userId:l}=i.memberByDeviceId(d);return i.members(l)}})();return this.#r("ACCEPT_INVITATION",{serializedGraph:i.save(),teamKeyring:i.teamKeyring()}),{peer:h}}),joinTeam:V(({context:s,event:i})=>{Y(i,"ACCEPT_INVITATION");const{serializedGraph:o,teamKeyring:a}=i.payload,{device:c,invitationSeed:h}=s;A(h);const{user:f,userKeyring:d}=s.user===void 0?th({serializedGraph:o,teamKeyring:a,invitationSeed:h}):{user:s.user,userKeyring:void 0},l=new Mn({source:o,context:{user:f,device:c},teamKeyring:a});return l.join(a,d),this.emit("joined",{team:l,user:f,teamKeyring:a}),{user:f,team:l}}),challengeIdentity:V(({context:s})=>{const{team:i,theirIdentityClaim:o}=s;A(i),A(Nt(o));const{deviceId:a}=o,c=i.device(a,{includeRemoved:!0}),h=i.memberByDeviceId(a,{includeRemoved:!0});this.#n=this.#n.extend(h.userName);const f=nh({type:N.DEVICE,name:a});return this.#r("CHALLENGE_IDENTITY",{challenge:f}),{theirDevice:c,peer:h,challenge:f}}),proveIdentity:({context:s,event:i})=>{Y(i,"CHALLENGE_IDENTITY");const{challenge:o}=i.payload,{keys:a}=s.device,c=rh(o,a);this.#r("PROVE_IDENTITY",{challenge:o,proof:c})},acceptIdentity:()=>this.#r("ACCEPT_IDENTITY"),listenForTeamUpdates:({context:s})=>{A(s.team),s.team.on("updated",({head:i})=>{this.#e.getSnapshot().status!=="done"&&this.#e.send({type:"LOCAL_UPDATE",payload:{head:i}}),this.emit("updated")})},sendSyncMessage:V(({context:s})=>{A(s.team);const i=s.syncState??Jn(),[o,a]=xc(s.team.graph,i);return a?(this.#n("sending sync message",zs(a)),this.#r("SYNC",a)):this.#n("no sync message to send"),{syncState:o}}),receiveSyncMessage:V(({context:s,event:i})=>{Y(i,"SYNC");const o=i.payload,{syncState:a=Jn(),team:c,device:h}=s;A(c);const f=c.teamKeys(),d=h.keys,l=({encryptedGraph:E,keys:m})=>uh({encryptedGraph:E,teamKeys:m,deviceKeys:d}),[y,p]=Lc(c.graph,a,o,f,l);return Be(y.head,c.graph.head)?{syncState:p}:(this.emit("updated"),{team:c.merge(y),syncState:p})}),sendSeed:V(({context:s})=>{const{user:i,peer:o,seed:a=ri()}=s,c=o.keys.encryption,h=i.keys.encryption.secretKey;this.#n(`encrypting seed with key ${c}`);const f=ee.encryptBytes({secret:a,recipientPublicKey:c,senderSecretKey:h});return this.#r("SEED",{encryptedSeed:f}),{seed:a}}),deriveSharedKey:V(({context:s,event:i})=>{Y(i,"SEED");const{encryptedSeed:o}=i.payload,{seed:a,user:c,peer:h}=s,f=o,d=h.keys.encryption,l=c.keys.encryption.secretKey;try{const y=ee.decryptBytes({cipher:f,senderPublicKey:d,recipientSecretKey:l});return{sessionKey:hu(a,y)}}catch(y){if(String(y).includes("incorrect key pair"))return this.#n(`failed to decrypt seed using public key ${d}`,y),this.#i(Xe);throw y}}),receiveEncryptedMessage:({context:s,event:i})=>{Y(i,"ENCRYPTED_MESSAGE");const o=s.sessionKey,a=i.payload;try{const c=He.decryptBytes(a,o);this.emit("message",c)}catch(c){if(String(c).includes("wrong secret key"))return this.#n(`failed to decrypt message using session key ${Ue.encode(o)}`,c),this.#i(Xe);throw c}},fail:V((s,{error:i})=>this.#i(i)),receiveError:V(({event:s})=>{Y(s,"ERROR");const i=s.payload;return this.#n("receiveError: %o",i),this.emit("remoteError",i),{error:i}}),sendError:V(({event:s})=>{Y(s,"LOCAL_ERROR");const i=s.payload;return this.#n("sendError %o",i),this.#t.send(Lt(i.type,"REMOTE")),this.emit("localError",i),{error:i}}),onConnected:()=>this.emit("connected"),onDisconnected:({event:s})=>this.emit("disconnected",s)},guards:{theySentIdentityClaim:({context:s})=>s.theirIdentityClaim!==void 0,weSentIdentityClaim:({context:s})=>s.ourIdentityClaim!==void 0,bothSentIdentityClaim:nr(["theySentIdentityClaim","weSentIdentityClaim"]),weHaveInvitation:({context:s})=>lt(s),theyHaveInvitation:({context:s})=>ve(s.theirIdentityClaim),neitherIsMember:nr(["weHaveInvitation","theyHaveInvitation"]),invitationIsValid:({context:s})=>{const{team:i,theirIdentityClaim:o}=s;return A(ve(o)),i.validateInvitation(o.proofOfInvitation).isValid},joinedTheRightTeam:({context:s,event:i})=>{Y(i,"ACCEPT_INVITATION");const o=s.invitationSeed,{serializedGraph:a,teamKeyring:c}=i.payload,h=qs(a,c),{id:f}=ke(o);return In(h,f)},deviceUnknown:({context:s})=>{const{theirIdentityClaim:i}=s;return A(Nt(i)),!s.team.hasDevice(i.deviceId,{includeRemoved:!0})},identityIsValid:({context:s,event:i})=>{Y(i,"PROVE_IDENTITY");const{challenge:o,proof:a}=i.payload;return s.team.verifyIdentityProof(o,a)},memberWasRemoved:({context:s})=>s.team.memberWasRemoved(s.peer.userId),deviceWasRemoved:({context:s})=>s.team.deviceWasRemoved(s.theirDevice.deviceId),serverWasRemoved:({context:s})=>s.team.serverWasRemoved(s.peer.userId),headsAreEqual:({context:s})=>Ss(s.team.graph.head,s.syncState?.lastCommonHead)}}).createMachine({context:n,id:"connection",entry:"requestIdentityClaim",initial:"awaitingIdentityClaim",on:{REQUEST_IDENTITY:{actions:"sendIdentityClaim",target:".awaitingIdentityClaim"},ERROR:{actions:"receiveError",target:"#disconnected"},LOCAL_ERROR:{actions:"sendError",target:"#disconnected"}},states:{awaitingIdentityClaim:{always:{guard:"bothSentIdentityClaim",target:"authenticating"},on:{CLAIM_IDENTITY:{actions:"receiveIdentityClaim"}}},authenticating:{initial:"checkingInvitations",states:{checkingInvitations:{always:[{guard:"neitherIsMember",...W(yn)},{guard:"weHaveInvitation",target:"awaitingInvitationAcceptance"},{guard:"theyHaveInvitation",target:"validatingInvitation"},{target:"#checkingIdentity"}]},awaitingInvitationAcceptance:{on:{ACCEPT_INVITATION:[{guard:"joinedTheRightTeam",actions:"joinTeam",target:"#checkingIdentity"},W(ln)]},...Me},validatingInvitation:{always:[{guard:"invitationIsValid",actions:"acceptInvitation",target:"#checkingIdentity"},W(hn)]},checkingIdentity:{id:"checkingIdentity",type:"parallel",states:{provingMyIdentity:{initial:"awaitingIdentityChallenge",states:{awaitingIdentityChallenge:{always:{guard:"weHaveInvitation",target:"done"},on:{CHALLENGE_IDENTITY:{actions:"proveIdentity",target:"awaitingIdentityAcceptance"}},...Me},awaitingIdentityAcceptance:{on:{ACCEPT_IDENTITY:{target:"done"}},...Me},done:{type:"final"}}},verifyingTheirIdentity:{initial:"challengingIdentity",states:{challengingIdentity:{always:[{guard:"theyHaveInvitation",target:"done"},{guard:"deviceUnknown",...W(dn)},{actions:"challengeIdentity",target:"awaitingIdentityProof"}]},awaitingIdentityProof:{on:{PROVE_IDENTITY:[{guard:"identityIsValid",actions:"acceptIdentity",target:"done"},W(un)]},...Me},done:{type:"final"}}}},onDone:{target:"done"}},done:{type:"final"}},onDone:{target:"#negotiating"}},negotiating:{id:"negotiating",entry:"sendSeed",on:{SEED:{actions:"deriveSharedKey",target:"synchronizing"}},...Me},synchronizing:{entry:"sendSyncMessage",always:{guard:"headsAreEqual",target:"connected"},on:{SYNC:{actions:["receiveSyncMessage","sendSyncMessage"]}}},connected:{id:"connected",entry:["onConnected","listenForTeamUpdates"],always:[{guard:"memberWasRemoved",...W(fn)},{guard:"deviceWasRemoved",...W(cn)},{guard:"serverWasRemoved",...W(pn)}],on:{LOCAL_UPDATE:{actions:"sendSyncMessage"},SYNC:{actions:["receiveSyncMessage","sendSyncMessage"]},ENCRYPTED_MESSAGE:{actions:"receiveEncryptedMessage"},DISCONNECT:"#disconnected"}},disconnected:{id:"disconnected",always:{actions:"onDisconnected"}}}});this.#e=xe(r),this.#e.subscribe({next:s=>{const i=Js(s.value);this.emit("change",i),this.#n(`⏩ ${i} `)},error:s=>{console.error("Connection encountered an unhandled error",s),this.#i(mn)}}),this.emit=(s,...i)=>(this.#n(`emit ${s} %o`,...i),super.emit(s,...i))}start=(e=[])=>{this.#n("starting"),this.#e.start(),this.#t.start(),this.#s=!0;for(const t of e)this.deliver(t);return this};stop=()=>{if(this.#s&&this.#e.getSnapshot().status!=="done"){const e={type:"DISCONNECT"};this.#e.send(e),this.#t.send(e)}return this.removeAllListeners(),this.#t.stop(),this.#n("connection stopped"),this};deliver(e){const t=$t(e);this.#t.receive(t)}send=e=>{A(this._sessionKey,"Can't send encrypted messages until we've finished connecting");const t=He.encryptBytes(e,this._sessionKey);this.#n(`encrypted message with session key ${Ue.encode(this._sessionKey)}`),this.#r("ENCRYPTED_MESSAGE",t)};get state(){return A(this.#s),this.#e.getSnapshot().value}get team(){return this._context.team}get _sessionKey(){return this._context.sessionKey}get _context(){return A(this.#s),this.#e.getSnapshot().context}#a(e){return new hh({sendMessage:t=>{this.#o("out",t);const n=Kt(t);e(n)}}).on("message",t=>{if(this.#o("in",t),t.type==="REQUEST_RESEND"){const{index:n}=t.payload;this.#t.resend(n)}else this.#e.send(t)}).on("request",t=>{this.#r("REQUEST_RESEND",{index:t})})}#i(e){this.#n("error: %o",e);const t=Lt(e,"LOCAL");return this.#e.send(t),{error:t.payload}}#r(e,t){this.#t.send({type:e,payload:t})}#o(e,t){const n=e==="in"?"<-":"->",r=this.#s?this._context.peer?.userName??"?":"?";this.#n(`${n}${r} #${t.index} ${lh(t)}`)}},W=e=>({actions:[{type:"fail",params:{error:e}},"onDisconnected"],target:"#disconnected"}),gh=7e3,Me={after:{[gh]:W(vn)}};export{j as ADMIN,mu as ADMIN_SCOPE,le as ALL,mh as Connection,iu as DEVICE_ID,eu as ENCRYPTION,Th as EPHEMERAL_SCOPE,Os as HashPurpose,su as INVITATION,nu as LINK_HASH,ru as LINK_TO_PREVIOUS,ou as SHARED_KEY,Qd as SIGNATURE,tu as SYMMETRIC,Ze as TEAM_SCOPE,Mn as Team,B as VALID,ee as asymmetric,we as castServer,Hd as connection,ch as createDevice,Z as createKeyset,Mh as createTeam,_h as createUser,ah as device,ke as generateProof,Sh as graphSummary,Ae as initialState,qu as invitation,kh as loadTeam,Ce as redactDevice,Q as redactKeys,Cc as redactUser,Ud as role,ae as signatures,He as symmetric};
//# sourceMappingURL=index-CqLaZBPf.js.map

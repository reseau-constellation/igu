var tv=Object.defineProperty;var rv=(r,e,t)=>e in r?tv(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Md=(r,e,t)=>(rv(r,typeof e!="symbol"?e+"":e,t),t),Sg=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var ss=(r,e,t)=>(Sg(r,e,"read from private field"),t?t.call(r):e.get(r)),zc=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},wn=(r,e,t,n)=>(Sg(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t),Ud=(r,e,t,n)=>({set _(s){wn(r,e,s,t)},get _(){return ss(r,e,n)}});import{e as v,p as nv,u as sv,a as th,b as iv,c as qe,d as is,f as Ye,v as je,l as P,g as Ur,h as L,r as ov,i as no,j as av,t as B,k as li,m as Jw,w as cv,n as lv,o as hv,q as uv,s as Wu,T as H,x as Oa,y as dv,z as fv,A as pv,B as Tn,C as ut,D as ve,E as gv,F as Zw,G as _p,H as G,I as em,J as Be,P as lt,K as xn,L as fo,M as Qe,N as Xe,O as Je,Q as mi,R as Ha,S as Qs,U as Qi,V as Ue,W as Ks,X as De,Y as js,Z as it,_ as tm,$ as a1,a0 as Rg,a1 as Br,a2 as yv,a3 as wv,a4 as mv,a5 as bv,a6 as Ev,a7 as _v,a8 as vv,a9 as Sv,aa as Xr,ab as Rv,ac as Yu,ad as vp,ae as Av,af as Ln,ag as Hs,ah as rm,ai as Iv,aj as Cv,ak as Ce,al as Tv,am as Vt,an as Sp,ao as Qu,ap as qa,aq as kv,ar as Dv,as as Pv,at as Rp,au as nm,av as Ov,aw as Nv,ax as xv,ay as $v,az as Lv,aA as sm,aB as Ag,aC as Bd,aD as rh,aE as zd}from"./index-bb67a2e0.js";const Ig={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function Cg(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(Ig).join(" / ");throw v(new Error(`Hash '${s}' is unknown or not supported. Must be ${a}`),"ERR_UNSUPPORTED_HASH_TYPE")}const i=Ig[s],o=nv(r,e,t,n,i);return sv.encode64(o,null)}function c1(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}function Ga(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=th(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return iv(t)}let im=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),""),Tg=class{constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}};class Fd{constructor(e={}){this.hwm=e.splitLimit??16,this.head=new Tg(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new Tg(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}function Bt(r={}){return om(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function Mv(r={}){return om(t=>{let n;const s=[];for(;!t.isEmpty()&&(n=t.shift(),n!=null);){if(n.error!=null)throw n.error;n.done===!1&&s.push(n.value)}return n==null?{done:!0}:{done:n.done===!0,value:s}},r)}function om(r,e){e=e??{};let t=e.onEnd,n=new Fd,s,i,o;const a=async()=>n.isEmpty()?o?{done:!0}:await new Promise((p,w)=>{i=y=>{i=null,n.push(y);try{p(r(n))}catch(_){w(_)}return s}}):r(n),c=p=>i!=null?i(p):(n.push(p),s),h=p=>(n=new Fd,i!=null?i({error:p}):(n.push({error:p}),s)),l=p=>{if(o)return s;if(e?.objectMode!==!0&&p?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return c({done:!1,value:p})},u=p=>o?s:(o=!0,p!=null?h(p):c({done:!0})),f=()=>(n=new Fd,u(),{done:!0}),g=p=>(u(p),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:a,return:f,throw:g,push:l,end:u,get readableLength(){return n.size}},t==null)return s;const d=s;return s={[Symbol.asyncIterator](){return this},next(){return d.next()},throw(p){return d.throw(p),t!=null&&(t(p),t=void 0),{done:!0}},return(){return d.return(),t!=null&&(t(),t=void 0),{done:!0}},push:l,end(p){return d.end(p),t!=null&&(t(p),t=void 0),s},get readableLength(){return d.readableLength}},s}let nh=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Uv(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function Zt(r,e,t){const n=t??{},s=Uv(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:u}=n;throw new nh(l,u)}const h=new Promise((l,u)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;u(new nh(f,g))}});c=await Promise.race([h,s.next()]),o=null}catch(h){e.removeEventListener("abort",a);const l=h.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof s.return=="function")try{const u=s.return();u instanceof Promise&&u.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(u){n.onReturnError!=null&&n.onReturnError(u)}if(l&&n.returnOnAbort===!0)return;throw h}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}function Bv(r,e,t){return n=>r(Zt(n,e,t))}function sn(r,e,t){return{sink:Bv(r.sink,e,{...t,onAbort:void 0}),source:Zt(r.source,e,t)}}const am=Symbol.for("@achingbrain/uint8arraylist");function kg(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function hi(r){return Boolean(r?.[am])}class ke{constructor(...e){Object.defineProperty(this,am,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(hi(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(hi(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=kg(this.bufs,e);return t.buf[t.index]}set(e,t){const n=kg(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(hi(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return qe(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:qe(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new ke;return i.length=s,i.bufs=n,i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;const h=e>=a&&e<c,l=t>a&&t<=c;if(h&&l){if(e===a&&t===c){n.push(o);break}const u=e-a;n.push(o.subarray(u,u+(t-e)));break}if(h){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(l){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!hi(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let u=0;u<i;u++)o[u]=-1;for(let u=0;u<s;u++)o[n[u]]=u;const a=o,c=this.byteLength-n.byteLength,h=n.byteLength-1;let l;for(let u=t;u<=c;u+=l){l=0;for(let f=h;f>=0;f--){const g=this.get(u+f);if(n[f]!==g){l=Math.max(1,f-a[g]);break}}if(l===0)return u}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=th(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=is(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=is(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=is(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=th(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=is(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=is(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=is(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=is(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=is(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof ke)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Ye(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new ke;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}function Dg(r){return new Uint8Array(r)}var pe;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(pe||(pe={}));const Ap=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),Pg=Object.freeze({NEW_STREAM:pe.NEW_STREAM,MESSAGE:pe.MESSAGE_INITIATOR,CLOSE:pe.CLOSE_INITIATOR,RESET:pe.RESET_INITIATOR}),zv=Object.freeze({MESSAGE:pe.MESSAGE_RECEIVER,CLOSE:pe.CLOSE_RECEIVER,RESET:pe.RESET_RECEIVER});function We(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}const Og=1024*1024,Fv=(r,e)=>e.append(r);async function*Vv(r,e={}){let t=new ke,n=!1,s=We(),i=Number(e.size??Og);(isNaN(i)||i===0||i<0)&&(i=Og);const o=e.yieldAfter??0,a=e.serialize??Fv;for(Promise.resolve().then(async()=>{try{let c;for await(const h of r){if(a(h,t),t.byteLength>=i){clearTimeout(c),s.resolve();continue}c=setTimeout(()=>{s.resolve()},o)}clearTimeout(c),s.resolve()}catch(c){s.reject(c)}finally{n=!0}});!n;)if(await s.promise,s=We(),t.byteLength>0){const c=t;t=new ke,yield c.subarray()}}const Vd=10*1024;let Kv=class{constructor(){this._pool=Dg(Vd),this._poolOffset=0}write(e,t){const n=this._pool;let s=this._poolOffset;je.encode(e.id<<3|e.type,n,s),s+=je.encode.bytes??0,(e.type===pe.NEW_STREAM||e.type===pe.MESSAGE_INITIATOR||e.type===pe.MESSAGE_RECEIVER)&&e.data!=null?je.encode(e.data.length,n,s):je.encode(0,n,s),s+=je.encode.bytes??0;const i=n.subarray(this._poolOffset,s);Vd-s<100?(this._pool=Dg(Vd),this._poolOffset=0):this._poolOffset=s,t.append(i),(e.type===pe.NEW_STREAM||e.type===pe.MESSAGE_INITIATOR||e.type===pe.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const Ng=new Kv;async function*jv(r,e=0){if(e==null||e===0){for await(const t of r){const n=new ke;for(const s of t)Ng.write(s,n);yield n.subarray()}return}yield*Vv(r,{size:e,serialize:(t,n)=>{for(const s of t)Ng.write(s,n)}})}const cm=1<<20,Hv=4<<20;let qv=class{constructor(e=cm,t=Hv){this._buffer=new ke,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(h){if(h.code==="ERR_MSG_TOO_BIG")throw h;break}const{id:n,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;const c={id:n,type:s};(s===pe.NEW_STREAM||s===pe.MESSAGE_INITIATOR||s===pe.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),t.push(c),this._buffer.consume(o+i),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=$g(e),{value:s,offset:i}=$g(e,n),o=t&7;if(Ap[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+i,length:s}}};const Gv=128,xg=127;function $g(r,e=0){let t=0,n=0,s=e,i;const o=r.length;do{if(s>=o||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(s++),t+=n<28?(i&xg)<<n:(i&xg)*Math.pow(2,n),n+=7}while(i>=Gv);return e=s-e,{value:t,offset:e}}const Cr=P("libp2p:mplex:stream"),Kd="ERR_STREAM_RESET",Wv="ERR_STREAM_ABORT",Yv="ERR_SINK_ENDED",Qv="ERR_DOUBLE_SINK";function Xv(r){const{id:e,name:t,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=cm}=r,a=new AbortController,c=new AbortController,h=new AbortController,l=i==="initiator"?Pg:zv,u=i==="initiator"?`i${e}`:`r${e}`,f=`${t??e}`;let g=!1,d=!1,p=!1,w;const y={open:Date.now()},_=A=>{g||(g=!0,Cr.trace("%s stream %s source end - err: %o",i,f,A),A!=null&&w==null&&(w=A),d&&(S.stat.timeline.close=Date.now(),s?.(w)))},m=A=>{d||(d=!0,Cr.trace("%s stream %s sink end - err: %o",i,f,A),A!=null&&w==null&&(w=A),g&&(y.close=Date.now(),s?.(w)))},b=Bt({onEnd:_}),S={close:()=>{Cr.trace("%s stream %s close",i,f),S.closeRead(),S.closeWrite()},closeRead:()=>{Cr.trace("%s stream %s closeRead",i,f),!g&&b.end()},closeWrite:()=>{if(Cr.trace("%s stream %s closeWrite",i,f),!d){h.abort();try{n({id:e,type:l.CLOSE})}catch(A){Cr.trace("%s stream %s error sending close",i,t,A)}m()}},abort:A=>{Cr.trace("%s stream %s abort",i,f,A),b.end(A),a.abort(),m(A)},reset:()=>{const A=v(new Error("stream reset"),Kd);c.abort(),b.end(A),m(A)},sink:async A=>{if(p)throw v(new Error("sink already called on stream"),Qv);if(p=!0,d)throw v(new Error("stream closed for writing"),Yv);A=Zt(A,Ur([a.signal,c.signal,h.signal]));try{i==="initiator"&&n({id:e,type:Pg.NEW_STREAM,data:new ke(L(f))});for await(let E of A)for(;E.length>0;){if(E.length<=o){n({id:e,type:l.MESSAGE,data:E instanceof Uint8Array?new ke(E):E});break}E=E instanceof Uint8Array?new ke(E):E,n({id:e,type:l.MESSAGE,data:E.sublist(0,o)}),E.consume(o)}}catch(E){if(E.type==="aborted"&&E.message==="The operation was aborted"){if(h.signal.aborted)return;c.signal.aborted&&(E.message="stream reset",E.code=Kd),a.signal.aborted&&(E.message="stream aborted",E.code=Wv)}if(E.code===Kd)Cr.trace("%s stream %s reset",i,t);else{Cr.trace("%s stream %s error",i,t,E);try{n({id:e,type:l.RESET})}catch(I){Cr.trace("%s stream %s error sending reset",i,t,I)}}b.end(E),m(E);return}try{n({id:e,type:l.CLOSE})}catch(E){Cr.trace("%s stream %s error sending close",i,t,E)}m()},source:b,sourcePush:A=>{b.push(A)},sourceReadableLength(){return b.readableLength},stat:{direction:i==="initiator"?"outbound":"inbound",timeline:y},metadata:{},id:u};return S}var Xu=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=typeof e>"u"?1:e}get msDuration(){return this.duration*1e3}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=typeof e>"u"?0:e}get msBlockDuration(){return this.blockDuration*1e3}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=typeof e>"u"?!1:Boolean(e)}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=typeof e>"u"?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(typeof e>"u"&&(e="rlflx"),typeof e!="string")throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}},Jv=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){const e=Date.now();Object.keys(this._keys).forEach(t=>{this._keys[t]<=e&&delete this._keys[t]}),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,t*1e3)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){const t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();const n=Date.now();return t>=n?t-n:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach(t=>{delete this._keys[t]})}};const Zv=Jv;var eS=Zv,Ar=class{constructor(e,t,n,s){this.remainingPoints=typeof e>"u"?0:e,this.msBeforeNext=typeof t>"u"?0:t,this.consumedPoints=typeof n>"u"?0:n,this.isFirstInDuration=typeof s>"u"?!1:s}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=Boolean(e)}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}};const jd=Xu,tS=eS,Lg=Ar;var pc=class extends jd{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed||e.inmemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration||e.inmemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new tS}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,n,s,i,o={}){const a=this._getRateLimiterRes(n,s,i);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&a.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(n,a.msBeforeNext),a.consumedPoints>this.points?t(a):e(a);if(a.consumedPoints>this.points){let c=Promise.resolve();this.blockDuration>0&&a.consumedPoints<=this.points+s&&(a.msBeforeNext=this.msBlockDuration,c=this._block(n,a.consumedPoints,this.msBlockDuration,o)),this.inMemoryBlockOnConsumed>0&&a.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(n,this.inMemoryBlockDuration),a.msBeforeNext=this.msInMemoryBlockDuration),c.then(()=>{t(a)}).catch(h=>{t(h)})}else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,c,a)}else e(a)}_handleError(e,t,n,s,i,o=!1,a={}){this.insuranceLimiter instanceof jd?this.insuranceLimiter[t](i,o,a).then(c=>{n(c)}).catch(c=>{s(c)}):s(e)}get _inmemoryBlockedKeys(){return this._inMemoryBlockedKeys}getInmemoryBlockMsBeforeExpire(e){return this.getInMemoryBlockMsBeforeExpire(e)}get inmemoryBlockOnConsumed(){return this.inMemoryBlockOnConsumed}set inmemoryBlockOnConsumed(e){this.inMemoryBlockOnConsumed=e}get inmemoryBlockDuration(){return this.inMemoryBlockDuration}set inmemoryBlockDuration(e){this.inMemoryBlockDuration=e}get msInmemoryBlockDuration(){return this.inMemoryBlockDuration*1e3}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&this.inMemoryBlockOnConsumed===0)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return this._inMemoryBlockDuration*1e3}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(typeof e<"u"&&!(e instanceof jd))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,n={}){const s=t*1e3;return this._block(this.getKey(e),this.points+1,s,n)}set(e,t,n,s={}){const i=(n>=0?n:this.duration)*1e3;return this._block(this.getKey(e),t,i,s)}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=this.getKey(e),a=this.getInMemoryBlockMsBeforeExpire(o);if(a>0)return i(new Lg(0,a));this._upsert(o,t,this._getKeySecDuration(n)*1e3,!1,n).then(c=>{this._afterConsume(s,i,o,t,c)}).catch(c=>{this._handleError(c,"consume",s,i,e,t,n)})})}penalty(e,t=1,n={}){const s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,t,a))}).catch(a=>{this._handleError(a,"penalty",i,o,e,t,n)})})}reward(e,t=1,n={}){const s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,-t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,-t,a))}).catch(a=>{this._handleError(a,"reward",i,o,e,t,n)})})}get(e,t={}){const n=this.getKey(e);return new Promise((s,i)=>{this._get(n,t).then(o=>{s(o===null||typeof o>"u"?null:this._getRateLimiterRes(n,0,o))}).catch(o=>{this._handleError(o,"get",s,i,e,t)})})}delete(e,t={}){const n=this.getKey(e);return new Promise((s,i)=>{this._delete(n,t).then(o=>{this._inMemoryBlockedKeys.delete(n),s(o)}).catch(o=>{this._handleError(o,"delete",s,i,e,t)})})}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,n){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,n,s={}){return new Promise((i,o)=>{this._upsert(e,t,n,!0,s).then(()=>{i(new Lg(0,n>0?n:-1,t))}).catch(a=>{this._handleError(a,"block",i,o,this.parseKey(e),n/1e3,s)})})}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,n,s=!1,i={}){throw new Error("You have to implement the method '_upsert'!")}};const rS=pc,nS=Ar,Mg="redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ";let sS=class extends rS{constructor(e){super(e),e.redis?this.client=e.redis:this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,typeof this.client.defineCommand=="function"&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:Mg})}_isRedisReady(){return this._rejectIfRedisNotReady?!(this.client.status&&this.client.status!=="ready"||typeof this.client.isReady=="function"&&!this.client.isReady()):!0}_getRateLimiterRes(e,t,n){let[s,i]=n;Array.isArray(s)&&([,s]=s,[,i]=i);const o=new nS;return o.consumedPoints=parseInt(s),o.isFirstInDuration=o.consumedPoints===t,o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.msBeforeNext=i,o}_upsert(e,t,n,s=!1){return new Promise((i,o)=>{if(!this._isRedisReady())return o(new Error("Redis connection is not ready"));const a=Math.floor(n/1e3),c=this.client.multi();if(s)a>0?c.set(e,t,"EX",a):c.set(e,t),c.pttl(e).exec((h,l)=>h?o(h):i(l));else if(a>0){const h=function(l,u){return l?o(l):i(u)};typeof this.client.rlflxIncr=="function"?this.client.rlflxIncr(e,t,a,h):this.client.eval(Mg,1,e,t,a,h)}else c.incrby(e,t).pttl(e).exec((h,l)=>h?o(h):i(l))})}_get(e){return new Promise((t,n)=>{if(!this._isRedisReady())return n(new Error("Redis connection is not ready"));this.client.multi().get(e).pttl(e).exec((s,i)=>{if(s)n(s);else{const[o]=i;if(o===null)return t(null);t(i)}})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{s?n(s):t(i>0)})})}};var iS=sS;const oS=pc,aS=Ar;function Ug(r){try{const e=r.client?r.client:r,{version:t}=e.topology.s.options.metadata.driver,n=t.split(".").map(s=>parseInt(s));return{major:n[0],feature:n[1],patch:n[2]}}catch{return{major:0,feature:0,patch:0}}}let cS=class lm extends oS{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,typeof this.client.then=="function"?this.client.then(t=>{this.client=t,this._initCollection(),this._driverVersion=Ug(this.client)}):(this._initCollection(),this._driverVersion=Ug(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?lm.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){const t=(typeof this.client.db=="function"?this.client.db(this.dbName):this.client).collection(this.tableName);t.createIndex({expire:-1},{expireAfterSeconds:0}),t.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=t}_getRateLimiterRes(e,t,n){const s=new aS;let i;return typeof n.value>"u"?i=n:i=n.value,s.isFirstInDuration=i.points===t,s.consumedPoints=i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire!==null?Math.max(new Date(i.expire).getTime()-Date.now(),0):-1,s}_upsert(e,t,n,s=!1,i={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const o=i.attrs||{};let a,c;s?(a={key:e},a=Object.assign(a,o),c={$set:{key:e,points:t,expire:n>0?new Date(Date.now()+n):null}},c.$set=Object.assign(c.$set,o)):(a={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},a=Object.assign(a,o),c={$setOnInsert:{key:e,expire:n>0?new Date(Date.now()+n):null},$inc:{points:t}},c.$setOnInsert=Object.assign(c.$setOnInsert,o));const h={upsert:!0};return this._driverVersion.major>=4||this._driverVersion.major===3&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?h.returnDocument="after":h.returnOriginal=!1,new Promise((l,u)=>{this._collection.findOneAndUpdate(a,c,h).then(f=>{l(f)}).catch(f=>{if(f&&f.code===11e3){const g=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},o),d={$set:Object.assign({key:e,points:t,expire:n>0?new Date(Date.now()+n):null},o)};this._collection.findOneAndUpdate(g,d,h).then(p=>{l(p)}).catch(p=>{p&&p.code===11e3?this._upsert(e,t,n,s).then(w=>l(w)).catch(w=>u(w)):u(p)})}else u(f)})})}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},s=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},n);return this._collection.findOne(s)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},s=Object.assign({key:e},n);return this._collection.deleteOne(s).then(i=>i.deletedCount>0)}};var lS=cS;const hS=pc,uS=Ar;let dS=class extends hS{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createDbAndTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{this._getConnection().then(n=>{n.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],()=>{this._releaseConnection(n),t()})}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise((e,t)=>{this.client.getConnection((n,s)=>{if(n)return t(n);e(s)})});case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise((e,t)=>{this._getConnection().then(n=>{n.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,s=>{if(s)return this._releaseConnection(n),t(s);n.query(this._getCreateTableStmt(),i=>{if(i)return this._releaseConnection(n),t(i);this._releaseConnection(n),e()})})}).catch(n=>{t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(typeof e>"u")if(this.client.constructor.name==="Connection")e="connection";else if(this.client.constructor.name==="Pool")e="pool";else if(this.client.constructor.name==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:Boolean(e)}_getRateLimiterRes(e,t,n){const s=new uS,[i]=n;return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_upsertTransaction(e,t,n,s,i){return new Promise((o,a)=>{e.query("BEGIN",c=>{if(c)return e.rollback(),a(c);const h=Date.now(),l=s>0?h+s:null;let u,f;i?(u=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = ?, 
            expire = ?;`,f=[this.dbName,this.tableName,t,n,l,n,l]):(u=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = IF(expire <= ?, ?, points + (?)), 
            expire = IF(expire <= ?, ?, expire);`,f=[this.dbName,this.tableName,t,n,l,h,n,n,h,l]),e.query(u,f,g=>{if(g)return e.rollback(),a(g);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],(d,p)=>{if(d)return e.rollback(),a(d);e.query("COMMIT",w=>{if(w)return e.rollback(),a(w);o(p)})})})})})}_upsert(e,t,n,s=!1){return this.tableCreated?new Promise((i,o)=>{this._getConnection().then(a=>{this._upsertTransaction(a,e,t,n,s).then(c=>{i(c),this._releaseConnection(a)}).catch(c=>{o(c),this._releaseConnection(a)})}).catch(a=>{o(a)})}):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],(i,o)=>{i?n(i):o.length===0?t(null):t(o),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],(i,o)=>{i?n(i):t(o.affectedRows>0),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}};var fS=dS;const pS=pc,gS=Ar;let yS=class extends pS{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?typeof t=="function"&&t():this._createTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{const n={name:"rlflx-clear-expired",text:`DELETE FROM ${this.tableName} WHERE expire < $1`,values:[e]};this._query(n).then(()=>{t()}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master);default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);case"typeorm":return!0;default:return!0}}_createTable(){return new Promise((e,t)=>{this._query({text:this._getCreateTableStmt()}).then(()=>{e()}).catch(n=>{n.code==="23505"?e():t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this.tableName} ( 
      key varchar(255) PRIMARY KEY,
      points integer NOT NULL DEFAULT 0,
      expire bigint
    );`}get clientType(){return this._clientType}set clientType(e){const t=this.client.constructor.name;if(typeof e>"u")if(t==="Client")e="client";else if(t==="Pool"||t==="BoundPool")e="pool";else if(t==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:Boolean(e)}_getRateLimiterRes(e,t,n){const s=new gS,i=n.rows[0];return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_query(e){const n={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise((s,i)=>{this._getConnection().then(o=>{o.query(n).then(a=>{s(a),this._releaseConnection(o)}).catch(a=>{i(a),this._releaseConnection(o)})}).catch(o=>{i(o)})})}_upsert(e,t,n,s=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));const i=n>0?Date.now()+n:null,o=s?" $3 ":` CASE
             WHEN ${this.tableName}.expire <= $4 THEN $3
             ELSE ${this.tableName}.expire
            END `;return this._query({name:s?"rlflx-upsert-force":"rlflx-upsert",text:`
            INSERT INTO ${this.tableName} VALUES ($1, $2, $3)
              ON CONFLICT(key) DO UPDATE SET
                points = CASE
                          WHEN (${this.tableName}.expire <= $4 OR 1=${s?1:0}) THEN $2
                          ELSE ${this.tableName}.points + ($2)
                         END,
                expire = ${o}
            RETURNING points, expire;`,values:[e,t,i,Date.now()]})}_get(e){return this.tableCreated?new Promise((t,n)=>{this._query({name:"rlflx-get",text:`
            SELECT points, expire FROM ${this.tableName} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then(s=>{s.rowCount===0&&(s=null),t(s)}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this.tableName} WHERE key = $1`,values:[e]}).then(t=>t.rowCount>0):Promise.reject(Error("Table is not created yet"))}};var wS=yS,mS=class{constructor(e,t,n=null){this.value=e,this.expiresAt=t,this.timeoutId=n}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){!(e instanceof Date)&&Number.isInteger(e)&&(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}};const bS=mS,Hd=Ar;var ES=class{constructor(){this._storage={}}incrby(e,t,n){if(this._storage[e]){const s=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return s!==0?(this._storage[e].value=this._storage[e].value+t,new Hd(0,s,this._storage[e].value,!1)):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new bS(t,s>0?new Date(Date.now()+s):null),s>0&&(this._storage[e].timeoutId=setTimeout(()=>{delete this._storage[e]},s),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new Hd(0,s===0?-1:s,this._storage[e].value,!0)}get(e){if(this._storage[e]){const t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return new Hd(0,t,this._storage[e].value,!1)}return null}delete(e){return this._storage[e]?(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0):!1}};const _S=Xu,vS=ES,Bg=Ar;let SS=class extends _S{constructor(e={}){super(e),this._memoryStorage=new vS}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=this.getKey(e),a=this._getKeySecDuration(n);let c=this._memoryStorage.incrby(o,t,a);if(c.remainingPoints=Math.max(this.points-c.consumedPoints,0),c.consumedPoints>this.points)this.blockDuration>0&&c.consumedPoints<=this.points+t&&(c=this._memoryStorage.set(o,c.consumedPoints,this.blockDuration)),i(c);else if(this.execEvenly&&c.msBeforeNext>0&&!c.isFirstInDuration){let h=Math.ceil(c.msBeforeNext/(c.remainingPoints+2));h<this.execEvenlyMinDelayMs&&(h=c.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(s,h,c)}else s(c)})}penalty(e,t=1,n={}){const s=this.getKey(e);return new Promise(i=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}reward(e,t=1,n={}){const s=this.getKey(e);return new Promise(i=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,-t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}block(e,t){const n=t*1e3,s=this.points+1;return this._memoryStorage.set(this.getKey(e),s,t),Promise.resolve(new Bg(0,n===0?-1:n,s))}set(e,t,n){const s=(n>=0?n:this.duration)*1e3;return this._memoryStorage.set(this.getKey(e),t,n),Promise.resolve(new Bg(0,s===0?-1:s,t))}get(e){const t=this._memoryStorage.get(this.getKey(e));return t!==null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};var hm=SS;const zg=av,RS=ov(),AS=Xu,um=hm,IS=Ar,br="rate_limiter_flexible";let so=null;const Fg=function(r,e,t,n){let s;n===null||n===!0||n===!1?s=n:s={remainingPoints:n.remainingPoints,msBeforeNext:n.msBeforeNext,consumedPoints:n.consumedPoints,isFirstInDuration:n.isFirstInDuration},r.send({channel:br,keyPrefix:e.keyPrefix,promiseId:e.promiseId,type:t,data:s})},dm=function(r){setTimeout(()=>{this._initiated?no.send(r):typeof this._promises[r.promiseId]<"u"&&dm.call(this,r)},30)},Li=function(r,e,t,n,s){const i={channel:br,keyPrefix:this.keyPrefix,func:r,promiseId:e,data:{key:t,arg:n,opts:s}};this._initiated?no.send(i):dm.call(this,i)},fm=function(r,e){if(!e||e.channel!==br||typeof this._rateLimiters[e.keyPrefix]>"u")return!1;let t;switch(e.func){case"consume":t=this._rateLimiters[e.keyPrefix].consume(e.data.key,e.data.arg,e.data.opts);break;case"penalty":t=this._rateLimiters[e.keyPrefix].penalty(e.data.key,e.data.arg,e.data.opts);break;case"reward":t=this._rateLimiters[e.keyPrefix].reward(e.data.key,e.data.arg,e.data.opts);break;case"block":t=this._rateLimiters[e.keyPrefix].block(e.data.key,e.data.arg,e.data.opts);break;case"get":t=this._rateLimiters[e.keyPrefix].get(e.data.key,e.data.opts);break;case"delete":t=this._rateLimiters[e.keyPrefix].delete(e.data.key,e.data.opts);break;default:return!1}t&&t.then(n=>{Fg(r,e,"resolve",n)}).catch(n=>{Fg(r,e,"reject",n)})},CS=function(r){if(!r||r.channel!==br||r.keyPrefix!==this.keyPrefix)return!1;if(this._promises[r.promiseId]){clearTimeout(this._promises[r.promiseId].timeoutId);let e;switch(r.data===null||r.data===!0||r.data===!1?e=r.data:e=new IS(r.data.remainingPoints,r.data.msBeforeNext,r.data.consumedPoints,r.data.isFirstInDuration),r.type){case"resolve":this._promises[r.promiseId].resolve(e);break;case"reject":this._promises[r.promiseId].reject(e);break;default:throw new Error(`RateLimiterCluster: no such message type '${r.type}'`)}delete this._promises[r.promiseId]}},TS=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},Mi=function(r,e){const t=no.hrtime();let n=t[0].toString()+t[1].toString();return typeof this._promises[n]<"u"&&(n+=RS.randomBytes(12).toString("base64")),this._promises[n]={resolve:r,reject:e,timeoutId:setTimeout(()=>{delete this._promises[n],e(new Error("RateLimiterCluster timeout: no answer from master in time"))},this.timeoutMs)},n};let kS=class{constructor(){if(so)return so;this._rateLimiters={},zg.setMaxListeners(0),zg.on("message",(e,t)=>{t&&t.channel===br&&t.type==="init"?(typeof this._rateLimiters[t.opts.keyPrefix]>"u"&&(this._rateLimiters[t.opts.keyPrefix]=new um(t.opts)),e.send({channel:br,type:"init",keyPrefix:t.opts.keyPrefix})):fm.call(this,e,t)}),so=this}},DS=class{constructor(e){if(so)return so;this._rateLimiters={},e.launchBus((t,n)=>{n.on("process:msg",s=>{const i=s.raw;if(i&&i.channel===br&&i.type==="init")typeof this._rateLimiters[i.opts.keyPrefix]>"u"&&(this._rateLimiters[i.opts.keyPrefix]=new um(i.opts)),e.sendDataToProcessId(s.process.pm_id,{data:{},topic:br,channel:br,type:"init",keyPrefix:i.opts.keyPrefix},(o,a)=>{o&&console.log(o,a)});else{const o={send:a=>{const c=a;c.topic=br,typeof c.data>"u"&&(c.data={}),e.sendDataToProcessId(s.process.pm_id,c,(h,l)=>{h&&console.log(h,l)})}};fm.call(this,o,i)}})}),so=this}};class PS extends AS{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=typeof e>"u"?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),no.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,no.on("message",t=>{t&&t.channel===br&&t.type==="init"&&t.keyPrefix===this.keyPrefix?this._initiated=!0:CS.call(this,t)}),no.send({channel:br,type:"init",opts:TS.call(this)}),this._promises={}}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=Mi.call(this,s,i);Li.call(this,"consume",o,e,t,n)})}penalty(e,t=1,n={}){return new Promise((s,i)=>{const o=Mi.call(this,s,i);Li.call(this,"penalty",o,e,t,n)})}reward(e,t=1,n={}){return new Promise((s,i)=>{const o=Mi.call(this,s,i);Li.call(this,"reward",o,e,t,n)})}block(e,t,n={}){return new Promise((s,i)=>{const o=Mi.call(this,s,i);Li.call(this,"block",o,e,t,n)})}get(e,t={}){return new Promise((n,s)=>{const i=Mi.call(this,n,s);Li.call(this,"get",i,e,t)})}delete(e,t={}){return new Promise((n,s)=>{const i=Mi.call(this,n,s);Li.call(this,"delete",i,e,t)})}}var OS={RateLimiterClusterMaster:kS,RateLimiterClusterMasterPM2:DS,RateLimiterCluster:PS};const NS=pc,xS=Ar;let $S=class extends NS{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,n){const s=new xS;return s.consumedPoints=parseInt(n.consumedPoints),s.isFirstInDuration=n.consumedPoints===t,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=n.msBeforeNext,s}_upsert(e,t,n,s=!1,i={}){return new Promise((o,a)=>{const c=Date.now(),h=Math.floor(n/1e3);s?this.client.set(e,t,h,l=>{l?a(l):this.client.set(`${e}_expire`,h>0?c+h*1e3:-1,h,()=>{const u={consumedPoints:t,msBeforeNext:h>0?h*1e3:-1};o(u)})}):this.client.incr(e,t,(l,u)=>{l||u===!1?this.client.add(e,t,h,(f,g)=>{if(f||!g)if(typeof i.attemptNumber>"u"||i.attemptNumber<3){const d=Object.assign({},i);d.attemptNumber=d.attemptNumber?d.attemptNumber+1:1,this._upsert(e,t,n,s,d).then(p=>o(p)).catch(p=>a(p))}else a(new Error("Can not add key"));else this.client.add(`${e}_expire`,h>0?c+h*1e3:-1,h,()=>{const d={consumedPoints:t,msBeforeNext:h>0?h*1e3:-1};o(d)})}):this.client.get(`${e}_expire`,(f,g)=>{if(f)a(f);else{const d=g===!1?0:g,p={consumedPoints:u,msBeforeNext:d>=0?Math.max(d-c,0):-1};o(p)}})})})}_get(e){return new Promise((t,n)=>{const s=Date.now();this.client.get(e,(i,o)=>{o?this.client.get(`${e}_expire`,(a,c)=>{if(a)n(a);else{const h=c===!1?0:c,l={consumedPoints:o,msBeforeNext:h>=0?Math.max(h-s,0):-1};t(l)}}):t(null)})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{s?n(s):i===!1?t(i):this.client.del(`${e}_expire`,o=>{o?n(o):t(i)})})})}};var LS=$S;const Vg=Ar;var MS=class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(typeof e>"u")throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=typeof e>"u"?!1:e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new Vg(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new Vg(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.rejectBlack()),typeof n>"u"?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch(()=>{}),n)}block(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch(()=>{}),n)}penalty(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch(()=>{}),n)}reward(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch(()=>{}),n)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),typeof t>"u"||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}};const US=Xu;var BS=class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach(t=>{if(!(t instanceof US))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")}),this._limiters=e}consume(e,t=1){return new Promise((n,s)=>{const i=[];this._limiters.forEach(o=>{i.push(o.consume(e,t).catch(a=>({rejected:!0,rej:a})))}),Promise.all(i).then(o=>{const a={};let c=!1;o.forEach(h=>{h.rejected===!0&&(c=!0)});for(let h=0;h<o.length;h++)c&&o[h].rejected===!0?a[this._limiters[h].keyPrefix]=o[h].rej:c||(a[this._limiters[h].keyPrefix]=o[h]);c?s(a):n(a)})})}},zS=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}};const Kg=zS,pm=4294967295,l1="limiter";var FS=class{constructor(e,t={maxQueueSize:pm}){this._queueLimiters={KEY_DEFAULT:new jg(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=l1){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=l1){return this._queueLimiters[t]||(this._queueLimiters[t]=new jg(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}};class jg{constructor(e,t={maxQueueSize:pm,key:l1}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then(e=>e!==null?e.remainingPoints:this._limiterFlexible.points)}removeTokens(e){const t=this;return new Promise((n,s)=>{if(e>t._limiterFlexible.points){s(new Kg(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`));return}t._queue.length>0?t._queueRequest.call(t,n,s,e):t._limiterFlexible.consume(t._key,e).then(i=>{n(i.remainingPoints)}).catch(i=>{i instanceof Error?s(i):(t._queueRequest.call(t,n,s,e),t._waitTimeout===null&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),i.msBeforeNext)))})})}_queueRequest(e,t,n){const s=this;s._queue.length<s._maxQueueSize?s._queue.push({resolve:e,reject:t,tokens:n}):t(new Kg(`Number of requests reached it's maximum ${s._maxQueueSize}`))}_processFIFO(){const e=this;if(e._waitTimeout!==null&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),e._queue.length===0)return;const t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then(n=>{t.resolve(n.remainingPoints),e._processFIFO.call(e)}).catch(n=>{n instanceof Error?(t.reject(n),e._processFIFO.call(e)):(e._queue.unshift(t),e._waitTimeout===null&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),n.msBeforeNext)))})}}const qd=Ar;var VS=class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return new qd(e.remainingPoints,Math.min(e.msBeforeNext,t.msBeforeNext),e.consumedPoints,e.isFirstInDuration)}consume(e,t=1,n={}){return this._rateLimiter.consume(e,t,n).catch(s=>s instanceof qd?this._burstLimiter.consume(e,t,n).then(i=>Promise.resolve(this._combineRes(s,i))).catch(i=>i instanceof qd?Promise.reject(this._combineRes(s,i)):Promise.reject(i)):Promise.reject(s))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then(([t,n])=>this._combineRes(t,n))}get points(){return this._rateLimiter.points}};const KS=iS,jS=lS,HS=fS,qS=wS,{RateLimiterClusterMaster:GS,RateLimiterClusterMasterPM2:WS,RateLimiterCluster:YS}=OS,QS=hm,XS=LS,JS=MS,ZS=BS,eR=FS,tR=VS,rR=Ar;var gm={RateLimiterRedis:KS,RateLimiterMongo:jS,RateLimiterMySQL:HS,RateLimiterPostgres:qS,RateLimiterMemory:QS,RateLimiterMemcache:XS,RateLimiterClusterMaster:GS,RateLimiterClusterMasterPM2:WS,RateLimiterCluster:YS,RLWrapperBlackAndWhite:JS,RateLimiterUnion:ZS,RateLimiterQueue:eR,BurstyRateLimiter:tR,RateLimiterRes:rR};const Tr=P("libp2p:mplex"),nR=1024,sR=1024,iR=1024*1024*4,oR=5;function Hg(r){const e={...r,type:`${Ap[r.type]} (${r.type})`};return r.type===pe.NEW_STREAM&&(e.data=B(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===pe.MESSAGE_INITIATOR||r.type===pe.MESSAGE_RECEIVER)&&(e.data=B(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class aR{constructor(e){this.protocol="/mplex/6.7.0",e=e??{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.sink=this._createSink();const t=this._createSource();this._source=t,this.source=t,this.closeController=new AbortController,this.rateLimiter=new gm.RateLimiterMemory({points:e.disconnectThreshold??oR,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}close(e){this.closeController.signal.aborted||(e!=null?this.streams.forEach(t=>t.abort(e)):this.streams.forEach(t=>t.close()),this.closeController.abort())}_newReceiverStream(e){const{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){const{id:t,name:n,type:s,registry:i}=e;if(Tr("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??sR))throw v(new Error("Too many outbound streams open"),"ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(t))throw new Error(`${s} stream ${t} already exists!`);const c=Xv({id:t,name:n,send:h=>{Tr.enabled&&Tr.trace("%s stream %s send",s,t,Hg(h)),this._source.push(h)},type:s,onEnd:()=>{Tr("%s stream with id %s and protocol %s ended",s,t,c.stat.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize});return i.set(t,c),c}_createSink(){return async t=>{const n=[this.closeController.signal];this._init.signal!=null&&n.push(this._init.signal),t=Zt(t,li(n));try{const s=new qv(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const i of t)for(const o of s.write(i))await this._handleIncoming(o);this._source.end()}catch(s){Tr("error in sink",s),this._source.end(s)}}}_createSource(){const t=Mv({objectMode:!0,onEnd:n=>{this.close(n)}});return Object.assign(jv(t,this._init.minSendBytes),{push:t.push,end:t.end,return:t.return})}async _handleIncoming(e){const{id:t,type:n}=e;if(Tr.enabled&&Tr.trace("incoming message",Hg(e)),e.type===pe.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??nR)){Tr("too many inbound streams open"),this._source.push({id:t,type:pe.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{Tr("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this._source.end(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:B(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){Tr("missing stream %s for message type %s",t,Ap[n]);return}const o=this._init.maxStreamBufferSize??iR;switch(n){case pe.MESSAGE_INITIATOR:case pe.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o){this._source.push({id:e.id,type:n===pe.MESSAGE_INITIATOR?pe.RESET_RECEIVER:pe.RESET_INITIATOR});const a=v(new Error("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers"),"ERR_STREAM_INPUT_BUFFER_FULL");i.abort(a);return}i.sourcePush(e.data);break;case pe.CLOSE_INITIATOR:case pe.CLOSE_RECEIVER:i.closeRead();break;case pe.RESET_INITIATOR:case pe.RESET_RECEIVER:i.reset();break;default:Tr("unknown message type %s",n)}}}class cR{constructor(e={}){this.protocol="/mplex/6.7.0",this._init=e}createStreamMuxer(e={}){return new aR({...e,...this._init})}}function ym(r={}){return()=>new cR(r)}var h1={},lR={get exports(){return h1},set exports(r){h1=r}},wm={},mm={},hR=Wa,Ip=Jw();(Wa.prototype=Object.create(Ip.EventEmitter.prototype)).constructor=Wa;function Wa(r,e,t){if(typeof r!="function")throw TypeError("rpcImpl must be a function");Ip.EventEmitter.call(this),this.rpcImpl=r,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(t)}Wa.prototype.rpcCall=function r(e,t,n,s,i){if(!s)throw TypeError("request must be specified");var o=this;if(!i)return Ip.asPromise(r,o,e,t,n,s);if(!o.rpcImpl){setTimeout(function(){i(Error("already ended"))},0);return}try{return o.rpcImpl(e,t[o.requestDelimited?"encodeDelimited":"encode"](s).finish(),function(c,h){if(c)return o.emit("error",c,e),i(c);if(h===null){o.end(!0);return}if(!(h instanceof n))try{h=n[o.responseDelimited?"decodeDelimited":"decode"](h)}catch(l){return o.emit("error",l,e),i(l)}return o.emit("data",h,e),i(null,h)})}catch(a){o.emit("error",a,e),setTimeout(function(){i(a)},0);return}};Wa.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};(function(r){var e=r;e.Service=hR})(mm);var uR={};(function(r){var e=r;e.build="minimal",e.Writer=cv,e.BufferWriter=lv,e.Reader=hv,e.BufferReader=uv,e.util=Jw(),e.rpc=mm,e.roots=uR,e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()})(wm);(function(r){r.exports=wm})(lR);const j=Wu(h1),po=j.Reader,Cp=j.Writer,Y=j.util,pt=j.roots["ipfs-unixfs"]||(j.roots["ipfs-unixfs"]={}),dR=pt.Data=(()=>{function r(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.Type=0,r.prototype.Data=Y.newBuffer([]),r.prototype.filesize=Y.Long?Y.Long.fromBits(0,0,!0):0,r.prototype.blocksizes=Y.emptyArray,r.prototype.hashType=Y.Long?Y.Long.fromBits(0,0,!0):0,r.prototype.fanout=Y.Long?Y.Long.fromBits(0,0,!0):0,r.prototype.mode=0,r.prototype.mtime=null,r.encode=function(t,n){if(n||(n=Cp.create()),n.uint32(8).int32(t.Type),t.Data!=null&&Object.hasOwnProperty.call(t,"Data")&&n.uint32(18).bytes(t.Data),t.filesize!=null&&Object.hasOwnProperty.call(t,"filesize")&&n.uint32(24).uint64(t.filesize),t.blocksizes!=null&&t.blocksizes.length)for(var s=0;s<t.blocksizes.length;++s)n.uint32(32).uint64(t.blocksizes[s]);return t.hashType!=null&&Object.hasOwnProperty.call(t,"hashType")&&n.uint32(40).uint64(t.hashType),t.fanout!=null&&Object.hasOwnProperty.call(t,"fanout")&&n.uint32(48).uint64(t.fanout),t.mode!=null&&Object.hasOwnProperty.call(t,"mode")&&n.uint32(56).uint32(t.mode),t.mtime!=null&&Object.hasOwnProperty.call(t,"mtime")&&pt.UnixTime.encode(t.mtime,n.uint32(66).fork()).ldelim(),n},r.decode=function(t,n){t instanceof po||(t=po.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new pt.Data;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.Type=t.int32();break;case 2:i.Data=t.bytes();break;case 3:i.filesize=t.uint64();break;case 4:if(i.blocksizes&&i.blocksizes.length||(i.blocksizes=[]),(o&7)===2)for(var a=t.uint32()+t.pos;t.pos<a;)i.blocksizes.push(t.uint64());else i.blocksizes.push(t.uint64());break;case 5:i.hashType=t.uint64();break;case 6:i.fanout=t.uint64();break;case 7:i.mode=t.uint32();break;case 8:i.mtime=pt.UnixTime.decode(t,t.uint32());break;default:t.skipType(o&7);break}}if(!i.hasOwnProperty("Type"))throw Y.ProtocolError("missing required 'Type'",{instance:i});return i},r.fromObject=function(t){if(t instanceof pt.Data)return t;var n=new pt.Data;switch(t.Type){case"Raw":case 0:n.Type=0;break;case"Directory":case 1:n.Type=1;break;case"File":case 2:n.Type=2;break;case"Metadata":case 3:n.Type=3;break;case"Symlink":case 4:n.Type=4;break;case"HAMTShard":case 5:n.Type=5;break}if(t.Data!=null&&(typeof t.Data=="string"?Y.base64.decode(t.Data,n.Data=Y.newBuffer(Y.base64.length(t.Data)),0):t.Data.length&&(n.Data=t.Data)),t.filesize!=null&&(Y.Long?(n.filesize=Y.Long.fromValue(t.filesize)).unsigned=!0:typeof t.filesize=="string"?n.filesize=parseInt(t.filesize,10):typeof t.filesize=="number"?n.filesize=t.filesize:typeof t.filesize=="object"&&(n.filesize=new Y.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0))),t.blocksizes){if(!Array.isArray(t.blocksizes))throw TypeError(".Data.blocksizes: array expected");n.blocksizes=[];for(var s=0;s<t.blocksizes.length;++s)Y.Long?(n.blocksizes[s]=Y.Long.fromValue(t.blocksizes[s])).unsigned=!0:typeof t.blocksizes[s]=="string"?n.blocksizes[s]=parseInt(t.blocksizes[s],10):typeof t.blocksizes[s]=="number"?n.blocksizes[s]=t.blocksizes[s]:typeof t.blocksizes[s]=="object"&&(n.blocksizes[s]=new Y.LongBits(t.blocksizes[s].low>>>0,t.blocksizes[s].high>>>0).toNumber(!0))}if(t.hashType!=null&&(Y.Long?(n.hashType=Y.Long.fromValue(t.hashType)).unsigned=!0:typeof t.hashType=="string"?n.hashType=parseInt(t.hashType,10):typeof t.hashType=="number"?n.hashType=t.hashType:typeof t.hashType=="object"&&(n.hashType=new Y.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0))),t.fanout!=null&&(Y.Long?(n.fanout=Y.Long.fromValue(t.fanout)).unsigned=!0:typeof t.fanout=="string"?n.fanout=parseInt(t.fanout,10):typeof t.fanout=="number"?n.fanout=t.fanout:typeof t.fanout=="object"&&(n.fanout=new Y.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0))),t.mode!=null&&(n.mode=t.mode>>>0),t.mtime!=null){if(typeof t.mtime!="object")throw TypeError(".Data.mtime: object expected");n.mtime=pt.UnixTime.fromObject(t.mtime)}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.blocksizes=[]),n.defaults){if(s.Type=n.enums===String?"Raw":0,n.bytes===String?s.Data="":(s.Data=[],n.bytes!==Array&&(s.Data=Y.newBuffer(s.Data))),Y.Long){var i=new Y.Long(0,0,!0);s.filesize=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.filesize=n.longs===String?"0":0;if(Y.Long){var i=new Y.Long(0,0,!0);s.hashType=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.hashType=n.longs===String?"0":0;if(Y.Long){var i=new Y.Long(0,0,!0);s.fanout=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.fanout=n.longs===String?"0":0;s.mode=0,s.mtime=null}if(t.Type!=null&&t.hasOwnProperty("Type")&&(s.Type=n.enums===String?pt.Data.DataType[t.Type]:t.Type),t.Data!=null&&t.hasOwnProperty("Data")&&(s.Data=n.bytes===String?Y.base64.encode(t.Data,0,t.Data.length):n.bytes===Array?Array.prototype.slice.call(t.Data):t.Data),t.filesize!=null&&t.hasOwnProperty("filesize")&&(typeof t.filesize=="number"?s.filesize=n.longs===String?String(t.filesize):t.filesize:s.filesize=n.longs===String?Y.Long.prototype.toString.call(t.filesize):n.longs===Number?new Y.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0):t.filesize),t.blocksizes&&t.blocksizes.length){s.blocksizes=[];for(var o=0;o<t.blocksizes.length;++o)typeof t.blocksizes[o]=="number"?s.blocksizes[o]=n.longs===String?String(t.blocksizes[o]):t.blocksizes[o]:s.blocksizes[o]=n.longs===String?Y.Long.prototype.toString.call(t.blocksizes[o]):n.longs===Number?new Y.LongBits(t.blocksizes[o].low>>>0,t.blocksizes[o].high>>>0).toNumber(!0):t.blocksizes[o]}return t.hashType!=null&&t.hasOwnProperty("hashType")&&(typeof t.hashType=="number"?s.hashType=n.longs===String?String(t.hashType):t.hashType:s.hashType=n.longs===String?Y.Long.prototype.toString.call(t.hashType):n.longs===Number?new Y.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0):t.hashType),t.fanout!=null&&t.hasOwnProperty("fanout")&&(typeof t.fanout=="number"?s.fanout=n.longs===String?String(t.fanout):t.fanout:s.fanout=n.longs===String?Y.Long.prototype.toString.call(t.fanout):n.longs===Number?new Y.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0):t.fanout),t.mode!=null&&t.hasOwnProperty("mode")&&(s.mode=t.mode),t.mtime!=null&&t.hasOwnProperty("mtime")&&(s.mtime=pt.UnixTime.toObject(t.mtime,n)),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),r})();pt.UnixTime=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.Seconds=Y.Long?Y.Long.fromBits(0,0,!1):0,r.prototype.FractionalNanoseconds=0,r.encode=function(t,n){return n||(n=Cp.create()),n.uint32(8).int64(t.Seconds),t.FractionalNanoseconds!=null&&Object.hasOwnProperty.call(t,"FractionalNanoseconds")&&n.uint32(21).fixed32(t.FractionalNanoseconds),n},r.decode=function(t,n){t instanceof po||(t=po.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new pt.UnixTime;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(o&7);break}}if(!i.hasOwnProperty("Seconds"))throw Y.ProtocolError("missing required 'Seconds'",{instance:i});return i},r.fromObject=function(t){if(t instanceof pt.UnixTime)return t;var n=new pt.UnixTime;return t.Seconds!=null&&(Y.Long?(n.Seconds=Y.Long.fromValue(t.Seconds)).unsigned=!1:typeof t.Seconds=="string"?n.Seconds=parseInt(t.Seconds,10):typeof t.Seconds=="number"?n.Seconds=t.Seconds:typeof t.Seconds=="object"&&(n.Seconds=new Y.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber())),t.FractionalNanoseconds!=null&&(n.FractionalNanoseconds=t.FractionalNanoseconds>>>0),n},r.toObject=function(t,n){n||(n={});var s={};if(n.defaults){if(Y.Long){var i=new Y.Long(0,0,!1);s.Seconds=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.Seconds=n.longs===String?"0":0;s.FractionalNanoseconds=0}return t.Seconds!=null&&t.hasOwnProperty("Seconds")&&(typeof t.Seconds=="number"?s.Seconds=n.longs===String?String(t.Seconds):t.Seconds:s.Seconds=n.longs===String?Y.Long.prototype.toString.call(t.Seconds):n.longs===Number?new Y.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber():t.Seconds),t.FractionalNanoseconds!=null&&t.hasOwnProperty("FractionalNanoseconds")&&(s.FractionalNanoseconds=t.FractionalNanoseconds),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();pt.Metadata=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.MimeType="",r.encode=function(t,n){return n||(n=Cp.create()),t.MimeType!=null&&Object.hasOwnProperty.call(t,"MimeType")&&n.uint32(10).string(t.MimeType),n},r.decode=function(t,n){t instanceof po||(t=po.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new pt.Metadata;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof pt.Metadata)return t;var n=new pt.Metadata;return t.MimeType!=null&&(n.MimeType=String(t.MimeType)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(s.MimeType=""),t.MimeType!=null&&t.hasOwnProperty("MimeType")&&(s.MimeType=t.MimeType),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();const mn=dR,qg=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],fR=["directory","hamt-sharded-directory"],Gg=parseInt("0644",8),Wg=parseInt("0755",8);function io(r){if(r!=null)return typeof r=="number"?r&4095:(r=r.toString(),r.substring(0,1)==="0"?parseInt(r,8)&4095:parseInt(r,10)&4095)}function Ya(r){if(r==null)return;let e;if(r.secs!=null&&(e={secs:r.secs,nsecs:r.nsecs}),r.Seconds!=null&&(e={secs:r.Seconds,nsecs:r.FractionalNanoseconds}),Array.isArray(r)&&(e={secs:r[0],nsecs:r[1]}),r instanceof Date){const t=r.getTime(),n=Math.floor(t/1e3);e={secs:n,nsecs:(t-n*1e3)*1e3}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(e!=null&&e.nsecs!=null&&(e.nsecs<0||e.nsecs>999999999))throw v(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}class Pe{static unmarshal(e){const t=mn.decode(e),n=mn.toObject(t,{defaults:!1,arrays:!0,longs:Number,objects:!1}),s=new Pe({type:qg[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return s._originalMode=n.mode||0,s}constructor(e={type:"file"}){const{type:t,data:n,blockSizes:s,hashType:i,fanout:o,mtime:a,mode:c}=e;if(t&&!qg.includes(t))throw v(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE");this.type=t||"file",this.data=n,this.hashType=i,this.fanout=o,this.blockSizes=s||[],this._originalMode=0,this.mode=io(c),a&&(this.mtime=Ya(a),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(e){this._mode=this.isDirectory()?Wg:Gg;const t=io(e);t!==void 0&&(this._mode=t)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&fR.includes(this.type))}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0;let e=0;return this.blockSizes.forEach(t=>{e+=t}),this.data&&(e+=this.data.length),e}marshal(){let e;switch(this.type){case"raw":e=mn.DataType.Raw;break;case"directory":e=mn.DataType.Directory;break;case"file":e=mn.DataType.File;break;case"metadata":e=mn.DataType.Metadata;break;case"symlink":e=mn.DataType.Symlink;break;case"hamt-sharded-directory":e=mn.DataType.HAMTShard;break;default:throw v(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE")}let t=this.data;(!this.data||!this.data.length)&&(t=void 0);let n;this.mode!=null&&(n=this._originalMode&4294963200|(io(this.mode)||0),n===Gg&&!this.isDirectory()&&(n=void 0),n===Wg&&this.isDirectory()&&(n=void 0));let s;if(this.mtime!=null){const o=Ya(this.mtime);o&&(s={Seconds:o.secs,FractionalNanoseconds:o.nsecs},s.FractionalNanoseconds===0&&delete s.FractionalNanoseconds)}const i={Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:n,mtime:s};return mn.encode(i).finish()}}var pR=bm,Yg=128,gR=127,yR=~gR,wR=Math.pow(2,31);function bm(r,e,t){e=e||[],t=t||0;for(var n=t;r>=wR;)e[t++]=r&255|Yg,r/=128;for(;r&yR;)e[t++]=r&255|Yg,r>>>=7;return e[t]=r|0,bm.bytes=t-n+1,e}var mR=u1,bR=128,Qg=127;function u1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw u1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Qg)<<s:(o&Qg)*Math.pow(2,s),s+=7}while(o>=bR);return u1.bytes=i-n,t}var ER=Math.pow(2,7),_R=Math.pow(2,14),vR=Math.pow(2,21),SR=Math.pow(2,28),RR=Math.pow(2,35),AR=Math.pow(2,42),IR=Math.pow(2,49),CR=Math.pow(2,56),TR=Math.pow(2,63),kR=function(r){return r<ER?1:r<_R?2:r<vR?3:r<SR?4:r<RR?5:r<AR?6:r<IR?7:r<CR?8:r<TR?9:10},DR={encode:pR,decode:mR,encodingLength:kR},sh=DR;const d1=(r,e=0)=>[sh.decode(r,e),sh.decode.bytes],ih=(r,e,t=0)=>(sh.encode(r,e,t),e),oh=r=>sh.encodingLength(r),PR=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Tp=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},OR=(r,e)=>{const t=e.byteLength,n=oh(r),s=n+oh(t),i=new Uint8Array(s+t);return ih(r,i,0),ih(t,i,n),i.set(e,s),new kp(r,t,e,i)},NR=r=>{const e=Tp(r),[t,n]=d1(e),[s,i]=d1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new kp(t,s,o,e)},xR=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&PR(r.bytes,t.bytes)}};let kp=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function $R(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var LR=$R,MR=LR;let UR=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},BR=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Em(this,e)}},zR=class{constructor(e){this.decoders=e}or(e){return Em(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Em=(r,e)=>new zR({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let FR=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new UR(e,t,n),this.decoder=new BR(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const _m=({name:r,prefix:e,encode:t,decode:n})=>new FR(r,e,t,n),vm=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=MR(t,e);return _m({prefix:r,name:e,encode:n,decode:i=>Tp(s(i))})},VR=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},KR=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},cr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>_m({prefix:e,name:r,encode(s){return KR(s,n,t)},decode(s){return VR(s,n,t,r)}}),fs=vm({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});vm({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Dl=cr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});cr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});cr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});cr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});cr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});cr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});cr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});cr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});cr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Xg=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return HR(t,f1(r),e||fs.encoder);default:return qR(t,f1(r),e||Dl.encoder)}},Jg=new WeakMap,f1=r=>{const e=Jg.get(r);if(e==null){const t=new Map;return Jg.set(r,t),t}return e};let Sm=class bt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Vo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==GR)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return bt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=OR(e,t);return bt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return bt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&xR(e.multihash,n.multihash)}toString(e){return Xg(this,e)}toJSON(){return{"/":Xg(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof bt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new bt(n,s,i,o||Zg(n,s,i.bytes))}else if(t[WR]===!0){const{version:n,multihash:s,code:i}=t,o=NR(s);return bt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Vo)throw new Error(`Version 0 CID must use dag-pb (code: ${Vo}) block encoding`);return new bt(e,t,n,n.bytes)}case 1:{const s=Zg(e,t,n.bytes);return new bt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return bt.create(0,Vo,e)}static createV1(e,t){return bt.create(1,e,t)}static decode(e){const[t,n]=bt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=bt.inspectBytes(e),n=t.size-t.multihashSize,s=Tp(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new kp(t.multihashCode,t.digestSize,i,s);return[t.version===0?bt.createV0(o):bt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=d1(e.subarray(t));return t+=f,u};let s=n(),i=Vo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=jR(e,t),i=bt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return f1(i).set(n,e),i}};const jR=(r,e)=>{switch(r[0]){case"Q":{const t=e||fs;return[fs.prefix,t.decode(`${fs.prefix}${r}`)]}case fs.prefix:{const t=e||fs;return[fs.prefix,t.decode(r)]}case Dl.prefix:{const t=e||Dl;return[Dl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},HR=(r,e,t)=>{const{prefix:n}=t;if(n!==fs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},qR=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Vo=112,GR=18,Zg=(r,e,t)=>{const n=oh(r),s=n+oh(e),i=new Uint8Array(s+t.byteLength);return ih(r,i,0),ih(e,i,n),i.set(t,s),i},WR=Symbol.for("@ipld/js-cid/CID"),Rm=cr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});cr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});cr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});cr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});class YR extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===H.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===H.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[H.uint.major](e,t){this.prefix(e);const n=String(t.value),s=[];for(let i=0;i<n.length;i++)s[i]=n.charCodeAt(i);e.push(s)}[H.negint.major](e,t){this[H.uint.major](e,t)}[H.bytes.major](e,t){throw new Error(`${Oa} unsupported type: Uint8Array`)}[H.string.major](e,t){this.prefix(e);const n=dv(JSON.stringify(t.value));e.push(n.length>32?fv(n):n)}[H.array.major](e,t){this.prefix(e),this.inRecursive.push({type:H.array,elements:0}),e.push([91])}[H.map.major](e,t){this.prefix(e),this.inRecursive.push({type:H.map,elements:0}),e.push([123])}[H.tag.major](e,t){}[H.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===H.array)e.push([93]);else if(o.type===H.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${Oa} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),s=[];let i=!1;for(let o=0;o<n.length;o++)s[o]=n.charCodeAt(o),!i&&(s[o]===46||s[o]===101||s[o]===69)&&(i=!0);i||(s.push(46),s.push(48)),e.push(s)}}function QR(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${Oa} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==H.string||n.type!==H.string)throw new Error(`${Oa} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${Oa} unexpected duplicate map keys, this is not supported`)}const XR={addBreakTokens:!0,mapSorter:QR};function JR(r,e){return e=Object.assign({},XR,e),pv(r,new YR,e)}class Am{constructor(e,t={}){this.pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}done(){return this.pos>=this.data.length}ch(){return this.data[this.pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this.pos]}expect(e){if(this.data.length-this.pos<e.length)throw new Error(`${ut} unexpected end of input at position ${this.pos}`);for(let t=0;t<e.length;t++)if(this.data[this.pos++]!==e[t])throw new Error(`${ut} unexpected token at position ${this.pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this.pos;let t=!1,n=!1;const s=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this.pos++;else break}};if(this.ch()===45&&(t=!0,this.pos++),this.ch()===48)if(this.pos++,this.ch()===46)this.pos++,n=!0;else return new ve(H.uint,0,this.pos-e);if(s([48,49,50,51,52,53,54,55,56,57]),t&&this.pos===e+1)throw new Error(`${ut} unexpected token at position ${this.pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${ut} unexpected token at position ${this.pos}`);n=!0,this.pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this.pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this.pos++,s([48,49,50,51,52,53,54,55,56,57]));const i=String.fromCharCode.apply(null,this.data.subarray(e,this.pos)),o=parseFloat(i);return n?new ve(H.float,o,this.pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new ve(o>=0?H.uint:H.negint,o,this.pos-e):new ve(o>=0?H.uint:H.negint,BigInt(i),this.pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${ut} unexpected character at position ${this.pos}; this shouldn't happen`);this.pos++;for(let i=this.pos,o=0;i<this.data.length&&o<65536;i++,o++){const a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this.pos,i));return this.pos=i+1,new ve(H.string,c,o)}}const e=this.pos,t=[],n=()=>{if(this.pos+4>=this.data.length)throw new Error(`${ut} unexpected end of unicode escape sequence at position ${this.pos}`);let i=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${ut} unexpected unicode escape character at position ${this.pos}`);i=i*16+a,this.pos++}return i},s=()=>{const i=this.ch();let o=null,a=i>239?4:i>223?3:i>191?2:1;if(this.pos+a>this.data.length)throw new Error(`${ut} unexpected unicode sequence at position ${this.pos}`);let c,h,l,u;switch(a){case 1:i<128&&(o=i);break;case 2:c=this.data[this.pos+1],(c&192)===128&&(u=(i&31)<<6|c&63,u>127&&(o=u));break;case 3:c=this.data[this.pos+1],h=this.data[this.pos+2],(c&192)===128&&(h&192)===128&&(u=(i&15)<<12|(c&63)<<6|h&63,u>2047&&(u<55296||u>57343)&&(o=u));break;case 4:c=this.data[this.pos+1],h=this.data[this.pos+2],l=this.data[this.pos+3],(c&192)===128&&(h&192)===128&&(l&192)===128&&(u=(i&15)<<18|(c&63)<<12|(h&63)<<6|l&63,u>65535&&u<1114112&&(o=u))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this.pos+=a};for(;!this.done();){const i=this.ch();let o;switch(i){case 92:if(this.pos++,this.done())throw new Error(`${ut} unexpected string termination at position ${this.pos}`);switch(o=this.ch(),this.pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${ut} unexpected string escape character at position ${this.pos}`)}break;case 34:return this.pos++,new ve(H.string,gv(t),this.pos-e);default:if(i<32)throw new Error(`${ut} invalid control character at position ${this.pos}`);i<128?(t.push(i),this.pos++):s()}}throw new Error(`${ut} unexpected end of string at position ${this.pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this.pos++,new ve(H.map,1/0,1);case 91:return this.modeStack.push("array-start"),this.pos++,new ve(H.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new ve(H.null,null,4);case 102:return this.expect([102,97,108,115,101]),new ve(H.false,!1,5);case 116:return this.expect([116,114,117,101]),new ve(H.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${ut} unexpected character at position ${this.pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this.pos++,this.skipWhitespace(),new ve(H.break,void 0,1);if(this.ch()!==44)throw new Error(`${ut} unexpected character at position ${this.pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this.pos++,this.skipWhitespace(),new ve(H.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this.pos++,this.skipWhitespace(),new ve(H.break,void 0,1);if(this.ch()!==44)throw new Error(`${ut} unexpected character at position ${this.pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this.pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this.pos++,this.skipWhitespace(),new ve(H.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${ut} unexpected character at position ${this.pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${ut} unexpected parse state at position ${this.pos}; this shouldn't happen`)}}}function ZR(r,e){return e=Object.assign({tokenizer:new Am(r,e)},e),Tn(r,e)}function eA(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=Sm.asCID(r);if(!e)return null;const t=e.toString();return[new ve(H.map,1/0,1),new ve(H.string,"/",1),new ve(H.string,t,t.length),new ve(H.break,void 0,1)]}function e3(r){const e=Rm.encode(r).slice(1);return[new ve(H.map,1/0,1),new ve(H.string,"/",1),new ve(H.map,1/0,1),new ve(H.string,"bytes",5),new ve(H.string,e,e.length),new ve(H.break,void 0,1),new ve(H.break,void 0,1)]}function tA(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function rA(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const nA={typeEncoders:{Object:eA,Uint8Array:e3,Buffer:e3,undefined:tA,number:rA}};class sA extends Am{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===H.map){const t=this._next();if(t.type===H.string&&t.value==="/"){const n=this._next();if(n.type===H.string){if(this._next().type!==H.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new ve(H.tag,42,0)}if(n.type===H.map){const s=this._next();if(s.type===H.string&&s.value==="bytes"){const i=this._next();if(i.type===H.string){for(let a=0;a<2;a++)if(this._next().type!==H.break)throw new Error("Invalid encoded Bytes form");const o=Rm.decode(`m${i.value}`);return new ve(H.bytes,o,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const p1={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};p1.tags[42]=Sm.parse;const iA="dag-json",Im=297,Cm=r=>JR(r,nA),Tm=r=>{const e=Object.assign(p1,{tokenizer:new sA(r,p1)});return ZR(r,e)},t3=r=>oA.decode(Cm(r)),oA=new TextDecoder,aA=r=>Tm(cA.encode(r)),cA=new TextEncoder,km=Object.freeze(Object.defineProperty({__proto__:null,code:Im,decode:Tm,encode:Cm,format:t3,name:iA,parse:aA,stringify:t3},Symbol.toStringTag,{value:"Module"}));function lA(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var hA=lA,uA=hA;const dA=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Dp=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let fA=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},pA=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Dm(this,e)}},gA=class{constructor(e){this.decoders=e}or(e){return Dm(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Dm=(r,e)=>new gA({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let yA=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new fA(e,t,n),this.decoder=new pA(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Pm=({name:r,prefix:e,encode:t,decode:n})=>new yA(r,e,t,n),Om=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=uA(t,e);return Pm({prefix:r,name:e,encode:n,decode:i=>Dp(s(i))})},wA=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},mA=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},lr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Pm({prefix:e,name:r,encode(s){return mA(s,n,t)},decode(s){return wA(s,n,t,r)}});lr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});lr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});const Nm=lr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});lr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function On(r){return Nm.encode(r).slice(1)}function tn(r){return Nm.decode(`u${r}`)}var bA=xm,r3=128,EA=127,_A=~EA,vA=Math.pow(2,31);function xm(r,e,t){e=e||[],t=t||0;for(var n=t;r>=vA;)e[t++]=r&255|r3,r/=128;for(;r&_A;)e[t++]=r&255|r3,r>>>=7;return e[t]=r|0,xm.bytes=t-n+1,e}var SA=g1,RA=128,n3=127;function g1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw g1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&n3)<<s:(o&n3)*Math.pow(2,s),s+=7}while(o>=RA);return g1.bytes=i-n,t}var AA=Math.pow(2,7),IA=Math.pow(2,14),CA=Math.pow(2,21),TA=Math.pow(2,28),kA=Math.pow(2,35),DA=Math.pow(2,42),PA=Math.pow(2,49),OA=Math.pow(2,56),NA=Math.pow(2,63),xA=function(r){return r<AA?1:r<IA?2:r<CA?3:r<TA?4:r<kA?5:r<DA?6:r<PA?7:r<OA?8:r<NA?9:10},$A={encode:bA,decode:SA,encodingLength:xA},ah=$A;const y1=(r,e=0)=>[ah.decode(r,e),ah.decode.bytes],ch=(r,e,t=0)=>(ah.encode(r,e,t),e),lh=r=>ah.encodingLength(r),LA=(r,e)=>{const t=e.byteLength,n=lh(r),s=n+lh(t),i=new Uint8Array(s+t);return ch(r,i,0),ch(t,i,n),i.set(e,s),new Pp(r,t,e,i)},MA=r=>{const e=Dp(r),[t,n]=y1(e),[s,i]=y1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Pp(t,s,o,e)},UA=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&dA(r.bytes,t.bytes)}};let Pp=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const ps=Om({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Om({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Pl=lr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});lr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});lr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});lr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});lr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});lr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});lr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});lr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});lr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const s3=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return zA(t,w1(r),e||ps.encoder);default:return FA(t,w1(r),e||Pl.encoder)}},i3=new WeakMap,w1=r=>{const e=i3.get(r);if(e==null){const t=new Map;return i3.set(r,t),t}return e};let Op=class Et{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ko)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==VA)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Et.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=LA(e,t);return Et.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Et.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&UA(e.multihash,n.multihash)}toString(e){return s3(this,e)}toJSON(){return{"/":s3(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Et)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Et(n,s,i,o||o3(n,s,i.bytes))}else if(t[KA]===!0){const{version:n,multihash:s,code:i}=t,o=MA(s);return Et.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ko)throw new Error(`Version 0 CID must use dag-pb (code: ${Ko}) block encoding`);return new Et(e,t,n,n.bytes)}case 1:{const s=o3(e,t,n.bytes);return new Et(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Et.create(0,Ko,e)}static createV1(e,t){return Et.create(1,e,t)}static decode(e){const[t,n]=Et.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Et.inspectBytes(e),n=t.size-t.multihashSize,s=Dp(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Pp(t.multihashCode,t.digestSize,i,s);return[t.version===0?Et.createV0(o):Et.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=y1(e.subarray(t));return t+=f,u};let s=n(),i=Ko;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=BA(e,t),i=Et.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return w1(i).set(n,e),i}};const BA=(r,e)=>{switch(r[0]){case"Q":{const t=e||ps;return[ps.prefix,t.decode(`${ps.prefix}${r}`)]}case ps.prefix:{const t=e||ps;return[ps.prefix,t.decode(r)]}case Pl.prefix:{const t=e||Pl;return[Pl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},zA=(r,e,t)=>{const{prefix:n}=t;if(n!==ps.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},FA=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Ko=112,VA=18,o3=(r,e,t)=>{const n=lh(r),s=n+lh(e),i=new Uint8Array(s+t.byteLength);return ch(r,i,0),ch(e,i,n),i.set(t,s),i},KA=Symbol.for("@ipld/js-cid/CID");function jA(r){const[e,t,n]=r;return{payload:t,signatures:[{protected:e,signature:n}],link:Op.decode(tn(t))}}function HA(r){const e={signature:tn(r.signature)};return r.header&&(e.header=r.header),r.protected&&(e.protected=tn(r.protected)),e}function qA(r){const e=tn(r.payload);try{Op.decode(e)}catch{throw new Error("Not a valid DagJWS")}return{payload:e,signatures:r.signatures.map(HA)}}function GA(r){const e={signature:On(r.signature)};return r.header&&(e.header=r.header),r.protected&&(e.protected=On(r.protected)),e}function WA(r){const e={payload:On(r.payload),signatures:r.signatures.map(GA)};return e.link=Op.decode(new Uint8Array(r.payload)),e}function YA(r){const[e,t,n,s,i]=r,o={ciphertext:s,iv:n,protected:e,tag:i};return t&&(o.recipients=[{encrypted_key:t}]),o}function QA(r){const e={};return r.encrypted_key&&(e.encrypted_key=tn(r.encrypted_key)),r.header&&(e.header=r.header),e}function XA(r){const e={ciphertext:tn(r.ciphertext),protected:tn(r.protected),iv:tn(r.iv),tag:tn(r.tag)};return r.aad&&(e.aad=tn(r.aad)),r.recipients&&(e.recipients=r.recipients.map(QA)),r.unprotected&&(e.unprotected=r.unprotected),e}function JA(r){const e={};return r.encrypted_key&&(e.encrypted_key=On(r.encrypted_key)),r.header&&(e.header=r.header),e}function ZA(r){const e={ciphertext:On(r.ciphertext),protected:On(r.protected),iv:On(r.iv),tag:On(r.tag)};return r.aad&&(e.aad=On(r.aad)),r.recipients&&(e.recipients=r.recipients.map(JA)),r.unprotected&&(e.unprotected=r.unprotected),e}const eI="dag-jose",tI=133;function $m(r){return"payload"in r&&typeof r.payload=="string"&&"signatures"in r&&Array.isArray(r.signatures)}function rI(r){return"payload"in r&&r.payload instanceof Uint8Array&&"signatures"in r&&Array.isArray(r.signatures)}function nI(r){return"ciphertext"in r&&r.ciphertext instanceof Uint8Array&&"iv"in r&&r.iv instanceof Uint8Array&&"protected"in r&&r.protected instanceof Uint8Array&&"tag"in r&&r.tag instanceof Uint8Array}function Lm(r){return"ciphertext"in r&&typeof r.ciphertext=="string"&&"iv"in r&&typeof r.iv=="string"&&"protected"in r&&typeof r.protected=="string"&&"tag"in r&&typeof r.tag=="string"}function Mm(r){if(typeof r=="string"){const e=r.split(".");if(e.length===3)return jA(e);if(e.length===5)return YA(e);throw new Error("Not a valid JOSE string")}if($m(r)||Lm(r))return r;throw new Error("Not a valid unencoded JOSE object")}function sI(r){typeof r=="string"&&(r=Mm(r));let e;if($m(r))e=qA(r);else if(Lm(r))e=XA(r);else throw new Error("Not a valid JOSE object");return new Uint8Array(Zw(e))}function iI(r){let e;try{e=_p(r)}catch{throw new Error("Not a valid DAG-JOSE object")}if(rI(e))return WA(e);if(nI(e))return ZA(e);throw new Error("Not a valid DAG-JOSE object")}const Um=Object.freeze(Object.defineProperty({__proto__:null,code:tI,decode:iI,encode:sI,name:eI,toGeneral:Mm},Symbol.toStringTag,{value:"Module"})),oI=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Do=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},aI=r=>new TextEncoder().encode(r),cI=r=>new TextDecoder().decode(r);var lI=Bm,a3=128,hI=127,uI=~hI,dI=Math.pow(2,31);function Bm(r,e,t){e=e||[],t=t||0;for(var n=t;r>=dI;)e[t++]=r&255|a3,r/=128;for(;r&uI;)e[t++]=r&255|a3,r>>>=7;return e[t]=r|0,Bm.bytes=t-n+1,e}var fI=m1,pI=128,c3=127;function m1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw m1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&c3)<<s:(o&c3)*Math.pow(2,s),s+=7}while(o>=pI);return m1.bytes=i-n,t}var gI=Math.pow(2,7),yI=Math.pow(2,14),wI=Math.pow(2,21),mI=Math.pow(2,28),bI=Math.pow(2,35),EI=Math.pow(2,42),_I=Math.pow(2,49),vI=Math.pow(2,56),SI=Math.pow(2,63),RI=function(r){return r<gI?1:r<yI?2:r<wI?3:r<mI?4:r<bI?5:r<EI?6:r<_I?7:r<vI?8:r<SI?9:10},AI={encode:lI,decode:fI,encodingLength:RI},hh=AI;const b1=(r,e=0)=>[hh.decode(r,e),hh.decode.bytes],uh=(r,e,t=0)=>(hh.encode(r,e,t),e),dh=r=>hh.encodingLength(r),fh=(r,e)=>{const t=e.byteLength,n=dh(r),s=n+dh(t),i=new Uint8Array(s+t);return uh(r,i,0),uh(t,i,n),i.set(e,s),new Np(r,t,e,i)},zm=r=>{const e=Do(r),[t,n]=b1(e),[s,i]=b1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Np(t,s,o,e)},II=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&oI(r.bytes,t.bytes)}};let Np=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const Fm=0,CI="identity",Vm=Do,TI=r=>fh(Fm,Vm(r)),E1={code:Fm,name:CI,encode:Vm,digest:TI},kI=Object.freeze(Object.defineProperty({__proto__:null,identity:E1},Symbol.toStringTag,{value:"Module"}));function DI(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var PI=DI,OI=PI;let NI=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},xI=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Km(this,e)}},$I=class{constructor(e){this.decoders=e}or(e){return Km(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Km=(r,e)=>new $I({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let LI=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new NI(e,t,n),this.decoder=new xI(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Ju=({name:r,prefix:e,encode:t,decode:n})=>new LI(r,e,t,n),gc=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=OI(t,e);return Ju({prefix:r,name:e,encode:n,decode:i=>Do(s(i))})},MI=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},UI=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},yt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Ju({prefix:e,name:r,encode(s){return UI(s,n,t)},decode(s){return MI(s,n,t,r)}}),BI=Ju({prefix:"\0",name:"identity",encode:r=>cI(r),decode:r=>aI(r)}),zI=Object.freeze(Object.defineProperty({__proto__:null,identity:BI},Symbol.toStringTag,{value:"Module"})),FI=yt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),VI=Object.freeze(Object.defineProperty({__proto__:null,base2:FI},Symbol.toStringTag,{value:"Module"})),KI=yt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),jI=Object.freeze(Object.defineProperty({__proto__:null,base8:KI},Symbol.toStringTag,{value:"Module"})),HI=gc({prefix:"9",name:"base10",alphabet:"0123456789"}),qI=Object.freeze(Object.defineProperty({__proto__:null,base10:HI},Symbol.toStringTag,{value:"Module"})),GI=yt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),WI=yt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),YI=Object.freeze(Object.defineProperty({__proto__:null,base16:GI,base16upper:WI},Symbol.toStringTag,{value:"Module"})),Na=yt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),QI=yt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),XI=yt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),JI=yt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ZI=yt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),eC=yt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),tC=yt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),rC=yt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),nC=yt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),sC=Object.freeze(Object.defineProperty({__proto__:null,base32:Na,base32hex:ZI,base32hexpad:tC,base32hexpadupper:rC,base32hexupper:eC,base32pad:XI,base32padupper:JI,base32upper:QI,base32z:nC},Symbol.toStringTag,{value:"Module"})),ph=gc({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),iC=gc({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),oC=Object.freeze(Object.defineProperty({__proto__:null,base36:ph,base36upper:iC},Symbol.toStringTag,{value:"Module"})),sr=gc({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),aC=gc({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),cC=Object.freeze(Object.defineProperty({__proto__:null,base58btc:sr,base58flickr:aC},Symbol.toStringTag,{value:"Module"})),lC=yt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),hC=yt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),uC=yt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),dC=yt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),fC=Object.freeze(Object.defineProperty({__proto__:null,base64:lC,base64pad:hC,base64url:uC,base64urlpad:dC},Symbol.toStringTag,{value:"Module"})),jm=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),pC=jm.reduce((r,e,t)=>(r[t]=e,r),[]),gC=jm.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function yC(r){return r.reduce((e,t)=>(e+=pC[t],e),"")}function wC(r){const e=[];for(const t of r){const n=gC[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const mC=Ju({prefix:"🚀",name:"base256emoji",encode:yC,decode:wC}),bC=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:mC},Symbol.toStringTag,{value:"Module"})),Hm=({name:r,code:e,encode:t})=>new EC(r,e,t);let EC=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?fh(this.code,t):t.then(n=>fh(this.code,n))}else throw Error("Unknown type, must be binary type")}};const qm=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),go=Hm({name:"sha2-256",code:18,encode:qm("SHA-256")}),_C=Hm({name:"sha2-512",code:19,encode:qm("SHA-512")}),vC=Object.freeze(Object.defineProperty({__proto__:null,sha256:go,sha512:_C},Symbol.toStringTag,{value:"Module"})),SC="raw",xp=85,RC=r=>Do(r),AC=r=>Do(r),IC=Object.freeze(Object.defineProperty({__proto__:null,code:xp,decode:AC,encode:RC,name:SC},Symbol.toStringTag,{value:"Module"})),CC=new TextEncoder,TC=new TextDecoder,kC="json",Gm=512,DC=r=>CC.encode(JSON.stringify(r)),PC=r=>JSON.parse(TC.decode(r)),OC=Object.freeze(Object.defineProperty({__proto__:null,code:Gm,decode:PC,encode:DC,name:kC},Symbol.toStringTag,{value:"Module"})),l3=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return xC(t,_1(r),e||sr.encoder);default:return $C(t,_1(r),e||Na.encoder)}},h3=new WeakMap,_1=r=>{const e=h3.get(r);if(e==null){const t=new Map;return h3.set(r,t),t}return e};let J=class _t{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==jo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==LC)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return _t.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=fh(e,t);return _t.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return _t.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&II(e.multihash,n.multihash)}toString(e){return l3(this,e)}toJSON(){return{"/":l3(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof _t)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new _t(n,s,i,o||u3(n,s,i.bytes))}else if(t[MC]===!0){const{version:n,multihash:s,code:i}=t,o=zm(s);return _t.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==jo)throw new Error(`Version 0 CID must use dag-pb (code: ${jo}) block encoding`);return new _t(e,t,n,n.bytes)}case 1:{const s=u3(e,t,n.bytes);return new _t(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return _t.create(0,jo,e)}static createV1(e,t){return _t.create(1,e,t)}static decode(e){const[t,n]=_t.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=_t.inspectBytes(e),n=t.size-t.multihashSize,s=Do(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Np(t.multihashCode,t.digestSize,i,s);return[t.version===0?_t.createV0(o):_t.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=b1(e.subarray(t));return t+=f,u};let s=n(),i=jo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=NC(e,t),i=_t.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return _1(i).set(n,e),i}};const NC=(r,e)=>{switch(r[0]){case"Q":{const t=e||sr;return[sr.prefix,t.decode(`${sr.prefix}${r}`)]}case sr.prefix:{const t=e||sr;return[sr.prefix,t.decode(r)]}case Na.prefix:{const t=e||Na;return[Na.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},xC=(r,e,t)=>{const{prefix:n}=t;if(n!==sr.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},$C=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},jo=112,LC=18,u3=(r,e,t)=>{const n=dh(r),s=n+dh(e),i=new Uint8Array(s+t.byteLength);return uh(r,i,0),uh(e,i,n),i.set(t,s),i},MC=Symbol.for("@ipld/js-cid/CID"),UC={...zI,...VI,...jI,...qI,...YI,...sC,...oC,...cC,...fC,...bC},BC={...vC,...kI},zC={raw:IC,json:OC};class yc extends Error{constructor(e="not initialized"){super(e),this.name="NotInitializedError",this.code=yc.code}}yc.code="ERR_NOT_INITIALIZED";class FC extends Error{constructor(e="cannot initialize an initializing node"){super(e),this.name="AlreadyInitializingError",this.code=bi.code}}FC.code="ERR_ALREADY_INITIALIZING";class bi extends Error{constructor(e="cannot re-initialize an initialized node"){super(e),this.name="AlreadyInitializedError",this.code=bi.code}}bi.code="ERR_ALREADY_INITIALIZED";class wc extends Error{constructor(e="not started"){super(e),this.name="NotStartedError",this.code=wc.code}}wc.code="ERR_NOT_STARTED";class Zu extends Error{constructor(e="cannot start, already startin"){super(e),this.name="AlreadyStartingError",this.code=Zu.code}}Zu.code="ERR_ALREADY_STARTING";class ed extends Error{constructor(e="cannot start, already started"){super(e),this.name="AlreadyStartedError",this.code=ed.code}}ed.code="ERR_ALREADY_STARTED";class Po extends Error{constructor(e="not enabled"){super(e),this.name="NotEnabledError",this.code=Po.code}}Po.code="ERR_NOT_ENABLED";var VC=function(){return Date.now()};const Fc=VC;class KC{constructor(e,t,n){const s=this;this._started=Fc(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(Fc()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);const t=Fc();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=Fc(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}}function jC(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new KC(arguments[0],arguments[1],r)}var v1=jC;const{AbortController:HC}=globalThis,d3=v1;class $p extends HC{constructor(e){super(),this._ms=e,this._timer=d3(()=>this.abort(),e),Object.setPrototypeOf(this,$p.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=d3(()=>this.abort(),this._ms)}}var ze={TimeoutController:$p};function qC(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var GC=qC,WC=GC;const YC=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Lp=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let QC=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},XC=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Wm(this,e)}},JC=class{constructor(e){this.decoders=e}or(e){return Wm(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Wm=(r,e)=>new JC({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let ZC=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new QC(e,t,n),this.decoder=new XC(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Ym=({name:r,prefix:e,encode:t,decode:n})=>new ZC(r,e,t,n),Qm=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=WC(t,e);return Ym({prefix:r,name:e,encode:n,decode:i=>Lp(s(i))})},eT=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},tT=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},zn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Ym({prefix:e,name:r,encode(s){return tT(s,n,t)},decode(s){return eT(s,n,t,r)}}),gs=Qm({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Qm({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Ol=zn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});zn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});zn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});zn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});zn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});zn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});zn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});zn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});zn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var rT=Xm,f3=128,nT=127,sT=~nT,iT=Math.pow(2,31);function Xm(r,e,t){e=e||[],t=t||0;for(var n=t;r>=iT;)e[t++]=r&255|f3,r/=128;for(;r&sT;)e[t++]=r&255|f3,r>>>=7;return e[t]=r|0,Xm.bytes=t-n+1,e}var oT=S1,aT=128,p3=127;function S1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw S1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&p3)<<s:(o&p3)*Math.pow(2,s),s+=7}while(o>=aT);return S1.bytes=i-n,t}var cT=Math.pow(2,7),lT=Math.pow(2,14),hT=Math.pow(2,21),uT=Math.pow(2,28),dT=Math.pow(2,35),fT=Math.pow(2,42),pT=Math.pow(2,49),gT=Math.pow(2,56),yT=Math.pow(2,63),wT=function(r){return r<cT?1:r<lT?2:r<hT?3:r<uT?4:r<dT?5:r<fT?6:r<pT?7:r<gT?8:r<yT?9:10},mT={encode:rT,decode:oT,encodingLength:wT},gh=mT;const R1=(r,e=0)=>[gh.decode(r,e),gh.decode.bytes],yh=(r,e,t=0)=>(gh.encode(r,e,t),e),wh=r=>gh.encodingLength(r),bT=(r,e)=>{const t=e.byteLength,n=wh(r),s=n+wh(t),i=new Uint8Array(s+t);return yh(r,i,0),yh(t,i,n),i.set(e,s),new Mp(r,t,e,i)},ET=r=>{const e=Lp(r),[t,n]=R1(e),[s,i]=R1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Mp(t,s,o,e)},_T=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&YC(r.bytes,t.bytes)}};let Mp=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const vT=te("dns4"),ST=te("dns6"),RT=te("dnsaddr"),Ti=tr(te("dns"),RT,vT,ST),td=tr(te("ip4"),te("ip6")),mc=tr(de(td,te("tcp")),de(Ti,te("tcp"))),Jm=de(td,te("udp")),AT=de(Jm,te("utp")),IT=de(Jm,te("quic")),mh=tr(de(mc,te("ws")),de(Ti,te("ws"))),Qa=tr(de(mc,te("wss")),de(Ti,te("wss"))),A1=tr(de(mc,te("http")),de(td,te("http")),de(Ti,te("http"))),I1=tr(de(mc,te("https")),de(td,te("https")),de(Ti,te("https"))),Up=tr(de(mh,te("p2p-webrtc-star"),te("p2p")),de(Qa,te("p2p-webrtc-star"),te("p2p")),de(mh,te("p2p-webrtc-star")),de(Qa,te("p2p-webrtc-star"))),Zm=tr(de(A1,te("p2p-webrtc-direct"),te("p2p")),de(I1,te("p2p-webrtc-direct"),te("p2p")),de(A1,te("p2p-webrtc-direct")),de(I1,te("p2p-webrtc-direct"))),C1=tr(mh,Qa,A1,I1,Up,Zm,mc,AT,IT,Ti),ks=tr(de(C1,te("p2p")),Up,Zm,te("p2p")),g3=tr(de(ks,te("p2p-circuit"),ks),de(ks,te("p2p-circuit")),de(te("p2p-circuit"),ks),de(C1,te("p2p-circuit")),de(te("p2p-circuit"),C1),te("p2p-circuit")),e8=()=>tr(de(g3,e8),g3),Gi=e8(),t8=tr(de(Gi,ks,Gi),de(ks,Gi),de(Gi,ks),Gi,ks),CT=t8;function r8(r){function e(t){let n;try{n=G(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function de(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:r8(e),partialMatch:e}}function tr(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:r8(e),partialMatch:e}}function te(r){const e=r;function t(s){let i;try{i=G(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const y3=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return kT(t,T1(r),e||gs.encoder);default:return DT(t,T1(r),e||Ol.encoder)}},w3=new WeakMap,T1=r=>{const e=w3.get(r);if(e==null){const t=new Map;return w3.set(r,t),t}return e};let Gd=class vt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ho)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==PT)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return vt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=bT(e,t);return vt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return vt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&_T(e.multihash,n.multihash)}toString(e){return y3(this,e)}toJSON(){return{"/":y3(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof vt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new vt(n,s,i,o||m3(n,s,i.bytes))}else if(t[OT]===!0){const{version:n,multihash:s,code:i}=t,o=ET(s);return vt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ho)throw new Error(`Version 0 CID must use dag-pb (code: ${Ho}) block encoding`);return new vt(e,t,n,n.bytes)}case 1:{const s=m3(e,t,n.bytes);return new vt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return vt.create(0,Ho,e)}static createV1(e,t){return vt.create(1,e,t)}static decode(e){const[t,n]=vt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=vt.inspectBytes(e),n=t.size-t.multihashSize,s=Lp(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Mp(t.multihashCode,t.digestSize,i,s);return[t.version===0?vt.createV0(o):vt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=R1(e.subarray(t));return t+=f,u};let s=n(),i=Ho;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=TT(e,t),i=vt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return T1(i).set(n,e),i}};const TT=(r,e)=>{switch(r[0]){case"Q":{const t=e||gs;return[gs.prefix,t.decode(`${gs.prefix}${r}`)]}case gs.prefix:{const t=e||gs;return[gs.prefix,t.decode(r)]}case Ol.prefix:{const t=e||Ol;return[Ol.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},kT=(r,e,t)=>{const{prefix:n}=t;if(n!==gs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},DT=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Ho=112,PT=18,m3=(r,e,t)=>{const n=wh(r),s=n+wh(e),i=new Uint8Array(s+t.byteLength);return yh(r,i,0),yh(e,i,n),i.set(t,s),i},OT=Symbol.for("@ipld/js-cid/CID"),bh=/^\/(ip[fn]s)\/([^/?#]+)/,n8=1,s8=2,i8=/^https?:\/\/([^/]+)\.(ip[fn]s)\.[^/?]+/,NT=/^(([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])\.)+([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])$/;function Bp(r){try{return c8(r)?Boolean(Gd.parse(r)):r instanceof Uint8Array?Boolean(Gd.decode(r)):Boolean(Gd.asCID(r))}catch{return!1}}function o8(r,e,t=n8,n=s8){const s=l8(r);if(s===!1)return!1;const i=s.match(e);if(i==null||i[t]!=="ipfs")return!1;let o=i[n];return o!=null&&e===i8&&(o=o.toLowerCase()),Bp(o)}function a8(r,e,t=n8,n=s8){const s=l8(r);if(s===!1)return!1;const i=s.match(e);if(i==null||i[t]!=="ipns")return!1;let o=i[n];if(o!=null&&e===i8){if(o=o.toLowerCase(),Bp(o))return!0;try{!o.includes(".")&&o.includes("-")&&(o=o.replace(/--/g,"@").replace(/-/g,".").replace(/@/g,"-"));const{hostname:a}=new em.URL(`http://${o}`);return NT.test(a)}catch{return!1}}return!0}function c8(r){return typeof r=="string"}function l8(r){return r instanceof Uint8Array?B(r,"base58btc"):c8(r)?r:!1}const h8=r=>o8(r,bh)||a8(r,bh),xT=r=>o8(r,bh),u8=r=>a8(r,bh),In="/",d8=new TextEncoder().encode(In),Vc=d8[0];class X{constructor(e,t){if(typeof e=="string")this._buf=L(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Vc)throw new Error("Invalid key")}toString(e="utf8"){return B(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new X(e.join(In))}static random(){return new X(im().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new X(e):typeof e.uint8Array=="function"?new X(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=d8),this._buf[0]!==Vc){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Vc,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Vc;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return X.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(In).slice(1)}type(){return $T(this.baseNamespace())}name(){return LT(this.baseNamespace())}instance(e){return new X(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(In)||(e+=In),e+=this.type(),new X(e)}parent(){const e=this.list();return e.length===1?new X(In):new X(e.slice(0,-1).join(In))}child(e){return this.toString()===In?e:e.toString()===In?this:new X(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return X.withNamespaces([...this.namespaces(),...MT(e.map(t=>t.namespaces()))])}}function $T(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function LT(r){const e=r.split(":");return e[e.length-1]}function MT(r){return[].concat(...r)}let UT=/(-?(?:\d+\.?\d*|\d*\.?\d+)(?:e[-+]?\d+)?)\s*([\p{L}]*)/uig;re.nanosecond=re.ns=1/1e6;re.µs=re.μs=re.us=re.microsecond=1/1e3;re.millisecond=re.ms=re[""]=1;re.second=re.sec=re.s=re.ms*1e3;re.minute=re.min=re.m=re.s*60;re.hour=re.hr=re.h=re.m*60;re.day=re.d=re.h*24;re.week=re.wk=re.w=re.d*7;re.month=re.b=re.d*(365.25/12);re.year=re.yr=re.y=re.d*365.25;function re(r="",e="ms"){var t=null;return r=(r+"").replace(/(\d)[,_](\d)/g,"$1$2"),r.replace(UT,function(n,s,i){i=b3(i),i&&(t=(t||0)+parseFloat(s,10)*i)}),t&&t/(b3(e)||1)}function b3(r){return re[r]||re[r.toLowerCase().replace(/s$/,"")]}let Nl=class f8 extends Error{constructor(e="request timed out"){super(e),this.name="TimeoutError",this.code=f8.code}};Nl.code="ERR_TIMEOUT";function x(r,e){return(...t)=>{const n=t[e??t.length-1];if(!n||!n.timeout)return r(...t);const s=typeof n.timeout=="string"?re(n.timeout):n.timeout,i=new ze.TimeoutController(s);n.signal=Ur([n.signal,i.signal]);const o=r(...t),a=new Promise((l,u)=>{i.signal.addEventListener("abort",()=>{u(new Nl)})}),c=Date.now(),h=()=>{if(i.signal.aborted)throw new Nl;if(Date.now()-c>s)throw i.abort(),new Nl};return o[Symbol.asyncIterator]?async function*(){const l=o[Symbol.asyncIterator]();try{for(;;){const{value:u,done:f}=await Promise.race([l.next(),a]);if(f)break;h(),yield u}}catch(u){throw h(),u}finally{i.clear(),l.return&&l.return()}}():(async()=>{try{const l=await Promise.race([o,a]);return h(),l}catch(l){throw h(),l}finally{i.clear()}})()}}var BT=p8,E3=128,zT=127,FT=~zT,VT=Math.pow(2,31);function p8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=VT;)e[t++]=r&255|E3,r/=128;for(;r&FT;)e[t++]=r&255|E3,r>>>=7;return e[t]=r|0,p8.bytes=t-n+1,e}var KT=k1,jT=128,_3=127;function k1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw k1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&_3)<<s:(o&_3)*Math.pow(2,s),s+=7}while(o>=jT);return k1.bytes=i-n,t}var HT=Math.pow(2,7),qT=Math.pow(2,14),GT=Math.pow(2,21),WT=Math.pow(2,28),YT=Math.pow(2,35),QT=Math.pow(2,42),XT=Math.pow(2,49),JT=Math.pow(2,56),ZT=Math.pow(2,63),ek=function(r){return r<HT?1:r<qT?2:r<GT?3:r<WT?4:r<YT?5:r<QT?6:r<XT?7:r<JT?8:r<ZT?9:10},tk={encode:BT,decode:KT,encodingLength:ek},Eh=tk;const D1=(r,e=0)=>[Eh.decode(r,e),Eh.decode.bytes],_h=(r,e,t=0)=>(Eh.encode(r,e,t),e),vh=r=>Eh.encodingLength(r),rk=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},zp=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},nk=(r,e)=>{const t=e.byteLength,n=vh(r),s=n+vh(t),i=new Uint8Array(s+t);return _h(r,i,0),_h(t,i,n),i.set(e,s),new Fp(r,t,e,i)},sk=r=>{const e=zp(r),[t,n]=D1(e),[s,i]=D1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Fp(t,s,o,e)},ik=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&rk(r.bytes,t.bytes)}};let Fp=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function ok(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var ak=ok,ck=ak;let lk=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},hk=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return g8(this,e)}},uk=class{constructor(e){this.decoders=e}or(e){return g8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const g8=(r,e)=>new uk({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let dk=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new lk(e,t,n),this.decoder=new hk(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const y8=({name:r,prefix:e,encode:t,decode:n})=>new dk(r,e,t,n),w8=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=ck(t,e);return y8({prefix:r,name:e,encode:n,decode:i=>zp(s(i))})},fk=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},pk=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Fn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>y8({prefix:e,name:r,encode(s){return pk(s,n,t)},decode(s){return fk(s,n,t,r)}}),ys=w8({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});w8({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const xl=Fn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Fn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Fn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Fn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Fn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Fn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Fn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Fn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Fn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const v3=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return yk(t,P1(r),e||ys.encoder);default:return wk(t,P1(r),e||xl.encoder)}},S3=new WeakMap,P1=r=>{const e=S3.get(r);if(e==null){const t=new Map;return S3.set(r,t),t}return e};let xa=class St{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==qo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==mk)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return St.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=nk(e,t);return St.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return St.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&ik(e.multihash,n.multihash)}toString(e){return v3(this,e)}toJSON(){return{"/":v3(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof St)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new St(n,s,i,o||R3(n,s,i.bytes))}else if(t[bk]===!0){const{version:n,multihash:s,code:i}=t,o=sk(s);return St.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==qo)throw new Error(`Version 0 CID must use dag-pb (code: ${qo}) block encoding`);return new St(e,t,n,n.bytes)}case 1:{const s=R3(e,t,n.bytes);return new St(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return St.create(0,qo,e)}static createV1(e,t){return St.create(1,e,t)}static decode(e){const[t,n]=St.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=St.inspectBytes(e),n=t.size-t.multihashSize,s=zp(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Fp(t.multihashCode,t.digestSize,i,s);return[t.version===0?St.createV0(o):St.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=D1(e.subarray(t));return t+=f,u};let s=n(),i=qo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=gk(e,t),i=St.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return P1(i).set(n,e),i}};const gk=(r,e)=>{switch(r[0]){case"Q":{const t=e||ys;return[ys.prefix,t.decode(`${ys.prefix}${r}`)]}case ys.prefix:{const t=e||ys;return[ys.prefix,t.decode(r)]}case xl.prefix:{const t=e||xl;return[xl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},yk=(r,e,t)=>{const{prefix:n}=t;if(n!==ys.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},wk=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},qo=112,mk=18,R3=(r,e,t)=>{const n=vh(r),s=n+vh(e),i=new Uint8Array(s+t.byteLength);return _h(r,i,0),_h(e,i,n),i.set(t,s),i},bk=Symbol.for("@ipld/js-cid/CID"),A3="/ipfs/";function bc(r){if(r instanceof Uint8Array)try{r=xa.decode(r)}catch(s){throw v(s,"ERR_INVALID_CID")}let e=xa.asCID(r);if(e)return{cid:e,path:void 0};r=r.toString(),r.startsWith(A3)&&(r=r.substring(A3.length));const t=r.split("/");let n;try{e=xa.parse(t.shift()||"")}catch(s){throw v(s,"ERR_INVALID_CID")}return t.length&&(n=`/${t.join("/")}`),{cid:e,path:n}}const Ek="ERR_BAD_PATH",m8="This command must be run in online mode. Try running 'ipfs daemon' first.",O1=new X("/local/filesroot"),_k=262144,vk=r=>{if(J.asCID(r))return`/ipfs/${r}`;const t=r.toString();try{return`/ipfs/${J.parse(t)}`}catch{}if(h8(t))return t;throw v(new Error(`invalid path: ${r}`),Ek)},Vp=r=>r instanceof Uint8Array?J.decode(r).toString():(r=r.toString(),r.indexOf("/ipfs/")===0&&(r=r.substring(6)),r.charAt(r.length-1)==="/"&&(r=r.substring(0,r.length-1)),r),rd=async function(r,e,t,n={}){const{cid:s,path:i}=bc(t);i&&(n.path=i);let o=s,a=n.path||"";if(a.startsWith("/")&&(a=a.substring(1)),n.path)try{for await(const{value:c,remainderPath:h}of Xa(s,n.path,e,r,{signal:n.signal})){if(!J.asCID(c))break;a=h,o=c}}catch(c){throw c.message.startsWith("Object has no property")&&(c.message=`no link named "${a.split("/")[0]}" under ${o}`,c.code="ERR_NO_LINK"),c}return{cid:o,remainderPath:a||""}},I3=r=>{if(r.type!=="file"&&r.type!=="directory"&&r.type!=="raw")throw new Error(`Unknown node type '${r.type}'`);const e={cid:r.cid,path:r.path,name:r.name,size:r.size,type:"file"};return r.type==="directory"&&(e.type="dir"),r.type==="file"&&(e.size=r.unixfs.fileSize()),(r.type==="file"||r.type==="directory")&&(e.mode=r.unixfs.mode,r.unixfs.mtime!==void 0&&(e.mtime=r.unixfs.mtime)),e},Sk=x(async(r,e)=>await r),Xa=async function*(r,e,t,n,s){const i=async h=>{const l=await t.getCodec(h.code),u=await n.blocks.get(h,s);return l.decode(u)},o=e.split("/").filter(Boolean);let a=await i(r),c=r;for(;o.length;){const h=o.shift();if(!h)throw v(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(r.code===Be&&Array.isArray(a.Links)){const l=a.Links.find(u=>u.Name===h);if(l){yield{value:l.Hash,remainderPath:o.join("/")},a=await i(l.Hash),c=l.Hash;continue}}if(Object.prototype.hasOwnProperty.call(a,h))a=a[h],yield{value:a,remainderPath:o.join("/")};else throw v(new Error(`no link named "${h}" under ${c}`),"ERR_NO_LINK");J.asCID(a)&&(c=a,a=await i(a))}yield{value:a,remainderPath:""}};class Pr{static create({start:e,stop:t}){return new Pr(e,t)}static async start(e,t){const{state:n,activate:s}=e;switch(n.status){case"stopped":try{const i=s(t);e.state={status:"starting",ready:i};const o=await i;return e.state={status:"started",value:o},o}catch(i){throw e.state={status:"stopped"},i}case"starting":throw new Zu;case"started":throw new ed;case"stopping":return await n.ready,await Pr.start(e,t);default:return Pr.panic(e)}}static async stop(e){const{state:t,deactivate:n}=e;switch(t.status){case"stopped":break;case"starting":{try{await t.ready}catch{}return await Pr.stop(e)}case"stopping":return await t.ready;case"started":{n&&await n(t.value),e.state={status:"stopped"};break}default:Pr.panic(t)}}static try({state:e}){switch(e.status){case"started":return e.value;default:return null}}static async use({state:e},t){switch(e.status){case"started":return e.value;case"starting":return await Sk(e.ready,t);default:throw new wc}}static panic({state:e}){const t=JSON.stringify({status:e.status});throw RangeError(`Service in invalid state ${t}, should never happen if you see this please report a bug`)}constructor(e,t){this.activate=e,this.deactivate=t,this.state={status:"stopped"}}async use(e){return await Pr.use(this,e)}try(){return Pr.try(this)}}function Rk({network:r,preload:e,peerId:t,keychain:n,repo:s,ipns:i,mfsPreload:o,print:a,hashers:c,options:h}){return async()=>{const{libp2p:u}=await Pr.start(r,{peerId:t,repo:s,print:a,hashers:c,options:h});await Promise.all([i.startOnline({keychain:n,libp2p:u,peerId:t,repo:s}),e.start(),o.start()])}}function Ak({network:r,preload:e,ipns:t,repo:n,mfsPreload:s}){return async()=>{await Promise.all([e.stop(),t.stop(),s.stop()]),await Pr.stop(r),await n.close()}}var nd=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}};let Ik=class{constructor(e){this.lru=nd(e)}get(e){const t=this.lru.get(e);if(t){if(t.expire&&t.expire<Date.now()){this.lru.remove(e);return}return t.value}}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}};const Wd=new Ik(1e3),Ck=60*1e3,Tk=lt.default?lt.default:lt,kk=new Tk({concurrency:4}),C3=r=>{if(r.Path)return r.Path;throw new Error(r.Message)};async function Dk(r,e){return(async(n,s={})=>{const i=new URLSearchParams(s);i.set("arg",n);const o=i.toString();if(!s.nocache&&Wd.has(o)){const c=Wd.get(o);return C3(c)}const a=await kk.add(async()=>{const c=await xn.get("https://ipfs.io/api/v0/dns",{searchParams:i}),h=new URL(c.url).search.slice(1),l=await c.json();return Wd.set(h,l,Ck),l});return C3(a)})(r,e)}function Pk(r){return r.endsWith(".eth")&&(r=r.replace(/.eth$/,".eth.link")),r}function Ok(){return x(async(e,t={recursive:!0})=>{if(typeof e!="string")throw new Error("Invalid arguments, domain must be a string");return e=Pk(e),Dk(e,t)})}function Nk({network:r}){return()=>{const e=r.try();return e!=null&&Boolean(e.libp2p.isStarted())}}var xk=b8,T3=128,$k=127,Lk=~$k,Mk=Math.pow(2,31);function b8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Mk;)e[t++]=r&255|T3,r/=128;for(;r&Lk;)e[t++]=r&255|T3,r>>>=7;return e[t]=r|0,b8.bytes=t-n+1,e}var Uk=N1,Bk=128,k3=127;function N1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw N1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&k3)<<s:(o&k3)*Math.pow(2,s),s+=7}while(o>=Bk);return N1.bytes=i-n,t}var zk=Math.pow(2,7),Fk=Math.pow(2,14),Vk=Math.pow(2,21),Kk=Math.pow(2,28),jk=Math.pow(2,35),Hk=Math.pow(2,42),qk=Math.pow(2,49),Gk=Math.pow(2,56),Wk=Math.pow(2,63),Yk=function(r){return r<zk?1:r<Fk?2:r<Vk?3:r<Kk?4:r<jk?5:r<Hk?6:r<qk?7:r<Gk?8:r<Wk?9:10},Qk={encode:xk,decode:Uk,encodingLength:Yk},Sh=Qk;const x1=(r,e=0)=>[Sh.decode(r,e),Sh.decode.bytes],Rh=(r,e,t=0)=>(Sh.encode(r,e,t),e),Ah=r=>Sh.encodingLength(r),Xk=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},sd=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Jk=r=>new TextEncoder().encode(r),Zk=r=>new TextDecoder().decode(r),yo=(r,e)=>{const t=e.byteLength,n=Ah(r),s=n+Ah(t),i=new Uint8Array(s+t);return Rh(r,i,0),Rh(t,i,n),i.set(e,s),new jp(r,t,e,i)},Kp=r=>{const e=sd(r),[t,n]=x1(e),[s,i]=x1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new jp(t,s,o,e)},eD=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Xk(r.bytes,t.bytes)}};let jp=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function tD(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var rD=tD,nD=rD;let sD=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},iD=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return E8(this,e)}},oD=class{constructor(e){this.decoders=e}or(e){return E8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const E8=(r,e)=>new oD({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let aD=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new sD(e,t,n),this.decoder=new iD(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const id=({name:r,prefix:e,encode:t,decode:n})=>new aD(r,e,t,n),Ec=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=nD(t,e);return id({prefix:r,name:e,encode:n,decode:i=>sd(s(i))})},cD=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},lD=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},wt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>id({prefix:e,name:r,encode(s){return lD(s,n,t)},decode(s){return cD(s,n,t,r)}}),xr=Ec({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),hD=Ec({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),uD=Object.freeze(Object.defineProperty({__proto__:null,base58btc:xr,base58flickr:hD},Symbol.toStringTag,{value:"Module"})),$a=wt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),dD=wt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),fD=wt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),pD=wt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),gD=wt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),yD=wt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),wD=wt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),mD=wt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),bD=wt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),ED=Object.freeze(Object.defineProperty({__proto__:null,base32:$a,base32hex:gD,base32hexpad:wD,base32hexpadupper:mD,base32hexupper:yD,base32pad:fD,base32padupper:pD,base32upper:dD,base32z:bD},Symbol.toStringTag,{value:"Module"})),D3=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return vD(t,$1(r),e||xr.encoder);default:return SD(t,$1(r),e||$a.encoder)}},P3=new WeakMap,$1=r=>{const e=P3.get(r);if(e==null){const t=new Map;return P3.set(r,t),t}return e};let _8=class Rt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Go)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==RD)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Rt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=yo(e,t);return Rt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Rt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&eD(e.multihash,n.multihash)}toString(e){return D3(this,e)}toJSON(){return{"/":D3(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Rt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Rt(n,s,i,o||O3(n,s,i.bytes))}else if(t[AD]===!0){const{version:n,multihash:s,code:i}=t,o=Kp(s);return Rt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Go)throw new Error(`Version 0 CID must use dag-pb (code: ${Go}) block encoding`);return new Rt(e,t,n,n.bytes)}case 1:{const s=O3(e,t,n.bytes);return new Rt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Rt.create(0,Go,e)}static createV1(e,t){return Rt.create(1,e,t)}static decode(e){const[t,n]=Rt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Rt.inspectBytes(e),n=t.size-t.multihashSize,s=sd(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new jp(t.multihashCode,t.digestSize,i,s);return[t.version===0?Rt.createV0(o):Rt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=x1(e.subarray(t));return t+=f,u};let s=n(),i=Go;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=_D(e,t),i=Rt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return $1(i).set(n,e),i}};const _D=(r,e)=>{switch(r[0]){case"Q":{const t=e||xr;return[xr.prefix,t.decode(`${xr.prefix}${r}`)]}case xr.prefix:{const t=e||xr;return[xr.prefix,t.decode(r)]}case $a.prefix:{const t=e||$a;return[$a.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},vD=(r,e,t)=>{const{prefix:n}=t;if(n!==xr.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},SD=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Go=112,RD=18,O3=(r,e,t)=>{const n=Ah(r),s=n+Ah(e),i=new Uint8Array(s+t.byteLength);return Rh(r,i,0),Rh(e,i,n),i.set(t,s),i},AD=Symbol.for("@ipld/js-cid/CID"),ID=id({prefix:"\0",name:"identity",encode:r=>Zk(r),decode:r=>Jk(r)}),CD=Object.freeze(Object.defineProperty({__proto__:null,identity:ID},Symbol.toStringTag,{value:"Module"})),TD=wt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),kD=Object.freeze(Object.defineProperty({__proto__:null,base2:TD},Symbol.toStringTag,{value:"Module"})),DD=wt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),PD=Object.freeze(Object.defineProperty({__proto__:null,base8:DD},Symbol.toStringTag,{value:"Module"})),OD=Ec({prefix:"9",name:"base10",alphabet:"0123456789"}),ND=Object.freeze(Object.defineProperty({__proto__:null,base10:OD},Symbol.toStringTag,{value:"Module"})),xD=wt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),$D=wt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),LD=Object.freeze(Object.defineProperty({__proto__:null,base16:xD,base16upper:$D},Symbol.toStringTag,{value:"Module"})),MD=Ec({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),UD=Ec({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),BD=Object.freeze(Object.defineProperty({__proto__:null,base36:MD,base36upper:UD},Symbol.toStringTag,{value:"Module"})),zD=wt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),FD=wt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),VD=wt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),KD=wt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),jD=Object.freeze(Object.defineProperty({__proto__:null,base64:zD,base64pad:FD,base64url:VD,base64urlpad:KD},Symbol.toStringTag,{value:"Module"})),v8=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),HD=v8.reduce((r,e,t)=>(r[t]=e,r),[]),qD=v8.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function GD(r){return r.reduce((e,t)=>(e+=HD[t],e),"")}function WD(r){const e=[];for(const t of r){const n=qD[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const YD=id({prefix:"🚀",name:"base256emoji",encode:GD,decode:WD}),QD=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:YD},Symbol.toStringTag,{value:"Module"})),S8=({name:r,code:e,encode:t})=>new XD(r,e,t);let XD=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?yo(this.code,t):t.then(n=>yo(this.code,n))}else throw Error("Unknown type, must be binary type")}};const R8=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Hp=S8({name:"sha2-256",code:18,encode:R8("SHA-256")});S8({name:"sha2-512",code:19,encode:R8("SHA-512")});const A8=0,JD="identity",I8=sd,ZD=r=>yo(A8,I8(r)),Ih={code:A8,name:JD,encode:I8,digest:ZD};new TextEncoder;new TextDecoder;const N3={...CD,...kD,...PD,...ND,...LD,...ED,...BD,...uD,...jD,...QD};let x3=class L1 extends Error{constructor(e="The operation was aborted"){super(e),this.code=L1.code,this.type=L1.type}static get code(){return"ABORT_ERR"}static get type(){return"aborted"}};class ee extends Error{constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}}const C8=Symbol.for("@libp2p/peer-id");function Mn(r){return r!=null&&Boolean(r[C8])}const eP=Symbol.for("nodejs.util.inspect.custom"),tP=Object.values(N3).map(r=>r.decoder).reduce((r,e)=>r.or(e),N3.identity.decoder),T8=114,qp=36,Gp=37;class Wp{constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}get[C8](){return!0}toString(){return this.string==null&&(this.string=xr.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return _8.createV1(T8,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e instanceof Uint8Array)return Ye(this.multihash.bytes,e);if(typeof e=="string")return Z(e).equals(this);if(e?.multihash?.bytes!=null)return Ye(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[eP](){return`PeerId(${this.toString()})`}}class _c extends Wp{constructor(e){super({...e,type:"RSA"}),this.type="RSA",this.publicKey=e.publicKey}}class vc extends Wp{constructor(e){super({...e,type:"Ed25519"}),this.type="Ed25519",this.publicKey=e.multihash.digest}}class Sc extends Wp{constructor(e){super({...e,type:"secp256k1"}),this.type="secp256k1",this.publicKey=e.multihash.digest}}function gt(r){if(r.type==="RSA")return new _c(r);if(r.type==="Ed25519")return new vc(r);if(r.type==="secp256k1")return new Sc(r);throw new ee("Not a PeerId","ERR_INVALID_PARAMETERS")}function Z(r,e){if(r.charAt(0)==="1"||r.charAt(0)==="Q"){const t=Kp(xr.decode(`z${r}`));return r.startsWith("12D")?new vc({multihash:t}):r.startsWith("16U")?new Sc({multihash:t}):new _c({multihash:t})}return Fr(tP.decode(r))}function Fr(r){try{const e=Kp(r);if(e.code===Ih.code){if(e.digest.length===qp)return new vc({multihash:e});if(e.digest.length===Gp)return new Sc({multihash:e})}if(e.code===Hp.code)return new _c({multihash:e})}catch{return rP(_8.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function rP(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==T8)throw new Error("Supplied PeerID CID is invalid");const e=r.multihash;if(e.code===Hp.code)return new _c({multihash:r.multihash});if(e.code===Ih.code){if(e.digest.length===qp)return new vc({multihash:r.multihash});if(e.digest.length===Gp)return new Sc({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function Ir(r,e){return r.length===qp?new vc({multihash:yo(Ih.code,r),privateKey:e}):r.length===Gp?new Sc({multihash:yo(Ih.code,r),privateKey:e}):new _c({multihash:await Hp.digest(r),publicKey:r,privateKey:e})}function nP({repo:r,codecs:e,bases:t,name:n}){async function s(i,o={}){if(!h8(i))throw new Error("invalid argument "+i);if(u8(i))for await(const w of n.resolve(i,o))i=w;const[,a,c,...h]=i.split("/"),l=o.cidBase?await t.getBase(o.cidBase):void 0,u=sP(c);if(h.length===0){const w=l?l.encoder.encode(u):c;return`/${a}/${w}`}const f=J.decode(u);i=h.join("/");const g=Xa(f,i,e,r,o);let d=f,p=i;for await(const w of g)J.asCID(w.value)&&(d=w.value,p=w.remainderPath);return`/ipfs/${d.toString(l&&l.encoder)}${p?"/"+p:""}`}return x(s)}function sP(r){try{return Z(r).toBytes()}catch{return J.parse(r).bytes}}async function hr(r){let e;for await(const t of r)e=t;return e}function iP({addAll:r}){return(e,t={})=>{let n;const s=J.asCID(e);return s?n=r([{cid:s,...t}],t):n=r([{path:e.toString(),...t}],t),hr(n)}}function oP(r){return Symbol.iterator in r}function aP(r){return Symbol.asyncIterator in r}function $3(r){return xa.asCID(r)!=null}async function*Rc(r){if(r==null)throw v(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT");const e=xa.asCID(r);if(e){yield Ft({cid:e});return}if(r instanceof String||typeof r=="string"){yield Ft({path:r});return}if(r.cid!=null||r.path!=null)return yield Ft(r);if(oP(r)){const t=r[Symbol.iterator](),n=t.next();if(n.done)return t;if($3(n.value)){yield Ft({cid:n.value});for(const s of t)yield Ft({cid:s});return}if(n.value instanceof String||typeof n.value=="string"){yield Ft({path:n.value});for(const s of t)yield Ft({path:s});return}if(n.value.cid!=null||n.value.path!=null){yield Ft(n.value);for(const s of t)yield Ft(s);return}throw v(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}if(aP(r)){const t=r[Symbol.asyncIterator](),n=await t.next();if(n.done)return t;if($3(n.value)){yield Ft({cid:n.value});for await(const s of t)yield Ft({cid:s});return}if(n.value instanceof String||typeof n.value=="string"){yield Ft({path:n.value});for await(const s of t)yield Ft({path:s});return}if(n.value.cid!=null||n.value.path!=null){yield Ft(n.value);for await(const s of t)yield Ft(s);return}throw v(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}throw v(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}function Ft(r){const e=r.cid||`${r.path}`;if(!e)throw v(new Error("Unexpected input: Please path either a CID or an IPFS path"),"ERR_UNEXPECTED_INPUT");const t={path:e,recursive:r.recursive!==!1};return r.metadata!=null&&(t.metadata=r.metadata),t}const ye={direct:"direct",recursive:"recursive",indirect:"indirect",all:"all"};function cP({repo:r,codecs:e}){async function*t(n,s={}){const i=async function*(){for await(const{path:c,recursive:h,metadata:l}of Rc(n)){const{cid:u}=await rd(r,e,c),{reason:f}=await r.pins.isPinnedWithType(u,[ye.recursive,ye.direct]);if(f==="recursive"&&!h)throw new Error(`${u} already pinned recursively`);h?await r.pins.pinRecursively(u,{metadata:l}):await r.pins.pinDirectly(u,{metadata:l}),yield u}};if(!Boolean(s.lock)){yield*i();return}const a=await r.gcLock.readLock();try{yield*i()}finally{a()}}return x(t)}function Wo(r,e,t){const n={type:r,cid:e};return t&&(n.metadata=t),n}function lP({repo:r,codecs:e}){async function*t(n={}){let s=ye.all;if(n.type&&(s=n.type,!Object.keys(ye).includes(s)))throw v(new Error("Invalid pin type"),"ERR_INVALID_PIN_TYPE");if(n.paths){let i=!1;for await(const{path:o}of Rc(n.paths)){const{cid:a}=await rd(r,e,o),{reason:c,pinned:h,parent:l,metadata:u}=await r.pins.isPinnedWithType(a,s);if(!h)throw v(new Error(`path '${o}' is not pinned`),"ERR_NOT_PINNED");switch(c){case ye.direct:case ye.recursive:i=!0,yield Wo(c,a,u);break;default:i=!0,yield Wo(`${ye.indirect} through ${l}`,a,u)}}if(!i)throw new Error("No match found");return}if(s===ye.recursive||s===ye.all)for await(const{cid:i,metadata:o}of r.pins.recursiveKeys())yield Wo(ye.recursive,i,o);if(s===ye.indirect||s===ye.all)for await(const i of r.pins.indirectKeys(n))yield Wo(ye.indirect,i);if(s===ye.direct||s===ye.all)for await(const{cid:i,metadata:o}of r.pins.directKeys())yield Wo(ye.direct,i,o)}return x(t)}function hP({rmAll:r}){async function e(t,n={}){const s=await hr(r([{path:t,...n}],n));if(!s)throw new Error("CID expected");return s}return e}function uP({repo:r,codecs:e}){async function*t(n,s={}){const i=await r.gcLock.readLock();try{for await(const{path:o,recursive:a}of Rc(n)){const{cid:c}=await rd(r,e,o),{pinned:h,reason:l}=await r.pins.isPinnedWithType(c,ye.all);if(!h)throw new Error(`${c} is not pinned`);switch(l){case ye.recursive:if(!a)throw new Error(`${c} is pinned recursively`);await r.pins.unpin(c),yield c;break;case ye.direct:await r.pins.unpin(c),yield c;break;default:throw new Error(`${c} is pinned indirectly under ${l}`)}}}finally{i()}}return x(t)}class dP{constructor({codecs:e,repo:t}){const n=cP({codecs:e,repo:t});this.addAll=n,this.add=iP({addAll:n});const s=uP({codecs:e,repo:t});this.rmAll=s,this.rm=hP({rmAll:s}),this.ls=lP({codecs:e,repo:t}),this.remote={add:(i,o={})=>Promise.reject(new Error("Not implemented")),ls:async function*(i,o={}){return Promise.reject(new Error("Not implemented"))},rm:(i,o={})=>Promise.reject(new Error("Not implemented")),rmAll:(i,o={})=>Promise.reject(new Error("Not implemented")),service:{add:(i,o)=>Promise.reject(new Error("Not implemented")),rm:(i,o={})=>Promise.reject(new Error("Not implemented")),ls:(i={})=>Promise.reject(new Error("Not implemented"))}}}}function k8(r){return r=r||new Error("Cannot open database"),v(r,"ERR_DB_OPEN_FAILED")}function D8(r){return r=r||new Error("Delete failed"),v(r,"ERR_DB_DELETE_FAILED")}function M1(r){return r=r||new Error("Write failed"),v(r,"ERR_DB_WRITE_FAILED")}function hn(r){return r=r||new Error("Not Found"),v(r,"ERR_NOT_FOUND")}var U1={},fP={get exports(){return U1},set exports(r){U1=r}};(function(r){(function(){r.exports=w;var e=86400,t=3200,n=146097*t/400,s=e*n,i=1e3*s,o=864e13,a=4294967296,c=1e6,h="000000000",l=Math.trunc||function(C){var D=C-C%1;return D==0&&(C<0||C===0&&1/C!=1/0)?-0:D},u=w.prototype,f=(w.fromDate=function(C){return new w(+C)},w.fromInt64BE=S(0,1,2,3,0,4),w.fromInt64LE=S(3,2,1,0,4,0),w.fromString=function(K){var D,$=new w,K=(K+="").replace(/^\s*[+\-]?\d+/,function(Q){var Q=+Q,V=1970+(Q-1970)%400;return $.year=Q-V,V}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(W,Q,V){return Q<0&&(V*=-1),D=6e4*(60*+Q+ +V),""}).replace(/\.\d+$/,function(W){return $.nano=+(W+h).substr(1,9),""}).split(/\D+/);if(1<K.length?K[1]--:K[1]=0,$.time=D=Date.UTC.apply(Date,K)-(D||0),isNaN(D))throw new TypeError("Invalid Date");return y($)},w.fromTimeT=function(C){return m(C,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function(C){return this.nano+=+C||0,this},u.getNano=function(){var C=y(this);return(C.time%1e3*c+ +C.nano+1e9)%1e9},u.getTimeT=function(){var D=y(this),C=Math.floor(D.time/1e3),D=D.year;return D&&(C+=D*n*e/t),C},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return _(y(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function(C){var D=this,$=D.toDate(),K={H:function(){return E($.getUTCHours())},L:function(){return I($.getUTCMilliseconds(),3)},M:function(){return E($.getUTCMinutes())},N:function(){return I(D.getNano(),9)},S:function(){return E($.getUTCSeconds())},Y:function(){var W=D.getYear();return 999999<W?"+"+W:9999<W?"+"+I(W,6):0<=W?I(W,4):-999999<=W?"-"+I(-W,6):W},a:function(){return d[$.getUTCDay()]},b:function(){return g[$.getUTCMonth()]},d:function(){return E($.getUTCDate())},e:function(){return function(W){return(9<W?"":" ")+(0|W)}($.getUTCDate())},m:function(){return E($.getUTCMonth()+1)}};return function W(Q){return Q.replace(/%./g,function(V){var Te=V[1],me=p[Te],Te=K[Te];return me?W(me):Te?Te():V})}(C||f)},u.writeInt64BE=b(0,1,2,3,0,4),u.writeInt64LE=b(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return w;function w(C,D,$){var K=this;if(!(K instanceof w))return new w(C,D,$);K.time=+C||0,K.nano=+D||0,K.year=+$||0,y(K)}function y(C){var D,$,K,W=C.year,Q=C.time,V=C.nano,me=((V<0||c<=V)&&(V-=($=Math.floor(V/c))*c,Q+=$,$=1),W%t);return(Q<-o||o<Q||me)&&((D=l(Q/i))&&(W+=D*t,Q-=D*i),(K=_(Q)).setUTCFullYear(me+K.getUTCFullYear()),K=(Q=+K)+(D=l((W-=me)/t))*i,D&&-o<=K&&K<=o&&(W-=D*t,Q=K),$=1),$&&(C.year=W,C.time=Q,C.nano=V),C}function _(C){var D=new Date(0);return D.setTime(C),D}function m(W,K){W=+W||0;var $=l((K=(K|0)*a)/s)+l(W/s),K=K%s+W%s,W=l(K/s);return W&&($+=W,K-=W*s),new w(1e3*K,0,$*t)}function b(C,D,$,K,W,Q){return function(me,Te){var yn=y(this);me=me||new Array(8),A(me,Te|=0);var $i=Math.floor(yn.time/1e3),yn=yn.year*(n*e/t),gn=l(yn/a)+l($i/a),yn=yn%a+$i%a,$i=Math.floor(yn/a);return $i&&(gn+=$i,yn-=$i*a),V(me,Te+W,gn),V(me,Te+Q,yn),me};function V(me,Te,gn){me[Te+C]=gn>>24&255,me[Te+D]=gn>>16&255,me[Te+$]=gn>>8&255,me[Te+K]=255&gn}}function S(C,D,$,K,W,Q){return function(me,Te){A(me,Te|=0);var gn=V(me,Te+W);return m(V(me,Te+Q),gn)};function V(me,Te){return 16777216*me[Te+C]+(me[Te+D]<<16|me[Te+$]<<8|me[Te+K])}}function A(C,D){if(C=C&&C.length,C==null)throw new TypeError("Invalid Buffer");if(C<D+8)throw new RangeError("Out of range")}function E(C){return(9<C?"":"0")+(0|C)}function I(C,D){return(h+(0|C)).substr(-D)}})()})(fP);const pP=U1,P8=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let gP=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},yP=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return O8(this,e)}},wP=class{constructor(e){this.decoders=e}or(e){return O8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const O8=(r,e)=>new wP({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let mP=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new gP(e,t,n),this.decoder=new yP(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const bP=({name:r,prefix:e,encode:t,decode:n})=>new mP(r,e,t,n),EP=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},_P=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Vn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>bP({prefix:e,name:r,encode(s){return _P(s,n,t)},decode(s){return EP(s,n,t,r)}});Vn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});const vP=Vn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Vn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Vn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Vn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Vn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Vn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Vn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Vn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const SP="ERR_IPNS_EXPIRED_RECORD",Yp="ERR_UNRECOGNIZED_VALIDITY",RP="ERR_SIGNATURE_CREATION",oi="ERR_SIGNATURE_VERIFICATION",AP="ERR_UNRECOGNIZED_FORMAT",L3="ERR_UNDEFINED_PARAMETER",IP="ERR_INVALID_RECORD_DATA",CP="ERR_INVALID_EMBEDDED_KEY",TP="ERR_MISSING_PRIVATE_KEY";var un;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),function(n){n.codec=()=>fo(e)}(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=Qe((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.value!=null&&(s.uint32(10),s.bytes(n.value)),n.signature!=null&&(s.uint32(18),s.bytes(n.signature)),n.validityType!=null&&(s.uint32(24),r.ValidityType.codec().encode(n.validityType,s)),n.validity!=null&&(s.uint32(34),s.bytes(n.validity)),n.sequence!=null&&(s.uint32(40),s.uint64(n.sequence)),n.ttl!=null&&(s.uint32(48),s.uint64(n.ttl)),n.pubKey!=null&&(s.uint32(58),s.bytes(n.pubKey)),n.signatureV2!=null&&(s.uint32(66),s.bytes(n.signatureV2)),n.data!=null&&(s.uint32(74),s.bytes(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s)=>{const i={},o=s==null?n.len:n.pos+s;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:i.value=n.bytes();break;case 2:i.signature=n.bytes();break;case 3:i.validityType=r.ValidityType.codec().decode(n);break;case 4:i.validity=n.bytes();break;case 5:i.sequence=n.uint64();break;case 6:i.ttl=n.uint64();break;case 7:i.pubKey=n.bytes();break;case 8:i.signatureV2=n.bytes();break;case 9:i.data=n.bytes();break;default:n.skipType(a&7);break}}return i})),t),r.encode=n=>Xe(n,r.codec()),r.decode=n=>Je(n,r.codec())})(un||(un={}));const M3=P("ipns:utils"),N8=L("/ipns/");function B1(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),h=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,h))}const kP=async(r,e)=>{if(e==null||r==null){const n=new Error("one or more of the provided parameters are not defined");throw M3.error(n),v(n,L3)}let t;if(e.pubKey!=null){try{t=mi(e.pubKey)}catch(s){throw M3.error(s),s}if(!(await Ir(e.pubKey)).equals(r))throw v(new Error("Embedded public key did not match PeerID"),CP)}else r.publicKey!=null&&(t=mi(r.publicKey));if(t!=null)return t;throw v(new Error("no public key is available"),L3)},DP=(r,e,t)=>{const n=L(e);return qe([r,t,n])},x8=r=>{const e=L("ipns-signature:");return qe([e,r])},PP=r=>un.encode(r),od=r=>{const e=un.decode(r);return e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),{value:e.value??new Uint8Array(0),signature:e.signature??new Uint8Array(0),validityType:e.validityType??un.ValidityType.EOL,validity:e.validity??new Uint8Array(0),sequence:e.sequence??0n,pubKey:e.pubKey,ttl:e.ttl??void 0,signatureV2:e.signatureV2,data:e.data}},Ch=r=>qe([N8,r.toBytes()]),OP=r=>Fr(r.slice(N8.length)),NP=(r,e,t,n,s)=>{let i;if(t===un.ValidityType.EOL)i=0;else throw v(new Error("Unknown validity type"),Yp);return Ha({Value:r,Validity:e,ValidityType:i,Sequence:n,TTL:s})},xP=r=>{const e=Tn(r);if(e.ValidityType===0)e.ValidityType=un.ValidityType.EOL;else throw v(new Error("Unknown validity type"),Yp);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e};var $P=$8,U3=128,LP=127,MP=~LP,UP=Math.pow(2,31);function $8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=UP;)e[t++]=r&255|U3,r/=128;for(;r&MP;)e[t++]=r&255|U3,r>>>=7;return e[t]=r|0,$8.bytes=t-n+1,e}var BP=z1,zP=128,B3=127;function z1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw z1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&B3)<<s:(o&B3)*Math.pow(2,s),s+=7}while(o>=zP);return z1.bytes=i-n,t}var FP=Math.pow(2,7),VP=Math.pow(2,14),KP=Math.pow(2,21),jP=Math.pow(2,28),HP=Math.pow(2,35),qP=Math.pow(2,42),GP=Math.pow(2,49),WP=Math.pow(2,56),YP=Math.pow(2,63),QP=function(r){return r<FP?1:r<VP?2:r<KP?3:r<jP?4:r<HP?5:r<qP?6:r<GP?7:r<WP?8:r<YP?9:10},XP={encode:$P,decode:BP,encodingLength:QP},Th=XP;const z3=(r,e=0)=>[Th.decode(r,e),Th.decode.bytes],F3=(r,e,t=0)=>(Th.encode(r,e,t),e),V3=r=>Th.encodingLength(r),JP=(r,e)=>{const t=e.byteLength,n=V3(r),s=n+V3(t),i=new Uint8Array(s+t);return F3(r,i,0),F3(t,i,n),i.set(e,s),new L8(r,t,e,i)},ZP=r=>{const e=P8(r),[t,n]=z3(e),[s,i]=z3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new L8(t,s,o,e)};let L8=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const M8=0,eO="identity",U8=P8,tO=r=>JP(M8,U8(r)),rO={code:M8,name:eO,encode:U8,digest:tO},B8=P("ipns"),nO=rO.code,$l="/ipns/",Yd=$l.length,sO=async(r,e,t,n)=>{const s=new pP(Date.now()+Number(n)),i=un.ValidityType.EOL,[o,a]=n.toString().split("."),c=BigInt(o)*BigInt(1e5)+BigInt(a??"0");return await iO(r,e,t,i,s,c)},iO=async(r,e,t,n,s,i)=>{t=BigInt(t);const o=L(s.toString());if(r.privateKey==null)throw v(new Error("Missing private key"),TP);const a=await Qs(r.privateKey),c=await aO(a,e,n,o),h=NP(e,o,n,t,i),l=x8(h),u=await a.sign(l),f={value:e,signature:c,validityType:n,validity:o,sequence:t,ttl:i,signatureV2:u,data:h};if(r.publicKey!=null){const g=ZP(r.toBytes());(g.code!==nO||!Ye(r.publicKey,g.digest))&&(f.pubKey=r.publicKey)}return B8("ipns entry for %b created",e),f},oO=r=>vP.encode(r).slice(1),F1=r=>new X(`/ipns/${oO(r)}`),aO=async(r,e,t,n)=>{try{const s=DP(e,t,n);return await r.sign(s)}catch(s){throw B8.error("record signature creation failed",s),v(new Error("record signature creation failed"),RP)}},ur=P("ipfs:ipns:publisher"),K3=hn().code,z8=60*60*1e3;class Ll{constructor(e,t){this._routing=e,this._datastore=t}async publishWithEOL(e,t,n,s){const i=await this._updateOrCreateRecord(e,t,n,s);return this._putRecordToRouting(i,e,s)}publish(e,t,n){return this.publishWithEOL(e,t,z8,n)}async _putRecordToRouting(e,t,n){if(!Mn(t)){const i="peerId received is not valid";throw ur.error(i),v(new Error(i),"ERR_INVALID_PEER_ID")}if(t.publicKey==null)throw v(new Error("Public key was missing"),"ERR_MISSING_PUBLIC_KEY");const s=Ch(t);return await this._publishEntry(s,e,n),e}async _publishEntry(e,t,n){try{const s=await this._routing.put(e,t,n);return ur(`ipns record for ${B(e,"base32")} was stored in the routing`),s}catch(s){const i=`ipns record for ${B(e,"base32")} could not be stored in the routing - ${s.stack}`;throw ur.error(i),ur.error(s),v(new Error(i),"ERR_PUTTING_TO_ROUTING")}}async _getPublished(e,t={}){if(!Mn(e)){const s="peerId received is not valid";throw ur.error(s),v(new Error(s),"ERR_INVALID_PEER_ID")}const n=t.checkRouting!==!1;try{const s=await this._datastore.get(F1(e.toBytes()));return this._unmarshalData(s)}catch(s){if(s.code!==K3){const i=`unexpected error getting the ipns record ${e.toString()} from datastore`;throw ur.error(i),v(new Error(i),"ERR_UNEXPECTED_DATASTORE_RESPONSE")}if(!n)throw v(s,"ERR_NOT_FOUND_AND_CHECK_ROUTING_NOT_ENABLED");try{const i=Ch(e),o=await this._routing.get(i);return this._unmarshalData(o)}catch(i){throw ur.error(i),i}}}_unmarshalData(e){try{return od(e)}catch(t){throw v(t,"ERR_INVALID_RECORD_DATA")}}async _updateOrCreateRecord(e,t,n,s){if(!Mn(e)){const h="peerId received is not valid";throw ur.error(h),v(new Error(h),"ERR_INVALID_PEER_ID")}const i={checkRouting:!0};let o;try{o=await this._getPublished(e,i)}catch(h){if(h.code!==K3){const l=`unexpected error when determining the last published IPNS record for ${e.toString()} ${h.stack}`;throw ur.error(l),v(new Error(l),"ERR_DETERMINING_PUBLISHED_RECORD")}}let a=0n;o&&o.sequence!==void 0&&(a=Ye(o.value,t)?o.sequence:o.sequence+BigInt(1));let c;try{c=await sO(e,t,a,n)}catch(h){const l=`ipns record for ${t} could not be created`;throw ur.error(h),v(new Error(l),"ERR_CREATING_IPNS_RECORD")}try{const h=PP(c);return await this._datastore.put(F1(e.toBytes()),h,s),ur(`ipns record for ${B(t,"base32")} was stored in the datastore`),h}catch{const l=`ipns record for ${t} could not be stored in the datastore`;throw ur.error(l),v(new Error(l),"ERR_STORING_IN_DATASTORE")}}}Ll.defaultRecordLifetime=z8;const Kc=P("ipfs:ipns:republisher"),F8=60*1e3,V8=60*F8,cO=4*V8,lO=24*V8;class hO{constructor(e,t,n,s,i={pass:""}){this._publisher=e,this._datastore=t,this._peerId=n,this._keychain=s,this._options=i,this._republishHandle=null}async start(){if(this._republishHandle)throw v(new Error("republisher is already running"),"ERR_REPUBLISH_ALREADY_RUNNING");const e={_task:null,_inflightTask:null,_timeoutId:null,runPeriodically:s=>{e._timeoutId=setTimeout(async()=>{e._timeoutId=null;try{e._inflightTask=e._task(),await e._inflightTask,e._task&&e.runPeriodically(s)}catch(i){Kc.error(i)}},s())},cancel:async()=>{e._timeoutId!=null&&clearTimeout(e._timeoutId),e._task=null,await e._inflightTask}},{pass:t}=this._options;let n=!0;e._task=async()=>{const s=new ze.TimeoutController(3e4);try{await this._republishEntries(this._peerId,t,{signal:s.signal})}finally{s.clear()}},e.runPeriodically(()=>n?(n=!1,this._options.initialBroadcastInterval||F8):this._options.broadcastInterval||cO),this._republishHandle=e}async stop(){const e=this._republishHandle;if(!e)throw v(new Error("republisher is not running"),"ERR_REPUBLISH_NOT_RUNNING");this._republishHandle=null,await e.cancel()}async _republishEntries(e,t,n){try{await this._republishEntry(e,n)}catch{const i="cannot republish entry for the node's private key";Kc.error(i);return}if(t)try{const s=await this._keychain.listKeys();for(const i of s){if(i.name==="self")continue;const o=await this._keychain.exportKey(i.name,t),a=await Qi(o,t),c=await Ir(a.public.bytes,a.bytes);await this._republishEntry(c,n)}}catch(s){Kc.error(s)}}async _republishEntry(e,t){try{const n=await this._getPreviousValue(e);await this._publisher.publishWithEOL(e,n,lO,t)}catch(n){if(n.code==="ERR_NO_ENTRY_FOUND")return;throw n}}async _getPreviousValue(e){if(!Mn(e))throw v(new Error("invalid peer ID"),"ERR_INVALID_PEER_ID");try{const t=await this._datastore.get(F1(e.toBytes()));if(!(t instanceof Uint8Array))throw v(new Error("found ipns record that we couldn't process"),"ERR_INVALID_IPNS_RECORD");try{return od(t).value}catch(n){throw Kc.error(n),v(new Error("found ipns record that we couldn't convert to a value"),"ERR_INVALID_IPNS_RECORD")}}catch(t){throw t&&t.notFound?v(new Error(`no previous entry for record with id: ${e.toString()}`),"ERR_NO_ENTRY_FOUND"):t}}}const Yo=P("ipns:validator"),uO=async(r,e)=>{const{value:t,validityType:n,validity:s}=e;let i,o;if(e.signatureV2!=null&&e.data!=null)o=e.signatureV2,i=x8(e.data),dO(e);else throw v(new Error("missing data or signatureV2"),oi);let a;try{a=await r.verify(i,o)}catch{a=!1}if(!a)throw Yo.error("record signature verification failed"),v(new Error("record signature verification failed"),oi);if(s!=null&&n===un.ValidityType.EOL){let c;try{c=B1(B(s))}catch{throw Yo.error("unrecognized validity format (not an rfc3339 format)"),v(new Error("unrecognized validity format (not an rfc3339 format)"),AP)}if(c.getTime()<Date.now())throw Yo.error("record has expired"),v(new Error("record has expired"),SP)}else if(n!=null)throw Yo.error("unrecognized validity type"),v(new Error("unrecognized validity type"),Yp);Yo("ipns entry for %b is valid",t)},dO=r=>{if(r.data==null)throw v(new Error("Record data is missing"),IP);const e=xP(r.data);if(!Ye(e.Value,r.value))throw v(new Error('Field "value" did not match between protobuf and CBOR'),oi);if(!Ye(e.Validity,r.validity))throw v(new Error('Field "validity" did not match between protobuf and CBOR'),oi);if(e.ValidityType!==r.validityType)throw v(new Error('Field "validityType" did not match between protobuf and CBOR'),oi);if(e.Sequence!==r.sequence)throw v(new Error('Field "sequence" did not match between protobuf and CBOR'),oi);if(e.TTL!==r.ttl)throw v(new Error('Field "ttl" did not match between protobuf and CBOR'),oi)},Qp=async(r,e)=>{const t=OP(r),n=od(e),s=await kP(t,n);await uO(s,n)},Qd=P("ipfs:ipns:resolver"),fO=hn().code,j3=32;class pO{constructor(e){this._routing=e}async resolve(e,t={}){if(typeof e!="string")throw v(new Error("invalid name"),"ERR_INVALID_NAME");const n=t.recursive&&t.recursive.toString()==="true",s=e.split("/");if(s.length!==3||s[0]!=="")throw v(new Error("invalid name"),"ERR_INVALID_NAME");const i=s[2];let o=1/0;n&&(o=j3);const a=await this.resolver(i,o,t);return Qd(`${e} was locally resolved correctly`),a}async resolver(e,t,n){if(t===0){const o=`could not resolve name (recursion limit of ${j3} exceeded)`;throw Qd.error(o),v(new Error(o),"ERR_RESOLVE_RECURSION_LIMIT")}const s=await this._resolveName(e,n),i=s.split("/");return i[1]==="ipfs"||!t?s:this.resolver(i[2],t-1,n)}async _resolveName(e,t){const n=Z(e),s=Ch(n);let i;try{i=await this._routing.get(s,t)}catch(o){throw Qd.error("could not get record from routing",o),o.code===fO?v(new Error(`record requested for ${e} was not found in the network`),"ERR_NO_RECORD_FOUND"):v(new Error(`unexpected error getting the ipns record ${n.toString()}`),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}return this._validateRecord(n,i)}async _validateRecord(e,t){await Qp(qe([L("/ipns/"),e.toBytes()]),t);const n=od(t);return B(n.value)}}class gO{constructor(e){this.lru=nd(e)}get(e){const t=this.lru.get(e);if(t){if(t.expire&&t.expire<Date.now()){this.lru.remove(e);return}return t.value}}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}}const Qo=P("ipfs:ipns"),H3=60*1e3;class q3{constructor(e,t,n,s,i){this.publisher=new Ll(e,t),this.republisher=new hO(this.publisher,t,n,s,i),this.resolver=new pO(e),this.cache=new gO(1e3),this.routing=e}async publish(e,t,n=Ll.defaultRecordLifetime,s){try{await this.publisher.publishWithEOL(e,t,n,s),Qo(`IPNS value ${B(t,"base32")} was published correctly`);const i=e.toString(),o=parseFloat(n),a=o<H3?o:H3;return this.cache.set(i,t,a),Qo(`IPNS value ${B(t,"base32")} was cached correctly`),{name:i,value:t}}catch(i){throw Qo.error(i),i}}async resolve(e,t={}){if(typeof e!="string")throw v(new Error("name received is not valid"),"ERR_INVALID_NAME");if(!t.nocache&&!t.recursive){const n=e.split("/")[2],s=this.cache.get(n);if(s)return s}try{const n=await this.resolver.resolve(e,t);return Qo(`IPNS record from ${e} was resolved correctly`),n}catch(n){throw Qo.error(n),n}}async initializeKeyspace(e,t,n){return this.publish(e,t,Ll.defaultRecordLifetime,n)}}async function Kn(r){const e=[];for await(const t of r)e.push(t);return e}const G3=(r,e)=>async function*(){yield*(await Kn(r)).sort(e)}();async function ot(r){for await(const e of r);}async function*$e(r,e){for await(const t of r)await e(t)&&(yield t)}async function*Ei(r,e){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}class ad{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await ot(this.putMany(e,n)),e=[],await ot(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null&&(n=$e(n,s=>s.key.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>$e(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>G3(s,i),n)),e.offset!=null){let s=0;n=$e(n,()=>s++>=e.offset)}return e.limit!=null&&(n=Ei(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null&&(n=$e(n,s=>s.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>$e(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>G3(s,i),n)),e.offset!=null){let s=0;n=$e(n,()=>s++>=e.offset)}return e.limit!=null&&(n=Ei(n,e.limit)),n}}const yO=P("datastore:core:tiered");class wO extends ad{constructor(e){super(),this.stores=e.slice()}async open(){try{await Promise.all(this.stores.map(e=>e.open()))}catch(e){throw k8(e)}}async put(e,t,n){try{await Promise.all(this.stores.map(s=>s.put(e,t,n)))}catch(s){throw M1(s)}}async get(e,t){for(const n of this.stores)try{const s=await n.get(e,t);if(s)return s}catch(s){yO.error(s)}throw hn()}async has(e,t){for(const n of this.stores)if(await n.has(e,t))return!0;return!1}async delete(e,t){try{await Promise.all(this.stores.map(n=>n.delete(e,t)))}catch(n){throw D8(n)}}async*putMany(e,t={}){let n;const s=this.stores.map(i=>{const o=Bt({objectMode:!0});return ot(i.putMany(o,t)).catch(a=>{n=a}),o});try{for await(const i of e){if(n)throw n;s.forEach(o=>o.push(i)),yield i}}finally{s.forEach(i=>i.end())}}async*deleteMany(e,t={}){let n;const s=this.stores.map(i=>{const o=Bt({objectMode:!0});return ot(i.deleteMany(o,t)).catch(a=>{n=a}),o});try{for await(const i of e){if(n)throw n;s.forEach(o=>o.push(i)),yield i}}finally{s.forEach(i=>i.end())}}async close(){await Promise.all(this.stores.map(e=>e.close()))}batch(){const e=this.stores.map(t=>t.batch());return{put:(t,n)=>{e.forEach(s=>s.put(t,n))},delete:t=>{e.forEach(n=>n.delete(t))},commit:async t=>{for(const n of e)await n.commit(t)}}}query(e,t){return this.stores[this.stores.length-1].query(e,t)}queryKeys(e,t){return this.stores[this.stores.length-1].queryKeys(e,t)}}function le(r,e,t,n,s){for(e=e.split?e.split("."):e,n=0;n<e.length;n++)r=r?r[e[n]]:s;return r===s?t:r}const K8=(r,e)=>{const t=e.map((n,s)=>({entry:un.decode(n),index:s}));return t.sort((n,s)=>{if(n.entry.signatureV2!=null&&s.entry.signatureV2==null)return-1;if(n.entry.signatureV2==null&&s.entry.signatureV2!=null)return 1;const i=n.entry.sequence??0n,o=s.entry.sequence??0n;if(i>o)return-1;if(i<o)return 1;const a=n.entry.validity??new Uint8Array(0),c=s.entry.validity??new Uint8Array(0),h=B1(B(a)),l=B1(B(c));return h.getTime()>l.getTime()?-1:h.getTime()<l.getTime()?1:0}),t[0].index},mO="SHARDING",bO="_README";class EO extends ad{constructor(){super(),this.data={}}open(){return Promise.resolve()}close(){return Promise.resolve()}async put(e,t){this.data[e.toString()]=t}async get(e){if(!await this.has(e))throw hn();return this.data[e.toString()]}async has(e){return this.data[e.toString()]!==void 0}async delete(e){delete this.data[e.toString()]}async*_all(){yield*Object.entries(this.data).map(([e,t])=>({key:new X(e),value:t}))}async*_allKeys(){yield*Object.entries(this.data).map(([e])=>new X(e))}}async function*zt(r,e){for await(const t of r)yield e(t)}async function*Yt(...r){const e=Bt({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async t=>{for await(const n of t)e.push(n)})),e.end()}catch(t){e.end(t)}}),yield*e}const _O=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},j8=r=>r!=null&&(typeof r[Symbol.asyncIterator]=="function"||typeof r[Symbol.iterator]=="function"||typeof r.next=="function"),Xd=r=>r!=null&&typeof r.sink=="function"&&j8(r.source),vO=r=>e=>{const t=r.sink(e);if(t.then!=null){const n=Bt({objectMode:!0});return t.then(()=>{n.end()},i=>{n.end(i)}),Yt(n,async function*(){yield*r.source,n.end()}())}return r.source};function ie(r,...e){if(Xd(r)){const n=r;r=()=>n.source}else if(j8(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&Xd(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)Xd(t[n])&&(t[n]=vO(t[n]));return _O(...t)}new X(mO);new X(bO);const Ml="/record/";function W3(r){return B(r,"base32")}function jc(r){(typeof r=="string"||r instanceof String)&&(r=L(r.toString()));const e=B(r,"base64url");return`${Ml}${e}`}function SO(r){if(r.substring(0,Ml.length)!==Ml)throw new ee("topic received is not from a record","ERR_TOPIC_IS_NOT_FROM_RECORD_NAMESPACE");const e=r.substring(Ml.length);return L(e,"base64url")}const dt=P("datastore-pubsub:publisher");class RO extends ad{constructor(e,t,n,s,i,o){if(super(),!s)throw new ee("missing validator","ERR_INVALID_PARAMETERS");if(typeof s!="function")throw new ee("missing validate function","ERR_INVALID_PARAMETERS");if(typeof i!="function")throw new ee("missing select function","ERR_INVALID_PARAMETERS");if(o&&typeof o!="function")throw new ee("invalid subscriptionKeyFn received","ERR_INVALID_PARAMETERS");this._pubsub=e,this._datastore=t,this._peerId=n,this._validator=s,this._selector=i,this._handleSubscriptionKeyFn=o,this._onMessage=this._onMessage.bind(this),this._pubsub.addEventListener("message",this._onMessage)}async put(e,t,n){if(!(e instanceof Uint8Array)){const i="datastore key does not have a valid format";throw dt.error(i),new ee(i,"ERR_INVALID_DATASTORE_KEY")}if(!(t instanceof Uint8Array)){const i="received value is not a Uint8Array";throw dt.error(i),new ee(i,"ERR_INVALID_VALUE_RECEIVED")}const s=jc(e);dt(`publish value for topic ${s}`),await this._pubsub.publish(s,t)}async get(e,t){if(!(e instanceof Uint8Array)){const i="datastore key does not have a valid format";throw dt.error(i),new ee(i,"ERR_INVALID_DATASTORE_KEY")}const n=jc(e),s=await this._pubsub.getTopics();if(s&&Array.isArray(s)&&s.indexOf(n)>-1)return this._getLocal(e,t);try{await this._pubsub.subscribe(n)}catch{const o=`cannot subscribe topic ${n}`;throw dt.error(o),new ee(o,"ERR_SUBSCRIBING_TOPIC")}return dt(`subscribed values for key ${n}`),this._getLocal(e)}unsubscribe(e){const t=jc(e);return this._pubsub.unsubscribe(t)}async _getLocal(e,t){const n=new X("/"+W3(e),!1);let s;try{s=await this._datastore.get(n,t)}catch(i){if(i.code!=="ERR_NOT_FOUND"){const a=`unexpected error getting the ipns record for ${n.toString()}`;throw dt.error(a),new ee(a,"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}const o=`local record requested was not found for ${n.toString()}`;throw dt.error(o),new ee(o,"ERR_NOT_FOUND")}if(!(s instanceof Uint8Array)){const i="found record that we couldn't convert to a value";throw dt.error(i),new ee(i,"ERR_INVALID_RECORD_RECEIVED")}return s}async _onMessage(e){const t=e.detail;if(t.type!=="signed"){dt.error("unsigned message received, this module can only work with signed messages");return}const{data:n,from:s,topic:i}=t;let o;try{o=SO(i)}catch(a){dt.error(a);return}if(dt(`message received for topic ${i}`),this._peerId.equals(s)){dt("message discarded as it is from the same peer");return}if(this._handleSubscriptionKeyFn){let a;try{a=await this._handleSubscriptionKeyFn(o)}catch{dt.error("message discarded by the subscriptionKeyFn");return}o=a}try{await this._storeIfSubscriptionIsBetter(o,n)}catch(a){dt.error(a)}}async _storeIfSubscriptionIsBetter(e,t,n){let s=!1;try{s=await this._isBetter(e,t)}catch(i){if(i.code!=="ERR_NOT_VALID_RECORD")throw i}s&&await this._storeRecord(e,t,n)}async _validateRecord(e,t){return this._validator(e,t)}async _selectRecord(e,t){return await this._selector(e,t)===0}async _isBetter(e,t){try{await this._validateRecord(e,t)}catch{const o="record received through pubsub is not valid";throw dt.error(o),new ee(o,"ERR_NOT_VALID_RECORD")}const n=new X(e);let s;try{s=await this._getLocal(n.uint8Array())}catch{return!0}return Ye(s,t)?!1:this._selectRecord(e,[s,t])}async _storeRecord(e,t,n){const s=new X("/"+W3(e),!1);await this._datastore.put(s,t,n),dt(`record for ${jc(e)} was stored in the datastore`)}}const Hc=P("ipfs:ipns:pubsub");class V1{constructor(e,t,n){this._subscriptions={},this._handleSubscriptionKey=this._handleSubscriptionKey.bind(this),this._pubsubDs=new RO(e,t,n,Qp,K8,this._handleSubscriptionKey)}async put(e,t,n){try{await this._pubsubDs.put(e,t,n)}catch(s){throw Hc.error(s),s}}async get(e,t){let n,s;try{n=await this._pubsubDs.get(e,t)}catch(o){s=o}const i=e.slice(0,Yd);if(B(i)===$l){const o=sr.encode(e).substring(1),a=sr.encode(e.slice(Yd)).substring(1);this._subscriptions[o]=a,Hc(`subscribed to pubsub topic ${o}, id ${a}`)}if(s)throw s;return n}_handleSubscriptionKey(e){e instanceof Uint8Array&&(e=B(e,"base58btc"));const t=this._subscriptions[e];if(!t)throw v(new Error(`key ${e} does not correspond to a subscription`),"ERR_INVALID_KEY");try{return Ch(Z(t))}catch(n){throw Hc.error(n),n}}getSubscriptions(){return Object.values(this._subscriptions).filter(Boolean).map(t=>`${$l}${t}`)}async cancel(e){if(typeof e!="string")throw v(new Error("invalid subscription name"),"ERR_INVALID_SUBSCRIPTION_NAME");e.startsWith($l)&&(e=e.substring(Yd));const t=Object.keys(this._subscriptions).find(s=>this._subscriptions[s]===e);if(!t)return{canceled:!1};const n=L(t);return this._pubsubDs.unsubscribe(n),delete this._subscriptions[t],Hc(`unsubscribed pubsub ${t}: ${e}`),{canceled:!0}}}var kh;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.key!=null&&t.key.byteLength>0)&&(n.uint32(10),n.bytes(t.key)),(s.writeDefaults===!0||t.value!=null&&t.value.byteLength>0)&&(n.uint32(18),n.bytes(t.value)),(s.writeDefaults===!0||t.timeReceived!=="")&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={key:new Uint8Array(0),value:new Uint8Array(0),timeReceived:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(kh||(kh={}));function AO(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function IO(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),h=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,h))}class Kt{constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return kh.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:AO(this.timeReceived)}}static deserialize(e){const t=kh.decode(e);return new Kt(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=IO(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Kt(e.key,e.value,t)}}const Jd=P("ipfs:ipns:offline-datastore");class H8{constructor(e){this._datastore=e,this.stores=[]}async put(e,t,n){if(!(e instanceof Uint8Array))throw v(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");if(!(t instanceof Uint8Array))throw v(new Error("Offline datastore value must be a Uint8Array"),"ERR_INVALID_VALUE");let s;try{s=this._routingKey(e)}catch(o){throw Jd.error(o),v(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const i=new Kt(e,t,new Date);await this._datastore.put(s,i.serialize(),n)}async get(e,t){if(!(e instanceof Uint8Array))throw v(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");let n;try{n=this._routingKey(e)}catch(o){throw Jd.error(o),v(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const s=await this._datastore.get(n,t);let i;try{i=Kt.deserialize(s)}catch(o){throw Jd.error(o),o}return i.value}_routingKey(e){return new X("/dht/record/"+B(e,"base32"),!1)}}const CO=P("ipfs:ipns:dht-datastore");class TO{constructor(e){this._dht=e}async put(e,t,n){try{await ot(this._dht.put(e,t,n))}catch(s){throw CO.error(s),s}}async get(e,t){for await(const n of this._dht.get(e,t))if(n.name==="VALUE")return n.value;throw hn()}}function kO({libp2p:r,repo:e,peerId:t,options:n}){const s=[];let i;if(le(n,"EXPERIMENTAL.ipnsPubsub",!1)&&(i=new V1(r.pubsub,e.datastore,t),s.push(i)),le(n,"offline",!1)!==!0&&["dht","dhtclient","dhtserver"].includes(le(n,"config.Routing.Type","none"))&&s.push(new TO(r.dht)),le(n,"offline",!1)||s.length===0){const o=new H8(e.datastore);s.push(o)}return new wO(s)}const DO=P("ipfs:components:ipns");class PO{constructor(e={pass:""}){this.options=e,this.offline=null,this.online=null}getIPNS(){const e=this.online||this.offline;if(e)return e;throw new yc}get routing(){return this.getIPNS().routing}startOffline({repo:e,peerId:t,keychain:n}){if(this.offline!=null)throw new bi;DO("initializing IPNS keyspace (offline)");const s=new H8(e.datastore),i=new q3(s,e.datastore,t,n,this.options);this.offline=i}async startOnline({libp2p:e,repo:t,peerId:n,keychain:s}){if(this.online!=null)throw new bi;const i=kO({libp2p:e,repo:t,peerId:n,options:this.options}),o=new q3(i,t.datastore,n,s,this.options);await o.republisher.start(),this.online=o}async stop(){const e=this.online;e&&(await e.republisher.stop(),this.online=null)}publish(e,t,n,s){return this.getIPNS().publish(e,t,n,s)}resolve(e,t){return this.getIPNS().resolve(e,t)}initializeKeyspace(e,t,n){return this.getIPNS().initializeKeyspace(e,t,n)}}async function OO({ipns:r,repo:e,codecs:t},n,s){if(u8(n))return r.resolve(n);const{cid:i,path:o}=bc(n);await ot(Xa(i,o||"",t,e,s))}const Zd=P("ipfs:name:publish");function NO({ipns:r,repo:e,codecs:t,peerId:n,isOnline:s,keychain:i}){const o=async c=>{let h;if(c==="self"&&n.privateKey!=null)h=await Qs(n.privateKey);else try{const l=await i.exportKey(c,"temp");h=await Qi(l,"temp")}catch(l){throw Zd.error(l),v(l,"ERR_CANNOT_GET_KEY")}return Ir(h.public.bytes,h.bytes)};async function a(c,h={}){const l=h.resolve!==!1,u=h.lifetime||"24h",f=h.key||"self";if(!s())throw v(new Error(m8),"OFFLINE_ERROR");try{c=vk(c)}catch(y){throw Zd.error(y),y}let g=0;try{g=re(u)||0,g=parseFloat(g.toFixed(6))}catch(y){throw Zd.error(y),y}const d=await Promise.all([o(f),l?OO({ipns:r,repo:e,codecs:t},c):Promise.resolve()]),p=L(c),w=await r.publish(d[0],p,g,h);return{name:w.name,value:B(w.value)}}return x(a)}var xO=/^(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9])?\.){0,126}(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9]))\.?$/i,$O=function(e,t){if(t==null&&(t=!1),e.length<2||e.length>255)return!1;var n=e[e.length-1];if(t){if(n!==".")return!1}else if(n===".")return!1;return xO.test(e)};const LO=Ue.bind({ignoreUndefined:!0}),MO=P("ipfs:name:resolve"),Y3=(r,e)=>e.length>0?r+"/"+e.join("/"):r;function UO({dns:r,ipns:e,isOnline:t,options:{offline:n}}){async function*s(i,o={}){if(o=LO({nocache:!1,recursive:!0},o),n&&o&&o.nocache)throw v(new Error("cannot specify both offline and nocache"),"ERR_NOCACHE_AND_OFFLINE");if(!t()&&!n)throw v(new Error(m8),"OFFLINE_ERROR");let a=i.toString();a.startsWith("/ipns/")||(a=`/ipns/${a}`);let[c,h,...l]=a.slice(1).split("/");try{if(h.substring(0,1)==="1"){const f=Z(h),g=zm(f.toBytes());h=J.createV1(114,g).toString(ph)}else{const f=J.parse(h);f.version===1&&(h=f.toString(ph))}}catch(f){if($O(h)){yield Y3(await r(h,o),l);return}throw MO.error(f),v(new Error("Invalid IPNS name"),"ERR_IPNS_INVALID_NAME")}const u=await e.resolve(`/${c}/${h}`,o);yield Y3(u instanceof Uint8Array?B(u):u,l)}return x(s)}function Xp(r,e){if(!r||!(e&&e.ipnsPubsub))throw v(new Error("IPNS pubsub subsystem is not enabled"),"ERR_IPNS_PUBSUB_NOT_ENABLED");if(r.routing instanceof V1)return r.routing;const t=(r.routing.stores||[]).find(n=>n instanceof V1);if(!t)throw v(new Error("IPNS pubsub datastore not found"),"ERR_PUBSUB_DATASTORE_NOT_FOUND");return t}function BO({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s,i={}){return Xp(r,t).cancel(s,i)}return x(n)}function zO({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s={}){try{return{enabled:Boolean(Xp(r,t))}}catch{return{enabled:!1}}}return x(n)}function FO({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s={}){return Xp(r,t).getSubscriptions(s)}return x(n)}class VO{constructor({ipns:e,options:t}){this.cancel=BO({ipns:e,options:t}),this.state=zO({ipns:e,options:t}),this.subs=FO({ipns:e,options:t})}}class KO{constructor({dns:e,ipns:t,repo:n,codecs:s,peerId:i,isOnline:o,keychain:a,options:c}){this.publish=NO({ipns:t,repo:n,codecs:s,peerId:i,isOnline:o,keychain:a}),this.resolve=UO({dns:e,ipns:t,isOnline:o,options:c}),this.pubsub=new VO({ipns:t,options:c})}}const jO=hn().code,K1={default:"<dst>",edges:"<src> -> <dst>"};function HO({repo:r,codecs:e,resolve:t,preload:n}){async function*s(i,o={}){if(o.maxDepth===0)return;if(o.edges&&o.format&&o.format!==K1.default)throw new Error("Cannot set edges to true and also specify format");if(o.format=o.edges?K1.edges:o.format,typeof o.maxDepth!="number"&&(o.maxDepth=o.recursive?1/0:1),o.timeout){const l=[new ze.TimeoutController(o.timeout).signal];o.signal&&l.push(o.signal),o.signal=Ur(l)}const c=(Array.isArray(i)?i:[i]).map(h=>qO(n,h,o));for(const h of c)try{yield*GO(t,r,e,h,o)}catch(l){yield{ref:"",err:l.message}}}return s}function qO(r,e,t){const{cid:n,path:s}=bc(e);return t.preload!==!1&&r(n),`/ipfs/${n}${s||""}`}async function*GO(r,e,t,n,s){const i=await r(n,s),{cid:o}=bc(i),a=s.maxDepth!=null?s.maxDepth:1/0,c=s.unique||!1;for await(const h of YO(e,t,o,a,c,s))h.parent&&(h.isDuplicate||(yield{ref:WO(h.parent.cid,h.node.cid,h.node.name,s.format)}))}function WO(r,e,t="",n=K1.default){let s=n.replace(/<src>/g,r.toString());return s=s.replace(/<dst>/g,e.toString()),s=s.replace(/<linkname>/g,t),s}async function*YO(r,e,t,n,s,i){const o=new Set;async function*a(c,h){const l=h+1;if(!(l>n))try{for await(const u of QO(r,e,c.cid,i))yield{parent:c,node:u,isDuplicate:s&&o.has(u.cid.toString())},s&&o.add(u.cid.toString()),yield*a(u,l)}catch(u){throw u.code===jO&&(u.message=`Could not find object with CID: ${c.cid}`),u}}yield*a({cid:t},0)}async function*QO(r,e,t,n){const s=await r.blocks.get(t,n),o=(await e.getCodec(t.code)).decode(s),a=t.code===Be,c=[];for(const[h,l]of j1(o,c)){if(a){const u=h.match(/^Links\/(\d+)\/Hash$/);if(u){const f=Number(u[1]);if(f<o.Links.length){yield{name:o.Links[f].Name,cid:l};continue}}}yield{name:h,cid:l}}}const j1=function*(r,e){if(r!=null&&!(r instanceof Uint8Array)){for(const[t,n]of Object.entries(r)){const s=[...e,t];if(n!=null&&typeof n=="object")if(Array.isArray(n))for(const[i,o]of n.entries()){const a=[...s,i],c=J.asCID(o);c?yield[a.join("/"),c]:typeof o=="object"&&(yield*j1(o,a))}else{const i=J.asCID(n);i?yield[s.join("/"),i]:yield*j1(n,s)}}return[]}};function XO({repo:r}){async function*e(t={}){for await(const n of r.blocks.queryKeys({},{signal:t.signal}))yield{ref:n.toString()}}return x(e)}function JO({network:r}){async function e(t={}){const{bitswap:n}=await r.use(t),s=n.getWantlist();return Array.from(s).map(i=>i[1].cid)}return x(e)}function ZO({network:r}){async function e(t,n={}){const{bitswap:s}=await r.use(n),i=s.wantlistForPeer(t);return Array.from(i).map(o=>o[1].cid)}return x(e)}function eN({network:r}){async function e(t,n={}){const{bitswap:s}=await r.use(n);return Array.isArray(t)||(t=[t]),s.unwant(t)}return x(e)}function q8({network:r}){async function e(t={}){const n=(await r.use(t)).bitswap,s=n.stat().snapshot;return{provideBufLen:parseInt(s.providesBufferLength.toString()),blocksReceived:BigInt(s.blocksReceived.toString()),wantlist:Array.from(n.getWantlist()).map(i=>i[1].cid),peers:n.peers(),dupBlksReceived:BigInt(s.dupBlksReceived.toString()),dupDataReceived:BigInt(s.dupDataReceived.toString()),dataReceived:BigInt(s.dataReceived.toString()),blocksSent:BigInt(s.blocksSent.toString()),dataSent:BigInt(s.dataSent.toString())}}return x(e)}class tN{constructor({network:e}){this.wantlist=JO({network:e}),this.wantlistForPeer=ZO({network:e}),this.unwant=eN({network:e}),this.stat=q8({network:e})}}function G8(r){try{return CT.matches(r)}catch{return!1}}function rN({repo:r}){async function e(t,n={}){if(!G8(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await r.config.getAll(n),i=s.Bootstrap||[];return i.push(t.toString()),s.Bootstrap=Array.from(new Set(i)).sort((o,a)=>o.localeCompare(a)),await r.config.replace(s),{Peers:[t]}}return x(e)}function nN({repo:r}){async function e(t={}){const n=await r.config.getAll(t),s=n.Bootstrap||[];return n.Bootstrap=[],await r.config.replace(n),{Peers:s.map(i=>G(i))}}return x(e)}function sN({repo:r}){async function e(t={}){return{Peers:(await r.config.get("Bootstrap",t)||[]).map(s=>G(s))}}return x(e)}const oo=()=>({Addresses:{Swarm:[],Announce:[],NoAnnounce:[],API:"",Gateway:"",RPC:"",Delegates:["/dns4/node0.delegate.ipfs.io/tcp/443/https","/dns4/node1.delegate.ipfs.io/tcp/443/https","/dns4/node2.delegate.ipfs.io/tcp/443/https","/dns4/node3.delegate.ipfs.io/tcp/443/https"]},Discovery:{MDNS:{Enabled:!1,Interval:10},webRTCStar:{Enabled:!0}},Bootstrap:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"],Pubsub:{Enabled:!0},Swarm:{ConnMgr:{LowWater:5,HighWater:20},DisableNatPortMap:!0},Routing:{Type:"dhtclient"}});function iN({repo:r}){async function e(t={}){const n=await r.config.getAll(t);return n.Bootstrap=oo().Bootstrap,await r.config.replace(n),{Peers:oo().Bootstrap.map(s=>G(s))}}return x(e)}function oN({repo:r}){async function e(t,n={}){if(!G8(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await r.config.getAll(n);return s.Bootstrap=(s.Bootstrap||[]).filter(i=>i.toString()!==t.toString()),await r.config.replace(s),{Peers:[t]}}return x(e)}class aN{constructor({repo:e}){this.add=rN({repo:e}),this.list=sN({repo:e}),this.rm=oN({repo:e}),this.clear=nN({repo:e}),this.reset=iN({repo:e})}}function cN({preload:r,repo:e}){async function t(n,s={}){return s.preload!==!1&&r(n),e.blocks.get(n,s)}return x(t)}function lN({codecs:r,hashers:e,repo:t,preload:n}){async function s(i,o={}){const a=o.pin?await t.gcLock.readLock():null;try{const c=o.version!=null?o.version:0,h=o.format||(c===0?"dag-pb":"raw"),u=await(await e.getHasher(o.mhtype||"sha2-256")).digest(i),f=await r.getCodec(h),g=J.create(c,f.code,u);return await t.blocks.put(g,i,{signal:o.signal}),o.preload!==!1&&n(g),o.pin===!0&&await t.pins.pinRecursively(g,{signal:o.signal}),g}finally{a&&a()}}return x(s)}const qc=globalThis.CustomEvent??Event;async function*cd(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered==null?!1:e.ordered,s=new EventTarget,i=[];let o=We(),a=We(),c=!1,h,l=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const d of r){if(i.length===t&&(o=We(),await o.promise),l)break;const p={done:!1};i.push(p),d().then(w=>{p.done=!0,p.ok=!0,p.value=w,s.dispatchEvent(new qc("task-complete"))},w=>{p.done=!0,p.err=w,s.dispatchEvent(new qc("task-complete"))})}c=!0,s.dispatchEvent(new qc("task-complete"))}catch(d){h=d,s.dispatchEvent(new qc("task-complete"))}});function u(){return n?i[0]?.done:Boolean(i.find(d=>d.done))}function*f(){for(;i.length>0&&i[0].done;){const d=i[0];if(i.shift(),d.ok)yield d.value;else throw l=!0,o.resolve(),d.err;o.resolve()}}function*g(){for(;u();)for(let d=0;d<i.length;d++)if(i[d].done){const p=i[d];if(i.splice(d,1),d--,p.ok)yield p.value;else throw l=!0,o.resolve(),p.err;o.resolve()}}for(;;){if(u()||(a=We(),await a.promise),h!=null)throw h;if(n?yield*f():yield*g(),c&&i.length===0)break}}function W8(r){return r instanceof Uint8Array?J.decode(r):J.parse(r.toString())}const hN=8;function uN({repo:r}){async function*e(t,n={}){Array.isArray(t)||(t=[t]);const s=await r.gcLock.writeLock();try{yield*ie(t,i=>zt(i,o=>async()=>{o=W8(o);const a={cid:o};try{if(!await r.blocks.has(o))throw v(new Error("block not found"),"ERR_BLOCK_NOT_FOUND");await r.blocks.delete(o)}catch(c){n.force||(c.message=`cannot remove ${o}: ${c.message}`,a.error=c)}return a}),i=>cd(i,{concurrency:hN}),i=>$e(i,()=>!n.quiet))}finally{s()}}return x(e)}function dN({repo:r,preload:e}){async function t(n,s={}){n=W8(n),s.preload!==!1&&e(n);const i=await r.blocks.get(n);return{cid:n,size:i.length}}return x(t)}class fN{constructor({codecs:e,hashers:t,preload:n,repo:s}){this.get=cN({preload:n,repo:s}),this.put=lN({codecs:e,hashers:t,preload:n,repo:s}),this.rm=uN({repo:s}),this.stat=dN({preload:n,repo:s})}}async function*_i(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}function pN(r){return typeof r.stream=="function"?_i(r.stream()):_i(new Response(r).body)}function Ac(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function qs(r){return ArrayBuffer.isView(r)||r instanceof ArrayBuffer}function Ja(r){return r.constructor&&(r.constructor.name==="Blob"||r.constructor.name==="File")&&typeof r.stream=="function"}function H1(r){return typeof r=="object"&&(r.path||r.content)}const Za=r=>r&&typeof r.getReader=="function";async function*Gc(r){yield r}async function Y8(r){if(qs(r))return Gc(ef(r));if(typeof r=="string"||r instanceof String)return Gc(ef(r.toString()));if(Ja(r))return pN(r);if(Za(r)&&(r=_i(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const e=Ac(r),{value:t,done:n}=await e.peek();if(n)return Gc(new Uint8Array(0));if(e.push(t),Number.isInteger(t))return Gc(Uint8Array.from(await Kn(e)));if(qs(t)||typeof t=="string"||t instanceof String)return zt(e,ef)}throw v(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT")}function ef(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r instanceof ArrayBuffer?new Uint8Array(r):Array.isArray(r)?Uint8Array.from(r):L(r.toString())}async function*gN(r,e){if(r==null)throw v(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT");if(typeof r=="string"||r instanceof String){yield Wc(r.toString(),e);return}if(qs(r)||Ja(r)){yield Wc(r,e);return}if(Za(r)&&(r=_i(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const t=Ac(r),{value:n,done:s}=await t.peek();if(s){yield{content:[]};return}if(t.push(n),Number.isInteger(n)||qs(n)||typeof n=="string"||n instanceof String){yield Wc(t,e);return}throw v(new Error("Unexpected input: multiple items passed - if you are using ipfs.add, please use ipfs.addAll instead"),"ERR_UNEXPECTED_INPUT")}if(H1(r)){yield Wc(r,e);return}throw v(new Error('Unexpected input: cannot convert "'+typeof r+'" into ImportCandidate'),"ERR_UNEXPECTED_INPUT")}async function Wc(r,e){const{path:t,mode:n,mtime:s,content:i}=r,o={path:t||"",mode:io(n),mtime:Ya(s)};return i?o.content=await e(i):t||(o.content=await e(r)),o}function Q8(r){return gN(r,Y8)}function yN({addAll:r}){async function e(t,n={}){const s=await hr(r(Q8(t),n));if(s==null)throw Error("Failed to add a file, if you see this please report a bug");return s}return e}async function*Jp(r,e=1){let t=[];e<1&&(e=1);for await(const n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}async function*Zp(r,e=1){for await(const t of Jp(r,e)){const n=t.map(async s=>await s().then(i=>({ok:!0,value:i}),i=>({ok:!1,err:i})));for(let s=0;s<n.length;s++){const i=await n[s];if(i.ok)yield i.value;else throw i.err}}}const wN=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Ic=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var mN=X8,Q3=128,bN=127,EN=~bN,_N=Math.pow(2,31);function X8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=_N;)e[t++]=r&255|Q3,r/=128;for(;r&EN;)e[t++]=r&255|Q3,r>>>=7;return e[t]=r|0,X8.bytes=t-n+1,e}var vN=q1,SN=128,X3=127;function q1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw q1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&X3)<<s:(o&X3)*Math.pow(2,s),s+=7}while(o>=SN);return q1.bytes=i-n,t}var RN=Math.pow(2,7),AN=Math.pow(2,14),IN=Math.pow(2,21),CN=Math.pow(2,28),TN=Math.pow(2,35),kN=Math.pow(2,42),DN=Math.pow(2,49),PN=Math.pow(2,56),ON=Math.pow(2,63),NN=function(r){return r<RN?1:r<AN?2:r<IN?3:r<CN?4:r<TN?5:r<kN?6:r<DN?7:r<PN?8:r<ON?9:10},xN={encode:mN,decode:vN,encodingLength:NN},Dh=xN;const G1=(r,e=0)=>[Dh.decode(r,e),Dh.decode.bytes],Ph=(r,e,t=0)=>(Dh.encode(r,e,t),e),Oh=r=>Dh.encodingLength(r),W1=(r,e)=>{const t=e.byteLength,n=Oh(r),s=n+Oh(t),i=new Uint8Array(s+t);return Ph(r,i,0),Ph(t,i,n),i.set(e,s),new e2(r,t,e,i)},$N=r=>{const e=Ic(r),[t,n]=G1(e),[s,i]=G1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new e2(t,s,o,e)},LN=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&wN(r.bytes,t.bytes)}};let e2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const J8=({name:r,code:e,encode:t})=>new MN(r,e,t);let MN=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?W1(this.code,t):t.then(n=>W1(this.code,n))}else throw Error("Unknown type, must be binary type")}};const Z8=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Y1=J8({name:"sha2-256",code:18,encode:Z8("SHA-256")});J8({name:"sha2-512",code:19,encode:Z8("SHA-512")});const UN=new Uint8Array(0),eb=r=>{const e=r.match(/../g);return e?new Uint8Array(e.map(t=>parseInt(t,16))):UN},BN=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var zN=tb,J3=128,FN=127,VN=~FN,KN=Math.pow(2,31);function tb(r,e,t){e=e||[],t=t||0;for(var n=t;r>=KN;)e[t++]=r&255|J3,r/=128;for(;r&VN;)e[t++]=r&255|J3,r>>>=7;return e[t]=r|0,tb.bytes=t-n+1,e}var jN=Q1,HN=128,Z3=127;function Q1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Q1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Z3)<<s:(o&Z3)*Math.pow(2,s),s+=7}while(o>=HN);return Q1.bytes=i-n,t}var qN=Math.pow(2,7),GN=Math.pow(2,14),WN=Math.pow(2,21),YN=Math.pow(2,28),QN=Math.pow(2,35),XN=Math.pow(2,42),JN=Math.pow(2,49),ZN=Math.pow(2,56),ex=Math.pow(2,63),tx=function(r){return r<qN?1:r<GN?2:r<WN?3:r<YN?4:r<QN?5:r<XN?6:r<JN?7:r<ZN?8:r<ex?9:10},rx={encode:zN,decode:jN,encodingLength:tx},rb=rx;const ey=(r,e,t=0)=>(rb.encode(r,e,t),e),ty=r=>rb.encodingLength(r),ry=(r,e)=>{const t=e.byteLength,n=ty(r),s=n+ty(t),i=new Uint8Array(s+t);return ey(r,i,0),ey(t,i,n),i.set(e,s),new nx(r,t,e,i)};let nx=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const t2=({name:r,code:e,encode:t})=>new sx(r,e,t);let sx=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ry(this.code,t):t.then(n=>ry(this.code,n))}else throw Error("Unknown type, must be binary type")}};function ix(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var ox=ix,ax=ox;let cx=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},lx=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return nb(this,e)}},hx=class{constructor(e){this.decoders=e}or(e){return nb(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const nb=(r,e)=>new hx({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let ux=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new cx(e,t,n),this.decoder=new lx(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const sb=({name:r,prefix:e,encode:t,decode:n})=>new ux(r,e,t,n),ib=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=ax(t,e);return sb({prefix:r,name:e,encode:n,decode:i=>BN(s(i))})},dx=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},fx=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},jn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>sb({prefix:e,name:r,encode(s){return fx(s,n,t)},decode(s){return dx(s,n,t,r)}});ib({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});ib({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});jn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});jn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});jn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});jn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});jn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});jn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});jn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});jn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});jn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var X1={},px={get exports(){return X1},set exports(r){X1=r}},Nh={},gx={get exports(){return Nh},set exports(r){Nh=r}};(function(r,e){(function(t,n){var s={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(p){if(!Array.isArray(p)&&!ArrayBuffer.isView(p))return!1;for(var w=0;w<p.length;w++)if(!Number.isInteger(p[w])||p[w]<0||p[w]>255)return!1;return!0}function o(p,w){return(p&65535)*w+(((p>>>16)*w&65535)<<16)}function a(p,w){return p<<w|p>>>32-w}function c(p){return p^=p>>>16,p=o(p,2246822507),p^=p>>>13,p=o(p,3266489909),p^=p>>>16,p}function h(p,w){p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var y=[0,0,0,0];return y[3]+=p[3]+w[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=p[2]+w[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=p[1]+w[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=p[0]+w[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function l(p,w){p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var y=[0,0,0,0];return y[3]+=p[3]*w[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=p[2]*w[3],y[1]+=y[2]>>>16,y[2]&=65535,y[2]+=p[3]*w[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=p[1]*w[3],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=p[2]*w[2],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=p[3]*w[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=p[0]*w[3]+p[1]*w[2]+p[2]*w[1]+p[3]*w[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function u(p,w){return w%=64,w===32?[p[1],p[0]]:w<32?[p[0]<<w|p[1]>>>32-w,p[1]<<w|p[0]>>>32-w]:(w-=32,[p[1]<<w|p[0]>>>32-w,p[0]<<w|p[1]>>>32-w])}function f(p,w){return w%=64,w===0?p:w<32?[p[0]<<w|p[1]>>>32-w,p[1]<<w]:[p[1]<<w-32,0]}function g(p,w){return[p[0]^w[0],p[1]^w[1]]}function d(p){return p=g(p,[0,p[0]>>>1]),p=l(p,[4283543511,3981806797]),p=g(p,[0,p[0]>>>1]),p=l(p,[3301882366,444984403]),p=g(p,[0,p[0]>>>1]),p}s.x86.hash32=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%4,_=p.length-y,m=w,b=0,S=3432918353,A=461845907,E=0;E<_;E=E+4)b=p[E]|p[E+1]<<8|p[E+2]<<16|p[E+3]<<24,b=o(b,S),b=a(b,15),b=o(b,A),m^=b,m=a(m,13),m=o(m,5)+3864292196;switch(b=0,y){case 3:b^=p[E+2]<<16;case 2:b^=p[E+1]<<8;case 1:b^=p[E],b=o(b,S),b=a(b,15),b=o(b,A),m^=b}return m^=p.length,m=c(m),m>>>0},s.x86.hash128=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%16,_=p.length-y,m=w,b=w,S=w,A=w,E=0,I=0,C=0,D=0,$=597399067,K=2869860233,W=951274213,Q=2716044179,V=0;V<_;V=V+16)E=p[V]|p[V+1]<<8|p[V+2]<<16|p[V+3]<<24,I=p[V+4]|p[V+5]<<8|p[V+6]<<16|p[V+7]<<24,C=p[V+8]|p[V+9]<<8|p[V+10]<<16|p[V+11]<<24,D=p[V+12]|p[V+13]<<8|p[V+14]<<16|p[V+15]<<24,E=o(E,$),E=a(E,15),E=o(E,K),m^=E,m=a(m,19),m+=b,m=o(m,5)+1444728091,I=o(I,K),I=a(I,16),I=o(I,W),b^=I,b=a(b,17),b+=S,b=o(b,5)+197830471,C=o(C,W),C=a(C,17),C=o(C,Q),S^=C,S=a(S,15),S+=A,S=o(S,5)+2530024501,D=o(D,Q),D=a(D,18),D=o(D,$),A^=D,A=a(A,13),A+=m,A=o(A,5)+850148119;switch(E=0,I=0,C=0,D=0,y){case 15:D^=p[V+14]<<16;case 14:D^=p[V+13]<<8;case 13:D^=p[V+12],D=o(D,Q),D=a(D,18),D=o(D,$),A^=D;case 12:C^=p[V+11]<<24;case 11:C^=p[V+10]<<16;case 10:C^=p[V+9]<<8;case 9:C^=p[V+8],C=o(C,W),C=a(C,17),C=o(C,Q),S^=C;case 8:I^=p[V+7]<<24;case 7:I^=p[V+6]<<16;case 6:I^=p[V+5]<<8;case 5:I^=p[V+4],I=o(I,K),I=a(I,16),I=o(I,W),b^=I;case 4:E^=p[V+3]<<24;case 3:E^=p[V+2]<<16;case 2:E^=p[V+1]<<8;case 1:E^=p[V],E=o(E,$),E=a(E,15),E=o(E,K),m^=E}return m^=p.length,b^=p.length,S^=p.length,A^=p.length,m+=b,m+=S,m+=A,b+=m,S+=m,A+=m,m=c(m),b=c(b),S=c(S),A=c(A),m+=b,m+=S,m+=A,b+=m,S+=m,A+=m,("00000000"+(m>>>0).toString(16)).slice(-8)+("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(S>>>0).toString(16)).slice(-8)+("00000000"+(A>>>0).toString(16)).slice(-8)},s.x64.hash128=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%16,_=p.length-y,m=[0,w],b=[0,w],S=[0,0],A=[0,0],E=[2277735313,289559509],I=[1291169091,658871167],C=0;C<_;C=C+16)S=[p[C+4]|p[C+5]<<8|p[C+6]<<16|p[C+7]<<24,p[C]|p[C+1]<<8|p[C+2]<<16|p[C+3]<<24],A=[p[C+12]|p[C+13]<<8|p[C+14]<<16|p[C+15]<<24,p[C+8]|p[C+9]<<8|p[C+10]<<16|p[C+11]<<24],S=l(S,E),S=u(S,31),S=l(S,I),m=g(m,S),m=u(m,27),m=h(m,b),m=h(l(m,[0,5]),[0,1390208809]),A=l(A,I),A=u(A,33),A=l(A,E),b=g(b,A),b=u(b,31),b=h(b,m),b=h(l(b,[0,5]),[0,944331445]);switch(S=[0,0],A=[0,0],y){case 15:A=g(A,f([0,p[C+14]],48));case 14:A=g(A,f([0,p[C+13]],40));case 13:A=g(A,f([0,p[C+12]],32));case 12:A=g(A,f([0,p[C+11]],24));case 11:A=g(A,f([0,p[C+10]],16));case 10:A=g(A,f([0,p[C+9]],8));case 9:A=g(A,[0,p[C+8]]),A=l(A,I),A=u(A,33),A=l(A,E),b=g(b,A);case 8:S=g(S,f([0,p[C+7]],56));case 7:S=g(S,f([0,p[C+6]],48));case 6:S=g(S,f([0,p[C+5]],40));case 5:S=g(S,f([0,p[C+4]],32));case 4:S=g(S,f([0,p[C+3]],24));case 3:S=g(S,f([0,p[C+2]],16));case 2:S=g(S,f([0,p[C+1]],8));case 1:S=g(S,[0,p[C]]),S=l(S,E),S=u(S,31),S=l(S,I),m=g(m,S)}return m=g(m,[0,p.length]),b=g(b,[0,p.length]),m=h(m,b),b=h(b,m),m=d(m),b=d(b),m=h(m,b),b=h(b,m),("00000000"+(m[0]>>>0).toString(16)).slice(-8)+("00000000"+(m[1]>>>0).toString(16)).slice(-8)+("00000000"+(b[0]>>>0).toString(16)).slice(-8)+("00000000"+(b[1]>>>0).toString(16)).slice(-8)},r.exports&&(e=r.exports=s),e.murmurHash3=s})()})(gx,Nh);(function(r){r.exports=Nh})(px);const r2=Wu(X1);function yx(r){const e=new Array(4);for(let t=0;t<4;t++)e[t]=r&255,r=r>>8;return new Uint8Array(e)}t2({name:"murmur3-32",code:35,encode:r=>yx(r2.x86.hash32(r))});const ld=t2({name:"murmur3-128",code:34,encode:r=>eb(r2.x64.hash128(r))});t2({name:"murmur3-x64-64",code:34,encode:r=>eb(r2.x64.hash128(r)).subarray(0,8)});async function wx(r){return(await ld.encode(r)).slice(0,8).reverse()}const mx={chunker:"fixed",strategy:"balanced",rawLeaves:!1,onlyHash:!1,reduceSingleLeafToSelf:!0,hasher:Y1,leafType:"file",cidVersion:0,progress:()=>()=>{},shardSplitThreshold:1e3,fileImportConcurrency:50,blockWriteConcurrency:10,minChunkSize:262144,maxChunkSize:262144,avgChunkSize:262144,window:16,polynomial:0x3df305dfb2a804,maxChildrenPerNode:174,layerRepeat:4,wrapWithDirectory:!1,recursive:!1,hidden:!1,timeout:void 0,hamtHashFn:wx,hamtHashCode:34,hamtBucketBits:8},bx=(r={})=>Ue.bind({ignoreUndefined:!0})(mx,r);function Ex(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var _x=Ex,vx=_x;let Sx=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Rx=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return ob(this,e)}},Ax=class{constructor(e){this.decoders=e}or(e){return ob(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const ob=(r,e)=>new Ax({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Ix=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Sx(e,t,n),this.decoder=new Rx(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const ab=({name:r,prefix:e,encode:t,decode:n})=>new Ix(r,e,t,n),cb=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=vx(t,e);return ab({prefix:r,name:e,encode:n,decode:i=>Ic(s(i))})},Cx=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Tx=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Hn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>ab({prefix:e,name:r,encode(s){return Tx(s,n,t)},decode(s){return Cx(s,n,t,r)}}),ws=cb({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});cb({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Ul=Hn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Hn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Hn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Hn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Hn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Hn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Hn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Hn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Hn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const ny=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Px(t,J1(r),e||ws.encoder);default:return Ox(t,J1(r),e||Ul.encoder)}},sy=new WeakMap,J1=r=>{const e=sy.get(r);if(e==null){const t=new Map;return sy.set(r,t),t}return e};let kx=class At{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Xo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Nx)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return At.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=W1(e,t);return At.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return At.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&LN(e.multihash,n.multihash)}toString(e){return ny(this,e)}toJSON(){return{"/":ny(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof At)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new At(n,s,i,o||iy(n,s,i.bytes))}else if(t[xx]===!0){const{version:n,multihash:s,code:i}=t,o=$N(s);return At.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Xo)throw new Error(`Version 0 CID must use dag-pb (code: ${Xo}) block encoding`);return new At(e,t,n,n.bytes)}case 1:{const s=iy(e,t,n.bytes);return new At(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return At.create(0,Xo,e)}static createV1(e,t){return At.create(1,e,t)}static decode(e){const[t,n]=At.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=At.inspectBytes(e),n=t.size-t.multihashSize,s=Ic(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new e2(t.multihashCode,t.digestSize,i,s);return[t.version===0?At.createV0(o):At.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=G1(e.subarray(t));return t+=f,u};let s=n(),i=Xo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=Dx(e,t),i=At.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return J1(i).set(n,e),i}};const Dx=(r,e)=>{switch(r[0]){case"Q":{const t=e||ws;return[ws.prefix,t.decode(`${ws.prefix}${r}`)]}case ws.prefix:{const t=e||ws;return[ws.prefix,t.decode(r)]}case Ul.prefix:{const t=e||Ul;return[Ul.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Px=(r,e,t)=>{const{prefix:n}=t;if(n!==ws.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Ox=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Xo=112,Nx=18,iy=(r,e,t)=>{const n=Oh(r),s=n+Oh(e),i=new Uint8Array(s+t.byteLength);return Ph(r,i,0),Ph(e,i,n),i.set(t,s),i},xx=Symbol.for("@ipld/js-cid/CID"),wo=async(r,e,t)=>{t.codec||(t.codec=Ks),t.hasher||(t.hasher=Y1),t.cidVersion===void 0&&(t.cidVersion=1),t.codec===Ks&&t.hasher!==Y1&&(t.cidVersion=1);const n=await t.hasher.digest(r),s=kx.create(t.cidVersion,t.codec.code,n);return t.onlyHash||await e.put(s,r,{signal:t.signal}),s},$x=async(r,e,t)=>{const n=new Pe({type:"directory",mtime:r.mtime,mode:r.mode}),s=De(js({Data:n.marshal()})),i=await wo(s,e,t),o=r.path;return{cid:i,path:o,unixfs:n,size:s.length}},Lx="raw",Z1=85,Mx=r=>Ic(r),Ux=r=>Ic(r),Bx=Object.freeze(Object.defineProperty({__proto__:null,code:Z1,decode:Ux,encode:Mx,name:Lx},Symbol.toStringTag,{value:"Module"}));async function zx(r,e){return e(await Kn(r))}function Fx(r,e,t){return lb(r,e,t)}async function lb(r,e,t){const n=[];for await(const s of Jp(r,t.maxChildrenPerNode))n.push(await e(s));return n.length>1?lb(n,e,t):n[0]}async function Vx(r,e,t){const n=new Kx(t.layerRepeat);let s=0,i=1,o=n;for await(const a of Jp(r,t.maxChildrenPerNode))o.isFull()&&(o!==n&&n.addChild(await o.reduce(e)),s&&s%t.layerRepeat===0&&i++,o=new hb(i,t.layerRepeat,s),s++),o.append(a);return o&&o!==n&&n.addChild(await o.reduce(e)),n.reduce(e)}class hb{constructor(e,t,n=0){this.maxDepth=e,this.layerRepeat=t,this.currentDepth=1,this.iteration=n,this.root=this.node=this.parent={children:[],depth:this.currentDepth,maxDepth:e,maxChildren:(this.maxDepth-this.currentDepth)*this.layerRepeat}}isFull(){if(!this.root.data)return!1;if(this.currentDepth<this.maxDepth&&this.node.maxChildren)return this._addNextNodeToParent(this.node),!1;const e=this._findParent(this.node,this.currentDepth);return e?(this._addNextNodeToParent(e),!1):!0}_addNextNodeToParent(e){this.parent=e;const t={children:[],depth:e.depth+1,parent:e,maxDepth:this.maxDepth,maxChildren:Math.floor(e.children.length/this.layerRepeat)*this.layerRepeat};e.children.push(t),this.currentDepth=t.depth,this.node=t}append(e){this.node.data=e}reduce(e){return this._reduce(this.root,e)}async _reduce(e,t){let n=[];return e.children.length&&(n=await Promise.all(e.children.filter(s=>s.data).map(s=>this._reduce(s,t)))),t((e.data||[]).concat(n))}_findParent(e,t){const n=e.parent;if(!(!n||n.depth===0))return n.children.length===n.maxChildren||!n.maxChildren?this._findParent(n,t):n}}class Kx extends hb{constructor(e){super(0,e),this.root.depth=0,this.currentDepth=1}addChild(e){this.root.children.push(e)}reduce(e){return e((this.root.data||[]).concat(this.root.children))}}async function*jx(r,e,t){for await(let n of r.content)yield async()=>{t.progress(n.length,r.path);let s;const i={codec:Ks,cidVersion:t.cidVersion,hasher:t.hasher,onlyHash:t.onlyHash};return t.rawLeaves?(i.codec=Bx,i.cidVersion=1):(s=new Pe({type:t.leafType,data:n}),n=De({Data:s.marshal(),Links:[]})),{cid:await wo(n,e,i),unixfs:s,size:n.length}}}const Hx={flat:zx,balanced:Fx,trickle:Vx};async function*qx(r,e,t){let n=-1,s,i;typeof t.bufferImporter=="function"?i=t.bufferImporter:i=jx;for await(const o of Zp(i(r,e,t),t.blockWriteConcurrency)){if(n++,n===0){s=o;continue}else n===1&&s&&(yield s,s=null);yield o}s&&(s.single=!0,yield s)}const Gx=(r,e,t)=>{async function n(s){if(s.length===1&&s[0].single&&t.reduceSingleLeafToSelf){const l=s[0];if(r.mtime!==void 0||r.mode!==void 0){let u=await e.get(l.cid);l.unixfs=new Pe({type:"file",mtime:r.mtime,mode:r.mode,data:u}),u=De(js({Data:l.unixfs.marshal()})),l.cid=await wo(u,e,{...t,codec:Ks,hasher:t.hasher,cidVersion:t.cidVersion}),l.size=u.length}return{cid:l.cid,path:r.path,unixfs:l.unixfs,size:l.size}}const i=new Pe({type:"file",mtime:r.mtime,mode:r.mode}),o=s.filter(l=>l.cid.code===Z1&&l.size||l.unixfs&&!l.unixfs.data&&l.unixfs.fileSize()?!0:Boolean(l.unixfs&&l.unixfs.data&&l.unixfs.data.length)).map(l=>l.cid.code===Z1?(i.addBlockSize(l.size),{Name:"",Tsize:l.size,Hash:l.cid}):(!l.unixfs||!l.unixfs.data?i.addBlockSize(l.unixfs&&l.unixfs.fileSize()||0):i.addBlockSize(l.unixfs.data.length),{Name:"",Tsize:l.size,Hash:l.cid})),a={Data:i.marshal(),Links:o},c=De(js(a));return{cid:await wo(c,e,t),path:r.path,unixfs:i,size:c.length+a.Links.reduce((l,u)=>l+u.Tsize,0)}}return n};function Wx(r,e,t){const n=Hx[t.strategy];if(!n)throw v(new Error(`Unknown importer build strategy name: ${t.strategy}`),"ERR_BAD_STRATEGY");return n(qx(r,e,t),Gx(r,e,t),t)}let Yx=class{constructor(e,t=12,n=8*1024,s=32*1024,i=64,o){this.bits=t,this.min=n,this.max=s,this.asModule=e,this.rabin=new e.Rabin(t,n,s,i,o),this.polynomial=o}fingerprint(e){const{__retain:t,__release:n,__allocArray:s,__getInt32Array:i,Int32Array_ID:o,Uint8Array_ID:a}=this.asModule,c=new Int32Array(Math.ceil(e.length/this.min)),h=t(s(o,c)),l=t(s(a,e)),u=this.rabin.fingerprint(l,h),f=i(u);n(l),n(h);const g=f.indexOf(0);return g>=0?f.subarray(0,g):f}};var Qx=Yx,Cc={};const tf=-8,Bl=-4,Xx=0,oy=1,ay=1<<0,Yc=1<<1,Jx=5,cy=1<<10,ly=1<<11,Zx=1<<13,e$=0,rf=4,t$=8,r$=12,hy=12,n$=16,s$=typeof BigUint64Array<"u",Jo=Symbol(),Zo=1024;function ub(r,e){const t=new Uint32Array(r),n=new Uint16Array(r);var s=t[e+Bl>>>2]>>>1,i=e>>>1;if(s<=Zo)return String.fromCharCode.apply(String,n.subarray(i,i+s));const o=[];do{const a=n[i+Zo-1],c=a>=55296&&a<56320?Zo-1:Zo;o.push(String.fromCharCode.apply(String,n.subarray(i,i+=c))),s-=c}while(s>Zo);return o.join("")+String.fromCharCode.apply(String,n.subarray(i,i+s))}function n2(r){const e={};function t(s,i){return s?ub(s.buffer,i):"<yet unknown>"}const n=r.env=r.env||{};return n.abort=n.abort||function(i,o,a,c){const h=e.memory||n.memory;throw Error("abort: "+t(h,i)+" at "+t(h,o)+":"+a+":"+c)},n.trace=n.trace||function(i,o){const a=e.memory||n.memory;console.log("trace: "+t(a,i)+(o?" ":"")+Array.prototype.slice.call(arguments,2,2+o).join(", "))},r.Math=r.Math||Math,r.Date=r.Date||Date,e}function s2(r,e){const t=e.exports,n=t.memory,s=t.table,i=t.__alloc,o=t.__retain,a=t.__rtti_base||-1;function c(S){const A=new Uint32Array(n.buffer),E=A[a>>>2];if((S>>>=0)>=E)throw Error("invalid id: "+S);return A[(a+4>>>2)+S*2]}function h(S){const A=new Uint32Array(n.buffer),E=A[a>>>2];if((S>>>=0)>=E)throw Error("invalid id: "+S);return A[(a+4>>>2)+S*2+1]}function l(S){return 31-Math.clz32(S>>>Jx&31)}function u(S){const A=S.length,E=i(A<<1,oy),I=new Uint16Array(n.buffer);for(var C=0,D=E>>>1;C<A;++C)I[D+C]=S.charCodeAt(C);return E}r.__allocString=u;function f(S){const A=n.buffer;if(new Uint32Array(A)[S+tf>>>2]!==oy)throw Error("not a string: "+S);return ub(A,S)}r.__getString=f;function g(S,A,E){const I=n.buffer;if(E)switch(S){case 2:return new Float32Array(I);case 3:return new Float64Array(I)}else switch(S){case 0:return new(A?Int8Array:Uint8Array)(I);case 1:return new(A?Int16Array:Uint16Array)(I);case 2:return new(A?Int32Array:Uint32Array)(I);case 3:return new(A?BigInt64Array:BigUint64Array)(I)}throw Error("unsupported align: "+S)}function d(S,A){const E=c(S);if(!(E&(ay|Yc)))throw Error("not an array: "+S+" @ "+E);const I=l(E),C=A.length,D=i(C<<I,Xx),$=i(E&Yc?n$:r$,S),K=new Uint32Array(n.buffer);K[$+e$>>>2]=o(D),K[$+rf>>>2]=D,K[$+t$>>>2]=C<<I,E&Yc&&(K[$+hy>>>2]=C);const W=g(I,E&cy,E&ly);if(E&Zx)for(let Q=0;Q<C;++Q)W[(D>>>I)+Q]=o(A[Q]);else W.set(A,D>>>I);return $}r.__allocArray=d;function p(S){const A=new Uint32Array(n.buffer),E=A[S+tf>>>2],I=c(E);if(!(I&ay))throw Error("not an array: "+E);const C=l(I);var D=A[S+rf>>>2];const $=I&Yc?A[S+hy>>>2]:A[D+Bl>>>2]>>>C;return g(C,I&cy,I&ly).subarray(D>>>=C,D+$)}r.__getArrayView=p;function w(S){const A=p(S),E=A.length,I=new Array(E);for(let C=0;C<E;C++)I[C]=A[C];return I}r.__getArray=w;function y(S){const A=n.buffer,E=new Uint32Array(A)[S+Bl>>>2];return A.slice(S,S+E)}r.__getArrayBuffer=y;function _(S,A,E){return new S(m(S,A,E))}function m(S,A,E){const I=n.buffer,C=new Uint32Array(I),D=C[E+rf>>>2];return new S(I,D,C[D+Bl>>>2]>>>A)}r.__getInt8Array=_.bind(null,Int8Array,0),r.__getInt8ArrayView=m.bind(null,Int8Array,0),r.__getUint8Array=_.bind(null,Uint8Array,0),r.__getUint8ArrayView=m.bind(null,Uint8Array,0),r.__getUint8ClampedArray=_.bind(null,Uint8ClampedArray,0),r.__getUint8ClampedArrayView=m.bind(null,Uint8ClampedArray,0),r.__getInt16Array=_.bind(null,Int16Array,1),r.__getInt16ArrayView=m.bind(null,Int16Array,1),r.__getUint16Array=_.bind(null,Uint16Array,1),r.__getUint16ArrayView=m.bind(null,Uint16Array,1),r.__getInt32Array=_.bind(null,Int32Array,2),r.__getInt32ArrayView=m.bind(null,Int32Array,2),r.__getUint32Array=_.bind(null,Uint32Array,2),r.__getUint32ArrayView=m.bind(null,Uint32Array,2),s$&&(r.__getInt64Array=_.bind(null,BigInt64Array,3),r.__getInt64ArrayView=m.bind(null,BigInt64Array,3),r.__getUint64Array=_.bind(null,BigUint64Array,3),r.__getUint64ArrayView=m.bind(null,BigUint64Array,3)),r.__getFloat32Array=_.bind(null,Float32Array,2),r.__getFloat32ArrayView=m.bind(null,Float32Array,2),r.__getFloat64Array=_.bind(null,Float64Array,3),r.__getFloat64ArrayView=m.bind(null,Float64Array,3);function b(S,A){const E=new Uint32Array(n.buffer);var I=E[S+tf>>>2];if(I<=E[a>>>2])do if(I==A)return!0;while(I=h(I));return!1}return r.__instanceof=b,r.memory=r.memory||n,r.table=r.table||s,gb(t,r)}function db(r){return typeof Response<"u"&&r instanceof Response}async function fb(r,e){return db(r=await r)?pb(r,e):s2(n2(e||(e={})),await WebAssembly.instantiate(r instanceof WebAssembly.Module?r:await WebAssembly.compile(r),e))}Cc.instantiate=fb;function i$(r,e){return s2(n2(e||(e={})),new WebAssembly.Instance(r instanceof WebAssembly.Module?r:new WebAssembly.Module(r),e))}Cc.instantiateSync=i$;async function pb(r,e){return WebAssembly.instantiateStreaming?s2(n2(e||(e={})),(await WebAssembly.instantiateStreaming(r,e)).instance):fb(db(r=await r)?r.arrayBuffer():r,e)}Cc.instantiateStreaming=pb;function gb(r,e){var t=e?Object.create(e):{},n=r.__argumentsLength?function(s){r.__argumentsLength.value=s}:r.__setArgumentsLength||r.__setargc||function(){};for(let s in r){if(!Object.prototype.hasOwnProperty.call(r,s))continue;const i=r[s];let o=s.split("."),a=t;for(;o.length>1;){let l=o.shift();Object.prototype.hasOwnProperty.call(a,l)||(a[l]={}),a=a[l]}let c=o[0],h=c.indexOf("#");if(h>=0){let l=c.substring(0,h),u=a[l];if(typeof u>"u"||!u.prototype){let f=function(...g){return f.wrap(f.prototype.constructor(0,...g))};f.prototype={valueOf:function(){return this[Jo]}},f.wrap=function(g){return Object.create(f.prototype,{[Jo]:{value:g,writable:!1}})},u&&Object.getOwnPropertyNames(u).forEach(g=>Object.defineProperty(f,g,Object.getOwnPropertyDescriptor(u,g))),a[l]=f}if(c=c.substring(h+1),a=a[l].prototype,/^(get|set):/.test(c)){if(!Object.prototype.hasOwnProperty.call(a,c=c.substring(4))){let f=r[s.replace("set:","get:")],g=r[s.replace("get:","set:")];Object.defineProperty(a,c,{get:function(){return f(this[Jo])},set:function(d){g(this[Jo],d)},enumerable:!0})}}else c==="constructor"?(a[c]=(...f)=>(n(f.length),i(...f))).original=i:(a[c]=function(...f){return n(f.length),i(this[Jo],...f)}).original=i}else/^(get|set):/.test(c)?Object.prototype.hasOwnProperty.call(a,c=c.substring(4))||Object.defineProperty(a,c,{get:r[s.replace("set:","get:")],set:r[s.replace("get:","set:")],enumerable:!0}):typeof i=="function"&&i!==n?(a[c]=(...l)=>(n(l.length),i(...l))).original=i:a[c]=i}return t}Cc.demangle=gb;const{instantiate:o$}=Cc;i2.supported=typeof WebAssembly<"u";function i2(r={}){if(!i2.supported)return null;var e=new Uint8Array([0,97,115,109,1,0,0,0,1,78,14,96,2,127,126,0,96,1,127,1,126,96,2,127,127,0,96,1,127,1,127,96,1,127,0,96,2,127,127,1,127,96,3,127,127,127,1,127,96,0,0,96,3,127,127,127,0,96,0,1,127,96,4,127,127,127,127,0,96,5,127,127,127,127,127,1,127,96,1,126,1,127,96,2,126,126,1,126,2,13,1,3,101,110,118,5,97,98,111,114,116,0,10,3,54,53,2,2,8,9,3,5,2,8,6,5,3,4,2,6,9,12,13,2,5,11,3,2,3,2,3,2,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,6,7,7,4,4,5,3,1,0,1,6,47,9,127,1,65,0,11,127,1,65,0,11,127,0,65,3,11,127,0,65,4,11,127,1,65,0,11,127,1,65,0,11,127,1,65,0,11,127,0,65,240,2,11,127,0,65,6,11,7,240,5,41,6,109,101,109,111,114,121,2,0,7,95,95,97,108,108,111,99,0,10,8,95,95,114,101,116,97,105,110,0,11,9,95,95,114,101,108,101,97,115,101,0,12,9,95,95,99,111,108,108,101,99,116,0,51,11,95,95,114,116,116,105,95,98,97,115,101,3,7,13,73,110,116,51,50,65,114,114,97,121,95,73,68,3,2,13,85,105,110,116,56,65,114,114,97,121,95,73,68,3,3,6,100,101,103,114,101,101,0,16,3,109,111,100,0,17,5,82,97,98,105,110,3,8,16,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,0,21,16,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,0,22,21,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,23,21,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,24,14,82,97,98,105,110,35,103,101,116,58,119,112,111,115,0,25,14,82,97,98,105,110,35,115,101,116,58,119,112,111,115,0,26,15,82,97,98,105,110,35,103,101,116,58,99,111,117,110,116,0,27,15,82,97,98,105,110,35,115,101,116,58,99,111,117,110,116,0,28,13,82,97,98,105,110,35,103,101,116,58,112,111,115,0,29,13,82,97,98,105,110,35,115,101,116,58,112,111,115,0,30,15,82,97,98,105,110,35,103,101,116,58,115,116,97,114,116,0,31,15,82,97,98,105,110,35,115,101,116,58,115,116,97,114,116,0,32,16,82,97,98,105,110,35,103,101,116,58,100,105,103,101,115,116,0,33,16,82,97,98,105,110,35,115,101,116,58,100,105,103,101,115,116,0,34,21,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,35,21,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,36,22,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,37,22,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,38,31,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,39,31,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,40,20,82,97,98,105,110,35,103,101,116,58,112,111,108,121,110,111,109,105,97,108,0,41,20,82,97,98,105,110,35,115,101,116,58,112,111,108,121,110,111,109,105,97,108,0,42,17,82,97,98,105,110,35,103,101,116,58,109,105,110,115,105,122,101,0,43,17,82,97,98,105,110,35,115,101,116,58,109,105,110,115,105,122,101,0,44,17,82,97,98,105,110,35,103,101,116,58,109,97,120,115,105,122,101,0,45,17,82,97,98,105,110,35,115,101,116,58,109,97,120,115,105,122,101,0,46,14,82,97,98,105,110,35,103,101,116,58,109,97,115,107,0,47,14,82,97,98,105,110,35,115,101,116,58,109,97,115,107,0,48,17,82,97,98,105,110,35,99,111,110,115,116,114,117,99,116,111,114,0,20,17,82,97,98,105,110,35,102,105,110,103,101,114,112,114,105,110,116,0,49,8,1,50,10,165,31,53,199,1,1,4,127,32,1,40,2,0,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,3,65,4,107,118,65,16,115,33,4,32,3,65,7,107,11,33,3,32,1,40,2,20,33,2,32,1,40,2,16,34,5,4,64,32,5,32,2,54,2,20,11,32,2,4,64,32,2,32,5,54,2,16,11,32,1,32,0,32,4,32,3,65,4,116,106,65,2,116,106,40,2,96,70,4,64,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,2,54,2,96,32,2,69,4,64,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,65,127,115,113,34,1,54,2,4,32,1,69,4,64,32,0,32,0,40,2,0,65,1,32,3,116,65,127,115,113,54,2,0,11,11,11,11,226,2,1,6,127,32,1,40,2,0,33,3,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,34,5,65,1,113,4,64,32,3,65,124,113,65,16,106,32,5,65,124,113,106,34,2,65,240,255,255,255,3,73,4,64,32,0,32,4,16,1,32,1,32,2,32,3,65,3,113,114,34,3,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,33,5,11,11,32,3,65,2,113,4,64,32,1,65,4,107,40,2,0,34,2,40,2,0,34,6,65,124,113,65,16,106,32,3,65,124,113,106,34,7,65,240,255,255,255,3,73,4,64,32,0,32,2,16,1,32,2,32,7,32,6,65,3,113,114,34,3,54,2,0,32,2,33,1,11,11,32,4,32,5,65,2,114,54,2,0,32,4,65,4,107,32,1,54,2,0,32,0,32,3,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,2,65,4,107,118,65,16,115,33,4,32,2,65,7,107,11,34,3,65,4,116,32,4,106,65,2,116,106,40,2,96,33,2,32,1,65,0,54,2,16,32,1,32,2,54,2,20,32,2,4,64,32,2,32,1,54,2,16,11,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,1,54,2,96,32,0,32,0,40,2,0,65,1,32,3,116,114,54,2,0,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,114,54,2,4,11,119,1,1,127,32,2,2,127,32,0,40,2,160,12,34,2,4,64,32,2,32,1,65,16,107,70,4,64,32,2,40,2,0,33,3,32,1,65,16,107,33,1,11,11,32,1,11,107,34,2,65,48,73,4,64,15,11,32,1,32,3,65,2,113,32,2,65,32,107,65,1,114,114,54,2,0,32,1,65,0,54,2,16,32,1,65,0,54,2,20,32,1,32,2,106,65,16,107,34,2,65,2,54,2,0,32,0,32,2,54,2,160,12,32,0,32,1,16,2,11,155,1,1,3,127,35,0,34,0,69,4,64,65,1,63,0,34,0,74,4,127,65,1,32,0,107,64,0,65,0,72,5,65,0,11,4,64,0,11,65,176,3,34,0,65,0,54,2,0,65,208,15,65,0,54,2,0,3,64,32,1,65,23,73,4,64,32,1,65,2,116,65,176,3,106,65,0,54,2,4,65,0,33,2,3,64,32,2,65,16,73,4,64,32,1,65,4,116,32,2,106,65,2,116,65,176,3,106,65,0,54,2,96,32,2,65,1,106,33,2,12,1,11,11,32,1,65,1,106,33,1,12,1,11,11,65,176,3,65,224,15,63,0,65,16,116,16,3,65,176,3,36,0,11,32,0,11,45,0,32,0,65,240,255,255,255,3,79,4,64,65,32,65,224,0,65,201,3,65,29,16,0,0,11,32,0,65,15,106,65,112,113,34,0,65,16,32,0,65,16,75,27,11,169,1,1,1,127,32,0,32,1,65,128,2,73,4,127,32,1,65,4,118,33,1,65,0,5,32,1,65,248,255,255,255,1,73,4,64,32,1,65,1,65,27,32,1,103,107,116,106,65,1,107,33,1,11,32,1,65,31,32,1,103,107,34,2,65,4,107,118,65,16,115,33,1,32,2,65,7,107,11,34,2,65,2,116,106,40,2,4,65,127,32,1,116,113,34,1,4,127,32,0,32,1,104,32,2,65,4,116,106,65,2,116,106,40,2,96,5,32,0,40,2,0,65,127,32,2,65,1,106,116,113,34,1,4,127,32,0,32,0,32,1,104,34,0,65,2,116,106,40,2,4,104,32,0,65,4,116,106,65,2,116,106,40,2,96,5,65,0,11,11,11,111,1,1,127,63,0,34,2,32,1,65,248,255,255,255,1,73,4,127,32,1,65,1,65,27,32,1,103,107,116,65,1,107,106,5,32,1,11,65,16,32,0,40,2,160,12,32,2,65,16,116,65,16,107,71,116,106,65,255,255,3,106,65,128,128,124,113,65,16,118,34,1,32,2,32,1,74,27,64,0,65,0,72,4,64,32,1,64,0,65,0,72,4,64,0,11,11,32,0,32,2,65,16,116,63,0,65,16,116,16,3,11,113,1,2,127,32,1,40,2,0,34,3,65,124,113,32,2,107,34,4,65,32,79,4,64,32,1,32,2,32,3,65,2,113,114,54,2,0,32,2,32,1,65,16,106,106,34,1,32,4,65,16,107,65,1,114,54,2,0,32,0,32,1,16,2,5,32,1,32,3,65,126,113,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,32,1,65,16,106,32,1,40,2,0,65,124,113,106,40,2,0,65,125,113,54,2,0,11,11,91,1,2,127,32,0,32,1,16,5,34,4,16,6,34,3,69,4,64,65,1,36,1,65,0,36,1,32,0,32,4,16,6,34,3,69,4,64,32,0,32,4,16,7,32,0,32,4,16,6,33,3,11,11,32,3,65,0,54,2,4,32,3,32,2,54,2,8,32,3,32,1,54,2,12,32,0,32,3,16,1,32,0,32,3,32,4,16,8,32,3,11,13,0,16,4,32,0,32,1,16,9,65,16,106,11,33,1,1,127,32,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,18,0,32,0,65,172,3,75,4,64,32,0,65,16,107,16,52,11,11,140,3,1,1,127,2,64,32,1,69,13,0,32,0,65,0,58,0,0,32,0,32,1,106,65,1,107,65,0,58,0,0,32,1,65,2,77,13,0,32,0,65,1,106,65,0,58,0,0,32,0,65,2,106,65,0,58,0,0,32,0,32,1,106,34,2,65,2,107,65,0,58,0,0,32,2,65,3,107,65,0,58,0,0,32,1,65,6,77,13,0,32,0,65,3,106,65,0,58,0,0,32,0,32,1,106,65,4,107,65,0,58,0,0,32,1,65,8,77,13,0,32,1,65,0,32,0,107,65,3,113,34,1,107,33,2,32,0,32,1,106,34,0,65,0,54,2,0,32,0,32,2,65,124,113,34,1,106,65,4,107,65,0,54,2,0,32,1,65,8,77,13,0,32,0,65,4,106,65,0,54,2,0,32,0,65,8,106,65,0,54,2,0,32,0,32,1,106,34,2,65,12,107,65,0,54,2,0,32,2,65,8,107,65,0,54,2,0,32,1,65,24,77,13,0,32,0,65,12,106,65,0,54,2,0,32,0,65,16,106,65,0,54,2,0,32,0,65,20,106,65,0,54,2,0,32,0,65,24,106,65,0,54,2,0,32,0,32,1,106,34,2,65,28,107,65,0,54,2,0,32,2,65,24,107,65,0,54,2,0,32,2,65,20,107,65,0,54,2,0,32,2,65,16,107,65,0,54,2,0,32,0,32,0,65,4,113,65,24,106,34,2,106,33,0,32,1,32,2,107,33,1,3,64,32,1,65,32,79,4,64,32,0,66,0,55,3,0,32,0,65,8,106,66,0,55,3,0,32,0,65,16,106,66,0,55,3,0,32,0,65,24,106,66,0,55,3,0,32,1,65,32,107,33,1,32,0,65,32,106,33,0,12,1,11,11,11,11,178,1,1,3,127,32,1,65,240,255,255,255,3,32,2,118,75,4,64,65,144,1,65,192,1,65,23,65,56,16,0,0,11,32,1,32,2,116,34,3,65,0,16,10,34,2,32,3,16,13,32,0,69,4,64,65,12,65,2,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,2,34,1,32,0,40,2,0,34,4,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,32,4,16,12,11,32,0,32,1,54,2,0,32,0,32,2,54,2,4,32,0,32,3,54,2,8,32,0,11,46,1,2,127,65,12,65,5,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,65,128,2,65,3,16,14,11,9,0,65,63,32,0,121,167,107,11,49,1,2,127,65,63,32,1,121,167,107,33,2,3,64,65,63,32,0,121,167,107,32,2,107,34,3,65,0,78,4,64,32,0,32,1,32,3,172,134,133,33,0,12,1,11,11,32,0,11,40,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,163,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,65,0,58,0,0,11,38,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,152,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,45,0,0,11,254,5,2,1,127,4,126,32,0,69,4,64,65,232,0,65,6,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,24,32,0,66,0,55,3,32,32,0,66,0,55,3,40,32,0,66,0,55,3,48,32,0,66,0,55,3,56,32,0,66,0,55,3,64,32,0,66,0,55,3,72,32,0,66,0,55,3,80,32,0,66,0,55,3,88,32,0,66,0,55,3,96,32,0,32,2,173,55,3,80,32,0,32,3,173,55,3,88,65,12,65,4,16,10,34,2,65,172,3,75,4,64,32,2,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,32,4,65,0,16,14,33,2,32,0,40,2,0,16,12,32,0,32,2,54,2,0,32,0,32,4,54,2,4,32,0,66,1,32,1,173,134,66,1,125,55,3,96,32,0,66,243,130,183,218,216,230,232,30,55,3,72,35,4,69,4,64,65,0,33,2,3,64,32,2,65,128,2,72,4,64,32,2,65,255,1,113,173,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,65,0,33,4,3,64,32,4,32,0,40,2,4,65,1,107,72,4,64,32,6,66,8,134,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,32,4,65,1,106,33,4,12,1,11,11,35,6,40,2,4,32,2,65,3,116,106,32,6,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,63,32,0,41,3,72,121,167,107,172,33,7,65,0,33,2,3,64,32,2,65,128,2,72,4,64,35,5,33,1,32,2,172,32,7,134,34,8,33,6,65,63,32,0,41,3,72,34,9,121,167,107,33,3,3,64,65,63,32,6,121,167,107,32,3,107,34,4,65,0,78,4,64,32,6,32,9,32,4,172,134,133,33,6,12,1,11,11,32,1,40,2,4,32,2,65,3,116,106,32,6,32,8,132,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,1,36,4,11,32,0,66,0,55,3,24,32,0,66,0,55,3,32,65,0,33,2,3,64,32,2,32,0,40,2,4,72,4,64,32,0,40,2,0,32,2,16,18,32,2,65,1,106,33,2,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,6,66,45,136,167,65,3,116,106,41,3,0,32,6,66,8,134,66,1,132,133,55,3,40,32,0,11,38,1,1,127,32,0,40,2,0,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,55,1,2,127,32,1,32,0,40,2,0,34,2,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,16,12,11,32,0,32,1,54,2,0,11,7,0,32,0,40,2,4,11,9,0,32,0,32,1,54,2,4,11,7,0,32,0,40,2,8,11,9,0,32,0,32,1,54,2,8,11,7,0,32,0,41,3,16,11,9,0,32,0,32,1,55,3,16,11,7,0,32,0,41,3,24,11,9,0,32,0,32,1,55,3,24,11,7,0,32,0,41,3,32,11,9,0,32,0,32,1,55,3,32,11,7,0,32,0,41,3,40,11,9,0,32,0,32,1,55,3,40,11,7,0,32,0,41,3,48,11,9,0,32,0,32,1,55,3,48,11,7,0,32,0,41,3,56,11,9,0,32,0,32,1,55,3,56,11,7,0,32,0,41,3,64,11,9,0,32,0,32,1,55,3,64,11,7,0,32,0,41,3,72,11,9,0,32,0,32,1,55,3,72,11,7,0,32,0,41,3,80,11,9,0,32,0,32,1,55,3,80,11,7,0,32,0,41,3,88,11,9,0,32,0,32,1,55,3,88,11,7,0,32,0,41,3,96,11,9,0,32,0,32,1,55,3,96,11,172,4,2,5,127,1,126,32,2,65,172,3,75,4,64,32,2,65,16,107,34,4,32,4,40,2,4,65,1,106,54,2,4,11,32,2,33,4,65,0,33,2,32,1,40,2,8,33,5,32,1,40,2,4,33,6,3,64,2,127,65,0,33,3,3,64,32,3,32,5,72,4,64,32,3,32,6,106,45,0,0,33,1,32,0,40,2,0,32,0,40,2,8,16,19,33,7,32,0,40,2,8,32,0,40,2,0,40,2,4,106,32,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,7,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,1,173,32,8,66,8,134,132,133,55,3,40,32,0,32,0,41,3,16,66,1,124,55,3,16,32,0,32,0,41,3,24,66,1,124,55,3,24,32,0,41,3,16,32,0,41,3,80,90,4,127,32,0,41,3,40,32,0,41,3,96,131,80,5,65,0,11,4,127,65,1,5,32,0,41,3,16,32,0,41,3,88,90,11,4,64,32,0,32,0,41,3,32,55,3,48,32,0,32,0,41,3,16,55,3,56,32,0,32,0,41,3,40,55,3,64,65,0,33,1,3,64,32,1,32,0,40,2,4,72,4,64,32,0,40,2,0,32,1,16,18,32,1,65,1,106,33,1,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,8,66,8,134,66,1,132,133,55,3,40,32,3,65,1,106,12,3,11,32,3,65,1,106,33,3,12,1,11,11,65,127,11,34,1,65,0,78,4,64,32,5,32,1,107,33,5,32,1,32,6,106,33,6,32,2,34,1,65,1,106,33,2,32,4,40,2,4,32,1,65,2,116,106,32,0,41,3,56,62,2,0,12,1,11,11,32,4,11,10,0,16,15,36,5,16,15,36,6,11,3,0,1,11,73,1,2,127,32,0,40,2,4,34,1,65,255,255,255,255,0,113,34,2,65,1,70,4,64,32,0,65,16,106,16,53,32,0,32,0,40,2,0,65,1,114,54,2,0,35,0,32,0,16,2,5,32,0,32,2,65,1,107,32,1,65,128,128,128,128,127,113,114,54,2,4,11,11,58,0,2,64,2,64,2,64,32,0,65,8,107,40,2,0,14,7,0,0,1,1,1,1,1,2,11,15,11,32,0,40,2,0,34,0,4,64,32,0,65,172,3,79,4,64,32,0,65,16,107,16,52,11,11,15,11,0,11,11,137,3,7,0,65,16,11,55,40,0,0,0,1,0,0,0,1,0,0,0,40,0,0,0,97,0,108,0,108,0,111,0,99,0,97,0,116,0,105,0,111,0,110,0,32,0,116,0,111,0,111,0,32,0,108,0,97,0,114,0,103,0,101,0,65,208,0,11,45,30,0,0,0,1,0,0,0,1,0,0,0,30,0,0,0,126,0,108,0,105,0,98,0,47,0,114,0,116,0,47,0,116,0,108,0,115,0,102,0,46,0,116,0,115,0,65,128,1,11,43,28,0,0,0,1,0,0,0,1,0,0,0,28,0,0,0,73,0,110,0,118,0,97,0,108,0,105,0,100,0,32,0,108,0,101,0,110,0,103,0,116,0,104,0,65,176,1,11,53,38,0,0,0,1,0,0,0,1,0,0,0,38,0,0,0,126,0,108,0,105,0,98,0,47,0,97,0,114,0,114,0,97,0,121,0,98,0,117,0,102,0,102,0,101,0,114,0,46,0,116,0,115,0,65,240,1,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,73,0,110,0,100,0,101,0,120,0,32,0,111,0,117,0,116,0,32,0,111,0,102,0,32,0,114,0,97,0,110,0,103,0,101,0,65,176,2,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,126,0,108,0,105,0,98,0,47,0,116,0,121,0,112,0,101,0,100,0,97,0,114,0,114,0,97,0,121,0,46,0,116,0,115,0,65,240,2,11,53,7,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,145,4,0,0,2,0,0,0,49,0,0,0,2,0,0,0,17,1,0,0,2,0,0,0,16,0,34,16,115,111,117,114,99,101,77,97,112,112,105,110,103,85,82,76,16,46,47,114,97,98,105,110,46,119,97,115,109,46,109,97,112]);return o$(new Response(new Blob([e],{type:"application/wasm"})),r)}var a$=i2;const yb=Qx,c$=a$,l$=async(r,e,t,n,s)=>{const i=await c$();return new yb(i,r,e,t,n,s)};var h$={Rabin:yb,create:l$};async function*u$(r,e){let t,n,s;if(e.minChunkSize&&e.maxChunkSize&&e.avgChunkSize)s=e.avgChunkSize,t=e.minChunkSize,n=e.maxChunkSize;else if(e.avgChunkSize)s=e.avgChunkSize,t=s/3,n=s+s/2;else throw v(new Error("please specify an average chunk size"),"ERR_INVALID_AVG_CHUNK_SIZE");if(t<16)throw v(new Error("rabin min must be greater than 16"),"ERR_INVALID_MIN_CHUNK_SIZE");n<t&&(n=t),s<t&&(s=t);const i=Math.floor(Math.log2(s));for await(const o of d$(r,{min:t,max:n,bits:i,window:e.window,polynomial:e.polynomial}))yield o}async function*d$(r,e){const t=await h$.create(e.bits,e.min,e.max,e.window),n=new ke;for await(const s of r){n.append(s);const i=t.fingerprint(s);for(let o=0;o<i.length;o++){const a=i[o],c=n.slice(0,a);n.consume(a),yield c}}n.length&&(yield n.subarray(0))}async function*f$(r,e){let t=new ke,n=0,s=!1;const i=e.maxChunkSize;for await(const o of r)for(t.append(o),n+=o.length;n>=i;)if(yield t.slice(0,i),s=!0,i===t.length)t=new ke,n=0;else{const a=new ke;a.append(t.sublist(i)),t=a,n-=i}(!s||n)&&(yield t.subarray(0,n))}async function*p$(r){for await(const e of r){if(e.length===void 0)throw v(new Error("Content was invalid"),"ERR_INVALID_CONTENT");if(typeof e=="string"||e instanceof String)yield L(e.toString());else if(Array.isArray(e))yield Uint8Array.from(e);else if(e instanceof Uint8Array)yield e;else throw v(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}}function g$(r){return Symbol.iterator in r}function y$(r){return Symbol.asyncIterator in r}function w$(r){try{if(r instanceof Uint8Array)return async function*(){yield r}();if(g$(r))return async function*(){yield*r}();if(y$(r))return r}catch{throw v(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}throw v(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}async function*m$(r,e,t){for await(const n of r)if(n.path&&(n.path.substring(0,2)==="./"&&(t.wrapWithDirectory=!0),n.path=n.path.split("/").filter(s=>s&&s!==".").join("/")),n.content){let s;typeof t.chunker=="function"?s=t.chunker:t.chunker==="rabin"?s=u$:s=f$;let i;typeof t.chunkValidator=="function"?i=t.chunkValidator:i=p$;const o={path:n.path,mtime:n.mtime,mode:n.mode,content:s(i(w$(n.content),t),t)};yield()=>Wx(o,e,t)}else if(n.path){const s={path:n.path,mtime:n.mtime,mode:n.mode};yield()=>$x(s,e,t)}else throw new Error("Import candidate must have content or path or both")}let ec=class{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}};class o2 extends ec{constructor(e,t){super(e,t),this._children={}}async put(e,t){this.cid=void 0,this.size=void 0,this._children[e]=t}get(e){return Promise.resolve(this._children[e])}childCount(){return Object.keys(this._children).length}directChildrenCount(){return this.childCount()}onlyChild(){return this._children[Object.keys(this._children)[0]]}async*eachChildSeries(){const e=Object.keys(this._children);for(let t=0;t<e.length;t++){const n=e[t];yield{key:n,child:this._children[n]}}}async*flush(e){const t=Object.keys(this._children),n=[];for(let h=0;h<t.length;h++){let l=this._children[t[h]];if(l instanceof ec)for await(const u of l.flush(e))l=u,yield l;l.size!=null&&l.cid&&n.push({Name:t[h],Tsize:l.size,Hash:l.cid})}const s=new Pe({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:s.marshal(),Links:n},o=De(js(i)),a=await wo(o,e,this.options),c=o.length+i.Links.reduce((h,l)=>h+(l.Tsize==null?0:l.Tsize),0);this.cid=a,this.size=c,yield{cid:a,unixfs:s,path:this.path,size:c}}}const Qc=7;var b$=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(t===void 0)n!==-1&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let s=!1;n===-1?(n=this._data.length,this._setBit(e),this._changedData=!0):s=!0,this._setInternalPos(n,e,t,s),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,s=t;for(;n<this.length;){const i=this.get(n);s=e(s,i,n),n++}return s}find(e){let t=0,n,s;for(;t<this.length&&!n;)s=this.get(t),n=e(s),t++;return n?s:void 0}_internalPositionFor(e,t){const n=this._bytePosFor(e,t);if(n>=this._bitArrays.length)return-1;const s=this._bitArrays[n],i=e-n*Qc;if(!((s&1<<i)>0))return-1;const a=this._bitArrays.slice(0,n).reduce(E$,0),c=~(4294967295<<i+1),h=wb(s&c);return a+h-1}_bytePosFor(e,t){const n=Math.floor(e/Qc),s=n+1;for(;!t&&this._bitArrays.length<s;)this._bitArrays.push(0);return n}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*Qc}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*Qc)}_setInternalPos(e,t,n,s){const i=this._data,o=[t,n];if(s)this._sortData(),i[e]=o;else{if(i.length)if(i[i.length-1][0]>=t)i.push(o);else if(i[0][0]<=t)i.unshift(o);else{const a=Math.round(i.length/2);this._data=i.slice(0,a).concat(o).concat(i.slice(a))}else this._data.push(o);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(_$),this._changedData=!1}bitField(){const e=[];let t=8,n=0,s=0,i;const o=this._bitArrays.slice();for(;o.length||n;){n===0&&(i=o.shift(),n=7);const c=Math.min(n,t),h=~(255<<c),l=i&h;s|=l<<8-t,i=i>>>c,n-=c,t-=c,(!t||!n&&!o.length)&&(e.push(s),s=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(v$)}};function E$(r,e){return r+wb(e)}function wb(r){let e=r;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function _$(r,e){return r[0]-e[0]}function v$(r){return r[1]}class Mt{constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new b$,this.key=null}async put(e,t){const n=await this._findNewBucketAndPos(e);await n.bucket._putAt(n,e,t)}async get(e){const t=await this._findChild(e);if(t!=null)return t.value}async del(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);n!=null&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,n)=>n instanceof Mt?t+n.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof Mt?yield*t.eachLeafSeries():yield t}serialize(e,t){const n=[];return t(this._children.reduce((s,i,o)=>(i!=null&&(i instanceof Mt?s.push(i.serialize(e,t)):s.push(e(i,o))),s),n))}async asyncTransform(e,t){return await mb(this,e,t)}toJSON(){return this.serialize(R$,A$)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof Mt)&&n!=null&&n.key===e)return n}async _findPlace(e){const t=this._options.hash(typeof e=="string"?L(e):e),n=await t.take(this._options.bits),s=this._children.get(n);return s instanceof Mt?await s._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:s}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){const n=new Mt(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,n);const s=await n._findPlace(t.existingChild.hash);return s.bucket._putAt(s,t.existingChild.key,t.existingChild.value),await n._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const e=this._children.find(S$);if(e!=null&&!(e instanceof Mt)){const t=e.hash;t.untake(this._options.bits);const n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function S$(r){return Boolean(r)}function R$(r,e){return r.key}function A$(r){return r}async function mb(r,e,t){const n=[];for(const s of r._children.compactArray())if(s instanceof Mt)await mb(s,e,t);else{const i=await e(s);n.push({bitField:r._children.bitField(),children:i})}return await t(n)}const I$=[255,254,252,248,240,224,192,128],C$=[1,3,7,15,31,63,127,255];class T${constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const s=this._value[this._currentBytePos],i=this._currentBitPos+1,o=Math.min(i,t),a=k$(s,i-o,o);n=(n<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function k$(r,e,t){const n=D$(e,t);return(r&n)>>>e}function D$(r,e){return I$[r]&C$[Math.min(e+r-1,7)]}function P$(r){function e(t){return t instanceof uy?t:new uy(t,r)}return e}class uy{constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const s=this._buffers[this._currentBufferIndex],i=Math.min(s.availableBits(),t),o=s.take(i);n=(n<<i)+o,t-=i,this._availableBits-=i,s.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const n=this._buffers[this._currentBufferIndex],s=Math.min(n.totalBits()-n.availableBits(),t);n.untake(s),t-=s,this._availableBits+=s,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?qe([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new T$(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}function hd(r){if(r==null||r.hashFn==null)throw new Error("please define an options.hashFn");const e={bits:r.bits??8,hash:P$(r.hashFn)};return new Mt(e)}let O$=class extends ec{constructor(e,t){super(e,t),this._bucket=hd({hashFn:t.hamtHashFn,bits:t.hamtBucketBits})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){for await(const t of bb(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*bb(r,e,t,n){const s=r._children,i=[];let o=0;for(let g=0;g<s.length;g++){const d=s.get(g);if(!d)continue;const p=g.toString(16).toUpperCase().padStart(2,"0");if(d instanceof Mt){let w;for await(const y of await bb(d,e,null,n))w=y;if(!w)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:p,Tsize:w.size,Hash:w.cid}),o+=w.size}else if(typeof d.value.flush=="function"){const w=d.value;let y;for await(const m of w.flush(e))y=m,yield y;const _=p+d.key;i.push({Name:_,Tsize:y.size,Hash:y.cid}),o+=y.size}else{const w=d.value;if(!w.cid)continue;const y=p+d.key,_=w.size;i.push({Name:y,Tsize:_,Hash:w.cid}),o+=_}}const a=Uint8Array.from(s.bitField().reverse()),c=new Pe({type:"hamt-sharded-directory",data:a,fanout:r.tableSize(),hashType:n.hamtHashCode,mtime:t&&t.mtime,mode:t&&t.mode}),h={Data:c.marshal(),Links:i},l=De(js(h)),u=await wo(l,e,n),f=l.length+o;yield{cid:u,unixfs:c,size:f}}async function Eb(r,e,t,n){let s=e;e instanceof o2&&e.directChildrenCount()>=t&&(s=await N$(e,n));const i=s.parent;if(i){if(s!==e){if(r&&(r.parent=s),!s.parentKey)throw new Error("No parent key found");await i.put(s.parentKey,s)}return Eb(s,i,t,n)}return s}async function N$(r,e){const t=new O$({root:r.root,dir:!0,parent:r.parent,parentKey:r.parentKey,path:r.path,dirty:r.dirty,flat:!1,mtime:r.mtime,mode:r.mode},e);for await(const{key:n,child:s}of r.eachChildSeries())await t.put(n,s);return t}const x$=(r="")=>(r.trim().match(/([^\\/]|\\\/)+/g)||[]).filter(Boolean);async function $$(r,e,t){const n=x$(r.path||""),s=n.length-1;let i=e,o="";for(let a=0;a<n.length;a++){const c=n[a];o+=`${o?"/":""}${c}`;const h=a===s;if(i.dirty=!0,i.cid=void 0,i.size=void 0,h)await i.put(c,r),e=await Eb(null,i,t.shardSplitThreshold,t);else{let l=await i.get(c);(!l||!(l instanceof ec))&&(l=new o2({root:!1,dir:!0,parent:i,parentKey:c,path:o,dirty:!0,flat:!0,mtime:l&&l.unixfs&&l.unixfs.mtime,mode:l&&l.unixfs&&l.unixfs.mode},t)),await i.put(c,l),i=l}}return e}async function*dy(r,e){if(!(r instanceof ec)){r&&r.unixfs&&r.unixfs.isDirectory()&&(yield r);return}yield*r.flush(e)}async function*L$(r,e,t){let n=new o2({root:!0,dir:!0,path:"",dirty:!0,flat:!0},t);for await(const s of r)s&&(n=await $$(s,n,t),(!s.unixfs||!s.unixfs.isDirectory())&&(yield s));if(t.wrapWithDirectory)yield*dy(n,e);else for await(const s of n.eachChildSeries())s&&(yield*dy(s.child,e))}async function*a2(r,e,t={}){const n=bx(t);let s;typeof t.dagBuilder=="function"?s=t.dagBuilder:s=m$;let i;typeof t.treeBuilder=="function"?i=t.treeBuilder:i=L$;let o;Symbol.asyncIterator in r||Symbol.iterator in r?o=r:o=[r];for await(const a of i(Zp(s(o,e,n),n.fileImportConcurrency),e,n))yield{cid:a.cid,path:a.path,unixfs:a.unixfs,size:a.size}}async function*_b(r,e){if(typeof r=="string"||r instanceof String||qs(r)||Ja(r)||r._readableState)throw v(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(Za(r)&&(r=_i(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const t=Ac(r),{value:n,done:s}=await t.peek();if(s){yield*[];return}if(t.push(n),Number.isInteger(n))throw v(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(n._readableState){yield*zt(t,i=>nf({content:i},e));return}if(qs(n)){yield nf({content:t},e);return}if(H1(n)||n[Symbol.iterator]||n[Symbol.asyncIterator]||Za(n)||Ja(n)){yield*zt(t,i=>nf(i,e));return}}throw H1(r)?v(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT"):v(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}async function nf(r,e){const{path:t,mode:n,mtime:s,content:i}=r,o={path:t||"",mode:io(n),mtime:Ya(s)};return i?o.content=await e(i):t||(o.content=await e(r)),o}function M$(r){return _b(r,Y8)}const U$=r=>{if(r)if(r.startsWith("size-")){const e=r.split("-")[1],t=parseInt(e);if(isNaN(t))throw new Error("Chunker parameter size must be an integer");return{chunker:"fixed",maxChunkSize:t}}else{if(r.startsWith("rabin"))return{chunker:"rabin",...B$(r)};throw new Error(`Unrecognized chunker option: ${r}`)}else return{chunker:"fixed"}},B$=r=>{const e={},t=r.split("-");switch(t.length){case 1:e.avgChunkSize=262144;break;case 2:e.avgChunkSize=Xc(t[1],"avg");break;case 4:e.minChunkSize=Xc(t[1],"min"),e.avgChunkSize=Xc(t[2],"avg"),e.maxChunkSize=Xc(t[3],"max");break;default:throw new Error('Incorrect chunker format (expected "rabin" "rabin-[avg]" or "rabin-[min]-[avg]-[max]"')}return e},Xc=(r,e)=>{const t=parseInt(r);if(isNaN(t))throw new Error(`Chunker parameter ${e} must be an integer`);return t},z$=Ue.bind({ignoreUndefined:!0});function F$({repo:r,preload:e,hashers:t,options:n}){const s=n&&n.sharding;async function*i(o,a={}){const c=z$({shardSplitThreshold:s?1e3:1/0,strategy:"balanced"},a,{...U$(a.chunker)});c.hashAlg&&c.hashAlg!=="sha2-256"&&c.cidVersion!==1&&(c.cidVersion=1),c.trickle&&(c.strategy="trickle"),c.strategy==="trickle"&&(c.leafType="raw",c.reduceSingleLeafToSelf=!1),c.cidVersion>0&&c.rawLeaves===void 0&&(c.rawLeaves=!0),c.hashAlg!==void 0&&c.rawLeaves===void 0&&(c.rawLeaves=!0),delete c.trickle;const h={};if(c.progress){const g=c.progress;c.progress=(d,p)=>{h[p]||(h[p]=0),h[p]+=d,g(h[p],p)}}let l;c.hashAlg!=null&&(l=await t.getHasher(c.hashAlg));const u=ie(M$(o),g=>a2(g,r.blocks,{...c,hasher:l,pin:!1}),V$(c),K$(e,c),j$(r,c)),f=await r.gcLock.readLock();try{for await(const g of u){const d=g.path??g.cid.toString();delete h[d],yield{...g,path:d}}}finally{f()}}return x(i)}function V$(r){async function*e(t){for await(const n of t){let s=n.cid;r.cidVersion===1&&(s=s.toV1());let i=n.path?n.path:s.toString();r.wrapWithDirectory&&!n.path&&(i=""),yield{path:i,cid:s,size:n.size,mode:n.unixfs&&n.unixfs.mode,mtime:n.unixfs&&n.unixfs.mtime}}}return e}function K$(r,e){async function*t(n){for await(const s of n)(!s.path||e.wrapWithDirectory?s.path==="":!s.path.includes("/"))&&!e.onlyHash&&e.preload!==!1&&r(s.cid),yield s}return t}function j$(r,e){async function*t(n){for await(const s of n){const i=!(s.path&&s.path.includes("/"));(e.pin==null?!0:e.pin)&&i&&!e.onlyHash&&await r.pins.pinRecursively(s.cid),yield s}}return t}var H$=vb,fy=128,q$=127,G$=~q$,W$=Math.pow(2,31);function vb(r,e,t){e=e||[],t=t||0;for(var n=t;r>=W$;)e[t++]=r&255|fy,r/=128;for(;r&G$;)e[t++]=r&255|fy,r>>>=7;return e[t]=r|0,vb.bytes=t-n+1,e}var Y$=e0,Q$=128,py=127;function e0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw e0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&py)<<s:(o&py)*Math.pow(2,s),s+=7}while(o>=Q$);return e0.bytes=i-n,t}var X$=Math.pow(2,7),J$=Math.pow(2,14),Z$=Math.pow(2,21),eL=Math.pow(2,28),tL=Math.pow(2,35),rL=Math.pow(2,42),nL=Math.pow(2,49),sL=Math.pow(2,56),iL=Math.pow(2,63),oL=function(r){return r<X$?1:r<J$?2:r<Z$?3:r<eL?4:r<tL?5:r<rL?6:r<nL?7:r<sL?8:r<iL?9:10},aL={encode:H$,decode:Y$,encodingLength:oL},xh=aL;const t0=(r,e=0)=>[xh.decode(r,e),xh.decode.bytes],$h=(r,e,t=0)=>(xh.encode(r,e,t),e),Lh=r=>xh.encodingLength(r),cL=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},ud=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Sb=(r,e)=>{const t=e.byteLength,n=Lh(r),s=n+Lh(t),i=new Uint8Array(s+t);return $h(r,i,0),$h(t,i,n),i.set(e,s),new c2(r,t,e,i)},Rb=r=>{const e=ud(r),[t,n]=t0(e),[s,i]=t0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new c2(t,s,o,e)},lL=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&cL(r.bytes,t.bytes)}};let c2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function hL(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var uL=hL,dL=uL;let fL=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},pL=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Ab(this,e)}},gL=class{constructor(e){this.decoders=e}or(e){return Ab(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Ab=(r,e)=>new gL({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let yL=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new fL(e,t,n),this.decoder=new pL(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Ib=({name:r,prefix:e,encode:t,decode:n})=>new yL(r,e,t,n),Cb=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=dL(t,e);return Ib({prefix:r,name:e,encode:n,decode:i=>ud(s(i))})},wL=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},mL=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},qn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Ib({prefix:e,name:r,encode(s){return mL(s,n,t)},decode(s){return wL(s,n,t,r)}}),ms=Cb({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Cb({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const zl=qn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});qn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});qn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});qn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});qn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});qn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});qn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});qn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});qn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const gy=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return EL(t,r0(r),e||ms.encoder);default:return _L(t,r0(r),e||zl.encoder)}},yy=new WeakMap,r0=r=>{const e=yy.get(r);if(e==null){const t=new Map;return yy.set(r,t),t}return e};let Fl=class It{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ea)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==vL)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return It.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Sb(e,t);return It.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return It.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&lL(e.multihash,n.multihash)}toString(e){return gy(this,e)}toJSON(){return{"/":gy(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof It)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new It(n,s,i,o||wy(n,s,i.bytes))}else if(t[SL]===!0){const{version:n,multihash:s,code:i}=t,o=Rb(s);return It.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ea)throw new Error(`Version 0 CID must use dag-pb (code: ${ea}) block encoding`);return new It(e,t,n,n.bytes)}case 1:{const s=wy(e,t,n.bytes);return new It(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return It.create(0,ea,e)}static createV1(e,t){return It.create(1,e,t)}static decode(e){const[t,n]=It.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=It.inspectBytes(e),n=t.size-t.multihashSize,s=ud(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new c2(t.multihashCode,t.digestSize,i,s);return[t.version===0?It.createV0(o):It.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=t0(e.subarray(t));return t+=f,u};let s=n(),i=ea;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=bL(e,t),i=It.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return r0(i).set(n,e),i}};const bL=(r,e)=>{switch(r[0]){case"Q":{const t=e||ms;return[ms.prefix,t.decode(`${ms.prefix}${r}`)]}case ms.prefix:{const t=e||ms;return[ms.prefix,t.decode(r)]}case zl.prefix:{const t=e||zl;return[zl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},EL=(r,e,t)=>{const{prefix:n}=t;if(n!==ms.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},_L=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ea=112,vL=18,wy=(r,e,t)=>{const n=Lh(r),s=n+Lh(e),i=new Uint8Array(s+t.byteLength);return $h(r,i,0),$h(e,i,n),i.set(t,s),i},SL=Symbol.for("@ipld/js-cid/CID"),Tb=85,kb=0,RL="identity",Db=ud,AL=r=>Sb(kb,Db(r)),IL={code:kb,name:RL,encode:Db,digest:AL},CL=async function(r){return(await ld.encode(r)).slice(0,8).reverse()},TL=(r,e,t)=>Promise.all(r.map(n=>{if(n.Name==null)throw new Error("Unexpected Link without a Name");if(n.Name.length===2){const s=parseInt(n.Name,16);return e._putObjectAt(s,new Mt({hash:t._options.hash,bits:t._options.bits},e,s))}return t.put(n.Name.substring(2),!0)})),my=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),kL=r=>{let e=r.bucket;const t=[];for(;e._parent;)t.push(e),e=e._parent;return t.push(e),t.reverse()},Pb=async(r,e,t,n,s)=>{if(!n){const l=hd({hashFn:CL});n={rootBucket:l,hamtDepth:1,lastBucket:l}}await TL(r.Links,n.lastBucket,n.rootBucket);const i=await n.rootBucket._findNewBucketAndPos(e);let o=my(i.pos);const a=kL(i);a.length>n.hamtDepth&&(n.lastBucket=a[n.hamtDepth],o=my(n.lastBucket._posAtParent));const c=r.Links.find(l=>{if(l.Name==null)return!1;const u=l.Name.substring(0,2),f=l.Name.substring(2);return!(u!==o||f&&f!==e)});if(!c)return null;if(c.Name!=null&&c.Name.substring(2)===e)return c.Hash;n.hamtDepth++;const h=await t.get(c.Hash,s);return r=it(h),Pb(r,e,t,n,s)};function Mh(r,e,t,n){const s=r.length,i=e+s;return t>=i||n<e?new Uint8Array(0):(n>=e&&n<i&&(r=r.subarray(0,n-e)),t>=e&&t<i&&(r=r.subarray(t-e)),r)}const l2=(r,e,t)=>{if(e||(e=0),e<0)throw v(new Error("Offset must be greater than or equal to 0"),"ERR_INVALID_PARAMS");if(e>r)throw v(new Error("Offset must be less than the file size"),"ERR_INVALID_PARAMS");if(!t&&t!==0&&(t=r-e),t<0)throw v(new Error("Length must be greater than or equal to 0"),"ERR_INVALID_PARAMS");return e+t>r&&(t=r-e),{offset:e,length:t}};async function Ob(r,e,t,n,s,i,o,a){if(e instanceof Uint8Array){t.push(Mh(e,n,s,i));return}if(e.Data==null)throw v(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");let c;try{c=Pe.unmarshal(e.Data)}catch(l){throw v(l,"ERR_NOT_UNIXFS")}if(c.data!=null){const l=c.data,u=Mh(l,n,s,i);t.push(u),n+=u.byteLength}const h=[];for(let l=0;l<e.Links.length;l++){const u=e.Links[l],f=n,g=f+c.blockSizes[l];if((s>=f&&s<g||i>=f&&i<=g||s<f&&i>g)&&h.push({link:u,blockStart:n}),n=g,n>i)break}await ie(h,l=>zt(l,u=>async()=>{const f=await r.get(u.link.Hash,{signal:a.signal});return{...u,block:f}}),l=>cd(l,{ordered:!0}),async l=>{for await(const{link:u,block:f,blockStart:g}of l){let d;switch(u.Hash.code){case Be:d=it(f);break;case Tb:d=f;break;default:t.end(v(new Error(`Unsupported codec: ${u.Hash.code}`),"ERR_NOT_UNIXFS"));return}o.add(async()=>{await Ob(r,d,t,g,s,i,o,a)})}})}const by=(r,e,t,n,s,i,o)=>{async function*a(c={}){const h=t.fileSize();if(h===void 0)throw new Error("File was a directory");const{offset:l,length:u}=l2(h,c.offset,c.length);if(u===0)return;const f=new lt({concurrency:1}),g=Bt();f.add(async()=>{await Ob(o,e,g,0,l,l+u,f,c)}),f.on("error",p=>{g.end(p)});let d=0;for await(const p of g)p!=null&&(d+=p.byteLength,d===u&&g.end(),yield p)}return a},DL=(r,e,t,n,s,i,o)=>{async function*a(c={}){const h=c.offset||0,l=c.length||e.Links.length,u=e.Links.slice(h,l);for(const f of u){const g=await s(f.Hash,f.Name||"",`${n}/${f.Name||""}`,[],i+1,o,c);g.entry&&(yield g.entry)}}return a},PL=(r,e,t,n,s,i,o)=>{function a(c={}){return Nb(e,n,s,i,o,c)}return a};async function*Nb(r,e,t,n,s,i){const o=r.Links;for(const a of o){const c=a.Name!=null?a.Name.substring(2):null;if(c)yield(await t(a.Hash,c,`${e}/${c}`,[],n+1,s,i)).entry;else{const h=await s.get(a.Hash);r=it(h);for await(const l of Nb(r,e,t,n,s,i))yield l}}}const OL=(r,e)=>{const t=r.Links.find(n=>n.Name===e);return t&&t.Hash},NL={raw:by,file:by,directory:DL,"hamt-sharded-directory":PL,metadata:(r,e,t,n,s,i,o)=>()=>[],symlink:(r,e,t,n,s,i,o)=>()=>[]},xL=async(r,e,t,n,s,i,o,a)=>{const c=await o.get(r,a),h=it(c);let l,u;if(e||(e=r.toString()),h.Data==null)throw v(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");try{l=Pe.unmarshal(h.Data)}catch(f){throw v(f,"ERR_NOT_UNIXFS")}if(t||(t=e),n.length){let f;if(l&&l.type==="hamt-sharded-directory"?f=await Pb(h,n[0],o):f=OL(h,n[0]),!f)throw v(new Error("file does not exist"),"ERR_NOT_FOUND");const g=n.shift(),d=`${t}/${g}`;u={cid:f,toResolve:n,name:g||"",path:d}}return{entry:{type:l.isDirectory()?"directory":"file",name:e,path:t,cid:r,content:NL[l.type](r,h,l,t,s,i,o),unixfs:l,depth:i,node:h,size:l.fileSize()},next:u}},$L=r=>{async function*e(t={}){const{offset:n,length:s}=l2(r.length,t.offset,t.length);yield Mh(r,0,n,n+s)}return e},LL=async(r,e,t,n,s,i,o,a)=>{if(n.length)throw v(new Error(`No link named ${t} found in raw node ${r}`),"ERR_NOT_FOUND");const c=await o.get(r,a);return{entry:{type:"raw",name:e,path:t,cid:r,content:$L(c),depth:i,size:c.length,node:c}}},ML=async(r,e,t,n,s,i,o,a)=>{const c=await o.get(r),h=_p(c);let l=h,u=t;for(;n.length;){const f=n[0];if(f in l){n.shift(),u=`${u}/${f}`;const g=Fl.asCID(l[f]);if(g)return{entry:{type:"object",name:e,path:t,cid:r,node:c,depth:i,size:c.length,content:async function*(){yield h}},next:{cid:g,name:f,path:u,toResolve:n}};l=l[f]}else throw v(new Error(`No property named ${f} found in cbor node ${r}`),"ERR_NO_PROP")}return{entry:{type:"object",name:e,path:t,cid:r,node:c,depth:i,size:c.length,content:async function*(){yield h}}}},UL=r=>{async function*e(t={}){const{offset:n,length:s}=l2(r.length,t.offset,t.length);yield Mh(r,0,n,n+s)}return e},BL=async(r,e,t,n,s,i,o,a)=>{if(n.length)throw v(new Error(`No link named ${t} found in raw node ${r}`),"ERR_NOT_FOUND");const c=await Rb(r.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:r,content:UL(c.digest),depth:i,size:c.digest.length,node:c.digest}}},zL={[Be]:xL,[Tb]:LL,[tm]:ML,[IL.code]:BL};function xb(r,e,t,n,s,i,o){const a=zL[r.code];if(!a)throw v(new Error(`No resolver for code ${r.code}`),"ERR_NO_RESOLVER");return a(r,e,t,n,xb,s,i,o)}const FL=(r="")=>(r.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean),VL=r=>{if(r instanceof Uint8Array)return{cid:Fl.decode(r),toResolve:[]};const e=Fl.asCID(r);if(e)return{cid:e,toResolve:[]};if(typeof r=="string"){r.indexOf("/ipfs/")===0&&(r=r.substring(6));const t=FL(r);return{cid:Fl.parse(t[0]),toResolve:t.slice(1)}}throw v(new Error(`Unknown path type ${r}`),"ERR_BAD_PATH")};async function*$b(r,e,t={}){let{cid:n,toResolve:s}=VL(r),i=n.toString(),o=i;const a=s.length;for(;;){const c=await xb(n,i,o,s,a,e,t);if(!c.entry&&!c.next)throw v(new Error(`Could not resolve ${r}`),"ERR_NOT_FOUND");if(c.entry&&(yield c.entry),!c.next)return;s=c.next.toResolve,n=c.next.cid,i=c.next.name,o=c.next.path}}async function Gn(r,e,t={}){const n=await hr($b(r,e,t));if(!n)throw v(new Error(`Could not resolve ${r}`),"ERR_NOT_FOUND");return n}async function*Lb(r,e,t={}){const n=await Gn(r,e,t);if(!n)return;if(yield n,n.type==="directory")for await(const i of s(n,t))yield i;async function*s(i,o){for await(const a of i.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*s(a,o))}}function KL({repo:r,preload:e}){async function*t(n,s={}){if(n=Vp(n),s.preload!==!1){const o=n.split("/");e(J.parse(o[0]))}const i=await Gn(n,r.blocks,s);if(i.type==="directory")throw new Error("this dag node is a directory");if(!i.content)throw new Error("this dag node has no content");yield*i.content(s)}return x(t)}L("ustar\0","binary");L("ustar ","binary");L(" \0","binary");function jL(r){const e=async function*(){let t=yield,n=new ke;for await(const s of r){if(t==null){n.append(s),t=yield n,n=new ke;continue}for(n.append(s);n.length>=t;){const i=n.sublist(0,t);if(n.consume(t),t=yield i,t==null){n.length>0&&(t=yield n,n=new ke);break}}}if(t!=null)throw Object.assign(new Error(`stream ended before ${t} bytes became available`),{code:"ERR_UNDER_READ",buffer:n})}();return e.next(),e}var HL={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,SIGUNUSED:31,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:64,O_EXCL:128,UV_FS_O_FILEMAP:0,O_NOCTTY:256,O_TRUNC:512,O_APPEND:1024,O_DIRECTORY:65536,O_NOATIME:262144,O_NOFOLLOW:131072,O_SYNC:1052672,O_DSYNC:4096,O_DIRECT:16384,O_NONBLOCK:2048,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:269488447,SSL_OP_ALL:2147485780,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6};const qL="0000000000000000000",GL="7777777777777777777",WL="0".charCodeAt(0),YL=L("ustar\0","binary"),QL=L("00","binary"),XL=parseInt("7777",8),JL=257,ZL=263,eM=function(r){switch(r){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},tM=function(r){let e=256;for(let t=0;t<148;t++)e+=r[t];for(let t=156;t<512;t++)e+=r[t];return e},os=function(r,e){const t=r.toString(8);return t.length>e?L(GL.slice(0,e)+" "):L(qL.slice(0,e-t.length)+t+" ")},sf=function(r){const e=L(r).byteLength;let t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${r}`};function rM(r){let e="";r.name!=null&&(e+=sf(" path="+r.name+`
`)),r.linkname!=null&&(e+=sf(" linkpath="+r.linkname+`
`));const t=r.pax;if(t!=null)for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e+=sf(" "+n+"="+t[n]+`
`));return L(e)}function n0(r){const e=new Uint8Array(512);let t=r.name,n="";if(r.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),L(t).byteLength!==t.length)return null;for(;L(t).byteLength>100;){const s=t.indexOf("/");if(s===-1)return null;n+=n!==""?"/"+t.slice(0,s):t.slice(0,s),t=t.slice(s+1)}return L(t).byteLength>100||L(n).byteLength>155||r.linkname!=null&&L(r.linkname).byteLength>100?null:(e.set(L(t),0),e.set(os(r.mode&XL,6),100),e.set(os(r.uid,6),108),e.set(os(r.gid,6),116),e.set(os(r.size,11),124),e.set(os(r.mtime.getTime()/1e3|0,11),136),e[156]=WL+eM(r.type),r.linkname!=null&&e.set(L(r.linkname),157),e.set(YL,JL),e.set(QL,ZL),r.uname!=null&&e.set(L(r.uname),265),r.gname!=null&&e.set(L(r.gname),297),e.set(os(r.devmajor??0,6),329),e.set(os(r.devminor??0,6),337),n!=null&&e.set(L(n),345),e.set(os(tM(e),6),148),e)}const{S_IFMT:nM,S_IFBLK:sM,S_IFCHR:iM,S_IFDIR:oM,S_IFIFO:aM,S_IFLNK:cM}=HL,lM=parseInt("755",8),hM=parseInt("644",8),Mb=new Uint8Array(1024);function uM(r=0){switch(r&nM){case sM:return"block-device";case iM:return"character-device";case oM:return"directory";case aM:return"fifo";case cM:return"symlink";default:return"file"}}function s0(r){return r&=511,r!==0?Mb.subarray(0,512-r):new Uint8Array(0)}function of(r){if(r.pax==null){const e=n0(r);if(e!=null)return e}return dM(r)}function dM(r){const e=rM(r),t={name:"PaxHeader",mode:r.mode,uid:r.uid,gid:r.gid,size:e.length,mtime:r.mtime,type:"pax-header",linkname:r.linkname,uname:r.uname,gname:r.gname,devmajor:r.devmajor,devminor:r.devminor};return new ke(n0(t)??new Uint8Array(0),e,s0(e.length),n0({...t,size:r.size,type:r.type})??new Uint8Array(0)).subarray()}function Ey(){return async function*(r){for await(let{header:e,body:t}of r){const n={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??uM(e.mode),mode:e.mode??(e.type==="directory"?lM:hM),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=L(t)),t instanceof Uint8Array||hi(t)){n.size=t.length,yield of(n),yield hi(t)?t.subarray():t,yield s0(n.size);continue}if(n.type==="symlink"&&n.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");n.linkname=B(await a1(t)),yield of(n);continue}if(yield of(n),n.type!=="file"&&n.type!=="contiguous-file")continue;let s=0;for await(const i of t??[])s+=i.length,yield hi(i)?i.subarray():i;if(s!==n.size)throw new Error(`size mismatch, wrote ${s} of ${n.size} bytes`);yield s0(n.size)}yield Mb}}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const fM=4,_y=0,vy=1,pM=2;function Oo(r){let e=r.length;for(;--e>=0;)r[e]=0}const gM=0,Ub=1,yM=2,wM=3,mM=258,h2=29,Tc=256,tc=Tc+1+h2,ao=30,u2=19,Bb=2*tc+1,ui=15,af=16,bM=7,d2=256,zb=16,Fb=17,Vb=18,i0=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Vl=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),EM=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Kb=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),_M=512,kn=new Array((tc+2)*2);Oo(kn);const La=new Array(ao*2);Oo(La);const rc=new Array(_M);Oo(rc);const nc=new Array(mM-wM+1);Oo(nc);const f2=new Array(h2);Oo(f2);const Uh=new Array(ao);Oo(Uh);function cf(r,e,t,n,s){this.static_tree=r,this.extra_bits=e,this.extra_base=t,this.elems=n,this.max_length=s,this.has_stree=r&&r.length}let jb,Hb,qb;function lf(r,e){this.dyn_tree=r,this.max_code=0,this.stat_desc=e}const Gb=r=>r<256?rc[r]:rc[256+(r>>>7)],sc=(r,e)=>{r.pending_buf[r.pending++]=e&255,r.pending_buf[r.pending++]=e>>>8&255},Qt=(r,e,t)=>{r.bi_valid>af-t?(r.bi_buf|=e<<r.bi_valid&65535,sc(r,r.bi_buf),r.bi_buf=e>>af-r.bi_valid,r.bi_valid+=t-af):(r.bi_buf|=e<<r.bi_valid&65535,r.bi_valid+=t)},rn=(r,e,t)=>{Qt(r,t[e*2],t[e*2+1])},Wb=(r,e)=>{let t=0;do t|=r&1,r>>>=1,t<<=1;while(--e>0);return t>>>1},vM=r=>{r.bi_valid===16?(sc(r,r.bi_buf),r.bi_buf=0,r.bi_valid=0):r.bi_valid>=8&&(r.pending_buf[r.pending++]=r.bi_buf&255,r.bi_buf>>=8,r.bi_valid-=8)},SM=(r,e)=>{const t=e.dyn_tree,n=e.max_code,s=e.stat_desc.static_tree,i=e.stat_desc.has_stree,o=e.stat_desc.extra_bits,a=e.stat_desc.extra_base,c=e.stat_desc.max_length;let h,l,u,f,g,d,p=0;for(f=0;f<=ui;f++)r.bl_count[f]=0;for(t[r.heap[r.heap_max]*2+1]=0,h=r.heap_max+1;h<Bb;h++)l=r.heap[h],f=t[t[l*2+1]*2+1]+1,f>c&&(f=c,p++),t[l*2+1]=f,!(l>n)&&(r.bl_count[f]++,g=0,l>=a&&(g=o[l-a]),d=t[l*2],r.opt_len+=d*(f+g),i&&(r.static_len+=d*(s[l*2+1]+g)));if(p!==0){do{for(f=c-1;r.bl_count[f]===0;)f--;r.bl_count[f]--,r.bl_count[f+1]+=2,r.bl_count[c]--,p-=2}while(p>0);for(f=c;f!==0;f--)for(l=r.bl_count[f];l!==0;)u=r.heap[--h],!(u>n)&&(t[u*2+1]!==f&&(r.opt_len+=(f-t[u*2+1])*t[u*2],t[u*2+1]=f),l--)}},Yb=(r,e,t)=>{const n=new Array(ui+1);let s=0,i,o;for(i=1;i<=ui;i++)s=s+t[i-1]<<1,n[i]=s;for(o=0;o<=e;o++){let a=r[o*2+1];a!==0&&(r[o*2]=Wb(n[a]++,a))}},RM=()=>{let r,e,t,n,s;const i=new Array(ui+1);for(t=0,n=0;n<h2-1;n++)for(f2[n]=t,r=0;r<1<<i0[n];r++)nc[t++]=n;for(nc[t-1]=n,s=0,n=0;n<16;n++)for(Uh[n]=s,r=0;r<1<<Vl[n];r++)rc[s++]=n;for(s>>=7;n<ao;n++)for(Uh[n]=s<<7,r=0;r<1<<Vl[n]-7;r++)rc[256+s++]=n;for(e=0;e<=ui;e++)i[e]=0;for(r=0;r<=143;)kn[r*2+1]=8,r++,i[8]++;for(;r<=255;)kn[r*2+1]=9,r++,i[9]++;for(;r<=279;)kn[r*2+1]=7,r++,i[7]++;for(;r<=287;)kn[r*2+1]=8,r++,i[8]++;for(Yb(kn,tc+1,i),r=0;r<ao;r++)La[r*2+1]=5,La[r*2]=Wb(r,5);jb=new cf(kn,i0,Tc+1,tc,ui),Hb=new cf(La,Vl,0,ao,ui),qb=new cf(new Array(0),EM,0,u2,bM)},Qb=r=>{let e;for(e=0;e<tc;e++)r.dyn_ltree[e*2]=0;for(e=0;e<ao;e++)r.dyn_dtree[e*2]=0;for(e=0;e<u2;e++)r.bl_tree[e*2]=0;r.dyn_ltree[d2*2]=1,r.opt_len=r.static_len=0,r.sym_next=r.matches=0},Xb=r=>{r.bi_valid>8?sc(r,r.bi_buf):r.bi_valid>0&&(r.pending_buf[r.pending++]=r.bi_buf),r.bi_buf=0,r.bi_valid=0},Sy=(r,e,t,n)=>{const s=e*2,i=t*2;return r[s]<r[i]||r[s]===r[i]&&n[e]<=n[t]},hf=(r,e,t)=>{const n=r.heap[t];let s=t<<1;for(;s<=r.heap_len&&(s<r.heap_len&&Sy(e,r.heap[s+1],r.heap[s],r.depth)&&s++,!Sy(e,n,r.heap[s],r.depth));)r.heap[t]=r.heap[s],t=s,s<<=1;r.heap[t]=n},Ry=(r,e,t)=>{let n,s,i=0,o,a;if(r.sym_next!==0)do n=r.pending_buf[r.sym_buf+i++]&255,n+=(r.pending_buf[r.sym_buf+i++]&255)<<8,s=r.pending_buf[r.sym_buf+i++],n===0?rn(r,s,e):(o=nc[s],rn(r,o+Tc+1,e),a=i0[o],a!==0&&(s-=f2[o],Qt(r,s,a)),n--,o=Gb(n),rn(r,o,t),a=Vl[o],a!==0&&(n-=Uh[o],Qt(r,n,a)));while(i<r.sym_next);rn(r,d2,e)},o0=(r,e)=>{const t=e.dyn_tree,n=e.stat_desc.static_tree,s=e.stat_desc.has_stree,i=e.stat_desc.elems;let o,a,c=-1,h;for(r.heap_len=0,r.heap_max=Bb,o=0;o<i;o++)t[o*2]!==0?(r.heap[++r.heap_len]=c=o,r.depth[o]=0):t[o*2+1]=0;for(;r.heap_len<2;)h=r.heap[++r.heap_len]=c<2?++c:0,t[h*2]=1,r.depth[h]=0,r.opt_len--,s&&(r.static_len-=n[h*2+1]);for(e.max_code=c,o=r.heap_len>>1;o>=1;o--)hf(r,t,o);h=i;do o=r.heap[1],r.heap[1]=r.heap[r.heap_len--],hf(r,t,1),a=r.heap[1],r.heap[--r.heap_max]=o,r.heap[--r.heap_max]=a,t[h*2]=t[o*2]+t[a*2],r.depth[h]=(r.depth[o]>=r.depth[a]?r.depth[o]:r.depth[a])+1,t[o*2+1]=t[a*2+1]=h,r.heap[1]=h++,hf(r,t,1);while(r.heap_len>=2);r.heap[--r.heap_max]=r.heap[1],SM(r,e),Yb(t,c,r.bl_count)},Ay=(r,e,t)=>{let n,s=-1,i,o=e[0*2+1],a=0,c=7,h=4;for(o===0&&(c=138,h=3),e[(t+1)*2+1]=65535,n=0;n<=t;n++)i=o,o=e[(n+1)*2+1],!(++a<c&&i===o)&&(a<h?r.bl_tree[i*2]+=a:i!==0?(i!==s&&r.bl_tree[i*2]++,r.bl_tree[zb*2]++):a<=10?r.bl_tree[Fb*2]++:r.bl_tree[Vb*2]++,a=0,s=i,o===0?(c=138,h=3):i===o?(c=6,h=3):(c=7,h=4))},Iy=(r,e,t)=>{let n,s=-1,i,o=e[0*2+1],a=0,c=7,h=4;for(o===0&&(c=138,h=3),n=0;n<=t;n++)if(i=o,o=e[(n+1)*2+1],!(++a<c&&i===o)){if(a<h)do rn(r,i,r.bl_tree);while(--a!==0);else i!==0?(i!==s&&(rn(r,i,r.bl_tree),a--),rn(r,zb,r.bl_tree),Qt(r,a-3,2)):a<=10?(rn(r,Fb,r.bl_tree),Qt(r,a-3,3)):(rn(r,Vb,r.bl_tree),Qt(r,a-11,7));a=0,s=i,o===0?(c=138,h=3):i===o?(c=6,h=3):(c=7,h=4)}},AM=r=>{let e;for(Ay(r,r.dyn_ltree,r.l_desc.max_code),Ay(r,r.dyn_dtree,r.d_desc.max_code),o0(r,r.bl_desc),e=u2-1;e>=3&&r.bl_tree[Kb[e]*2+1]===0;e--);return r.opt_len+=3*(e+1)+5+5+4,e},IM=(r,e,t,n)=>{let s;for(Qt(r,e-257,5),Qt(r,t-1,5),Qt(r,n-4,4),s=0;s<n;s++)Qt(r,r.bl_tree[Kb[s]*2+1],3);Iy(r,r.dyn_ltree,e-1),Iy(r,r.dyn_dtree,t-1)},CM=r=>{let e=4093624447,t;for(t=0;t<=31;t++,e>>>=1)if(e&1&&r.dyn_ltree[t*2]!==0)return _y;if(r.dyn_ltree[9*2]!==0||r.dyn_ltree[10*2]!==0||r.dyn_ltree[13*2]!==0)return vy;for(t=32;t<Tc;t++)if(r.dyn_ltree[t*2]!==0)return vy;return _y};let Cy=!1;const TM=r=>{Cy||(RM(),Cy=!0),r.l_desc=new lf(r.dyn_ltree,jb),r.d_desc=new lf(r.dyn_dtree,Hb),r.bl_desc=new lf(r.bl_tree,qb),r.bi_buf=0,r.bi_valid=0,Qb(r)},Jb=(r,e,t,n)=>{Qt(r,(gM<<1)+(n?1:0),3),Xb(r),sc(r,t),sc(r,~t),t&&r.pending_buf.set(r.window.subarray(e,e+t),r.pending),r.pending+=t},kM=r=>{Qt(r,Ub<<1,3),rn(r,d2,kn),vM(r)},DM=(r,e,t,n)=>{let s,i,o=0;r.level>0?(r.strm.data_type===pM&&(r.strm.data_type=CM(r)),o0(r,r.l_desc),o0(r,r.d_desc),o=AM(r),s=r.opt_len+3+7>>>3,i=r.static_len+3+7>>>3,i<=s&&(s=i)):s=i=t+5,t+4<=s&&e!==-1?Jb(r,e,t,n):r.strategy===fM||i===s?(Qt(r,(Ub<<1)+(n?1:0),3),Ry(r,kn,La)):(Qt(r,(yM<<1)+(n?1:0),3),IM(r,r.l_desc.max_code+1,r.d_desc.max_code+1,o+1),Ry(r,r.dyn_ltree,r.dyn_dtree)),Qb(r),n&&Xb(r)},PM=(r,e,t)=>(r.pending_buf[r.sym_buf+r.sym_next++]=e,r.pending_buf[r.sym_buf+r.sym_next++]=e>>8,r.pending_buf[r.sym_buf+r.sym_next++]=t,e===0?r.dyn_ltree[t*2]++:(r.matches++,e--,r.dyn_ltree[(nc[t]+Tc+1)*2]++,r.dyn_dtree[Gb(e)*2]++),r.sym_next===r.sym_end);var OM=TM,NM=Jb,xM=DM,$M=PM,LM=kM,MM={_tr_init:OM,_tr_stored_block:NM,_tr_flush_block:xM,_tr_tally:$M,_tr_align:LM};const UM=(r,e,t,n)=>{let s=r&65535|0,i=r>>>16&65535|0,o=0;for(;t!==0;){o=t>2e3?2e3:t,t-=o;do s=s+e[n++]|0,i=i+s|0;while(--o);s%=65521,i%=65521}return s|i<<16|0};var ic=UM;const BM=()=>{let r,e=[];for(var t=0;t<256;t++){r=t;for(var n=0;n<8;n++)r=r&1?3988292384^r>>>1:r>>>1;e[t]=r}return e},zM=new Uint32Array(BM()),FM=(r,e,t,n)=>{const s=zM,i=n+t;r^=-1;for(let o=n;o<i;o++)r=r>>>8^s[(r^e[o])&255];return r^-1};var ct=FM,vi={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ki={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:VM,_tr_stored_block:a0,_tr_flush_block:KM,_tr_tally:$s,_tr_align:jM}=MM,{Z_NO_FLUSH:Ls,Z_PARTIAL_FLUSH:HM,Z_FULL_FLUSH:qM,Z_FINISH:wr,Z_BLOCK:Ty,Z_OK:ft,Z_STREAM_END:ky,Z_STREAM_ERROR:on,Z_DATA_ERROR:GM,Z_BUF_ERROR:uf,Z_DEFAULT_COMPRESSION:WM,Z_FILTERED:YM,Z_HUFFMAN_ONLY:Jc,Z_RLE:QM,Z_FIXED:XM,Z_DEFAULT_STRATEGY:JM,Z_UNKNOWN:ZM,Z_DEFLATED:dd}=ki,eU=9,tU=15,rU=8,nU=29,sU=256,c0=sU+1+nU,iU=30,oU=19,aU=2*c0+1,cU=15,ae=3,Ds=258,an=Ds+ae+1,lU=32,mo=42,p2=57,l0=69,h0=73,u0=91,d0=103,di=113,Ra=666,Ht=1,No=2,Si=3,xo=4,hU=3,fi=(r,e)=>(r.msg=vi[e],e),Dy=r=>r*2-(r>4?9:0),Cs=r=>{let e=r.length;for(;--e>=0;)r[e]=0},uU=r=>{let e,t,n,s=r.w_size;e=r.hash_size,n=e;do t=r.head[--n],r.head[n]=t>=s?t-s:0;while(--e);e=s,n=e;do t=r.prev[--n],r.prev[n]=t>=s?t-s:0;while(--e)};let dU=(r,e,t)=>(e<<r.hash_shift^t)&r.hash_mask,Ms=dU;const nr=r=>{const e=r.state;let t=e.pending;t>r.avail_out&&(t=r.avail_out),t!==0&&(r.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+t),r.next_out),r.next_out+=t,e.pending_out+=t,r.total_out+=t,r.avail_out-=t,e.pending-=t,e.pending===0&&(e.pending_out=0))},ir=(r,e)=>{KM(r,r.block_start>=0?r.block_start:-1,r.strstart-r.block_start,e),r.block_start=r.strstart,nr(r.strm)},ge=(r,e)=>{r.pending_buf[r.pending++]=e},ta=(r,e)=>{r.pending_buf[r.pending++]=e>>>8&255,r.pending_buf[r.pending++]=e&255},f0=(r,e,t,n)=>{let s=r.avail_in;return s>n&&(s=n),s===0?0:(r.avail_in-=s,e.set(r.input.subarray(r.next_in,r.next_in+s),t),r.state.wrap===1?r.adler=ic(r.adler,e,s,t):r.state.wrap===2&&(r.adler=ct(r.adler,e,s,t)),r.next_in+=s,r.total_in+=s,s)},Zb=(r,e)=>{let t=r.max_chain_length,n=r.strstart,s,i,o=r.prev_length,a=r.nice_match;const c=r.strstart>r.w_size-an?r.strstart-(r.w_size-an):0,h=r.window,l=r.w_mask,u=r.prev,f=r.strstart+Ds;let g=h[n+o-1],d=h[n+o];r.prev_length>=r.good_match&&(t>>=2),a>r.lookahead&&(a=r.lookahead);do if(s=e,!(h[s+o]!==d||h[s+o-1]!==g||h[s]!==h[n]||h[++s]!==h[n+1])){n+=2,s++;do;while(h[++n]===h[++s]&&h[++n]===h[++s]&&h[++n]===h[++s]&&h[++n]===h[++s]&&h[++n]===h[++s]&&h[++n]===h[++s]&&h[++n]===h[++s]&&h[++n]===h[++s]&&n<f);if(i=Ds-(f-n),n=f-Ds,i>o){if(r.match_start=e,o=i,i>=a)break;g=h[n+o-1],d=h[n+o]}}while((e=u[e&l])>c&&--t!==0);return o<=r.lookahead?o:r.lookahead},bo=r=>{const e=r.w_size;let t,n,s;do{if(n=r.window_size-r.lookahead-r.strstart,r.strstart>=e+(e-an)&&(r.window.set(r.window.subarray(e,e+e-n),0),r.match_start-=e,r.strstart-=e,r.block_start-=e,r.insert>r.strstart&&(r.insert=r.strstart),uU(r),n+=e),r.strm.avail_in===0)break;if(t=f0(r.strm,r.window,r.strstart+r.lookahead,n),r.lookahead+=t,r.lookahead+r.insert>=ae)for(s=r.strstart-r.insert,r.ins_h=r.window[s],r.ins_h=Ms(r,r.ins_h,r.window[s+1]);r.insert&&(r.ins_h=Ms(r,r.ins_h,r.window[s+ae-1]),r.prev[s&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=s,s++,r.insert--,!(r.lookahead+r.insert<ae)););}while(r.lookahead<an&&r.strm.avail_in!==0)},e7=(r,e)=>{let t=r.pending_buf_size-5>r.w_size?r.w_size:r.pending_buf_size-5,n,s,i,o=0,a=r.strm.avail_in;do{if(n=65535,i=r.bi_valid+42>>3,r.strm.avail_out<i||(i=r.strm.avail_out-i,s=r.strstart-r.block_start,n>s+r.strm.avail_in&&(n=s+r.strm.avail_in),n>i&&(n=i),n<t&&(n===0&&e!==wr||e===Ls||n!==s+r.strm.avail_in)))break;o=e===wr&&n===s+r.strm.avail_in?1:0,a0(r,0,0,o),r.pending_buf[r.pending-4]=n,r.pending_buf[r.pending-3]=n>>8,r.pending_buf[r.pending-2]=~n,r.pending_buf[r.pending-1]=~n>>8,nr(r.strm),s&&(s>n&&(s=n),r.strm.output.set(r.window.subarray(r.block_start,r.block_start+s),r.strm.next_out),r.strm.next_out+=s,r.strm.avail_out-=s,r.strm.total_out+=s,r.block_start+=s,n-=s),n&&(f0(r.strm,r.strm.output,r.strm.next_out,n),r.strm.next_out+=n,r.strm.avail_out-=n,r.strm.total_out+=n)}while(o===0);return a-=r.strm.avail_in,a&&(a>=r.w_size?(r.matches=2,r.window.set(r.strm.input.subarray(r.strm.next_in-r.w_size,r.strm.next_in),0),r.strstart=r.w_size,r.insert=r.strstart):(r.window_size-r.strstart<=a&&(r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,r.insert>r.strstart&&(r.insert=r.strstart)),r.window.set(r.strm.input.subarray(r.strm.next_in-a,r.strm.next_in),r.strstart),r.strstart+=a,r.insert+=a>r.w_size-r.insert?r.w_size-r.insert:a),r.block_start=r.strstart),r.high_water<r.strstart&&(r.high_water=r.strstart),o?xo:e!==Ls&&e!==wr&&r.strm.avail_in===0&&r.strstart===r.block_start?No:(i=r.window_size-r.strstart,r.strm.avail_in>i&&r.block_start>=r.w_size&&(r.block_start-=r.w_size,r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,i+=r.w_size,r.insert>r.strstart&&(r.insert=r.strstart)),i>r.strm.avail_in&&(i=r.strm.avail_in),i&&(f0(r.strm,r.window,r.strstart,i),r.strstart+=i,r.insert+=i>r.w_size-r.insert?r.w_size-r.insert:i),r.high_water<r.strstart&&(r.high_water=r.strstart),i=r.bi_valid+42>>3,i=r.pending_buf_size-i>65535?65535:r.pending_buf_size-i,t=i>r.w_size?r.w_size:i,s=r.strstart-r.block_start,(s>=t||(s||e===wr)&&e!==Ls&&r.strm.avail_in===0&&s<=i)&&(n=s>i?i:s,o=e===wr&&r.strm.avail_in===0&&n===s?1:0,a0(r,r.block_start,n,o),r.block_start+=n,nr(r.strm)),o?Si:Ht)},df=(r,e)=>{let t,n;for(;;){if(r.lookahead<an){if(bo(r),r.lookahead<an&&e===Ls)return Ht;if(r.lookahead===0)break}if(t=0,r.lookahead>=ae&&(r.ins_h=Ms(r,r.ins_h,r.window[r.strstart+ae-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),t!==0&&r.strstart-t<=r.w_size-an&&(r.match_length=Zb(r,t)),r.match_length>=ae)if(n=$s(r,r.strstart-r.match_start,r.match_length-ae),r.lookahead-=r.match_length,r.match_length<=r.max_lazy_match&&r.lookahead>=ae){r.match_length--;do r.strstart++,r.ins_h=Ms(r,r.ins_h,r.window[r.strstart+ae-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart;while(--r.match_length!==0);r.strstart++}else r.strstart+=r.match_length,r.match_length=0,r.ins_h=r.window[r.strstart],r.ins_h=Ms(r,r.ins_h,r.window[r.strstart+1]);else n=$s(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++;if(n&&(ir(r,!1),r.strm.avail_out===0))return Ht}return r.insert=r.strstart<ae-1?r.strstart:ae-1,e===wr?(ir(r,!0),r.strm.avail_out===0?Si:xo):r.sym_next&&(ir(r,!1),r.strm.avail_out===0)?Ht:No},Ui=(r,e)=>{let t,n,s;for(;;){if(r.lookahead<an){if(bo(r),r.lookahead<an&&e===Ls)return Ht;if(r.lookahead===0)break}if(t=0,r.lookahead>=ae&&(r.ins_h=Ms(r,r.ins_h,r.window[r.strstart+ae-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),r.prev_length=r.match_length,r.prev_match=r.match_start,r.match_length=ae-1,t!==0&&r.prev_length<r.max_lazy_match&&r.strstart-t<=r.w_size-an&&(r.match_length=Zb(r,t),r.match_length<=5&&(r.strategy===YM||r.match_length===ae&&r.strstart-r.match_start>4096)&&(r.match_length=ae-1)),r.prev_length>=ae&&r.match_length<=r.prev_length){s=r.strstart+r.lookahead-ae,n=$s(r,r.strstart-1-r.prev_match,r.prev_length-ae),r.lookahead-=r.prev_length-1,r.prev_length-=2;do++r.strstart<=s&&(r.ins_h=Ms(r,r.ins_h,r.window[r.strstart+ae-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart);while(--r.prev_length!==0);if(r.match_available=0,r.match_length=ae-1,r.strstart++,n&&(ir(r,!1),r.strm.avail_out===0))return Ht}else if(r.match_available){if(n=$s(r,0,r.window[r.strstart-1]),n&&ir(r,!1),r.strstart++,r.lookahead--,r.strm.avail_out===0)return Ht}else r.match_available=1,r.strstart++,r.lookahead--}return r.match_available&&(n=$s(r,0,r.window[r.strstart-1]),r.match_available=0),r.insert=r.strstart<ae-1?r.strstart:ae-1,e===wr?(ir(r,!0),r.strm.avail_out===0?Si:xo):r.sym_next&&(ir(r,!1),r.strm.avail_out===0)?Ht:No},fU=(r,e)=>{let t,n,s,i;const o=r.window;for(;;){if(r.lookahead<=Ds){if(bo(r),r.lookahead<=Ds&&e===Ls)return Ht;if(r.lookahead===0)break}if(r.match_length=0,r.lookahead>=ae&&r.strstart>0&&(s=r.strstart-1,n=o[s],n===o[++s]&&n===o[++s]&&n===o[++s])){i=r.strstart+Ds;do;while(n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&s<i);r.match_length=Ds-(i-s),r.match_length>r.lookahead&&(r.match_length=r.lookahead)}if(r.match_length>=ae?(t=$s(r,1,r.match_length-ae),r.lookahead-=r.match_length,r.strstart+=r.match_length,r.match_length=0):(t=$s(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++),t&&(ir(r,!1),r.strm.avail_out===0))return Ht}return r.insert=0,e===wr?(ir(r,!0),r.strm.avail_out===0?Si:xo):r.sym_next&&(ir(r,!1),r.strm.avail_out===0)?Ht:No},pU=(r,e)=>{let t;for(;;){if(r.lookahead===0&&(bo(r),r.lookahead===0)){if(e===Ls)return Ht;break}if(r.match_length=0,t=$s(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++,t&&(ir(r,!1),r.strm.avail_out===0))return Ht}return r.insert=0,e===wr?(ir(r,!0),r.strm.avail_out===0?Si:xo):r.sym_next&&(ir(r,!1),r.strm.avail_out===0)?Ht:No};function Vr(r,e,t,n,s){this.good_length=r,this.max_lazy=e,this.nice_length=t,this.max_chain=n,this.func=s}const Aa=[new Vr(0,0,0,0,e7),new Vr(4,4,8,4,df),new Vr(4,5,16,8,df),new Vr(4,6,32,32,df),new Vr(4,4,16,16,Ui),new Vr(8,16,32,32,Ui),new Vr(8,16,128,128,Ui),new Vr(8,32,128,256,Ui),new Vr(32,128,258,1024,Ui),new Vr(32,258,258,4096,Ui)],gU=r=>{r.window_size=2*r.w_size,Cs(r.head),r.max_lazy_match=Aa[r.level].max_lazy,r.good_match=Aa[r.level].good_length,r.nice_match=Aa[r.level].nice_length,r.max_chain_length=Aa[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=ae-1,r.match_available=0,r.ins_h=0};function yU(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=dd,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(aU*2),this.dyn_dtree=new Uint16Array((2*iU+1)*2),this.bl_tree=new Uint16Array((2*oU+1)*2),Cs(this.dyn_ltree),Cs(this.dyn_dtree),Cs(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(cU+1),this.heap=new Uint16Array(2*c0+1),Cs(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*c0+1),Cs(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const kc=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.status!==mo&&e.status!==p2&&e.status!==l0&&e.status!==h0&&e.status!==u0&&e.status!==d0&&e.status!==di&&e.status!==Ra?1:0},t7=r=>{if(kc(r))return fi(r,on);r.total_in=r.total_out=0,r.data_type=ZM;const e=r.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?p2:e.wrap?mo:di,r.adler=e.wrap===2?0:1,e.last_flush=-2,VM(e),ft},r7=r=>{const e=t7(r);return e===ft&&gU(r.state),e},wU=(r,e)=>kc(r)||r.state.wrap!==2?on:(r.state.gzhead=e,ft),n7=(r,e,t,n,s,i)=>{if(!r)return on;let o=1;if(e===WM&&(e=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),s<1||s>eU||t!==dd||n<8||n>15||e<0||e>9||i<0||i>XM||n===8&&o!==1)return fi(r,on);n===8&&(n=9);const a=new yU;return r.state=a,a.strm=r,a.status=mo,a.wrap=o,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+ae-1)/ae),a.window=new Uint8Array(a.w_size*2),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=a.lit_bufsize*4,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=(a.lit_bufsize-1)*3,a.level=e,a.strategy=i,a.method=t,r7(r)},mU=(r,e)=>n7(r,e,dd,tU,rU,JM),bU=(r,e)=>{if(kc(r)||e>Ty||e<0)return r?fi(r,on):on;const t=r.state;if(!r.output||r.avail_in!==0&&!r.input||t.status===Ra&&e!==wr)return fi(r,r.avail_out===0?uf:on);const n=t.last_flush;if(t.last_flush=e,t.pending!==0){if(nr(r),r.avail_out===0)return t.last_flush=-1,ft}else if(r.avail_in===0&&Dy(e)<=Dy(n)&&e!==wr)return fi(r,uf);if(t.status===Ra&&r.avail_in!==0)return fi(r,uf);if(t.status===mo&&t.wrap===0&&(t.status=di),t.status===mo){let s=dd+(t.w_bits-8<<4)<<8,i=-1;if(t.strategy>=Jc||t.level<2?i=0:t.level<6?i=1:t.level===6?i=2:i=3,s|=i<<6,t.strstart!==0&&(s|=lU),s+=31-s%31,ta(t,s),t.strstart!==0&&(ta(t,r.adler>>>16),ta(t,r.adler&65535)),r.adler=1,t.status=di,nr(r),t.pending!==0)return t.last_flush=-1,ft}if(t.status===p2){if(r.adler=0,ge(t,31),ge(t,139),ge(t,8),t.gzhead)ge(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),ge(t,t.gzhead.time&255),ge(t,t.gzhead.time>>8&255),ge(t,t.gzhead.time>>16&255),ge(t,t.gzhead.time>>24&255),ge(t,t.level===9?2:t.strategy>=Jc||t.level<2?4:0),ge(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(ge(t,t.gzhead.extra.length&255),ge(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(r.adler=ct(r.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=l0;else if(ge(t,0),ge(t,0),ge(t,0),ge(t,0),ge(t,0),ge(t,t.level===9?2:t.strategy>=Jc||t.level<2?4:0),ge(t,hU),t.status=di,nr(r),t.pending!==0)return t.last_flush=-1,ft}if(t.status===l0){if(t.gzhead.extra){let s=t.pending,i=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+i>t.pending_buf_size;){let a=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+a),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex+=a,nr(r),t.pending!==0)return t.last_flush=-1,ft;s=0,i-=a}let o=new Uint8Array(t.gzhead.extra);t.pending_buf.set(o.subarray(t.gzindex,t.gzindex+i),t.pending),t.pending+=i,t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=h0}if(t.status===h0){if(t.gzhead.name){let s=t.pending,i;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),nr(r),t.pending!==0)return t.last_flush=-1,ft;s=0}t.gzindex<t.gzhead.name.length?i=t.gzhead.name.charCodeAt(t.gzindex++)&255:i=0,ge(t,i)}while(i!==0);t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=u0}if(t.status===u0){if(t.gzhead.comment){let s=t.pending,i;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),nr(r),t.pending!==0)return t.last_flush=-1,ft;s=0}t.gzindex<t.gzhead.comment.length?i=t.gzhead.comment.charCodeAt(t.gzindex++)&255:i=0,ge(t,i)}while(i!==0);t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s))}t.status=d0}if(t.status===d0){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(nr(r),t.pending!==0))return t.last_flush=-1,ft;ge(t,r.adler&255),ge(t,r.adler>>8&255),r.adler=0}if(t.status=di,nr(r),t.pending!==0)return t.last_flush=-1,ft}if(r.avail_in!==0||t.lookahead!==0||e!==Ls&&t.status!==Ra){let s=t.level===0?e7(t,e):t.strategy===Jc?pU(t,e):t.strategy===QM?fU(t,e):Aa[t.level].func(t,e);if((s===Si||s===xo)&&(t.status=Ra),s===Ht||s===Si)return r.avail_out===0&&(t.last_flush=-1),ft;if(s===No&&(e===HM?jM(t):e!==Ty&&(a0(t,0,0,!1),e===qM&&(Cs(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),nr(r),r.avail_out===0))return t.last_flush=-1,ft}return e!==wr?ft:t.wrap<=0?ky:(t.wrap===2?(ge(t,r.adler&255),ge(t,r.adler>>8&255),ge(t,r.adler>>16&255),ge(t,r.adler>>24&255),ge(t,r.total_in&255),ge(t,r.total_in>>8&255),ge(t,r.total_in>>16&255),ge(t,r.total_in>>24&255)):(ta(t,r.adler>>>16),ta(t,r.adler&65535)),nr(r),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?ft:ky)},EU=r=>{if(kc(r))return on;const e=r.state.status;return r.state=null,e===di?fi(r,GM):ft},_U=(r,e)=>{let t=e.length;if(kc(r))return on;const n=r.state,s=n.wrap;if(s===2||s===1&&n.status!==mo||n.lookahead)return on;if(s===1&&(r.adler=ic(r.adler,e,t,0)),n.wrap=0,t>=n.w_size){s===0&&(Cs(n.head),n.strstart=0,n.block_start=0,n.insert=0);let c=new Uint8Array(n.w_size);c.set(e.subarray(t-n.w_size,t),0),e=c,t=n.w_size}const i=r.avail_in,o=r.next_in,a=r.input;for(r.avail_in=t,r.next_in=0,r.input=e,bo(n);n.lookahead>=ae;){let c=n.strstart,h=n.lookahead-(ae-1);do n.ins_h=Ms(n,n.ins_h,n.window[c+ae-1]),n.prev[c&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=c,c++;while(--h);n.strstart=c,n.lookahead=ae-1,bo(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=ae-1,n.match_available=0,r.next_in=o,r.input=a,r.avail_in=i,n.wrap=s,ft};var vU=mU,SU=n7,RU=r7,AU=t7,IU=wU,CU=bU,TU=EU,kU=_U,DU="pako deflate (from Nodeca project)",Ma={deflateInit:vU,deflateInit2:SU,deflateReset:RU,deflateResetKeep:AU,deflateSetHeader:IU,deflate:CU,deflateEnd:TU,deflateSetDictionary:kU,deflateInfo:DU};const PU=(r,e)=>Object.prototype.hasOwnProperty.call(r,e);var OU=function(r){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const t=e.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const n in t)PU(t,n)&&(r[n]=t[n])}}return r},NU=r=>{let e=0;for(let n=0,s=r.length;n<s;n++)e+=r[n].length;const t=new Uint8Array(e);for(let n=0,s=0,i=r.length;n<i;n++){let o=r[n];t.set(o,s),s+=o.length}return t},fd={assign:OU,flattenChunks:NU};let s7=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{s7=!1}const oc=new Uint8Array(256);for(let r=0;r<256;r++)oc[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;oc[254]=oc[254]=1;var xU=r=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(r);let e,t,n,s,i,o=r.length,a=0;for(s=0;s<o;s++)t=r.charCodeAt(s),(t&64512)===55296&&s+1<o&&(n=r.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),a+=t<128?1:t<2048?2:t<65536?3:4;for(e=new Uint8Array(a),i=0,s=0;i<a;s++)t=r.charCodeAt(s),(t&64512)===55296&&s+1<o&&(n=r.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),t<128?e[i++]=t:t<2048?(e[i++]=192|t>>>6,e[i++]=128|t&63):t<65536?(e[i++]=224|t>>>12,e[i++]=128|t>>>6&63,e[i++]=128|t&63):(e[i++]=240|t>>>18,e[i++]=128|t>>>12&63,e[i++]=128|t>>>6&63,e[i++]=128|t&63);return e};const $U=(r,e)=>{if(e<65534&&r.subarray&&s7)return String.fromCharCode.apply(null,r.length===e?r:r.subarray(0,e));let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(r[n]);return t};var LU=(r,e)=>{const t=e||r.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(r.subarray(0,e));let n,s;const i=new Array(t*2);for(s=0,n=0;n<t;){let o=r[n++];if(o<128){i[s++]=o;continue}let a=oc[o];if(a>4){i[s++]=65533,n+=a-1;continue}for(o&=a===2?31:a===3?15:7;a>1&&n<t;)o=o<<6|r[n++]&63,a--;if(a>1){i[s++]=65533;continue}o<65536?i[s++]=o:(o-=65536,i[s++]=55296|o>>10&1023,i[s++]=56320|o&1023)}return $U(i,s)},MU=(r,e)=>{e=e||r.length,e>r.length&&(e=r.length);let t=e-1;for(;t>=0&&(r[t]&192)===128;)t--;return t<0||t===0?e:t+oc[r[t]]>e?t:e},ac={string2buf:xU,buf2string:LU,utf8border:MU};function UU(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var i7=UU;const o7=Object.prototype.toString,{Z_NO_FLUSH:BU,Z_SYNC_FLUSH:zU,Z_FULL_FLUSH:FU,Z_FINISH:VU,Z_OK:Bh,Z_STREAM_END:KU,Z_DEFAULT_COMPRESSION:jU,Z_DEFAULT_STRATEGY:HU,Z_DEFLATED:qU}=ki;function Dc(r){this.options=fd.assign({level:jU,method:qU,chunkSize:16384,windowBits:15,memLevel:8,strategy:HU},r||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new i7,this.strm.avail_out=0;let t=Ma.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(t!==Bh)throw new Error(vi[t]);if(e.header&&Ma.deflateSetHeader(this.strm,e.header),e.dictionary){let n;if(typeof e.dictionary=="string"?n=ac.string2buf(e.dictionary):o7.call(e.dictionary)==="[object ArrayBuffer]"?n=new Uint8Array(e.dictionary):n=e.dictionary,t=Ma.deflateSetDictionary(this.strm,n),t!==Bh)throw new Error(vi[t]);this._dict_set=!0}}Dc.prototype.push=function(r,e){const t=this.strm,n=this.options.chunkSize;let s,i;if(this.ended)return!1;for(e===~~e?i=e:i=e===!0?VU:BU,typeof r=="string"?t.input=ac.string2buf(r):o7.call(r)==="[object ArrayBuffer]"?t.input=new Uint8Array(r):t.input=r,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),(i===zU||i===FU)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(s=Ma.deflate(t,i),s===KU)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),s=Ma.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===Bh;if(t.avail_out===0){this.onData(t.output);continue}if(i>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0};Dc.prototype.onData=function(r){this.chunks.push(r)};Dc.prototype.onEnd=function(r){r===Bh&&(this.result=fd.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};function g2(r,e){const t=new Dc(e);if(t.push(r,!0),t.err)throw t.msg||vi[t.err];return t.result}function GU(r,e){return e=e||{},e.raw=!0,g2(r,e)}function WU(r,e){return e=e||{},e.gzip=!0,g2(r,e)}var YU=Dc,QU=g2,XU=GU,JU=WU,ZU=ki,eB={Deflate:YU,deflate:QU,deflateRaw:XU,gzip:JU,constants:ZU};const Zc=16209,tB=16191;var rB=function(e,t){let n,s,i,o,a,c,h,l,u,f,g,d,p,w,y,_,m,b,S,A,E,I,C,D;const $=e.state;n=e.next_in,C=e.input,s=n+(e.avail_in-5),i=e.next_out,D=e.output,o=i-(t-e.avail_out),a=i+(e.avail_out-257),c=$.dmax,h=$.wsize,l=$.whave,u=$.wnext,f=$.window,g=$.hold,d=$.bits,p=$.lencode,w=$.distcode,y=(1<<$.lenbits)-1,_=(1<<$.distbits)-1;e:do{d<15&&(g+=C[n++]<<d,d+=8,g+=C[n++]<<d,d+=8),m=p[g&y];t:for(;;){if(b=m>>>24,g>>>=b,d-=b,b=m>>>16&255,b===0)D[i++]=m&65535;else if(b&16){S=m&65535,b&=15,b&&(d<b&&(g+=C[n++]<<d,d+=8),S+=g&(1<<b)-1,g>>>=b,d-=b),d<15&&(g+=C[n++]<<d,d+=8,g+=C[n++]<<d,d+=8),m=w[g&_];r:for(;;){if(b=m>>>24,g>>>=b,d-=b,b=m>>>16&255,b&16){if(A=m&65535,b&=15,d<b&&(g+=C[n++]<<d,d+=8,d<b&&(g+=C[n++]<<d,d+=8)),A+=g&(1<<b)-1,A>c){e.msg="invalid distance too far back",$.mode=Zc;break e}if(g>>>=b,d-=b,b=i-o,A>b){if(b=A-b,b>l&&$.sane){e.msg="invalid distance too far back",$.mode=Zc;break e}if(E=0,I=f,u===0){if(E+=h-b,b<S){S-=b;do D[i++]=f[E++];while(--b);E=i-A,I=D}}else if(u<b){if(E+=h+u-b,b-=u,b<S){S-=b;do D[i++]=f[E++];while(--b);if(E=0,u<S){b=u,S-=b;do D[i++]=f[E++];while(--b);E=i-A,I=D}}}else if(E+=u-b,b<S){S-=b;do D[i++]=f[E++];while(--b);E=i-A,I=D}for(;S>2;)D[i++]=I[E++],D[i++]=I[E++],D[i++]=I[E++],S-=3;S&&(D[i++]=I[E++],S>1&&(D[i++]=I[E++]))}else{E=i-A;do D[i++]=D[E++],D[i++]=D[E++],D[i++]=D[E++],S-=3;while(S>2);S&&(D[i++]=D[E++],S>1&&(D[i++]=D[E++]))}}else if(b&64){e.msg="invalid distance code",$.mode=Zc;break e}else{m=w[(m&65535)+(g&(1<<b)-1)];continue r}break}}else if(b&64)if(b&32){$.mode=tB;break e}else{e.msg="invalid literal/length code",$.mode=Zc;break e}else{m=p[(m&65535)+(g&(1<<b)-1)];continue t}break}}while(n<s&&i<a);S=d>>3,n-=S,d-=S<<3,g&=(1<<d)-1,e.next_in=n,e.next_out=i,e.avail_in=n<s?5+(s-n):5-(n-s),e.avail_out=i<a?257+(a-i):257-(i-a),$.hold=g,$.bits=d};const Bi=15,Py=852,Oy=592,Ny=0,ff=1,xy=2,nB=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),sB=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),iB=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),oB=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),aB=(r,e,t,n,s,i,o,a)=>{const c=a.bits;let h=0,l=0,u=0,f=0,g=0,d=0,p=0,w=0,y=0,_=0,m,b,S,A,E,I=null,C;const D=new Uint16Array(Bi+1),$=new Uint16Array(Bi+1);let K=null,W,Q,V;for(h=0;h<=Bi;h++)D[h]=0;for(l=0;l<n;l++)D[e[t+l]]++;for(g=c,f=Bi;f>=1&&D[f]===0;f--);if(g>f&&(g=f),f===0)return s[i++]=1<<24|64<<16|0,s[i++]=1<<24|64<<16|0,a.bits=1,0;for(u=1;u<f&&D[u]===0;u++);for(g<u&&(g=u),w=1,h=1;h<=Bi;h++)if(w<<=1,w-=D[h],w<0)return-1;if(w>0&&(r===Ny||f!==1))return-1;for($[1]=0,h=1;h<Bi;h++)$[h+1]=$[h]+D[h];for(l=0;l<n;l++)e[t+l]!==0&&(o[$[e[t+l]]++]=l);if(r===Ny?(I=K=o,C=20):r===ff?(I=nB,K=sB,C=257):(I=iB,K=oB,C=0),_=0,l=0,h=u,E=i,d=g,p=0,S=-1,y=1<<g,A=y-1,r===ff&&y>Py||r===xy&&y>Oy)return 1;for(;;){W=h-p,o[l]+1<C?(Q=0,V=o[l]):o[l]>=C?(Q=K[o[l]-C],V=I[o[l]-C]):(Q=32+64,V=0),m=1<<h-p,b=1<<d,u=b;do b-=m,s[E+(_>>p)+b]=W<<24|Q<<16|V|0;while(b!==0);for(m=1<<h-1;_&m;)m>>=1;if(m!==0?(_&=m-1,_+=m):_=0,l++,--D[h]===0){if(h===f)break;h=e[t+o[l]]}if(h>g&&(_&A)!==S){for(p===0&&(p=g),E+=u,d=h-p,w=1<<d;d+p<f&&(w-=D[d+p],!(w<=0));)d++,w<<=1;if(y+=1<<d,r===ff&&y>Py||r===xy&&y>Oy)return 1;S=_&A,s[S]=g<<24|d<<16|E-i|0}}return _!==0&&(s[E+_]=h-p<<24|64<<16|0),a.bits=g,0};var Ua=aB;const cB=0,a7=1,c7=2,{Z_FINISH:$y,Z_BLOCK:lB,Z_TREES:el,Z_OK:Ri,Z_STREAM_END:hB,Z_NEED_DICT:uB,Z_STREAM_ERROR:Sr,Z_DATA_ERROR:l7,Z_MEM_ERROR:h7,Z_BUF_ERROR:dB,Z_DEFLATED:Ly}=ki,pd=16180,My=16181,Uy=16182,By=16183,zy=16184,Fy=16185,Vy=16186,Ky=16187,jy=16188,Hy=16189,zh=16190,bn=16191,pf=16192,qy=16193,gf=16194,Gy=16195,Wy=16196,Yy=16197,Qy=16198,tl=16199,rl=16200,Xy=16201,Jy=16202,Zy=16203,e5=16204,t5=16205,yf=16206,r5=16207,n5=16208,Oe=16209,u7=16210,d7=16211,fB=852,pB=592,gB=15,yB=gB,s5=r=>(r>>>24&255)+(r>>>8&65280)+((r&65280)<<8)+((r&255)<<24);function wB(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Di=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.mode<pd||e.mode>d7?1:0},f7=r=>{if(Di(r))return Sr;const e=r.state;return r.total_in=r.total_out=e.total=0,r.msg="",e.wrap&&(r.adler=e.wrap&1),e.mode=pd,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(fB),e.distcode=e.distdyn=new Int32Array(pB),e.sane=1,e.back=-1,Ri},p7=r=>{if(Di(r))return Sr;const e=r.state;return e.wsize=0,e.whave=0,e.wnext=0,f7(r)},g7=(r,e)=>{let t;if(Di(r))return Sr;const n=r.state;return e<0?(t=0,e=-e):(t=(e>>4)+5,e<48&&(e&=15)),e&&(e<8||e>15)?Sr:(n.window!==null&&n.wbits!==e&&(n.window=null),n.wrap=t,n.wbits=e,p7(r))},y7=(r,e)=>{if(!r)return Sr;const t=new wB;r.state=t,t.strm=r,t.window=null,t.mode=pd;const n=g7(r,e);return n!==Ri&&(r.state=null),n},mB=r=>y7(r,yB);let i5=!0,wf,mf;const bB=r=>{if(i5){wf=new Int32Array(512),mf=new Int32Array(32);let e=0;for(;e<144;)r.lens[e++]=8;for(;e<256;)r.lens[e++]=9;for(;e<280;)r.lens[e++]=7;for(;e<288;)r.lens[e++]=8;for(Ua(a7,r.lens,0,288,wf,0,r.work,{bits:9}),e=0;e<32;)r.lens[e++]=5;Ua(c7,r.lens,0,32,mf,0,r.work,{bits:5}),i5=!1}r.lencode=wf,r.lenbits=9,r.distcode=mf,r.distbits=5},w7=(r,e,t,n)=>{let s;const i=r.state;return i.window===null&&(i.wsize=1<<i.wbits,i.wnext=0,i.whave=0,i.window=new Uint8Array(i.wsize)),n>=i.wsize?(i.window.set(e.subarray(t-i.wsize,t),0),i.wnext=0,i.whave=i.wsize):(s=i.wsize-i.wnext,s>n&&(s=n),i.window.set(e.subarray(t-n,t-n+s),i.wnext),n-=s,n?(i.window.set(e.subarray(t-n,t),0),i.wnext=n,i.whave=i.wsize):(i.wnext+=s,i.wnext===i.wsize&&(i.wnext=0),i.whave<i.wsize&&(i.whave+=s))),0},EB=(r,e)=>{let t,n,s,i,o,a,c,h,l,u,f,g,d,p,w=0,y,_,m,b,S,A,E,I;const C=new Uint8Array(4);let D,$;const K=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Di(r)||!r.output||!r.input&&r.avail_in!==0)return Sr;t=r.state,t.mode===bn&&(t.mode=pf),o=r.next_out,s=r.output,c=r.avail_out,i=r.next_in,n=r.input,a=r.avail_in,h=t.hold,l=t.bits,u=a,f=c,I=Ri;e:for(;;)switch(t.mode){case pd:if(t.wrap===0){t.mode=pf;break}for(;l<16;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(t.wrap&2&&h===35615){t.wbits===0&&(t.wbits=15),t.check=0,C[0]=h&255,C[1]=h>>>8&255,t.check=ct(t.check,C,2,0),h=0,l=0,t.mode=My;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((h&255)<<8)+(h>>8))%31){r.msg="incorrect header check",t.mode=Oe;break}if((h&15)!==Ly){r.msg="unknown compression method",t.mode=Oe;break}if(h>>>=4,l-=4,E=(h&15)+8,t.wbits===0&&(t.wbits=E),E>15||E>t.wbits){r.msg="invalid window size",t.mode=Oe;break}t.dmax=1<<t.wbits,t.flags=0,r.adler=t.check=1,t.mode=h&512?Hy:bn,h=0,l=0;break;case My:for(;l<16;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(t.flags=h,(t.flags&255)!==Ly){r.msg="unknown compression method",t.mode=Oe;break}if(t.flags&57344){r.msg="unknown header flags set",t.mode=Oe;break}t.head&&(t.head.text=h>>8&1),t.flags&512&&t.wrap&4&&(C[0]=h&255,C[1]=h>>>8&255,t.check=ct(t.check,C,2,0)),h=0,l=0,t.mode=Uy;case Uy:for(;l<32;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}t.head&&(t.head.time=h),t.flags&512&&t.wrap&4&&(C[0]=h&255,C[1]=h>>>8&255,C[2]=h>>>16&255,C[3]=h>>>24&255,t.check=ct(t.check,C,4,0)),h=0,l=0,t.mode=By;case By:for(;l<16;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}t.head&&(t.head.xflags=h&255,t.head.os=h>>8),t.flags&512&&t.wrap&4&&(C[0]=h&255,C[1]=h>>>8&255,t.check=ct(t.check,C,2,0)),h=0,l=0,t.mode=zy;case zy:if(t.flags&1024){for(;l<16;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}t.length=h,t.head&&(t.head.extra_len=h),t.flags&512&&t.wrap&4&&(C[0]=h&255,C[1]=h>>>8&255,t.check=ct(t.check,C,2,0)),h=0,l=0}else t.head&&(t.head.extra=null);t.mode=Fy;case Fy:if(t.flags&1024&&(g=t.length,g>a&&(g=a),g&&(t.head&&(E=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(n.subarray(i,i+g),E)),t.flags&512&&t.wrap&4&&(t.check=ct(t.check,n,g,i)),a-=g,i+=g,t.length-=g),t.length))break e;t.length=0,t.mode=Vy;case Vy:if(t.flags&2048){if(a===0)break e;g=0;do E=n[i+g++],t.head&&E&&t.length<65536&&(t.head.name+=String.fromCharCode(E));while(E&&g<a);if(t.flags&512&&t.wrap&4&&(t.check=ct(t.check,n,g,i)),a-=g,i+=g,E)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=Ky;case Ky:if(t.flags&4096){if(a===0)break e;g=0;do E=n[i+g++],t.head&&E&&t.length<65536&&(t.head.comment+=String.fromCharCode(E));while(E&&g<a);if(t.flags&512&&t.wrap&4&&(t.check=ct(t.check,n,g,i)),a-=g,i+=g,E)break e}else t.head&&(t.head.comment=null);t.mode=jy;case jy:if(t.flags&512){for(;l<16;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(t.wrap&4&&h!==(t.check&65535)){r.msg="header crc mismatch",t.mode=Oe;break}h=0,l=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),r.adler=t.check=0,t.mode=bn;break;case Hy:for(;l<32;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}r.adler=t.check=s5(h),h=0,l=0,t.mode=zh;case zh:if(t.havedict===0)return r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=h,t.bits=l,uB;r.adler=t.check=1,t.mode=bn;case bn:if(e===lB||e===el)break e;case pf:if(t.last){h>>>=l&7,l-=l&7,t.mode=yf;break}for(;l<3;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}switch(t.last=h&1,h>>>=1,l-=1,h&3){case 0:t.mode=qy;break;case 1:if(bB(t),t.mode=tl,e===el){h>>>=2,l-=2;break e}break;case 2:t.mode=Wy;break;case 3:r.msg="invalid block type",t.mode=Oe}h>>>=2,l-=2;break;case qy:for(h>>>=l&7,l-=l&7;l<32;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if((h&65535)!==(h>>>16^65535)){r.msg="invalid stored block lengths",t.mode=Oe;break}if(t.length=h&65535,h=0,l=0,t.mode=gf,e===el)break e;case gf:t.mode=Gy;case Gy:if(g=t.length,g){if(g>a&&(g=a),g>c&&(g=c),g===0)break e;s.set(n.subarray(i,i+g),o),a-=g,i+=g,c-=g,o+=g,t.length-=g;break}t.mode=bn;break;case Wy:for(;l<14;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(t.nlen=(h&31)+257,h>>>=5,l-=5,t.ndist=(h&31)+1,h>>>=5,l-=5,t.ncode=(h&15)+4,h>>>=4,l-=4,t.nlen>286||t.ndist>30){r.msg="too many length or distance symbols",t.mode=Oe;break}t.have=0,t.mode=Yy;case Yy:for(;t.have<t.ncode;){for(;l<3;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}t.lens[K[t.have++]]=h&7,h>>>=3,l-=3}for(;t.have<19;)t.lens[K[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,D={bits:t.lenbits},I=Ua(cB,t.lens,0,19,t.lencode,0,t.work,D),t.lenbits=D.bits,I){r.msg="invalid code lengths set",t.mode=Oe;break}t.have=0,t.mode=Qy;case Qy:for(;t.have<t.nlen+t.ndist;){for(;w=t.lencode[h&(1<<t.lenbits)-1],y=w>>>24,_=w>>>16&255,m=w&65535,!(y<=l);){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(m<16)h>>>=y,l-=y,t.lens[t.have++]=m;else{if(m===16){for($=y+2;l<$;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(h>>>=y,l-=y,t.have===0){r.msg="invalid bit length repeat",t.mode=Oe;break}E=t.lens[t.have-1],g=3+(h&3),h>>>=2,l-=2}else if(m===17){for($=y+3;l<$;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}h>>>=y,l-=y,E=0,g=3+(h&7),h>>>=3,l-=3}else{for($=y+7;l<$;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}h>>>=y,l-=y,E=0,g=11+(h&127),h>>>=7,l-=7}if(t.have+g>t.nlen+t.ndist){r.msg="invalid bit length repeat",t.mode=Oe;break}for(;g--;)t.lens[t.have++]=E}}if(t.mode===Oe)break;if(t.lens[256]===0){r.msg="invalid code -- missing end-of-block",t.mode=Oe;break}if(t.lenbits=9,D={bits:t.lenbits},I=Ua(a7,t.lens,0,t.nlen,t.lencode,0,t.work,D),t.lenbits=D.bits,I){r.msg="invalid literal/lengths set",t.mode=Oe;break}if(t.distbits=6,t.distcode=t.distdyn,D={bits:t.distbits},I=Ua(c7,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,D),t.distbits=D.bits,I){r.msg="invalid distances set",t.mode=Oe;break}if(t.mode=tl,e===el)break e;case tl:t.mode=rl;case rl:if(a>=6&&c>=258){r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=h,t.bits=l,rB(r,f),o=r.next_out,s=r.output,c=r.avail_out,i=r.next_in,n=r.input,a=r.avail_in,h=t.hold,l=t.bits,t.mode===bn&&(t.back=-1);break}for(t.back=0;w=t.lencode[h&(1<<t.lenbits)-1],y=w>>>24,_=w>>>16&255,m=w&65535,!(y<=l);){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(_&&!(_&240)){for(b=y,S=_,A=m;w=t.lencode[A+((h&(1<<b+S)-1)>>b)],y=w>>>24,_=w>>>16&255,m=w&65535,!(b+y<=l);){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}h>>>=b,l-=b,t.back+=b}if(h>>>=y,l-=y,t.back+=y,t.length=m,_===0){t.mode=t5;break}if(_&32){t.back=-1,t.mode=bn;break}if(_&64){r.msg="invalid literal/length code",t.mode=Oe;break}t.extra=_&15,t.mode=Xy;case Xy:if(t.extra){for($=t.extra;l<$;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}t.length+=h&(1<<t.extra)-1,h>>>=t.extra,l-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=Jy;case Jy:for(;w=t.distcode[h&(1<<t.distbits)-1],y=w>>>24,_=w>>>16&255,m=w&65535,!(y<=l);){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(!(_&240)){for(b=y,S=_,A=m;w=t.distcode[A+((h&(1<<b+S)-1)>>b)],y=w>>>24,_=w>>>16&255,m=w&65535,!(b+y<=l);){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}h>>>=b,l-=b,t.back+=b}if(h>>>=y,l-=y,t.back+=y,_&64){r.msg="invalid distance code",t.mode=Oe;break}t.offset=m,t.extra=_&15,t.mode=Zy;case Zy:if(t.extra){for($=t.extra;l<$;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}t.offset+=h&(1<<t.extra)-1,h>>>=t.extra,l-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){r.msg="invalid distance too far back",t.mode=Oe;break}t.mode=e5;case e5:if(c===0)break e;if(g=f-c,t.offset>g){if(g=t.offset-g,g>t.whave&&t.sane){r.msg="invalid distance too far back",t.mode=Oe;break}g>t.wnext?(g-=t.wnext,d=t.wsize-g):d=t.wnext-g,g>t.length&&(g=t.length),p=t.window}else p=s,d=o-t.offset,g=t.length;g>c&&(g=c),c-=g,t.length-=g;do s[o++]=p[d++];while(--g);t.length===0&&(t.mode=rl);break;case t5:if(c===0)break e;s[o++]=t.length,c--,t.mode=rl;break;case yf:if(t.wrap){for(;l<32;){if(a===0)break e;a--,h|=n[i++]<<l,l+=8}if(f-=c,r.total_out+=f,t.total+=f,t.wrap&4&&f&&(r.adler=t.check=t.flags?ct(t.check,s,f,o-f):ic(t.check,s,f,o-f)),f=c,t.wrap&4&&(t.flags?h:s5(h))!==t.check){r.msg="incorrect data check",t.mode=Oe;break}h=0,l=0}t.mode=r5;case r5:if(t.wrap&&t.flags){for(;l<32;){if(a===0)break e;a--,h+=n[i++]<<l,l+=8}if(t.wrap&4&&h!==(t.total&4294967295)){r.msg="incorrect length check",t.mode=Oe;break}h=0,l=0}t.mode=n5;case n5:I=hB;break e;case Oe:I=l7;break e;case u7:return h7;case d7:default:return Sr}return r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=h,t.bits=l,(t.wsize||f!==r.avail_out&&t.mode<Oe&&(t.mode<yf||e!==$y))&&w7(r,r.output,r.next_out,f-r.avail_out),u-=r.avail_in,f-=r.avail_out,r.total_in+=u,r.total_out+=f,t.total+=f,t.wrap&4&&f&&(r.adler=t.check=t.flags?ct(t.check,s,f,r.next_out-f):ic(t.check,s,f,r.next_out-f)),r.data_type=t.bits+(t.last?64:0)+(t.mode===bn?128:0)+(t.mode===tl||t.mode===gf?256:0),(u===0&&f===0||e===$y)&&I===Ri&&(I=dB),I},_B=r=>{if(Di(r))return Sr;let e=r.state;return e.window&&(e.window=null),r.state=null,Ri},vB=(r,e)=>{if(Di(r))return Sr;const t=r.state;return t.wrap&2?(t.head=e,e.done=!1,Ri):Sr},SB=(r,e)=>{const t=e.length;let n,s,i;return Di(r)||(n=r.state,n.wrap!==0&&n.mode!==zh)?Sr:n.mode===zh&&(s=1,s=ic(s,e,t,0),s!==n.check)?l7:(i=w7(r,e,t,t),i?(n.mode=u7,h7):(n.havedict=1,Ri))};var RB=p7,AB=g7,IB=f7,CB=mB,TB=y7,kB=EB,DB=_B,PB=vB,OB=SB,NB="pako inflate (from Nodeca project)",Dn={inflateReset:RB,inflateReset2:AB,inflateResetKeep:IB,inflateInit:CB,inflateInit2:TB,inflate:kB,inflateEnd:DB,inflateGetHeader:PB,inflateSetDictionary:OB,inflateInfo:NB};function xB(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var $B=xB;const m7=Object.prototype.toString,{Z_NO_FLUSH:LB,Z_FINISH:MB,Z_OK:cc,Z_STREAM_END:bf,Z_NEED_DICT:Ef,Z_STREAM_ERROR:UB,Z_DATA_ERROR:o5,Z_MEM_ERROR:BB}=ki;function Pc(r){this.options=fd.assign({chunkSize:1024*64,windowBits:15,to:""},r||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),e.windowBits>=0&&e.windowBits<16&&!(r&&r.windowBits)&&(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(e.windowBits&15||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new i7,this.strm.avail_out=0;let t=Dn.inflateInit2(this.strm,e.windowBits);if(t!==cc)throw new Error(vi[t]);if(this.header=new $B,Dn.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=ac.string2buf(e.dictionary):m7.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(t=Dn.inflateSetDictionary(this.strm,e.dictionary),t!==cc)))throw new Error(vi[t])}Pc.prototype.push=function(r,e){const t=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let i,o,a;if(this.ended)return!1;for(e===~~e?o=e:o=e===!0?MB:LB,m7.call(r)==="[object ArrayBuffer]"?t.input=new Uint8Array(r):t.input=r,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),i=Dn.inflate(t,o),i===Ef&&s&&(i=Dn.inflateSetDictionary(t,s),i===cc?i=Dn.inflate(t,o):i===o5&&(i=Ef));t.avail_in>0&&i===bf&&t.state.wrap>0&&r[t.next_in]!==0;)Dn.inflateReset(t),i=Dn.inflate(t,o);switch(i){case UB:case o5:case Ef:case BB:return this.onEnd(i),this.ended=!0,!1}if(a=t.avail_out,t.next_out&&(t.avail_out===0||i===bf))if(this.options.to==="string"){let c=ac.utf8border(t.output,t.next_out),h=t.next_out-c,l=ac.buf2string(t.output,c);t.next_out=h,t.avail_out=n-h,h&&t.output.set(t.output.subarray(c,c+h),0),this.onData(l)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(i===cc&&a===0)){if(i===bf)return i=Dn.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};Pc.prototype.onData=function(r){this.chunks.push(r)};Pc.prototype.onEnd=function(r){r===cc&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=fd.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};function y2(r,e){const t=new Pc(e);if(t.push(r),t.err)throw t.msg||vi[t.err];return t.result}function zB(r,e){return e=e||{},e.raw=!0,y2(r,e)}var FB=Pc,VB=y2,KB=zB,jB=y2,HB=ki,qB={Inflate:FB,inflate:VB,inflateRaw:KB,ungzip:jB,constants:HB};const{Deflate:GB,deflate:WB,deflateRaw:YB,gzip:QB}=eB,{Inflate:XB,inflate:JB,inflateRaw:ZB,ungzip:ez}=qB;var tz=GB,rz=WB,nz=YB,sz=QB,iz=XB,oz=JB,az=ZB,cz=ez,lz=ki,a5={Deflate:tz,deflate:rz,deflateRaw:nz,gzip:sz,Inflate:iz,inflate:oz,inflateRaw:az,ungzip:cz,constants:lz};const c5=6;function hz({repo:r,preload:e}){async function*t(n,s={}){if(s.compressionLevel!=null&&(s.compressionLevel<-1||s.compressionLevel>9))throw v(new Error("Compression level must be between -1 and 9"),"ERR_INVALID_PARAMS");if(s.preload!==!1){let a;try{a=Vp(n).split("/")}catch(c){throw v(c,"ERR_INVALID_PATH")}e(J.parse(a[0]))}const i=J.asCID(n)||n,o=await Gn(i,r.blocks,s);if(o.type==="file"||o.type==="raw"){const a=[];!s.compress||s.archive===!0?a.push([{header:{name:o.path,mode:o.type==="file"&&o.unixfs.mode,mtime:o.type==="file"&&o.unixfs.mtime?new Date(o.unixfs.mtime.secs*1e3):void 0,size:o.size,type:"file"},body:o.content()}],Ey()):a.push(o.content),s.compress&&a.push(async function*(c){const h=await a1(c);yield a5.gzip(h,{level:s.compressionLevel||c5})}),yield*ie(...a);return}if(o.type==="directory"){const a=[Lb(i,r.blocks,s),async function*(c){for await(const h of c){const l={header:{name:h.path,size:h.size}};if(h.type==="file")l.header.type="file",l.header.mode=h.unixfs.mode!=null?h.unixfs.mode:void 0,l.header.mtime=h.unixfs.mtime?new Date(h.unixfs.mtime.secs*1e3):void 0,l.body=h.content();else if(h.type==="raw")l.header.type="file",l.body=h.content();else if(h.type==="directory")l.header.type="directory",l.header.mode=h.unixfs.mode!=null?h.unixfs.mode:void 0,l.header.mtime=h.unixfs.mtime?new Date(h.unixfs.mtime.secs*1e3):void 0;else throw v(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");yield l}},Ey()];if(s.compress){if(!s.archive)throw v(new Error("file is not regular"),"ERR_INVALID_PATH");s.compress&&a.push(async function*(c){const h=await a1(c);yield a5.gzip(h,{level:s.compressionLevel||c5})})}yield*ie(...a);return}throw v(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS")}return x(t)}function uz({repo:r,preload:e}){async function*t(n,s={}){const i=Vp(n),o=i.split("/");s.preload!==!1&&e(J.parse(o[0]));const a=J.asCID(i)||i,c=await Gn(a,r.blocks,s);if(c.type==="file"){yield I3(c);return}if(c.type==="directory"){for await(const h of c.content())yield I3(h);return}throw v(new Error(`Unknown UnixFS type ${c.type}`),"ERR_UNKNOWN_UNIXFS_TYPE")}return x(t)}class dz{constructor({preload:e,repo:t,hashers:n,options:s}){const i=F$({preload:e,repo:t,options:s,hashers:n});this.addAll=i,this.add=yN({addAll:i}),this.cat=KL({repo:t,preload:e}),this.get=hz({repo:t,preload:e}),this.ls=uz({repo:t,preload:e})}}const Fh="0.18.0",fz="",pz="^0.158.0";function gz({repo:r}){async function e(t={}){const n=await r.version.get();return{version:Fh,commit:fz,repo:`${n}`,"ipfs-core":Fh,"interface-ipfs-core":pz}}return x(e)}const yz=P("ipfs:components:id");function wz({peerId:r,network:e}){async function t(n={}){const s=e.try();if(!s){if(n.peerId)throw new wc;if(r.publicKey==null)throw v(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");return{id:r,publicKey:B(r.publicKey,"base64pad"),addresses:[],agentVersion:`js-ipfs/${Fh}`,protocolVersion:"9000",protocols:[]}}const{libp2p:i}=s,o=n.peerId?n.peerId:r,a=await mz(o,i,n),c=B(a.metadata.get("AgentVersion")||new Uint8Array),h=B(a.metadata.get("ProtocolVersion")||new Uint8Array),l=a.id.toString(),u=a.publicKey?B(a.publicKey,"base64pad"):"";return{id:o,publicKey:u,addresses:(a.addresses||[]).map(f=>{const g=f.toString();return g.endsWith(`/p2p/${l}`)?g:`${g}/p2p/${l}`}).sort().map(f=>G(f)),agentVersion:c,protocolVersion:h,protocols:(a.protocols||[]).sort()}}return x(t)}async function mz(r,e,t){let n=await e.peerStore.get(r);n||(n=await bz(r,e,t));let s=r.publicKey?r.publicKey:await e.peerStore.keyBook.get(r);if(s==null)try{s=await e.getPublicKey(r,t)}catch(i){yz.error("Could not load public key for",r.toString(),i)}return{...n,publicKey:s,metadata:n.metadata||new Map,addresses:n.addresses.map(i=>i.multiaddr)}}async function bz(r,e,t){if(e.dht==null)throw v(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");for await(const s of e.dht.findPeer(r,t))if(s.name==="FINAL_PEER")break;const n=await e.peerStore.get(r);if(!n)throw v(new Error("Could not find peer"),"ERR_NOT_FOUND");return n}var Ke=Ez;function Ez(r,e,t){var n,s;if(Array.isArray(e)&&(n=e.slice(0)),typeof e=="string"&&(n=e.split(".")),typeof e=="symbol"&&(n=[e]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");if(s=n.pop(),!s)return!1;l5(s);for(var i;i=n.shift();)if(l5(i),typeof r[i]>"u"&&(r[i]={}),r=r[i],!r||typeof r!="object")return!1;return r[s]=t,!0}function l5(r){if(r=="__proto__"||r=="constructor"||r=="prototype")throw new Error("setting of prototype values not supported")}const Vh={server:{description:"Recommended for nodes with public IPv4 address (servers, VPSes, etc.), disables host and content discovery and UPnP in local networks.",transform:r=>(Ke(r,"Discovery.MDNS.Enabled",!1),Ke(r,"Discovery.webRTCStar.Enabled",!1),r.Swarm={...r.Swarm||{},DisableNatPortMap:!0},r)},"local-discovery":{description:"Sets default values to fields affected by `server` profile, enables discovery and UPnP in local networks.",transform:r=>(Ke(r,"Discovery.MDNS.Enabled",!0),Ke(r,"Discovery.webRTCStar.Enabled",!0),Ke(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!1}),r)},test:{description:"Reduces external interference, useful for running ipfs in test environments. Note that with these settings node won't be able to talk to the rest of the network without manual bootstrap.",transform:r=>{const e=oo();return Ke(r,"Addresses.API",e.Addresses.API?"/ip4/127.0.0.1/tcp/0":""),Ke(r,"Addresses.Gateway",e.Addresses.Gateway?"/ip4/127.0.0.1/tcp/0":""),Ke(r,"Addresses.Swarm",e.Addresses.Swarm.length?["/ip4/127.0.0.1/tcp/0"]:[]),Ke(r,"Addresses.Delegates",[]),Ke(r,"Bootstrap",[]),Ke(r,"Discovery.MDNS.Enabled",!1),Ke(r,"Discovery.webRTCStar.Enabled",!1),Ke(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!0}),r}},"default-networking":{description:"Restores default network settings. Inverse profile of the `test` profile.",transform:r=>{const e=oo();return Ke(r,"Addresses.API",e.Addresses.API),Ke(r,"Addresses.Gateway",e.Addresses.Gateway),Ke(r,"Addresses.Swarm",e.Addresses.Swarm),Ke(r,"Addresses.Delegates",e.Addresses.Delegates),Ke(r,"Bootstrap",e.Bootstrap),Ke(r,"Discovery.MDNS.Enabled",e.Discovery.MDNS.Enabled),Ke(r,"Discovery.webRTCStar.Enabled",e.Discovery.webRTCStar.Enabled),Ke(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!1}),r}},lowpower:{description:"Reduces daemon overhead on the system. May affect node functionality,performance of content discovery and data fetching may be degraded. Recommended for low power systems.",transform:r=>{const e=r.Swarm||{},t=e.ConnMgr||{};return t.LowWater=20,t.HighWater=40,e.ConnMgr=t,r.Swarm=e,r}},"default-power":{description:'Inverse of "lowpower" profile.',transform:r=>{const e=oo();return r.Swarm=e.Swarm,r}}},_z=P("ipfs:core:config");function vz({repo:r}){return{getAll:x(e),get:x(t),set:x(n),replace:x(s),profiles:{apply:x(i),list:x(Sz)}};async function e(o={}){return r.config.getAll(o)}async function t(o,a){return o?r.config.get(o,a):Promise.reject(new Error("key argument is required"))}async function n(o,a,c){return r.config.set(o,a,c)}async function s(o,a){return r.config.replace(o,a)}async function i(o,a={dryRun:!1}){const{dryRun:c}=a,h=Vh[o];if(!h)throw new Error(`No profile with name '${o}' exists`);try{const l=await r.config.getAll(a);let u=JSON.parse(JSON.stringify(l));return u=h.transform(u),c||await r.config.replace(u,a),delete l.Identity.PrivKey,delete u.Identity.PrivKey,{original:l,updated:u}}catch(l){throw _z(l),new Error(`Could not apply profile '${o}' to config: ${l.message}`)}}}async function Sz(r){return Object.keys(Vh).map(e=>({name:e,description:Vh[e].description}))}function nl({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*Rz(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=J.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*p0(n,s))}else{const t=J.asCID(e);t?yield[r.join("/"),t]:yield*p0(e,r)}}function*p0(r,e){if(r==null||r instanceof Uint8Array)return;const t=J.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*Rz(i,s)}}function*Az(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!J.asCID(n)&&(yield*g0(n,s))}else yield*g0(e,r)}function*g0(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!J.asCID(n)&&(yield*Az(s,n))}}function Iz(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=J.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}let Cz=class{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:nl(),bytes:nl(),value:nl(),asBlock:nl()})}links(){return p0(this.value,[])}tree(){return g0(this.value,[])}get(e="/"){return Iz(this.value,e.split("/").filter(Boolean))}};function Tz({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n&&n.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new Cz({cid:e,bytes:r,value:s})}var kz=b7,h5=128,Dz=127,Pz=~Dz,Oz=Math.pow(2,31);function b7(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Oz;)e[t++]=r&255|h5,r/=128;for(;r&Pz;)e[t++]=r&255|h5,r>>>=7;return e[t]=r|0,b7.bytes=t-n+1,e}var Nz=y0,xz=128,u5=127;function y0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw y0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&u5)<<s:(o&u5)*Math.pow(2,s),s+=7}while(o>=xz);return y0.bytes=i-n,t}var $z=Math.pow(2,7),Lz=Math.pow(2,14),Mz=Math.pow(2,21),Uz=Math.pow(2,28),Bz=Math.pow(2,35),zz=Math.pow(2,42),Fz=Math.pow(2,49),Vz=Math.pow(2,56),Kz=Math.pow(2,63),jz=function(r){return r<$z?1:r<Lz?2:r<Mz?3:r<Uz?4:r<Bz?5:r<zz?6:r<Fz?7:r<Vz?8:r<Kz?9:10},Hz={encode:kz,decode:Nz,encodingLength:jz},Kh=Hz;const w0=(r,e=0)=>[Kh.decode(r,e),Kh.decode.bytes],jh=(r,e,t=0)=>(Kh.encode(r,e,t),e),Hh=r=>Kh.encodingLength(r),qz=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},w2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Gz=(r,e)=>{const t=e.byteLength,n=Hh(r),s=n+Hh(t),i=new Uint8Array(s+t);return jh(r,i,0),jh(t,i,n),i.set(e,s),new m2(r,t,e,i)},m0=r=>{const e=w2(r),[t,n]=w0(e),[s,i]=w0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new m2(t,s,o,e)},Wz=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&qz(r.bytes,t.bytes)}};let m2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function Yz(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var Qz=Yz,Xz=Qz;let Jz=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Zz=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return E7(this,e)}},eF=class{constructor(e){this.decoders=e}or(e){return E7(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const E7=(r,e)=>new eF({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let tF=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Jz(e,t,n),this.decoder=new Zz(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const _7=({name:r,prefix:e,encode:t,decode:n})=>new tF(r,e,t,n),v7=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Xz(t,e);return _7({prefix:r,name:e,encode:n,decode:i=>w2(s(i))})},rF=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},nF=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Wn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>_7({prefix:e,name:r,encode(s){return nF(s,n,t)},decode(s){return rF(s,n,t,r)}}),bs=v7({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});v7({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Kl=Wn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Wn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Wn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Wn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Wn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Wn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Wn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Wn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Wn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const d5=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return iF(t,b0(r),e||bs.encoder);default:return oF(t,b0(r),e||Kl.encoder)}},f5=new WeakMap,b0=r=>{const e=f5.get(r);if(e==null){const t=new Map;return f5.set(r,t),t}return e};let lc=class Ct{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ra)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==aF)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ct.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Gz(e,t);return Ct.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ct.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Wz(e.multihash,n.multihash)}toString(e){return d5(this,e)}toJSON(){return{"/":d5(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ct)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Ct(n,s,i,o||p5(n,s,i.bytes))}else if(t[cF]===!0){const{version:n,multihash:s,code:i}=t,o=m0(s);return Ct.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ra)throw new Error(`Version 0 CID must use dag-pb (code: ${ra}) block encoding`);return new Ct(e,t,n,n.bytes)}case 1:{const s=p5(e,t,n.bytes);return new Ct(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Ct.create(0,ra,e)}static createV1(e,t){return Ct.create(1,e,t)}static decode(e){const[t,n]=Ct.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ct.inspectBytes(e),n=t.size-t.multihashSize,s=w2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new m2(t.multihashCode,t.digestSize,i,s);return[t.version===0?Ct.createV0(o):Ct.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=w0(e.subarray(t));return t+=f,u};let s=n(),i=ra;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=sF(e,t),i=Ct.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return b0(i).set(n,e),i}};const sF=(r,e)=>{switch(r[0]){case"Q":{const t=e||bs;return[bs.prefix,t.decode(`${bs.prefix}${r}`)]}case bs.prefix:{const t=e||bs;return[bs.prefix,t.decode(r)]}case Kl.prefix:{const t=e||Kl;return[Kl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},iF=(r,e,t)=>{const{prefix:n}=t;if(n!==bs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},oF=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ra=112,aF=18,p5=(r,e,t)=>{const n=Hh(r),s=n+Hh(e),i=new Uint8Array(s+t.byteLength);return jh(r,i,0),jh(e,i,n),i.set(t,s),i},cF=Symbol.for("@ipld/js-cid/CID");function S7(r){const e=Zw({version:1,roots:r}),t=je.encode(e.length),n=new Uint8Array(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function lF(r){return{async setRoots(e){const t=S7(e);await r.write(t)},async writeBlock(e){const{cid:t,bytes:n}=e;await r.write(new Uint8Array(je.encode(t.bytes.length+n.length))),await r.write(t.bytes),n.length&&await r.write(n)},async close(){await r.end()}}}function sl(){}function hF(){const r=[];let e=null,t=sl,n=!1,s=null,i=sl;const o=()=>(e||(e=new Promise(h=>{t=()=>{e=null,t=sl,h()}})),e),a={write(h){r.push(h);const l=o();return i(),l},async end(){n=!0;const h=o();i(),await h}},c={async next(){const h=r.shift();return h?(r.length===0&&t(),{done:!1,value:h}):n?(t(),{done:!0,value:void 0}):(s||(s=new Promise(l=>{i=()=>(s=null,i=sl,l(c.next()))})),s)}};return{writer:a,iterator:c}}const Ps={Null:r=>r===null,Int:r=>Number.isInteger(r),Float:r=>typeof r=="number"&&Number.isFinite(r),String:r=>typeof r=="string",Bool:r=>typeof r=="boolean",Bytes:r=>r instanceof Uint8Array,Link:r=>!Ps.Null(r)&&typeof r=="object"&&r.asCID===r,List:r=>Array.isArray(r),Map:r=>!Ps.Null(r)&&typeof r=="object"&&r.asCID!==r&&!Ps.List(r)&&!Ps.Bytes(r)},Wi={Int:Ps.Int,"CarHeader > version":r=>Wi.Int(r),"CarHeader > roots (anon) > valueType (anon)":Ps.Link,"CarHeader > roots (anon)":r=>Ps.List(r)&&Array.prototype.every.call(r,Wi["CarHeader > roots (anon) > valueType (anon)"]),"CarHeader > roots":r=>Wi["CarHeader > roots (anon)"](r),CarHeader:r=>{const e=r&&Object.keys(r);return Ps.Map(r)&&["version"].every(t=>e.includes(t))&&Object.entries(r).every(([t,n])=>Wi["CarHeader > "+t]&&Wi["CarHeader > "+t](n))}},uF=Wi.CarHeader,_f={SHA2_256:18,LENGTH:32,DAG_PB:112},dF=16+8+8+8;function qh(r,e){if(!r.length)throw new Error("Unexpected end of data");const t=je.decode(r);return e.seek(je.decode.bytes),t}function fF(r){const e=new DataView(r.buffer,r.byteOffset,r.byteLength);let t=0;return{version:2,characteristics:[e.getBigUint64(t,!0),e.getBigUint64(t+=8,!0)],dataOffset:Number(e.getBigUint64(t+=8,!0)),dataSize:Number(e.getBigUint64(t+=8,!0)),indexOffset:Number(e.getBigUint64(t+=8,!0))}}function pF(r){je.decode(r);const e=je.decode.bytes,t=je.decode(r.subarray(je.decode.bytes)),n=je.decode.bytes;return e+n+t}async function b2(r,e){const t=qh(await r.upTo(8),r);if(t===0)throw new Error("Invalid CAR header (zero length)");const n=await r.exactly(t,!0),s=_p(n);if(!uF(s))throw new Error("Invalid CAR header format");if(s.version!==1&&s.version!==2||e!==void 0&&s.version!==e)throw new Error(`Invalid CAR version: ${s.version}${e!==void 0?` (expected ${e})`:""}`);const i=Array.isArray(s.roots);if(s.version===1&&!i||s.version===2&&i)throw new Error("Invalid CAR header format");if(s.version===1)return s;const o=fF(await r.exactly(dF,!0));r.seek(o.dataOffset-r.pos);const a=await b2(r,1);return Object.assign(a,o)}async function gF(r){const e=await r.exactly(2,!1);if(e[0]===_f.SHA2_256&&e[1]===_f.LENGTH){const o=await r.exactly(34,!0),a=m0(o);return lc.create(0,_f.DAG_PB,a)}const t=qh(await r.upTo(8),r);if(t!==1)throw new Error(`Unexpected CID version (${t})`);const n=qh(await r.upTo(8),r),s=await r.exactly(pF(await r.upTo(8)),!0),i=m0(s);return lc.create(t,n,i)}async function R7(r){const e=r.pos;let t=qh(await r.upTo(8),r);if(t===0)throw new Error("Invalid CAR section (zero length)");t+=r.pos-e;const n=await gF(r),s=t-Number(r.pos-e);return{cid:n,length:t,blockLength:s}}async function yF(r){const{cid:e,blockLength:t}=await R7(r);return{bytes:await r.exactly(t,!0),cid:e}}async function wF(r){const e=r.pos,{cid:t,length:n,blockLength:s}=await R7(r),i={cid:t,length:n,blockLength:s,offset:e,blockOffset:r.pos};return r.seek(i.blockLength),i}function mF(r){const e=(async()=>{const t=await b2(r);if(t.version===2){const n=r.pos-t.dataOffset;r=_F(r,t.dataSize-n)}return t})();return{header:()=>e,async*blocks(){for(await e;(await r.upTo(8)).length>0;)yield await yF(r)},async*blocksIndex(){for(await e;(await r.upTo(8)).length>0;)yield await wF(r)}}}function A7(r){let e=0;return{async upTo(t){return r.subarray(e,e+Math.min(t,r.length-e))},async exactly(t,n=!1){if(t>r.length-e)throw new Error("Unexpected end of data");const s=r.subarray(e,e+t);return n&&(e+=t),s},seek(t){e+=t},get pos(){return e}}}function bF(r){let e=0,t=0,n=0,s=new Uint8Array(0);const i=async o=>{t=s.length-n;const a=[s.subarray(n)];for(;t<o;){const h=await r();if(h==null)break;t<0?h.length>t&&a.push(h.subarray(-t)):a.push(h),t+=h.length}s=new Uint8Array(a.reduce((h,l)=>h+l.length,0));let c=0;for(const h of a)s.set(h,c),c+=h.length;n=0};return{async upTo(o){return s.length-n<o&&await i(o),s.subarray(n,n+Math.min(s.length-n,o))},async exactly(o,a=!1){if(s.length-n<o&&await i(o),s.length-n<o)throw new Error("Unexpected end of data");const c=s.subarray(n,n+o);return a&&(e+=o,n+=o),c},seek(o){e+=o,n+=o},get pos(){return e}}}function EF(r){const e=r[Symbol.asyncIterator]();async function t(){const n=await e.next();return n.done?null:n.value}return bF(t)}function _F(r,e){let t=0;return{async upTo(n){let s=await r.upTo(n);return s.length+t>e&&(s=s.subarray(0,e-t)),s},async exactly(n,s=!1){const i=await r.exactly(n,s);if(i.length+t>e)throw new Error("Unexpected end of data");return s&&(t+=n),i},seek(n){t+=n,r.seek(n)},get pos(){return r.pos}}}class Gh{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array)||!e.cid)throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const t=lc.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:t,bytes:e.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}static create(e){e=vF(e);const{encoder:t,iterator:n}=y5(),s=new Gh(e,t),i=new g5(n);return{writer:s,out:i}}static createAppender(){const{encoder:e,iterator:t}=y5();e.setRoots=()=>Promise.resolve();const n=new Gh([],e),s=new g5(t);return{writer:n,out:s}}static async updateRootsInBytes(e,t){const n=A7(e);await b2(n);const s=S7(t);if(Number(n.pos)!==s.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${s.length} bytes)`);return e.set(s,0),e}}class g5{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function y5(){const r=hF(),{writer:e,iterator:t}=r;return{encoder:lF(e),iterator:t}}function vF(r){if(r===void 0)return[];if(!Array.isArray(r)){const t=lc.asCID(r);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}const e=[];for(const t of r){const n=lc.asCID(t);if(!n)throw new TypeError("roots must be a single CID or an array of CIDs");e.push(n)}return e}const I7=async({cid:r,load:e,seen:t})=>{t=t||new Set;const n=r.toString(sr);if(t.has(n))return;const s=await e(r);if(t.add(n),s!==null)for(const[,i]of s.links())await I7({cid:i,load:e,seen:t})},C7=P("ipfs:components:dag:import"),SF=[xp,Gm];function RF({repo:r,preload:e,codecs:t}){async function*n(s,i={}){i.preload!==!1&&e(s);const o=J.asCID(s);if(!o)throw new Error(`Unexpected error converting CID type: ${s}`);C7(`Exporting ${o} as car`);const{writer:a,out:c}=await Gh.create([o]);let h=null;(async()=>{try{const l=AF(r,a,{signal:i.signal,timeout:i.timeout},t);await I7({cid:o,load:l})}catch(l){h=l}finally{a.close()}})();for await(const l of c){if(h)break;yield l}if(h)throw h}return x(n)}function AF(r,e,t,n){return async s=>{const i=await n.getCodec(s.code);if(!i)throw new Error(`Can't decode links in block with codec 0x${s.code.toString(16)} to form complete DAG`);const o=await r.blocks.get(s,t);return C7(`Adding block ${s} to car`),await e.put({cid:s,bytes:o}),SF.includes(s.code)?null:Tz({bytes:o,cid:s,codec:i})}}async function Rr(r){for await(const e of r)return e}function IF({codecs:r,repo:e,preload:t}){return x(async function(i,o={}){if(o.preload!==!1&&t(i),o.path){const u=o.localResolve?await Rr(Xa(i,o.path,r,e,o)):await hr(Xa(i,o.path,r,e,o));if(!u)throw v(new Error("Not found"),"ERR_NOT_FOUND");return u}const a=await r.getCodec(i.code),c=await e.blocks.get(i,o);return{value:a.decode(c),remainderPath:""}})}class CF{constructor(e,t,n){this._version=e,this._roots=t,this._iterable=n,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class Wh extends CF{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(e){const{version:t,roots:n,iterator:s}=await TF(e);return new Wh(t,n,s)}static async fromIterable(e){const{version:t,roots:n,iterator:s}=await kF(e);return new Wh(t,n,s)}}async function TF(r){if(!(r instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return T7(A7(r))}async function kF(r){if(!r||typeof r[Symbol.asyncIterator]!="function")throw new TypeError("fromIterable() requires an async iterable");return T7(EF(r))}async function T7(r){const e=mF(r),{version:t,roots:n}=await e.header();return{version:t,roots:n,iterator:e.blocks()}}const k7=P("ipfs:components:dag:import");function DF({repo:r}){async function*e(t,n={}){const s=await r.gcLock.readLock();try{const i={signal:n.signal,timeout:n.timeout},o=Ac(t),{value:a,done:c}=await o.peek();if(c)return;a&&o.push(a);let h;a instanceof Uint8Array?h=[o]:h=o;for await(const l of h){const u=await PF(r,i,l);if(n.pinRoots!==!1)for(const f of u){let g="";try{await r.blocks.has(f)?(k7(`Pinning root ${f}`),await r.pins.pinRecursively(f)):g="blockstore: block not found"}catch(d){g=d.message}yield{root:{cid:f,pinErrorMsg:g}}}}}finally{s()}}return x(e)}async function PF(r,e,t){const n=await Wh.fromIterable(t),s=await n.getRoots();return await ot(r.blocks.putMany(zt(n,({cid:i,bytes:o})=>(k7(`Import block ${i}`),{key:i,value:o})),{signal:e.signal})),s}function OF({repo:r,codecs:e,hashers:t,preload:n}){async function s(i,o={}){const a=o.pin?await r.gcLock.readLock():null;try{const c=await e.getCodec(o.storeCodec||"dag-cbor");if(!c)throw new Error(`Unknown storeCodec ${o.storeCodec}, please configure additional BlockCodecs for this IPFS instance`);if(o.inputCodec){if(!(i instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");const d=await e.getCodec(o.inputCodec);if(!d)throw new Error(`Unknown inputCodec ${o.inputCodec}, please configure additional BlockCodecs for this IPFS instance`);i=d.decode(i)}const h=o.version!=null?o.version:1,l=await t.getHasher(o.hashAlg||"sha2-256");if(!l)throw new Error(`Unknown hash algorithm ${o.hashAlg}, please configure additional MultihashHashers for this IPFS instance`);const u=c.encode(i),f=await l.digest(u),g=J.create(h,c.code,f);return await r.blocks.put(g,u,{signal:o.signal}),o.pin&&await r.pins.pinRecursively(g),o.preload!==!1&&n(g),g}finally{a&&a()}}return x(s)}function NF({repo:r,codecs:e,preload:t}){async function n(s,i={}){const{cid:o}=bc(s);return i.preload!==!1&&t(o),rd(r,e,s,i)}return x(n)}class xF{constructor({repo:e,codecs:t,hashers:n,preload:s}){this.export=RF({repo:e,preload:s,codecs:t}),this.get=IF({codecs:t,repo:e,preload:s}),this.import=DF({repo:e}),this.resolve=NF({repo:e,codecs:t,preload:s}),this.put=OF({repo:e,codecs:t,hashers:n,preload:s})}}const il=(r,e)=>e,$F=(r,e,t,n)=>{if(n!=null&&n.assumeHttp===!1)return`tcp://${r}:${e}`;let s="tcp",i=`:${e}`;return t[t.length-1].protocol==="tcp"&&(s=e==="443"?"https":"http",i=e==="443"||e==="80"?"":i),`${s}://${r}${i}`},LF={ip4:il,ip6:(r,e,t,n)=>n.length===1&&n[0].protocol==="ip6"?e:`[${e}]`,tcp:(r,e,t,n,s)=>n.some(i=>["http","https","ws","wss"].includes(i.protocol))?`${r}:${e}`:$F(r,e,n,s),udp:(r,e)=>`udp://${r}:${e}`,dnsaddr:il,dns4:il,dns6:il,ipfs:(r,e)=>`${r}/ipfs/${e}`,p2p:(r,e)=>`${r}/p2p/${e}`,http:r=>`http://${r}`,https:r=>`https://${r}`,ws:r=>`ws://${r}`,wss:r=>`wss://${r}`,"p2p-websocket-star":r=>`${r}/p2p-websocket-star`,"p2p-webrtc-star":r=>`${r}/p2p-webrtc-star`,"p2p-webrtc-direct":r=>`${r}/p2p-webrtc-direct`};function E2(r,e){const t=G(r),n=t.toString().split("/").slice(1);return t.tuples().map(s=>({protocol:n.shift()??"",content:s[1]!=null?n.shift()??"":""})).reduce((s,i,o,a)=>{const c=LF[i.protocol];if(c==null)throw new Error(`Unsupported protocol ${i.protocol}`);return c(s,i.content,o,a,e)},"")}function MF(r){if(!Array.isArray(r))throw new TypeError(`Expected an array, got ${typeof r}`);r=[...r];for(let e=r.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[r[e],r[t]]=[r[t],r[e]]}return r}const UF=P("ipfs:preload"),BF=lt.default?lt.default:lt,zF=new BF({concurrency:4});function FF(r,e={}){return UF(r),zF.add(async()=>{const n=(await xn.post(r,{signal:e.signal})).body.getReader();try{for(;;){const{done:s}=await n.read();if(s)return}}finally{n.releaseLock()}})}const na=P("ipfs:preload");function VF(r={}){if(r.enabled=Boolean(r.enabled),r.addresses=r.addresses||[],r.cache=r.cache||1e3,!r.enabled||!r.addresses.length)return na("preload disabled"),Object.assign(()=>{},{start:()=>{},stop:()=>{}});let e=!0,t=[];const n=r.addresses.map(o=>E2(o)),s=nd(r.cache),i=async o=>{try{if(e)throw new Error(`preload ${o} but preloader is not started`);const a=o.toString();if(s.has(a))return;s.set(a,!0);const c=MF(n);let h=!1;const l=Date.now();for(const u of c){if(e)throw new Error(`preload aborted for ${a}`);let f;try{f=new AbortController,t=t.concat(f),await FF(`${u}/api/v0/refs?r=true&arg=${encodeURIComponent(a)}`,{signal:f.signal}),h=!0}catch(g){g.type!=="aborted"&&na.error(g)}finally{t=t.filter(g=>g!==f)}if(h)break}na(`${h?"":"un"}successfully preloaded ${a} in ${Date.now()-l}ms`)}catch(a){na.error(a)}};return i.start=()=>{e=!1},i.stop=()=>{e=!0,na(`aborting ${t.length} pending preload request(s)`),t.forEach(o=>o.abort()),t=[]},i}const ol=P("ipfs:mfs-preload");function KF({preload:r,files:e,options:t={}}){if(t.interval=t.interval||30*1e3,!t.enabled){ol("MFS preload disabled");const o=async()=>{};return{start:o,stop:o}}let n="",s;const i=async()=>{try{const o=await e.stat("/"),a=o.cid.toString();n!==a&&(ol(`preloading updated MFS root ${n} -> ${o.cid}`),await r(o.cid),n=a)}catch(o){ol.error("failed to preload MFS root",o)}finally{s=setTimeout(i,t.interval)}};return{async start(){const o=await e.stat("/");n=o.cid.toString(),ol(`monitoring MFS root ${o.cid}`),s=setTimeout(i,t.interval)},stop(){clearTimeout(s)}}}let jF=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},HF=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const w5=r=>globalThis.DOMException===void 0?new HF(r):new DOMException(r),m5=r=>{const e=r.reason===void 0?w5("This operation was aborted."):r.reason;return e instanceof Error?e:w5(e)};function qF(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o;const a=new Promise((c,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(t===Number.POSITIVE_INFINITY){c(r);return}if(e.signal){const{signal:l}=e;l.aborted&&h(m5(l)),l.addEventListener("abort",()=>{h(m5(l))})}o=i.setTimeout.call(void 0,()=>{if(n){try{c(n())}catch(l){h(l)}return}if(typeof r.cancel=="function"&&r.cancel(),s===!1)c();else if(s instanceof Error)h(s);else{const l=s??`Promise timed out after ${t} milliseconds`;h(new jF(l))}},t),(async()=>{try{c(await r)}catch(l){h(l)}finally{i.clearTimeout.call(void 0,o)}})()});return a.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},a}const b5="lock:worker:request-read",E5="lock:worker:release-read",_5="lock:master:grant-read",v5="lock:worker:request-write",S5="lock:worker:release-write",R5="lock:master:grant-write",Us={},Ai=r=>{r.addEventListener("message",e=>{Ai.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{Ai.dispatchEvent("message",r,e)})};Ai.addEventListener=(r,e)=>{Us[r]==null&&(Us[r]=[]),Us[r].push(e)};Ai.removeEventListener=(r,e)=>{Us[r]!=null&&(Us[r]=Us[r].filter(t=>t===e))};Ai.dispatchEvent=function(r,e,t){Us[r]!=null&&Us[r].forEach(n=>n(e,t))};const A5=(r,e,t,n,s)=>(i,o)=>{if(o.data.type!==t)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>(i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{const h=l=>{if(l==null||l.data==null)return;const u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===n&&u.identifier===a.identifier&&(i.removeEventListener("message",h),c())};i.addEventListener("message",h)}))}}))},I5=(r,e,t,n)=>async()=>{const s=im();return globalThis.postMessage({type:e,identifier:s,name:r}),await new Promise(i=>{const o=a=>{if(a==null||a.data==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:n,identifier:s,name:r})}))};globalThis.addEventListener("message",o)})},GF={singleProcess:!1},WF=r=>{if(r=Object.assign({},GF,r),Boolean(globalThis.document)||r.singleProcess){const t=new EventTarget;return Ai.addEventListener("message",A5(t,"requestReadLock",b5,E5,_5)),Ai.addEventListener("message",A5(t,"requestWriteLock",v5,S5,R5)),t}return{isWorker:!0,readLock:t=>I5(t,b5,_5,E5),writeLock:t=>I5(t,v5,R5,S5)}},Js={};let Ts;async function vf(r,e){let t;const n=new Promise(s=>{t=s});return r.add(async()=>await qF((async()=>await new Promise(s=>{t(()=>{s()})}))(),{milliseconds:e.timeout})),await n}const YF=(r,e)=>{if(Ts.isWorker===!0)return{readLock:Ts.readLock(r,e),writeLock:Ts.writeLock(r,e)};const t=new lt({concurrency:1});let n;return{async readLock(){if(n!=null)return await vf(n,e);n=new lt({concurrency:e.concurrency,autoStart:!1});const s=n,i=vf(n,e);return t.add(async()=>(s.start(),await s.onIdle().then(()=>{n===s&&(n=null)}))),await i},async writeLock(){return n=null,await vf(t,e)}}},QF={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function _2(r){const e=Object.assign({},QF,r);return Ts==null&&(Ts=WF(e),Ts.isWorker!==!0&&(Ts.addEventListener("requestReadLock",t=>{Js[t.data.name]!=null&&Js[t.data.name].readLock().then(async n=>await t.data.handler().finally(()=>n()))}),Ts.addEventListener("requestWriteLock",async t=>{Js[t.data.name]!=null&&Js[t.data.name].writeLock().then(async n=>await t.data.handler().finally(()=>n()))}))),Js[e.name]==null&&(Js[e.name]=YF(e.name,e)),Js[e.name]}let al;function v2(r=!1){if(al)return al;const e=_2({singleProcess:r});return al={readLock:t=>async(...n)=>{const s=await e.readLock();try{return await t.apply(null,n)}finally{s()}},writeLock:t=>async(...n)=>{const s=await e.writeLock();try{return await t.apply(null,n)}finally{s()}}},al}const C5=P("ipfs:mfs:utils:with-mfs-root");async function S2(r,e){if(e&&e.signal&&e.signal.aborted)throw v(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await r.repo.datastore.open();let t;try{const n=await r.repo.datastore.get(O1);t=J.decode(n)}catch(n){if(n.code!=="ERR_NOT_FOUND")throw n;C5("Creating new MFS root");const s=De({Data:new Pe({type:"directory"}).marshal(),Links:[]}),i=await go.digest(s);if(t=J.createV0(i),await r.repo.blocks.put(t,s),e&&e.signal&&e.signal.aborted)throw v(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await r.repo.datastore.put(O1,t.bytes)}return C5(`Loaded MFS root /ipfs/${t}`),t}function R2(r=""){return(r.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean)}const Sf="ipfs",Xt=async(r,e,t)=>{const n=await S2(r,t);let s={entryType:"file"},i="";if(J.asCID(e)?i=`/ipfs/${e}`:i=e.toString(),i=i.trim(),i=i.replace(/(\/\/+)/g,"/"),i.endsWith("/")&&i.length>1&&(i=i.substring(0,i.length-1)),!i)throw v(new Error("paths must not be empty"),"ERR_NO_PATH");if(i.substring(0,1)!=="/")throw v(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");i.substring(i.length-1)==="/"&&(i=i.substring(0,i.length-1));const o=R2(i);if(o[0]===Sf){let c;o.length===2?c=`/${o.join("/")}`:c=`/${o.slice(0,o.length-1).join("/")}`,s={type:"ipfs",depth:o.length-2,entryType:"file",mfsPath:`/${o.join("/")}`,mfsDirectory:c,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}else{const c=`/${Sf}/${n}${o.length?"/"+o.join("/"):""}`,h=`/${Sf}/${n}/${o.slice(0,o.length-1).join("/")}`;s={type:"mfs",depth:o.length,entryType:"file",mfsDirectory:h,mfsPath:c,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}const a=s.type==="mfs"?s.mfsPath:s.path;try{const c=await Gn(a,r.repo.blocks,t);s.cid=c.cid,s.mfsPath=`/ipfs/${c.path}`,s.entryType=c.type,s.content=c.content,(s.entryType==="file"||s.entryType==="directory")&&(c.type==="file"||c.type==="directory")&&(s.unixfs=c.unixfs)}catch(c){if(c.code!=="ERR_NOT_FOUND")throw c}return s.exists=Boolean(s.cid),s},XF=Ue.bind({ignoreUndefined:!0}),JF=P("ipfs:mfs:stat"),ZF={withLocal:!1};function gd(r){async function e(t,n={}){n=XF(ZF,n),JF(`Fetching stats for ${t}`);const{type:s,cid:i,mfsPath:o}=await Xt(r,t,n),a=s==="ipfs"&&i?i:o;let c;try{c=await Gn(a,r.repo.blocks)}catch(h){throw h.code==="ERR_NOT_FOUND"?v(new Error(`${t} does not exist`),"ERR_NOT_FOUND"):h}if(!T5[c.type])throw new Error(`Cannot stat codec ${c.cid.code}`);return T5[c.type](c)}return x(e)}const T5={raw:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1}),file:r=>{const e={cid:r.cid,type:"file",size:r.unixfs.fileSize(),cumulativeSize:De(r.node).length+(r.node.Links||[]).reduce((t,n)=>t+(n.Tsize||0),0),blocks:r.unixfs.blockSizes.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:r.unixfs.mode};return r.unixfs.mtime&&(e.mtime=r.unixfs.mtime),e},directory:r=>{const e={cid:r.cid,type:"directory",size:0,cumulativeSize:De(r.node).length+(r.node.Links||[]).reduce((t,n)=>t+(n.Tsize||0),0),blocks:r.node.Links.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:r.unixfs.mode};return r.unixfs.mtime&&(e.mtime=r.unixfs.mtime),e},object:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,type:"file",blocks:0,local:void 0,sizeLocal:void 0,withLocality:!1}),identity:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1})},eV=P("ipfs:mfs:utils:to-trail");async function Oc(r,e){eV(`Creating trail for path ${e}`);const t=[];for await(const n of $b(e,r.repo.blocks))t.push({name:n.name,cid:n.cid,size:n.size,type:n.type});return t}const D7=async(r,e,t)=>{t.codec||(t.codec=Ks),t.hasher||(t.hasher=go),t.cidVersion===void 0&&(t.cidVersion=1),t.codec===Ks&&t.hasher!==go&&(t.cidVersion=1);const n=await t.hasher.digest(r),s=J.create(t.cidVersion,t.codec.code,n);return t.onlyHash||await e.put(s,r,{signal:t.signal}),s},P7=ld.code,O7=8;async function N7(r){return(await ld.encode(r)).subarray(0,8).reverse()}class tV{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}}class x7 extends tV{constructor(e,t){super(e,t),this._bucket=hd({hashFn:N7,bits:O7})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){yield*$7(this._bucket,e,this,this.options)}}async function*$7(r,e,t,n){const s=r._children,i=[];let o=0;for(let g=0;g<s.length;g++){const d=s.get(g);if(!d)continue;const p=g.toString(16).toUpperCase().padStart(2,"0");if(d instanceof Mt){let w;for await(const y of await $7(d,e,null,n))w=y;if(!w)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:p,Tsize:w.size,Hash:w.cid}),o+=w.size}else if(typeof d.value.flush=="function"){const w=d.value;let y;for await(const m of w.flush(e))y=m,yield y;const _=p+d.key;i.push({Name:_,Tsize:y.size,Hash:y.cid}),o+=y.size}else{const w=d.value;if(!w.cid)continue;const y=p+d.key,_=w.size;i.push({Name:y,Tsize:_,Hash:w.cid}),o+=_}}const a=Uint8Array.from(s.bitField().reverse()),h={Data:new Pe({type:"hamt-sharded-directory",data:a,fanout:r.tableSize(),hashType:P7,mtime:t&&t.mtime,mode:t&&t.mode}).marshal(),Links:i},l=De(js(h)),u=await D7(l,e,n),f=l.length+o;yield{cid:u,node:h,size:f}}const Ia=P("ipfs:mfs:core:utils:hamt-utils"),yd=async(r,e,t,n)=>{if(!n.parent.Data)throw new Error("Could not update HAMT directory because parent had no data");const s=Uint8Array.from(t._children.bitField().reverse()),i=Pe.unmarshal(n.parent.Data),o=new Pe({type:"hamt-sharded-directory",data:s,fanout:t.tableSize(),hashType:P7,mode:i.mode,mtime:i.mtime}),a=await r.hashers.getHasher(n.hashAlg),c={Data:o.marshal(),Links:e.sort((f,g)=>(f.Name||"").localeCompare(g.Name||""))},h=De(c),l=await a.digest(h),u=J.create(n.cidVersion,Be,l);return n.flush&&await r.repo.blocks.put(u,h),{node:c,cid:u,size:e.reduce((f,g)=>f+(g.Tsize||0),h.length)}},L7=async(r,e,t,n,s)=>{const i=new Mt({hash:t._options.hash,bits:t._options.bits},n,s);return n._putObjectAt(s,i),await wd(r,e,i,t),i},M7=async r=>{const e=hd({hashFn:N7,bits:O7});return await Promise.all(r.map(async t=>{const n=t.Name||"";if(n.length===2){const s=parseInt(n,16),i=new Mt({hash:e._options.hash,bits:e._options.bits},e,s);return e._putObjectAt(s,i),Promise.resolve()}return e.put(n.substring(2),{size:t.Tsize,cid:t.Hash})})),e},wd=async(r,e,t,n)=>{await Promise.all(e.map(async s=>{const i=s.Name||"";if(i.length===2){Ia("Populating sub bucket",i);const o=parseInt(i,16),a=await r.repo.blocks.get(s.Hash),c=it(a),h=new Mt({hash:n._options.hash,bits:n._options.bits},t,o);return t._putObjectAt(o,h),await wd(r,c.Links,h,n),Promise.resolve()}return n.put(i.substring(2),{size:s.Tsize,cid:s.Hash})}))},co=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),rV=async(r,e,t)=>{const n=await M7(t.Links),s=await n._findNewBucketAndPos(e),i=[{bucket:s.bucket,prefix:co(s.pos)}];let o=s.bucket;for(;o!==n;)i.push({bucket:o,prefix:co(o._posAtParent)}),o=o._parent;i.reverse(),i[0].node=t;for(let a=0;a<i.length;a++){const c=i[a];if(!c.node)throw new Error("Could not generate HAMT path");const h=c.node.Links.filter(g=>(g.Name||"").substring(0,2)===c.prefix).pop();if(!h){Ia(`Link ${c.prefix}${e} will be added`);continue}if(h.Name===`${c.prefix}${e}`){Ia(`Link ${c.prefix}${e} will be replaced`);continue}Ia(`Found subshard ${c.prefix}`);const l=await r.repo.blocks.get(h.Hash),u=it(l);if(!i[a+1]){Ia(`Loaded new subshard ${c.prefix}`),await L7(r,u.Links,n,c.bucket,parseInt(c.prefix,16));const g=await n._findNewBucketAndPos(e);i.push({bucket:g.bucket,prefix:co(g.pos),node:u});continue}const f=i[a+1];await wd(r,u.Links,f.bucket,n),f.node=u}return await n.put(e,!0),i.reverse(),{rootBucket:n,path:i}},nV=async(r,e,t={})=>{const n=new x7({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let i=0;i<e.length;i++)await n._bucket.put(e[i].name,{size:e[i].size,cid:e[i].cid});const s=await hr(n.flush(r.repo.blocks));if(!s)throw new Error("Flushing shard yielded no result");return s},nn=P("ipfs:mfs:core:utils:add-link");async function $o(r,e){let t=e.parent;if(e.parentCid){const s=J.asCID(e.parentCid);if(s===null)throw v(new Error("Invalid CID passed to addLink"),"EINVALIDPARENTCID");if(s.code!==Be)throw v(new Error("Unsupported codec. Only DAG-PB is supported"),"EINVALIDPARENTCID");nn(`Loading parent node ${s}`);const i=await r.repo.blocks.get(s);t=it(i)}if(!t)throw v(new Error("No parent node or CID passed to addLink"),"EINVALIDPARENT");if(!e.cid)throw v(new Error("No child cid passed to addLink"),"EINVALIDCHILDCID");if(!e.name)throw v(new Error("No child name passed to addLink"),"EINVALIDCHILDNAME");if(!e.size&&e.size!==0)throw v(new Error("No child size passed to addLink"),"EINVALIDCHILDSIZE");if(!t.Data)throw v(new Error("Parent node with no data passed to addLink"),"ERR_INVALID_PARENT");const n=Pe.unmarshal(t.Data);return n.type==="hamt-sharded-directory"?(nn("Adding link to sharded directory"),oV(r,{...e,parent:t})):t.Links.length>=e.shardSplitThreshold?(nn("Converting directory to sharded directory"),sV(r,{...e,parent:t,mtime:n.mtime,mode:n.mode})):(nn(`Adding ${e.name} (${e.cid}) to regular directory`),iV(r,{...e,parent:t}))}const sV=async(r,e)=>{const t=await nV(r,e.parent.Links.map(n=>({name:n.Name||"",size:n.Tsize||0,cid:n.Hash})).concat({name:e.name,size:e.size,cid:e.cid}),e);return nn(`Converted directory to sharded directory ${t.cid}`),t},iV=async(r,e)=>{const t=e.parent.Links.filter(h=>h.Name!==e.name);if(t.push({Name:e.name,Tsize:e.size,Hash:e.cid}),!e.parent.Data)throw v(new Error("Parent node with no data passed to addToDirectory"),"ERR_INVALID_PARENT");const n=Pe.unmarshal(e.parent.Data);let s;if(n.mtime){const h=Date.now(),l=Math.floor(h/1e3);n.mtime={secs:l,nsecs:(h-l*1e3)*1e3},s=n.marshal()}else s=e.parent.Data;e.parent=js({Data:s,Links:t});const i=await r.hashers.getHasher(e.hashAlg),o=De(e.parent),a=await i.digest(o),c=J.create(e.cidVersion,Be,a);return e.flush&&await r.repo.blocks.put(c,o),{node:e.parent,cid:c,size:o.length}},oV=async(r,e)=>{const{shard:t,path:n}=await aV(r,e),s=await hr(t.flush(r.repo.blocks));if(!s)throw new Error("No result from flushing shard");const i=await r.repo.blocks.get(s.cid),o=it(i),a=e.parent.Links.filter(h=>(h.Name||"").substring(0,2)!==n[0].prefix),c=o.Links.find(h=>(h.Name||"").substring(0,2)===n[0].prefix);if(!c)throw new Error(`No link found with prefix ${n[0].prefix}`);return a.push(c),yd(r,a,n[0].bucket,e)},aV=async(r,e)=>{const t={name:e.name,cid:e.cid,size:e.size};if(!e.parent.Data)throw v(new Error("Parent node with no data passed to addFileToShardedDirectory"),"ERR_INVALID_PARENT");const n=await M7(e.parent.Links),s=Pe.unmarshal(e.parent.Data),i=new x7({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mode:s.mode},e);i._bucket=n,s.mtime&&(i.mtime={secs:Math.round(Date.now()/1e3)});const o=await n._findNewBucketAndPos(t.name),a=cV(o);a[0].node=e.parent;let c=0;for(;c<a.length;){const h=a[c];c++;const l=h.node;if(!l)throw new Error("Segment had no node");const u=l.Links.find(p=>(p.Name||"").substring(0,2)===h.prefix);if(!u){nn(`Link ${h.prefix}${t.name} will be added`),c=a.length;break}if(u.Name===`${h.prefix}${t.name}`){nn(`Link ${h.prefix}${t.name} will be replaced`),c=a.length;break}if((u.Name||"").length>2){nn(`Link ${u.Name} ${u.Hash} will be replaced with a subshard`),c=a.length;break}nn(`Found subshard ${h.prefix}`);const f=await r.repo.blocks.get(u.Hash),g=it(f);if(!a[c]){nn(`Loaded new subshard ${h.prefix}`),await L7(r,g.Links,n,h.bucket,parseInt(h.prefix,16));const p=await n._findNewBucketAndPos(t.name);a.push({bucket:p.bucket,prefix:co(p.pos),node:g});break}const d=a[c];await wd(r,g.Links,d.bucket,n),d.node=g}return await i._bucket.put(t.name,{size:t.size,cid:t.cid}),{shard:i,path:a}},cV=r=>{const e=[{bucket:r.bucket,prefix:co(r.pos)}];let t=r.bucket._parent,n=r.bucket._posAtParent;for(;t;)e.push({bucket:t,prefix:co(n)}),n=t._posAtParent,t=t._parent;return e.reverse(),e},k5=P("ipfs:mfs:utils:update-tree"),lV={shardSplitThreshold:1e3};async function Pi(r,e,t){t=Object.assign({},lV,t),k5("Trail",e),e=e.slice().reverse();let n=0,s;for await(const o of r.repo.blocks.getMany(e.map(a=>a.cid))){const a=it(o),c=e[n].cid,h=e[n].name;if(n++,!s){s={cid:c,name:h,size:o.length};continue}const l=await $o(r,{parent:a,name:s.name,cid:s.cid,size:s.size,flush:t.flush,shardSplitThreshold:t.shardSplitThreshold,hashAlg:t.hashAlg,cidVersion:t.cidVersion});s={cid:l.cid,name:h,size:l.size}}const{cid:i}=s;return k5(`Final CID ${i}`),i}const hV=P("ipfs:mfs:utils:update-mfs-root");async function Oi(r,e,t){if(t&&t.signal&&t.signal.aborted)throw v(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});return hV(`New MFS root will be ${e}`),await r.repo.datastore.put(O1,e.bytes),e}async function uV(r,e,t){const n=new Pe({type:e,mode:t.mode,mtime:t.mtime}),s=await r.hashers.getHasher(t.hashAlg),i={Data:n.marshal(),Links:[]},o=De(i),a=await s.digest(o),c=J.create(t.cidVersion,Be,a);return t.flush&&await r.repo.blocks.put(c,o),{cid:c,node:i}}const dV=Ue.bind({ignoreUndefined:!0}),U7=P("ipfs:mfs:mkdir"),fV={parents:!1,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3,flush:!0};function Yh(r){async function e(t,n={}){const s=dV(fV,n);if(!t)throw new Error("no path given to Mkdir");if(t=t.trim(),t==="/"){if(s.parents)return;throw v(new Error("cannot create directory '/': Already exists"),"ERR_INVALID_PATH")}if(t.substring(0,1)!=="/")throw v(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");U7(`Creating ${t}`);const i=R2(t);if(i[0]==="ipfs")throw v(new Error("path cannot have the prefix 'ipfs'"),"ERR_INVALID_PATH");const o=await S2(r,s);let a;const c=[],h=await uV(r,"directory",s);for(let u=0;u<=i.length;u++){const f=i.slice(0,u),g=`/ipfs/${o}/${f.join("/")}`;try{if(a=await Gn(g,r.repo.blocks),a.type!=="file"&&a.type!=="directory")throw v(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(u===i.length){if(s.parents)return;throw v(new Error("file already exists"),"ERR_ALREADY_EXISTS")}c.push({name:a.name,cid:a.cid})}catch(d){if(d.code==="ERR_NOT_FOUND"){if(u<i.length&&!s.parents)throw v(new Error(`Intermediate directory path ${g} does not exist, use the -p flag to create it`),"ERR_NOT_FOUND");await pV(r,f[f.length-1],h,c[c.length-1],c,s)}else throw d}}const l=await Pi(r,c,s);await Oi(r,l,s)}return x(e)}const pV=async(r,e,t,n,s,i)=>{U7(`Adding empty dir called ${e} to ${n.cid}`);const o=await $o(r,{parent:n.node,parentCid:n.cid,size:0,cid:t.cid,name:e,hashAlg:i.hashAlg,cidVersion:i.cidVersion,flush:i.flush,shardSplitThreshold:i.shardSplitThreshold});s[s.length-1].cid=o.cid,s.push({name:e,cid:t.cid})},gV=Ue.bind({ignoreUndefined:!0}),cl=P("ipfs:mfs:cp"),yV={parents:!1,flush:!0,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3};function A2(r){async function e(t,n,s={}){const i=gV(yV,s);Array.isArray(t)||(t=[t]);const o=await Promise.all(t.map(f=>Xt(r,f,i)));let a=await Xt(r,n,i);if(!o.length||!a)throw v(new Error("Please supply at least one source"),"ERR_INVALID_PARAMS");const c=o.find(f=>!f.exists);if(c)throw v(new Error(`${c.path} does not exist`),"ERR_INVALID_PARAMS");const h=D5(a);if(a.exists){if(cl("Destination exists"),o.length===1&&!h)throw v(new Error("directory already has entry by that name"),"ERR_ALREADY_EXISTS")}else if(cl("Destination does not exist"),o.length>1){if(!i.parents)throw v(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await Yh(r)(a.path,i),a=await Xt(r,a.path,i)}else if(a.parts.length>1){const f=`/${a.parts.slice(0,-1).join("/")}`;try{await gd(r)(f,i)}catch(g){if(g.code!=="ERR_NOT_FOUND")throw g;if(!i.parents)throw v(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await Yh(r)(f,i),a=await Xt(r,a.path,i)}}const l=D5(a)?a.mfsPath:a.mfsDirectory,u=await Oc(r,l);if(o.length===1){const f=o.pop();if(!f)throw v(new Error("could not find source"),"ERR_INVALID_PARAMS");const g=h?f.name:a.name;return cl(`Only one source, copying to destination ${h?"directory":"file"} ${g}`),wV(r,f,g,u,i)}return cl("Multiple sources, wrapping in a directory"),mV(r,o,a,u,i)}return x(e)}const D5=r=>r.unixfs&&r.unixfs.type&&r.unixfs.type.includes("directory"),wV=async(r,e,t,n,s)=>{let i=n.pop();if(!i)throw v(new Error("destination had no parent"),"ERR_INVALID_PARAMS");i=await B7(r,e,t,i,s),n.push(i);const o=await Pi(r,n,s);await Oi(r,o,s)},mV=async(r,e,t,n,s)=>{for(let o=0;o<e.length;o++){const a=e[o];t=await B7(r,a,a.name,t,s)}n[n.length-1]=t;const i=await Pi(r,n,s);await Oi(r,i,s)},B7=async(r,e,t,n,s)=>{const i=await r.repo.blocks.get(e.cid),{node:o,cid:a,size:c}=await $o(r,{parentCid:n.cid,size:i.length,cid:e.cid,name:t,hashAlg:s.hashAlg,cidVersion:s.cidVersion,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold});return n.node=o,n.cid=a,n.size=c,n},Os=P("ipfs:mfs:core:utils:remove-link");async function bV(r,e){let t=e.parent;if(e.parentCid){const s=J.asCID(e.parentCid);if(s===null)throw v(new Error("Invalid CID passed to removeLink"),"EINVALIDPARENTCID");Os(`Loading parent node ${s}`);const i=await r.repo.blocks.get(s);t=it(i)}if(!t)throw v(new Error("No parent node or CID passed to removeLink"),"EINVALIDPARENT");if(!e.name)throw v(new Error("No child name passed to removeLink"),"EINVALIDCHILDNAME");if(!t.Data)throw v(new Error("Parent node had no data"),"ERR_INVALID_NODE");return Pe.unmarshal(t.Data).type==="hamt-sharded-directory"?(Os(`Removing ${e.name} from sharded directory`),_V(r,{...e,parent:t})):(Os(`Removing link ${e.name} regular directory`),EV(r,{...e,parent:t}))}const EV=async(r,e)=>{e.parent.Links=e.parent.Links.filter(o=>o.Name!==e.name);const t=await De(e.parent),s=await(await r.hashers.getHasher(e.hashAlg)).digest(t),i=J.create(e.cidVersion,Be,s);return await r.repo.blocks.put(i,t),Os(`Updated regular directory ${i}`),{node:e.parent,cid:i}},_V=async(r,e)=>{const{rootBucket:t,path:n}=await rV(r,e.name,e.parent);await t.del(e.name);const{node:s}=await z7(r,n,e.name,e);return yd(r,s.Links,t,e)},z7=async(r,e,t,n)=>{const s=e.pop();if(!s)throw v(new Error("Could not find parent"),"EINVALIDPARENT");const{bucket:i,prefix:o,node:a}=s;if(!a)throw v(new Error("Could not find parent"),"EINVALIDPARENT");const c=a.Links.find(g=>(g.Name||"").substring(0,2)===o);if(!c)throw v(new Error(`No link found with prefix ${o} for file ${t}`),"ERR_NOT_FOUND");if(c.Name===`${o}${t}`){Os(`Removing existing link ${c.Name}`);const g=a.Links.filter(d=>d.Name!==c.Name);return await i.del(t),yd(r,g,i,n)}Os(`Descending into sub-shard ${c.Name} for ${o}${t}`);const h=await z7(r,e,t,n);let l=h.cid,u=h.size,f=o;if(h.node.Links.length===1){Os(`Removing subshard for ${o}`);const g=h.node.Links[0];f=`${o}${(g.Name||"").substring(2)}`,l=g.Hash,u=g.Tsize||0}return Os(`Updating shard ${o} with name ${f}`),vV(r,i,a,o,f,u,l,n)},vV=(r,e,t,n,s,i,o,a)=>{const c=t.Links.filter(h=>h.Name!==n);return c.push({Name:s,Tsize:i,Hash:o}),yd(r,c,e,a)},SV=Ue.bind({ignoreUndefined:!0}),RV={recursive:!1,cidVersion:0,hashAlg:"sha2-256",flush:!0,shardSplitThreshold:1e3};function I2(r){async function e(t,n={}){const s=SV(RV,n);Array.isArray(t)||(t=[t]);const i=await Promise.all(t.map(o=>Xt(r,o,s)));if(!i.length)throw v(new Error("Please supply at least one path to remove"),"ERR_INVALID_PARAMS");i.forEach(o=>{if(o.path==="/")throw v(new Error("Cannot delete root"),"ERR_INVALID_PARAMS")});for(const o of i)await AV(r,o.path,s)}return x(e)}const AV=async(r,e,t)=>{const n=await Xt(r,e,t),s=await Oc(r,n.mfsPath),i=s[s.length-1];s.pop();const o=s[s.length-1];if(!o)throw v(new Error(`${e} does not exist`),"ERR_NOT_FOUND");if(i.type==="directory"&&!t.recursive)throw v(new Error(`${e} is a directory, use -r to remove directories`),"ERR_WAS_DIR");const{cid:a}=await bV(r,{parentCid:o.cid,name:i.name,hashAlg:t.hashAlg,cidVersion:t.cidVersion,flush:t.flush,shardSplitThreshold:t.shardSplitThreshold});o.cid=a;const c=await Pi(r,s,t);await Oi(r,c,t)},IV=Ue.bind({ignoreUndefined:!0}),CV=P("ipfs:mfs:touch"),P5={flush:!0,shardSplitThreshold:1e3,hashAlg:"sha2-256",cidVersion:0,recursive:!1};function TV(r,e,t){let n=0;return(r.includes("x")||r.includes("X")&&(t||e&1||e&8||e&64))&&(n+=1),r.includes("w")&&(n+=2),r.includes("r")&&(n+=4),n}function kV(r,e){let t=0;return r.includes("u")&&(t+=e<<6),r.includes("g")&&(t+=e<<3),r.includes("o")&&(t+=e),t}function DV(r,e,t){return e.includes("t")&&(t+=parseInt("1000",8)),e.includes("s")&&(r.includes("u")&&(t+=parseInt("4000",8)),r.includes("g")&&(t+=parseInt("2000",8))),t}function PV(r,e,t){e||(e=0);const n=r.match(/^(u?g?o?a?)(-?\+?=?)?(r?w?x?X?s?t?)$/);if(!n)throw new Error(`Invalid file mode: ${r}`);let[,s,i,o]=n;(s==="a"||!s)&&(s="ugo");let a=TV(o,e,t);return a=kV(s,a),a=DV(s,o,a),i==="="?(s.includes("u")&&(e=e&parseInt("7077",8),e=e|a),s.includes("g")&&(e=e&parseInt("7707",8),e=e|a),s.includes("o")&&(e=e&parseInt("7770",8),e=e|a),e):i==="+"?a|e:i==="-"?a^e:e}function O5(r,e){if(r instanceof String||typeof r=="string"){const t=`${r}`;t.match(/^\d+$/g)?r=parseInt(t,8):r=0+t.split(",").reduce((n,s)=>PV(s,n,e.isDirectory()),e.mode||0)}return r}function OV(r){async function e(t,n,s={}){const i=IV(P5,s);CV(`Fetching stats for ${t}`);const{cid:o,mfsDirectory:a,name:c}=await Xt(r,t,i);if(o.code!==Be)throw v(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(i.recursive){const I=await ie(async function*(){for await(const C of Lb(o,r.repo.blocks)){if(C.type!=="file"&&C.type!=="directory")throw v(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");C.unixfs.mode=O5(n,C.unixfs);const D=js({Data:C.unixfs.marshal(),Links:C.node.Links});yield{path:C.path,content:D}}},C=>a2(C,r.repo.blocks,{...i,pin:!1,dagBuilder:async function*(D,$,K){for await(const W of D)yield async function(){const Q=W.content,V=De(Q),me=await D7(V,$,K);if(!Q.Data)throw v(new Error(`${me} had no data`),"ERR_INVALID_NODE");const Te=Pe.unmarshal(Q.Data);return{cid:me,size:V.length,path:W.path,unixfs:Te}}}}),C=>hr(C));if(!I)throw v(new Error(`Could not chmod ${t}`),"ERR_COULD_NOT_CHMOD");await I2(r)(t,i),await A2(r)(`/ipfs/${I.cid}`,t,i);return}const h=await r.repo.blocks.get(o),l=it(h);if(!l.Data)throw v(new Error(`${o} had no data`),"ERR_INVALID_NODE");const u=Pe.unmarshal(l.Data);u.mode=O5(n,u);const f=De({Data:u.marshal(),Links:l.Links}),g=i.hashAlg||P5.hashAlg,p=await(await r.hashers.getHasher(g)).digest(f),w=J.create(i.cidVersion,Be,p);i.flush&&await r.repo.blocks.put(w,f);const y=await Oc(r,a),_=y[y.length-1],m=J.decode(_.cid.bytes),b=await r.repo.blocks.get(m),S=it(b),A=await $o(r,{parent:S,name:c,cid:w,size:f.length,flush:i.flush,hashAlg:g,cidVersion:o.version,shardSplitThreshold:1/0});_.cid=A.cid;const E=await Pi(r,y,i);await Oi(r,E,i)}return x(e)}const NV=Ue.bind({ignoreUndefined:!0}),xV={};function $V(r){async function e(t,n={}){n=NV(xV,n);const{cid:s}=await gd(r)(t,n);return s}return x(e)}const LV=Ue.bind({ignoreUndefined:!0}),MV={parents:!1,flush:!0,cidVersion:0,hashAlg:"sha2-256",shardSplitThreshold:1e3};function UV(r){async function e(t,n,s={}){const i=LV(MV,s);await A2(r)(t,n,i),await I2(r)(t,{...i,recursive:!0})}return x(e)}const BV=Ue.bind({ignoreUndefined:!0}),zV=P("ipfs:mfs:touch"),N5={flush:!0,shardSplitThreshold:1e3,cidVersion:0,hashAlg:"sha2-256"};function FV(r){async function e(t,n={}){const s=BV(N5,n);s.mtime=s.mtime||new Date,zV(`Touching ${t} mtime: ${s.mtime}`);const{cid:i,mfsDirectory:o,name:a,exists:c}=await Xt(r,t,s),h=n.hashAlg||N5.hashAlg,l=await r.hashers.getHasher(h);let u,f,g=s.cidVersion;if(c){if(i.code!==Be)throw v(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");g=i.version;const S=await r.repo.blocks.get(i),A=it(S);if(!A.Data)throw v(new Error(`${t} had no data`),"ERR_INVALID_NODE");const E=Pe.unmarshal(A.Data);E.mtime=s.mtime,u=De({Data:E.marshal(),Links:A.Links});const I=await l.digest(u);f=J.create(s.cidVersion,Be,I),s.flush&&await r.repo.blocks.put(f,u)}else{const S=new Pe({type:"file",mtime:s.mtime});u=De({Data:S.marshal(),Links:[]});const A=await l.digest(u);f=J.create(s.cidVersion,Be,A),s.flush&&await r.repo.blocks.put(f,u)}const d=await Oc(r,o),p=d[d.length-1],w=p.cid,y=await r.repo.blocks.get(w),_=it(y),m=await $o(r,{parent:_,name:a,cid:f,size:u.length,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:g});p.cid=m.cid;const b=await Pi(r,d,s);await Oi(r,b,s)}return x(e)}const VV=Ue.bind({ignoreUndefined:!0}),KV={offset:0,length:1/0};function jV(r){function e(t,n={}){return n=VV(KV,n),{[Symbol.asyncIterator]:async function*(){const i=await Xt(r,t,n),o=await Gn(i.mfsPath,r.repo.blocks);if(o.type!=="file"&&o.type!=="raw")throw v(new Error(`${t} was not a file or raw bytes`),"ERR_NOT_FILE");if(!o.content)throw v(new Error(`Could not load content stream from ${t}`),"ERR_NO_CONTENT");for await(const a of o.content({offset:n.offset,length:n.length}))yield a}}}return x(e)}const sa=P("ipfs:mfs:utils:to-async-iterator");function HV(r){if(!r)throw v(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");if((typeof r=="string"||r instanceof String)&&(sa("Content was a string"),r=L(r.toString())),r.length)return sa("Content was array-like"),{[Symbol.asyncIterator]:function*(){yield r}};if(r[Symbol.asyncIterator])return sa("Content was an async iterator"),r;if(r[Symbol.iterator])return sa("Content was an iterator"),r;if(Rg.Blob&&r instanceof Rg.Blob)return sa("Content was an HTML5 Blob"),_i(r.stream());throw v(new Error(`Don't know how to convert ${r} into an async iterator`),"ERR_INVALID_PARAMS")}const qV=Ue.bind({ignoreUndefined:!0}),Yr=P("ipfs:mfs:write"),GV={offset:0,length:1/0,create:!1,truncate:!1,rawLeaves:!1,reduceSingleLeafToSelf:!1,cidVersion:0,hashAlg:"sha2-256",parents:!1,progress:(r,e)=>{},strategy:"trickle",flush:!0,leafType:"raw",shardSplitThreshold:1e3};function WV(r){async function e(t,n,s={}){const i=qV(GV,s);let o,a,c;if(Yr("Reading source, destination and parent"),await v2().readLock(async()=>{o=await HV(n),a=await Xt(r,t,i),c=await Xt(r,a.mfsDirectory,i)})(),Yr("Read source, destination and parent"),!i.parents&&!c.exists)throw v(new Error("directory does not exist"),"ERR_NO_EXIST");if(o==null)throw v(new Error("could not create source"),"ERR_NO_SOURCE");if(a==null)throw v(new Error("could not create destination"),"ERR_NO_DESTINATION");if(!i.create&&!a.exists)throw v(new Error("file does not exist"),"ERR_NO_EXIST");if(a.entryType!=="file")throw v(new Error("not a file"),"ERR_NOT_A_FILE");return YV(r,t,o,a,i)}return x(e)}const YV=async(r,e,t,n,s)=>{const i=await QV(r,t,n,s);await v2().writeLock(async()=>{const o=R2(e),a=o.pop();if(a==null)throw v(new Error("source does not exist"),"ERR_NO_EXIST");let c=!1;try{await gd(r)(`/${o.join("/")}`,s),c=!0}catch(w){if(w.code!=="ERR_NOT_FOUND")throw w}c||await Yh(r)(`/${o.join("/")}`,s);const h=await Xt(r,e,s),l=await Oc(r,h.mfsDirectory),u=l[l.length-1];if(!u)throw v(new Error("directory does not exist"),"ERR_NO_EXIST");if(!u.type||!u.type.includes("directory"))throw v(new Error(`cannot write to ${u.name}: Not a directory`),"ERR_NOT_A_DIRECTORY");const f=await r.repo.blocks.get(u.cid),g=it(f),d=await $o(r,{parent:g,name:a,cid:i.cid,size:i.size,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:s.cidVersion});u.cid=d.cid;const p=await Pi(r,l,s);await Oi(r,p,s)})()},QV=async(r,e,t,n)=>{t.exists?Yr(`Overwriting file ${t.cid} offset ${n.offset} length ${n.length}`):Yr(`Writing file offset ${n.offset} length ${n.length}`);const s=[];if(n.offset>0)if(t.unixfs){if(Yr(`Writing first ${n.offset} bytes of original file`),s.push(()=>t.content({offset:0,length:n.offset})),t.unixfs.fileSize()<n.offset){const l=n.offset-t.unixfs.fileSize();Yr(`Writing zeros for extra ${l} bytes`),s.push(x5(l))}}else Yr(`Writing zeros for first ${n.offset} bytes`),s.push(x5(n.offset));s.push(F7(e,n.length));const i=JV(XV(s),l=>{if(t.unixfs&&!n.truncate){const u=t.unixfs.fileSize();if(u>l)return Yr(`Writing last ${u-l} of ${u} bytes from original file starting at offset ${l}`),t.content({offset:l});Yr("Not writing last bytes from original file")}return{[Symbol.asyncIterator]:async function*(){}}});let o;n.mode!==void 0&&n.mode!==null?o=io(n.mode):t&&t.unixfs&&(o=t.unixfs.mode);let a;n.mtime!=null?a=Ya(n.mtime):t&&t.unixfs&&(a=t.unixfs.mtime);const c=await r.hashers.getHasher(n.hashAlg),h=await hr(a2([{content:i,mode:o,mtime:a}],r.repo.blocks,{progress:n.progress,hasher:c,cidVersion:n.cidVersion,strategy:n.strategy,rawLeaves:n.rawLeaves,reduceSingleLeafToSelf:n.reduceSingleLeafToSelf,leafType:n.leafType}));if(!h)throw v(new Error(`cannot write to ${parent.name}`),"ERR_COULD_NOT_WRITE");return Yr(`Wrote ${h.cid}`),{cid:h.cid,size:h.size}},F7=(r,e)=>async function*(){let n=0;for await(const s of r){if(n+=s.length,n>e){yield s.subarray(0,e-n);return}yield s}},x5=(r,e=_k)=>{const t=new Uint8Array(e);async function*n(){for(;;)yield t}return F7(n(),r)},XV=async function*(r){for(let e=0;e<r.length;e++)yield*r[e]()},JV=async function*(r,e){let t=0;for await(const n of r)t+=n.length,yield n;for await(const n of e(t))t+=n.length,yield n},$5=r=>{const e={cid:r.cid,name:r.name,type:r.type==="directory"?"directory":"file",size:r.size};return(r.type==="file"||r.type==="directory")&&(e.mode=r.unixfs.mode,e.mtime=r.unixfs.mtime),e};function ZV(r){async function*e(t,n={}){const s=await Xt(r,t,n),i=await Gn(s.mfsPath,r.repo.blocks);if(i.type==="directory"){yield*zt(i.content(n),$5);return}yield $5(i)}return x(e)}const eK={stat:gd},tK={chmod:OV,cp:A2,flush:$V,mkdir:Yh,mv:UV,rm:I2,touch:FV},L5={write:WV,read:jV,ls:ZV},M5=({options:r,mfs:e,operations:t,lock:n})=>{Object.keys(t).forEach(s=>{e[s]=n(t[s](r))})},rK={repoOwner:!0,repo:null};function nK(r){const{repoOwner:e}=Object.assign({},rK||{},r),t=v2(e),n=o=>t.readLock(o),s=o=>t.writeLock(o),i={};return M5({options:r,mfs:i,operations:eK,lock:n}),M5({options:r,mfs:i,operations:tK,lock:s}),Object.keys(L5).forEach(o=>{i[o]=L5[o](r)}),i}function sK({repo:r,preload:e,hashers:t,options:n}){const s=nK({repo:r,repoOwner:n.repoOwner!==!1,hashers:t}),i=o=>(...c)=>{const h=c.filter(l=>xT(l)||Bp(l));if(h.length){const l=c[c.length-1];l&&l.preload!==!1&&h.forEach(u=>e(u))}return o(...c)};return{...s,chmod:s.chmod,cp:i(s.cp),mkdir:s.mkdir,stat:i(s.stat),rm:s.rm,read:i(s.read),touch:s.touch,write:s.write,mv:i(s.mv),flush:s.flush,ls:i(async function*(...o){for await(const a of s.ls(...o))yield{...a,size:a.size||0}})}}function iK({keychain:r}){return x((t,n)=>r.exportKey(t,n))}const U5="Ed25519",B5=2048;function oK({keychain:r}){return x((t,n={type:U5,size:B5})=>r.createKey(t,n.type||U5,n.size||B5))}function aK({keychain:r}){return x((t,n,s)=>r.importKey(t,n,s))}function cK({keychain:r}){return x(t=>r.findKeyByName(t))}function lK({keychain:r}){return x(()=>r.listKeys())}function hK({keychain:r}){return x(async(t,n)=>{const s=await r.renameKey(t,n);return{was:t,now:s.name,id:s.id,overwrite:!1}})}function uK({keychain:r}){return x(t=>r.removeKey(t))}class dK{constructor({keychain:e}){this.gen=oK({keychain:e}),this.list=lK({keychain:e}),this.rm=uK({keychain:e}),this.rename=hK({keychain:e}),this.export=iK({keychain:e}),this.import=aK({keychain:e}),this.info=cK({keychain:e})}}function Ni({repo:r,preload:e}){async function t(n,s={}){s.preload!==!1&&e(n);const i=await r.blocks.get(n,s);return it(i)}return x(t)}function fK({repo:r,preload:e}){const t=Ni({repo:r,preload:e});async function n(s,i={}){return(await t(s,i)).Data||new Uint8Array(0)}return x(n)}function E0(r,e=[]){for(const t in r){const n=r[t];if(t==="/"&&Object.keys(r).length===1)try{e.push({Name:"",Tsize:0,Hash:J.parse(n)});continue}catch{}const s=J.asCID(n);if(s){e.push({Name:"",Tsize:0,Hash:s});continue}Array.isArray(n)&&E0(n,e),n&&typeof n=="object"&&E0(n,e)}return e}function pK({repo:r,codecs:e}){async function t(n,s={}){const i=await e.getCodec(n.code),o=await r.blocks.get(n,s),a=i.decode(o);switch(n.code){case xp:return[];case Be:return a.Links;case tm:case Im:return E0(a);default:throw new Error(`Cannot resolve links from codec ${n.code}`)}}return x(t)}function gK({repo:r,preload:e}){async function t(n={}){let s;if(n.template)if(n.template==="unixfs-dir")s=new Pe({type:"directory"}).marshal();else throw new Error("unknown template");const i=De({Data:s,Links:[]}),o=await go.digest(i),a=J.createV0(o);return await r.blocks.put(a,i,{signal:n.signal}),n.preload!==!1&&e(a),a}return x(t)}function Nc({repo:r,preload:e}){async function t(n,s={}){const i=await r.gcLock.readLock();try{const o=De(n),a=await go.digest(o),c=J.createV1(Be,a);return await r.blocks.put(c,o,{signal:s.signal}),s.preload!==!1&&e(c),s.pin&&await r.pins.pinRecursively(c,{signal:s.signal}),c}finally{i()}}return x(t)}function yK({repo:r,preload:e}){const t=Ni({repo:r,preload:e});async function n(s,i={}){const o=await t(s,i),c=De(o).length,h=o.Links.reduce((l,u)=>l+(u.Tsize||0),0);return{Hash:s,NumLinks:o.Links.length,BlockSize:c,LinksSize:c-(o.Data||[]).length,DataSize:(o.Data||[]).length,CumulativeSize:c+h}}return x(n)}function wK({repo:r,preload:e}){const t=Ni({repo:r,preload:e}),n=Nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a);return n({...c,Links:c.Links.concat([o])},a)}return x(s)}function mK({repo:r,preload:e}){const t=Ni({repo:r,preload:e}),n=Nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a),h=qe([c.Data||[],o]);return n({...c,Data:h},a)}return x(s)}function bK({repo:r,preload:e}){const t=Ni({repo:r,preload:e}),n=Nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a),h=(typeof o=="string"?o:o.Name)||"";return c.Links=c.Links.filter(l=>l.Name!==h),n(c,a)}return x(s)}function EK({repo:r,preload:e}){const t=Ni({repo:r,preload:e}),n=Nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a);return n({...c,Data:o},a)}return x(s)}class _K{constructor({repo:e,preload:t}){this.addLink=wK({repo:e,preload:t}),this.appendData=mK({repo:e,preload:t}),this.rmLink=bK({repo:e,preload:t}),this.setData=EK({repo:e,preload:t})}}class vK{constructor({repo:e,codecs:t,preload:n}){this.data=fK({repo:e,preload:n}),this.get=Ni({repo:e,preload:n}),this.links=pK({repo:e,codecs:t}),this.new=gK({repo:e,preload:n}),this.put=Nc({repo:e,preload:n}),this.stat=yK({repo:e,preload:n}),this.patch=new _K({repo:e,preload:n})}}const SK=P("ipfs:repo:gc");function RK({repo:r,hashers:e}){async function*t(n={}){const s=Date.now();let i;try{i=await S2({repo:r,hashers:e},n),await r.pins.pinRecursively(i),yield*r.gc()}finally{i&&await r.pins.unpin(i)}SK(`Complete (${Date.now()-s}ms)`)}return x(t)}function V7({repo:r}){async function e(t={}){const n=await r.stat();return{numObjects:BigInt(n.numObjects.toString()),repoSize:BigInt(n.repoSize.toString()),repoPath:n.repoPath,version:`${n.version}`,storageMax:BigInt(n.storageMax.toString())}}return x(e)}const jl=12;function AK({repo:r}){async function e(t={}){try{await r._checkInitialized(t)}catch(n){if([/Key not found in database \[\/version\]/,/ENOENT/,/repo is not initialized yet/].some(i=>i.test(n.message)))return jl;throw n}return r.version.get()}return x(e)}class IK{constructor({repo:e,hashers:t}){this.gc=RK({repo:e,hashers:t}),this.stat=V7({repo:e}),this.version=AK({repo:e}),this.setApiAddr=n=>e.apiAddr.set(n)}}function z5(r,e){return{totalIn:BigInt(0),totalOut:BigInt(0),rateIn:0,rateOut:0}}function CK({network:r}){return x(async function*(t={}){const{libp2p:n}=await r.use(t);if(!t.poll){yield z5();return}const s=t.interval||1e3;let i=-1;try{if(i=typeof s=="string"?re(s)||-1:s,!i||i<0)throw new Error("invalid duration")}catch(a){throw v(a,"ERR_INVALID_POLL_INTERVAL")}let o;try{for(;;)yield z5(n,t),await new Promise(a=>{o=setTimeout(a,i)})}finally{clearTimeout(o)}})}class TK{constructor({repo:e,network:t}){this.repo=V7({repo:e}),this.bw=CK({network:t}),this.bitswap=q8({network:t})}}var C2=kK;function kK(r,e,t){if(!r)return t;var n,s;if(Array.isArray(e)&&(n=e.slice(0)),typeof e=="string"&&(n=e.split(".")),typeof e=="symbol"&&(n=[e]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");for(;n.length;)if(s=n.shift(),!r||(r=r[s],r===void 0))return t;return r}var DK=K7,F5=128,PK=127,OK=~PK,NK=Math.pow(2,31);function K7(r,e,t){e=e||[],t=t||0;for(var n=t;r>=NK;)e[t++]=r&255|F5,r/=128;for(;r&OK;)e[t++]=r&255|F5,r>>>=7;return e[t]=r|0,K7.bytes=t-n+1,e}var xK=_0,$K=128,V5=127;function _0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw _0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&V5)<<s:(o&V5)*Math.pow(2,s),s+=7}while(o>=$K);return _0.bytes=i-n,t}var LK=Math.pow(2,7),MK=Math.pow(2,14),UK=Math.pow(2,21),BK=Math.pow(2,28),zK=Math.pow(2,35),FK=Math.pow(2,42),VK=Math.pow(2,49),KK=Math.pow(2,56),jK=Math.pow(2,63),HK=function(r){return r<LK?1:r<MK?2:r<UK?3:r<BK?4:r<zK?5:r<FK?6:r<VK?7:r<KK?8:r<jK?9:10},qK={encode:DK,decode:xK,encodingLength:HK},Qh=qK;const v0=(r,e=0)=>[Qh.decode(r,e),Qh.decode.bytes],Xh=(r,e,t=0)=>(Qh.encode(r,e,t),e),Jh=r=>Qh.encodingLength(r),GK=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},T2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},S0=(r,e)=>{const t=e.byteLength,n=Jh(r),s=n+Jh(t),i=new Uint8Array(s+t);return Xh(r,i,0),Xh(t,i,n),i.set(e,s),new D2(r,t,e,i)},k2=r=>{const e=T2(r),[t,n]=v0(e),[s,i]=v0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new D2(t,s,o,e)},WK=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&GK(r.bytes,t.bytes)}};let D2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function YK(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var QK=YK,XK=QK;let JK=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ZK=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return j7(this,e)}},ej=class{constructor(e){this.decoders=e}or(e){return j7(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const j7=(r,e)=>new ej({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let tj=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new JK(e,t,n),this.decoder=new ZK(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const H7=({name:r,prefix:e,encode:t,decode:n})=>new tj(r,e,t,n),q7=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=XK(t,e);return H7({prefix:r,name:e,encode:n,decode:i=>T2(s(i))})},rj=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},nj=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Yn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>H7({prefix:e,name:r,encode(s){return nj(s,n,t)},decode(s){return rj(s,n,t,r)}}),Es=q7({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});q7({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const cn=Yn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Yn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Yn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Yn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Yn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Yn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Yn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Yn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Yn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const K5=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return ij(t,R0(r),e||Es.encoder);default:return oj(t,R0(r),e||cn.encoder)}},j5=new WeakMap,R0=r=>{const e=j5.get(r);if(e==null){const t=new Map;return j5.set(r,t),t}return e};let Gs=class Tt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ia)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==aj)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Tt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=S0(e,t);return Tt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Tt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&WK(e.multihash,n.multihash)}toString(e){return K5(this,e)}toJSON(){return{"/":K5(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Tt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Tt(n,s,i,o||H5(n,s,i.bytes))}else if(t[cj]===!0){const{version:n,multihash:s,code:i}=t,o=k2(s);return Tt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ia)throw new Error(`Version 0 CID must use dag-pb (code: ${ia}) block encoding`);return new Tt(e,t,n,n.bytes)}case 1:{const s=H5(e,t,n.bytes);return new Tt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Tt.create(0,ia,e)}static createV1(e,t){return Tt.create(1,e,t)}static decode(e){const[t,n]=Tt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Tt.inspectBytes(e),n=t.size-t.multihashSize,s=T2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new D2(t.multihashCode,t.digestSize,i,s);return[t.version===0?Tt.createV0(o):Tt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=v0(e.subarray(t));return t+=f,u};let s=n(),i=ia;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=sj(e,t),i=Tt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return R0(i).set(n,e),i}};const sj=(r,e)=>{switch(r[0]){case"Q":{const t=e||Es;return[Es.prefix,t.decode(`${Es.prefix}${r}`)]}case Es.prefix:{const t=e||Es;return[Es.prefix,t.decode(r)]}case cn.prefix:{const t=e||cn;return[cn.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},ij=(r,e,t)=>{const{prefix:n}=t;if(n!==Es.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},oj=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ia=112,aj=18,H5=(r,e,t)=>{const n=Jh(r),s=n+Jh(e),i=new Uint8Array(s+t.byteLength);return Xh(r,i,0),Xh(e,i,n),i.set(t,s),i},cj=Symbol.for("@ipld/js-cid/CID");async function Eo(r){let e=0;for await(const t of r)e++;return e}const lj=85,hj=Br("ipfs:repo:migrator:migration-8");function G7(r){return r.child?G7(r.child):r}function uj(r){try{const e=cn.decode(`b${r.toString().toLowerCase().slice(1)}`),t=Gs.decode(e).multihash.bytes,n=cn.encode(t).slice(1).toUpperCase();return new X(`/${n}`,!1)}catch{return r}}function dj(r){try{const e=cn.decode(`b${r.toString().toLowerCase().slice(1)}`),t=k2(e),n=cn.encode(Gs.createV1(lj,t).bytes).slice(1);return new X(`/${n.toUpperCase()}`,!1)}catch{return r}}async function q5(r,e,t){const n=r.blocks;await n.open();const s=G7(n),i=await Eo(s.queryKeys({filters:[o=>t(o).toString()!==o.toString()]}));try{let o=0;for await(const a of s.query({})){const c=t(a.key);c.toString()!==a.key.toString()&&(o+=1,hj(`Migrating Block from ${a.key} to ${c}`,await s.has(a.key)),await s.delete(a.key),await s.put(c,a.value),e(o/i*100,`Migrated Block from ${a.key} to ${c}`))}}finally{await n.close()}}const fj={version:8,description:"Transforms key names into base32 encoding and converts Block store to use bare multihashes encoded as base32",migrate:(r,e=()=>{})=>q5(r,e,uj),revert:(r,e=()=>{})=>q5(r,e,dj)},G5=j.Reader,pj=j.Writer;j.util;const ll=j.roots.default||(j.roots.default={}),gj=ll.ipfs=(()=>{const r={};return r.pin=function(){const e={};return e.Set=function(){function t(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}return t.prototype.version=0,t.prototype.fanout=0,t.prototype.seed=0,t.encode=function(s,i){return i||(i=pj.create()),s.version!=null&&Object.hasOwnProperty.call(s,"version")&&i.uint32(8).uint32(s.version),s.fanout!=null&&Object.hasOwnProperty.call(s,"fanout")&&i.uint32(16).uint32(s.fanout),s.seed!=null&&Object.hasOwnProperty.call(s,"seed")&&i.uint32(29).fixed32(s.seed),i},t.decode=function(s,i){s instanceof G5||(s=G5.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new ll.ipfs.pin.Set;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:a.version=s.uint32();break;case 2:a.fanout=s.uint32();break;case 3:a.seed=s.fixed32();break;default:s.skipType(c&7);break}}return a},t.fromObject=function(s){if(s instanceof ll.ipfs.pin.Set)return s;var i=new ll.ipfs.pin.Set;return s.version!=null&&(i.version=s.version>>>0),s.fanout!=null&&(i.fanout=s.fanout>>>0),s.seed!=null&&(i.seed=s.seed>>>0),i},t.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(o.version=0,o.fanout=0,o.seed=0),s.version!=null&&s.hasOwnProperty("version")&&(o.version=s.version),s.fanout!=null&&s.hasOwnProperty("fanout")&&(o.fanout=s.fanout),s.seed!=null&&s.hasOwnProperty("seed")&&(o.seed=s.seed),o},t.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},t}(),e}(),r})();var Zh={},yj={get exports(){return Zh},set exports(r){Zh=r}};(function(r,e){Object.defineProperty(e,"__esModule",{value:!0}),t.BASE=2166136261;function t(n,s=t.BASE){const i=n.length;for(let o=0;o<i;o++)s^=n.charCodeAt(o),s+=(s<<1)+(s<<4)+(s<<7)+(s<<8)+(s<<24);return s>>>0}e.default=t,r.exports=t})(yj,Zh);const wj=Wu(Zh),Hl=new X("/local/pins"),Rf=256,mj=8192,W7=Gs.parse("QmdfTbBqBPQ7VNxZEYEj14VmRuZBkqFbiwReogJgS1zR1n"),Xi={direct:"direct",recursive:"recursive"};function W5(r){return new X(`/${cn.encode(r.multihash.bytes).toUpperCase().substring(1)}`)}const Y7=({name:r,code:e,encode:t})=>new bj(r,e,t);let bj=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?S0(this.code,t):t.then(n=>S0(this.code,n))}else throw Error("Unknown type, must be binary type")}};const Q7=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),P2=Y7({name:"sha2-256",code:18,encode:Q7("SHA-256")});Y7({name:"sha2-512",code:19,encode:Q7("SHA-512")});const A0=gj.pin.Set;function Ej(r){const e=r.Data;if(!e)throw new Error("No data present");const t=je.decode(e),n=je.decode.bytes??0;if(n<=0)throw new Error("Invalid Set header length");if(n+t>e.length)throw new Error("Impossibly large set header length");const s=e.slice(n,t+n),i=A0.toObject(A0.decode(s),{defaults:!1,arrays:!0,longs:Number,objects:!1});if(i.version!==1)throw new Error(`Unsupported Set version: ${i.version}`);if(i.fanout>r.Links.length)throw new Error("Impossibly large fanout");return{header:i,data:e.slice(t+n)}}function _j(r,e){const t=new Uint8Array(4);new DataView(t.buffer).setUint32(0,r,!0);const s=L(e.toString()),i=qe([t,s],t.byteLength+s.byteLength);return wj(B(i))}async function*X7(r,e){const t=Ej(e);let n=0;for(const s of e.Links){if(n<t.header.fanout){const i=s.Hash;if(!W7.equals(i)){const o=await r.get(i),a=it(o);yield*X7(r,a)}}else yield s.Hash;n++}}async function*hl(r,e,t){const n=e.Links.find(o=>o.Name===t);if(!n)throw new Error("No link found with name "+t);const s=await r.get(n.Hash),i=it(s);yield*X7(r,i)}function vj(r,e){return t(e,0);async function t(n,s){const i=A0.encode({version:1,fanout:Rf,seed:s}).finish(),o=je.encode(i.length),a=qe([o,i]),c=[];for(let l=0;l<Rf;l++)c.push({Name:"",Tsize:1,Hash:W7});if(n.length<=mj){const l=n.map(g=>({link:{Name:"",Tsize:1,Hash:g.key},data:g.data||new Uint8Array})).sort((g,d)=>c1(g.link.Hash.bytes,d.link.Hash.bytes)),u=c.concat(l.map(g=>g.link));return{Data:qe([a,...l.map(g=>g.data)]),Links:u}}else{const l=n.reduce((f,g)=>{const d=_j(s,g.key)%Rf;return f[d]=d in f?f[d].concat([g]):[g],f},[]);let u=0;for(const f of l){const g=await t(f,s+1);await h(g,u),u++}return{Data:a,Links:c}}async function h(l,u){const f=De(l),g=await P2.digest(f),d=Gs.createV0(g);await r.put(d,f);const p=l.Links.reduce((w,y)=>w+(y.Tsize||0),0)+f.length;c[u]={Name:"",Tsize:p,Hash:d}}}}async function Y5(r,e,t){const n=await vj(r,t.map(c=>({key:c}))),s=De(n),i=await P2.digest(s),o=Gs.createV0(i);await r.put(o,s);const a=n.Links.reduce((c,h)=>c+h.Tsize,0)+s.length;return{Name:e,Tsize:a,Hash:o}}async function Sj(r,e,t,n){if(!await e.has(Hl))return;const s=await e.get(Hl),i=Gs.decode(s),o=await r.get(i),a=it(o);let c=0;const h=await Eo(hl(r,a,Xi.recursive))+await Eo(hl(r,a,Xi.direct));for await(const l of hl(r,a,Xi.recursive)){c++;const u={depth:1/0};l.version!==0&&(u.version=l.version),l.code!==Be&&(u.codec=l.code),await t.put(W5(l),Ha(u)),n(c/h*100,`Migrated recursive pin ${l}`)}for await(const l of hl(r,a,Xi.direct)){c++;const u={depth:0};l.version!==0&&(u.version=l.version),l.code!==Be&&(u.codec=l.code),await t.put(W5(l),Ha(u)),n(c/h*100,`Migrated direct pin ${l}`)}await r.delete(i),await e.delete(Hl)}async function Rj(r,e,t,n){const s=[],i=[];let o=0;const a=await Eo(t.queryKeys({}));for await(const{key:f,value:g}of t.query({})){o++;const d=Tn(g),p=Gs.create(d.version||0,d.codec||Be,k2(cn.decode("b"+f.toString().toLowerCase().split("/").pop())));d.depth===0?(n(o/a*100,`Reverted direct pin ${p}`),i.push(p)):(n(o/a*100,`Reverted recursive pin ${p}`),s.push(p))}n(100,"Updating pin root");const c={Links:[await Y5(r,Xi.direct,i),await Y5(r,Xi.recursive,s)]},h=De(c),l=await P2.digest(h),u=Gs.createV0(l);await r.put(u,h),await e.put(Hl,u.bytes)}async function Q5(r,e,t){const n=r.blocks,s=r.datastore,i=r.pins;await n.open(),await s.open(),await i.open();try{await t(n,s,i,e)}finally{await i.close(),await s.close(),await n.close()}}const Aj={version:9,description:"Migrates pins to datastore",migrate:(r,e=()=>{})=>Q5(r,e,Sj),revert:(r,e=()=>{})=>Q5(r,e,Rj)},Ij=new X("/config"),O2=new X("/version");function md(r){let e=r;for(;e.db||e.child;)if(e=e.db||e.child,e.type==="level-js"||e.constructor.name==="Level")return e}async function Cj(r,e,t){const n=await e(r);if(n)return n;const s=md(t);return s?new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{i(Boolean(a.result))}}):!1}async function Tj(r,e,t,n){if(await t(r))return e(r);const s=md(n);if(!s)throw hn();return new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{if(a.result)return i(a.result);o(hn())}})}function ul(r){const e=r.get.bind(r),t=r.has.bind(r);return r.get=n=>Tj(n,e,t,r),r.has=n=>Cj(n,t,r),r}function J7(r){return{...r,root:ul(r.root),datastore:ul(r.datastore),pins:ul(r.pins),keys:ul(r.keys)}}async function kj(r,e,t=()=>{}){const n=md(e);if(!n){t(`${r} did not need an upgrade`);return}t(`Upgrading ${r}`),await e9(n,(i,o)=>[{type:"del",key:i},{type:"put",key:L(i),value:o}])}async function Dj(r,e,t=()=>{}){const n=md(e);if(!n){t(`${r} did not need a downgrade`);return}t(`Downgrading ${r}`),await e9(n,(i,o)=>[{type:"del",key:i},{type:"put",key:B(i),value:o}])}function Z7(r){return r.child?Z7(r.child):r}async function X5(r,e,t){const n=Object.entries(r).map(([o,a])=>({key:o,backend:Z7(a)})).filter(({key:o,backend:a})=>a.constructor.name==="LevelDatastore").map(({key:o,backend:a})=>({name:o,store:a}));e(0,`Migrating ${n.length} dbs`);let s=0;const i=o=>{e(Math.round(s/n.length*100),o)};for(const{name:o,store:a}of n){await a.open();try{await t(o,a,i)}finally{s++,await a.close()}}e(100,`Migrated ${n.length} dbs`)}const Pj={version:10,description:"Migrates datastore-level keys to binary",migrate:(r,e=()=>{})=>X5(r,e,kj),revert:(r,e=()=>{})=>X5(r,e,Dj)};function e9(r,e){function t(n,s){const i=r.store("readwrite"),o=i.transaction;let a=0,c;o.onabort=()=>s(c||o.error||new Error("aborted by user")),o.oncomplete=()=>s();function h(){const l=n[a++],u=l.key;let f;try{f=l.type==="del"?i.delete(u):i.put(l.value,u)}catch(g){c=g,o.abort();return}a<n.length&&(f.onsuccess=h)}h()}return new Promise((n,s)=>{const i=r.iterator(),o=c=>c;i._deserializeKey=i._deserializeValue=o,a();function a(){const c=(h,l,u)=>{if(h||l===void 0){const f=g=>{if(g){s(g);return}n()};i.end(f);return}t(e(l,u),a)};i.next(c)}})}const Ns=new X("/local/filesroot");async function Oj(r,e=()=>{}){if(e(100,"Migrating MFS root to repo datastore"),await r.root.open(),await r.datastore.open(),await r.root.has(Ns)){const t=await r.root.get(Ns);await r.datastore.put(Ns,t),await r.root.delete(Ns)}await r.datastore.close(),await r.root.close(),e(100,"Stored MFS root in repo datastore")}async function Nj(r,e=()=>{}){if(e(100,"Migrating MFS root to repo root datastore"),await r.root.open(),await r.datastore.open(),await r.datastore.has(Ns)){const t=await r.datastore.get(Ns);await r.root.put(Ns,t),await r.datastore.delete(Ns)}await r.datastore.close(),await r.root.close(),e(100,"Stored MFS root in repo root datastore")}const xj={version:11,description:"Store mfs root in the datastore",migrate:Oj,revert:Nj},J5=j.Reader,$j=j.Writer,Lj=j.util,dl=j.roots.default||(j.roots.default={}),t9=dl.Protocols=(()=>{function r(e){if(this.protocols=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.protocols=Lj.emptyArray,r.encode=function(t,n){if(n||(n=$j.create()),t.protocols!=null&&t.protocols.length)for(var s=0;s<t.protocols.length;++s)n.uint32(10).string(t.protocols[s]);return n},r.decode=function(t,n){t instanceof J5||(t=J5.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new dl.Protocols;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.protocols&&i.protocols.length||(i.protocols=[]),i.protocols.push(t.string());break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof dl.Protocols)return t;var n=new dl.Protocols;if(t.protocols){if(!Array.isArray(t.protocols))throw TypeError(".Protocols.protocols: array expected");n.protocols=[];for(var s=0;s<t.protocols.length;++s)n.protocols[s]=String(t.protocols[s])}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.protocols=[]),t.protocols&&t.protocols.length){s.protocols=[];for(var i=0;i<t.protocols.length;++i)s.protocols[i]=t.protocols[i]}return s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})(),zi=j.Reader,Af=j.Writer,Ne=j.util,at=j.roots.default||(j.roots.default={}),r9=at.Addresses=(()=>{function r(e){if(this.addrs=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.addrs=Ne.emptyArray,r.prototype.certifiedRecord=null,r.encode=function(t,n){if(n||(n=Af.create()),t.addrs!=null&&t.addrs.length)for(var s=0;s<t.addrs.length;++s)at.Addresses.Address.encode(t.addrs[s],n.uint32(10).fork()).ldelim();return t.certifiedRecord!=null&&Object.hasOwnProperty.call(t,"certifiedRecord")&&at.Addresses.CertifiedRecord.encode(t.certifiedRecord,n.uint32(18).fork()).ldelim(),n},r.decode=function(t,n){t instanceof zi||(t=zi.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new at.Addresses;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.addrs&&i.addrs.length||(i.addrs=[]),i.addrs.push(at.Addresses.Address.decode(t,t.uint32()));break;case 2:i.certifiedRecord=at.Addresses.CertifiedRecord.decode(t,t.uint32());break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof at.Addresses)return t;var n=new at.Addresses;if(t.addrs){if(!Array.isArray(t.addrs))throw TypeError(".Addresses.addrs: array expected");n.addrs=[];for(var s=0;s<t.addrs.length;++s){if(typeof t.addrs[s]!="object")throw TypeError(".Addresses.addrs: object expected");n.addrs[s]=at.Addresses.Address.fromObject(t.addrs[s])}}if(t.certifiedRecord!=null){if(typeof t.certifiedRecord!="object")throw TypeError(".Addresses.certifiedRecord: object expected");n.certifiedRecord=at.Addresses.CertifiedRecord.fromObject(t.certifiedRecord)}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.addrs=[]),n.defaults&&(s.certifiedRecord=null),t.addrs&&t.addrs.length){s.addrs=[];for(var i=0;i<t.addrs.length;++i)s.addrs[i]=at.Addresses.Address.toObject(t.addrs[i],n)}return t.certifiedRecord!=null&&t.hasOwnProperty("certifiedRecord")&&(s.certifiedRecord=at.Addresses.CertifiedRecord.toObject(t.certifiedRecord,n)),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.Address=function(){function e(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}e.prototype.multiaddr=Ne.newBuffer([]),e.prototype.isCertified=null;let t;return Object.defineProperty(e.prototype,"_isCertified",{get:Ne.oneOfGetter(t=["isCertified"]),set:Ne.oneOfSetter(t)}),e.encode=function(s,i){return i||(i=Af.create()),s.multiaddr!=null&&Object.hasOwnProperty.call(s,"multiaddr")&&i.uint32(10).bytes(s.multiaddr),s.isCertified!=null&&Object.hasOwnProperty.call(s,"isCertified")&&i.uint32(16).bool(s.isCertified),i},e.decode=function(s,i){s instanceof zi||(s=zi.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new at.Addresses.Address;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:a.multiaddr=s.bytes();break;case 2:a.isCertified=s.bool();break;default:s.skipType(c&7);break}}return a},e.fromObject=function(s){if(s instanceof at.Addresses.Address)return s;var i=new at.Addresses.Address;return s.multiaddr!=null&&(typeof s.multiaddr=="string"?Ne.base64.decode(s.multiaddr,i.multiaddr=Ne.newBuffer(Ne.base64.length(s.multiaddr)),0):s.multiaddr.length&&(i.multiaddr=s.multiaddr)),s.isCertified!=null&&(i.isCertified=Boolean(s.isCertified)),i},e.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(i.bytes===String?o.multiaddr="":(o.multiaddr=[],i.bytes!==Array&&(o.multiaddr=Ne.newBuffer(o.multiaddr)))),s.multiaddr!=null&&s.hasOwnProperty("multiaddr")&&(o.multiaddr=i.bytes===String?Ne.base64.encode(s.multiaddr,0,s.multiaddr.length):i.bytes===Array?Array.prototype.slice.call(s.multiaddr):s.multiaddr),s.isCertified!=null&&s.hasOwnProperty("isCertified")&&(o.isCertified=s.isCertified,i.oneofs&&(o._isCertified="isCertified")),o},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e}(),r.CertifiedRecord=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.seq=Ne.Long?Ne.Long.fromBits(0,0,!0):0,e.prototype.raw=Ne.newBuffer([]),e.encode=function(n,s){return s||(s=Af.create()),n.seq!=null&&Object.hasOwnProperty.call(n,"seq")&&s.uint32(8).uint64(n.seq),n.raw!=null&&Object.hasOwnProperty.call(n,"raw")&&s.uint32(18).bytes(n.raw),s},e.decode=function(n,s){n instanceof zi||(n=zi.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new at.Addresses.CertifiedRecord;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.seq=n.uint64();break;case 2:o.raw=n.bytes();break;default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof at.Addresses.CertifiedRecord)return n;var s=new at.Addresses.CertifiedRecord;return n.seq!=null&&(Ne.Long?(s.seq=Ne.Long.fromValue(n.seq)).unsigned=!0:typeof n.seq=="string"?s.seq=parseInt(n.seq,10):typeof n.seq=="number"?s.seq=n.seq:typeof n.seq=="object"&&(s.seq=new Ne.LongBits(n.seq.low>>>0,n.seq.high>>>0).toNumber(!0))),n.raw!=null&&(typeof n.raw=="string"?Ne.base64.decode(n.raw,s.raw=Ne.newBuffer(Ne.base64.length(n.raw)),0):n.raw.length&&(s.raw=n.raw)),s},e.toObject=function(n,s){s||(s={});var i={};if(s.defaults){if(Ne.Long){var o=new Ne.Long(0,0,!0);i.seq=s.longs===String?o.toString():s.longs===Number?o.toNumber():o}else i.seq=s.longs===String?"0":0;s.bytes===String?i.raw="":(i.raw=[],s.bytes!==Array&&(i.raw=Ne.newBuffer(i.raw)))}return n.seq!=null&&n.hasOwnProperty("seq")&&(typeof n.seq=="number"?i.seq=s.longs===String?String(n.seq):n.seq:i.seq=s.longs===String?Ne.Long.prototype.toString.call(n.seq):s.longs===Number?new Ne.LongBits(n.seq.low>>>0,n.seq.high>>>0).toNumber(!0):n.seq),n.raw!=null&&n.hasOwnProperty("raw")&&(i.raw=s.bytes===String?Ne.base64.encode(n.raw,0,n.raw.length):s.bytes===Array?Array.prototype.slice.call(n.raw):n.raw),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e}(),r})(),_o=j.Reader,N2=j.Writer,be=j.util,nt=j.roots.default||(j.roots.default={}),n9=nt.Peer=(()=>{function r(t){if(this.addresses=[],this.protocols=[],this.metadata=[],t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}r.prototype.addresses=be.emptyArray,r.prototype.protocols=be.emptyArray,r.prototype.metadata=be.emptyArray,r.prototype.pubKey=null,r.prototype.peerRecordEnvelope=null;let e;return Object.defineProperty(r.prototype,"_pubKey",{get:be.oneOfGetter(e=["pubKey"]),set:be.oneOfSetter(e)}),Object.defineProperty(r.prototype,"_peerRecordEnvelope",{get:be.oneOfGetter(e=["peerRecordEnvelope"]),set:be.oneOfSetter(e)}),r.encode=function(n,s){if(s||(s=N2.create()),n.addresses!=null&&n.addresses.length)for(var i=0;i<n.addresses.length;++i)nt.Address.encode(n.addresses[i],s.uint32(10).fork()).ldelim();if(n.protocols!=null&&n.protocols.length)for(var i=0;i<n.protocols.length;++i)s.uint32(18).string(n.protocols[i]);if(n.metadata!=null&&n.metadata.length)for(var i=0;i<n.metadata.length;++i)nt.Metadata.encode(n.metadata[i],s.uint32(26).fork()).ldelim();return n.pubKey!=null&&Object.hasOwnProperty.call(n,"pubKey")&&s.uint32(34).bytes(n.pubKey),n.peerRecordEnvelope!=null&&Object.hasOwnProperty.call(n,"peerRecordEnvelope")&&s.uint32(42).bytes(n.peerRecordEnvelope),s},r.decode=function(n,s){n instanceof _o||(n=_o.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new nt.Peer;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.addresses&&o.addresses.length||(o.addresses=[]),o.addresses.push(nt.Address.decode(n,n.uint32()));break;case 2:o.protocols&&o.protocols.length||(o.protocols=[]),o.protocols.push(n.string());break;case 3:o.metadata&&o.metadata.length||(o.metadata=[]),o.metadata.push(nt.Metadata.decode(n,n.uint32()));break;case 4:o.pubKey=n.bytes();break;case 5:o.peerRecordEnvelope=n.bytes();break;default:n.skipType(a&7);break}}return o},r.fromObject=function(n){if(n instanceof nt.Peer)return n;var s=new nt.Peer;if(n.addresses){if(!Array.isArray(n.addresses))throw TypeError(".Peer.addresses: array expected");s.addresses=[];for(var i=0;i<n.addresses.length;++i){if(typeof n.addresses[i]!="object")throw TypeError(".Peer.addresses: object expected");s.addresses[i]=nt.Address.fromObject(n.addresses[i])}}if(n.protocols){if(!Array.isArray(n.protocols))throw TypeError(".Peer.protocols: array expected");s.protocols=[];for(var i=0;i<n.protocols.length;++i)s.protocols[i]=String(n.protocols[i])}if(n.metadata){if(!Array.isArray(n.metadata))throw TypeError(".Peer.metadata: array expected");s.metadata=[];for(var i=0;i<n.metadata.length;++i){if(typeof n.metadata[i]!="object")throw TypeError(".Peer.metadata: object expected");s.metadata[i]=nt.Metadata.fromObject(n.metadata[i])}}return n.pubKey!=null&&(typeof n.pubKey=="string"?be.base64.decode(n.pubKey,s.pubKey=be.newBuffer(be.base64.length(n.pubKey)),0):n.pubKey.length&&(s.pubKey=n.pubKey)),n.peerRecordEnvelope!=null&&(typeof n.peerRecordEnvelope=="string"?be.base64.decode(n.peerRecordEnvelope,s.peerRecordEnvelope=be.newBuffer(be.base64.length(n.peerRecordEnvelope)),0):n.peerRecordEnvelope.length&&(s.peerRecordEnvelope=n.peerRecordEnvelope)),s},r.toObject=function(n,s){s||(s={});var i={};if((s.arrays||s.defaults)&&(i.addresses=[],i.protocols=[],i.metadata=[]),n.addresses&&n.addresses.length){i.addresses=[];for(var o=0;o<n.addresses.length;++o)i.addresses[o]=nt.Address.toObject(n.addresses[o],s)}if(n.protocols&&n.protocols.length){i.protocols=[];for(var o=0;o<n.protocols.length;++o)i.protocols[o]=n.protocols[o]}if(n.metadata&&n.metadata.length){i.metadata=[];for(var o=0;o<n.metadata.length;++o)i.metadata[o]=nt.Metadata.toObject(n.metadata[o],s)}return n.pubKey!=null&&n.hasOwnProperty("pubKey")&&(i.pubKey=s.bytes===String?be.base64.encode(n.pubKey,0,n.pubKey.length):s.bytes===Array?Array.prototype.slice.call(n.pubKey):n.pubKey,s.oneofs&&(i._pubKey="pubKey")),n.peerRecordEnvelope!=null&&n.hasOwnProperty("peerRecordEnvelope")&&(i.peerRecordEnvelope=s.bytes===String?be.base64.encode(n.peerRecordEnvelope,0,n.peerRecordEnvelope.length):s.bytes===Array?Array.prototype.slice.call(n.peerRecordEnvelope):n.peerRecordEnvelope,s.oneofs&&(i._peerRecordEnvelope="peerRecordEnvelope")),i},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();nt.Address=(()=>{function r(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}r.prototype.multiaddr=be.newBuffer([]),r.prototype.isCertified=null;let e;return Object.defineProperty(r.prototype,"_isCertified",{get:be.oneOfGetter(e=["isCertified"]),set:be.oneOfSetter(e)}),r.encode=function(n,s){return s||(s=N2.create()),n.multiaddr!=null&&Object.hasOwnProperty.call(n,"multiaddr")&&s.uint32(10).bytes(n.multiaddr),n.isCertified!=null&&Object.hasOwnProperty.call(n,"isCertified")&&s.uint32(16).bool(n.isCertified),s},r.decode=function(n,s){n instanceof _o||(n=_o.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new nt.Address;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.multiaddr=n.bytes();break;case 2:o.isCertified=n.bool();break;default:n.skipType(a&7);break}}return o},r.fromObject=function(n){if(n instanceof nt.Address)return n;var s=new nt.Address;return n.multiaddr!=null&&(typeof n.multiaddr=="string"?be.base64.decode(n.multiaddr,s.multiaddr=be.newBuffer(be.base64.length(n.multiaddr)),0):n.multiaddr.length&&(s.multiaddr=n.multiaddr)),n.isCertified!=null&&(s.isCertified=Boolean(n.isCertified)),s},r.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.multiaddr="":(i.multiaddr=[],s.bytes!==Array&&(i.multiaddr=be.newBuffer(i.multiaddr)))),n.multiaddr!=null&&n.hasOwnProperty("multiaddr")&&(i.multiaddr=s.bytes===String?be.base64.encode(n.multiaddr,0,n.multiaddr.length):s.bytes===Array?Array.prototype.slice.call(n.multiaddr):n.multiaddr),n.isCertified!=null&&n.hasOwnProperty("isCertified")&&(i.isCertified=n.isCertified,s.oneofs&&(i._isCertified="isCertified")),i},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();nt.Metadata=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.key="",r.prototype.value=be.newBuffer([]),r.encode=function(t,n){return n||(n=N2.create()),t.key!=null&&Object.hasOwnProperty.call(t,"key")&&n.uint32(10).string(t.key),t.value!=null&&Object.hasOwnProperty.call(t,"value")&&n.uint32(18).bytes(t.value),n},r.decode=function(t,n){t instanceof _o||(t=_o.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new nt.Metadata;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.key=t.string();break;case 2:i.value=t.bytes();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof nt.Metadata)return t;var n=new nt.Metadata;return t.key!=null&&(n.key=String(t.key)),t.value!=null&&(typeof t.value=="string"?be.base64.decode(t.value,n.value=be.newBuffer(be.base64.length(t.value)),0):t.value.length&&(n.value=t.value)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(s.key="",n.bytes===String?s.value="":(s.value=[],n.bytes!==Array&&(s.value=be.newBuffer(s.value)))),t.key!=null&&t.hasOwnProperty("key")&&(s.key=t.key),t.value!=null&&t.hasOwnProperty("value")&&(s.value=n.bytes===String?be.base64.encode(t.value,0,t.value.length):n.bytes===Array?Array.prototype.slice.call(t.value):t.value),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();const Z5=j.Reader,Mj=j.Writer,xe=j.util,fl=j.roots.default||(j.roots.default={}),Uj=fl.Envelope=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.publicKey=xe.newBuffer([]),r.prototype.payloadType=xe.newBuffer([]),r.prototype.payload=xe.newBuffer([]),r.prototype.signature=xe.newBuffer([]),r.encode=function(t,n){return n||(n=Mj.create()),t.publicKey!=null&&Object.hasOwnProperty.call(t,"publicKey")&&n.uint32(10).bytes(t.publicKey),t.payloadType!=null&&Object.hasOwnProperty.call(t,"payloadType")&&n.uint32(18).bytes(t.payloadType),t.payload!=null&&Object.hasOwnProperty.call(t,"payload")&&n.uint32(26).bytes(t.payload),t.signature!=null&&Object.hasOwnProperty.call(t,"signature")&&n.uint32(42).bytes(t.signature),n},r.decode=function(t,n){t instanceof Z5||(t=Z5.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new fl.Envelope;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.publicKey=t.bytes();break;case 2:i.payloadType=t.bytes();break;case 3:i.payload=t.bytes();break;case 5:i.signature=t.bytes();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof fl.Envelope)return t;var n=new fl.Envelope;return t.publicKey!=null&&(typeof t.publicKey=="string"?xe.base64.decode(t.publicKey,n.publicKey=xe.newBuffer(xe.base64.length(t.publicKey)),0):t.publicKey.length&&(n.publicKey=t.publicKey)),t.payloadType!=null&&(typeof t.payloadType=="string"?xe.base64.decode(t.payloadType,n.payloadType=xe.newBuffer(xe.base64.length(t.payloadType)),0):t.payloadType.length&&(n.payloadType=t.payloadType)),t.payload!=null&&(typeof t.payload=="string"?xe.base64.decode(t.payload,n.payload=xe.newBuffer(xe.base64.length(t.payload)),0):t.payload.length&&(n.payload=t.payload)),t.signature!=null&&(typeof t.signature=="string"?xe.base64.decode(t.signature,n.signature=xe.newBuffer(xe.base64.length(t.signature)),0):t.signature.length&&(n.signature=t.signature)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(n.bytes===String?s.publicKey="":(s.publicKey=[],n.bytes!==Array&&(s.publicKey=xe.newBuffer(s.publicKey))),n.bytes===String?s.payloadType="":(s.payloadType=[],n.bytes!==Array&&(s.payloadType=xe.newBuffer(s.payloadType))),n.bytes===String?s.payload="":(s.payload=[],n.bytes!==Array&&(s.payload=xe.newBuffer(s.payload))),n.bytes===String?s.signature="":(s.signature=[],n.bytes!==Array&&(s.signature=xe.newBuffer(s.signature)))),t.publicKey!=null&&t.hasOwnProperty("publicKey")&&(s.publicKey=n.bytes===String?xe.base64.encode(t.publicKey,0,t.publicKey.length):n.bytes===Array?Array.prototype.slice.call(t.publicKey):t.publicKey),t.payloadType!=null&&t.hasOwnProperty("payloadType")&&(s.payloadType=n.bytes===String?xe.base64.encode(t.payloadType,0,t.payloadType.length):n.bytes===Array?Array.prototype.slice.call(t.payloadType):t.payloadType),t.payload!=null&&t.hasOwnProperty("payload")&&(s.payload=n.bytes===String?xe.base64.encode(t.payload,0,t.payload.length):n.bytes===Array?Array.prototype.slice.call(t.payload):t.payload),t.signature!=null&&t.hasOwnProperty("signature")&&(s.signature=n.bytes===String?xe.base64.encode(t.signature,0,t.signature.length):n.bytes===Array?Array.prototype.slice.call(t.signature):t.signature),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})(),pl=j.Reader,e4=j.Writer,Ve=j.util,kr=j.roots.default||(j.roots.default={}),Bj=kr.PeerRecord=(()=>{function r(e){if(this.addresses=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.peerId=Ve.newBuffer([]),r.prototype.seq=Ve.Long?Ve.Long.fromBits(0,0,!0):0,r.prototype.addresses=Ve.emptyArray,r.encode=function(t,n){if(n||(n=e4.create()),t.peerId!=null&&Object.hasOwnProperty.call(t,"peerId")&&n.uint32(10).bytes(t.peerId),t.seq!=null&&Object.hasOwnProperty.call(t,"seq")&&n.uint32(16).uint64(t.seq),t.addresses!=null&&t.addresses.length)for(var s=0;s<t.addresses.length;++s)kr.PeerRecord.AddressInfo.encode(t.addresses[s],n.uint32(26).fork()).ldelim();return n},r.decode=function(t,n){t instanceof pl||(t=pl.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new kr.PeerRecord;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.peerId=t.bytes();break;case 2:i.seq=t.uint64();break;case 3:i.addresses&&i.addresses.length||(i.addresses=[]),i.addresses.push(kr.PeerRecord.AddressInfo.decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof kr.PeerRecord)return t;var n=new kr.PeerRecord;if(t.peerId!=null&&(typeof t.peerId=="string"?Ve.base64.decode(t.peerId,n.peerId=Ve.newBuffer(Ve.base64.length(t.peerId)),0):t.peerId.length&&(n.peerId=t.peerId)),t.seq!=null&&(Ve.Long?(n.seq=Ve.Long.fromValue(t.seq)).unsigned=!0:typeof t.seq=="string"?n.seq=parseInt(t.seq,10):typeof t.seq=="number"?n.seq=t.seq:typeof t.seq=="object"&&(n.seq=new Ve.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0))),t.addresses){if(!Array.isArray(t.addresses))throw TypeError(".PeerRecord.addresses: array expected");n.addresses=[];for(var s=0;s<t.addresses.length;++s){if(typeof t.addresses[s]!="object")throw TypeError(".PeerRecord.addresses: object expected");n.addresses[s]=kr.PeerRecord.AddressInfo.fromObject(t.addresses[s])}}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.addresses=[]),n.defaults)if(n.bytes===String?s.peerId="":(s.peerId=[],n.bytes!==Array&&(s.peerId=Ve.newBuffer(s.peerId))),Ve.Long){var i=new Ve.Long(0,0,!0);s.seq=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.seq=n.longs===String?"0":0;if(t.peerId!=null&&t.hasOwnProperty("peerId")&&(s.peerId=n.bytes===String?Ve.base64.encode(t.peerId,0,t.peerId.length):n.bytes===Array?Array.prototype.slice.call(t.peerId):t.peerId),t.seq!=null&&t.hasOwnProperty("seq")&&(typeof t.seq=="number"?s.seq=n.longs===String?String(t.seq):t.seq:s.seq=n.longs===String?Ve.Long.prototype.toString.call(t.seq):n.longs===Number?new Ve.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0):t.seq),t.addresses&&t.addresses.length){s.addresses=[];for(var o=0;o<t.addresses.length;++o)s.addresses[o]=kr.PeerRecord.AddressInfo.toObject(t.addresses[o],n)}return s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.AddressInfo=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.multiaddr=Ve.newBuffer([]),e.encode=function(n,s){return s||(s=e4.create()),n.multiaddr!=null&&Object.hasOwnProperty.call(n,"multiaddr")&&s.uint32(10).bytes(n.multiaddr),s},e.decode=function(n,s){n instanceof pl||(n=pl.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new kr.PeerRecord.AddressInfo;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.multiaddr=n.bytes();break;default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof kr.PeerRecord.AddressInfo)return n;var s=new kr.PeerRecord.AddressInfo;return n.multiaddr!=null&&(typeof n.multiaddr=="string"?Ve.base64.decode(n.multiaddr,s.multiaddr=Ve.newBuffer(Ve.base64.length(n.multiaddr)),0):n.multiaddr.length&&(s.multiaddr=n.multiaddr)),s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.multiaddr="":(i.multiaddr=[],s.bytes!==Array&&(i.multiaddr=Ve.newBuffer(i.multiaddr)))),n.multiaddr!=null&&n.hasOwnProperty("multiaddr")&&(i.multiaddr=s.bytes===String?Ve.base64.encode(n.multiaddr,0,n.multiaddr.length):s.bytes===Array?Array.prototype.slice.call(n.multiaddr):n.multiaddr),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e}(),r})();j.util.Long=void 0;j.configure();async function zj(r,e=()=>{}){e(0,"Storing each peerstore key under a single datastore key"),await r.datastore.open();const t={},n=[];for await(const{key:s,value:i}of r.datastore.query({prefix:"/peers"})){n.push(s);const o=s.toString(),[,a,c,h,l]=o.split("/");if(a==="peers"&&["protos","addrs","metadata","keys"].includes(c)&&h)if(t[h]=t[h]||{addresses:[],protocols:[],metadata:[]},c==="protos"){const u=t9.decode(i);t[h].protocols=u.protocols.sort()}else if(c==="addrs"){const u=r9.decode(i);t[h].addresses=u.addrs.sort((f,g)=>G(f.multiaddr).toString().localeCompare(G(g.multiaddr).toString())),u.certifiedRecord&&u.certifiedRecord.raw&&(t[h].peerRecordEnvelope=u.certifiedRecord.raw)}else c==="metadata"?t[h].metadata.push({key:l,value:i}):c==="keys"&&(t[h].pubKey=i)}e(33,"Read peer data from store");for(const s of n)await r.datastore.delete(s);e(66,"Removed existing peer data from store");for(const s of Object.keys(t)){const i=t[s];i.metadata=i.metadata.sort((a,c)=>a.key.localeCompare(c.key));const o=n9.encode(i).finish();await r.datastore.put(new X(`/peers/${s}`),o)}await r.datastore.close(),e(100,"Stored each peerstore key under a single datastore key")}async function Fj(r,e=()=>{}){e(0,"Storing each peerstore key under a multiple datastore keys"),await r.datastore.open();const t={},n=[];for await(const{key:s,value:i}of r.datastore.query({prefix:"/peers"})){n.push(s);const o=s.toString(),[,,a]=o.split("/");t[a]=n9.decode(i)}e(33,"Read peer data from store");for(const s of n)await r.datastore.delete(s);e(66,"Removed existing peer data from store");for(const[s,i]of Object.entries(t)){if(i.protocols&&i.protocols.length>0&&await r.datastore.put(new X(`/peers/protos/${s}`),t9.encode({protocols:i.protocols}).finish()),i.addresses&&i.addresses.length>0){const o=i.peerRecordEnvelope;let a;if(o){const c=Uj.decode(o),h=Bj.decode(c.payload);a={raw:o,seq:h.seq}}await r.datastore.put(new X(`/peers/addrs/${s}`),r9.encode({addrs:i.addresses,certifiedRecord:a}).finish())}if(i.metadata&&i.metadata.length>0)for(const{key:o,value:a}of i.metadata)await r.datastore.put(new X(`/peers/metadata/${s}/${o}`),a);i.pubKey&&await r.datastore.put(new X(`/peers/keys/${s}`),i.pubKey)}await r.datastore.close(),e(100,"Stored each peerstore key under multiple datastore keys")}const Vj={version:12,description:"Store each peerstore peer under a single datastore key",migrate:zj,revert:Fj},Zs={description:"Empty migration.",migrate:()=>{},revert:()=>{},empty:!0},x2=[Object.assign({version:1},Zs),Object.assign({version:2},Zs),Object.assign({version:3},Zs),Object.assign({version:4},Zs),Object.assign({version:5},Zs),Object.assign({version:6},Zs),Object.assign({version:7},Zs),fj,Aj,Pj,xj,Vj];class bd extends Error{constructor(e){super(e),this.name="NonReversibleMigrationError",this.code=bd.code,this.message=e}}bd.code="ERR_NON_REVERSIBLE_MIGRATION";class xc extends Error{constructor(e){super(e),this.name="NotInitializedRepoError",this.code=xc.code,this.message=e}}xc.code="ERR_NOT_INITIALIZED_REPO";class Ed extends Error{constructor(e){super(e),this.name="RequiredParameterError",this.code=Ed.code,this.message=e}}Ed.code="ERR_REQUIRED_PARAMETER";class _d extends Error{constructor(e){super(e),this.name="InvalidValueError",this.code=_d.code,this.message=e}}_d.code="ERR_INVALID_VALUE";class Lo extends Error{constructor(e){super(e),this.name="MissingRepoOptionsError",this.code=Lo.code,this.message=e}}Lo.code="ERR_MISSING_REPO_OPTIONS";const Kj=Object.freeze(Object.defineProperty({__proto__:null,InvalidValueError:_d,MissingRepoOptionsError:Lo,NonReversibleMigrationError:bd,NotInitializedRepoError:xc,RequiredParameterError:Ed},Symbol.toStringTag,{value:"Module"})),If=Br("ipfs:repo:migrator:repo:init");async function jj(r){if(!r)throw new Lo("Please pass repo options when trying to open a repo");const e=r.root;try{await e.open();const t=await e.has(O2),n=await e.has(Ij);return!t||!n?(If(`Version entry present: ${t}`),If(`Config entry present: ${n}`),!1):!0}catch(t){return If("While checking if repo is initialized error was thrown: "+t.message),!1}finally{if(e!==void 0)try{await e.close()}catch{}}}async function s9(r){if(!await jj(r))throw new xc("Repo is not initialized!");const e=r.root;await e.open();try{return parseInt(B(await e.get(O2)))}finally{await e.close()}}async function eu(r,e){if(!e)throw new Lo("Please pass repo options when trying to open a repo");const t=e.root;await t.open(),await t.put(O2,L(String(r))),await t.close()}const $r=Br("ipfs:repo:migrator");function Hj(r){return r=r||x2,!Array.isArray(r)||r.length===0?0:r[r.length-1].version}async function qj(r,e,t,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??x2;if(!r)throw new mr.RequiredParameterError("Path argument is required!");if(!t)throw new mr.RequiredParameterError("repoOptions argument is required!");if(!n)throw new mr.RequiredParameterError("toVersion argument is required!");if(!Number.isInteger(n)||n<=0)throw new mr.InvalidValueError("Version has to be positive integer!");e=J7(e);const h=await s9(e);if(h===n){$r("Nothing to migrate.");return}if(h>n)throw new mr.InvalidValueError(`Current repo's version (${h}) is higher then toVersion (${n}), you probably wanted to revert it?`);i9(c,h,n);let l;!a&&!i&&(l=await t.repoLock.lock(r));try{for(const u of c){if(n!==void 0&&u.version>n)break;if(!(u.version<=h)){$r(`Migrating version ${u.version}`);try{if(!a){let f=()=>{};o&&(f=(g,d)=>o(u.version,g.toFixed(2),d)),await u.migrate(e,f)}}catch(f){const g=u.version-1;throw $r(`An exception was raised during execution of migration. Setting the repo's version to last successfully migrated version: ${g}`),await eu(g,e),new Error(`During migration to version ${u.version} exception was raised: ${f.stack||f.message||f}`)}$r(`Migrating to version ${u.version} finished`)}}a||await eu(n||Hj(c),e),$r("Repo successfully migrated",n!==void 0?`to version ${n}!`:"to latest version!")}finally{!a&&!i&&l&&await l.close()}}async function Gj(r,e,t,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??x2;if(!r)throw new mr.RequiredParameterError("Path argument is required!");if(!t)throw new mr.RequiredParameterError("repoOptions argument is required!");if(!n)throw new mr.RequiredParameterError("When reverting migrations, you have to specify to which version to revert!");if(!Number.isInteger(n)||n<=0)throw new mr.InvalidValueError("Version has to be positive integer!");e=J7(e);const h=await s9(e);if(h===n){$r("Nothing to revert.");return}if(h<n)throw new mr.InvalidValueError(`Current repo's version (${h}) is lower then toVersion (${n}), you probably wanted to migrate it?`);i9(c,n,h,!0);let l;!a&&!i&&(l=await t.repoLock.lock(r)),$r(`Reverting from version ${h} to ${n}`);try{const u=c.slice().reverse();for(const f of u){if(f.version<=n)break;if(!(f.version>h)){$r(`Reverting migration version ${f.version}`);try{if(!a){let g=()=>{};o&&(g=(d,p)=>o(f.version,d.toFixed(2),p)),await f.revert(e,g)}}catch(g){const d=f.version;throw $r(`An exception was raised during execution of migration. Setting the repo's version to last successfully reverted version: ${d}`),await eu(d,e),g.message=`During reversion to version ${f.version} exception was raised: ${g.message}`,g}$r(`Reverting to version ${f.version} finished`)}}a||await eu(n,e),$r(`All migrations successfully reverted to version ${n}!`)}finally{!a&&!i&&l&&await l.close()}}function i9(r,e,t,n=!1){let s=0;for(const i of r){if(i.version>t)break;if(i.version>e){if(n&&!i.revert)throw new mr.NonReversibleMigrationError(`It is not possible to revert to version ${e} because migration version ${i.version} is not reversible. Cancelling reversion.`);s++}}if(s!==t-e)throw new mr.InvalidValueError(`The ipfs-repo-migrations package does not have all migration to migrate from version ${e} to ${t}`)}const mr=Kj;var hc={},Wj={get exports(){return hc},set exports(r){hc=r}};/*!
 * bytes
 * Copyright(c) 2012-2014 TJ Holowaychuk
 * Copyright(c) 2015 Jed Watson
 * MIT Licensed
 */Wj.exports=Jj;hc.format=o9;hc.parse=a9;var Yj=/\B(?=(\d{3})+(?!\d))/g,Qj=/(?:\.0*|(\.[^0]+)0+)$/,ds={b:1,kb:1<<10,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)},Xj=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i;function Jj(r,e){return typeof r=="string"?a9(r):typeof r=="number"?o9(r,e):null}function o9(r,e){if(!Number.isFinite(r))return null;var t=Math.abs(r),n=e&&e.thousandsSeparator||"",s=e&&e.unitSeparator||"",i=e&&e.decimalPlaces!==void 0?e.decimalPlaces:2,o=Boolean(e&&e.fixedDecimals),a=e&&e.unit||"";(!a||!ds[a.toLowerCase()])&&(t>=ds.pb?a="PB":t>=ds.tb?a="TB":t>=ds.gb?a="GB":t>=ds.mb?a="MB":t>=ds.kb?a="KB":a="B");var c=r/ds[a.toLowerCase()],h=c.toFixed(i);return o||(h=h.replace(Qj,"$1")),n&&(h=h.split(".").map(function(l,u){return u===0?l.replace(Yj,n):l}).join(".")),h+s+a}function a9(r){if(typeof r=="number"&&!isNaN(r))return r;if(typeof r!="string")return null;var e=Xj.exec(r),t,n="b";return e?(t=parseFloat(e[1]),n=e[4].toLowerCase()):(t=parseInt(r,10),n="b"),isNaN(t)?null:Math.floor(ds[n]*t)}class vd extends Error{constructor(e){super(e),this.name="LockExistsError",this.code=vd.code}}vd.code="ERR_LOCK_EXISTS";class Ws extends Error{constructor(e){super(e),this.name="NotFoundError",this.code=Ws.code}}Ws.code="ERR_NOT_FOUND";class Sd extends Error{constructor(e){super(e),this.name="InvalidRepoVersionError",this.code=Sd.code}}Sd.code="ERR_INVALID_REPO_VERSION";const Ca="ERR_REPO_NOT_INITIALIZED",Zj="ERR_REPO_ALREADY_OPEN",eH="ERR_REPO_ALREADY_CLOSED";async function c9(r,e,t){const n=await e(r);if(n)return n;const s=h9(t);return s?new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{i(Boolean(a.result))}}):!1}async function l9(r,e,t,n){if(await t(r))return e(r);const s=h9(n);if(!s)throw new Ws;return new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{if(a.result)return i(a.result);o(new Ws)}})}function h9(r){let e=r;for(;e.db||e.child;)if(e=e.db||e.child,e.type==="level-js"||e.constructor.name==="Level")return e}const tH=Br("ipfs:repo:version"),Cf=new X("version");function rH(r){return{async exists(){return c9(Cf,r.has.bind(r),r)},async get(){const e=await l9(Cf,r.get.bind(r),r.has.bind(r),r);return parseInt(B(e),10)},set(e){return r.put(Cf,L(String(e)))},async check(e){const t=await this.get();return tH("comparing version: %s and %s",t,e),t===e||(t===6&&e===7||e===6&&t===7)}}}const nH=lt.default?lt.default:lt,Tf=new X("config");function sH(r){const e=new nH({concurrency:1}),t={async getAll(i={}){const o=await l9(Tf,r.get.bind(r),r.has.bind(r),r);return JSON.parse(B(o))},async get(i,o={}){if(i==null)throw new Ws(`Key ${i} does not exist in config`);const a=await this.getAll(o),c=C2(a,i);if(c===void 0)throw new Ws(`Key ${i} does not exist in config`);return c},set(i,o,a={}){if(typeof i!="string"&&!(i instanceof String))throw v(new Error("Invalid key type: "+typeof i),"ERR_INVALID_KEY");if(o===void 0||o instanceof Uint8Array)throw v(new Error("Invalid value type: "+typeof o),"ERR_INVALID_VALUE");return e.add(()=>n({key:i,value:o},a.signal))},replace(i,o={}){if(!i||i instanceof Uint8Array)throw v(new Error("Invalid value type: "+typeof i),"ERR_INVALID_VALUE");return e.add(()=>n({key:void 0,value:i},o.signal))},async exists(){return c9(Tf,r.has.bind(r),r)}};return t;async function n(i,o){if(o&&o.aborted)return;const a=i.key,c=i.value;if(a){const h=await t.getAll();return typeof h=="object"&&h!==null&&Ke(h,a,c),s(h)}return s(c)}function s(i){const o=L(JSON.stringify(i,null,2));return r.put(Tf,o)}}function kf(r){if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}function iH(r,e={}){if(!kf(r)&&!Array.isArray(r))throw new TypeError("Expected a plain object or array");const{deep:t,compare:n}=e,s=[],i=[],o=c=>{const h=s.indexOf(c);if(h!==-1)return i[h];const l=[];return s.push(c),i.push(l),l.push(...c.map(u=>Array.isArray(u)?o(u):kf(u)?a(u):u)),l},a=c=>{const h=s.indexOf(c);if(h!==-1)return i[h];const l={},u=Object.keys(c).sort(n);s.push(c),i.push(l);for(const f of u){const g=c[f];let d;t&&Array.isArray(g)?d=o(g):d=t&&kf(g)?a(g):g,Object.defineProperty(l,f,{...Object.getOwnPropertyDescriptor(c,f),value:d})}return l};return Array.isArray(r)?t?o(r):r.slice():a(r)}const Df=new X("datastore_spec");function oH(r){return{exists(){return r.has(Df)},async get(){const e=await r.get(Df);return JSON.parse(B(e))},async set(e){return r.put(Df,L(JSON.stringify(iH(e,{deep:!0}))))}}}const Pf=new X("api");function aH(r){return{async get(){const e=await r.get(Pf);return e&&e.toString()},set(e){return r.put(Pf,L(e.toString()))},delete(){return r.delete(Pf)}}}var cH=u9,t4=128,lH=127,hH=~lH,uH=Math.pow(2,31);function u9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=uH;)e[t++]=r&255|t4,r/=128;for(;r&hH;)e[t++]=r&255|t4,r>>>=7;return e[t]=r|0,u9.bytes=t-n+1,e}var dH=I0,fH=128,r4=127;function I0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw I0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&r4)<<s:(o&r4)*Math.pow(2,s),s+=7}while(o>=fH);return I0.bytes=i-n,t}var pH=Math.pow(2,7),gH=Math.pow(2,14),yH=Math.pow(2,21),wH=Math.pow(2,28),mH=Math.pow(2,35),bH=Math.pow(2,42),EH=Math.pow(2,49),_H=Math.pow(2,56),vH=Math.pow(2,63),SH=function(r){return r<pH?1:r<gH?2:r<yH?3:r<wH?4:r<mH?5:r<bH?6:r<EH?7:r<_H?8:r<vH?9:10},RH={encode:cH,decode:dH,encodingLength:SH},tu=RH;const C0=(r,e=0)=>[tu.decode(r,e),tu.decode.bytes],ru=(r,e,t=0)=>(tu.encode(r,e,t),e),nu=r=>tu.encodingLength(r),AH=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Rd=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},d9=(r,e)=>{const t=e.byteLength,n=nu(r),s=n+nu(t),i=new Uint8Array(s+t);return ru(r,i,0),ru(t,i,n),i.set(e,s),new $2(r,t,e,i)},f9=r=>{const e=Rd(r),[t,n]=C0(e),[s,i]=C0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new $2(t,s,o,e)},IH=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&AH(r.bytes,t.bytes)}};let $2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function CH(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var TH=CH,kH=TH;let DH=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},PH=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return p9(this,e)}},OH=class{constructor(e){this.decoders=e}or(e){return p9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const p9=(r,e)=>new OH({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let NH=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new DH(e,t,n),this.decoder=new PH(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const g9=({name:r,prefix:e,encode:t,decode:n})=>new NH(r,e,t,n),y9=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=kH(t,e);return g9({prefix:r,name:e,encode:n,decode:i=>Rd(s(i))})},xH=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},$H=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Qn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>g9({prefix:e,name:r,encode(s){return $H(s,n,t)},decode(s){return xH(s,n,t,r)}}),_s=y9({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});y9({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Bs=Qn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Qn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Qn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Qn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Qn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Qn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Qn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Qn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Qn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const n4=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return MH(t,T0(r),e||_s.encoder);default:return UH(t,T0(r),e||Bs.encoder)}},s4=new WeakMap,T0=r=>{const e=s4.get(r);if(e==null){const t=new Map;return s4.set(r,t),t}return e};let zr=class kt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==oa)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==BH)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return kt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=d9(e,t);return kt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return kt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&IH(e.multihash,n.multihash)}toString(e){return n4(this,e)}toJSON(){return{"/":n4(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof kt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new kt(n,s,i,o||i4(n,s,i.bytes))}else if(t[zH]===!0){const{version:n,multihash:s,code:i}=t,o=f9(s);return kt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==oa)throw new Error(`Version 0 CID must use dag-pb (code: ${oa}) block encoding`);return new kt(e,t,n,n.bytes)}case 1:{const s=i4(e,t,n.bytes);return new kt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return kt.create(0,oa,e)}static createV1(e,t){return kt.create(1,e,t)}static decode(e){const[t,n]=kt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=kt.inspectBytes(e),n=t.size-t.multihashSize,s=Rd(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new $2(t.multihashCode,t.digestSize,i,s);return[t.version===0?kt.createV0(o):kt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=C0(e.subarray(t));return t+=f,u};let s=n(),i=oa;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=LH(e,t),i=kt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return T0(i).set(n,e),i}};const LH=(r,e)=>{switch(r[0]){case"Q":{const t=e||_s;return[_s.prefix,t.decode(`${_s.prefix}${r}`)]}case _s.prefix:{const t=e||_s;return[_s.prefix,t.decode(r)]}case Bs.prefix:{const t=e||Bs;return[Bs.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},MH=(r,e,t)=>{const{prefix:n}=t;if(n!==_s.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},UH=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},oa=112,BH=18,i4=(r,e,t)=>{const n=nu(r),s=n+nu(e),i=new Uint8Array(s+t.byteLength);return ru(r,i,0),ru(e,i,n),i.set(t,s),i},zH=Symbol.for("@ipld/js-cid/CID"),w9=0,FH="identity",m9=Rd,VH=r=>d9(w9,m9(r)),KH={code:w9,name:FH,encode:m9,digest:VH};function jH(r){return{open(){return r.open()},close(){return r.close()},query(e,t){return r.query(e,t)},queryKeys(e,t){return r.queryKeys(e,t)},async get(e,t){const n=as(e);return n.isIdentity?Promise.resolve(n.digest):r.get(e,t)},async*getMany(e,t){for await(const n of e)yield this.get(n,t)},async put(e,t,n){const{isIdentity:s}=as(e);s||await r.put(e,t,n)},async*putMany(e,t){const n=Bt({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)(async()=>{try{await ot(r.putMany(async function*(){for await(const{key:i,value:o}of e)as(i).isIdentity||(yield{key:i,value:o}),n.push({key:i,value:o})}())),n.end()}catch(i){n.end(i)}}),yield*n},has(e,t){const{isIdentity:n}=as(e);return n?Promise.resolve(!0):r.has(e,t)},delete(e,t){const{isIdentity:n}=as(e);return n?Promise.resolve():r.delete(e,t)},deleteMany(e,t){return r.deleteMany($e(e,n=>!as(n).isIdentity),t)},batch(){const e=r.batch();return{put(t,n){const{isIdentity:s}=as(t);s||e.put(t,n)},delete(t){const{isIdentity:n}=as(t);n||e.delete(t)},commit:t=>e.commit(t)}}}}function as(r){const e=zr.asCID(r);if(e==null)throw v(new Error("Not a valid cid"),"ERR_INVALID_CID");return e.multihash.code!==KH.code?{isIdentity:!1}:{isIdentity:!0,digest:e.multihash.digest}}const b9=Br("ipfs:repo:lock:memory"),E9="repo.lock",Ta={};async function HH(r){const e=r+"/"+E9;if(b9("locking %s",e),Ta[e]===!0)throw new vd(`Lock already being held for file: ${e}`);return Ta[e]=!0,{async close(){Ta[e]&&delete Ta[e]}}}async function qH(r){const e=r+"/"+E9;return b9(`checking lock: ${e}`),Boolean(Ta[e])}const _9={lock:HH,locked:qH},GH={autoMigrate:!0,onMigrationProgress:()=>{},repoOwner:!0,repoLock:_9},v9={Spec:{type:"mount",mounts:[{mountpoint:"/blocks",type:"measure",prefix:"flatfs.datastore",child:{type:"flatfs",path:"blocks",sync:!0,shardFunc:"/repo/flatfs/shard/v1/next-to-last/2"}},{mountpoint:"/",type:"measure",prefix:"leveldb.datastore",child:{type:"levelds",path:"datastore",compression:"none"}}]}};function gl({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*WH(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=zr.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*k0(n,s))}else{const t=zr.asCID(e);t?yield[r.join("/"),t]:yield*k0(e,r)}}function*k0(r,e){if(r==null||r instanceof Uint8Array)return;const t=zr.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*WH(i,s)}}function*YH(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!zr.asCID(n)&&(yield*D0(n,s))}else yield*D0(e,r)}function*D0(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!zr.asCID(n)&&(yield*YH(s,n))}}function QH(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=zr.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}class XH{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:gl(),bytes:gl(),value:gl(),asBlock:gl()})}links(){return k0(this.value,[])}tree(){return D0(this.value,[])}get(e="/"){return QH(this.value,e.split("/").filter(Boolean))}}function S9({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n&&n.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new XH({cid:e,bytes:r,value:s})}function yl(r){const e=zr.asCID(r);if(e==null)throw v(new Error("Not a valid cid"),"ERR_INVALID_CID");const t=Bs.encode(e.multihash.bytes);return new X("/"+t.slice(1).toUpperCase(),!1)}function o4(r){return f9(Bs.decode(`b${r.toString().toLowerCase().substring(1)}`))}const JH=Br("ipfs:repo:utils:walk-dag");async function*su(r,e,t,n){try{const s=await e.get(r,n),i=await t(r.code),o=S9({bytes:s,cid:r,codec:i});for(const[,a]of o.links())yield a,yield*su(a,e,t,n)}catch(s){throw JH("Could not walk DAG for CID",r.toString(),s),s}}class ZH extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,n]of e)this.onEviction(t,n.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const n=t.get(e);return this._getItemValue(e,n)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield e)}for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:n=this.maxAge}={}){const s=typeof n=="number"&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;this.cache.has(e)?this.cache.set(e,{value:t,expiry:s}):this._set(e,{value:t,expiry:s})}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],n=t.length-e;n<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(n>0&&this._emitEvictions(t.slice(0,n)),this.oldCache=new Map(t.slice(n)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,i]=n;this._deleteIfExpired(s,i)===!1&&(yield[s,i.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,i]=n;this.cache.has(s)||this._deleteIfExpired(s,i)===!1&&(yield[s,i.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[n,s]of this.entriesAscending())e.call(t,s,n,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}const eq=2048;function tq(r){const e=`Invalid type '${r}', must be one of {direct, indirect, recursive, all}`;return v(new Error(e),"ERR_INVALID_PIN_TYPE")}class rq{constructor({pinstore:e,blockstore:t,loadCodec:n}){this.pinstore=e,this.blockstore=t,this.loadCodec=n,this.log=Br("ipfs:repo:pin"),this.directPins=new Set,this.recursivePins=new Set}async pinDirectly(e,t={}){await this.blockstore.get(e,t);const n={depth:0};return e.version!==0&&(n.version=e.version),e.code!==Be&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),this.pinstore.put(yl(e),Ha(n))}unpin(e,t){return this.pinstore.delete(yl(e),t)}async pinRecursively(e,t={}){await this.fetchCompleteDag(e,t);const n={depth:1/0};e.version!==0&&(n.version=e.version),e.code!==Be&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),await this.pinstore.put(yl(e),Ha(n))}async*directKeys(e){for await(const t of this.pinstore.query({filters:[n=>Tn(n.value).depth===0]})){const n=Tn(t.value),s=n.version||0,i=n.codec!=null?n.codec:Be,o=o4(t.key);yield{cid:zr.create(s,i,o),metadata:n.metadata}}}async*recursiveKeys(e){for await(const t of this.pinstore.query({filters:[n=>Tn(n.value).depth===1/0]})){const n=Tn(t.value),s=n.version||0,i=n.codec!=null?n.codec:Be,o=o4(t.key);yield{cid:zr.create(s,i,o),metadata:n.metadata}}}async*indirectKeys(e){for await(const{cid:t}of this.recursiveKeys())for await(const n of su(t,this.blockstore,this.loadCodec,e)){const s=[ye.recursive];(await this.isPinnedWithType(n,s)).pinned||(yield n)}}async isPinnedWithType(e,t,n){Array.isArray(t)||(t=[t]);const s=t.includes(ye.all),i=t.includes(ye.direct),o=t.includes(ye.recursive),a=t.includes(ye.indirect);if(o||i||s){const l=await Rr(this.pinstore.query({prefix:yl(e).toString(),filters:[u=>{if(s)return!0;const f=Tn(u.value);return t.includes(f.depth===0?ye.direct:ye.recursive)}],limit:1}));if(l){const u=Tn(l.value);return{cid:e,pinned:!0,reason:u.depth===0?ye.direct:ye.recursive,metadata:u.metadata}}}const c=this;async function*h(l,u){for await(const{cid:f}of u)for await(const g of su(f,c.blockstore,c.loadCodec))if(g.equals(l)){yield f;return}}if(s||a){const l=await Rr(h(e,this.recursiveKeys()));if(l)return{cid:e,pinned:!0,reason:ye.indirect,parent:l}}return{cid:e,pinned:!1}}async fetchCompleteDag(e,t={}){const n=new ZH({maxSize:t.cidCacheMaxSize??eq}),s=async(i,o)=>{if(n.has(i.toString()))return;n.set(i.toString(),!0);const a=await this.blockstore.get(i,o),c=await this.loadCodec(i.code),h=S9({bytes:a,cid:i,codec:c});await Promise.all([...h.links()].map(([,l])=>s(l,o)))};await s(e,t)}static checkPinType(e){if(typeof e!="string"||!Object.keys(ye).includes(e))throw tq(e);return!0}}function nq(r,e){return{open(){return e.open()},close(){return e.close()},query(t,n){return e.query(t,n)},queryKeys(t,n){return e.queryKeys(t,n)},async get(t,n){return e.get(t,n)},async*getMany(t,n){yield*e.getMany(t,n)},async put(t,n,s){await e.put(t,n,s)},async*putMany(t,n){yield*e.putMany(t,n)},has(t,n){return e.has(t,n)},async delete(t,n){return await a4(t,r),e.delete(t,n)},deleteMany(t,n){return e.deleteMany(zt(t,async s=>(await a4(s,r),s)),n)},batch(){return e.batch()}}}async function a4(r,e){const{pinned:t,reason:n}=await e.isPinnedWithType(r,ye.all);if(t)throw v(new Error(`pinned: ${n}`),"ERR_BLOCK_PINNED")}const uc=Br("ipfs:repo:gc"),sq=hn().code,iq=256,oq=new X("/local/filesroot");function aq({gcLock:r,pins:e,blockstore:t,root:n,loadCodec:s}){async function*i(){const o=Date.now();uc("Creating set of marked blocks");const a=await r.writeLock();try{const c=await cq({pins:e,blockstore:t,root:n,loadCodec:s}),h=t.queryKeys({});yield*lq({blockstore:t},c,h),uc(`Complete (${Date.now()-o}ms)`)}finally{a()}}return i}async function cq({pins:r,blockstore:e,loadCodec:t,root:n}){const s=async function*(){let a;try{a=await n.get(oq)}catch(h){if(h.code===sq){uc("No blocks in MFS");return}throw h}const c=zr.decode(a);yield c,yield*su(c,e,t)}(),i=Yt(zt(r.recursiveKeys(),({cid:a})=>a),r.indirectKeys(),zt(r.directKeys(),({cid:a})=>a),s),o=new Set;for await(const a of Yt(i,s))o.add(Bs.encode(a.multihash.bytes));return o}async function*lq({blockstore:r},e,t){let n=0,s=0;yield*ie(Zp(zt(t,async o=>async function(){n++;try{const c=Bs.encode(o.multihash.bytes);if(e.has(c))return null;try{await r.delete(o),s++}catch(h){return{err:new Error(`Could not delete block with CID ${o}: ${h.message}`)}}return{cid:o}}catch(c){const h=`Could delete block with CID ${o}`;return uc(h,c),{err:new Error(h+`: ${c.message}`)}}}),iq),o=>$e(o,Boolean)),uc(`Marked set has ${e.size} unique blocks. Blockstore has ${n} blocks. Deleted ${s} blocks.`)}const qt=Br("ipfs:repo"),hq=Number.MAX_SAFE_INTEGER,uq="repoAutoMigrate";class dq{constructor(e,t,n,s){if(typeof e!="string")throw new Error("missing repo path");if(typeof t!="function")throw new Error("missing codec loader");this.options=Ue(GH,s),this.closed=!0,this.path=e,this.root=n.root,this.datastore=n.datastore,this.keys=n.keys;const i=n.blocks,o=n.pins;this.pins=new rq({pinstore:o,blockstore:i,loadCodec:t});const a=nq(this.pins,i);this.blocks=jH(a),this.version=rH(this.root),this.config=sH(this.root),this.spec=oH(this.root),this.apiAddr=aH(this.root),this.gcLock=_2({name:e,singleProcess:this.options.repoOwner!==!1}),this.gc=aq({gcLock:this.gcLock,pins:this.pins,blockstore:this.blocks,root:this.root,loadCodec:t})}async init(e){qt("initializing at: %s",this.path),await this._openRoot(),await this.config.replace(pq(e)),await this.spec.set(gq(e)),await this.version.set(jl)}async isInitialized(){if(!this.closed)return!0;try{return await this._openRoot(),await this._checkInitialized(),await this.root.close(),!0}catch{return!1}}async open(){if(!this.closed)throw v(new Error("repo is already open"),Zj);qt("opening at: %s",this.path);try{if(await this._openRoot(),await this._checkInitialized(),this._lockfile=await this._openLock(),qt("acquired repo.lock"),!await this.version.check(jl))if(await this._isAutoMigrationEnabled())await this._migrate(jl,{root:this.root,datastore:this.datastore,pins:this.pins.pinstore,blocks:this.pins.blockstore,keys:this.keys});else throw new Sd("Incompatible repo versions. Automatic migrations disabled. Please migrate the repo manually.");qt("creating datastore"),await this.datastore.open(),qt("creating blocks"),await this.blocks.open(),qt("creating keystore"),await this.keys.open(),qt("creating pins"),await this.pins.pinstore.open(),this.closed=!1,qt("all opened")}catch(e){if(this._lockfile)try{await this._closeLock(),this._lockfile=null}catch(t){qt("error removing lock",t)}throw e}}async _openRoot(){try{await this.root.open()}catch(e){if(e.message!=="Already open")throw e}}async _openLock(){const e=await this.options.repoLock.lock(this.path);if(typeof e.close!="function")throw v(new Error("Locks must have a close method"),"ERR_NO_CLOSE_FUNCTION");return e}_closeLock(){return this._lockfile&&this._lockfile.close()}async _checkInitialized(){qt("init check");let e;try{[e]=await Promise.all([this.config.exists(),this.spec.exists(),this.version.exists()])}catch(t){throw t.code==="ERR_NOT_FOUND"?v(new Error("repo is not initialized yet"),Ca,{path:this.path}):t}if(!e)throw v(new Error("repo is not initialized yet"),Ca,{path:this.path})}async close(){if(this.closed)throw v(new Error("repo is already closed"),eH);qt("closing at: %s",this.path);try{await this.apiAddr.delete()}catch(e){if(e.code!==Ca&&!e.message.startsWith("ENOENT"))throw e}await Promise.all([this.root,this.blocks,this.keys,this.datastore,this.pins.pinstore].map(e=>e&&e.close())),qt("unlocking"),this.closed=!0,await this._closeLock()}exists(){return this.version.exists()}async stat(){if(this.datastore&&this.keys){const[e,t,n,s,i]=await Promise.all([this._storageMaxStat(),this._blockStat(),this.version.get(),c4(this.datastore),c4(this.keys)]),o=t.size+s+i;return{repoPath:this.path,storageMax:e,version:n,numObjects:t.count,repoSize:o}}throw v(new Error("repo is not initialized yet"),Ca,{path:this.path})}async _isAutoMigrationEnabled(){if(this.options.autoMigrate!==void 0)return this.options.autoMigrate;let e;try{e=await this.config.get(uq)}catch(t){if(t.code===Ws.code)e=!0;else throw t}return e}async _migrate(e,t){return await this.version.get()>e?(qt(`reverting to version ${e}`),Gj(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress})):(qt(`migrating to version ${e}`),qj(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress}))}async _storageMaxStat(){try{const e=await this.config.get("Datastore.StorageMax");return BigInt(hc(e))}catch{return BigInt(hq)}}async _blockStat(){let e=BigInt(0),t=BigInt(0);if(this.blocks)for await(const{key:n,value:s}of this.blocks.query({}))e+=BigInt(1),t+=BigInt(s.byteLength),t+=BigInt(n.bytes.byteLength);return{count:e,size:t}}}async function c4(r){let e=BigInt(0);for await(const t of r.query({}))e+=BigInt(t.value.byteLength),e+=BigInt(t.key.uint8Array().byteLength);return e}function fq(r,e,t,n){return new dq(r,e,t,n)}function pq(r){return r.Datastore=Object.assign({},v9,C2(r,"datastore")),r}function gq(r){const e={...v9.Spec,...C2(r,"Datastore.Spec")};return{type:e.type,mounts:e.mounts.map(t=>({mountpoint:t.mountpoint,type:t.child.type,path:t.child.path,shardFunc:t.child.shardFunc}))}}async function*iu(r,e){yield*(await Kn(r)).sort(e)}class aa extends ad{constructor(e,t={}){super(),this.db=typeof e=="string"?new yv(e,{...t,keyEncoding:"utf8",valueEncoding:"view"}):e,this.opts={createIfMissing:!0,compression:!1,...t}}async open(){try{await this.db.open(this.opts)}catch(e){throw k8(e)}}async put(e,t){try{await this.db.put(e.toString(),t)}catch(n){throw M1(n)}}async get(e){let t;try{t=await this.db.get(e.toString())}catch(n){throw n.notFound?hn(n):M1(n)}return t}async has(e){try{await this.db.get(e.toString())}catch(t){if(t.notFound)return!1;throw t}return!0}async delete(e){try{await this.db.del(e.toString())}catch(t){throw D8(t)}}close(){return this.db&&this.db.close()}batch(){const e=[];return{put:(t,n)=>{e.push({type:"put",key:t.toString(),value:n})},delete:t=>{e.push({type:"del",key:t.toString()})},commit:()=>this.db.batch(e)}}query(e){let t=this._query({values:!0,prefix:e.prefix});Array.isArray(e.filters)&&(t=e.filters.reduce((i,o)=>$e(i,o),t)),Array.isArray(e.orders)&&(t=e.orders.reduce((i,o)=>iu(i,o),t));const{offset:n,limit:s}=e;if(n){let i=0;t=$e(t,()=>i++>=n)}return s&&(t=Ei(t,s)),t}queryKeys(e){let t=zt(this._query({values:!1,prefix:e.prefix}),({key:i})=>i);Array.isArray(e.filters)&&(t=e.filters.reduce((i,o)=>$e(i,o),t)),Array.isArray(e.orders)&&(t=e.orders.reduce((i,o)=>iu(i,o),t));const{offset:n,limit:s}=e;if(n){let i=0;t=$e(t,()=>i++>=n)}return s&&(t=Ei(t,s)),t}_query(e){const t={keys:!0,keyEncoding:"buffer",values:e.values};if(e.prefix!=null){const s=e.prefix.toString();t.gte=s,t.lt=s+"ÿ"}const n=this.db.iterator(t);if(n[Symbol.asyncIterator])return yq(n);if(n.next!=null&&n.end!=null)return wq(n);throw new Error("Level returned incompatible iterator")}}async function*yq(r){for await(const[e,t]of r)yield{key:new X(e,!1),value:t};await r.close()}function wq(r){return{[Symbol.asyncIterator](){return{next:()=>new Promise((e,t)=>{r.next((n,s,i)=>{if(n)return t(n);if(s==null)return r.end(o=>{if(o)return t(o);e({done:!0,value:void 0})});e({done:!1,value:{key:new X(s,!1),value:i}})})}),return:()=>new Promise((e,t)=>{r.end(n=>{if(n)return t(n);e({done:!0,value:void 0})})})}}}}var mq=R9,l4=128,bq=127,Eq=~bq,_q=Math.pow(2,31);function R9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=_q;)e[t++]=r&255|l4,r/=128;for(;r&Eq;)e[t++]=r&255|l4,r>>>=7;return e[t]=r|0,R9.bytes=t-n+1,e}var vq=P0,Sq=128,h4=127;function P0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw P0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&h4)<<s:(o&h4)*Math.pow(2,s),s+=7}while(o>=Sq);return P0.bytes=i-n,t}var Rq=Math.pow(2,7),Aq=Math.pow(2,14),Iq=Math.pow(2,21),Cq=Math.pow(2,28),Tq=Math.pow(2,35),kq=Math.pow(2,42),Dq=Math.pow(2,49),Pq=Math.pow(2,56),Oq=Math.pow(2,63),Nq=function(r){return r<Rq?1:r<Aq?2:r<Iq?3:r<Cq?4:r<Tq?5:r<kq?6:r<Dq?7:r<Pq?8:r<Oq?9:10},xq={encode:mq,decode:vq,encodingLength:Nq},ou=xq;const O0=(r,e=0)=>[ou.decode(r,e),ou.decode.bytes],au=(r,e,t=0)=>(ou.encode(r,e,t),e),cu=r=>ou.encodingLength(r),$q=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},L2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Lq=(r,e)=>{const t=e.byteLength,n=cu(r),s=n+cu(t),i=new Uint8Array(s+t);return au(r,i,0),au(t,i,n),i.set(e,s),new M2(r,t,e,i)},A9=r=>{const e=L2(r),[t,n]=O0(e),[s,i]=O0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new M2(t,s,o,e)},Mq=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&$q(r.bytes,t.bytes)}};let M2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function Uq(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var Bq=Uq,zq=Bq;let Fq=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Vq=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return I9(this,e)}},Kq=class{constructor(e){this.decoders=e}or(e){return I9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const I9=(r,e)=>new Kq({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let jq=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Fq(e,t,n),this.decoder=new Vq(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const C9=({name:r,prefix:e,encode:t,decode:n})=>new jq(r,e,t,n),T9=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=zq(t,e);return C9({prefix:r,name:e,encode:n,decode:i=>L2(s(i))})},Hq=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},qq=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Xn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>C9({prefix:e,name:r,encode(s){return qq(s,n,t)},decode(s){return Hq(s,n,t,r)}}),en=T9({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});T9({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Un=Xn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Xn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});const Gq=Xn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Xn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Xn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Xn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Xn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Xn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Xn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const u4=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Yq(t,N0(r),e||en.encoder);default:return Qq(t,N0(r),e||Un.encoder)}},d4=new WeakMap,N0=r=>{const e=d4.get(r);if(e==null){const t=new Map;return d4.set(r,t),t}return e};let k9=class Dt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ca)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Xq)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Dt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Lq(e,t);return Dt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Dt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Mq(e.multihash,n.multihash)}toString(e){return u4(this,e)}toJSON(){return{"/":u4(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Dt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Dt(n,s,i,o||f4(n,s,i.bytes))}else if(t[Jq]===!0){const{version:n,multihash:s,code:i}=t,o=A9(s);return Dt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ca)throw new Error(`Version 0 CID must use dag-pb (code: ${ca}) block encoding`);return new Dt(e,t,n,n.bytes)}case 1:{const s=f4(e,t,n.bytes);return new Dt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Dt.create(0,ca,e)}static createV1(e,t){return Dt.create(1,e,t)}static decode(e){const[t,n]=Dt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Dt.inspectBytes(e),n=t.size-t.multihashSize,s=L2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new M2(t.multihashCode,t.digestSize,i,s);return[t.version===0?Dt.createV0(o):Dt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=O0(e.subarray(t));return t+=f,u};let s=n(),i=ca;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=Wq(e,t),i=Dt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return N0(i).set(n,e),i}};const Wq=(r,e)=>{switch(r[0]){case"Q":{const t=e||en;return[en.prefix,t.decode(`${en.prefix}${r}`)]}case en.prefix:{const t=e||en;return[en.prefix,t.decode(r)]}case Un.prefix:{const t=e||Un;return[Un.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Yq=(r,e,t)=>{const{prefix:n}=t;if(n!==en.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Qq=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ca=112,Xq=18,f4=(r,e,t)=>{const n=cu(r),s=n+cu(e),i=new Uint8Array(s+t.byteLength);return au(r,i,0),au(e,i,n),i.set(t,s),i},Jq=Symbol.for("@ipld/js-cid/CID"),Zq=85,p4=(r,e)=>async function*(){yield*(await Kn(r)).sort(e)}();class U2{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await ot(this.putMany(e,n)),e=[],await ot(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null&&(n=$e(n,s=>s.key.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>$e(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>p4(s,i),n)),e.offset!=null){let s=0;n=$e(n,()=>s++>=(e.offset||0))}return e.limit!=null&&(n=Ei(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null&&(n=$e(n,s=>s.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>$e(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>p4(s,i),n)),e.offset!=null){let s=0;n=$e(n,()=>s++>=e.offset)}return e.limit!=null&&(n=Ei(n,e.limit)),n}}function Fi(r){const e=k9.asCID(r);if(!e)throw v(new Error("Not a valid cid"),"ERR_INVALID_CID");return new X("/"+Un.encode(e.multihash.bytes).slice(1).toUpperCase(),!1)}function zs(r){return k9.createV1(Zq,A9(Un.decode("b"+r.toString().slice(1).toLowerCase())))}function B2(r){const e=r.substring(0,1);if(e==="/")return B2(r.substring(1));let t;e.toLowerCase()==="b"?t=i=>Un.decode(i.toLowerCase()).subarray(2):e.toLowerCase()==="c"?t=i=>Gq.decode(i.toLowerCase()).subarray(2):e==="z"?t=i=>en.decode(i).subarray(2):e==="Q"?t=i=>en.decode("z"+i):t=i=>Un.decode("b"+i.toLowerCase()).subarray(2);let n;for(let i=1;i<r.length;i++)try{n=t(r.substring(0,i))}catch(o){if(o.message!=="Unexpected end of data")throw o}let s="/C";return n&&(s=`/${Un.encode(n).slice(1,-1).toUpperCase()||"C"}`),s}function eG(r){return{...r,prefix:r.prefix?B2(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e({key:zs(t.key),value:t.value})):void 0,orders:r.orders?r.orders.map(e=>(t,n)=>e({key:zs(t.key),value:t.value},{key:zs(n.key),value:n.value})):void 0}}function tG(r){return{...r,prefix:r.prefix?B2(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e(zs(t))):void 0,orders:r.orders?r.orders.map(e=>(t,n)=>e(zs(t),zs(n))):void 0}}class rG extends U2{constructor(e){super(),this.child=e}open(){return this.child.open()}close(){return this.child.close()}async*query(e,t){for await(const{key:n,value:s}of this.child.query(eG(e),t))yield{key:zs(n),value:s}}async*queryKeys(e,t){for await(const n of this.child.queryKeys(tG(e),t))yield zs(n)}async get(e,t){return this.child.get(Fi(e),t)}async*getMany(e,t){for await(const n of e)yield this.get(n,t)}async put(e,t,n){await this.child.put(Fi(e),t,n)}async*putMany(e,t){const n=Bt({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)(async()=>{try{const i=this.child;await ot(this.child.putMany(async function*(){for await(const o of e){const a=Fi(o.key);await i.has(a,t)||(yield{key:a,value:o.value}),n.push(o)}}())),n.end()}catch(i){n.end(i)}}),yield*n}has(e,t){return this.child.has(Fi(e),t)}delete(e,t){return this.child.delete(Fi(e),t)}deleteMany(e,t){const n=Bt({objectMode:!0});return ot(this.child.deleteMany(async function*(){for await(const s of e)yield Fi(s),n.push(s);n.end()}(),t)).catch(s=>{n.end(s)}),n}}function nG(r,e,t){const n=t.path||"ipfs";return fq(n,s=>e.getCodec(s),{root:new aa(n,{prefix:"",version:2}),blocks:new rG(new aa(`${n}/blocks`,{prefix:"",version:2})),datastore:new aa(`${n}/datastore`,{prefix:"",version:2}),keys:new aa(`${n}/keys`,{prefix:"",version:2}),pins:new aa(`${n}/pins`,{prefix:"",version:2})},{autoMigrate:t.autoMigrate,onMigrationProgress:t.onMigrationProgress||r,repoLock:_9})}const sG={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var lu;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.publicKey!=null&&t.publicKey.byteLength>0)&&(n.uint32(10),n.bytes(t.publicKey)),(s.writeDefaults===!0||t.payloadType!=null&&t.payloadType.byteLength>0)&&(n.uint32(18),n.bytes(t.payloadType)),(s.writeDefaults===!0||t.payload!=null&&t.payload.byteLength>0)&&(n.uint32(26),n.bytes(t.payload)),(s.writeDefaults===!0||t.signature!=null&&t.signature.byteLength>0)&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.publicKey=t.bytes();break;case 2:s.payloadType=t.bytes();break;case 3:s.payload=t.bytes();break;case 5:s.signature=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(lu||(lu={}));function g4(r){return r instanceof Uint8Array?{get(e){return r[e]},set(e,t){r[e]=t}}:{get(e){return r.get(e)},set(e,t){r.set(e,t)}}}const y4=4294967296;class Jr{constructor(e=0,t=0){this.hi=e,this.lo=t}toBigInt(e){if(e===!0)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toNumber(e){return Number(this.toBigInt(e))}zzDecode(){const e=-(this.lo&1),t=((this.lo>>>1|this.hi<<31)^e)>>>0,n=(this.hi>>>1^e)>>>0;return new Jr(n,t)}zzEncode(){const e=this.hi>>31,t=((this.hi<<1|this.lo>>>31)^e)>>>0,n=(this.lo<<1^e)>>>0;return new Jr(t,n)}toBytes(e,t=0){const n=g4(e);for(;this.hi>0;)n.set(t++,this.lo&127|128),this.lo=(this.lo>>>7|this.hi<<25)>>>0,this.hi>>>=7;for(;this.lo>127;)n.set(t++,this.lo&127|128),this.lo=this.lo>>>7;n.set(t++,this.lo)}static fromBigInt(e){if(e===0n)return new Jr;const t=e<0;t&&(e=-e);let n=Number(e>>32n)|0,s=Number(e-(BigInt(n)<<32n))|0;return t&&(n=~n>>>0,s=~s>>>0,++s>y4&&(s=0,++n>y4&&(n=0))),new Jr(n,s)}static fromNumber(e){if(e===0)return new Jr;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new Jr(s,n)}static fromBytes(e,t=0){const n=g4(e),s=new Jr;let i=0;if(e.length-t>4){for(;i<4;++i)if(s.lo=(s.lo|(n.get(t)&127)<<i*7)>>>0,n.get(t++)<128)return s;if(s.lo=(s.lo|(n.get(t)&127)<<28)>>>0,s.hi=(s.hi|(n.get(t)&127)>>4)>>>0,n.get(t++)<128)return s;i=0}else for(;i<4;++i){if(t>=e.length)throw RangeError(`index out of range: ${t} > ${e.length}`);if(s.lo=(s.lo|(n.get(t)&127)<<i*7)>>>0,n.get(t++)<128)return s}if(e.length-t>4){for(;i<5;++i)if(s.hi=(s.hi|(n.get(t)&127)<<i*7+3)>>>0,n.get(t++)<128)return s}else if(t<e.byteLength)for(;i<5;++i){if(t>=e.length)throw RangeError(`index out of range: ${t} > ${e.length}`);if(s.hi=(s.hi|(n.get(t)&127)<<i*7+3)>>>0,n.get(t++)<128)return s}throw RangeError("invalid varint encoding")}}const iG=Math.pow(2,7),oG=Math.pow(2,14),aG=Math.pow(2,21),cG=Math.pow(2,28),lG=Math.pow(2,35),hG=Math.pow(2,42),uG=Math.pow(2,49),dG=Math.pow(2,56),fG=Math.pow(2,63),Fs={encodingLength(r){return r<iG?1:r<oG?2:r<aG?3:r<cG?4:r<lG?5:r<hG?6:r<uG?7:r<dG?8:r<fG?9:10},encode(r,e,t=0){if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return e==null&&(e=th(Fs.encodingLength(r))),Jr.fromNumber(r).toBytes(e,t),e},decode(r,e=0){return Jr.fromBytes(r,e).toNumber(!0)}};class or{constructor(e){const{peerId:t,payloadType:n,payload:s,signature:i}=e;this.peerId=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=lu.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return Ye(this.marshal(),e.marshal())}async validate(e){const t=D9(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return await mi(this.peerId.publicKey).verify(t.subarray(),this.signature)}}or.createFromProtobuf=async r=>{const e=lu.decode(r),t=await Ir(e.publicKey);return new or({peerId:t,payloadType:e.payloadType,payload:e.payload,signature:e.signature})};or.seal=async(r,e)=>{if(e.privateKey==null)throw new Error("Missing private key");const t=r.domain,n=r.codec,s=r.marshal(),i=D9(t,n,s),a=await(await Qs(e.privateKey)).sign(i.subarray());return new or({peerId:e,payloadType:n,payload:s,signature:a})};or.openAndCertify=async(r,e)=>{const t=await or.createFromProtobuf(r);if(!await t.validate(e))throw v(new Error("envelope signature is not valid for the given domain"),sG.ERR_SIGNATURE_NOT_VALID);return t};const D9=(r,e,t)=>{const n=L(r),s=Fs.encode(n.byteLength),i=Fs.encode(e.length),o=Fs.encode(t.length);return new ke(s,n,i,e,o,t)};function pG(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}var hu;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Qe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),(o.writeDefaults===!0||s.multiaddr!=null&&s.multiaddr.byteLength>0)&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={multiaddr:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.multiaddr=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),t.encode=s=>Xe(s,t.codec()),t.decode=s=>Je(s,t.codec())})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.peerId!=null&&t.peerId.byteLength>0)&&(n.uint32(10),n.bytes(t.peerId)),(s.writeDefaults===!0||t.seq!==0n)&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n,{writeDefaults:!0});s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.peerId=t.bytes();break;case 2:s.seq=t.uint64();break;case 3:s.addresses.push(r.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(hu||(hu={}));const gG="libp2p-peer-record",yG=Uint8Array.from([3,1]);class Jt{constructor(e){this.domain=Jt.DOMAIN,this.codec=Jt.CODEC;const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=hu.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Jt)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!pG(this.multiaddrs,e.multiaddrs))}}Jt.createFromProtobuf=r=>{const e=hu.decode(r),t=Fr(e.peerId),n=(e.addresses??[]).map(i=>G(i.multiaddr)),s=e.seq;return new Jt({peerId:t,multiaddrs:n,seqNumber:s})};Jt.DOMAIN=gG;Jt.CODEC=yG;const x0=Symbol.for("@libp2p/topology");function wG(r){return r!=null&&Boolean(r[x0])}const w4=()=>{};class mG{constructor(e){this.min=e.min??0,this.max=e.max??1/0,this.peers=new Set,this.onConnect=e.onConnect??w4,this.onDisconnect=e.onDisconnect??w4}get[Symbol.toStringTag](){return x0.toString()}get[x0](){return!0}async setRegistrar(e){this.registrar=e}disconnect(e){this.onDisconnect(e)}}function z2(r){return new mG(r)}var ei=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Cn;let Fe=class extends EventTarget{constructor(){super(...arguments),Cn.set(this,new Map)}listenerCount(e){const t=ei(this,Cn,"f").get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=ei(this,Cn,"f").get(e);s==null&&(s=[],ei(this,Cn,"f").set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=ei(this,Cn,"f").get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),ei(this,Cn,"f").set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=ei(this,Cn,"f").get(e.type);return n==null||(n=n.filter(({once:s})=>!s),ei(this,Cn,"f").set(e.type,n)),t}safeDispatchEvent(e,t){return this.dispatchEvent(new F(e,t))}};Cn=new WeakMap;class bG extends Event{constructor(e,t){super(e,t),this.detail=t?.detail}}const F=globalThis.CustomEvent??bG;class EG{constructor(e,t,n){this.gossip=e,this.msgs=new Map,this.history=[],this.notValidatedCount=0,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(!n)return null;const s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{const i=this.msgs.get(s.msgIdStr);if(i&&i.validated&&e.has(s.topic)){let o=t.get(s.topic);o||(o=[],t.set(s.topic,o)),o.push(s.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(!t)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{const n=this.msgs.get(t.msgIdStr);n&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}}var $0={},_G={get exports(){return $0},set exports(r){$0=r}},uu={},vG={get exports(){return uu},set exports(r){uu=r}},Of={},Nf={},xf,m4;function SG(){if(m4)return xf;m4=1,xf=e;var r=xi();function e(i,o){this.lo=i>>>0,this.hi=o>>>0}var t=e.zero=new e(0,0);t.toNumber=function(){return 0},t.zzEncode=t.zzDecode=function(){return this},t.length=function(){return 1};var n=e.zeroHash="\0\0\0\0\0\0\0\0";e.fromNumber=function(o){if(o===0)return t;var a=o<0;a&&(o=-o);var c=o>>>0,h=(o-c)/4294967296>>>0;return a&&(h=~h>>>0,c=~c>>>0,++c>4294967295&&(c=0,++h>4294967295&&(h=0))),new e(c,h)},e.from=function(o){if(typeof o=="number")return e.fromNumber(o);if(r.isString(o))if(r.Long)o=r.Long.fromString(o);else return e.fromNumber(parseInt(o,10));return o.low||o.high?new e(o.low>>>0,o.high>>>0):t},e.prototype.toNumber=function(o){if(!o&&this.hi>>>31){var a=~this.lo+1>>>0,c=~this.hi>>>0;return a||(c=c+1>>>0),-(a+c*4294967296)}return this.lo+this.hi*4294967296},e.prototype.toLong=function(o){return r.Long?new r.Long(this.lo|0,this.hi|0,Boolean(o)):{low:this.lo|0,high:this.hi|0,unsigned:Boolean(o)}};var s=String.prototype.charCodeAt;return e.fromHash=function(o){return o===n?t:new e((s.call(o,0)|s.call(o,1)<<8|s.call(o,2)<<16|s.call(o,3)<<24)>>>0,(s.call(o,4)|s.call(o,5)<<8|s.call(o,6)<<16|s.call(o,7)<<24)>>>0)},e.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},e.prototype.zzEncode=function(){var o=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^o)>>>0,this.lo=(this.lo<<1^o)>>>0,this},e.prototype.zzDecode=function(){var o=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^o)>>>0,this.hi=(this.hi>>>1^o)>>>0,this},e.prototype.length=function(){var o=this.lo,a=(this.lo>>>28|this.hi<<4)>>>0,c=this.hi>>>24;return c===0?a===0?o<16384?o<128?1:2:o<2097152?3:4:a<16384?a<128?5:6:a<2097152?7:8:c<128?9:10},xf}var b4;function xi(){return b4||(b4=1,function(r){var e=r;e.asPromise=wv,e.base64=mv,e.EventEmitter=bv,e.float=Ev,e.inquire=_v,e.utf8=vv,e.pool=Sv,e.LongBits=SG(),e.isNode=Boolean(typeof Xr<"u"&&Xr&&Xr.process&&Xr.process.versions&&Xr.process.versions.node),e.global=e.isNode&&Xr||typeof window<"u"&&window||typeof self<"u"&&self||Xr,e.emptyArray=Object.freeze?Object.freeze([]):[],e.emptyObject=Object.freeze?Object.freeze({}):{},e.isInteger=Number.isInteger||function(i){return typeof i=="number"&&isFinite(i)&&Math.floor(i)===i},e.isString=function(i){return typeof i=="string"||i instanceof String},e.isObject=function(i){return i&&typeof i=="object"},e.isset=e.isSet=function(i,o){var a=i[o];return a!=null&&i.hasOwnProperty(o)?typeof a!="object"||(Array.isArray(a)?a.length:Object.keys(a).length)>0:!1},e.Buffer=function(){try{var s=e.inquire("buffer").Buffer;return s.prototype.utf8Write?s:null}catch{return null}}(),e._Buffer_from=null,e._Buffer_allocUnsafe=null,e.newBuffer=function(i){return typeof i=="number"?e.Buffer?e._Buffer_allocUnsafe(i):new e.Array(i):e.Buffer?e._Buffer_from(i):typeof Uint8Array>"u"?i:new Uint8Array(i)},e.Array=typeof Uint8Array<"u"?Uint8Array:Array,e.Long=e.global.dcodeIO&&e.global.dcodeIO.Long||e.global.Long||e.inquire("long"),e.key2Re=/^true|false|0|1$/,e.key32Re=/^-?(?:0|[1-9][0-9]*)$/,e.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,e.longToHash=function(i){return i?e.LongBits.from(i).toHash():e.LongBits.zeroHash},e.longFromHash=function(i,o){var a=e.LongBits.fromHash(i);return e.Long?e.Long.fromBits(a.lo,a.hi,o):a.toNumber(Boolean(o))};function t(s,i,o){for(var a=Object.keys(i),c=0;c<a.length;++c)(s[a[c]]===void 0||!o)&&(s[a[c]]=i[a[c]]);return s}e.merge=t,e.lcFirst=function(i){return i.charAt(0).toLowerCase()+i.substring(1)};function n(s){function i(o,a){if(!(this instanceof i))return new i(o,a);Object.defineProperty(this,"message",{get:function(){return o}}),Error.captureStackTrace?Error.captureStackTrace(this,i):Object.defineProperty(this,"stack",{value:new Error().stack||""}),a&&t(this,a)}return(i.prototype=Object.create(Error.prototype)).constructor=i,Object.defineProperty(i.prototype,"name",{get:function(){return s}}),i.prototype.toString=function(){return this.name+": "+this.message},i}e.newError=n,e.ProtocolError=n("ProtocolError"),e.oneOfGetter=function(i){for(var o={},a=0;a<i.length;++a)o[i[a]]=1;return function(){for(var c=Object.keys(this),h=c.length-1;h>-1;--h)if(o[c[h]]===1&&this[c[h]]!==void 0&&this[c[h]]!==null)return c[h]}},e.oneOfSetter=function(i){return function(o){for(var a=0;a<i.length;++a)i[a]!==o&&delete this[i[a]]}},e.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},e._configure=function(){var s=e.Buffer;if(!s){e._Buffer_from=e._Buffer_allocUnsafe=null;return}e._Buffer_from=s.from!==Uint8Array.from&&s.from||function(o,a){return new s(o,a)},e._Buffer_allocUnsafe=s.allocUnsafe||function(o){return new s(o)}}}(Nf)),Nf}var $f,E4;function P9(){if(E4)return $f;E4=1,$f=c;var r=xi(),e,t=r.LongBits,n=r.base64,s=r.utf8;function i(w,y,_){this.fn=w,this.len=y,this.next=void 0,this.val=_}function o(){}function a(w){this.head=w.head,this.tail=w.tail,this.len=w.len,this.next=w.states}function c(){this.len=0,this.head=new i(o,0,0),this.tail=this.head,this.states=null}var h=function(){return r.Buffer?function(){return(c.create=function(){return new e})()}:function(){return new c}};c.create=h(),c.alloc=function(y){return new r.Array(y)},r.Array!==Array&&(c.alloc=r.pool(c.alloc,r.Array.prototype.subarray)),c.prototype._push=function(y,_,m){return this.tail=this.tail.next=new i(y,_,m),this.len+=_,this};function l(w,y,_){y[_]=w&255}function u(w,y,_){for(;w>127;)y[_++]=w&127|128,w>>>=7;y[_]=w}function f(w,y){this.len=w,this.next=void 0,this.val=y}f.prototype=Object.create(i.prototype),f.prototype.fn=u,c.prototype.uint32=function(y){return this.len+=(this.tail=this.tail.next=new f((y=y>>>0)<128?1:y<16384?2:y<2097152?3:y<268435456?4:5,y)).len,this},c.prototype.int32=function(y){return y<0?this._push(g,10,t.fromNumber(y)):this.uint32(y)},c.prototype.sint32=function(y){return this.uint32((y<<1^y>>31)>>>0)};function g(w,y,_){for(;w.hi;)y[_++]=w.lo&127|128,w.lo=(w.lo>>>7|w.hi<<25)>>>0,w.hi>>>=7;for(;w.lo>127;)y[_++]=w.lo&127|128,w.lo=w.lo>>>7;y[_++]=w.lo}c.prototype.uint64=function(y){var _=t.from(y);return this._push(g,_.length(),_)},c.prototype.int64=c.prototype.uint64,c.prototype.sint64=function(y){var _=t.from(y).zzEncode();return this._push(g,_.length(),_)},c.prototype.bool=function(y){return this._push(l,1,y?1:0)};function d(w,y,_){y[_]=w&255,y[_+1]=w>>>8&255,y[_+2]=w>>>16&255,y[_+3]=w>>>24}c.prototype.fixed32=function(y){return this._push(d,4,y>>>0)},c.prototype.sfixed32=c.prototype.fixed32,c.prototype.fixed64=function(y){var _=t.from(y);return this._push(d,4,_.lo)._push(d,4,_.hi)},c.prototype.sfixed64=c.prototype.fixed64,c.prototype.float=function(y){return this._push(r.float.writeFloatLE,4,y)},c.prototype.double=function(y){return this._push(r.float.writeDoubleLE,8,y)};var p=r.Array.prototype.set?function(y,_,m){_.set(y,m)}:function(y,_,m){for(var b=0;b<y.length;++b)_[m+b]=y[b]};return c.prototype.bytes=function(y){var _=y.length>>>0;if(!_)return this._push(l,1,0);if(r.isString(y)){var m=c.alloc(_=n.length(y));n.decode(y,m,0),y=m}return this.uint32(_)._push(p,_,y)},c.prototype.string=function(y){var _=s.length(y);return _?this.uint32(_)._push(s.write,_,y):this._push(l,1,0)},c.prototype.fork=function(){return this.states=new a(this),this.head=this.tail=new i(o,0,0),this.len=0,this},c.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new i(o,0,0),this.len=0),this},c.prototype.ldelim=function(){var y=this.head,_=this.tail,m=this.len;return this.reset().uint32(m),m&&(this.tail.next=y.next,this.tail=_,this.len+=m),this},c.prototype.finish=function(){for(var y=this.head.next,_=this.constructor.alloc(this.len),m=0;y;)y.fn(y.val,_,m),m+=y.len,y=y.next;return _},c._configure=function(w){e=w,c.create=h(),e._configure()},$f}var Lf,_4;function RG(){if(_4)return Lf;_4=1,Lf=t;var r=P9();(t.prototype=Object.create(r.prototype)).constructor=t;var e=xi();function t(){r.call(this)}t._configure=function(){t.alloc=e._Buffer_allocUnsafe,t.writeBytesBuffer=e.Buffer&&e.Buffer.prototype instanceof Uint8Array&&e.Buffer.prototype.set.name==="set"?function(i,o,a){o.set(i,a)}:function(i,o,a){if(i.copy)i.copy(o,a,0,i.length);else for(var c=0;c<i.length;)o[a++]=i[c++]}},t.prototype.bytes=function(i){e.isString(i)&&(i=e._Buffer_from(i,"base64"));var o=i.length>>>0;return this.uint32(o),o&&this._push(t.writeBytesBuffer,o,i),this};function n(s,i,o){s.length<40?e.utf8.write(s,i,o):i.utf8Write?i.utf8Write(s,o):i.write(s,o)}return t.prototype.string=function(i){var o=e.Buffer.byteLength(i);return this.uint32(o),o&&this._push(n,o,i),this},t._configure(),Lf}var Mf,v4;function O9(){if(v4)return Mf;v4=1,Mf=i;var r=xi(),e,t=r.LongBits,n=r.utf8;function s(u,f){return RangeError("index out of range: "+u.pos+" + "+(f||1)+" > "+u.len)}function i(u){this.buf=u,this.pos=0,this.len=u.length}var o=typeof Uint8Array<"u"?function(f){if(f instanceof Uint8Array||Array.isArray(f))return new i(f);throw Error("illegal buffer")}:function(f){if(Array.isArray(f))return new i(f);throw Error("illegal buffer")},a=function(){return r.Buffer?function(g){return(i.create=function(p){return r.Buffer.isBuffer(p)?new e(p):o(p)})(g)}:o};i.create=a(),i.prototype._slice=r.Array.prototype.subarray||r.Array.prototype.slice,i.prototype.uint32=function(){var f=4294967295;return function(){if(f=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(f=(f|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return f;if((this.pos+=5)>this.len)throw this.pos=this.len,s(this,10);return f}}(),i.prototype.int32=function(){return this.uint32()|0},i.prototype.sint32=function(){var f=this.uint32();return f>>>1^-(f&1)|0};function c(){var u=new t(0,0),f=0;if(this.len-this.pos>4){for(;f<4;++f)if(u.lo=(u.lo|(this.buf[this.pos]&127)<<f*7)>>>0,this.buf[this.pos++]<128)return u;if(u.lo=(u.lo|(this.buf[this.pos]&127)<<28)>>>0,u.hi=(u.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return u;f=0}else{for(;f<3;++f){if(this.pos>=this.len)throw s(this);if(u.lo=(u.lo|(this.buf[this.pos]&127)<<f*7)>>>0,this.buf[this.pos++]<128)return u}return u.lo=(u.lo|(this.buf[this.pos++]&127)<<f*7)>>>0,u}if(this.len-this.pos>4){for(;f<5;++f)if(u.hi=(u.hi|(this.buf[this.pos]&127)<<f*7+3)>>>0,this.buf[this.pos++]<128)return u}else for(;f<5;++f){if(this.pos>=this.len)throw s(this);if(u.hi=(u.hi|(this.buf[this.pos]&127)<<f*7+3)>>>0,this.buf[this.pos++]<128)return u}throw Error("invalid varint encoding")}i.prototype.bool=function(){return this.uint32()!==0};function h(u,f){return(u[f-4]|u[f-3]<<8|u[f-2]<<16|u[f-1]<<24)>>>0}i.prototype.fixed32=function(){if(this.pos+4>this.len)throw s(this,4);return h(this.buf,this.pos+=4)},i.prototype.sfixed32=function(){if(this.pos+4>this.len)throw s(this,4);return h(this.buf,this.pos+=4)|0};function l(){if(this.pos+8>this.len)throw s(this,8);return new t(h(this.buf,this.pos+=4),h(this.buf,this.pos+=4))}return i.prototype.float=function(){if(this.pos+4>this.len)throw s(this,4);var f=r.float.readFloatLE(this.buf,this.pos);return this.pos+=4,f},i.prototype.double=function(){if(this.pos+8>this.len)throw s(this,4);var f=r.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,f},i.prototype.bytes=function(){var f=this.uint32(),g=this.pos,d=this.pos+f;if(d>this.len)throw s(this,f);return this.pos+=f,Array.isArray(this.buf)?this.buf.slice(g,d):g===d?new this.buf.constructor(0):this._slice.call(this.buf,g,d)},i.prototype.string=function(){var f=this.bytes();return n.read(f,0,f.length)},i.prototype.skip=function(f){if(typeof f=="number"){if(this.pos+f>this.len)throw s(this,f);this.pos+=f}else do if(this.pos>=this.len)throw s(this);while(this.buf[this.pos++]&128);return this},i.prototype.skipType=function(u){switch(u){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(u=this.uint32()&7)!==4;)this.skipType(u);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+u+" at offset "+this.pos)}return this},i._configure=function(u){e=u,i.create=a(),e._configure();var f=r.Long?"toLong":"toNumber";r.merge(i.prototype,{int64:function(){return c.call(this)[f](!1)},uint64:function(){return c.call(this)[f](!0)},sint64:function(){return c.call(this).zzDecode()[f](!1)},fixed64:function(){return l.call(this)[f](!0)},sfixed64:function(){return l.call(this)[f](!1)}})},Mf}var Uf,S4;function AG(){if(S4)return Uf;S4=1,Uf=t;var r=O9();(t.prototype=Object.create(r.prototype)).constructor=t;var e=xi();function t(n){r.call(this,n)}return t._configure=function(){e.Buffer&&(t.prototype._slice=e.Buffer.prototype.slice)},t.prototype.string=function(){var s=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+s,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+s,this.len))},t._configure(),Uf}var Bf={},zf,R4;function IG(){if(R4)return zf;R4=1,zf=e;var r=xi();(e.prototype=Object.create(r.EventEmitter.prototype)).constructor=e;function e(t,n,s){if(typeof t!="function")throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(n),this.responseDelimited=Boolean(s)}return e.prototype.rpcCall=function t(n,s,i,o,a){if(!o)throw TypeError("request must be specified");var c=this;if(!a)return r.asPromise(t,c,n,s,i,o);if(!c.rpcImpl){setTimeout(function(){a(Error("already ended"))},0);return}try{return c.rpcImpl(n,s[c.requestDelimited?"encodeDelimited":"encode"](o).finish(),function(l,u){if(l)return c.emit("error",l,n),a(l);if(u===null){c.end(!0);return}if(!(u instanceof i))try{u=i[c.responseDelimited?"decodeDelimited":"decode"](u)}catch(f){return c.emit("error",f,n),a(f)}return c.emit("data",u,n),a(null,u)})}catch(h){c.emit("error",h,n),setTimeout(function(){a(h)},0);return}},e.prototype.end=function(n){return this.rpcImpl&&(n||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},zf}var A4;function CG(){return A4||(A4=1,function(r){var e=r;e.Service=IG()}(Bf)),Bf}var Ff,I4;function TG(){return I4||(I4=1,Ff={}),Ff}var C4;function kG(){return C4||(C4=1,function(r){var e=r;e.build="minimal",e.Writer=P9(),e.BufferWriter=RG(),e.Reader=O9(),e.BufferReader=AG(),e.util=xi(),e.rpc=CG(),e.roots=TG(),e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()}(Of)),Of}var T4;function N9(){return T4||(T4=1,function(r){r.exports=kG()}(vG)),uu}(function(r){(function(e,t){typeof Rv=="function"&&r&&r.exports&&(r.exports=t(N9()))})(Xr,function(e){var t=e.Reader,n=e.Writer,s=e.util,i=e.roots.default||(e.roots.default={});return i.RPC=function(){function o(c){if(this.subscriptions=[],this.messages=[],c)for(var h=Object.keys(c),l=0;l<h.length;++l)c[h[l]]!=null&&(this[h[l]]=c[h[l]])}o.prototype.subscriptions=s.emptyArray,o.prototype.messages=s.emptyArray,o.prototype.control=null;var a;return Object.defineProperty(o.prototype,"_control",{get:s.oneOfGetter(a=["control"]),set:s.oneOfSetter(a)}),o.encode=function(h,l){if(l||(l=n.create()),h.subscriptions!=null&&h.subscriptions.length)for(var u=0;u<h.subscriptions.length;++u)i.RPC.SubOpts.encode(h.subscriptions[u],l.uint32(10).fork()).ldelim();if(h.messages!=null&&h.messages.length)for(var u=0;u<h.messages.length;++u)i.RPC.Message.encode(h.messages[u],l.uint32(18).fork()).ldelim();return h.control!=null&&Object.hasOwnProperty.call(h,"control")&&i.RPC.ControlMessage.encode(h.control,l.uint32(26).fork()).ldelim(),l},o.decode=function(h,l){h instanceof t||(h=t.create(h));for(var u=l===void 0?h.len:h.pos+l,f=new i.RPC;h.pos<u;){var g=h.uint32();switch(g>>>3){case 1:f.subscriptions&&f.subscriptions.length||(f.subscriptions=[]),f.subscriptions.push(i.RPC.SubOpts.decode(h,h.uint32()));break;case 2:f.messages&&f.messages.length||(f.messages=[]),f.messages.push(i.RPC.Message.decode(h,h.uint32()));break;case 3:f.control=i.RPC.ControlMessage.decode(h,h.uint32());break;default:h.skipType(g&7);break}}return f},o.fromObject=function(h){if(h instanceof i.RPC)return h;var l=new i.RPC;if(h.subscriptions){if(!Array.isArray(h.subscriptions))throw TypeError(".RPC.subscriptions: array expected");l.subscriptions=[];for(var u=0;u<h.subscriptions.length;++u){if(typeof h.subscriptions[u]!="object")throw TypeError(".RPC.subscriptions: object expected");l.subscriptions[u]=i.RPC.SubOpts.fromObject(h.subscriptions[u])}}if(h.messages){if(!Array.isArray(h.messages))throw TypeError(".RPC.messages: array expected");l.messages=[];for(var u=0;u<h.messages.length;++u){if(typeof h.messages[u]!="object")throw TypeError(".RPC.messages: object expected");l.messages[u]=i.RPC.Message.fromObject(h.messages[u])}}if(h.control!=null){if(typeof h.control!="object")throw TypeError(".RPC.control: object expected");l.control=i.RPC.ControlMessage.fromObject(h.control)}return l},o.toObject=function(h,l){l||(l={});var u={};if((l.arrays||l.defaults)&&(u.subscriptions=[],u.messages=[]),h.subscriptions&&h.subscriptions.length){u.subscriptions=[];for(var f=0;f<h.subscriptions.length;++f)u.subscriptions[f]=i.RPC.SubOpts.toObject(h.subscriptions[f],l)}if(h.messages&&h.messages.length){u.messages=[];for(var f=0;f<h.messages.length;++f)u.messages[f]=i.RPC.Message.toObject(h.messages[f],l)}return h.control!=null&&h.hasOwnProperty("control")&&(u.control=i.RPC.ControlMessage.toObject(h.control,l),l.oneofs&&(u._control="control")),u},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o.SubOpts=function(){function c(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}c.prototype.subscribe=null,c.prototype.topic=null;var h;return Object.defineProperty(c.prototype,"_subscribe",{get:s.oneOfGetter(h=["subscribe"]),set:s.oneOfSetter(h)}),Object.defineProperty(c.prototype,"_topic",{get:s.oneOfGetter(h=["topic"]),set:s.oneOfSetter(h)}),c.encode=function(u,f){return f||(f=n.create()),u.subscribe!=null&&Object.hasOwnProperty.call(u,"subscribe")&&f.uint32(8).bool(u.subscribe),u.topic!=null&&Object.hasOwnProperty.call(u,"topic")&&f.uint32(18).string(u.topic),f},c.decode=function(u,f){u instanceof t||(u=t.create(u));for(var g=f===void 0?u.len:u.pos+f,d=new i.RPC.SubOpts;u.pos<g;){var p=u.uint32();switch(p>>>3){case 1:d.subscribe=u.bool();break;case 2:d.topic=u.string();break;default:u.skipType(p&7);break}}return d},c.fromObject=function(u){if(u instanceof i.RPC.SubOpts)return u;var f=new i.RPC.SubOpts;return u.subscribe!=null&&(f.subscribe=Boolean(u.subscribe)),u.topic!=null&&(f.topic=String(u.topic)),f},c.toObject=function(u,f){f||(f={});var g={};return u.subscribe!=null&&u.hasOwnProperty("subscribe")&&(g.subscribe=u.subscribe,f.oneofs&&(g._subscribe="subscribe")),u.topic!=null&&u.hasOwnProperty("topic")&&(g.topic=u.topic,f.oneofs&&(g._topic="topic")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.Message=function(){function c(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}c.prototype.from=null,c.prototype.data=null,c.prototype.seqno=null,c.prototype.topic="",c.prototype.signature=null,c.prototype.key=null;var h;return Object.defineProperty(c.prototype,"_from",{get:s.oneOfGetter(h=["from"]),set:s.oneOfSetter(h)}),Object.defineProperty(c.prototype,"_data",{get:s.oneOfGetter(h=["data"]),set:s.oneOfSetter(h)}),Object.defineProperty(c.prototype,"_seqno",{get:s.oneOfGetter(h=["seqno"]),set:s.oneOfSetter(h)}),Object.defineProperty(c.prototype,"_signature",{get:s.oneOfGetter(h=["signature"]),set:s.oneOfSetter(h)}),Object.defineProperty(c.prototype,"_key",{get:s.oneOfGetter(h=["key"]),set:s.oneOfSetter(h)}),c.encode=function(u,f){return f||(f=n.create()),u.from!=null&&Object.hasOwnProperty.call(u,"from")&&f.uint32(10).bytes(u.from),u.data!=null&&Object.hasOwnProperty.call(u,"data")&&f.uint32(18).bytes(u.data),u.seqno!=null&&Object.hasOwnProperty.call(u,"seqno")&&f.uint32(26).bytes(u.seqno),f.uint32(34).string(u.topic),u.signature!=null&&Object.hasOwnProperty.call(u,"signature")&&f.uint32(42).bytes(u.signature),u.key!=null&&Object.hasOwnProperty.call(u,"key")&&f.uint32(50).bytes(u.key),f},c.decode=function(u,f){u instanceof t||(u=t.create(u));for(var g=f===void 0?u.len:u.pos+f,d=new i.RPC.Message;u.pos<g;){var p=u.uint32();switch(p>>>3){case 1:d.from=u.bytes();break;case 2:d.data=u.bytes();break;case 3:d.seqno=u.bytes();break;case 4:d.topic=u.string();break;case 5:d.signature=u.bytes();break;case 6:d.key=u.bytes();break;default:u.skipType(p&7);break}}if(!d.hasOwnProperty("topic"))throw s.ProtocolError("missing required 'topic'",{instance:d});return d},c.fromObject=function(u){if(u instanceof i.RPC.Message)return u;var f=new i.RPC.Message;return u.from!=null&&(typeof u.from=="string"?s.base64.decode(u.from,f.from=s.newBuffer(s.base64.length(u.from)),0):u.from.length&&(f.from=u.from)),u.data!=null&&(typeof u.data=="string"?s.base64.decode(u.data,f.data=s.newBuffer(s.base64.length(u.data)),0):u.data.length&&(f.data=u.data)),u.seqno!=null&&(typeof u.seqno=="string"?s.base64.decode(u.seqno,f.seqno=s.newBuffer(s.base64.length(u.seqno)),0):u.seqno.length&&(f.seqno=u.seqno)),u.topic!=null&&(f.topic=String(u.topic)),u.signature!=null&&(typeof u.signature=="string"?s.base64.decode(u.signature,f.signature=s.newBuffer(s.base64.length(u.signature)),0):u.signature.length&&(f.signature=u.signature)),u.key!=null&&(typeof u.key=="string"?s.base64.decode(u.key,f.key=s.newBuffer(s.base64.length(u.key)),0):u.key.length&&(f.key=u.key)),f},c.toObject=function(u,f){f||(f={});var g={};return f.defaults&&(g.topic=""),u.from!=null&&u.hasOwnProperty("from")&&(g.from=f.bytes===String?s.base64.encode(u.from,0,u.from.length):f.bytes===Array?Array.prototype.slice.call(u.from):u.from,f.oneofs&&(g._from="from")),u.data!=null&&u.hasOwnProperty("data")&&(g.data=f.bytes===String?s.base64.encode(u.data,0,u.data.length):f.bytes===Array?Array.prototype.slice.call(u.data):u.data,f.oneofs&&(g._data="data")),u.seqno!=null&&u.hasOwnProperty("seqno")&&(g.seqno=f.bytes===String?s.base64.encode(u.seqno,0,u.seqno.length):f.bytes===Array?Array.prototype.slice.call(u.seqno):u.seqno,f.oneofs&&(g._seqno="seqno")),u.topic!=null&&u.hasOwnProperty("topic")&&(g.topic=u.topic),u.signature!=null&&u.hasOwnProperty("signature")&&(g.signature=f.bytes===String?s.base64.encode(u.signature,0,u.signature.length):f.bytes===Array?Array.prototype.slice.call(u.signature):u.signature,f.oneofs&&(g._signature="signature")),u.key!=null&&u.hasOwnProperty("key")&&(g.key=f.bytes===String?s.base64.encode(u.key,0,u.key.length):f.bytes===Array?Array.prototype.slice.call(u.key):u.key,f.oneofs&&(g._key="key")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlMessage=function(){function c(h){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],h)for(var l=Object.keys(h),u=0;u<l.length;++u)h[l[u]]!=null&&(this[l[u]]=h[l[u]])}return c.prototype.ihave=s.emptyArray,c.prototype.iwant=s.emptyArray,c.prototype.graft=s.emptyArray,c.prototype.prune=s.emptyArray,c.encode=function(l,u){if(u||(u=n.create()),l.ihave!=null&&l.ihave.length)for(var f=0;f<l.ihave.length;++f)i.RPC.ControlIHave.encode(l.ihave[f],u.uint32(10).fork()).ldelim();if(l.iwant!=null&&l.iwant.length)for(var f=0;f<l.iwant.length;++f)i.RPC.ControlIWant.encode(l.iwant[f],u.uint32(18).fork()).ldelim();if(l.graft!=null&&l.graft.length)for(var f=0;f<l.graft.length;++f)i.RPC.ControlGraft.encode(l.graft[f],u.uint32(26).fork()).ldelim();if(l.prune!=null&&l.prune.length)for(var f=0;f<l.prune.length;++f)i.RPC.ControlPrune.encode(l.prune[f],u.uint32(34).fork()).ldelim();return u},c.decode=function(l,u){l instanceof t||(l=t.create(l));for(var f=u===void 0?l.len:l.pos+u,g=new i.RPC.ControlMessage;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:g.ihave&&g.ihave.length||(g.ihave=[]),g.ihave.push(i.RPC.ControlIHave.decode(l,l.uint32()));break;case 2:g.iwant&&g.iwant.length||(g.iwant=[]),g.iwant.push(i.RPC.ControlIWant.decode(l,l.uint32()));break;case 3:g.graft&&g.graft.length||(g.graft=[]),g.graft.push(i.RPC.ControlGraft.decode(l,l.uint32()));break;case 4:g.prune&&g.prune.length||(g.prune=[]),g.prune.push(i.RPC.ControlPrune.decode(l,l.uint32()));break;default:l.skipType(d&7);break}}return g},c.fromObject=function(l){if(l instanceof i.RPC.ControlMessage)return l;var u=new i.RPC.ControlMessage;if(l.ihave){if(!Array.isArray(l.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");u.ihave=[];for(var f=0;f<l.ihave.length;++f){if(typeof l.ihave[f]!="object")throw TypeError(".RPC.ControlMessage.ihave: object expected");u.ihave[f]=i.RPC.ControlIHave.fromObject(l.ihave[f])}}if(l.iwant){if(!Array.isArray(l.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");u.iwant=[];for(var f=0;f<l.iwant.length;++f){if(typeof l.iwant[f]!="object")throw TypeError(".RPC.ControlMessage.iwant: object expected");u.iwant[f]=i.RPC.ControlIWant.fromObject(l.iwant[f])}}if(l.graft){if(!Array.isArray(l.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");u.graft=[];for(var f=0;f<l.graft.length;++f){if(typeof l.graft[f]!="object")throw TypeError(".RPC.ControlMessage.graft: object expected");u.graft[f]=i.RPC.ControlGraft.fromObject(l.graft[f])}}if(l.prune){if(!Array.isArray(l.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");u.prune=[];for(var f=0;f<l.prune.length;++f){if(typeof l.prune[f]!="object")throw TypeError(".RPC.ControlMessage.prune: object expected");u.prune[f]=i.RPC.ControlPrune.fromObject(l.prune[f])}}return u},c.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.ihave=[],f.iwant=[],f.graft=[],f.prune=[]),l.ihave&&l.ihave.length){f.ihave=[];for(var g=0;g<l.ihave.length;++g)f.ihave[g]=i.RPC.ControlIHave.toObject(l.ihave[g],u)}if(l.iwant&&l.iwant.length){f.iwant=[];for(var g=0;g<l.iwant.length;++g)f.iwant[g]=i.RPC.ControlIWant.toObject(l.iwant[g],u)}if(l.graft&&l.graft.length){f.graft=[];for(var g=0;g<l.graft.length;++g)f.graft[g]=i.RPC.ControlGraft.toObject(l.graft[g],u)}if(l.prune&&l.prune.length){f.prune=[];for(var g=0;g<l.prune.length;++g)f.prune[g]=i.RPC.ControlPrune.toObject(l.prune[g],u)}return f},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlIHave=function(){function c(l){if(this.messageIDs=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}c.prototype.topicID=null,c.prototype.messageIDs=s.emptyArray;var h;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(h=["topicID"]),set:s.oneOfSetter(h)}),c.encode=function(u,f){if(f||(f=n.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.messageIDs!=null&&u.messageIDs.length)for(var g=0;g<u.messageIDs.length;++g)f.uint32(18).bytes(u.messageIDs[g]);return f},c.decode=function(u,f){u instanceof t||(u=t.create(u));for(var g=f===void 0?u.len:u.pos+f,d=new i.RPC.ControlIHave;u.pos<g;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.messageIDs&&d.messageIDs.length||(d.messageIDs=[]),d.messageIDs.push(u.bytes());break;default:u.skipType(p&7);break}}return d},c.fromObject=function(u){if(u instanceof i.RPC.ControlIHave)return u;var f=new i.RPC.ControlIHave;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.messageIDs){if(!Array.isArray(u.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");f.messageIDs=[];for(var g=0;g<u.messageIDs.length;++g)typeof u.messageIDs[g]=="string"?s.base64.decode(u.messageIDs[g],f.messageIDs[g]=s.newBuffer(s.base64.length(u.messageIDs[g])),0):u.messageIDs[g].length&&(f.messageIDs[g]=u.messageIDs[g])}return f},c.toObject=function(u,f){f||(f={});var g={};if((f.arrays||f.defaults)&&(g.messageIDs=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(g.topicID=u.topicID,f.oneofs&&(g._topicID="topicID")),u.messageIDs&&u.messageIDs.length){g.messageIDs=[];for(var d=0;d<u.messageIDs.length;++d)g.messageIDs[d]=f.bytes===String?s.base64.encode(u.messageIDs[d],0,u.messageIDs[d].length):f.bytes===Array?Array.prototype.slice.call(u.messageIDs[d]):u.messageIDs[d]}return g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlIWant=function(){function c(h){if(this.messageIDs=[],h)for(var l=Object.keys(h),u=0;u<l.length;++u)h[l[u]]!=null&&(this[l[u]]=h[l[u]])}return c.prototype.messageIDs=s.emptyArray,c.encode=function(l,u){if(u||(u=n.create()),l.messageIDs!=null&&l.messageIDs.length)for(var f=0;f<l.messageIDs.length;++f)u.uint32(10).bytes(l.messageIDs[f]);return u},c.decode=function(l,u){l instanceof t||(l=t.create(l));for(var f=u===void 0?l.len:l.pos+u,g=new i.RPC.ControlIWant;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:g.messageIDs&&g.messageIDs.length||(g.messageIDs=[]),g.messageIDs.push(l.bytes());break;default:l.skipType(d&7);break}}return g},c.fromObject=function(l){if(l instanceof i.RPC.ControlIWant)return l;var u=new i.RPC.ControlIWant;if(l.messageIDs){if(!Array.isArray(l.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");u.messageIDs=[];for(var f=0;f<l.messageIDs.length;++f)typeof l.messageIDs[f]=="string"?s.base64.decode(l.messageIDs[f],u.messageIDs[f]=s.newBuffer(s.base64.length(l.messageIDs[f])),0):l.messageIDs[f].length&&(u.messageIDs[f]=l.messageIDs[f])}return u},c.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.messageIDs=[]),l.messageIDs&&l.messageIDs.length){f.messageIDs=[];for(var g=0;g<l.messageIDs.length;++g)f.messageIDs[g]=u.bytes===String?s.base64.encode(l.messageIDs[g],0,l.messageIDs[g].length):u.bytes===Array?Array.prototype.slice.call(l.messageIDs[g]):l.messageIDs[g]}return f},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlGraft=function(){function c(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}c.prototype.topicID=null;var h;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(h=["topicID"]),set:s.oneOfSetter(h)}),c.encode=function(u,f){return f||(f=n.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),f},c.decode=function(u,f){u instanceof t||(u=t.create(u));for(var g=f===void 0?u.len:u.pos+f,d=new i.RPC.ControlGraft;u.pos<g;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;default:u.skipType(p&7);break}}return d},c.fromObject=function(u){if(u instanceof i.RPC.ControlGraft)return u;var f=new i.RPC.ControlGraft;return u.topicID!=null&&(f.topicID=String(u.topicID)),f},c.toObject=function(u,f){f||(f={});var g={};return u.topicID!=null&&u.hasOwnProperty("topicID")&&(g.topicID=u.topicID,f.oneofs&&(g._topicID="topicID")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlPrune=function(){function c(l){if(this.peers=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}c.prototype.topicID=null,c.prototype.peers=s.emptyArray,c.prototype.backoff=null;var h;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(h=["topicID"]),set:s.oneOfSetter(h)}),Object.defineProperty(c.prototype,"_backoff",{get:s.oneOfGetter(h=["backoff"]),set:s.oneOfSetter(h)}),c.encode=function(u,f){if(f||(f=n.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.peers!=null&&u.peers.length)for(var g=0;g<u.peers.length;++g)i.RPC.PeerInfo.encode(u.peers[g],f.uint32(18).fork()).ldelim();return u.backoff!=null&&Object.hasOwnProperty.call(u,"backoff")&&f.uint32(24).uint64(u.backoff),f},c.decode=function(u,f){u instanceof t||(u=t.create(u));for(var g=f===void 0?u.len:u.pos+f,d=new i.RPC.ControlPrune;u.pos<g;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.peers&&d.peers.length||(d.peers=[]),d.peers.push(i.RPC.PeerInfo.decode(u,u.uint32()));break;case 3:d.backoff=u.uint64();break;default:u.skipType(p&7);break}}return d},c.fromObject=function(u){if(u instanceof i.RPC.ControlPrune)return u;var f=new i.RPC.ControlPrune;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.peers){if(!Array.isArray(u.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");f.peers=[];for(var g=0;g<u.peers.length;++g){if(typeof u.peers[g]!="object")throw TypeError(".RPC.ControlPrune.peers: object expected");f.peers[g]=i.RPC.PeerInfo.fromObject(u.peers[g])}}return u.backoff!=null&&(s.Long?(f.backoff=s.Long.fromValue(u.backoff)).unsigned=!0:typeof u.backoff=="string"?f.backoff=parseInt(u.backoff,10):typeof u.backoff=="number"?f.backoff=u.backoff:typeof u.backoff=="object"&&(f.backoff=new s.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0))),f},c.toObject=function(u,f){f||(f={});var g={};if((f.arrays||f.defaults)&&(g.peers=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(g.topicID=u.topicID,f.oneofs&&(g._topicID="topicID")),u.peers&&u.peers.length){g.peers=[];for(var d=0;d<u.peers.length;++d)g.peers[d]=i.RPC.PeerInfo.toObject(u.peers[d],f)}return u.backoff!=null&&u.hasOwnProperty("backoff")&&(typeof u.backoff=="number"?g.backoff=f.longs===String?String(u.backoff):u.backoff:g.backoff=f.longs===String?s.Long.prototype.toString.call(u.backoff):f.longs===Number?new s.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0):u.backoff,f.oneofs&&(g._backoff="backoff")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.PeerInfo=function(){function c(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}c.prototype.peerID=null,c.prototype.signedPeerRecord=null;var h;return Object.defineProperty(c.prototype,"_peerID",{get:s.oneOfGetter(h=["peerID"]),set:s.oneOfSetter(h)}),Object.defineProperty(c.prototype,"_signedPeerRecord",{get:s.oneOfGetter(h=["signedPeerRecord"]),set:s.oneOfSetter(h)}),c.encode=function(u,f){return f||(f=n.create()),u.peerID!=null&&Object.hasOwnProperty.call(u,"peerID")&&f.uint32(10).bytes(u.peerID),u.signedPeerRecord!=null&&Object.hasOwnProperty.call(u,"signedPeerRecord")&&f.uint32(18).bytes(u.signedPeerRecord),f},c.decode=function(u,f){u instanceof t||(u=t.create(u));for(var g=f===void 0?u.len:u.pos+f,d=new i.RPC.PeerInfo;u.pos<g;){var p=u.uint32();switch(p>>>3){case 1:d.peerID=u.bytes();break;case 2:d.signedPeerRecord=u.bytes();break;default:u.skipType(p&7);break}}return d},c.fromObject=function(u){if(u instanceof i.RPC.PeerInfo)return u;var f=new i.RPC.PeerInfo;return u.peerID!=null&&(typeof u.peerID=="string"?s.base64.decode(u.peerID,f.peerID=s.newBuffer(s.base64.length(u.peerID)),0):u.peerID.length&&(f.peerID=u.peerID)),u.signedPeerRecord!=null&&(typeof u.signedPeerRecord=="string"?s.base64.decode(u.signedPeerRecord,f.signedPeerRecord=s.newBuffer(s.base64.length(u.signedPeerRecord)),0):u.signedPeerRecord.length&&(f.signedPeerRecord=u.signedPeerRecord)),f},c.toObject=function(u,f){f||(f={});var g={};return u.peerID!=null&&u.hasOwnProperty("peerID")&&(g.peerID=f.bytes===String?s.base64.encode(u.peerID,0,u.peerID.length):f.bytes===Array?Array.prototype.slice.call(u.peerID):u.peerID,f.oneofs&&(g._peerID="peerID")),u.signedPeerRecord!=null&&u.hasOwnProperty("signedPeerRecord")&&(g.signedPeerRecord=f.bytes===String?s.base64.encode(u.signedPeerRecord,0,u.signedPeerRecord.length):f.bytes===Array?Array.prototype.slice.call(u.signedPeerRecord):u.signedPeerRecord,f.oneofs&&(g._signedPeerRecord="signedPeerRecord")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o}(),i})})(_G);const DG=$0,{RPC:F2}=DG,$c=1e3,V2=60*$c,k4="/floodsub/1.0.0",D4="/meshsub/1.0.0",x9="/meshsub/1.1.0",PG=6,OG=4,NG=12,xG=4,$G=2,LG=5,MG=3,UG=6,BG=.25,zG=3,P4=100,FG=$c,VG=V2,KG=16,jG=V2,HG=15,qG=300,GG=$c,WG=60,YG=2,QG=10*$c,Vi=5e3,XG=10,JG=3*$c,ZG=2*V2,eW=120*1e3,tW="ERR_TOPIC_VALIDATOR_REJECT",rW="ERR_TOPIC_VALIDATOR_IGNORE",nW=0,sW=128,iW=1e3,oW=1e3;function En(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function aW(r){return B(r,"base64")}const du="StrictSign",K2="StrictNoSign";var Nn;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(Nn||(Nn={}));var O4;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(O4||(O4={}));var vo;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(vo||(vo={}));var Mr;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Mr||(Mr={}));var Gt;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(Gt||(Gt={}));var Dr;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(Dr||(Dr={}));function N4(r){switch(r){case Nn.Ignore:return Mr.Ignore;case Nn.Reject:return Mr.Reject}}async function cW(r,e){switch(r){case du:{if(!e)throw Error("Must provide PeerId");if(e.privateKey==null)throw Error("Cannot sign message, no private key present");if(e.publicKey==null)throw Error("Cannot sign message, no public key present");const t=await Qs(e.privateKey);return{type:vo.Signing,author:e,key:e.publicKey,privateKey:t}}case K2:return{type:vo.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}const Re="ERR_INVALID_PEER_SCORE_PARAMS",lW={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},hW={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function uW(r={}){return{...lW,...r,topics:r.topics?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=dW(n),e),{}):{}}}function dW(r={}){return{...hW,...r}}function fW(r){for(const[e,t]of Object.entries(r.topics))try{pW(t)}catch(n){throw new ee(`invalid score parameters for topic ${e}: ${n.message}`,Re)}if(r.topicScoreCap<0)throw new ee("invalid topic score cap; must be positive (or 0 for no cap)",Re);if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new ee("missing application specific score function",Re);if(r.IPColocationFactorWeight>0)throw new ee("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",Re);if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new ee("invalid IPColocationFactorThreshold; must be at least 1",Re);if(r.behaviourPenaltyWeight>0)throw new ee("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",Re);if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new ee("invalid BehaviourPenaltyDecay; must be between 0 and 1",Re);if(r.decayInterval<1e3)throw new ee("invalid DecayInterval; must be at least 1s",Re);if(r.decayToZero<=0||r.decayToZero>=1)throw new ee("invalid DecayToZero; must be between 0 and 1",Re)}function pW(r){if(r.topicWeight<0)throw new ee("invalid topic weight; must be >= 0",Re);if(r.timeInMeshQuantum===0)throw new ee("invalid TimeInMeshQuantum; must be non zero",Re);if(r.timeInMeshWeight<0)throw new ee("invalid TimeInMeshWeight; must be positive (or 0 to disable)",Re);if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new ee("invalid TimeInMeshQuantum; must be positive",Re);if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new ee("invalid TimeInMeshCap; must be positive",Re);if(r.firstMessageDeliveriesWeight<0)throw new ee("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",Re);if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new ee("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",Re);if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new ee("invalid FirstMessageDeliveriesCap; must be positive",Re);if(r.meshMessageDeliveriesWeight>0)throw new ee("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",Re);if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new ee("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",Re);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new ee("invalid MeshMessageDeliveriesCap; must be positive",Re);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new ee("invalid MeshMessageDeliveriesThreshold; must be positive",Re);if(r.meshMessageDeliveriesWindow<0)throw new ee("invalid MeshMessageDeliveriesWindow; must be non-negative",Re);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new ee("invalid MeshMessageDeliveriesActivation; must be at least 1s",Re);if(r.meshFailurePenaltyWeight>0)throw new ee("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",Re);if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new ee("invalid MeshFailurePenaltyDecay; must be between 0 and 1",Re);if(r.invalidMessageDeliveriesWeight>0)throw new ee("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",Re);if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new ee("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",Re)}const gW={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function yW(r={}){return{...gW,...r}}function wW(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let h=0;if(a.inMesh){let g=a.meshTime/c.timeInMeshQuantum;g>c.timeInMeshCap&&(g=c.timeInMeshCap),h+=g*c.timeInMeshWeight}let l=a.firstMessageDeliveries;if(l>c.firstMessageDeliveriesCap&&(l=c.firstMessageDeliveriesCap),h+=l*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const g=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,d=g*g;h+=d*c.meshMessageDeliveriesWeight}const u=a.meshFailurePenalty;h+=u*c.meshFailurePenaltyWeight;const f=a.invalidMessageDeliveries*a.invalidMessageDeliveries;h+=f*c.invalidMessageDeliveriesWeight,s+=h*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);const i=t.appSpecificScore(r);if(s+=i*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a?a.size:0;if(c>t.IPColocationFactorThreshold){const h=c-t.IPColocationFactorThreshold,l=h*h;s+=l*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;s+=a*t.behaviourPenaltyWeight}return s}function Ge(r,t){var t=t||{};this._head=0,this._tail=0,this._capacity=t.capacity,this._capacityMask=3,this._list=new Array(4),Array.isArray(r)&&this._fromArray(r)}Ge.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};Ge.prototype.get=function(e){return this.peekAt(e)};Ge.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};Ge.prototype.peekFront=function(){return this.peek()};Ge.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(Ge.prototype,"length",{get:function(){return this.size()}});Ge.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ge.prototype.unshift=function(e){if(e===void 0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ge.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};Ge.prototype.push=function(e){if(e===void 0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ge.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};Ge.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var i=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};Ge.prototype.remove=function(e,t){var n=e,s,i=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=o)return s=this.toArray(),this.clear(),s;n+t>o&&(t=o-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;i>0;)this._list[n=n-1+a&this._capacityMask]=void 0,i--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;i>0;)this._list[n=n+1+a&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};Ge.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var i,o,a,c=arguments.length,h=this._list.length,l=2;if(!s||n<s/2){for(o=new Array(n),i=0;i<n;i++)o[i]=this._list[this._head+i&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+h&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+h&this._capacityMask);c>l;)this.unshift(arguments[--c]);for(i=n;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(n+t));var u=o.length;for(i=0;i<u;i++)o[i]=this._list[this._head+n+t+i&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+h&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-u+h&this._capacityMask);l<c;)this.push(arguments[l++]);for(i=0;i<u;i++)this.push(o[i])}return a}else return this.remove(n,t)}};Ge.prototype.clear=function(){this._head=0,this._tail=0};Ge.prototype.isEmpty=function(){return this._head===this._tail};Ge.prototype.toArray=function(){return this._copyArray(!1)};Ge.prototype._fromArray=function(e){for(var t=0;t<e.length;t++)this.push(e[t])};Ge.prototype._copyArray=function(e){var t=[],n=this._list,s=n.length,i;if(e||this._head>this._tail){for(i=this._head;i<s;i++)t.push(n[i]);for(i=0;i<this._tail;i++)t.push(n[i])}else for(i=this._head;i<this._tail;i++)t.push(n[i]);return t};Ge.prototype._growArray=function(){this._head&&(this._list=this._copyArray(!0),this._head=0),this._tail=this._list.length,this._list.length<<=1,this._capacityMask=this._capacityMask<<1|1};Ge.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};var mW=Ge,Wt;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(Wt||(Wt={}));class bW{constructor(){this.records=new Map,this.queue=new mW}ensureRecord(e){let t=this.records.get(e);if(t)return t;t={status:Wt.unknown,firstSeen:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+eW};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}function L0(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function EW(r,e){return L0(r,e,()=>!0)}class _W extends Map{constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}}const Ki=P("libp2p:gossipsub:score");class vW{constructor(e,t,n){this.params=e,this.metrics=t,this.peerStats=new Map,this.peerIPs=new _W(()=>new Set),this.scoreCache=new Map,this.deliveryRecords=new bW,fW(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=n.computeScore??wW}get size(){return this.peerStats.size}start(){if(this._backgroundInterval){Ki("Peer score already running");return}this._backgroundInterval=setInterval(()=>this.background(),this.params.decayInterval),Ki("started")}stop(){if(!this._backgroundInterval){Ki("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),Ki("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(!t)return 0;const n=Date.now(),s=this.scoreCache.get(e);if(s&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(e,{score:i,cacheUntil:o}),i}addPenalty(e,t,n){const s=this.peerStats.get(e);s&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n&&n.knownIPs.delete(t);const s=this.peerIPs.get(t);s&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);s&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);if(s){const i=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const s=this.deliveryRecords.ensureRecord(t),i=Date.now();if(s.status!==Wt.unknown){Ki("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-s.firstSeen,Wt[s.status]);return}s.status=Wt.valid,s.validated=i,s.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case Mr.Error:this.markInvalidMessageDelivery(e,n);return;case Mr.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status!==Wt.unknown){Ki("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeen,Wt[i.status]);return}if(s===Mr.Ignore){i.status=Wt.ignored,i.peers.clear();return}i.status=Wt.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),i.peers.clear()}duplicateMessage(e,t,n){const s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case Wt.unknown:s.peers.add(e);break;case Wt.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case Wt.invalid:this.markInvalidMessageDelivery(e,n);break;case Wt.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);s&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);if(s){let i=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const s=this.peerStats.get(e);if(s){const i=n!==void 0?Date.now():0,o=this.getPtopicStats(s,t);if(o&&o.inMesh){const a=this.params.topics[t];if(n!==void 0){const h=i-n,l=h>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,h,l),l)return}const c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const s=this.peerIPs.get(n);s&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}class SW{constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.promises=new Map,this.requestMsByMsg=new Map,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),s=t[n],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o||(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size||this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case Mr.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}class Vf{constructor(e){this.entries=new Map,this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var x4;(function(r){r.forward="forward",r.publish="publish"})(x4||(x4={}));var vs;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(vs||(vs={}));var Ji;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Unsub="unsubscribed",r.Excess="excess"})(Ji||(Ji={}));var Ba;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(Ba||(Ba={}));var za;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(za||(za={}));var Zi;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(Zi||(Zi={}));function RW(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEvents:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_total",help:"Number of times we include peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),meshPeerChurnEvents:r.gauge({name:"gossipsub_peer_churn_events_total",help:"Number of times we remove peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),asyncValidationResult:r.gauge({name:"gossipsub_async_validation_result_total",help:"Message validation result for each topic",labelNames:["topic","acceptance"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeers:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),msgPublishPeersByGroup:r.gauge({name:"gossipsub_msg_publish_peers_by_group",help:"Total count of peers (by group) that we publish a msg to",labelNames:["topic","peerGroup"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedStatus:r.gauge({name:"gossipsub_msg_received_status_total",help:"Tracks distribution of recv msgs by duplicate, invalid, valid",labelNames:["topic","status"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["topic","error"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,1*t.maxMeshMessageDeliveriesWindowSec,2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores",labelNames:["topic","p"]}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,1*t.behaviourPenaltyThreshold,2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,1*t.gossipPromiseExpireSec,2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,i){const o=this.toTopic(n);this.meshPeerInclusionEvents.inc({topic:o,reason:s},i)},onRemoveFromMesh(n,s,i){const o=this.toTopic(n);this.meshPeerChurnEvents.inc({topic:o,reason:s},i)},onReportValidationMcacheHit(n){this.asyncValidationMcacheHit.inc({hit:n?"hit":"miss"})},onReportValidation(n,s){const i=this.toTopic(n);this.asyncValidationResult.inc({topic:i,acceptance:s})},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,i){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(n,s){for(const[i,o]of n){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){const i=this.toTopic(n);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(n,s,i,o){const a=this.toTopic(n);this.msgPublishCount.inc({topic:a},1),this.msgPublishBytes.inc({topic:a},i*o),this.msgPublishPeers.inc({topic:a},i),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"direct"},s.direct),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"floodsub"},s.floodsub),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"mesh"},s.mesh),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"fanout"},s.fanout)},onMsgRecvPreValidation(n){const s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvResult(n,s){const i=this.toTopic(n);this.msgReceivedStatus.inc({topic:i,status:s})},onMsgRecvInvalid(n,s){const i=this.toTopic(n),o=s.reason===Mr.Error?s.error:s.reason;this.msgReceivedInvalid.inc({topic:i,error:o},1)},onDuplicateMsgDelivery(n,s,i){if(this.duplicateMsgDeliveryDelay.observe(s/1e3),i){const o=this.toTopic(n);this.duplicateMsgLateDelivery.inc({topic:o},1)}},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages&&this.rpcRecvMessage.inc(n.messages.length),n.control&&(this.rpcRecvControl.inc(1),n.control.ihave&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages&&this.rpcSentMessage.inc(n.messages.length),n.control){const i=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),(i>0||o>0||a>0||c>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let i=0,o=0,a=0,c=0;for(const h of n)h>=s.graylistThreshold&&i++,h>=s.publishThreshold&&o++,h>=s.gossipThreshold&&a++,h>=0&&c++;this.peersByScoreThreshold.set({threshold:Zi.graylist},i),this.peersByScoreThreshold.set({threshold:Zi.publish},o),this.peersByScoreThreshold.set({threshold:Zi.gossip},a),this.peersByScoreThreshold.set({threshold:Zi.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[s,i]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){const i=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let h=i.get(c);h||(h=new Set,i.set(c,h)),o.forEach(l=>h?.add(l))});for(const[o,a]of i){const c=[];a.forEach(h=>{c.push(s.get(h)??0)}),this.scorePerMesh.set({topic:o},c)}}}}const $9=L("libp2p-pubsub:");async function AW(r,e,t,n){switch(r.type){case vo.Signing:{const s={from:r.author.toBytes(),data:n,seqno:Yu(8),topic:e,signature:void 0,key:void 0},i=qe([$9,F2.Message.encode(s).finish()]);s.signature=await r.privateKey.sign(i),s.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${B(s.seqno,"base16")}`),topic:e,signature:s.signature,key:s.key};return{raw:s,msg:o}}case vo.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}}}}async function IW(r,e){switch(r){case K2:return e.signature!=null?{valid:!1,error:Gt.SignaturePresent}:e.seqno!=null?{valid:!1,error:Gt.SeqnoPresent}:e.key!=null?{valid:!1,error:Gt.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case du:{if(e.seqno==null)return{valid:!1,error:Gt.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:Gt.InvalidSeqno};if(e.signature==null)return{valid:!1,error:Gt.InvalidSignature};if(e.from==null)return{valid:!1,error:Gt.InvalidPeerId};let t;try{t=Fr(e.from)}catch{return{valid:!1,error:Gt.InvalidPeerId}}let n;if(e.key){if(n=mi(e.key),t.publicKey!==void 0&&!Ye(n.bytes,t.publicKey))return{valid:!1,error:Gt.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:Gt.InvalidPeerId};n=mi(t.publicKey)}const s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},i=qe([$9,F2.Message.encode(s).finish()]);return await n.verify(i,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${B(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key??vp(n)}}:{valid:!1,error:Gt.InvalidSignature}}}}var CW=L9,$4=128,TW=127,kW=~TW,DW=Math.pow(2,31);function L9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=DW;)e[t++]=r&255|$4,r/=128;for(;r&kW;)e[t++]=r&255|$4,r>>>=7;return e[t]=r|0,L9.bytes=t-n+1,e}var PW=M0,OW=128,L4=127;function M0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw M0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&L4)<<s:(o&L4)*Math.pow(2,s),s+=7}while(o>=OW);return M0.bytes=i-n,t}var NW=Math.pow(2,7),xW=Math.pow(2,14),$W=Math.pow(2,21),LW=Math.pow(2,28),MW=Math.pow(2,35),UW=Math.pow(2,42),BW=Math.pow(2,49),zW=Math.pow(2,56),FW=Math.pow(2,63),VW=function(r){return r<NW?1:r<xW?2:r<$W?3:r<LW?4:r<MW?5:r<UW?6:r<BW?7:r<zW?8:r<FW?9:10},KW={encode:CW,decode:PW,encodingLength:VW},M9=KW;const M4=(r,e,t=0)=>(M9.encode(r,e,t),e),U4=r=>M9.encodingLength(r),B4=(r,e)=>{const t=e.byteLength,n=U4(r),s=n+U4(t),i=new Uint8Array(s+t);return M4(r,i,0),M4(t,i,n),i.set(e,s),new jW(r,t,e,i)};let jW=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const U9=({name:r,code:e,encode:t})=>new HW(r,e,t);let HW=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?B4(this.code,t):t.then(n=>B4(this.code,n))}else throw Error("Unknown type, must be binary type")}};const B9=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),qW=U9({name:"sha2-256",code:18,encode:B9("SHA-256")});U9({name:"sha2-512",code:19,encode:B9("SHA-512")});const GW=(r,e)=>{const t=L(e.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n};function WW(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return GW(r.from.toBytes(),r.sequenceNumber)}async function YW(r){return await qW.encode(r.data)}function QW(r,e,t,n,s){let i=0;const o=new Map;if(Object.entries(e.topics).forEach(([f,g])=>{const d=s.get(f)??"unknown",p=t.topics[f];if(p===void 0)return;let w=o.get(d);w||(w={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(d,w));let y=0,_=0,m=0,b=0,S=0;if(g.inMesh){const C=Math.max(g.meshTime/p.timeInMeshQuantum,p.timeInMeshCap);y+=C*p.timeInMeshWeight}let A=g.firstMessageDeliveries;if(A>p.firstMessageDeliveriesCap&&(A=p.firstMessageDeliveriesCap),_+=A*p.firstMessageDeliveriesWeight,g.meshMessageDeliveriesActive&&g.meshMessageDeliveries<p.meshMessageDeliveriesThreshold){const C=p.meshMessageDeliveriesThreshold-g.meshMessageDeliveries,D=C*C;m+=D*p.meshMessageDeliveriesWeight}const E=g.meshFailurePenalty;b+=E*p.meshFailurePenaltyWeight;const I=g.invalidMessageDeliveries*g.invalidMessageDeliveries;S+=I*p.invalidMessageDeliveriesWeight,i+=(y+_+m+b+S)*p.topicWeight,w.p1w+=y,w.p2w+=_,w.p3w+=m,w.p3bw+=b,w.p4w+=S}),t.topicScoreCap>0&&i>t.topicScoreCap){i=t.topicScoreCap;const f=t.topicScoreCap/i;for(const g of o.values())g.p1w*=f,g.p2w*=f,g.p3w*=f,g.p3bw*=f,g.p4w*=f}let a=0,c=0,h=0;const l=t.appSpecificScore(r);a+=l*t.appSpecificWeight,e.knownIPs.forEach(f=>{if(t.IPColocationFactorWhitelist.has(f))return;const g=n.get(f),d=g?g.size:0;if(d>t.IPColocationFactorThreshold){const p=d-t.IPColocationFactorThreshold,w=p*p;c+=w*t.IPColocationFactorWeight}});const u=e.behaviourPenalty*e.behaviourPenalty;return h+=u*t.behaviourPenaltyWeight,i+=a+c+h,{byTopic:o,p5w:a,p6w:c,p7w:h,score:i}}function XW(r,e,t,n,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a){const c=QW(o,a,t,n,s);for(const[h,l]of c.byTopic){let u=i.byTopic.get(h);u||(u={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(h,u)),u.p1w.push(l.p1w),u.p2w.push(l.p2w),u.p3w.push(l.p3w),u.p3bw.push(l.p3bw),u.p4w.push(l.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}function JW(r){return globalThis?.Buffer?.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}const Ad=r=>{const e=Fs.encodingLength(r),t=JW(e);return Fs.encode(r,t),Ad.bytes=e,t};Ad.bytes=0;function ar(r){r=r??{};const e=r.lengthEncoder??Ad;return async function*(n){for await(const s of n){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}}}ar.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??Ad;return new ke(t(r.byteLength),r)};const ZW=8,eY=1024*1024*4;var ai;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(ai||(ai={}));const j2=r=>{const e=Fs.decode(r);return j2.bytes=Fs.encodingLength(e),e};j2.bytes=0;function er(r){return async function*(t){const n=new ke;let s=ai.LENGTH,i=-1;const o=r?.lengthDecoder??j2,a=r?.maxLengthLength??ZW,c=r?.maxDataLength??eY;for await(const h of t)for(n.append(h);n.byteLength>0;){if(s===ai.LENGTH)try{if(i=o(n),i<0)throw v(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>c)throw v(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const l=o.bytes;n.consume(l),r?.onLength!=null&&r.onLength(i),s=ai.DATA}catch(l){if(l instanceof RangeError){if(n.byteLength>a)throw v(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(s===ai.DATA){if(n.byteLength<i)break;const l=n.sublist(0,i);n.consume(i),r?.onData!=null&&r.onData(l),yield l,s=ai.LENGTH}}if(n.byteLength>0)throw v(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}er.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return er({...e??{},onLength:i=>{t=i}})(n)};class tY{constructor(e,t,n){this.rawStream=e,this.pushable=Bt({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,ie(Zt(this.pushable,this.closeController.signal,{returnOnAbort:!0}),ar(),this.rawStream).catch(t)}get protocol(){return this.rawStream.stat.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}close(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}}class rY{constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.source=Zt(ie(this.rawStream,er(t)),this.closeController.signal,{returnOnAbort:!0})}close(){this.closeController.abort(),this.rawStream.close()}}var nY=N9();const sY=Wu(nY),iY={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function oY(r,e){e={...e};const t=sY.Reader.create(r),n=r.length,s=n===void 0?t.len:t.pos+n,i={};for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.subscriptions&&i.subscriptions.length||(i.subscriptions=[]),i.subscriptions.length<e.maxSubscriptions?i.subscriptions.push(aY(t,t.uint32())):t.skipType(o&7);break;case 2:i.messages&&i.messages.length||(i.messages=[]),i.messages.length<e.maxMessages?i.messages.push(cY(t,t.uint32())):t.skipType(o&7);break;case 3:i.control=lY(t,t.uint32(),e);break;default:t.skipType(o&7);break}}return i}function aY(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.subscribe=r.bool();break;case 2:n.topic=r.string();break;default:r.skipType(s&7);break}}return n}function cY(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.from=r.bytes();break;case 2:n.data=r.bytes();break;case 3:n.seqno=r.bytes();break;case 4:n.topic=r.string();break;case 5:n.signature=r.bytes();break;case 6:n.key=r.bytes();break;default:r.skipType(s&7);break}}if(!n.topic)throw Error("missing required 'topic'");return n}function lY(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.ihave&&s.ihave.length||(s.ihave=[]),s.ihave.length<t.maxControlMessages?s.ihave.push(hY(r,r.uint32(),t)):r.skipType(i&7);break;case 2:s.iwant&&s.iwant.length||(s.iwant=[]),s.iwant.length<t.maxControlMessages?s.iwant.push(uY(r,r.uint32(),t)):r.skipType(i&7);break;case 3:s.graft&&s.graft.length||(s.graft=[]),s.graft.length<t.maxControlMessages?s.graft.push(dY(r,r.uint32())):r.skipType(i&7);break;case 4:s.prune&&s.prune.length||(s.prune=[]),s.prune.length<t.maxControlMessages?s.prune.push(fY(r,r.uint32(),t)):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function hY(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.topicID=r.string();break;case 2:s.messageIDs&&s.messageIDs.length||(s.messageIDs=[]),t.maxIhaveMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function uY(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.messageIDs&&s.messageIDs.length||(s.messageIDs=[]),t.maxIwantMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function dY(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.topicID=r.string();break;default:r.skipType(s&7);break}}return n}function fY(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.topicID=r.string();break;case 2:s.peers&&s.peers.length||(s.peers=[]),t.maxPeerInfos-- >0?s.peers.push(pY(r,r.uint32())):r.skipType(i&7);break;case 3:s.backoff=r.uint64();break;default:r.skipType(i&7);break}}return s}function pY(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.peerID=r.bytes();break;case 2:n.signedPeerRecord=r.bytes();break;default:r.skipType(s&7);break}}return n}var fu;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(fu||(fu={}));function gY(r){for(const e of r.tuples())switch(e[0]){case fu.ip4:case fu.ip6:return Av(e[0],e[1])}return null}var rr;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(rr||(rr={}));class z9 extends Fe{constructor(e,t={}){super(),this.multicodecs=[x9,D4],this.peers=new Set,this.streamsInbound=new Map,this.streamsOutbound=new Map,this.outboundInflightQueue=Bt({objectMode:!0}),this.direct=new Set,this.floodsubPeers=new Set,this.acceptFromWhitelist=new Map,this.topics=new Map,this.subscriptions=new Set,this.mesh=new Map,this.fanout=new Map,this.fanoutLastpub=new Map,this.gossip=new Map,this.control=new Map,this.peerhave=new Map,this.iasked=new Map,this.backoff=new Map,this.outbound=new Map,this.topicValidators=new Map,this.heartbeatTicks=0,this.directPeerInitial=null,this.status={code:rr.stopped},this.heartbeatTimer=null,this.runHeartbeat=()=>{const s=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(i=>{this.log("Error running heartbeat",i)}).finally(()=>{if(s?.(),this.status.code===rr.started){clearTimeout(this.status.heartbeatTimeout);let i=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;i<this.opts.heartbeatInterval*.25&&(i+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,i)}})};const n={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:PG,Dlo:OG,Dhi:NG,Dscore:xG,Dout:$G,Dlazy:UG,heartbeatInterval:FG,fanoutTTL:VG,mcacheLength:LG,mcacheGossip:MG,seenTTL:ZG,gossipsubIWantFollowupMs:JG,prunePeers:KG,pruneBackoff:jG,graftFloodThreshold:QG,opportunisticGraftPeers:YG,opportunisticGraftTicks:WG,directConnectTicks:qG,...t,scoreParams:uW(t.scoreParams),scoreThresholds:yW(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??iY,this.globalSignaturePolicy=n.globalSignaturePolicy??du,n.fallbackToFloodsub&&this.multicodecs.push(k4),this.log=P(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(s=>s.id.toString())),this.seenCache=new Vf({validityMs:n.seenTTL}),this.publishedMessageIds=new Vf({validityMs:n.seenTTL}),t.msgIdFn)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case du:this.msgIdFn=WW;break;case K2:this.msgIdFn=YW;break}if(t.fastMsgIdFn&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new Vf({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??aW,this.mcache=t.messageCache||new EG(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform&&(this.dataTransform=t.dataTransform),t.metricsRegister){if(!t.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const s=Math.max(...Object.values(n.scoreParams.topics).map(o=>o.meshMessageDeliveriesWindow),oW),i=RW(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});i.mcacheSize.addCollect(()=>this.onScrapeMetrics(i));for(const o of this.multicodecs)i.protocolsEnabled.set({protocol:o},1);this.metrics=i}else this.metrics=null;this.gossipTracer=new SW(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new vW(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.allowedTopics=n.allowedTopics?new Set(n.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>Z(e))}isStarted(){return this.status.code===rr.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await cW(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=Bt({objectMode:!0}),ie(this.outboundInflightQueue,async i=>{for await(const{peerId:o,connection:a}of i)await this.createOutboundStream(o,a)}).catch(i=>this.log.error("outbound inflight queue error",i)),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.peerStore.addressBook.add(i.id,i.addrs)}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(i=>e.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams})));const t=z2({onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)}),n=await Promise.all(this.multicodecs.map(i=>e.register(i,t))),s=setTimeout(this.runHeartbeat,P4);this.status={code:rr.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+P4},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>await this.connect(i)))}).catch(i=>{this.log(i)})},GG),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==rr.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:rr.stopped};const t=this.components.registrar;e.forEach(n=>t.unregister(n)),this.outboundInflightQueue.end();for(const n of this.streamsOutbound.values())n.close();this.streamsOutbound.clear();for(const n of this.streamsInbound.values())n.close();this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const n=t.remotePeer;this.addPeer(n,t.stat.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.stat.status}),!(!this.isStarted()||t.stat.status!=="OPEN")&&(this.addPeer(e,t.stat.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{const s=new tY(await t.newStream(this.multicodecs),o=>this.log.error("outbound pipe error",o),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);const i=s.protocol;i===k4&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}async createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close()),this.log("create inbound stream %s",n);const i=new rY(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch(o=>this.log(o))}addPeer(e,t,n){const s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.add(s),this.score.addPeer(s);const i=gY(n);i!==null?this.score.addIP(s,i):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,t==="outbound")}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close(),s?.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const i of this.topics.values())i.delete(t);for(const[i,o]of this.mesh)o.delete(t)===!0&&this.metrics?.onRemoveFromMesh(i,Ji.Dc,1);for(const i of this.fanout.values())i.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===rr.started}getMeshPeers(e){const t=this.mesh.get(e);return t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t?Array.from(t):[]).map(n=>Z(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await ie(t,async n=>{for await(const s of n)try{const i=s.subarray(),o=oY(i,this.decodeRpcLimits);this.metrics?.onRpcRecv(o,i.length),this.opts.awaitRpcHandler?await this.handleReceivedRpc(e,o):this.handleReceivedRpc(e,o).catch(a=>this.log(a))}catch(i){this.log(i)}})}catch(n){this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}if(this.log("rpc from %p",e),t.subscriptions&&t.subscriptions.length>0){const n=[];t.subscriptions.forEach(s=>{const i=s.topic,o=s.subscribe===!0;if(i!=null){if(this.allowedTopics&&!this.allowedTopics.has(i))return;this.handleReceivedSubscription(e,i,o),n.push({topic:i,subscribe:o})}}),this.dispatchEvent(new F("subscription-change",{detail:{peerId:e,subscriptions:n}}))}if(t.messages)for(const n of t.messages){if(this.allowedTopics&&!this.allowedTopics.has(n.topic))continue;const s=this.handleReceivedMessage(e,n).catch(i=>this.log(i));this.opts.awaitRpcMessageHandler&&await s}t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);s==null&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const n=await this.validateReceivedMessage(e,t);switch(this.metrics?.onMsgRecvResult(t.topic,n.code),n.code){case Dr.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case Dr.invalid:if(n.msgIdStr){const s=n.msgIdStr;this.score.rejectMessage(e.toString(),s,t.topic,n.reason),this.gossipTracer.rejectMessage(s,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case Dr.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new F("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new F("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString())}}async validateReceivedMessage(e,t){const n=this.fastMsgIdFn?.(t),s=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(s)return{code:Dr.duplicate,msgIdStr:s};const i=await IW(this.globalSignaturePolicy,t);if(!i.valid)return{code:Dr.invalid,reason:Mr.Error,error:i.error};const o=i.message;try{this.dataTransform&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(u){return this.log("Invalid message, transform failed",u),{code:Dr.invalid,reason:Mr.Error,error:Gt.TransformFailed}}const a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),h={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:Dr.duplicate,msgIdStr:c};this.seenCache.put(c);const l=this.topicValidators.get(t.topic);if(l!=null){let u;try{u=await l(e,o)}catch(f){const g=f.code;g===rW&&(u=Nn.Ignore),g===tW?u=Nn.Reject:u=Nn.Ignore}if(u!==Nn.Accept)return{code:Dr.invalid,reason:N4(u),msgIdStr:c}}return{code:Dr.valid,messageId:h,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n}))})}async handleControlMessage(e,t){if(t===void 0)return;const n=t.ihave?this.handleIHave(e,t.ihave):[],s=t.iwant?this.handleIWant(e,t.iwant):[],i=t.graft?await this.handleGraft(e,t.graft):[];t.prune&&await this.handlePrune(e,t.prune),!(!n.length&&!s.length&&!i.length)&&this.sendRpc(e,{messages:s,control:{iwant:n,prune:i}})}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n&&n.messagesAccepted<sW&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const s=this.score.score(e);return s>=nW?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+iW}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:za.LowScore}),[];const s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>XG)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:za.MaxIhave}),[];const i=this.iasked.get(e)??0;if(i>=Vi)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:za.MaxIasked}),[];const o=new Map;if(t.forEach(({topicID:h,messageIDs:l})=>{if(!h||!l||!this.mesh.has(h))return;let u=0;l.forEach(f=>{const g=this.msgIdToStrFn(f);this.seenCache.has(g)||(o.set(g,f),u++)}),this.metrics?.onIhaveRcv(h,l.length,u)}),!o.size)return[];let a=o.size;a+i>Vi&&(a=Vi-i),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return En(c),c=c.slice(0,a),this.iasked.set(e,i+a),this.gossipTracer.addPromise(e,c),[{messageIDs:c}]}handleIWant(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];const s=new Map,i=new Map;let o=0;return t.forEach(({messageIDs:a})=>{a&&a.forEach(c=>{const h=this.msgIdToStrFn(c),l=this.mcache.getWithIWantCount(h,e);if(l==null){o++;return}if(i.set(l.msg.topic,1+(i.get(l.msg.topic)??0)),l.count>zG){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(h,l.msg)})}),this.metrics?.onIwantRcv(i,o),s.size?(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}async handleGraft(e,t){const n=[],s=this.score.score(e),i=Date.now();let o=this.opts.doPX;return t.forEach(({topicID:a})=>{if(!a)return;const c=this.mesh.get(a);if(!c){o=!1;return}if(c.has(e))return;if(this.direct.has(e)){this.log("GRAFT: ignoring request from direct peer %s",e),n.push(a),o=!1;return}const h=this.backoff.get(a)?.get(e);if(typeof h=="number"&&i<h){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,Ba.GraftBackoff),o=!1;const l=h+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<l&&this.score.addPenalty(e,1,Ba.GraftBackoff),this.addBackoff(e,a),n.push(a);return}if(s<0){this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,a),n.push(a),o=!1,this.addBackoff(e,a);return}if(c.size>=this.opts.Dhi&&!this.outbound.get(e)){n.push(a),this.addBackoff(e,a);return}this.log("GRAFT: Add mesh link from %s in %s",e,a),this.score.graft(e,a),c.add(e),this.metrics?.onAddToMesh(a,vs.Subscribed,1)}),n.length?await Promise.all(n.map(a=>this.makePrune(e,a,o))):[]}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:s,backoff:i,peers:o}of t){if(s==null)continue;const a=this.mesh.get(s);if(!a)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,Ji.Unsub,1)),typeof i=="number"&&i>0?this.doAddBackoff(e,s,i*1e3):this.addBackoff(e,s),o&&o.length){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s);continue}await this.pxConnect(o)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s||(s=new Map,this.backoff.set(t,s));const i=Date.now()+n;(s.get(e)??0)<i&&s.set(e,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,Ba.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%HG!==0)return;const e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,i)=>{s<e&&t.delete(i)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){const e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>await this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(En(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map(async n=>{if(!n.peerID)return;const s=Fr(n.peerID).toString();if(!this.peers.has(s)){if(!n.signedPeerRecord){t.push(s);return}try{const i=await or.openAndCertify(n.signedPeerRecord,"libp2p-peer-record"),o=i.peerId;if(!i.peerId.equals(s)){this.log("bogus peer record obtained through px: peer ID %p doesn't match expected peer %p",o,s);return}if(!await this.components.peerStore.addressBook.consumePeerRecord(i)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(s)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length&&await Promise.all(t.map(async n=>await this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);const t=Z(e),n=await this.components.connectionManager.openConnection(t);for(const s of this.multicodecs)for(const i of this.components.registrar.getTopologies(s))i.onConnect(t,n)}subscribe(e){if(this.status.code!==rr.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==rr.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==rr.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,n=this.fanout.get(e);if(n&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),n.forEach(s=>{!this.direct.has(s)&&this.score.score(s)>=0&&t.add(s)}),this.metrics?.onAddToMesh(e,vs.Fanout,t.size)),t.size<this.opts.D){const s=t.size;this.getRandomGossipPeers(e,this.opts.D,o=>!t.has(o)&&!this.direct.has(o)&&this.score.score(o)>=0).forEach(o=>{t.add(o)}),this.metrics?.onAddToMesh(e,vs.Random,t.size-s)}this.mesh.set(e,t),t.forEach(s=>{this.log("JOIN: Add mesh link to %s in %s",s,e),this.sendGraft(s,e)})}leave(e){if(this.status.code!==rr.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t&&(Promise.all(Array.from(t).map(async n=>(this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)))).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){const s=new Set,i=this.topics.get(e);i&&(this.direct.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&s.add(a)}),this.floodsubPeers.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));const o=this.mesh.get(e);return o&&o.size>0&&o.forEach(a=>{t!==a&&!n?.has(a)&&s.add(a)}),s}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s)if(this.opts.floodPublish)s.forEach(i=>{this.direct.has(i)?(t.add(i),n.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});else{this.direct.forEach(o=>{s.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{s.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});const i=this.mesh.get(e);if(i&&i.size>0)i.forEach(o=>{t.add(o),n.mesh++});else{const o=this.fanout.get(e);if(o&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{const a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n&&this.score.deliverMessage(n,e,t.topic);const i=this.selectPeersToForward(t.topic,n,s);i.forEach(o=>{this.sendRpc(o,{messages:[t]})}),this.metrics?.onForwardMsg(t.topic,i.size)}async publish(e,t,n){const s=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:i,msg:o}=await AW(this.publishConfig,e,t,s),a=await this.msgIdFn(o),c=this.msgIdToStrFn(a);if(this.seenCache.has(c))throw Error("PublishError.Duplicate");const{tosend:h,tosendCount:l}=this.selectPeersToPublish(e),u=this.opts.emitSelf===!0&&this.subscriptions.has(e),f=n?.allowPublishToZeroPeers??this.opts.allowPublishToZeroPeers;if(h.size===0&&!f&&!u)throw Error("PublishError.InsufficientPeers");this.seenCache.put(c),this.mcache.put({msgId:a,msgIdStr:c},i,!0),this.publishedMessageIds.put(c);for(const g of h)this.sendRpc(g,{messages:[i]})||h.delete(g);return this.metrics?.onPublishMsg(e,l,h.size,i.data!=null?i.data.length:0),u&&(h.add(this.components.peerId.toString()),super.dispatchEvent(new F("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:c,msg:o}})),super.dispatchEvent(new F("message",{detail:o}))),{recipients:Array.from(h.values()).map(g=>Z(g))}}reportMessageValidationResult(e,t,n){if(n===Nn.Accept){const s=this.mcache.validate(e);if(this.metrics?.onReportValidationMcacheHit(s!==null),s!=null){const{message:i,originatingPeers:o}=s;this.score.deliverMessage(t.toString(),e,i.topic),this.forwardMessage(e,s.message,t.toString(),o),this.metrics?.onReportValidation(i.topic,n)}}else{const s=this.mcache.remove(e);if(this.metrics?.onReportValidationMcacheHit(s!==null),s){const i=N4(n),{message:o,originatingPeers:a}=s;this.score.rejectMessage(t.toString(),e,o.topic,i);for(const c of a)this.score.rejectMessage(c,e,o.topic,i);this.metrics?.onReportValidation(o.topic,n)}}}sendGraft(e,t){const n=[{topicID:t}];this.sendRpc(e,{control:{graft:n}})}async sendPrune(e,t){const n=[await this.makePrune(e,t,this.opts.doPX)];this.sendRpc(e,{control:{prune:n}})}sendRpc(e,t){const n=this.streamsOutbound.get(e);if(!n)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const s=this.control.get(e);s&&(this.piggybackControl(e,t,s),this.control.delete(e));const i=this.gossip.get(e);i&&(this.piggybackGossip(e,t,i),this.gossip.delete(e));const o=F2.encode(t).finish();try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s&&this.control.set(e,s),i&&this.gossip.set(e,i),!1}return this.metrics?.onRpcSent(t,o.length),!0}piggybackControl(e,t,n){if(n.graft){t.control||(t.control={}),t.control.graft||(t.control.graft=[]);for(const s of n.graft)s.topicID&&this.mesh.get(s.topicID)?.has(e)&&t.control.graft.push(s)}if(n.prune){t.control||(t.control={}),t.control.prune||(t.control.prune=[]);for(const s of n.prune)s.topicID&&!this.mesh.get(s.topicID)?.has(e)&&t.control.prune.push(s)}}piggybackGossip(e,t,n){t.control||(t.control={}),t.control.ihave=n}async sendGraftPrune(e,t,n){const s=this.opts.doPX;for(const[i,o]of e){const a=o.map(l=>({topicID:l}));let c=[];const h=t.get(i);h&&(c=await Promise.all(h.map(async l=>await this.makePrune(i,l,s&&!(n.get(i)??!1)))),t.delete(i)),this.sendRpc(i,{control:{graft:a,prune:c}})}for(const[i,o]of t){const a=await Promise.all(o.map(async c=>await this.makePrune(i,c,s&&!(n.get(i)??!1))));this.sendRpc(i,{control:{prune:a}})}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(!n.length||(En(n),n.length>Vi&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),!t.size))return;let s=this.opts.Dlazy;const i=BG*t.size;let o=t;i>s&&(s=i),s>o.size?s=o.size:o=En(Array.from(o)).slice(0,s),o.forEach(a=>{let c=n;n.length>Vi&&(c=En(c.slice()).slice(0,Vi)),this.pushGossip(a,{topicID:e,messageIDs:c})})}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,{control:{ihave:t}});for(const[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,{control:{graft:t.graft,prune:t.prune}})}pushGossip(e,t){this.log("Add gossip to %s",e);const n=this.gossip.get(e)||[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n){if(this.score.prune(e,t),this.streamsOutbound.get(e).protocol===D4)return{topicID:t,peers:[]};const s=this.opts.pruneBackoff/1e3;if(!n)return{topicID:t,peers:[],backoff:s};const i=this.getRandomGossipPeers(t,this.opts.prunePeers,a=>a!==e&&this.score.score(a)>=0),o=await Promise.all(Array.from(i).map(async a=>{const c=Z(a);return{peerID:c.toBytes(),signedPeerRecord:await this.components.peerStore.addressBook.getRawEnvelope(c)}}));return{topicID:t,peers:o,backoff:s}}async heartbeat(){const{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:i,fanoutTTL:o}=this.opts;this.heartbeatTicks++;const a=new Map,c=d=>{let p=a.get(d);return p===void 0&&(p=this.score.score(d),a.set(d,p)),p},h=new Map,l=new Map,u=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const f=new Map;this.mesh.forEach((d,p)=>{const w=this.topics.get(p),y=new Set,_=new Set;if(f.set(p,_),w){const S=En(Array.from(w)),A=this.backoff.get(p);for(const E of S){const I=this.streamsOutbound.get(E);if(I&&this.multicodecs.includes(I.protocol)&&!d.has(E)&&!this.direct.has(E)){const C=c(E);(!A||!A.has(E))&&C>=0&&y.add(E),C>=this.opts.scoreThresholds.gossipThreshold&&_.add(E)}}}const m=(S,A)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",S,p),this.addBackoff(S,p),d.delete(S),c(S)>=this.opts.scoreThresholds.gossipThreshold&&_.add(S),this.metrics?.onRemoveFromMesh(p,A,1);const E=l.get(S);E?E.push(p):l.set(S,[p])},b=(S,A)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",S,p),this.score.graft(S,p),d.add(S),_.delete(S),this.metrics?.onAddToMesh(p,A,1);const E=h.get(S);E?E.push(p):h.set(S,[p])};if(d.forEach(S=>{const A=c(S);A<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",S,A,p),m(S,Ji.BadScore),u.set(S,!0))}),d.size<t){const S=e-d.size;EW(y,S).forEach(E=>{b(E,vs.NotEnough)})}if(d.size>n){let S=Array.from(d);S.sort((E,I)=>c(I)-c(E)),S=S.slice(0,s).concat(En(S.slice(s)));let A=0;if(S.slice(0,e).forEach(E=>{this.outbound.get(E)&&A++}),A<i){const E=C=>{const D=S[C];for(let $=C;$>0;$--)S[$]=S[$-1];S[0]=D};if(A>0){let C=A;for(let D=1;D<e&&C>0;D++)this.outbound.get(S[D])&&(E(D),C--)}let I=e-A;for(let C=e;C<S.length&&I>0;C++)this.outbound.get(S[C])&&(E(C),I--)}S.slice(e).forEach(E=>{m(E,Ji.Excess)})}if(d.size>=t){let S=0;if(d.forEach(A=>{this.outbound.get(A)&&S++}),S<i){const A=i-S;L0(y,A,I=>this.outbound.get(I)===!0).forEach(I=>{b(I,vs.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&d.size>1){const S=Array.from(d).sort((I,C)=>c(I)-c(C)),A=Math.floor(d.size/2),E=c(S[A]);if(E<this.opts.scoreThresholds.opportunisticGraftThreshold){const I=this.opts.opportunisticGraftPeers,C=L0(y,I,D=>c(D)>E);for(const D of C)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",D,p),b(D,vs.Opportunistic)}}});const g=Date.now();this.fanoutLastpub.forEach((d,p)=>{d+o<g&&(this.fanout.delete(p),this.fanoutLastpub.delete(p))}),this.fanout.forEach((d,p)=>{const w=this.topics.get(p);d.forEach(b=>{(!w.has(b)||c(b)<this.opts.scoreThresholds.publishThreshold)&&d.delete(b)});const y=this.topics.get(p),_=[],m=new Set;if(f.set(p,m),y){const b=En(Array.from(y));for(const S of b){const A=this.streamsOutbound.get(S);if(A&&this.multicodecs.includes(A.protocol)&&!d.has(S)&&!this.direct.has(S)){const E=c(S);E>=this.opts.scoreThresholds.publishThreshold&&_.push(S),E>=this.opts.scoreThresholds.gossipThreshold&&m.add(S)}}}if(d.size<e){const b=e-d.size;_.slice(0,b).forEach(S=>{d.add(S),m?.delete(S)})}}),this.emitGossip(f),await this.sendGraftPrune(h,l,u),this.flush(),this.mcache.shift(),this.dispatchEvent(new F("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){const s=this.topics.get(e);if(!s)return new Set;let i=[];return s.forEach(o=>{const a=this.streamsOutbound.get(o);a&&this.multicodecs.includes(a.protocol)&&n(o)&&i.push(o)}),i=En(i),t>0&&i.length>t&&(i=i.slice(0,t)),new Set(i)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;for(const o of this.backoff.values())t+=o.size;e.cacheSize.set({cache:"backoff"},t);for(const[o,a]of this.topics)e.topicPeersCount.set({topicStr:o},a.size);for(const[o,a]of this.mesh)e.meshPeerCounts.set({topicStr:o},a.size);const n=[],s=new Map;e.behaviourPenalty.reset();for(const o of this.peers.keys()){const a=this.score.score(o);n.push(a),s.set(o,a),e.behaviourPenalty.observe(this.score.peerStats.get(o)?.behaviourPenalty??0)}e.registerScores(n,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,s);const i=XW(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(i)}}z9.multicodec=x9;function yY(r={}){return e=>new z9(e,r)}const wY=()=>({gossipsub:yY({fallbackToFloodsub:!0,emitSelf:!0,maxInboundStreams:64,maxOutboundStreams:128})});var mY=F9,z4=128,bY=127,EY=~bY,_Y=Math.pow(2,31);function F9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=_Y;)e[t++]=r&255|z4,r/=128;for(;r&EY;)e[t++]=r&255|z4,r>>>=7;return e[t]=r|0,F9.bytes=t-n+1,e}var vY=U0,SY=128,F4=127;function U0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw U0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&F4)<<s:(o&F4)*Math.pow(2,s),s+=7}while(o>=SY);return U0.bytes=i-n,t}var RY=Math.pow(2,7),AY=Math.pow(2,14),IY=Math.pow(2,21),CY=Math.pow(2,28),TY=Math.pow(2,35),kY=Math.pow(2,42),DY=Math.pow(2,49),PY=Math.pow(2,56),OY=Math.pow(2,63),NY=function(r){return r<RY?1:r<AY?2:r<IY?3:r<CY?4:r<TY?5:r<kY?6:r<DY?7:r<PY?8:r<OY?9:10},xY={encode:mY,decode:vY,encodingLength:NY},pu=xY;const B0=(r,e=0)=>[pu.decode(r,e),pu.decode.bytes],gu=(r,e,t=0)=>(pu.encode(r,e,t),e),yu=r=>pu.encodingLength(r),$Y=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},H2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},LY=(r,e)=>{const t=e.byteLength,n=yu(r),s=n+yu(t),i=new Uint8Array(s+t);return gu(r,i,0),gu(t,i,n),i.set(e,s),new q2(r,t,e,i)},MY=r=>{const e=H2(r),[t,n]=B0(e),[s,i]=B0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new q2(t,s,o,e)},UY=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&$Y(r.bytes,t.bytes)}};let q2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function BY(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var zY=BY,FY=zY;let VY=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},KY=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return V9(this,e)}},jY=class{constructor(e){this.decoders=e}or(e){return V9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const V9=(r,e)=>new jY({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let HY=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new VY(e,t,n),this.decoder=new KY(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const K9=({name:r,prefix:e,encode:t,decode:n})=>new HY(r,e,t,n),j9=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=FY(t,e);return K9({prefix:r,name:e,encode:n,decode:i=>H2(s(i))})},qY=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},GY=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Jn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>K9({prefix:e,name:r,encode(s){return GY(s,n,t)},decode(s){return qY(s,n,t,r)}}),Ss=j9({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});j9({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const ql=Jn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Jn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Jn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Jn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Jn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Jn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Jn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Jn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Jn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const V4=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return QY(t,z0(r),e||Ss.encoder);default:return XY(t,z0(r),e||ql.encoder)}},K4=new WeakMap,z0=r=>{const e=K4.get(r);if(e==null){const t=new Map;return K4.set(r,t),t}return e};let WY=class Pt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==la)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==JY)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Pt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=LY(e,t);return Pt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Pt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&UY(e.multihash,n.multihash)}toString(e){return V4(this,e)}toJSON(){return{"/":V4(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Pt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Pt(n,s,i,o||j4(n,s,i.bytes))}else if(t[ZY]===!0){const{version:n,multihash:s,code:i}=t,o=MY(s);return Pt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==la)throw new Error(`Version 0 CID must use dag-pb (code: ${la}) block encoding`);return new Pt(e,t,n,n.bytes)}case 1:{const s=j4(e,t,n.bytes);return new Pt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Pt.create(0,la,e)}static createV1(e,t){return Pt.create(1,e,t)}static decode(e){const[t,n]=Pt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Pt.inspectBytes(e),n=t.size-t.multihashSize,s=H2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new q2(t.multihashCode,t.digestSize,i,s);return[t.version===0?Pt.createV0(o):Pt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=B0(e.subarray(t));return t+=f,u};let s=n(),i=la;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=YY(e,t),i=Pt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return z0(i).set(n,e),i}};const YY=(r,e)=>{switch(r[0]){case"Q":{const t=e||Ss;return[Ss.prefix,t.decode(`${Ss.prefix}${r}`)]}case Ss.prefix:{const t=e||Ss;return[Ss.prefix,t.decode(r)]}case ql.prefix:{const t=e||ql;return[ql.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},QY=(r,e,t)=>{const{prefix:n}=t;if(n!==Ss.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},XY=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},la=112,JY=18,j4=(r,e,t)=>{const n=yu(r),s=n+yu(e),i=new Uint8Array(s+t.byteLength);return gu(r,i,0),gu(e,i,n),i.set(t,s),i},ZY=Symbol.for("@ipld/js-cid/CID"),ti=P("libp2p-delegated-peer-routing"),H4=3e4,eQ=4;var q4;(function(r){r[r.SENDING_QUERY=0]="SENDING_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADDING_PEER=6]="ADDING_PEER",r[r.DIALING_PEER=7]="DIALING_PEER"})(q4||(q4={}));var G4;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(G4||(G4={}));class tQ{constructor(e){if(e==null)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new lt({concurrency:eQ});const{protocol:t,host:n,port:s}=e.getEndpointConfig();ti(`enabled DelegatedPeerRouting via ${t}://${n}:${s}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async findPeer(e,t={}){ti("findPeer starts: %p",e),t.timeout=t.timeout??H4,t.signal=li([this.abortController.signal].concat(t.signal!=null?[t.signal]:[]));const n=We(),s=We();this.httpQueue.add(async()=>(n.resolve(),await s.promise));try{await n.promise;for await(const i of this.client.dht.findPeer(e,t))if(i.name==="FINAL_PEER")return{id:i.peer.id,multiaddrs:i.peer.multiaddrs,protocols:[]}}catch(i){throw ti.error("findPeer errored: %o",i),i}finally{s.resolve(),ti("findPeer finished: %p",e)}throw v(new Error("Not found"),"ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){let n;const s=WY.asCID(e);s!=null?n=s:n=Fr(e),ti("getClosestPeers starts: %s",n),t.timeout=t.timeout??H4,t.signal=li([this.abortController.signal].concat(t.signal!=null?[t.signal]:[]));const i=We(),o=We();this.httpQueue.add(async()=>(i.resolve(),await o.promise));try{await i.promise;for await(const a of this.client.dht.query(n,t))a.name==="PEER_RESPONSE"&&(yield*a.closer.map(c=>({id:c.id,multiaddrs:c.multiaddrs,protocols:[]})))}catch(a){throw ti.error("getClosestPeers errored:",a),a}finally{o.resolve(),ti("getClosestPeers finished: %b",e)}}}function rQ(r){return()=>new tQ(r)}const Kr=P("libp2p:delegated-content-routing"),wl=3e4,nQ=4,sQ=2;var W4;(function(r){r[r.SENDING_QUERY=0]="SENDING_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADDING_PEER=6]="ADDING_PEER",r[r.DIALING_PEER=7]="DIALING_PEER"})(W4||(W4={}));var Y4;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(Y4||(Y4={}));class iQ{constructor(e){if(e==null)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new lt({concurrency:nQ}),this.httpQueueRefs=new lt({concurrency:sQ});const{protocol:t,host:n,port:s}=e.getEndpointConfig();Kr(`enabled DelegatedContentRouting via ${t}://${n}:${s}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.httpQueueRefs.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async*findProviders(e,t={}){Kr("findProviders starts: %c",e),t.timeout=t.timeout??wl,t.signal=li([this.abortController.signal].concat(t.signal!=null?[t.signal]:[]));const n=We(),s=We();this.httpQueue.add(async()=>(n.resolve(),await s.promise));try{await n.promise;for await(const i of this.client.dht.findProvs(e,t))i.name==="PROVIDER"&&(yield*i.providers.map(o=>({id:o.id,protocols:[],multiaddrs:o.multiaddrs})))}catch(i){throw Kr.error("findProviders errored:",i),i}finally{s.resolve(),Kr("findProviders finished: %c",e)}}async provide(e,t={}){Kr("provide starts: %c",e),t.timeout=t.timeout??wl,t.signal=li([this.abortController.signal].concat(t.signal!=null?[t.signal]:[])),await this.httpQueueRefs.add(async()=>{await this.client.block.stat(e,t),await ot(this.client.dht.provide(e,t))}),Kr("provide finished: %c",e)}async put(e,t,n={}){Kr("put value start: %b",e),n.timeout=n.timeout??wl,n.signal=li([this.abortController.signal].concat(n.signal!=null?[n.signal]:[])),await this.httpQueue.add(async()=>{await ot(this.client.dht.put(e,t,n))}),Kr("put value finished: %b",e)}async get(e,t={}){return Kr("get value start: %b",e),t.timeout=t.timeout??wl,t.signal=li([this.abortController.signal].concat(t.signal!=null?[t.signal]:[])),await this.httpQueue.add(async()=>{for await(const n of this.client.dht.get(e,t))if(n.name==="VALUE")return Kr("get value finished: %b",e),n.value;throw v(new Error("Not found"),"ERR_NOT_FOUND")})}}function oQ(r){return()=>new iQ(r)}const aQ=r=>Promise.reject(new Error(`No base found for "${r}"`));class H9{constructor(e){this._basesByName={},this._basesByPrefix={},this._loadBase=e.loadBase||aQ;for(const t of e.bases)this.addBase(t)}addBase(e){if(this._basesByName[e.name]||this._basesByPrefix[e.prefix])throw new Error(`Codec already exists for codec "${e.name}"`);this._basesByName[e.name]=e,this._basesByPrefix[e.prefix]=e}removeBase(e){delete this._basesByName[e.name],delete this._basesByPrefix[e.prefix]}async getBase(e){if(this._basesByName[e])return this._basesByName[e];if(this._basesByPrefix[e])return this._basesByPrefix[e];const t=await this._loadBase(e);return this._basesByName[t.name]==null&&this._basesByPrefix[t.prefix]==null&&this.addBase(t),t}listBases(){return Object.values(this._basesByName)}}const cQ=r=>Promise.reject(new Error(`No codec found for "${r}"`));class q9{constructor(e){this._codecsByName={},this._codecsByCode={},this._loadCodec=e.loadCodec||cQ;for(const t of e.codecs)this.addCodec(t)}addCodec(e){if(this._codecsByName[e.name]||this._codecsByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._codecsByName[e.name]=e,this._codecsByCode[e.code]=e}removeCodec(e){delete this._codecsByName[e.name],delete this._codecsByCode[e.code]}async getCodec(e){const t=typeof e=="string"?this._codecsByName:this._codecsByCode;if(t[e])return t[e];const n=await this._loadCodec(e);return t[e]==null&&this.addCodec(n),n}listCodecs(){return Object.values(this._codecsByName)}}const lQ=r=>Promise.reject(new Error(`No hasher found for "${r}"`));class G9{constructor(e){this._hashersByName={},this._hashersByCode={},this._loadHasher=e.loadHasher||lQ;for(const t of e.hashers)this.addHasher(t)}addHasher(e){if(this._hashersByName[e.name]||this._hashersByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._hashersByName[e.name]=e,this._hashersByCode[e.code]=e}removeHasher(e){delete this._hashersByName[e.name],delete this._hashersByCode[e.code]}async getHasher(e){const t=typeof e=="string"?this._hashersByName:this._hashersByCode;if(t[e])return t[e];const n=await this._loadHasher(e);return t[e]==null&&this.addHasher(n),n}listHashers(){return Object.values(this._hashersByName)}}const hQ=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Mo=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},uQ=r=>new TextEncoder().encode(r),dQ=r=>new TextDecoder().decode(r);var fQ=W9,Q4=128,pQ=127,gQ=~pQ,yQ=Math.pow(2,31);function W9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=yQ;)e[t++]=r&255|Q4,r/=128;for(;r&gQ;)e[t++]=r&255|Q4,r>>>=7;return e[t]=r|0,W9.bytes=t-n+1,e}var wQ=F0,mQ=128,X4=127;function F0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw F0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&X4)<<s:(o&X4)*Math.pow(2,s),s+=7}while(o>=mQ);return F0.bytes=i-n,t}var bQ=Math.pow(2,7),EQ=Math.pow(2,14),_Q=Math.pow(2,21),vQ=Math.pow(2,28),SQ=Math.pow(2,35),RQ=Math.pow(2,42),AQ=Math.pow(2,49),IQ=Math.pow(2,56),CQ=Math.pow(2,63),TQ=function(r){return r<bQ?1:r<EQ?2:r<_Q?3:r<vQ?4:r<SQ?5:r<RQ?6:r<AQ?7:r<IQ?8:r<CQ?9:10},kQ={encode:fQ,decode:wQ,encodingLength:TQ},wu=kQ;const V0=(r,e=0)=>[wu.decode(r,e),wu.decode.bytes],mu=(r,e,t=0)=>(wu.encode(r,e,t),e),bu=r=>wu.encodingLength(r),Eu=(r,e)=>{const t=e.byteLength,n=bu(r),s=n+bu(t),i=new Uint8Array(s+t);return mu(r,i,0),mu(t,i,n),i.set(e,s),new G2(r,t,e,i)},DQ=r=>{const e=Mo(r),[t,n]=V0(e),[s,i]=V0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new G2(t,s,o,e)},PQ=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&hQ(r.bytes,t.bytes)}};let G2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const Y9=0,OQ="identity",Q9=Mo,NQ=r=>Eu(Y9,Q9(r)),K0={code:Y9,name:OQ,encode:Q9,digest:NQ},xQ=Object.freeze(Object.defineProperty({__proto__:null,identity:K0},Symbol.toStringTag,{value:"Module"}));function $Q(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var LQ=$Q,MQ=LQ;let UQ=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},BQ=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return X9(this,e)}},zQ=class{constructor(e){this.decoders=e}or(e){return X9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const X9=(r,e)=>new zQ({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let FQ=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new UQ(e,t,n),this.decoder=new BQ(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Id=({name:r,prefix:e,encode:t,decode:n})=>new FQ(r,e,t,n),Lc=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=MQ(t,e);return Id({prefix:r,name:e,encode:n,decode:i=>Mo(s(i))})},VQ=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},KQ=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},mt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Id({prefix:e,name:r,encode(s){return KQ(s,n,t)},decode(s){return VQ(s,n,t,r)}}),jQ=Id({prefix:"\0",name:"identity",encode:r=>dQ(r),decode:r=>uQ(r)}),HQ=Object.freeze(Object.defineProperty({__proto__:null,identity:jQ},Symbol.toStringTag,{value:"Module"})),qQ=mt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),GQ=Object.freeze(Object.defineProperty({__proto__:null,base2:qQ},Symbol.toStringTag,{value:"Module"})),WQ=mt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),YQ=Object.freeze(Object.defineProperty({__proto__:null,base8:WQ},Symbol.toStringTag,{value:"Module"})),QQ=Lc({prefix:"9",name:"base10",alphabet:"0123456789"}),XQ=Object.freeze(Object.defineProperty({__proto__:null,base10:QQ},Symbol.toStringTag,{value:"Module"})),JQ=mt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ZQ=mt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),eX=Object.freeze(Object.defineProperty({__proto__:null,base16:JQ,base16upper:ZQ},Symbol.toStringTag,{value:"Module"})),Fa=mt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),tX=mt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),rX=mt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),nX=mt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),sX=mt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),iX=mt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),oX=mt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),aX=mt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),cX=mt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),lX=Object.freeze(Object.defineProperty({__proto__:null,base32:Fa,base32hex:sX,base32hexpad:oX,base32hexpadupper:aX,base32hexupper:iX,base32pad:rX,base32padupper:nX,base32upper:tX,base32z:cX},Symbol.toStringTag,{value:"Module"})),hX=Lc({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),uX=Lc({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),dX=Object.freeze(Object.defineProperty({__proto__:null,base36:hX,base36upper:uX},Symbol.toStringTag,{value:"Module"})),Pn=Lc({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),fX=Lc({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),pX=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Pn,base58flickr:fX},Symbol.toStringTag,{value:"Module"})),gX=mt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),yX=mt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Cd=mt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),wX=mt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),mX=Object.freeze(Object.defineProperty({__proto__:null,base64:gX,base64pad:yX,base64url:Cd,base64urlpad:wX},Symbol.toStringTag,{value:"Module"})),J9=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),bX=J9.reduce((r,e,t)=>(r[t]=e,r),[]),EX=J9.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function _X(r){return r.reduce((e,t)=>(e+=bX[t],e),"")}function vX(r){const e=[];for(const t of r){const n=EX[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const SX=Id({prefix:"🚀",name:"base256emoji",encode:_X,decode:vX}),RX=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:SX},Symbol.toStringTag,{value:"Module"})),Z9=({name:r,code:e,encode:t})=>new AX(r,e,t);let AX=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Eu(this.code,t):t.then(n=>Eu(this.code,n))}else throw Error("Unknown type, must be binary type")}};const eE=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),IX=Z9({name:"sha2-256",code:18,encode:eE("SHA-256")}),CX=Z9({name:"sha2-512",code:19,encode:eE("SHA-512")}),TX=Object.freeze(Object.defineProperty({__proto__:null,sha256:IX,sha512:CX},Symbol.toStringTag,{value:"Module"})),kX="raw",DX=85,PX=r=>Mo(r),OX=r=>Mo(r),NX=Object.freeze(Object.defineProperty({__proto__:null,code:DX,decode:OX,encode:PX,name:kX},Symbol.toStringTag,{value:"Module"})),xX=new TextEncoder,$X=new TextDecoder,LX="json",MX=512,UX=r=>xX.encode(JSON.stringify(r)),BX=r=>JSON.parse($X.decode(r)),zX=Object.freeze(Object.defineProperty({__proto__:null,code:MX,decode:BX,encode:UX,name:LX},Symbol.toStringTag,{value:"Module"})),J4=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return VX(t,j0(r),e||Pn.encoder);default:return KX(t,j0(r),e||Fa.encoder)}},Z4=new WeakMap,j0=r=>{const e=Z4.get(r);if(e==null){const t=new Map;return Z4.set(r,t),t}return e};let ne=class Ot{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ha)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==jX)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ot.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Eu(e,t);return Ot.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ot.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&PQ(e.multihash,n.multihash)}toString(e){return J4(this,e)}toJSON(){return{"/":J4(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ot)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Ot(n,s,i,o||e6(n,s,i.bytes))}else if(t[HX]===!0){const{version:n,multihash:s,code:i}=t,o=DQ(s);return Ot.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ha)throw new Error(`Version 0 CID must use dag-pb (code: ${ha}) block encoding`);return new Ot(e,t,n,n.bytes)}case 1:{const s=e6(e,t,n.bytes);return new Ot(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Ot.create(0,ha,e)}static createV1(e,t){return Ot.create(1,e,t)}static decode(e){const[t,n]=Ot.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ot.inspectBytes(e),n=t.size-t.multihashSize,s=Mo(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new G2(t.multihashCode,t.digestSize,i,s);return[t.version===0?Ot.createV0(o):Ot.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=V0(e.subarray(t));return t+=f,u};let s=n(),i=ha;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=FX(e,t),i=Ot.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return j0(i).set(n,e),i}};const FX=(r,e)=>{switch(r[0]){case"Q":{const t=e||Pn;return[Pn.prefix,t.decode(`${Pn.prefix}${r}`)]}case Pn.prefix:{const t=e||Pn;return[Pn.prefix,t.decode(r)]}case Fa.prefix:{const t=e||Fa;return[Fa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},VX=(r,e,t)=>{const{prefix:n}=t;if(n!==Pn.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},KX=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ha=112,jX=18,e6=(r,e,t)=>{const n=bu(r),s=n+bu(e),i=new Uint8Array(s+t.byteLength);return mu(r,i,0),mu(e,i,n),i.set(t,s),i},HX=Symbol.for("@ipld/js-cid/CID"),qX={...HQ,...GQ,...YQ,...XQ,...eX,...lX,...dX,...pX,...mX,...RX},GX={...TX,...xQ},WX={raw:NX,json:zX};function t6(r){try{r=E2(G(r))}catch{}return r=r.toString(),r}const YX=()=>{},r6=P("ipfs-http-client:lib:error-handler"),QX=Ue.bind({ignoreUndefined:!0}),XX=Hs.isBrowser||Hs.isWebWorker?location.protocol:"http",JX=Hs.isBrowser||Hs.isWebWorker?location.hostname:"localhost",ZX=Hs.isBrowser||Hs.isWebWorker?location.port:"5001",eJ=(r={})=>{let e,t={},n;if(typeof r=="string"||Ln(r))e=new URL(t6(r));else if(r instanceof URL)e=r;else if(typeof r.url=="string"||Ln(r.url))e=new URL(t6(r.url)),t=r;else if(r.url instanceof URL)e=r.url,t=r;else{t=r||{};const s=(t.protocol||XX).replace(":",""),i=(t.host||JX).split(":")[0],o=t.port||ZX;e=new URL(`${s}://${i}:${o}`)}if(t.apiPath?e.pathname=t.apiPath:(e.pathname==="/"||e.pathname===void 0)&&(e.pathname="api/v0"),Hs.isNode){const s=YX();n=t.agent||new s({keepAlive:!0,maxSockets:6})}return{...t,host:e.host,protocol:e.protocol.replace(":",""),port:Number(e.port),apiPath:e.pathname,url:e,agent:n}},tJ=async r=>{let e;try{if((r.headers.get("Content-Type")||"").startsWith("application/json")){const n=await r.json();r6(n),e=n.Message||n.message}else e=await r.text()}catch(n){r6("Failed to parse error response",n),e=n.message}let t=new xn.HTTPError(r);throw e&&(e.includes("deadline has elapsed")&&(t=new xn.TimeoutError),e&&e.includes("context deadline exceeded")&&(t=new xn.TimeoutError)),e&&e.includes("request timed out")&&(t=new xn.TimeoutError),e&&(t.message=e),t},rJ=/[A-Z\u00C0-\u00D6\u00D8-\u00DE]/g,n6=r=>r.replace(rJ,function(e){return"-"+e.toLowerCase()}),nJ=r=>typeof r=="string"?re(r):r;class W2 extends xn{constructor(e={}){const t=eJ(e);super({timeout:nJ(t.timeout||0)||void 0,headers:t.headers,base:`${t.url}`,handleError:tJ,transformSearchParams:s=>{const i=new URLSearchParams;for(const[o,a]of s)a!=="undefined"&&a!=="null"&&o!=="signal"&&i.append(n6(o),a),o==="timeout"&&!isNaN(a)&&i.append(n6(o),a);return i},agent:t.agent}),delete this.get,delete this.put,delete this.delete,delete this.options;const n=this.fetch;this.fetch=(s,i={})=>(typeof s=="string"&&!s.startsWith("/")&&(s=`${t.url}/${s}`),n.call(this,s,QX(i,{method:"POST"})))}}xn.HTTPError;const O=r=>e=>r(new W2(e),e);function tE(r){if(r!=null)return typeof r=="string"?r:r.toString(8).padStart(4,"0")}function rE(r){if(r==null)return;let e;if(r.secs!=null&&(e={secs:r.secs,nsecs:r.nsecs}),r.Seconds!=null&&(e={secs:r.Seconds,nsecs:r.FractionalNanoseconds}),Array.isArray(r)&&(e={secs:r[0],nsecs:r[1]}),r instanceof Date){const t=r.getTime(),n=Math.floor(t/1e3);e={secs:n,nsecs:(t-n*1e3)*1e3}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(e!=null&&e.nsecs!=null&&(e.nsecs<0||e.nsecs>999999999))throw v(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}function N({arg:r,searchParams:e,hashAlg:t,mtime:n,mode:s,...i}={}){e&&(i={...i,...e}),t&&(i.hash=t),n!=null&&(n=rE(n),i.mtime=n.secs,i.mtimeNsecs=n.nsecs),s!=null&&(i.mode=tE(s)),i.timeout&&!isNaN(i.timeout)&&(i.timeout=`${i.timeout}ms`),r==null?r=[]:Array.isArray(r)||(r=[r]);const o=new URLSearchParams(i);return r.forEach(a=>o.append("arg",a)),o}const sJ=O(r=>{async function e(t={}){return((await(await r.post("bitswap/wantlist",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Keys||[]).map(s=>ne.parse(s["/"]))}return e}),iJ=O(r=>{async function e(t,n={}){return((await(await r.post("bitswap/wantlist",{signal:n.signal,searchParams:N({...n,peer:t.toString()}),headers:n.headers})).json()).Keys||[]).map(i=>ne.parse(i["/"]))}return e}),nE=O(r=>{async function e(t={}){const n=await r.post("bitswap/stat",{searchParams:N(t),signal:t.signal,headers:t.headers});return oJ(await n.json())}return e});function oJ(r){return{provideBufLen:r.ProvideBufLen,wantlist:(r.Wantlist||[]).map(e=>ne.parse(e["/"])),peers:(r.Peers||[]).map(e=>Z(e)),blocksReceived:BigInt(r.BlocksReceived),dataReceived:BigInt(r.DataReceived),blocksSent:BigInt(r.BlocksSent),dataSent:BigInt(r.DataSent),dupBlksReceived:BigInt(r.DupBlksReceived),dupDataReceived:BigInt(r.DupDataReceived)}}const aJ=O(r=>{async function e(t,n={}){return(await r.post("bitswap/unwant",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers})).json()}return e});function cJ(r){return{wantlist:sJ(r),wantlistForPeer:iJ(r),unwant:aJ(r),stat:nE(r)}}const sE=O(r=>{async function e(t,n={}){const s=await r.post("block/get",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers});return new Uint8Array(await s.arrayBuffer())}return e});async function lJ(r){if(qs(r))return new Blob([r]);if(typeof r=="string"||r instanceof String)return new Blob([r.toString()]);if(Ja(r))return r;if(Za(r)&&(r=_i(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const e=Ac(r),{value:t,done:n}=await e.peek();if(n)return s6(e);if(e.push(t),Number.isInteger(t))return new Blob([Uint8Array.from(await Kn(e))]);if(qs(t)||typeof t=="string"||t instanceof String)return s6(e)}throw v(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT")}async function s6(r){const e=[];for await(const t of r)e.push(t);return new Blob(e)}function hJ(r){return _b(r,lJ)}function uJ(r){if(r!=null)return typeof r=="string"?r:r.toString(8).padStart(4,"0")}async function fn(r,e,t={}){const n=[],s=new FormData;let i=0,o=0;for await(const{content:a,path:c,mode:h,mtime:l}of hJ(r)){let u="";const f=a?"file":"dir";i>0&&(u=`-${i}`);let g=f+u;const d=[];if(h!=null&&d.push(`mode=${uJ(h)}`),l!=null){const{secs:p,nsecs:w}=l;d.push(`mtime=${p}`),w!=null&&d.push(`mtime-nsecs=${w}`)}if(d.length&&(g=`${g}?${d.join("&")}`),a){s.set(g,a,c!=null?encodeURIComponent(c):void 0);const p=o+a.size;n.push({name:c,start:o,end:p}),o=p}else if(c!=null)s.set(g,new File([""],encodeURIComponent(c),{type:"application/x-directory"}));else throw new Error("path or content or both must be set");i++}return{total:o,parts:n,headers:t,body:s}}function dJ(r){return r.filter(Boolean)}function pn(...r){return Ur(dJ(r))}const fJ=O(r=>{async function e(t,n={}){const s=new AbortController,i=pn(s.signal,n.signal);let o;try{o=await(await r.post("block/put",{signal:i,searchParams:N(n),...await fn([t],s,n.headers)})).json()}catch(a){if(n.format==="dag-pb")return e(t,{...n,format:"protobuf"});if(n.format==="dag-cbor")return e(t,{...n,format:"cbor"});throw a}return ne.parse(o.Key)}return e}),pJ=O(r=>{async function*e(t,n={}){Array.isArray(t)||(t=[t]);const s=await r.post("block/rm",{signal:n.signal,searchParams:N({arg:t.map(i=>i.toString()),"stream-channels":!0,...n}),headers:n.headers});for await(const i of s.ndjson())yield gJ(i)}return e});function gJ(r){const e={cid:ne.parse(r.Hash)};return r.Error&&(e.error=new Error(r.Error)),e}const yJ=O(r=>{async function e(t,n={}){const i=await(await r.post("block/stat",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers})).json();return{cid:ne.parse(i.Key),size:i.Size}}return e});function wJ(r){return{get:sE(r),put:fJ(r),rm:pJ(r),stat:yJ(r)}}const mJ=O(r=>{async function e(t,n={}){const s=await r.post("bootstrap/add",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Peers:i}=await s.json();return{Peers:i.map(o=>G(o))}}return e}),bJ=O(r=>{async function e(t={}){const n=await r.post("bootstrap/rm",{signal:t.signal,searchParams:N({...t,all:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>G(i))}}return e}),EJ=O(r=>{async function e(t={}){const n=await r.post("bootstrap/list",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>G(i))}}return e}),_J=O(r=>{async function e(t={}){const n=await r.post("bootstrap/add",{signal:t.signal,searchParams:N({...t,default:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>G(i))}}return e}),vJ=O(r=>{async function e(t,n={}){const s=await r.post("bootstrap/rm",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Peers:i}=await s.json();return{Peers:i.map(o=>G(o))}}return e});function SJ(r){return{add:mJ(r),clear:bJ(r),list:EJ(r),reset:_J(r),rm:vJ(r)}}const RJ=O(r=>{async function e(t,n={}){const i=await(await r.post("config/profile/apply",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return{original:i.OldCfg,updated:i.NewCfg}}return e});function ht(r){if(r==null)return r;const e=/^[A-Z]+$/,t={};return Object.keys(r).reduce((n,s)=>(e.test(s)?n[s.toLowerCase()]=r[s]:e.test(s[0])?n[s[0].toLowerCase()+s.slice(1)]=r[s]:n[s]=r[s],n),t)}const AJ=O(r=>{async function e(t={}){return(await(await r.post("config/profile/list",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).map(i=>ht(i))}return e});function IJ(r){return{apply:RJ(r),list:AJ(r)}}const CJ=O(r=>async(t,n={})=>{if(!t)throw new Error("key argument is required");return(await(await r.post("config",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json()).Value}),TJ=O(r=>async(t={})=>await(await r.post("config/show",{signal:t.signal,searchParams:N({...t}),headers:t.headers})).json()),kJ=O(r=>async(t,n={})=>{const s=new AbortController,i=pn(s.signal,n.signal);await(await r.post("config/replace",{signal:i,searchParams:N(n),...await fn([L(JSON.stringify(t))],s,n.headers)})).text()}),DJ=O(r=>async(t,n,s={})=>{if(typeof t!="string")throw new Error("Invalid key type");const i={...s,...PJ(t,n)};await(await r.post("config",{signal:s.signal,searchParams:N(i),headers:s.headers})).text()}),PJ=(r,e)=>{switch(typeof e){case"boolean":return{arg:[r,e.toString()],bool:!0};case"string":return{arg:[r,e]};default:return{arg:[r,JSON.stringify(e)],json:!0}}};function OJ(r){return{getAll:TJ(r),get:CJ(r),set:DJ(r),replace:kJ(r),profiles:IJ(r)}}const NJ=O(r=>{async function*e(t,n={}){yield*(await r.post("dag/export",{signal:n.signal,searchParams:N({arg:t.toString()}),headers:n.headers})).iterator()}return e});async function*i6(r,e,t,n,s){const i=async h=>{const l=await t.getCodec(h.code),u=await n(h,s);return l.decode(u)},o=e.split("/").filter(Boolean);let a=await i(r),c=r;for(;o.length;){const h=o.shift();if(!h)throw v(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(Object.prototype.hasOwnProperty.call(a,h))a=a[h],yield{value:a,remainderPath:o.join("/")};else throw v(new Error(`no link named "${h}" under ${c}`),"ERR_NO_LINK");const l=ne.asCID(a);l&&(c=l,a=await i(a))}yield{value:a,remainderPath:""}}const xJ=(r,e)=>O((n,s)=>{const i=sE(s);return async(a,c={})=>{if(c.path){const g=c.localResolve?await Rr(i6(a,c.path,r,i,c)):await hr(i6(a,c.path,r,i,c));if(!g)throw v(new Error("Not found"),"ERR_NOT_FOUND");return g}const h=await r.getCodec(a.code),l=await i(a,c);return{value:h.decode(l),remainderPath:""}}})(e),$J=O(r=>{async function*e(t,n={}){const s=new AbortController,i=pn(s.signal,n.signal),{headers:o,body:a}=await fn(t,s,n.headers),c=await r.post("dag/import",{signal:i,headers:o,body:a,searchParams:N({"pin-roots":n.pinRoots})});for await(const{Root:h}of c.ndjson())if(h!==void 0){const{Cid:{"/":l},PinErrorMsg:u}=h;yield{root:{cid:ne.parse(l),pinErrorMsg:u}}}}return e}),iE=(r,e)=>O(n=>async(i,o={})=>{const a={storeCodec:"dag-cbor",hashAlg:"sha2-256",...o};let c;if(a.inputCodec){if(!(i instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");c=i}else c=(await r.getCodec(a.storeCodec)).encode(i),a.inputCodec=a.storeCodec;const h=new AbortController,l=pn(h.signal,a.signal),f=await(await n.post("dag/put",{timeout:a.timeout,signal:l,searchParams:N(a),...await fn([c],h,a.headers)})).json();return ne.parse(f.Cid["/"])})(e),LJ=O(r=>async(t,n={})=>{const i=await(await r.post("dag/resolve",{signal:n.signal,searchParams:N({arg:`${t}${n.path?`/${n.path}`.replace(/\/[/]+/g,"/"):""}`,...n}),headers:n.headers})).json();return{cid:ne.parse(i.Cid["/"]),remainderPath:i.RemPath}});function MJ(r,e){return{export:NJ(e),get:xJ(r,e),import:$J(e),put:iE(r,e),resolve:LJ(e)}}const UJ=0,BJ=1,zJ=2,FJ=3,VJ=4,KJ=5,jJ=6,HJ=7,Uo=r=>{if(r.Type===UJ)return{name:"SENDING_QUERY",type:r.Type};if(r.Type===BJ)return{from:Z(r.ID),name:"PEER_RESPONSE",type:r.Type,messageType:0,messageName:"PUT_VALUE",closer:(r.Responses||[]).map(({ID:e,Addrs:t})=>({id:Z(e),multiaddrs:t.map(n=>G(n)),protocols:[]})),providers:(r.Responses||[]).map(({ID:e,Addrs:t})=>({id:Z(e),multiaddrs:t.map(n=>G(n)),protocols:[]}))};if(r.Type===zJ){let e={id:r.ID??Z(r.ID),multiaddrs:[],protocols:[]};return r.Responses&&r.Responses.length&&(e={id:Z(r.Responses[0].ID),multiaddrs:r.Responses[0].Addrs.map(t=>G(t)),protocols:[]}),{name:"FINAL_PEER",type:r.Type,peer:e}}if(r.Type===FJ)return{name:"QUERY_ERROR",type:r.Type,error:new Error(r.Extra)};if(r.Type===VJ)return{name:"PROVIDER",type:r.Type,providers:r.Responses.map(({ID:e,Addrs:t})=>({id:Z(e),multiaddrs:t.map(n=>G(n)),protocols:[]}))};if(r.Type===KJ)return{name:"VALUE",type:r.Type,value:L(r.Extra,"base64pad")};if(r.Type===jJ){const e=r.Responses.map(({ID:t})=>Z(t));if(!e.length)throw new Error("No peer found");return{name:"ADDING_PEER",type:r.Type,peer:e[0]}}if(r.Type===HJ)return{name:"DIALING_PEER",type:r.Type,peer:Z(r.ID)};throw new Error("Unknown DHT event type")},qJ=O(r=>{async function*e(t,n={}){const s=await r.post("dht/findpeer",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers});for await(const i of s.ndjson())yield Uo(i)}return e}),GJ=O(r=>{async function*e(t,n={}){const s=await r.post("dht/findprovs",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield Uo(i)}return e}),WJ=O(r=>{async function*e(t,n={}){const s=await r.post("dht/get",{signal:n.signal,searchParams:N({arg:t instanceof Uint8Array?B(t):t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield Uo(i)}return e}),YJ=O(r=>{async function*e(t,n={recursive:!1}){const s=Array.isArray(t)?t:[t],i=await r.post("dht/provide",{signal:n.signal,searchParams:N({arg:s.map(o=>o.toString()),...n}),headers:n.headers});for await(const o of i.ndjson())yield Uo(o)}return e}),QJ=O(r=>{async function*e(t,n,s={}){const i=new AbortController,o=pn(i.signal,s.signal),a=await r.post("dht/put",{signal:o,searchParams:N({arg:t instanceof Uint8Array?B(t):t.toString(),...s}),...await fn([n],i,s.headers)});for await(const c of a.ndjson())yield Uo(c)}return e}),XJ=O(r=>{async function*e(t,n={}){const s=await r.post("dht/query",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield Uo(i)}return e});function JJ(r){return{findPeer:qJ(r),findProvs:GJ(r),get:WJ(r),provide:YJ(r),put:QJ(r),query:XJ(r)}}const ZJ=O(r=>{async function e(t={}){return(await r.post("diag/cmds",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()}return e}),eZ=O(r=>{async function e(t={}){return(await r.post("diag/net",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()}return e}),tZ=O(r=>{async function e(t={}){return(await r.post("diag/sys",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()}return e});function rZ(r){return{cmds:ZJ(r),net:eZ(r),sys:tZ(r)}}const nZ=O(r=>{async function e(t,n,s={}){await(await r.post("files/chmod",{signal:s.signal,searchParams:N({arg:t,mode:n,...s}),headers:s.headers})).text()}return e}),sZ=O(r=>{async function e(t,n,s={}){const i=Array.isArray(t)?t:[t];await(await r.post("files/cp",{signal:s.signal,searchParams:N({arg:i.concat(n).map(a=>ne.asCID(a)?`/ipfs/${a}`:a),...s}),headers:s.headers})).text()}return e}),iZ=O(r=>{async function e(t,n={}){if(!t||typeof t!="string")throw new Error("ipfs.files.flush requires a path");const i=await(await r.post("files/flush",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return ne.parse(i.Cid)}return e});function H0(r){const e=ht(r);return Object.prototype.hasOwnProperty.call(e,"mode")&&(e.mode=parseInt(e.mode,8)),Object.prototype.hasOwnProperty.call(e,"mtime")&&(e.mtime={secs:e.mtime,nsecs:e.mtimeNsecs||0},delete e.mtimeNsecs),e}const oZ=O(r=>{async function*e(t,n={}){if(!t)throw new Error("ipfs.files.ls requires a path");const s=await r.post("files/ls",{signal:n.signal,searchParams:N({arg:ne.asCID(t)?`/ipfs/${t}`:t,long:!0,...n,stream:!0}),headers:n.headers});for await(const i of s.ndjson())if("Entries"in i)for(const o of i.Entries||[])yield o6(H0(o));else yield o6(H0(i))}return e});function o6(r){return r.hash&&(r.cid=ne.parse(r.hash)),delete r.hash,r.type=r.type===1?"directory":"file",r}const aZ=O(r=>{async function e(t,n={}){await(await r.post("files/mkdir",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).text()}return e}),cZ=O(r=>{async function e(t,n,s={}){Array.isArray(t)||(t=[t]),await(await r.post("files/mv",{signal:s.signal,searchParams:N({arg:t.concat(n),...s}),headers:s.headers})).text()}return e});var lZ=r=>{if(r[Symbol.asyncIterator])return r;if(r.getReader)return async function*(){const e=r.getReader();try{for(;;){const{done:t,value:n}=await e.read();if(t)return;yield n}}finally{e.releaseLock()}}();throw new Error("unknown stream")};const hZ=O(r=>{async function*e(t,n={}){const s=await r.post("files/read",{signal:n.signal,searchParams:N({arg:t,count:n.length,...n}),headers:n.headers});yield*lZ(s.body)}return e}),uZ=O(r=>{async function e(t,n={}){const s=await r.post("files/rm",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),i=await s.text();if(i!==""){const o=new xn.HTTPError(s);throw o.message=i,o}}return e}),oE=O(r=>{async function e(t,n={}){const i=await(await r.post("files/stat",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return i.WithLocality=i.WithLocality||!1,dZ(H0(i))}return e});function dZ(r){return r.cid=ne.parse(r.hash),delete r.hash,r}const fZ=O(r=>{async function e(t,n={}){await(await r.post("files/touch",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).text()}return e}),pZ=O(r=>{async function e(t,n,s={}){const i=new AbortController,o=pn(i.signal,s.signal);await(await r.post("files/write",{signal:o,searchParams:N({arg:t,streamChannels:!0,count:s.length,...s}),...await fn([{content:n,path:"arg",mode:tE(s.mode),mtime:rE(s.mtime)}],i,s.headers)})).text()}return e});function gZ(r){return{chmod:nZ(r),cp:sZ(r),flush:iZ(r),ls:oZ(r),mkdir:aZ(r),mv:cZ(r),read:hZ(r),rm:uZ(r),stat:oE(r),touch:fZ(r),write:pZ(r)}}const yZ=O(r=>async(t,n,s={})=>{throw v(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),wZ=O(r=>{async function e(t,n){const s=n??{type:"Ed25519"},o=await(await r.post("key/gen",{signal:s.signal,searchParams:N({arg:t,...s}),headers:s.headers})).json();return ht(o)}return e}),mZ=O(r=>{async function e(t,n,s,i={}){const a=await(await r.post("key/import",{signal:i.signal,searchParams:N({arg:t,pem:n,password:s,...i}),headers:i.headers})).json();return ht(a)}return e}),bZ=O(r=>async(t,n={})=>{throw v(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),EZ=O(r=>{async function e(t={}){return((await(await r.post("key/list",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Keys||[]).map(i=>ht(i))}return e}),_Z=O(r=>{async function e(t,n,s={}){const i=await r.post("key/rename",{signal:s.signal,searchParams:N({arg:[t,n],...s}),headers:s.headers});return ht(await i.json())}return e}),vZ=O(r=>{async function e(t,n={}){const i=await(await r.post("key/rm",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return ht(i.Keys[0])}return e});function SZ(r){return{export:yZ(r),gen:wZ(r),import:mZ(r),info:bZ(r),list:EZ(r),rename:_Z(r),rm:vZ(r)}}const RZ=O(r=>{async function e(t,n,s={}){const i=await r.post("log/level",{signal:s.signal,searchParams:N({arg:[t,n],...s}),headers:s.headers});return ht(await i.json())}return e}),AZ=O(r=>{async function e(t={}){return(await(await r.post("log/ls",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Strings}return e}),IZ=O(r=>{async function*e(t={}){yield*(await r.post("log/tail",{signal:t.signal,searchParams:N(t),headers:t.headers})).ndjson()}return e});function CZ(r){return{level:RZ(r),ls:AZ(r),tail:IZ(r)}}const TZ=O(r=>{async function e(t,n={}){const s=await r.post("name/publish",{signal:n.signal,searchParams:N({arg:`${t}`,...n}),headers:n.headers});return ht(await s.json())}return e}),kZ=O(r=>{async function*e(t,n={}){const s=await r.post("name/resolve",{signal:n.signal,searchParams:N({arg:t,stream:!0,...n}),headers:n.headers});for await(const i of s.ndjson())yield i.Path}return e}),DZ=O(r=>{async function e(t,n={}){const s=await r.post("name/pubsub/cancel",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers});return ht(await s.json())}return e}),PZ=O(r=>{async function e(t={}){const n=await r.post("name/pubsub/state",{signal:t.signal,searchParams:N(t),headers:t.headers});return ht(await n.json())}return e}),OZ=O(r=>{async function e(t={}){return(await(await r.post("name/pubsub/subs",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Strings||[]}return e});function NZ(r){return{cancel:DZ(r),state:PZ(r),subs:OZ(r)}}function xZ(r){return{publish:TZ(r),resolve:kZ(r),pubsub:NZ(r)}}const $Z=O(r=>{async function e(t,n={}){const i=await(await r.post("object/data",{signal:n.signal,searchParams:N({arg:`${t instanceof Uint8Array?ne.decode(t):t}`,...n}),headers:n.headers})).arrayBuffer();return new Uint8Array(i,0,i.byteLength)}return e}),LZ=O(r=>{async function e(t,n={}){const i=await(await r.post("object/get",{signal:n.signal,searchParams:N({arg:`${t instanceof Uint8Array?ne.decode(t):t}`,dataEncoding:"base64",...n}),headers:n.headers})).json();return{Data:L(i.Data,"base64pad"),Links:(i.Links||[]).map(o=>({Name:o.Name,Hash:ne.parse(o.Hash),Tsize:o.Size}))}}return e}),MZ=O(r=>{async function e(t,n={}){return((await(await r.post("object/links",{signal:n.signal,searchParams:N({arg:`${t instanceof Uint8Array?ne.decode(t):t}`,...n}),headers:n.headers})).json()).Links||[]).map(o=>({Name:o.Name,Tsize:o.Size,Hash:ne.parse(o.Hash)}))}return e}),UZ=O(r=>{async function e(t={}){const n=await r.post("object/new",{signal:t.signal,searchParams:N({arg:t.template,...t}),headers:t.headers}),{Hash:s}=await n.json();return ne.parse(s)}return e}),BZ=(r,e)=>O(n=>{const s=iE(r,e);async function i(o,a={}){return s(o,{...a,storeCodec:"dag-pb",hashAlg:"sha2-256",version:1})}return i})(e),zZ=O(r=>{async function e(t,n={}){const i=await(await r.post("object/stat",{signal:n.signal,searchParams:N({arg:`${t}`,...n}),headers:n.headers})).json();return{...i,Hash:ne.parse(i.Hash)}}return e}),FZ=O(r=>{async function e(t,n,s={}){const i=await r.post("object/patch/add-link",{signal:s.signal,searchParams:N({arg:[`${t}`,n.Name||n.name||"",(n.Hash||n.cid||"").toString()||null],...s}),headers:s.headers}),{Hash:o}=await i.json();return ne.parse(o)}return e}),VZ=O(r=>{async function e(t,n,s={}){const i=new AbortController,o=pn(i.signal,s.signal),a=await r.post("object/patch/append-data",{signal:o,searchParams:N({arg:`${t}`,...s}),...await fn([n],i,s.headers)}),{Hash:c}=await a.json();return ne.parse(c)}return e}),KZ=O(r=>{async function e(t,n,s={}){const i=await r.post("object/patch/rm-link",{signal:s.signal,searchParams:N({arg:[`${t}`,n.Name||n.name||null],...s}),headers:s.headers}),{Hash:o}=await i.json();return ne.parse(o)}return e}),jZ=O(r=>{async function e(t,n,s={}){const i=new AbortController,o=pn(i.signal,s.signal),a=await r.post("object/patch/set-data",{signal:o,searchParams:N({arg:[`${t}`],...s}),...await fn([n],i,s.headers)}),{Hash:c}=await a.json();return ne.parse(c)}return e});function HZ(r){return{addLink:FZ(r),appendData:VZ(r),rmLink:KZ(r),setData:jZ(r)}}function qZ(r,e){return{data:$Z(e),get:LZ(e),links:MZ(e),new:UZ(e),put:BZ(r,e),stat:zZ(e),patch:HZ(e)}}const aE=O(r=>{async function*e(t,n={}){for await(const{path:s,recursive:i,metadata:o}of Rc(t)){const a=await r.post("pin/add",{signal:n.signal,searchParams:N({...n,arg:s,recursive:i,metadata:o?JSON.stringify(o):void 0,stream:!0}),headers:n.headers});for await(const c of a.ndjson()){if(c.Pins){for(const h of c.Pins)yield ne.parse(h);continue}yield ne.parse(c)}}}return e});function GZ(r){const e=aE(r);return O(()=>{async function t(n,s={}){return hr(e([{path:n,...s}],s))}return t})(r)}function a6(r,e,t){const n={type:r,cid:ne.parse(e)};return t&&(n.metadata=t),n}const WZ=O(r=>{async function*e(t={}){let n=[];t.paths&&(n=Array.isArray(t.paths)?t.paths:[t.paths]);const s=await r.post("pin/ls",{signal:t.signal,searchParams:N({...t,arg:n.map(i=>`${i}`),stream:!0}),headers:t.headers});for await(const i of s.ndjson()){if(i.Keys){for(const o of Object.keys(i.Keys))yield a6(i.Keys[o].Type,o,i.Keys[o].Metadata);return}yield a6(i.Type,i.Cid,i.Metadata)}}return e}),cE=O(r=>{async function*e(t,n={}){for await(const{path:s,recursive:i}of Rc(t)){const o=new URLSearchParams(n.searchParams);o.append("arg",`${s}`),i!=null&&o.set("recursive",String(i));const a=await r.post("pin/rm",{signal:n.signal,headers:n.headers,searchParams:N({...n,arg:`${s}`,recursive:i})});for await(const c of a.ndjson()){if(c.Pins){yield*c.Pins.map(h=>ne.parse(h));continue}yield ne.parse(c)}}}return e}),YZ=r=>{const e=cE(r);return O(()=>{async function t(n,s={}){return hr(e([{path:n,...s}],s))}return t})(r)},lE=({Name:r,Status:e,Cid:t})=>({cid:ne.parse(t),name:r,status:e}),hE=r=>{if(typeof r=="string"&&r!=="")return r;throw new TypeError("service name must be passed")},uE=r=>{if(ne.asCID(r))return r.toString();throw new TypeError(`CID instance expected instead of ${typeof r}`)},Y2=({service:r,cid:e,name:t,status:n,all:s})=>{const i=N({service:hE(r),name:t,force:s?!0:void 0});if(e)for(const o of e)i.append("cid",uE(o));if(n)for(const o of n)i.append("status",o);return i},QZ=({cid:r,service:e,background:t,name:n,origins:s})=>{const i=N({arg:uE(r),service:hE(e),name:n,background:t?!0:void 0});if(s)for(const o of s)i.append("origin",o.toString());return i};function XZ(r){async function e(t,{timeout:n,signal:s,headers:i,...o}){const a=await r.post("pin/remote/add",{timeout:n,signal:s,headers:i,searchParams:QZ({cid:t,...o})});return lE(await a.json())}return e}function JZ(r){async function*e({timeout:t,signal:n,headers:s,...i}){const o=await r.post("pin/remote/ls",{timeout:t,signal:n,headers:s,searchParams:Y2(i)});for await(const a of o.ndjson())yield lE(a)}return e}function ZZ(r){async function e({timeout:t,signal:n,headers:s,...i}){await r.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:Y2({...i,all:!1})})}return e}function eee(r){async function e({timeout:t,signal:n,headers:s,...i}){await r.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:Y2({...i,all:!0})})}return e}function tee(r){const e=String(r);if(e==="undefined")throw Error("endpoint is required");return e[e.length-1]==="/"?e.slice(0,-1):e}function ree(r){return{service:r.Service,endpoint:new URL(r.ApiEndpoint),...r.Stat&&{stat:nee(r.Stat)}}}function nee(r){switch(r.Status){case"valid":{const{Pinning:e,Pinned:t,Queued:n,Failed:s}=r.PinCount;return{status:"valid",pinCount:{queued:n,pinning:e,pinned:t,failed:s}}}case"invalid":return{status:"invalid"};default:return{status:r.Status}}}function see(r){async function e(t,n){const{endpoint:s,key:i,headers:o,timeout:a,signal:c}=n;await r.post("pin/remote/service/add",{timeout:a,signal:c,searchParams:N({arg:[t,tee(s),i]}),headers:o})}return e}function iee(r){async function e(t={}){const{stat:n,headers:s,timeout:i,signal:o}=t,a=await r.post("pin/remote/service/ls",{timeout:i,signal:o,headers:s,searchParams:n===!0?N({stat:n}):void 0}),{RemoteServices:c}=await a.json();return c.map(ree)}return e}function oee(r){async function e(t,n={}){await r.post("pin/remote/service/rm",{signal:n.signal,headers:n.headers,searchParams:N({arg:t})})}return e}function aee(r){const e=new W2(r);return{add:see(e),ls:iee(e),rm:oee(e)}}function cee(r){const e=new W2(r);return{add:XZ(e),ls:JZ(e),rm:ZZ(e),rmAll:eee(e),service:aee(r)}}function lee(r){return{addAll:aE(r),add:GZ(r),ls:WZ(r),rmAll:cE(r),rm:YZ(r),remote:cee(r)}}const hee=r=>Array.isArray(r)?r.map(q0):r,q0=r=>B(ka(r)),ka=r=>Cd.decode(r),uee=r=>BigInt(`0x${B(Cd.decode(r),"base16")}`),Q2=r=>Cd.encode(L(r)),dee=O(r=>{async function e(t={}){const{Strings:n}=await(await r.post("pubsub/ls",{signal:t.signal,searchParams:N(t),headers:t.headers})).json();return hee(n)||[]}return e}),fee=O(r=>{async function e(t,n={}){const s=await r.post("pubsub/peers",{signal:n.signal,searchParams:N({arg:Q2(t),...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),pee=O(r=>{async function e(t,n,s={}){const i=N({arg:Q2(t),...s}),o=new AbortController,a=pn(o.signal,s.signal);await(await r.post("pubsub/pub",{signal:a,searchParams:i,...await fn([n],o,s.headers)})).text()}return e}),gee=P("ipfs-http-client:pubsub:subscribe"),yee=(r,e)=>O(t=>{async function n(s,i,o={}){o.signal=e.subscribe(s,i,o.signal);let a,c;const h=new Promise((u,f)=>{a=u,c=f}),l=setTimeout(()=>a(),1e3);return t.post("pubsub/sub",{signal:o.signal,searchParams:N({arg:Q2(s),...o}),headers:o.headers}).catch(u=>{e.unsubscribe(s,i),c(u)}).then(u=>{clearTimeout(l),u&&(wee(u,{onMessage:f=>{if(i){if(typeof i=="function"){i(f);return}typeof i.handleEvent=="function"&&i.handleEvent(f)}},onEnd:()=>e.unsubscribe(s,i),onError:o.onError}),a())}),h}return n})(r);async function wee(r,{onMessage:e,onEnd:t,onError:n}){n=n||gee;try{for await(const s of r.ndjson())try{if(!s.from)continue;s.from!=null&&s.seqno!=null?e({type:"signed",from:Z(s.from),data:ka(s.data),sequenceNumber:uee(s.seqno),topic:q0(s.topicIDs[0]),key:ka(s.key??"u"),signature:ka(s.signature??"u")}):e({type:"unsigned",data:ka(s.data),topic:q0(s.topicIDs[0])})}catch(i){i.message=`Failed to parse pubsub message: ${i.message}`,n(i,!1,s)}}catch(s){mee(s)||n(s,!0)}finally{t()}}const mee=r=>{switch(r.type){case"aborted":return!0;case"abort":return!0;default:return r.name==="AbortError"}},bee=(r,e)=>{async function t(n,s){e.unsubscribe(n,s)}return t};class Eee{constructor(){this._subs=new Map}subscribe(e,t,n){const s=this._subs.get(e)||[];if(s.find(o=>o.handler===t))throw new Error(`Already subscribed to ${e} with this handler`);const i=new AbortController;return this._subs.set(e,[{handler:t,controller:i}].concat(s)),n&&n.addEventListener("abort",()=>this.unsubscribe(e,t)),i.signal}unsubscribe(e,t){const n=this._subs.get(e)||[];let s;t?(this._subs.set(e,n.filter(i=>i.handler!==t)),s=n.filter(i=>i.handler===t)):(this._subs.set(e,[]),s=n),(this._subs.get(e)||[]).length||this._subs.delete(e),s.forEach(i=>i.controller.abort())}}function _ee(r){const e=new Eee;return{ls:dee(r),peers:fee(r),publish:pee(r),subscribe:yee(r,e),unsubscribe:bee(r,e)}}const vee=O(r=>{async function*e(t={}){yield*(await r.post("refs/local",{signal:t.signal,transform:ht,searchParams:N(t),headers:t.headers})).ndjson()}return e}),See=O((r,e)=>Object.assign(async function*(n,s={}){const i=Array.isArray(n)?n:[n];yield*(await r.post("refs",{signal:s.signal,searchParams:N({arg:i.map(a=>`${a instanceof Uint8Array?ne.decode(a):a}`),...s}),headers:s.headers,transform:ht})).ndjson()},{local:vee(e)})),Ree=O(r=>{async function*e(t={}){yield*(await r.post("repo/gc",{signal:t.signal,searchParams:N(t),headers:t.headers,transform:s=>({err:s.Error?new Error(s.Error):null,cid:(s.Key||{})["/"]?ne.parse(s.Key["/"]):null})})).ndjson()}return e}),dE=O(r=>{async function e(t={}){const s=await(await r.post("repo/stat",{signal:t.signal,searchParams:N(t),headers:t.headers})).json();return{numObjects:BigInt(s.NumObjects),repoSize:BigInt(s.RepoSize),repoPath:s.RepoPath,version:s.Version,storageMax:BigInt(s.StorageMax)}}return e}),Aee=O(r=>{async function e(t={}){return(await(await r.post("repo/version",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Version}return e});function Iee(r){return{gc:Ree(r),stat:dE(r),version:Aee(r)}}const Cee=O(r=>{async function*e(t={}){yield*(await r.post("stats/bw",{signal:t.signal,searchParams:N(t),headers:t.headers,transform:s=>({totalIn:BigInt(s.TotalIn),totalOut:BigInt(s.TotalOut),rateIn:parseFloat(s.RateIn),rateOut:parseFloat(s.RateOut)})})).ndjson()}return e});function Tee(r){return{bitswap:nE(r),repo:dE(r),bw:Cee(r)}}const kee=O(r=>{async function e(t={}){const n=await r.post("swarm/addrs",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Addrs:s}=await n.json();return Object.keys(s).map(i=>({id:Z(i),addrs:(s[i]||[]).map(o=>G(o))}))}return e}),Dee=O(r=>{async function e(t,n={}){const s=await r.post("swarm/connect",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),Pee=O(r=>{async function e(t,n={}){const s=await r.post("swarm/disconnect",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),Oee=O(r=>{async function e(t={}){const n=await r.post("swarm/addrs/local",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Strings:s}=await n.json();return(s||[]).map(i=>G(i))}return e}),Nee=O(r=>{async function e(t={}){const n=await r.post("swarm/peers",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Peers:s}=await n.json();return(s||[]).map(i=>({addr:G(i.Addr),peer:Z(i.Peer),muxer:i.Muxer,latency:i.Latency,streams:i.Streams,direction:i.Direction==null?void 0:i.Direction===0?"inbound":"outbound"}))}return e});function xee(r){return{addrs:kee(r),connect:Dee(r),disconnect:Pee(r),localAddrs:Oee(r),peers:Nee(r)}}const fE=O(r=>{async function*e(t,n={}){const s=new AbortController,i=pn(s.signal,n.signal),{headers:o,body:a,total:c,parts:h}=await fn(t,s,n.headers),[l,u]=typeof n.progress=="function"?$ee(c,h,n.progress):[void 0,void 0],f=await r.post("add",{searchParams:N({"stream-channels":!0,...n,progress:Boolean(l)}),onUploadProgress:u,signal:i,headers:o,body:a});for await(let g of f.ndjson())g=ht(g),g.hash!==void 0?yield Mee(g):l&&l(g.bytes||0,g.name)}return e}),$ee=(r,e,t)=>e?[void 0,Lee(r,e,t)]:[t,void 0],Lee=(r,e,t)=>{let n=0;const s=e.length;return({loaded:i,total:o})=>{const a=Math.floor(i/o*r);for(;n<s;){const{start:c,end:h,name:l}=e[n];if(a<h){t(a-c,l);break}else t(h-c,l),n+=1}}};function Mee({name:r,hash:e,size:t,mode:n,mtime:s,mtimeNsecs:i}){const o={path:r,cid:ne.parse(e),size:parseInt(t)};return n!=null&&(o.mode=parseInt(n,8)),s!=null&&(o.mtime={secs:s,nsecs:i||0}),o}function Uee(r){const e=fE(r);return O(()=>{async function t(n,s={}){return await hr(e(Q8(n),s))}return t})(r)}const Bee=O(r=>{async function*e(t,n={}){yield*(await r.post("cat",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers})).iterator()}return e}),zee=O(r=>async(t={})=>(await r.post("commands",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()),Fee=O(r=>async(t,n={})=>(await(await r.post("dns",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json()).Path),Vee=O(r=>()=>{const e=new URL(r.opts.base||"");return{host:e.hostname,port:e.port,protocol:e.protocol,pathname:e.pathname,"api-path":e.pathname}}),Kee=O(r=>{async function*e(t,n={}){const s={arg:`${t instanceof Uint8Array?ne.decode(t):t}`,...n};s.compressionLevel&&(s["compression-level"]=s.compressionLevel,delete s.compressionLevel),yield*(await r.post("get",{signal:n.signal,searchParams:N(s),headers:n.headers})).iterator()}return e}),pE=O(r=>{async function e(t={}){const s=await(await r.post("id",{signal:t.signal,searchParams:N({arg:t.peerId?t.peerId.toString():void 0,...t}),headers:t.headers})).json(),i={...ht(s)};return i.id=Z(i.id),i.addresses&&(i.addresses=i.addresses.map(o=>G(o))),i}return e}),jee=r=>{const e=pE(r);async function t(n={}){const s=await e(n);return Boolean(s&&s.addresses&&s.addresses.length)}return t},Hee=O((r,e)=>{async function*t(n,s={}){const i=`${n instanceof Uint8Array?ne.decode(n):n}`;async function o(c){let h=c.Hash;if(h.includes("/")){const u=h.startsWith("/ipfs/")?h:`/ipfs/${h}`;h=(await oE(e)(u)).cid}else h=ne.parse(h);const l={name:c.Name,path:i+(c.Name?`/${c.Name}`:""),size:c.Size,cid:h,type:qee(c)};return c.Mode&&(l.mode=parseInt(c.Mode,8)),c.Mtime!==void 0&&c.Mtime!==null&&(l.mtime={secs:c.Mtime},c.MtimeNsecs!==void 0&&c.MtimeNsecs!==null&&(l.mtime.nsecs=c.MtimeNsecs)),l}const a=await r.post("ls",{signal:s.signal,searchParams:N({arg:i,...s}),headers:s.headers});for await(let c of a.ndjson()){if(c=c.Objects,!c)throw new Error("expected .Objects in results");if(c=c[0],!c)throw new Error("expected one array in results.Objects");const h=c.Links;if(!Array.isArray(h))throw new Error("expected one array in results.Objects[0].Links");if(!h.length){yield o(c);return}yield*h.map(o)}}return t});function qee(r){switch(r.Type){case 1:case 5:return"dir";case 2:return"file";default:return"file"}}const Gee=O(r=>{async function e(t={}){const n=await r.post("dns",{signal:t.signal,searchParams:N(t),headers:t.headers});return ht(await n.json())}return e}),Wee=O(r=>{async function*e(t,n={}){yield*(await r.post("ping",{signal:n.signal,searchParams:N({arg:`${t}`,...n}),headers:n.headers,transform:ht})).ndjson()}return e}),Yee=O(r=>{async function e(t,n={}){const s=await r.post("resolve",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Path:i}=await s.json();return i}return e}),Qee=O(r=>async(t={})=>{throw v(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),Xee=O(r=>{async function e(t={}){await(await r.post("shutdown",{signal:t.signal,searchParams:N(t),headers:t.headers})).text()}return e}),Jee=O(r=>{async function e(t={}){const n=await r.post("version",{signal:t.signal,searchParams:N(t),headers:t.headers});return{...ht(await n.json()),"ipfs-http-client":"1.0.0"}}return e});function Zee(r={}){const e={name:K0.name,code:K0.code,encode:h=>h,decode:h=>h},t=Object.values(qX);(r.ipld&&r.ipld.bases?r.ipld.bases:[]).forEach(h=>t.push(h));const n=new H9({bases:t,loadBase:r.ipld&&r.ipld.loadBase}),s=Object.values(WX);[Ks,rm,km,Um,e].concat(r.ipld&&r.ipld.codecs||[]).forEach(h=>s.push(h));const i=new q9({codecs:s,loadCodec:r.ipld&&r.ipld.loadCodec}),o=Object.values(GX);(r.ipld&&r.ipld.hashers?r.ipld.hashers:[]).forEach(h=>o.push(h));const a=new G9({hashers:o,loadHasher:r.ipld&&r.ipld.loadHasher});return{add:Uee(r),addAll:fE(r),bitswap:cJ(r),block:wJ(r),bootstrap:SJ(r),cat:Bee(r),commands:zee(r),config:OJ(r),dag:MJ(i,r),dht:JJ(r),diag:rZ(r),dns:Fee(r),files:gZ(r),get:Kee(r),getEndpointConfig:Vee(r),id:pE(r),isOnline:jee(r),key:SZ(r),log:CZ(r),ls:Hee(r),mount:Gee(r),name:xZ(r),object:qZ(i,r),pin:lee(r),ping:Wee(r),pubsub:_ee(r),refs:See(r),repo:Iee(r),resolve:Yee(r),start:Qee(r),stats:Tee(r),stop:Xee(r),swarm:xee(r),version:Jee(r),bases:n,codecs:i,hashers:a}}const c6=421,ete=290,tte=2e3,dn=Object.create(null);dn.open="0";dn.close="1";dn.ping="2";dn.pong="3";dn.message="4";dn.upgrade="5";dn.noop="6";const Gl=Object.create(null);Object.keys(dn).forEach(r=>{Gl[dn[r]]=r});const rte={type:"error",data:"parser error"},nte=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",ste=typeof ArrayBuffer=="function",ite=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer,gE=({type:r,data:e},t,n)=>nte&&e instanceof Blob?t?n(e):l6(e,n):ste&&(e instanceof ArrayBuffer||ite(e))?t?n(e):l6(new Blob([e]),n):n(dn[r]+(e||"")),l6=(r,e)=>{const t=new FileReader;return t.onload=function(){const n=t.result.split(",")[1];e("b"+(n||""))},t.readAsDataURL(r)},h6="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Da=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let r=0;r<h6.length;r++)Da[h6.charCodeAt(r)]=r;const ote=r=>{let e=r.length*.75,t=r.length,n,s=0,i,o,a,c;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);const h=new ArrayBuffer(e),l=new Uint8Array(h);for(n=0;n<t;n+=4)i=Da[r.charCodeAt(n)],o=Da[r.charCodeAt(n+1)],a=Da[r.charCodeAt(n+2)],c=Da[r.charCodeAt(n+3)],l[s++]=i<<2|o>>4,l[s++]=(o&15)<<4|a>>2,l[s++]=(a&3)<<6|c&63;return h},ate=typeof ArrayBuffer=="function",yE=(r,e)=>{if(typeof r!="string")return{type:"message",data:wE(r,e)};const t=r.charAt(0);return t==="b"?{type:"message",data:cte(r.substring(1),e)}:Gl[t]?r.length>1?{type:Gl[t],data:r.substring(1)}:{type:Gl[t]}:rte},cte=(r,e)=>{if(ate){const t=ote(r);return wE(t,e)}else return{base64:!0,data:r}},wE=(r,e)=>{switch(e){case"blob":return r instanceof ArrayBuffer?new Blob([r]):r;case"arraybuffer":default:return r}},mE=String.fromCharCode(30),lte=(r,e)=>{const t=r.length,n=new Array(t);let s=0;r.forEach((i,o)=>{gE(i,!1,a=>{n[o]=a,++s===t&&e(n.join(mE))})})},hte=(r,e)=>{const t=r.split(mE),n=[];for(let s=0;s<t.length;s++){const i=yE(t[s],e);if(n.push(i),i.type==="error")break}return n},bE=4;function st(r){if(r)return ute(r)}function ute(r){for(var e in st.prototype)r[e]=st.prototype[e];return r}st.prototype.on=st.prototype.addEventListener=function(r,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+r]=this._callbacks["$"+r]||[]).push(e),this};st.prototype.once=function(r,e){function t(){this.off(r,t),e.apply(this,arguments)}return t.fn=e,this.on(r,t),this};st.prototype.off=st.prototype.removeListener=st.prototype.removeAllListeners=st.prototype.removeEventListener=function(r,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+r];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+r],this;for(var n,s=0;s<t.length;s++)if(n=t[s],n===e||n.fn===e){t.splice(s,1);break}return t.length===0&&delete this._callbacks["$"+r],this};st.prototype.emit=function(r){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+r],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t){t=t.slice(0);for(var n=0,s=t.length;n<s;++n)t[n].apply(this,e)}return this};st.prototype.emitReserved=st.prototype.emit;st.prototype.listeners=function(r){return this._callbacks=this._callbacks||{},this._callbacks["$"+r]||[]};st.prototype.hasListeners=function(r){return!!this.listeners(r).length};const yr=(()=>typeof self<"u"?self:typeof window<"u"?window:Function("return this")())();function EE(r,...e){return e.reduce((t,n)=>(r.hasOwnProperty(n)&&(t[n]=r[n]),t),{})}const dte=yr.setTimeout,fte=yr.clearTimeout;function Td(r,e){e.useNativeTimers?(r.setTimeoutFn=dte.bind(yr),r.clearTimeoutFn=fte.bind(yr)):(r.setTimeoutFn=yr.setTimeout.bind(yr),r.clearTimeoutFn=yr.clearTimeout.bind(yr))}const pte=1.33;function gte(r){return typeof r=="string"?yte(r):Math.ceil((r.byteLength||r.size)*pte)}function yte(r){let e=0,t=0;for(let n=0,s=r.length;n<s;n++)e=r.charCodeAt(n),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(n++,t+=4);return t}class wte extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class _E extends st{constructor(e){super(),this.writable=!1,Td(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,n){return super.emitReserved("error",new wte(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=yE(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}}const vE="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),G0=64,mte={};let u6=0,ml=0,d6;function f6(r){let e="";do e=vE[r%G0]+e,r=Math.floor(r/G0);while(r>0);return e}function SE(){const r=f6(+new Date);return r!==d6?(u6=0,d6=r):r+"."+f6(u6++)}for(;ml<G0;ml++)mte[vE[ml]]=ml;function RE(r){let e="";for(let t in r)r.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(r[t]));return e}function bte(r){let e={},t=r.split("&");for(let n=0,s=t.length;n<s;n++){let i=t[n].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}let AE=!1;try{AE=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Ete=AE;function IE(r){const e=r.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Ete))return new XMLHttpRequest}catch{}if(!e)try{return new yr[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}function _te(){}const vte=function(){return new IE({xdomain:!1}).responseType!=null}();class Ste extends _E{constructor(e){if(super(e),this.polling=!1,typeof location<"u"){const n=location.protocol==="https:";let s=location.port;s||(s=n?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||s!==e.port,this.xs=e.secure!==n}const t=e&&e.forceBase64;this.supportsBinary=vte&&!t}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let n=0;this.polling&&(n++,this.once("pollComplete",function(){--n||t()})),this.writable||(n++,this.once("drain",function(){--n||t()}))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=n=>{if(this.readyState==="opening"&&n.type==="open"&&this.onOpen(),n.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(n)};hte(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,lte(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){let e=this.query||{};const t=this.opts.secure?"https":"http";let n="";this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=SE()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.opts.port&&(t==="https"&&Number(this.opts.port)!==443||t==="http"&&Number(this.opts.port)!==80)&&(n=":"+this.opts.port);const s=RE(e),i=this.opts.hostname.indexOf(":")!==-1;return t+"://"+(i?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(s.length?"?"+s:"")}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new ln(this.uri(),e)}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(s,i)=>{this.onError("xhr post error",s,i)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,n)=>{this.onError("xhr poll error",t,n)}),this.pollXhr=e}}class ln extends st{constructor(e,t){super(),Td(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=t.async!==!1,this.data=t.data!==void 0?t.data:null,this.create()}create(){const e=EE(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new IE(e);try{t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let n in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(n)&&t.setRequestHeader(n,this.opts.extraHeaders[n])}}catch{}if(this.method==="POST")try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{t.setRequestHeader("Accept","*/*")}catch{}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),t.onreadystatechange=()=>{t.readyState===4&&(t.status===200||t.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof t.status=="number"?t.status:0)},0))},t.send(this.data)}catch(n){this.setTimeoutFn(()=>{this.onError(n)},0);return}typeof document<"u"&&(this.index=ln.requestsCount++,ln.requests[this.index]=this)}onError(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}cleanup(e){if(!(typeof this.xhr>"u"||this.xhr===null)){if(this.xhr.onreadystatechange=_te,e)try{this.xhr.abort()}catch{}typeof document<"u"&&delete ln.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}ln.requestsCount=0;ln.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",p6);else if(typeof addEventListener=="function"){const r="onpagehide"in yr?"pagehide":"unload";addEventListener(r,p6,!1)}}function p6(){for(let r in ln.requests)ln.requests.hasOwnProperty(r)&&ln.requests[r].abort()}const CE=(()=>typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0))(),bl=yr.WebSocket||yr.MozWebSocket,g6=!0,Rte="arraybuffer",y6=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Ate extends _E{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,n=y6?{}:EE(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=g6&&!y6?t?new bl(e,t):new bl(e):new bl(e,t,n)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType||Rte,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],s=t===e.length-1;gE(n,this.supportsBinary,i=>{const o={};try{g6&&this.ws.send(i)}catch{}s&&CE(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.close(),this.ws=null)}uri(){let e=this.query||{};const t=this.opts.secure?"wss":"ws";let n="";this.opts.port&&(t==="wss"&&Number(this.opts.port)!==443||t==="ws"&&Number(this.opts.port)!==80)&&(n=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=SE()),this.supportsBinary||(e.b64=1);const s=RE(e),i=this.opts.hostname.indexOf(":")!==-1;return t+"://"+(i?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(s.length?"?"+s:"")}check(){return!!bl}}const Ite={websocket:Ate,polling:Ste},Cte=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Tte=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function W0(r){const e=r,t=r.indexOf("["),n=r.indexOf("]");t!=-1&&n!=-1&&(r=r.substring(0,t)+r.substring(t,n).replace(/:/g,";")+r.substring(n,r.length));let s=Cte.exec(r||""),i={},o=14;for(;o--;)i[Tte[o]]=s[o]||"";return t!=-1&&n!=-1&&(i.source=e,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i.pathNames=kte(i,i.path),i.queryKey=Dte(i,i.query),i}function kte(r,e){const t=/\/{2,9}/g,n=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&n.splice(0,1),e.slice(-1)=="/"&&n.splice(n.length-1,1),n}function Dte(r,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(n,s,i){s&&(t[s]=i)}),t}let TE=class Yi extends st{constructor(e,t={}){super(),this.writeBuffer=[],e&&typeof e=="object"&&(t=e,e=null),e?(e=W0(e),t.hostname=e.host,t.secure=e.protocol==="https"||e.protocol==="wss",t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=W0(t.host).host),Td(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=bte(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=bE,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new Ite[e](n)}open(){let e;if(this.opts.rememberUpgrade&&Yi.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)e="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else e=this.transports[0];this.readyState="opening";try{e=this.createTransport(e)}catch{this.transports.shift(),this.open();return}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",t=>this.onClose("transport close",t))}probe(e){let t=this.createTransport(e),n=!1;Yi.priorWebsocketSuccess=!1;const s=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",u=>{if(!n)if(u.type==="pong"&&u.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;Yi.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{n||this.readyState!=="closed"&&(l(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const f=new Error("probe error");f.transport=t.name,this.emitReserved("upgradeError",f)}}))};function i(){n||(n=!0,l(),t.close(),t=null)}const o=u=>{const f=new Error("probe error: "+u);f.transport=t.name,i(),this.emitReserved("upgradeError",f)};function a(){o("transport closed")}function c(){o("socket closed")}function h(u){t&&u.name!==t.name&&i()}const l=()=>{t.removeListener("open",s),t.removeListener("error",o),t.removeListener("close",a),this.off("close",c),this.off("upgrading",h)};t.once("open",s),t.once("error",o),t.once("close",a),this.once("close",c),this.once("upgrading",h),t.open()}onOpen(){if(this.readyState="open",Yi.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let n=0;n<this.writeBuffer.length;n++){const s=this.writeBuffer[n].data;if(s&&(t+=gte(s)),n>0&&t>this.maxPayload)return this.writeBuffer.slice(0,n);t+=2}return this.writeBuffer}write(e,t,n){return this.sendPacket("message",e,t,n),this}send(e,t,n){return this.sendPacket("message",e,t,n),this}sendPacket(e,t,n,s){if(typeof t=="function"&&(s=t,t=void 0),typeof n=="function"&&(s=n,n=null),this.readyState==="closing"||this.readyState==="closed")return;n=n||{},n.compress=n.compress!==!1;const i={type:e,data:t,options:n};this.emitReserved("packetCreate",i),this.writeBuffer.push(i),s&&this.once("flush",s),this.flush()}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?n():e()}):this.upgrading?n():e()),this}onError(e){Yi.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let n=0;const s=e.length;for(;n<s;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}};TE.protocol=bE;function Pte(r,e="",t){let n=r;t=t||typeof location<"u"&&location,r==null&&(r=t.protocol+"//"+t.host),typeof r=="string"&&(r.charAt(0)==="/"&&(r.charAt(1)==="/"?r=t.protocol+r:r=t.host+r),/^(https?|wss?):\/\//.test(r)||(typeof t<"u"?r=t.protocol+"//"+r:r="https://"+r),n=W0(r)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";const i=n.host.indexOf(":")!==-1?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+i+":"+n.port+e,n.href=n.protocol+"://"+i+(t&&t.port===n.port?"":":"+n.port),n}const Ote=typeof ArrayBuffer=="function",Nte=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r.buffer instanceof ArrayBuffer,kE=Object.prototype.toString,xte=typeof Blob=="function"||typeof Blob<"u"&&kE.call(Blob)==="[object BlobConstructor]",$te=typeof File=="function"||typeof File<"u"&&kE.call(File)==="[object FileConstructor]";function X2(r){return Ote&&(r instanceof ArrayBuffer||Nte(r))||xte&&r instanceof Blob||$te&&r instanceof File}function Wl(r,e){if(!r||typeof r!="object")return!1;if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(Wl(r[t]))return!0;return!1}if(X2(r))return!0;if(r.toJSON&&typeof r.toJSON=="function"&&arguments.length===1)return Wl(r.toJSON(),!0);for(const t in r)if(Object.prototype.hasOwnProperty.call(r,t)&&Wl(r[t]))return!0;return!1}function Lte(r){const e=[],t=r.data,n=r;return n.data=Y0(t,e),n.attachments=e.length,{packet:n,buffers:e}}function Y0(r,e){if(!r)return r;if(X2(r)){const t={_placeholder:!0,num:e.length};return e.push(r),t}else if(Array.isArray(r)){const t=new Array(r.length);for(let n=0;n<r.length;n++)t[n]=Y0(r[n],e);return t}else if(typeof r=="object"&&!(r instanceof Date)){const t={};for(const n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=Y0(r[n],e));return t}return r}function Mte(r,e){return r.data=Q0(r.data,e),delete r.attachments,r}function Q0(r,e){if(!r)return r;if(r&&r._placeholder===!0){if(typeof r.num=="number"&&r.num>=0&&r.num<e.length)return e[r.num];throw new Error("illegal attachments")}else if(Array.isArray(r))for(let t=0;t<r.length;t++)r[t]=Q0(r[t],e);else if(typeof r=="object")for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(r[t]=Q0(r[t],e));return r}const Ute=5;var oe;(function(r){r[r.CONNECT=0]="CONNECT",r[r.DISCONNECT=1]="DISCONNECT",r[r.EVENT=2]="EVENT",r[r.ACK=3]="ACK",r[r.CONNECT_ERROR=4]="CONNECT_ERROR",r[r.BINARY_EVENT=5]="BINARY_EVENT",r[r.BINARY_ACK=6]="BINARY_ACK"})(oe||(oe={}));let Bte=class{constructor(e){this.replacer=e}encode(e){return(e.type===oe.EVENT||e.type===oe.ACK)&&Wl(e)?this.encodeAsBinary({type:e.type===oe.EVENT?oe.BINARY_EVENT:oe.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===oe.BINARY_EVENT||e.type===oe.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Lte(e),n=this.encodeAsString(t.packet),s=t.buffers;return s.unshift(n),s}},zte=class DE extends st{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===oe.BINARY_EVENT;n||t.type===oe.BINARY_ACK?(t.type=n?oe.EVENT:oe.ACK,this.reconstructor=new Fte(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(X2(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(oe[n.type]===void 0)throw new Error("unknown packet type "+n.type);if(n.type===oe.BINARY_EVENT||n.type===oe.BINARY_ACK){const i=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const o=e.substring(i,t);if(o!=Number(o)||e.charAt(t)!=="-")throw new Error("Illegal attachments");n.attachments=Number(o)}if(e.charAt(t+1)==="/"){const i=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););n.nsp=e.substring(i,t)}else n.nsp="/";const s=e.charAt(t+1);if(s!==""&&Number(s)==s){const i=t+1;for(;++t;){const o=e.charAt(t);if(o==null||Number(o)!=o){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){const i=this.tryParse(e.substr(t));if(DE.isPayloadValid(n.type,i))n.data=i;else throw new Error("invalid payload")}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case oe.CONNECT:return typeof t=="object";case oe.DISCONNECT:return t===void 0;case oe.CONNECT_ERROR:return typeof t=="string"||typeof t=="object";case oe.EVENT:case oe.BINARY_EVENT:return Array.isArray(t)&&t.length>0;case oe.ACK:case oe.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}};class Fte{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=Mte(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Vte=Object.freeze(Object.defineProperty({__proto__:null,Decoder:zte,Encoder:Bte,get PacketType(){return oe},protocol:Ute},Symbol.toStringTag,{value:"Module"}));function Or(r,e,t){return r.on(e,t),function(){r.off(e,t)}}const Kte=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class PE extends st{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[Or(e,"open",this.onopen.bind(this)),Or(e,"packet",this.onpacket.bind(this)),Or(e,"error",this.onerror.bind(this)),Or(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(Kte.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const n={type:oe.EVENT,data:t};if(n.options={},n.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const o=this.ids++,a=t.pop();this._registerAckCallback(o,a),n.id=o}const s=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!s||!this.connected)||(this.connected?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(e,t){var n;const s=(n=this.flags.timeout)!==null&&n!==void 0?n:this._opts.ackTimeout;if(s===void 0){this.acks[e]=t;return}const i=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let o=0;o<this.sendBuffer.length;o++)this.sendBuffer[o].id===e&&this.sendBuffer.splice(o,1);t.call(this,new Error("operation has timed out"))},s);this.acks[e]=(...o)=>{this.io.clearTimeoutFn(i),t.apply(this,[null,...o])}}emitWithAck(e,...t){const n=this.flags.timeout!==void 0||this._opts.ackTimeout!==void 0;return new Promise((s,i)=>{t.push((o,a)=>n?o?i(o):s(a):s(o)),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const n={id:this.ids++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...i)=>n!==this._queue[0]?void 0:(s!==null?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(s)):(this._queue.shift(),t&&t(null,...i)),n.pending=!1,this._drainQueue())),this._queue.push(n),this._drainQueue()}_drainQueue(){if(this._queue.length===0)return;const e=this._queue[0];if(e.pending)return;e.pending=!0,e.tryCount++;const t=this.ids;this.ids=e.id,this.flags=e.flags,this.emit.apply(this,e.args),this.ids=t}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:oe.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case oe.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case oe.EVENT:case oe.BINARY_EVENT:this.onevent(e);break;case oe.ACK:case oe.BINARY_ACK:this.onack(e);break;case oe.DISCONNECT:this.ondisconnect();break;case oe.CONNECT_ERROR:this.destroy();const n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...s){n||(n=!0,t.packet({type:oe.ACK,id:e,data:s}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(t.apply(this,e.data),delete this.acks[e.id])}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:oe.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function Bo(r){r=r||{},this.ms=r.min||100,this.max=r.max||1e4,this.factor=r.factor||2,this.jitter=r.jitter>0&&r.jitter<=1?r.jitter:0,this.attempts=0}Bo.prototype.duration=function(){var r=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*r);r=Math.floor(e*10)&1?r+t:r-t}return Math.min(r,this.max)|0};Bo.prototype.reset=function(){this.attempts=0};Bo.prototype.setMin=function(r){this.ms=r};Bo.prototype.setMax=function(r){this.max=r};Bo.prototype.setJitter=function(r){this.jitter=r};class X0 extends st{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,Td(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((n=t.randomizationFactor)!==null&&n!==void 0?n:.5),this.backoff=new Bo({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const s=t.parser||Vte;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new TE(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const s=Or(t,"open",function(){n.onopen(),e&&e()}),i=Or(t,"error",o=>{n.cleanup(),n._readyState="closed",this.emitReserved("error",o),e?e(o):n.maybeReconnectOnOpen()});if(this._timeout!==!1){const o=this._timeout;o===0&&s();const a=this.setTimeoutFn(()=>{s(),t.close(),t.emit("error",new Error("timeout"))},o);this.opts.autoUnref&&a.unref(),this.subs.push(function(){clearTimeout(a)})}return this.subs.push(s),this.subs.push(i),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(Or(e,"ping",this.onping.bind(this)),Or(e,"data",this.ondata.bind(this)),Or(e,"error",this.onerror.bind(this)),Or(e,"close",this.onclose.bind(this)),Or(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){CE(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n||(n=new PE(this,e,t),this.nsps[e]=n),this._autoConnect&&n.connect(),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t)if(this.nsps[n].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(function(){clearTimeout(n)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const ua={};function Yl(r,e){typeof r=="object"&&(e=r,r=void 0),e=e||{};const t=Pte(r,e.path||"/socket.io"),n=t.source,s=t.id,i=t.path,o=ua[s]&&i in ua[s].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o;let c;return a?c=new X0(n,e):(ua[s]||(ua[s]=new X0(n,e)),c=ua[s]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(Yl,{Manager:X0,Socket:PE,io:Yl,connect:Yl});const El=65536;function jte(r){const e=new Uint8Array(r);let t=0;if(r>0)if(r>El)for(;t<r;)t+El>r?(crypto.getRandomValues(e.subarray(t,t+(r-t))),t+=r-t):(crypto.getRandomValues(e.subarray(t,t+El)),t+=El);else crypto.getRandomValues(e);return e}var J2=jte;const w6=64*1024,Hte=5*1e3;class qte{constructor(e,t){this.label=e.label,this.open=We(),this.channel=e,this.channel.binaryType="arraybuffer",this.log=t.log,typeof this.channel.bufferedAmountLowThreshold=="number"&&(this.channel.bufferedAmountLowThreshold=w6),e.addEventListener("message",s=>{t.onMessage(s)}),e.addEventListener("bufferedamountlow",()=>{this.log("stop backpressure: bufferedAmount %d",this.channel.bufferedAmount),this.open.resolve()}),e.addEventListener("open",()=>{this.open.resolve(),t.onOpen()}),e.addEventListener("close",()=>{t.onClose()}),e.addEventListener("error",s=>{if(s.error?.message==="Transport channel closed")return this.close();t.log.error('channel encounter an error in state "%s" message: "%s" detail: "%s',e.readyState,s.error?.message,s.error?.errorDetail);const i=s.error instanceof Error?s.error:new Error(`datachannel error: ${s.error?.message} ${s.error?.errorDetail}`);t.onError(v(i,"ERR_DATA_CHANNEL"))});let n=!1;this.closingInterval=setInterval(()=>{e.readyState==="closing"?(n&&t.onClose(),n=!0):n=!1},Hte)}async send(e){await this.open.promise,this.channel.send(e),this.channel.bufferedAmount>w6&&(this.log("start backpressure: bufferedAmount %d",this.channel.bufferedAmount),this.open=We())}close(){clearInterval(this.closingInterval),this.channel.close()}get bufferedAmount(){return this.channel.bufferedAmount}}var dc={},Gte={get exports(){return dc},set exports(r){dc=r}};const Wte=(r,e)=>Math.floor(Math.random()*(e-r+1)+r),m6=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},b6=({clearTimeout:r,setTimeout:e,willResolve:t})=>(n,{value:s,signal:i}={})=>{if(i&&i.aborted)return Promise.reject(m6());let o,a,c;const h=r||clearTimeout,l=()=>{h(o),c(m6())},u=()=>{i&&i.removeEventListener("abort",l)},f=new Promise((g,d)=>{a=()=>{u(),t?g(s):d(s)},c=d,o=(e||setTimeout)(a,n)});return i&&i.addEventListener("abort",l,{once:!0}),f.clear=()=>{h(o),o=null,a()},f},OE=r=>{const e=b6({...r,willResolve:!0});return e.reject=b6({...r,willResolve:!1}),e.range=(t,n,s)=>e(Wte(t,n),s),e},Z2=OE();Z2.createWithTimers=OE;Gte.exports=Z2;dc.default=Z2;const Yte={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]};function Qte(){if(typeof globalThis>"u")throw v(new Error("No WebRTC support detected"),"ERR_WEBRTC_SUPPORT");const r={RTCPeerConnection:globalThis.RTCPeerConnection??globalThis.mozRTCPeerConnection??globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription??globalThis.mozRTCSessionDescription??globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate??globalThis.mozRTCIceCandidate??globalThis.webkitRTCIceCandidate};if(r.RTCPeerConnection==null)throw v(new Error("No WebRTC support detected"),"ERR_WEBRTC_SUPPORT");return r}class NE extends Fe{constructor(e){super(),this.id=e.id??B(J2(4),"hex").slice(0,7),this.log=P(`libp2p:webrtc-peer:${e.logPrefix}:${this.id}`),this.wrtc=e.wrtc??Qte(),this.peerConnection=new this.wrtc.RTCPeerConnection(Object.assign({},Yte,e.peerConnectionConfig)),this.closed=!1,this.connected=We(),this.source=Bt(),this.sink=async t=>{if(await this.connected.promise,this.channel==null)throw v(new Error("Connected but no channel?!"),"ERR_DATA_CHANNEL");for await(const n of t)await this.channel.send(n);await this.close()}}handleDataChannelEvent(e){const t=e.channel;if(t==null){this.close(v(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL")).catch(n=>{this.log("Error closing after event channel was found to be null",n)});return}this.channel=new qte(t,{log:this.log,onMessage:n=>{this.source.push(new Uint8Array(n.data))},onOpen:()=>{this.connected.resolve(),this.dispatchEvent(new F("ready"))},onClose:()=>{this.close().catch(n=>{this.log("error closing connection after channel close",n)})},onError:n=>{this.close(n).catch(s=>{this.log("error closing connection after channel error",s)})}})}async close(e){if(this.closed=!0,e==null&&this.channel!=null)for(;this.channel.bufferedAmount>0;)await dc(100);this.channel?.close(),this.peerConnection.close(),this.source.end(e),this.dispatchEvent(new F("close"))}}class xE extends Fe{constructor(e){super(),this.log=e.log,this.peerConnection=e.peerConnection,this.wrtc=e.wrtc,this.status="idle",this.peerConnection.addEventListener("negotiationneeded",()=>{this.log("peer connection negotiation needed"),this.handleRenegotiate({type:"renegotiate"}).catch(t=>{this.log.error("could not renegotiate %o",t)})})}async handleSignal(e){if(this.log('incoming signal "%s"',e.type),e.type==="offer")return await this.handleOffer(e);if(e.type==="answer")return await this.handleAnswer(e);if(e.type==="candidate")return await this.handleCandidate(e);if(e.type==="renegotiate")return await this.handleRenegotiate(e);if(e.type==="goodbye")return await this.handleGoodye(e);this.log(`Unknown signal type ${e.type}`)}async handleOffer(e){}async handleAnswer(e){}async handleRenegotiate(e){}async handleGoodye(e){this.peerConnection.close()}async handleCandidate(e){const t=new this.wrtc.RTCIceCandidate(e.candidate);try{await this.peerConnection.addIceCandidate(t)}catch(n){if(t.address==null||t.address.endsWith(".local"))this.log("ignoring unsupported ICE candidate.");else throw v(n,"ERR_ADD_ICE_CANDIDATE")}}}const E6=P("libp2p:webrtc-peer:receiver");class Xte extends NE{constructor(e={}){super({...e,logPrefix:"receiver"}),this.handshake=new Jte({log:this.log,peerConnection:this.peerConnection,wrtc:this.wrtc,answerOptions:e.answerOptions}),this.handshake.addEventListener("signal",t=>this.dispatchEvent(new F("signal",{detail:t.detail}))),this.peerConnection.addEventListener("datachannel",t=>{this.handleDataChannelEvent(t)})}handleSignal(e){this.handshake.handleSignal(e).catch(t=>{this.log("error handling signal %o %o",e,t)})}}class Jte extends xE{constructor(e){super(e),this.options=e,this.status="idle",this.iceCandidates=[]}async handleRenegotiate(){E6.trace("renegotiate"),this.dispatchEvent(new F("signal",{detail:{type:"renegotiate"}}))}async handleOffer(e){await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(e));for(const n of this.iceCandidates)await this.handleCandidate(n);this.iceCandidates=[];const t=await this.peerConnection.createAnswer(this.options.answerOptions);await this.peerConnection.setLocalDescription(t),E6.trace("handle offer",this.peerConnection.localDescription),this.dispatchEvent(new F("signal",{detail:this.peerConnection.localDescription??t}))}async handleCandidate(e){if(this.peerConnection.remoteDescription==null||this.peerConnection.remoteDescription.type==null){this.iceCandidates.push(e);return}await super.handleCandidate(e)}}const Zte=r=>{const e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function ere(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");const a=[e].flat(),c=[],{addListener:h,removeListener:l}=Zte(r),u=(...g)=>{const d=t.multiArgs?g:g[0];t.filter&&!t.filter(d)||(c.push(d),t.count===c.length&&(n(),i(c)))},f=g=>{n(),o(g)};n=()=>{for(const g of a)l(g,u);for(const g of t.rejectionEvents)l(g,f)};for(const g of a)h(g,u);for(const g of t.rejectionEvents)h(g,f);t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=Iv(s,t.timeout);return i.cancel=n,i}return s}function tre(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=ere(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}const Kf=P("libp2p:webrtc-peer:initator"),rre=1e3;class nre extends NE{constructor(e={}){super({...e,logPrefix:"initiator"}),this.handleDataChannelEvent({channel:this.peerConnection.createDataChannel(e.dataChannelLabel??B(J2(20),"hex").slice(0,7),e.dataChannelInit)}),this.handshake=new sre({log:this.log,peerConnection:this.peerConnection,wrtc:this.wrtc,offerOptions:e.offerOptions}),this.handshake.addEventListener("signal",t=>{this.dispatchEvent(new F("signal",{detail:t.detail}))})}handleSignal(e){this.handshake.handleSignal(e).catch(t=>{this.log("error handling signal %o %o",e,t)})}}class sre extends xE{constructor(e){super(e),this.options=e,this.status="idle",this.peerConnection.addEventListener("icecandidate",t=>{if(t.candidate==null)return;const n={type:"candidate",candidate:{candidate:t.candidate.candidate,sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid}};Kf.trace("create candidate",n),this.dispatchEvent(new F("signal",{detail:n})),this.dispatchEvent(new F("ice-candidate"))})}async handleRenegotiate(){if(this.status==="negotiating"){this.log("already negotiating, queueing");return}this.status="negotiating";const e=await this.peerConnection.createOffer(this.options.offerOptions);await this.peerConnection.setLocalDescription(e),await tre(this,"ice-candidate"),await dc(rre),Kf.trace("renegotiate",this.peerConnection.localDescription),this.dispatchEvent(new F("signal",{detail:this.peerConnection.localDescription??e}))}async handleAnswer(e){Kf.trace("handle answer",e),await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(e)),this.status="idle"}}const jf=P("libp2p:webrtc-star:socket");function $E(r,e){const{sink:t,source:n}=r,s={remoteAddr:e.remoteAddr,async sink(i){e.signal!=null&&(i=Zt(i,e.signal));try{await t(i)}catch(o){o.type!=="aborted"&&jf.error(o)}},source:e.signal!=null?Zt(n,e.signal):n,timeline:{open:Date.now()},async close(){if(r.closed)return;const i=Date.now(),o=setTimeout(()=>{if(s.remoteAddr!=null){const{host:a,port:c}=s.remoteAddr.toOptions();jf("timeout closing socket to %s:%s after %dms, destroying it manually",a,c,Date.now()-i)}r.closed||r.close().catch(a=>{jf.error("could not close socket",a)})},tte);try{await r.close()}finally{clearTimeout(o)}}};return r.addEventListener("close",()=>{s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}function LE(r){const e=r.toString().split("/"),t=r.protos()[1].name,n=r.protos()[2].name,s=r.stringTuples()[1][1];if(t!=="tcp"||n!=="ws"&&n!=="wss")throw new Error(`invalid multiaddr: ${r.toString()}`);if(!Cv(r))return`http://${e[2]}:${e[4]}`;if(n==="ws")return`http://${e[2]}${s==null||s==="80"?"":`:${s}`}`;if(n==="wss")return`https://${e[2]}${s==null||s==="443"?"":`:${s}`}`;throw new Error("invalid multiaddr: "+r.toString())}function ire(r){const e="/libp2p-webrtc-star";if(r.startsWith(e)){r=r.substring(e.length,r.length);let t=G(r);const n=t.stringTuples().filter(s=>s[0]===421)[0];if(n[1]==null)throw new Error("invalid multiaddr: "+r);t=t.decapsulate("p2p"),t=t.encapsulate("/p2p-webrtc-star"),t=t.encapsulate(`/p2p/${n[1]}`),r=t.toString()}return r}const Lt=P("libp2p:webrtc-star:listener"),ore={transports:["websocket"],path:"/socket.io-next/"};class are extends Fe{constructor(e,t,n,s,i){super(),this.signallingAddr=t,this.socket=Yl(e,ore),this.connections=[],this.channels=new Map,this.pendingSignals=new Map,this.upgrader=n,this.handler=s,this.channelOptions=i,this.handleWsHandshake=this.handleWsHandshake.bind(this);let o=!1;this.socket.on("connect_error",a=>{o&&a.type==="TransportError"||this.dispatchEvent(new F("error",{detail:a}))}),this.socket.on("error",a=>{this.dispatchEvent(new F("error",{detail:a}))}),this.socket.on("ws-handshake",this.handleWsHandshake),this.socket.on("ws-peer",a=>{this.dispatchEvent(new F("peer",{detail:a}))}),this.socket.on("connect",()=>{this.socket.emit("ss-join",this.signallingAddr.toString()),o&&this.dispatchEvent(new F("reconnect"))}),this.socket.once("connect",()=>{o=!0,this.dispatchEvent(new F("listening"))}),this.socket.on("disconnect",()=>{this.dispatchEvent(new F("disconnect"))})}_createChannel(e,t,n){const s={...this.channelOptions},i=new Xte(s),o=a=>{const c=a.detail;Lt.error("incoming connection errored",c)};return i.addEventListener("error",o),i.addEventListener("close",()=>{i.removeEventListener("error",o)},{once:!0}),i.addEventListener("signal",a=>{const c=a.detail;this.socket.emit("ss-handshake",{intentId:e,srcMultiaddr:t,dstMultiaddr:n,answer:!0,signal:c})}),i.addEventListener("ready",()=>{const a=$E(i,{remoteAddr:this.signallingAddr});Lt("new inbound connection %s",a.remoteAddr);try{this.upgrader.upgradeInbound(a).then(c=>{Lt("inbound connection %s upgraded",a.remoteAddr),this.connections.push(a);const h=()=>{this.connections=this.connections.filter(l=>l!==a),this.channels.delete(e),this.pendingSignals.delete(e)};i.addEventListener("close",h,{once:!0}),this.dispatchEvent(new F("connection",{detail:c})),this.handler(c)}).catch(c=>{Lt.error("inbound connection failed to upgrade",c),a.close().catch(h=>{Lt.error("inbound connection failed to close after failing to upgrade",h)})})}catch(c){Lt.error("inbound connection failed to upgrade",c),a.close().catch(h=>{Lt.error("inbound connection failed to close after failing to upgrade",h)})}},{once:!0}),i}handleWsHandshake(e){if(Lt('incoming handshake. signal type "%s" is answer %s',e.signal.type,e.answer),e.answer===!0||e.err!=null||e.intentId==null)return;const t=e.intentId;let n=this.pendingSignals.get(t);n==null&&(n=[],this.pendingSignals.set(t,n)),n.push(e);let s=this.channels.get(t);if(s==null){if(e.signal.type!=="offer"){Lt("handshake is not an offer and channel does not exist, buffering until we receive an offer");return}Lt("creating new channel to handle offer handshake"),s=this._createChannel(e.intentId,e.srcMultiaddr,e.dstMultiaddr),this.channels.set(t,s)}else Lt("channel already exists, using it to handle handshake");for(;n.length>0;){const i=n.shift();i?.signal!=null&&s.handleSignal(i.signal)}}async close(){this.socket.emit("ss-leave",this.signallingAddr.toString()),this.socket.removeAllListeners(),this.socket.close(),await Promise.all([...this.connections.map(async e=>await e.close()),...Array.from(this.channels.values()).map(async e=>await e.close())]),this.dispatchEvent(new F("close"))}}class cre extends Fe{constructor(e,t,n,s,i){super(),this.upgrader=e,this.handler=t,this.peerId=n,this.transport=s,this.options=i}async listen(e){if(this.listeningAddr!=null)throw v(new Error("listener already in use"),"ERR_ALREADY_LISTENING");const t=We();this.listeningAddr=e;let n;e.protoCodes().includes(c6)?n=e:n=e.encapsulate(`/p2p/${this.peerId.toString()}`);const s=this.signallingUrl=LE(e);Lt("connecting to signalling server on: %s",this.signallingUrl);const i=new are(this.signallingUrl,n,this.upgrader,this.handler,this.options.channelOptions);return i.addEventListener("error",o=>{const a=o.detail;Lt("error connecting to signalling server %o",a),i.close().catch(c=>{Lt.error("error closing server after error",c)}),t.reject(a)}),i.addEventListener("listening",()=>{Lt("connected to signalling server"),this.dispatchEvent(new F("listening")),t.resolve()}),i.addEventListener("peer",o=>{this.transport.peerDiscovered(o.detail)}),i.addEventListener("connection",o=>{const a=o.detail;if(a.remoteAddr==null)try{a.remoteAddr=e.decapsulateCode(c6).encapsulate(`/p2p/${a.remotePeer.toString()}`)}catch(c){Lt.error("could not determine remote address",c)}this.dispatchEvent(new F("connection",{detail:a}))}),i.addEventListener("disconnect",()=>{this.transport.sigServers.delete(s)}),i.addEventListener("reconnect",()=>{this.transport.sigServers.set(s,i)}),this.transport.sigServers.set(this.signallingUrl,i),await t.promise}async close(){if(this.signallingUrl!=null){const e=this.transport.sigServers.get(this.signallingUrl);e!=null&&(await e.close(),this.transport.sigServers.delete(this.signallingUrl))}this.dispatchEvent(new F("close")),this.listeningAddr=void 0}getAddrs(){return this.listeningAddr!=null?[this.listeningAddr]:[]}}function lre(r,e,t,n,s){return new cre(r,e,t,n,s)}const eg=Symbol.for("@libp2p/transport");var lo;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(lo||(lo={}));const Mc=Symbol.for("@libp2p/peer-discovery"),hre="RTCPeerConnection"in globalThis,ri=P("libp2p:webrtc-star"),ure=()=>{};class dre extends Fe{constructor(){super(...arguments),this.started=!1}get[Mc](){return!0}get[Symbol.toStringTag](){return"@libp2p/webrtc-star-discovery"}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}dispatchEvent(e){return this.isStarted()?super.dispatchEvent(e):!1}}class fre{constructor(e){e?.wrtc!=null&&(this.wrtc=e.wrtc),this.sigServers=new Map,this._discovery=new dre,this.discovery=()=>this._discovery,this.peerDiscovered=this.peerDiscovered.bind(this)}get[eg](){return!0}get[Symbol.toStringTag](){return"@libp2p/webrtc-star"}async dial(e,t){const n=await this._connect(e,t),s=$E(n,{remoteAddr:e,signal:t.signal});ri("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s);return ri("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){if(t.signal?.aborted===!0)throw new nh;const n={...t.channelOptions??{}};this.wrtc!=null&&(n.wrtc=this.wrtc);const s=e.toOptions(),i=B(J2(36),"hex");return await new Promise((o,a)=>{const c=this.sigServers.get(LE(e));if(c?.socket==null)return a(v(new Error("unknown signal server to use"),"ERR_UNKNOWN_SIGNAL_SERVER"));let h=!1;ri("dialing %s:%s",s.host,s.port);const l=new nre(n),u=p=>{const w=p.detail;if(!h){const y=`connection error ${s.host}:${s.port}: ${w.message}`;ri.error(y),d(w)}},f=()=>{h=!0,ri("connection opened %s:%s",s.host,s.port),d()},g=()=>{ri.error("connection aborted %s:%s",s.host,s.port),l.close().finally(()=>{d(new nh)})},d=p=>{l.removeEventListener("ready",f),t.signal?.removeEventListener("abort",g),p==null?o(l):a(p)};l.addEventListener("ready",f,{once:!0}),l.addEventListener("close",()=>{l.removeEventListener("error",u)}),t.signal?.addEventListener("abort",g),l.addEventListener("signal",p=>{const w=p.detail;c.socket.emit("ss-handshake",{intentId:i,srcMultiaddr:c.signallingAddr.toString(),dstMultiaddr:e.toString(),signal:w})}),c.socket.on("ws-handshake",p=>{p.intentId===i&&p.err!=null&&l.close().finally(()=>{a(v(new Error(p.err),"ERR_SIGNALLING_FAILED"))}),!(p.intentId!==i||p.answer==null||l.closed)&&l.handleSignal(p.signal)})})}createListener(e){if(!hre&&this.wrtc==null)throw v(new Error("no WebRTC support"),"ERR_NO_WEBRTC_SUPPORT");if(e.channelOptions=e.channelOptions??{},this.wrtc!=null&&(e.channelOptions.wrtc=this.wrtc),this.peerId==null)throw v(new Error("PeerId not set"),"ERR_MISSING_PEER_ID");return lre(e.upgrader,e.handler??ure,this.peerId,this,e)}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>t.protoCodes().includes(ete)?!1:Up.matches(t))}peerDiscovered(e){ri("peer discovered: %s",e),e=ire(e);const t=G(e),n=t.getPeerId();if(n==null)return;const s=Z(n);this._discovery.dispatchEvent(new F("peer",{detail:{id:s,multiaddrs:[t],protocols:[]}}))}}function pre(r={}){const e=new fre(r);return{transport:t=>(e.peerId=t.peerId,e),discovery:e.discovery}}function gre(){const r=pre();return{transports:[r.transport],peerDiscovery:[r.discovery],connectionManager:{maxParallelDials:150,maxDialsPerPeer:4,dialTimeout:1e4,autoDial:!0},nat:{enabled:!1}}}function ii(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}var we;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.DHT_DISABLED="DHT is not available",r.PUBSUB_DISABLED="PubSub is not available",r.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",r.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",r.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",r.NOT_FOUND="Not found"})(we||(we={}));var k;(function(r){r.DHT_DISABLED="ERR_DHT_DISABLED",r.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",r.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",r.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",r.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",r.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",r.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",r.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",r.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",r.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",r.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",r.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",r.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",r.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",r.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",r.ERR_DIALED_SELF="ERR_DIALED_SELF",r.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",r.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",r.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",r.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",r.ERR_INVALID_KEY="ERR_INVALID_KEY",r.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_PEER="ERR_INVALID_PEER",r.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",r.ERR_NOT_FOUND="ERR_NOT_FOUND",r.ERR_TIMEOUT="ERR_TIMEOUT",r.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",r.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",r.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",r.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",r.ERR_FIND_SELF="ERR_FIND_SELF",r.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",r.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",r.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",r.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",r.ERR_INVALID_CMS="ERR_INVALID_CMS",r.ERR_MISSING_KEYS="ERR_MISSING_KEYS",r.ERR_NO_KEY="ERR_NO_KEY",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",r.ERR_INVALID_RECORD="ERR_INVALID_RECORD",r.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",r.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED"})(k||(k={}));async function*J0(r,e){yield*zt(r,async t=>(await e.addressBook.add(t.id,t.multiaddrs),t))}function ME(r){const e=new Set;return $e(r,t=>e.has(t.id.toString())?!1:(e.add(t.id.toString()),!0))}async function*UE(r,e=1){let t=0;for await(const n of r)t++,yield n;if(t<e)throw v(new Error("not found"),"NOT_FOUND")}const ho=new Map,yre=()=>`${Date.now()}:${Math.floor(Math.random()*1e6)}`;async function wre(r,e,t){for(;ho.get(t);){try{await r()}catch(n){setTimeout(()=>{throw n},1);break}if(!ho.get(t))break;await new Promise(n=>{const s=setTimeout(n,e);ho.set(t,s)})}}function mre(r,e,t){t=t||e;const n=yre(),s=setTimeout(()=>{wre(r,e,n)},t);return ho.set(n,s),n}function bre(r){const e=ho.get(r);e&&(clearTimeout(e),ho.delete(r))}var _u={setDelayedInterval:mre,clearDelayedInterval:bre};const _6=P("libp2p:peer-routing");class Ere{constructor(e,t){this.components=e,this.routers=t.routers??[],this.refreshManagerInit=t.refreshManager??{},this.started=!1,this._findClosestPeersTask=this._findClosestPeersTask.bind(this)}isStarted(){return this.started}async start(){this.started||this.routers.length===0||this.timeoutId!=null||this.refreshManagerInit.enabled===!1||(this.timeoutId=_u.setDelayedInterval(this._findClosestPeersTask,this.refreshManagerInit.interval,this.refreshManagerInit.bootDelay),this.started=!0)}async _findClosestPeersTask(){if(this.abortController==null)try{this.abortController=new ze.TimeoutController(this.refreshManagerInit.timeout??1e4);try{Ce.setMaxListeners?.(1/0,this.abortController.signal)}catch{}await ot(this.getClosestPeers(this.components.peerId.toBytes(),{signal:this.abortController.signal}))}catch(e){_6.error(e)}finally{this.abortController?.clear(),this.abortController=void 0}}async stop(){_u.clearDelayedInterval(this.timeoutId),this.abortController?.abort(),this.started=!1}async findPeer(e,t){if(this.routers.length===0)throw v(new Error("No peer routers available"),k.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw v(new Error("Should not try to find self"),k.ERR_FIND_SELF);const n=await ie(Yt(...this.routers.map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(i){_6.error(i)}}())),s=>$e(s,Boolean),s=>J0(s,this.components.peerStore),async s=>await Rr(s));if(n!=null)return n;throw v(new Error(we.NOT_FOUND),k.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(this.routers.length===0)throw v(new Error("No peer routers available"),k.ERR_NO_ROUTERS_AVAILABLE);yield*ie(Yt(...this.routers.map(n=>n.getClosestPeers(e,t))),n=>J0(n,this.components.peerStore),n=>ME(n),n=>UE(n))}}class _re{constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw v(new Error("No content this.routers available"),k.ERR_NO_ROUTERS_AVAILABLE);yield*ie(Yt(...this.routers.map(n=>n.findProviders(e,t))),n=>J0(n,this.components.peerStore),n=>ME(n),n=>UE(n))}async provide(e,t={}){if(this.routers.length===0)throw v(new Error("No content routers available"),k.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>await n.provide(e,t)))}async put(e,t,n){if(!this.isStarted())throw v(new Error(we.NOT_STARTED_YET),k.DHT_NOT_STARTED);const s=this.components.dht;s!=null&&await ot(s.put(e,t,n))}async get(e,t){if(!this.isStarted())throw v(new Error(we.NOT_STARTED_YET),k.DHT_NOT_STARTED);const n=this.components.dht;if(n!=null){for await(const s of n.get(e,t))if(s.name==="VALUE")return s.value}throw v(new Error(we.NOT_FOUND),k.ERR_NOT_FOUND)}async*getMany(e,t,n){if(!this.isStarted())throw v(new Error(we.NOT_STARTED_YET),k.DHT_NOT_STARTED);if(t==null||t===0)return;let s=0;const i=this.components.dht;if(i!=null){for await(const o of i.get(e,n))if(o.name==="VALUE"&&(yield{from:o.from,val:o.value},s++,s===t))break}if(s===0)throw v(new Error(we.NOT_FOUND),k.ERR_NOT_FOUND)}}const vre=r=>r;class Sre extends Fe{constructor(e,t){super();const{listen:n=[],announce:s=[]}=t;this.components=e,this.listen=n.map(i=>i.toString()),this.announce=new Set(s.map(i=>i.toString())),this.observed=new Set,this.announceFilter=t.announceFilter??vre}getListenAddrs(){return Array.from(this.listen).map(e=>G(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>G(e))}getObservedAddrs(){return Array.from(this.observed).map(e=>G(e))}confirmObservedAddr(e){}removeObservedAddr(e){}addObservedAddr(e){let t=G(e);const n=t.getPeerId();n!=null&&Z(n).equals(this.components.peerId)&&(t=t.decapsulate(G(`/p2p/${this.components.peerId.toString()}`)));const s=t.toString();this.observed.has(s)||(this.observed.add(s),this.dispatchEvent(new F("change:addresses")))}getAddresses(){let e=this.getAnnounceAddrs().map(n=>n.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(n=>n.toString())),e=e.concat(this.getObservedAddrs().map(n=>n.toString()));const t=new Set(e);return this.announceFilter(Array.from(t).map(n=>G(n))).map(n=>n.protos().pop()?.path===!0||n.getPeerId()===this.components.peerId.toString()?n:n.encapsulate(`/p2p/${this.components.peerId.toString()}`))}}const v6=P("libp2p:connection-manager:latency-monitor:visibility-change-emitter");class Rre extends Fe{constructor(){super(),this.hidden="hidden",this.visibilityChange="visibilityChange",globalThis.document!=null&&(this._initializeVisibilityVarNames(),this._addVisibilityChangeListener())}_initializeVisibilityVarNames(){let e="hidden",t="visibilitychange";typeof globalThis.document.hidden<"u"?(e="hidden",t="visibilitychange"):typeof globalThis.document.mozHidden<"u"?(e="mozHidden",t="mozvisibilitychange"):typeof globalThis.document.msHidden<"u"?(e="msHidden",t="msvisibilitychange"):typeof globalThis.document.webkitHidden<"u"&&(e="webkitHidden",t="webkitvisibilitychange"),this.hidden=e,this.visibilityChange=t}_addVisibilityChangeListener(){typeof globalThis.document.addEventListener>"u"||typeof document[this.hidden]>"u"?v6("Checking page visibility requires a browser that supports the Page Visibility API."):globalThis.document.addEventListener(this.visibilityChange,this._handleVisibilityChange.bind(this),!1)}isVisible(){if(!(this.hidden===void 0||document[this.hidden]===void 0))return document[this.hidden]==null}_handleVisibilityChange(){const e=globalThis.document[this.hidden]===!1;v6(e?"Page Visible":"Page Hidden"),this.dispatchEvent(new F("visibilityChange",{detail:e}))}}const _n=P("libp2p:connection-manager:latency-monitor");class Are extends Fe{constructor(e={}){super();const{latencyCheckIntervalMs:t,dataEmitIntervalMs:n,asyncTestFn:s,latencyRandomPercentage:i}=e;this.latencyCheckIntervalMs=t??500,this.latencyRandomPercentage=i??10,this.latencyCheckMultiply=2*(this.latencyRandomPercentage/100)*this.latencyCheckIntervalMs,this.latencyCheckSubtract=this.latencyCheckMultiply/2,this.dataEmitIntervalMs=n===null||n===0?void 0:n??5*1e3,_n("latencyCheckIntervalMs: %s dataEmitIntervalMs: %s",this.latencyCheckIntervalMs,this.dataEmitIntervalMs),this.dataEmitIntervalMs!=null?_n("Expecting ~%s events per summary",this.latencyCheckIntervalMs/this.dataEmitIntervalMs):_n("Not emitting summaries"),this.asyncTestFn=s,globalThis.process?.hrtime!=null?(_n("Using process.hrtime for timing"),this.now=globalThis.process.hrtime,this.getDeltaMS=o=>{const a=this.now(o);return a[0]*1e3+a[1]/1e6}):typeof window<"u"&&window.performance?.now!=null?(_n("Using performance.now for timing"),this.now=window.performance.now.bind(window.performance),this.getDeltaMS=o=>Math.round(this.now()-o)):(_n("Using Date.now for timing"),this.now=Date.now,this.getDeltaMS=o=>this.now()-o),this.latencyData=this.initLatencyData()}start(){Ire()&&(this.visibilityChangeEmitter=new Rre,this.visibilityChangeEmitter.addEventListener("visibilityChange",e=>{const{detail:t}=e;t?this._startTimers():(this._emitSummary(),this._stopTimers())})),this.visibilityChangeEmitter?.isVisible()===!0&&this._startTimers()}stop(){this._stopTimers()}_startTimers(){this.checkLatencyID==null&&(this.checkLatency(),this.dataEmitIntervalMs!=null&&(this.emitIntervalID=setInterval(()=>this._emitSummary(),this.dataEmitIntervalMs),typeof this.emitIntervalID.unref=="function"&&this.emitIntervalID.unref()))}_stopTimers(){this.checkLatencyID!=null&&(clearTimeout(this.checkLatencyID),this.checkLatencyID=void 0),this.emitIntervalID!=null&&(clearInterval(this.emitIntervalID),this.emitIntervalID=void 0)}_emitSummary(){const e=this.getSummary();e.events>0&&this.dispatchEvent(new F("data",{detail:e}))}getSummary(){const e={events:this.latencyData.events,minMs:this.latencyData.minMs,maxMs:this.latencyData.maxMs,avgMs:this.latencyData.events>0?this.latencyData.totalMs/this.latencyData.events:Number.POSITIVE_INFINITY,lengthMs:this.getDeltaMS(this.latencyData.startTime)};return this.latencyData=this.initLatencyData(),_n.trace("Summary: %O",e),e}checkLatency(){const e=Math.random()*this.latencyCheckMultiply-this.latencyCheckSubtract,t={deltaOffset:Math.ceil(this.latencyCheckIntervalMs+e),startTime:this.now()},n=()=>{if(this.checkLatencyID==null)return;const s=this.getDeltaMS(t.startTime)-t.deltaOffset;this.checkLatency(),this.latencyData.events++,this.latencyData.minMs=Math.min(this.latencyData.minMs,s),this.latencyData.maxMs=Math.max(this.latencyData.maxMs,s),this.latencyData.totalMs+=s,_n.trace("MS: %s Data: %O",s,this.latencyData)};_n.trace("localData: %O",t),this.checkLatencyID=setTimeout(()=>{this.asyncTestFn!=null?(t.deltaOffset=0,t.startTime=this.now(),this.asyncTestFn(n)):(t.deltaOffset-=1,n())},t.deltaOffset),typeof this.checkLatencyID.unref=="function"&&this.checkLatencyID.unref()}initLatencyData(){return{startTime:this.now(),minMs:Number.POSITIVE_INFINITY,maxMs:Number.NEGATIVE_INFINITY,events:0,totalMs:0}}}function Ire(){return typeof globalThis.window<"u"}const BE="OPEN",S6="CLOSING",Hf="CLOSED";function vu(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}class Cre{constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return vu(this.map.entries(),e=>[Z(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,Z(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return vu(this.map.keys(),e=>Z(e))}values(){return this.map.values()}get size(){return this.map.size}}class Vs{constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return vu(this.set.entries(),e=>{const t=Z(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=Z(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return vu(this.set.values(),e=>Z(e))}intersection(e){const t=new Vs;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new Vs;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new Vs;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}const Tre="keep-alive";function zE(r){if(Mn(r))return{peerId:r};if(Ln(r)){const e=r.getPeerId();return{multiaddr:r,peerId:e==null?void 0:Z(e)}}throw v(new Error(`${r} is not a PeerId or a Multiaddr`),k.ERR_INVALID_MULTIADDR)}const Ze=P("libp2p:connection-manager"),kre={maxConnections:1/0,minConnections:0,maxEventLoopDelay:1/0,pollInterval:2e3,autoDialInterval:1e4,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},Dre=6e4;class Pre extends Fe{constructor(e,t){if(super(),this.opts=Ue.call({ignoreUndefined:!0},kre,t),this.opts.maxConnections<this.opts.minConnections)throw v(new Error("Connection Manager maxConnections must be greater than minConnections"),k.ERR_INVALID_PARAMETERS);Ze("options: %o",this.opts),this.components=e,this.connections=new Map,this.started=!1,t.maxEventLoopDelay!=null&&t.maxEventLoopDelay>0&&t.maxEventLoopDelay!==1/0&&(this.latencyMonitor=new Are({latencyCheckIntervalMs:t.pollInterval,dataEmitIntervalMs:t.pollInterval}));try{Ce.setMaxListeners?.(1/0,this)}catch{}this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.startupReconnectTimeout=t.startupReconnectTimeout??Dre,this.dialTimeout=t.dialTimeout??3e4,this.allow=(t.allow??[]).map(n=>G(n)),this.deny=(t.deny??[]).map(n=>G(n)),this.inboundConnectionRateLimiter=new gm.RateLimiterMemory({points:this.opts.inboundConnectionThreshold,duration:1}),this.incomingPendingConnections=0}isStarted(){return this.started}async start(){this.components.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)n.stat.direction==="inbound"?e.inbound++:e.outbound++;return e}}),this.components.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.stat.direction} ${s.stat.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.components.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const a=`${o.stat.direction} ${o.stat.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.latencyMonitor?.start(),this._onLatencyMeasure=this._onLatencyMeasure.bind(this),this.latencyMonitor?.addEventListener("data",this._onLatencyMeasure),this.started=!0,Ze("started")}async afterStart(){this.components.upgrader.addEventListener("connection",this.onConnect),this.components.upgrader.addEventListener("connectionEnd",this.onDisconnect),Promise.resolve().then(async()=>{const e=[];for(const t of await this.components.peerStore.all())(await this.components.peerStore.getTags(t.id)).filter(i=>i.name===Tre).length>0&&e.push(t.id);this.connectOnStartupController?.clear(),this.connectOnStartupController=new ze.TimeoutController(this.startupReconnectTimeout);try{Ce.setMaxListeners?.(1/0,this.connectOnStartupController.signal)}catch{}await Promise.all(e.map(async t=>{await this.openConnection(t,{signal:this.connectOnStartupController?.signal}).catch(n=>{Ze.error(n)})}))}).catch(e=>{Ze.error(e)}).finally(()=>{this.connectOnStartupController?.clear()})}async beforeStop(){this.connectOnStartupController?.abort(),this.components.upgrader.removeEventListener("connection",this.onConnect),this.components.upgrader.removeEventListener("connectionEnd",this.onDisconnect)}async stop(){this.latencyMonitor?.removeEventListener("data",this._onLatencyMeasure),this.latencyMonitor?.stop(),this.started=!1,await this._close(),Ze("stopped")}async _close(){const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(s){Ze.error(s)}})());Ze("closing %d connections",e.length),await Promise.all(e),this.connections.clear()}onConnect(e){this._onConnect(e).catch(t=>{Ze.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}const n=t.remotePeer,s=n.toString(),i=this.connections.get(s);i!=null?i.push(t):this.connections.set(s,[t]),n.publicKey!=null&&await this.components.peerStore.keyBook.set(n,n.publicKey);const o=this.getConnections().length,a=o-this.opts.maxConnections;await this._checkMaxLimit("maxConnections",o,a),this.dispatchEvent(new F("peer:connect",{detail:t}))}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer.toString();let s=this.connections.get(n);s!=null&&s.length>1?(s=s.filter(i=>i.id!==t.id),this.connections.set(n,s)):s!=null&&(this.connections.delete(n),this.dispatchEvent(new F("peer:disconnect",{detail:t})))}getConnections(e){if(e!=null)return this.connections.get(e.toString())??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}async openConnection(e,t={}){const{peerId:n,multiaddr:s}=zE(e);if(n==null&&s==null)throw v(new TypeError("Can only open connections to PeerIds or Multiaddrs"),k.ERR_INVALID_PARAMETERS);if(n!=null){Ze("dial to",n);const o=this.getConnections(n);if(o.length>0)return Ze("had an existing connection to %p",n),o[0]}let i;if(t?.signal==null){i=new ze.TimeoutController(this.dialTimeout),t.signal=i.signal;try{Ce.setMaxListeners?.(1/0,i.signal)}catch{}}try{const o=await this.components.dialer.dial(e,t);let a=this.connections.get(o.remotePeer.toString());a==null&&(a=[],this.connections.set(o.remotePeer.toString(),a));let c=!1;for(const h of a)h.id===o.id&&(c=!0);return c||a.push(o),o}finally{i?.clear()}}async closeConnections(e){const t=this.connections.get(e.toString())??[];await Promise.all(t.map(async n=>await n.close()))}getAll(e){if(!Mn(e))throw v(new Error("peerId must be an instance of peer-id"),k.ERR_INVALID_PARAMETERS);const t=e.toString(),n=this.connections.get(t);return n!=null?n.filter(s=>s.stat.status===BE):[]}_onLatencyMeasure(e){const{detail:t}=e;this._checkMaxLimit("maxEventLoopDelay",t.avgMs,1).catch(n=>{Ze.error(n)})}async _checkMaxLimit(e,t,n=1){const s=this.opts[e];if(s==null){Ze.trace("limit %s was not set so it cannot be applied",e);return}Ze.trace("checking limit of %s. current value: %d of %d",e,t,s),t>s&&(Ze("%s: limit exceeded: %p, %d/%d, pruning %d connection(s)",this.components.peerId,e,t,s,n),await this._pruneConnections(n))}async _pruneConnections(e){const t=this.getConnections(),n=new Cre;for(const o of t){const a=o.remotePeer;if(n.has(a))continue;const c=await this.components.peerStore.getTags(a);n.set(a,c.reduce((h,l)=>h+l.value,0))}const s=t.sort((o,a)=>{const c=n.get(o.remotePeer)??0,h=n.get(a.remotePeer)??0;if(c>h)return 1;if(c<h)return-1;const l=o.stat.timeline.open,u=a.stat.timeline.open;return l<u?1:l>u?-1:0}),i=[];for(const o of s)if(Ze("too many connections open - closing a connection to %p",o.remotePeer),i.push(o),i.length===e)break;await Promise.all(i.map(async o=>{try{await o.close()}catch(a){Ze.error(a)}this.onDisconnect(new F("connectionEnd",{detail:o}))}))}async acceptIncomingConnection(e){if(this.deny.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return Ze("connection from %s refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.opts.maxIncomingPendingConnections)return Ze("connection from %s refused - incomingPendingConnections exceeded by peer %s",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return Ze("connection from %s refused - inboundConnectionThreshold exceeded by host %s",s,e.remoteAddr),!1}}return this.getConnections().length<this.opts.maxConnections?(this.incomingPendingConnections++,!0):(Ze("connection from %s refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}}const cs=P("libp2p:connection-manager:auto-dialler"),Ore={enabled:!0,minConnections:0,autoDialInterval:1e4};class Nre{constructor(e,t){this.components=e,this.options=Ue.call({ignoreUndefined:!0},Ore,t),this.running=!1,this._autoDial=this._autoDial.bind(this),cs("options: %j",this.options)}isStarted(){return this.running}async start(){if(!this.options.enabled){cs("not enabled");return}this.running=!0,this._autoDial().catch(e=>{cs.error("could start autodial",e)}),cs("started")}async stop(){if(!this.options.enabled){cs("not enabled");return}this.running=!1,this.autoDialTimeout!=null&&this.autoDialTimeout.clear(),cs("stopped")}async _autoDial(){this.autoDialTimeout!=null&&this.autoDialTimeout.clear();const e=this.options.minConnections;if(this.components.connectionManager.getConnections().length>=e){this.autoDialTimeout=v1(this._autoDial,this.options.autoDialInterval);return}const t=await this.components.peerStore.all(),n=await ie(t.sort(()=>Math.random()>.5?1:-1),s=>$e(s,i=>!i.id.equals(this.components.peerId)),s=>iu(s,(i,o)=>o.protocols.length>i.protocols.length||o.id.publicKey!=null&&i.id.publicKey==null?1:-1),async s=>await Kn(s));for(let s=0;this.running&&s<n.length&&this.components.connectionManager.getConnections().length<e;s++){if(!this.running)return;const i=n[s];if(this.components.connectionManager.getConnections(i.id).length===0){cs("connecting to a peerStore stored peer %p",i.id);try{await this.components.connectionManager.openConnection(i.id)}catch(o){cs.error("could not connect to peerStore stored peer",o)}}}this.running&&(this.autoDialTimeout=v1(this._autoDial,this.options.autoDialInterval))}}var se;(function(r){(function(s){s.SUCCESS="SUCCESS",s.HOP_SRC_ADDR_TOO_LONG="HOP_SRC_ADDR_TOO_LONG",s.HOP_DST_ADDR_TOO_LONG="HOP_DST_ADDR_TOO_LONG",s.HOP_SRC_MULTIADDR_INVALID="HOP_SRC_MULTIADDR_INVALID",s.HOP_DST_MULTIADDR_INVALID="HOP_DST_MULTIADDR_INVALID",s.HOP_NO_CONN_TO_DST="HOP_NO_CONN_TO_DST",s.HOP_CANT_DIAL_DST="HOP_CANT_DIAL_DST",s.HOP_CANT_OPEN_DST_STREAM="HOP_CANT_OPEN_DST_STREAM",s.HOP_CANT_SPEAK_RELAY="HOP_CANT_SPEAK_RELAY",s.HOP_CANT_RELAY_TO_SELF="HOP_CANT_RELAY_TO_SELF",s.STOP_SRC_ADDR_TOO_LONG="STOP_SRC_ADDR_TOO_LONG",s.STOP_DST_ADDR_TOO_LONG="STOP_DST_ADDR_TOO_LONG",s.STOP_SRC_MULTIADDR_INVALID="STOP_SRC_MULTIADDR_INVALID",s.STOP_DST_MULTIADDR_INVALID="STOP_DST_MULTIADDR_INVALID",s.STOP_RELAY_REFUSED="STOP_RELAY_REFUSED",s.MALFORMED_MESSAGE="MALFORMED_MESSAGE"})(r.Status||(r.Status={}));let e;(function(s){s[s.SUCCESS=100]="SUCCESS",s[s.HOP_SRC_ADDR_TOO_LONG=220]="HOP_SRC_ADDR_TOO_LONG",s[s.HOP_DST_ADDR_TOO_LONG=221]="HOP_DST_ADDR_TOO_LONG",s[s.HOP_SRC_MULTIADDR_INVALID=250]="HOP_SRC_MULTIADDR_INVALID",s[s.HOP_DST_MULTIADDR_INVALID=251]="HOP_DST_MULTIADDR_INVALID",s[s.HOP_NO_CONN_TO_DST=260]="HOP_NO_CONN_TO_DST",s[s.HOP_CANT_DIAL_DST=261]="HOP_CANT_DIAL_DST",s[s.HOP_CANT_OPEN_DST_STREAM=262]="HOP_CANT_OPEN_DST_STREAM",s[s.HOP_CANT_SPEAK_RELAY=270]="HOP_CANT_SPEAK_RELAY",s[s.HOP_CANT_RELAY_TO_SELF=280]="HOP_CANT_RELAY_TO_SELF",s[s.STOP_SRC_ADDR_TOO_LONG=320]="STOP_SRC_ADDR_TOO_LONG",s[s.STOP_DST_ADDR_TOO_LONG=321]="STOP_DST_ADDR_TOO_LONG",s[s.STOP_SRC_MULTIADDR_INVALID=350]="STOP_SRC_MULTIADDR_INVALID",s[s.STOP_DST_MULTIADDR_INVALID=351]="STOP_DST_MULTIADDR_INVALID",s[s.STOP_RELAY_REFUSED=390]="STOP_RELAY_REFUSED",s[s.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE"})(e||(e={})),function(s){s.codec=()=>fo(e)}(r.Status||(r.Status={})),function(s){s.HOP="HOP",s.STOP="STOP",s.STATUS="STATUS",s.CAN_HOP="CAN_HOP"}(r.Type||(r.Type={}));let t;(function(s){s[s.HOP=1]="HOP",s[s.STOP=2]="STOP",s[s.STATUS=3]="STATUS",s[s.CAN_HOP=4]="CAN_HOP"})(t||(t={})),function(s){s.codec=()=>fo(t)}(r.Type||(r.Type={})),function(s){let i;s.codec=()=>(i==null&&(i=Qe((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),(c.writeDefaults===!0||o.id!=null&&o.id.byteLength>0)&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const h of o.addrs)a.uint32(18),a.bytes(h);c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={id:new Uint8Array(0),addrs:[]},h=a==null?o.len:o.pos+a;for(;o.pos<h;){const l=o.uint32();switch(l>>>3){case 1:c.id=o.bytes();break;case 2:c.addrs.push(o.bytes());break;default:o.skipType(l&7);break}}return c})),i),s.encode=o=>Xe(o,s.codec()),s.decode=o=>Je(o,s.codec())}(r.Peer||(r.Peer={}));let n;r.codec=()=>(n==null&&(n=Qe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.Type.codec().encode(s.type,i)),s.srcPeer!=null&&(i.uint32(18),r.Peer.codec().encode(s.srcPeer,i,{writeDefaults:!1})),s.dstPeer!=null&&(i.uint32(26),r.Peer.codec().encode(s.dstPeer,i,{writeDefaults:!1})),s.code!=null&&(i.uint32(32),r.Status.codec().encode(s.code,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(s);break;case 2:o.srcPeer=r.Peer.codec().decode(s,s.uint32());break;case 3:o.dstPeer=r.Peer.codec().decode(s,s.uint32());break;case 4:o.code=r.Status.codec().decode(s);break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>Xe(s,r.codec()),r.decode=s=>Je(s,r.codec())})(se||(se={}));const xre=P("libp2p:stream:converter");function R6(r,e={}){const{stream:t,remoteAddr:n}=r,{sink:s,source:i}=t,o=async function*(){for await(const h of i)yield*h}(),a={async sink(h){e.signal!=null&&(h=Zt(h,e.signal));try{await s(h),await c()}catch(l){l.type!=="aborted"&&xre(l)}},source:e.signal!=null?Zt(o,e.signal):o,remoteAddr:n,timeline:{open:Date.now(),close:void 0},async close(){await s(async function*(){yield new Uint8Array(0)}()),await c()}};async function c(){return a.timeline.close==null&&(a.timeline.close=Date.now()),await Promise.resolve()}return a}const So="/libp2p/circuit/relay/0.1.0";function $re(r){const e=new Map;async function t(i){const o=i.toString().split("/p2p-circuit").find(f=>f!==""),a=G(o),c=a.getPeerId();if(c==null)throw new Error("Could not determine relay peer from multiaddr");const h=Z(c);await r.peerStore.addressBook.add(h,[a]);const l=await r.connectionManager.openConnection(h),u=l.remoteAddr.encapsulate("/p2p-circuit");e.set(l.remotePeer.toString(),u),s.dispatchEvent(new F("listening"))}function n(){const i=[];for(const o of e.values())i.push(o);return i}const s=Object.assign(new Fe,{close:async()=>await Promise.resolve(),listen:t,getAddrs:n});return r.connectionManager.addEventListener("peer:disconnect",i=>{const{detail:o}=i;e.delete(o.remotePeer.toString())&&s.dispatchEvent(new F("close"))}),s}function A6(r,e){r.write({type:se.Type.STATUS,code:e})}function FE(r,e){try{r.dstPeer?.addrs!=null&&r.dstPeer.addrs.forEach(t=>G(t))}catch(t){throw A6(e,r.type===se.Type.HOP?se.Status.HOP_DST_MULTIADDR_INVALID:se.Status.STOP_DST_MULTIADDR_INVALID),t}try{r.srcPeer?.addrs!=null&&r.srcPeer.addrs.forEach(t=>G(t))}catch(t){throw A6(e,r.type===se.Type.HOP?se.Status.HOP_SRC_MULTIADDR_INVALID:se.Status.STOP_SRC_MULTIADDR_INVALID),t}}function kd(r){const e=Bt(),t=jL(r.source),n=We();let s;const i=r.sink(async function*(){yield*e,yield*await n.promise}());return i.catch(a=>{s=a}),{reader:t,writer:e,stream:{sink:async a=>s!=null?await Promise.reject(s):(n.resolve(a),await i),source:t},rest:()=>e.end(),write:e.push,read:async()=>{const a=await t.next();if(a.value!=null)return a.value}}}const da=P("libp2p:circuit:stream-handler");class Dd{constructor(e){const{stream:t,maxLength:n=4096}=e;this.stream=t,this.shake=kd(this.stream),this.decoder=er.fromReader(this.shake.reader,{maxDataLength:n})}async read(){const e=await this.decoder.next();if(e.value!=null){const t=se.decode(e.value);return da("read message type",t.type),t}da("read received no value, closing stream"),this.close()}write(e){da("write message type %s",e.type),this.shake.write(ar.single(se.encode(e)))}rest(){return this.shake.rest(),this.shake.stream}end(e){this.write(e),this.close()}close(){da("closing the stream"),this.rest().sink([]).catch(e=>{da.error(e)})}}const Va=P("libp2p:circuit:stop");function Lre(r){const{connection:e,request:t,streamHandler:n}=r;try{FE(t,n)}catch(s){Va.error("invalid stop request via peer %p %o",e.remotePeer,s);return}return Va("stop request is valid"),n.write({type:se.Type.STATUS,code:se.Status.SUCCESS}),n.rest()}async function Mre(r){const{connection:e,request:t,signal:n}=r,s=await e.newStream(So,{signal:n});Va("starting stop request to %p",e.remotePeer);const i=new Dd({stream:s});i.write(t);const o=await i.read();if(o==null){i.close();return}if(o.code===se.Status.SUCCESS)return Va("stop request to %p was successful",e.remotePeer),i.rest();Va("stop request failed with code %d",o.code),i.close()}const gr=P("libp2p:circuit:hop");async function Ure(r){const{connection:e,request:t,streamHandler:n,circuit:s,connectionManager:i}=r;if(!s.hopEnabled())return gr("HOP request received but we are not acting as a relay"),n.end({type:se.Type.STATUS,code:se.Status.HOP_CANT_SPEAK_RELAY});try{FE(t,n)}catch(u){gr.error("invalid hop request via peer %p %o",e.remotePeer,u);return}if(t.dstPeer==null){gr("HOP request received but we do not receive a dstPeer");return}const o=Fr(t.dstPeer.id),a=i.getConnections(o);if(a.length===0&&!s.hopActive())return gr("HOP request received but we are not connected to the destination peer"),n.end({type:se.Type.STATUS,code:se.Status.HOP_NO_CONN_TO_DST});if(a.length===0)return gr("did not have connection to remote peer"),n.end({type:se.Type.STATUS,code:se.Status.HOP_NO_CONN_TO_DST});const c={type:se.Type.STOP,dstPeer:t.dstPeer,srcPeer:t.srcPeer};let h;try{gr("performing STOP request");const u=await Mre({connection:a[0],request:c});if(u==null)throw new Error("Could not stop");h=u}catch(u){gr.error(u);return}gr("hop request from %p is valid",e.remotePeer),n.write({type:se.Type.STATUS,code:se.Status.SUCCESS});const l=n.rest();return gr("creating related connections"),await ie(l,h,l)}async function Bre(r){const{connection:e,request:t,signal:n}=r,s=await e.newStream(So,{signal:n}),i=new Dd({stream:s});i.write(t);const o=await i.read();if(o==null)throw v(new Error("HOP request had no response"),k.ERR_HOP_REQUEST_FAILED);if(o.code===se.Status.SUCCESS)return gr("hop request was successful"),i.rest();throw gr("hop request failed with code %d, closing stream",o.code),i.close(),v(new Error(`HOP request failed with code "${o.code??"unknown"}"`),k.ERR_HOP_REQUEST_FAILED)}async function zre(r){const{connection:e,signal:t}=r,n=await e.newStream(So,{signal:t}),s=new Dd({stream:n});s.write({type:se.Type.CAN_HOP});const i=await s.read();return await s.close(),!(i==null||i.code!==se.Status.SUCCESS)}function Fre(r){const{connection:e,streamHandler:t,circuit:n}=r,s=n.hopEnabled();gr("can hop (%s) request from %p",s,e.remotePeer),t.end({type:se.Type.STATUS,code:s?se.Status.SUCCESS:se.Status.HOP_CANT_SPEAK_RELAY})}const dr=P("libp2p:circuit");class Vre{constructor(e,t){this._init=t,this.components=e,this._started=!1}isStarted(){return this._started}async start(){this._started||(this._started=!0,await this.components.registrar.handle(So,e=>{this._onProtocol(e).catch(t=>{dr.error(t)})},{...this._init}).catch(e=>{dr.error(e)}))}async stop(){await this.components.registrar.unhandle(So)}hopEnabled(){return!0}hopActive(){return!0}get[eg](){return!0}get[Symbol.toStringTag](){return"libp2p/circuit-relay-v1"}async _onProtocol(e){const{connection:t,stream:n}=e,s=new ze.TimeoutController(this._init.hop.timeout);try{Ce.setMaxListeners?.(1/0,s.signal)}catch{}try{const i=sn(n,s.signal),o=new Dd({stream:{...n,...i}}),a=await o.read();if(a==null){dr("request was invalid, could not read from stream"),o.write({type:se.Type.STATUS,code:se.Status.MALFORMED_MESSAGE}),o.close();return}let c;switch(a.type){case se.Type.CAN_HOP:{dr("received CAN_HOP request from %p",t.remotePeer),await Fre({circuit:this,connection:t,streamHandler:o});break}case se.Type.HOP:{dr("received HOP request from %p",t.remotePeer),await Ure({connection:t,request:a,streamHandler:o,circuit:this,connectionManager:this.components.connectionManager});break}case se.Type.STOP:{dr("received STOP request from %p",t.remotePeer),c=await Lre({connection:t,request:a,streamHandler:o});break}default:{dr("Request of type %s not supported",a.type),o.write({type:se.Type.STATUS,code:se.Status.MALFORMED_MESSAGE}),o.close();return}}if(c!=null){const h=t.remoteAddr.encapsulate("/p2p-circuit").encapsulate(G(a.dstPeer?.addrs[0])),l=G(a.srcPeer?.addrs[0]),u=R6({stream:c,remoteAddr:h,localAddr:l}),f=a.type===se.Type.HOP?"relay":"inbound";dr("new %s connection %s",f,u.remoteAddr);const g=await this.components.upgrader.upgradeInbound(u);dr("%s connection %s upgraded",f,u.remoteAddr),this.handler!=null&&this.handler(g)}}finally{s.clear()}}async dial(e,t={}){const n=e.toString().split("/p2p-circuit"),s=G(n[0]),i=G(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const g="Circuit relay dial failed as addresses did not have peer id";throw dr.error(g),v(new Error(g),k.ERR_RELAYED_DIAL)}const c=Z(o),h=Z(a);let l=!1,f=this.components.connectionManager.getConnections(c)[0];f==null&&(await this.components.peerStore.addressBook.add(c,[s]),f=await this.components.connectionManager.openConnection(c,t),l=!0);try{const g=await Bre({...t,connection:f,request:{type:se.Type.HOP,srcPeer:{id:this.components.peerId.toBytes(),addrs:this.components.addressManager.getAddresses().map(w=>w.bytes)},dstPeer:{id:h.toBytes(),addrs:[G(i).bytes]}}}),d=s.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),p=R6({stream:g,remoteAddr:e,localAddr:d});return dr("new outbound connection %s",p.remoteAddr),await this.components.upgrader.upgradeOutbound(p)}catch(g){throw dr.error("Circuit relay dial failed",g),l&&await f.close(),g}}createListener(e){return this.handler=e.handler,$re({connectionManager:this.components.connectionManager,peerStore:this.components.peerStore})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Gi.matches(t))}}var Kre=VE,I6=128,jre=127,Hre=~jre,qre=Math.pow(2,31);function VE(r,e,t){e=e||[],t=t||0;for(var n=t;r>=qre;)e[t++]=r&255|I6,r/=128;for(;r&Hre;)e[t++]=r&255|I6,r>>>=7;return e[t]=r|0,VE.bytes=t-n+1,e}var Gre=Z0,Wre=128,C6=127;function Z0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Z0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&C6)<<s:(o&C6)*Math.pow(2,s),s+=7}while(o>=Wre);return Z0.bytes=i-n,t}var Yre=Math.pow(2,7),Qre=Math.pow(2,14),Xre=Math.pow(2,21),Jre=Math.pow(2,28),Zre=Math.pow(2,35),ene=Math.pow(2,42),tne=Math.pow(2,49),rne=Math.pow(2,56),nne=Math.pow(2,63),sne=function(r){return r<Yre?1:r<Qre?2:r<Xre?3:r<Jre?4:r<Zre?5:r<ene?6:r<tne?7:r<rne?8:r<nne?9:10},ine={encode:Kre,decode:Gre,encodingLength:sne},Su=ine;const ep=(r,e=0)=>[Su.decode(r,e),Su.decode.bytes],Ru=(r,e,t=0)=>(Su.encode(r,e,t),e),Au=r=>Su.encodingLength(r),one=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},tg=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},tp=(r,e)=>{const t=e.byteLength,n=Au(r),s=n+Au(t),i=new Uint8Array(s+t);return Ru(r,i,0),Ru(t,i,n),i.set(e,s),new rg(r,t,e,i)},ane=r=>{const e=tg(r),[t,n]=ep(e),[s,i]=ep(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new rg(t,s,o,e)},cne=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&one(r.bytes,t.bytes)}};let rg=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function lne(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var hne=lne,une=hne;let dne=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},fne=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return KE(this,e)}},pne=class{constructor(e){this.decoders=e}or(e){return KE(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const KE=(r,e)=>new pne({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let gne=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new dne(e,t,n),this.decoder=new fne(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const jE=({name:r,prefix:e,encode:t,decode:n})=>new gne(r,e,t,n),HE=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=une(t,e);return jE({prefix:r,name:e,encode:n,decode:i=>tg(s(i))})},yne=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},wne=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Zn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>jE({prefix:e,name:r,encode(s){return wne(s,n,t)},decode(s){return yne(s,n,t,r)}}),Rs=HE({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});HE({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Ql=Zn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Zn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Zn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Zn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Zn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Zn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Zn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Zn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Zn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const T6=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Ene(t,rp(r),e||Rs.encoder);default:return _ne(t,rp(r),e||Ql.encoder)}},k6=new WeakMap,rp=r=>{const e=k6.get(r);if(e==null){const t=new Map;return k6.set(r,t),t}return e};let mne=class Nt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==fa)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==vne)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Nt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=tp(e,t);return Nt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Nt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&cne(e.multihash,n.multihash)}toString(e){return T6(this,e)}toJSON(){return{"/":T6(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Nt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Nt(n,s,i,o||D6(n,s,i.bytes))}else if(t[Sne]===!0){const{version:n,multihash:s,code:i}=t,o=ane(s);return Nt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==fa)throw new Error(`Version 0 CID must use dag-pb (code: ${fa}) block encoding`);return new Nt(e,t,n,n.bytes)}case 1:{const s=D6(e,t,n.bytes);return new Nt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Nt.create(0,fa,e)}static createV1(e,t){return Nt.create(1,e,t)}static decode(e){const[t,n]=Nt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Nt.inspectBytes(e),n=t.size-t.multihashSize,s=tg(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new rg(t.multihashCode,t.digestSize,i,s);return[t.version===0?Nt.createV0(o):Nt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=ep(e.subarray(t));return t+=f,u};let s=n(),i=fa;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=bne(e,t),i=Nt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return rp(i).set(n,e),i}};const bne=(r,e)=>{switch(r[0]){case"Q":{const t=e||Rs;return[Rs.prefix,t.decode(`${Rs.prefix}${r}`)]}case Rs.prefix:{const t=e||Rs;return[Rs.prefix,t.decode(r)]}case Ql.prefix:{const t=e||Ql;return[Ql.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Ene=(r,e,t)=>{const{prefix:n}=t;if(n!==Rs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},_ne=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},fa=112,vne=18,D6=(r,e,t)=>{const n=Au(r),s=n+Au(e),i=new Uint8Array(s+t.byteLength);return Ru(r,i,0),Ru(e,i,n),i.set(t,s),i},Sne=Symbol.for("@ipld/js-cid/CID"),qE=({name:r,code:e,encode:t})=>new Rne(r,e,t);let Rne=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?tp(this.code,t):t.then(n=>tp(this.code,n))}else throw Error("Unknown type, must be binary type")}};const GE=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Ane=qE({name:"sha2-256",code:18,encode:GE("SHA-256")});qE({name:"sha2-512",code:19,encode:GE("SHA-512")});async function WE(r){const e=new TextEncoder().encode(r),t=await Ane.digest(e);return mne.createV0(t)}const YE=60*1e3,Ine=15*YE,Cne=30*YE,Tne=290,P6="hop_relay",O6="true",QE="/libp2p/relay";var XE;(function(){var r,e,t,n,s,i,o,a;a=function(c){var h,l,u,f;return h=(c&255<<24)>>>24,l=(c&255<<16)>>>16,u=(c&255<<8)>>>8,f=c&255,[h,l,u,f].join(".")},o=function(c){var h,l,u,f,g,d;for(h=[],u=f=0;f<=3&&c.length!==0;u=++f){if(u>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}d=e(c),g=d[0],l=d[1],c=c.substring(l),h.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(h.length){case 1:if(h[0]>4294967295)throw new Error("Invalid IP");return h[0]>>>0;case 2:if(h[0]>255||h[1]>16777215)throw new Error("Invalid IP");return(h[0]<<24|h[1])>>>0;case 3:if(h[0]>255||h[1]>255||h[2]>65535)throw new Error("Invalid IP");return(h[0]<<24|h[1]<<16|h[2])>>>0;case 4:if(h[0]>255||h[1]>255||h[2]>255||h[3]>255)throw new Error("Invalid IP");return(h[0]<<24|h[1]<<16|h[2]<<8|h[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var h,l,u,f,g;for(f=0,h=10,l="9",u=0,c.length>1&&c[u]==="0"&&(c[u+1]==="x"||c[u+1]==="X"?(u+=2,h=16):"0"<=c[u+1]&&c[u+1]<="9"&&(u++,h=8,l="7")),g=u;u<c.length;){if("0"<=c[u]&&c[u]<=l)f=f*h+(t(c[u])-n)>>>0;else if(h===16)if("a"<=c[u]&&c[u]<="f")f=f*h+(10+t(c[u])-i)>>>0;else if("A"<=c[u]&&c[u]<="F")f=f*h+(10+t(c[u])-s)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");u++}if(u===g)throw new Error("empty octet");return[f,u]},r=function(){function c(h,l){var u,f,g;if(typeof h!="string")throw new Error("Missing `net' parameter");if(l||(g=h.split("/",2),h=g[0],l=g[1]),l||(l=32),typeof l=="string"&&l.indexOf(".")>-1){try{this.maskLong=o(l)}catch{throw new Error("Invalid mask: "+l)}for(u=f=32;f>=0;u=--f)if(this.maskLong===4294967295<<32-u>>>0){this.bitmask=u;break}}else if(l||l===0)this.bitmask=parseInt(l,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(h)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+h)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+l);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(h){return typeof h=="string"&&(h.indexOf("/")>0||h.split(".").length!==4)&&(h=new c(h)),h instanceof c?this.contains(h.base)&&this.contains(h.broadcast||h.last):(o(h)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(h){return h==null&&(h=1),new c(a(this.netLong+this.size*h),this.mask)},c.prototype.forEach=function(h){var l,u,f;for(f=o(this.first),u=o(this.last),l=0;f<=u;)h(a(f),f,l),l++,f++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),XE=r}).call(Xr);const N6="[a-fA-F\\d:]",xs=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${N6})|(?<=${N6})(?=\\s|$))`:"",Nr="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",et="[a-fA-F\\d]{1,4}",Pd=`
(?:
(?:${et}:){7}(?:${et}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${et}:){6}(?:${Nr}|:${et}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${et}:){5}(?::${Nr}|(?::${et}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${et}:){4}(?:(?::${et}){0,1}:${Nr}|(?::${et}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${et}:){3}(?:(?::${et}){0,2}:${Nr}|(?::${et}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${et}:){2}(?:(?::${et}){0,3}:${Nr}|(?::${et}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${et}:){1}(?:(?::${et}){0,4}:${Nr}|(?::${et}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${et}){0,5}:${Nr}|(?::${et}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),kne=new RegExp(`(?:^${Nr}$)|(?:^${Pd}$)`),Dne=new RegExp(`^${Nr}$`),Pne=new RegExp(`^${Pd}$`),ng=r=>r&&r.exact?kne:new RegExp(`(?:${xs(r)}${Nr}${xs(r)})|(?:${xs(r)}${Pd}${xs(r)})`,"g");ng.v4=r=>r&&r.exact?Dne:new RegExp(`${xs(r)}${Nr}${xs(r)}`,"g");ng.v6=r=>r&&r.exact?Pne:new RegExp(`${xs(r)}${Pd}${xs(r)}`,"g");var np={},One={get exports(){return np},set exports(r){np=r}};(function(r){(function(e){const t="(0?\\d+|0x[a-f0-9]+)",n={fourOctet:new RegExp(`^${t}\\.${t}\\.${t}\\.${t}$`,"i"),threeOctet:new RegExp(`^${t}\\.${t}\\.${t}$`,"i"),twoOctet:new RegExp(`^${t}\\.${t}$`,"i"),longValue:new RegExp(`^${t}$`,"i")},s=new RegExp("^0[0-7]+$","i"),i=new RegExp("^0x[a-f0-9]+$","i"),o="%[0-9a-z]{1,}",a="(?:[0-9a-f]+::?)+",c={zoneIndex:new RegExp(o,"i"),native:new RegExp(`^(::)?(${a})?([0-9a-f]+)?(::)?(${o})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${t}\\.${t}\\.${t}\\.${t}(${o})?)$`,"i"),transitional:new RegExp(`^((?:${a})|(?:::)(?:${a})?)${t}\\.${t}\\.${t}\\.${t}(${o})?$`,"i")};function h(d,p){if(d.indexOf("::")!==d.lastIndexOf("::"))return null;let w=0,y=-1,_=(d.match(c.zoneIndex)||[])[0],m,b;for(_&&(_=_.substring(1),d=d.replace(/%.+$/,""));(y=d.indexOf(":",y+1))>=0;)w++;if(d.substr(0,2)==="::"&&w--,d.substr(-2,2)==="::"&&w--,w>p)return null;for(b=p-w,m=":";b--;)m+="0:";return d=d.replace("::",m),d[0]===":"&&(d=d.slice(1)),d[d.length-1]===":"&&(d=d.slice(0,-1)),p=function(){const S=d.split(":"),A=[];for(let E=0;E<S.length;E++)A.push(parseInt(S[E],16));return A}(),{parts:p,zoneId:_}}function l(d,p,w,y){if(d.length!==p.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let _=0,m;for(;y>0;){if(m=w-y,m<0&&(m=0),d[_]>>m!==p[_]>>m)return!1;y-=w,_+=1}return!0}function u(d){if(i.test(d))return parseInt(d,16);if(d[0]==="0"&&!isNaN(parseInt(d[1],10))){if(s.test(d))return parseInt(d,8);throw new Error(`ipaddr: cannot parse ${d} as octal`)}return parseInt(d,10)}function f(d,p){for(;d.length<p;)d=`0${d}`;return d}const g={};g.IPv4=function(){function d(p){if(p.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let w,y;for(w=0;w<p.length;w++)if(y=p[w],!(0<=y&&y<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=p}return d.prototype.SpecialRanges={unspecified:[[new d([0,0,0,0]),8]],broadcast:[[new d([255,255,255,255]),32]],multicast:[[new d([224,0,0,0]),4]],linkLocal:[[new d([169,254,0,0]),16]],loopback:[[new d([127,0,0,0]),8]],carrierGradeNat:[[new d([100,64,0,0]),10]],private:[[new d([10,0,0,0]),8],[new d([172,16,0,0]),12],[new d([192,168,0,0]),16]],reserved:[[new d([192,0,0,0]),24],[new d([192,0,2,0]),24],[new d([192,88,99,0]),24],[new d([198,51,100,0]),24],[new d([203,0,113,0]),24],[new d([240,0,0,0]),4]]},d.prototype.kind=function(){return"ipv4"},d.prototype.match=function(p,w){let y;if(w===void 0&&(y=p,p=y[0],w=y[1]),p.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return l(this.octets,p.octets,8,w)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,w=!1;const y={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0};let _,m,b;for(_=3;_>=0;_-=1)if(m=this.octets[_],m in y){if(b=y[m],w&&b!==0)return null;b!==8&&(w=!0),p+=b}else return null;return 32-p},d.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){return this.octets.slice(0)},d.prototype.toIPv4MappedAddress=function(){return g.IPv6.parse(`::ffff:${this.toString()}`)},d.prototype.toNormalizedString=function(){return this.toString()},d.prototype.toString=function(){return this.octets.join(".")},d}(),g.IPv4.broadcastAddressFromCIDR=function(d){try{const p=this.parseCIDR(d),w=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[];let m=0;for(;m<4;)_.push(parseInt(w[m],10)|parseInt(y[m],10)^255),m++;return new this(_)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.isIPv4=function(d){return this.parser(d)!==null},g.IPv4.isValid=function(d){try{return new this(this.parser(d)),!0}catch{return!1}},g.IPv4.isValidFourPartDecimal=function(d){return!!(g.IPv4.isValid(d)&&d.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},g.IPv4.networkAddressFromCIDR=function(d){let p,w,y,_,m;try{for(p=this.parseCIDR(d),y=p[0].toByteArray(),m=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[],w=0;w<4;)_.push(parseInt(y[w],10)&parseInt(m[w],10)),w++;return new this(_)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.parse=function(d){const p=this.parser(d);if(p===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(p)},g.IPv4.parseCIDR=function(d){let p;if(p=d.match(/^(.+)\/(\d+)$/)){const w=parseInt(p[2]);if(w>=0&&w<=32){const y=[this.parse(p[1]),w];return Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},g.IPv4.parser=function(d){let p,w,y;if(p=d.match(n.fourOctet))return function(){const _=p.slice(1,6),m=[];for(let b=0;b<_.length;b++)w=_[b],m.push(u(w));return m}();if(p=d.match(n.longValue)){if(y=u(p[1]),y>4294967295||y<0)throw new Error("ipaddr: address outside defined range");return function(){const _=[];let m;for(m=0;m<=24;m+=8)_.push(y>>m&255);return _}().reverse()}else return(p=d.match(n.twoOctet))?function(){const _=p.slice(1,4),m=[];if(y=u(_[1]),y>16777215||y<0)throw new Error("ipaddr: address outside defined range");return m.push(u(_[0])),m.push(y>>16&255),m.push(y>>8&255),m.push(y&255),m}():(p=d.match(n.threeOctet))?function(){const _=p.slice(1,5),m=[];if(y=u(_[2]),y>65535||y<0)throw new Error("ipaddr: address outside defined range");return m.push(u(_[0])),m.push(u(_[1])),m.push(y>>8&255),m.push(y&255),m}():null},g.IPv4.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>32)throw new Error("ipaddr: invalid IPv4 prefix length");const p=[0,0,0,0];let w=0;const y=Math.floor(d/8);for(;w<y;)p[w]=255,w++;return y<4&&(p[y]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},g.IPv6=function(){function d(p,w){let y,_;if(p.length===16)for(this.parts=[],y=0;y<=14;y+=2)this.parts.push(p[y]<<8|p[y+1]);else if(p.length===8)this.parts=p;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(y=0;y<this.parts.length;y++)if(_=this.parts[y],!(0<=_&&_<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");w&&(this.zoneId=w)}return d.prototype.SpecialRanges={unspecified:[new d([0,0,0,0,0,0,0,0]),128],linkLocal:[new d([65152,0,0,0,0,0,0,0]),10],multicast:[new d([65280,0,0,0,0,0,0,0]),8],loopback:[new d([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new d([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new d([0,0,0,0,0,65535,0,0]),96],rfc6145:[new d([0,0,0,0,65535,0,0,0]),96],rfc6052:[new d([100,65435,0,0,0,0,0,0]),96],"6to4":[new d([8194,0,0,0,0,0,0,0]),16],teredo:[new d([8193,0,0,0,0,0,0,0]),32],reserved:[[new d([8193,3512,0,0,0,0,0,0]),32]]},d.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},d.prototype.kind=function(){return"ipv6"},d.prototype.match=function(p,w){let y;if(w===void 0&&(y=p,p=y[0],w=y[1]),p.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return l(this.parts,p.parts,16,w)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,w=!1;const y={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0};let _,m;for(let b=7;b>=0;b-=1)if(_=this.parts[b],_ in y){if(m=y[_],w&&m!==0)return null;m!==16&&(w=!0),p+=m}else return null;return 128-p},d.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){let p;const w=[],y=this.parts;for(let _=0;_<y.length;_++)p=y[_],w.push(p>>8),w.push(p&255);return w},d.prototype.toFixedLengthString=function(){const p=function(){const y=[];for(let _=0;_<this.parts.length;_++)y.push(f(this.parts[_].toString(16),4));return y}.call(this).join(":");let w="";return this.zoneId&&(w=`%${this.zoneId}`),p+w},d.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");const p=this.parts.slice(-2),w=p[0],y=p[1];return new g.IPv4([w>>8,w&255,y>>8,y&255])},d.prototype.toNormalizedString=function(){const p=function(){const y=[];for(let _=0;_<this.parts.length;_++)y.push(this.parts[_].toString(16));return y}.call(this).join(":");let w="";return this.zoneId&&(w=`%${this.zoneId}`),p+w},d.prototype.toRFC5952String=function(){const p=/((^|:)(0(:|$)){2,})/g,w=this.toNormalizedString();let y=0,_=-1,m;for(;m=p.exec(w);)m[0].length>_&&(y=m.index,_=m[0].length);return _<0?w:`${w.substring(0,y)}::${w.substring(y+_)}`},d.prototype.toString=function(){return this.toNormalizedString().replace(/((^|:)(0(:|$))+)/,"::")},d}(),g.IPv6.broadcastAddressFromCIDR=function(d){try{const p=this.parseCIDR(d),w=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[];let m=0;for(;m<16;)_.push(parseInt(w[m],10)|parseInt(y[m],10)^255),m++;return new this(_)}catch(p){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${p})`)}},g.IPv6.isIPv6=function(d){return this.parser(d)!==null},g.IPv6.isValid=function(d){if(typeof d=="string"&&d.indexOf(":")===-1)return!1;try{const p=this.parser(d);return new this(p.parts,p.zoneId),!0}catch{return!1}},g.IPv6.networkAddressFromCIDR=function(d){let p,w,y,_,m;try{for(p=this.parseCIDR(d),y=p[0].toByteArray(),m=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[],w=0;w<16;)_.push(parseInt(y[w],10)&parseInt(m[w],10)),w++;return new this(_)}catch(b){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${b})`)}},g.IPv6.parse=function(d){const p=this.parser(d);if(p.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(p.parts,p.zoneId)},g.IPv6.parseCIDR=function(d){let p,w,y;if((w=d.match(/^(.+)\/(\d+)$/))&&(p=parseInt(w[2]),p>=0&&p<=128))return y=[this.parse(w[1]),p],Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},g.IPv6.parser=function(d){let p,w,y,_,m,b;if(y=d.match(c.deprecatedTransitional))return this.parser(`::ffff:${y[1]}`);if(c.native.test(d))return h(d,8);if((y=d.match(c.transitional))&&(b=y[6]||"",p=h(y[1].slice(0,-1)+b,6),p.parts)){for(m=[parseInt(y[2]),parseInt(y[3]),parseInt(y[4]),parseInt(y[5])],w=0;w<m.length;w++)if(_=m[w],!(0<=_&&_<=255))return null;return p.parts.push(m[0]<<8|m[1]),p.parts.push(m[2]<<8|m[3]),{parts:p.parts,zoneId:p.zoneId}}return null},g.IPv6.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>128)throw new Error("ipaddr: invalid IPv6 prefix length");const p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let w=0;const y=Math.floor(d/8);for(;w<y;)p[w]=255,w++;return y<16&&(p[y]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},g.fromByteArray=function(d){const p=d.length;if(p===4)return new g.IPv4(d);if(p===16)return new g.IPv6(d);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},g.isValid=function(d){return g.IPv6.isValid(d)||g.IPv4.isValid(d)},g.parse=function(d){if(g.IPv6.isValid(d))return g.IPv6.parse(d);if(g.IPv4.isValid(d))return g.IPv4.parse(d);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},g.parseCIDR=function(d){try{return g.IPv6.parseCIDR(d)}catch{try{return g.IPv4.parseCIDR(d)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},g.process=function(d){const p=this.parse(d);return p.kind()==="ipv6"&&p.isIPv4MappedAddress()?p.toIPv4Address():p},g.subnetMatch=function(d,p,w){let y,_,m,b;w==null&&(w="unicast");for(_ in p)if(Object.prototype.hasOwnProperty.call(p,_)){for(m=p[_],m[0]&&!(m[0]instanceof Array)&&(m=[m]),y=0;y<m.length;y++)if(b=m[y],d.kind()===b[0].kind()&&d.match.apply(d,b))return _}return w},r.exports?r.exports=g:e.ipaddr=g})(Xr)})(One);const Nne=np,{isValid:xne,parse:$ne}=Nne,Lne=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],Mne=Lne.map(r=>new XE(r));function Une(r){for(let e of Mne)if(e.contains(r))return!0;return!1}function x6(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}const Od=r=>{if(xne(r)){const e=$ne(r);if(e.kind()==="ipv4")return Une(e.toNormalizedString());if(e.kind()==="ipv6")return x6(r)}else if(Tv(r)&&ng.v6().test(r))return x6(r)};function $6(r){const{address:e}=r.nodeAddress();return Boolean(Od(e))}function sg(r,e){const t=$6(r.multiaddr),n=$6(e.multiaddr);return t&&!n?1:!t&&n||r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}const pa=P("libp2p:auto-relay"),Bne=()=>{};class zne{constructor(e,t){this.components=e,this.addressSorter=t.addressSorter??sg,this.maxListeners=t.maxListeners??1,this.listenRelays=new Set,this.onError=t.onError??Bne,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this),this.components.peerStore.addEventListener("change:protocols",n=>{this._onProtocolChange(n).catch(s=>{pa.error(s)})}),this.components.connectionManager.addEventListener("peer:disconnect",this._onPeerDisconnected)}async _onProtocolChange(e){const{peerId:t,protocols:n}=e.detail,s=t.toString();if(n.find(o=>o===So)==null){this.listenRelays.has(s)&&await this._removeListenRelay(s);return}if(!this.listenRelays.has(s))try{const o=this.components.connectionManager.getConnections(t);if(o.length===0)return;const a=o[0];if(a.remoteAddr.protoCodes().includes(Tne)){pa(`relayed connection to ${s} will not be used to hop on`);return}await zre({connection:a})&&(await this.components.peerStore.metadataBook.setValue(t,P6,L(O6)),await this._addListenRelay(a,s))}catch(o){this.onError(o)}}_onPeerDisconnected(e){const s=e.detail.remotePeer.toString();this.listenRelays.has(s)&&this._removeListenRelay(s).catch(i=>{pa.error(i)})}async _addListenRelay(e,t){try{if(this.listenRelays.size>=this.maxListeners)return;const n=await ie(await this.components.peerStore.addressBook.get(e.remotePeer),i=>iu(i,this.addressSorter),async i=>await Kn(i));(await Promise.all(n.map(async i=>{try{let o=i.multiaddr;return o.getPeerId()==null&&(o=o.encapsulate(`/p2p/${e.remotePeer.toString()}`)),o=o.encapsulate("/p2p-circuit"),await this.components.transportManager.listen([o]),!0}catch(o){pa.error("error listening on circuit address",o),this.onError(o)}return!1}))).includes(!0)&&this.listenRelays.add(t)}catch(n){this.onError(n),this.listenRelays.delete(t)}}async _removeListenRelay(e){this.listenRelays.delete(e)&&await this._listenOnAvailableHopRelays([e])}async _listenOnAvailableHopRelays(e=[]){if(this.listenRelays.size>=this.maxListeners)return;const t=[],n=await this.components.peerStore.all();for(const{id:s,metadata:i}of n){const o=s.toString();if(this.listenRelays.has(o)||e.includes(o))continue;const a=i.get(P6);if(a==null||B(a)!==O6)continue;const c=this.components.connectionManager.getConnections(s);if(c.length===0){t.push(s);continue}if(await this._addListenRelay(c[0],o),this.listenRelays.size>=this.maxListeners)return}for(const s of t)if(await this._tryToListenOnRelay(s),this.listenRelays.size>=this.maxListeners)return;try{const s=await WE(QE);for await(const i of this.components.contentRouting.findProviders(s)){if(i.multiaddrs.length===0)continue;const o=i.id;if(!o.equals(this.components.peerId)&&(await this.components.peerStore.addressBook.add(o,i.multiaddrs),await this._tryToListenOnRelay(o),this.listenRelays.size>=this.maxListeners))return}}catch(s){this.onError(s)}}async _tryToListenOnRelay(e){try{const t=await this.components.connectionManager.openConnection(e);await this._addListenRelay(t,e.toString())}catch(t){pa.error("Could not use %p as relay",e,t),this.onError(t,`could not connect and listen on known hop relay ${e.toString()}`)}}}const L6=P("libp2p:relay");class Fne{constructor(e,t){this.components=e,this.autoRelay=t.autoRelay?.enabled!==!1?new zne(e,{addressSorter:t.addressSorter,...t.autoRelay}):void 0,this.started=!1,this.init=t,this._advertiseService=this._advertiseService.bind(this)}isStarted(){return this.started}async start(){this.init.hop.enabled!==!1&&this.init.advertise.enabled!==!1&&(this.timeout=_u.setDelayedInterval(this._advertiseService,this.init.advertise.ttl,this.init.advertise.bootDelay)),this.started=!0}async stop(){this.timeout!=null&&_u.clearDelayedInterval(this.timeout),this.started=!1}async _advertiseService(){try{const e=await WE(QE);await this.components.contentRouting.provide(e)}catch(e){e.code===k.ERR_NO_ROUTERS_AVAILABLE?(L6.error("a content router, such as a DHT, must be provided in order to advertise the relay service",e),await this.stop()):L6.error(e)}}}function Vne(r){return r>=55296&&r<=56319}function Kne(r){return r>=56320&&r<=57343}var jne=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var s=t.length,i=0,o,a,c=0;c<s;c+=1){if(o=t.charCodeAt(c),a=t[c],Vne(o)&&Kne(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t};function Hne(r){return r>=55296&&r<=56319}function qne(r){return r>=56320&&r<=57343}var Gne=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,s=null,i=null,o=0;o<t;o++)s=e.charCodeAt(o),qne(s)?i!=null&&Hne(i)?n+=1:n+=3:s<=127?n+=1:s>=128&&s<=2047?n+=2:s>=2048&&s<=65535&&(n+=3),i=s;return n},Wne=jne,Yne=Gne,Qne=Wne.bind(null,Yne),Xne=Qne,Jne=/[\/\?<>\\:\*\|"]/g,Zne=/[\x00-\x1f\x80-\x9f]/g,ese=/^\.+$/,tse=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,rse=/[\. ]+$/;function M6(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(Jne,e).replace(Zne,e).replace(ese,e).replace(tse,e).replace(rse,e);return Xne(t,255)}var nse=function(r,e){var t=e&&e.replacement||"",n=M6(r,t);return t===""?n:M6(n,"")},Ro=Vt,z=Ro.asn1,zo=Ro.pkcs7asn1=Ro.pkcs7asn1||{};Ro.pkcs7=Ro.pkcs7||{};Ro.pkcs7.asn1=zo;var JE={name:"ContentInfo",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"ContentInfo.ContentType",tagClass:z.Class.UNIVERSAL,type:z.Type.OID,constructed:!1,capture:"contentType"},{name:"ContentInfo.content",tagClass:z.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,captureAsn1:"content"}]};zo.contentInfoValidator=JE;var ZE={name:"EncryptedContentInfo",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentType",tagClass:z.Class.UNIVERSAL,type:z.Type.OID,constructed:!1,capture:"contentType"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentEncryptionAlgorithm.algorithm",tagClass:z.Class.UNIVERSAL,type:z.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm.parameter",tagClass:z.Class.UNIVERSAL,captureAsn1:"encParameter"}]},{name:"EncryptedContentInfo.encryptedContent",tagClass:z.Class.CONTEXT_SPECIFIC,type:0,capture:"encryptedContent",captureAsn1:"encryptedContentAsn1"}]};zo.envelopedDataValidator={name:"EnvelopedData",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"EnvelopedData.Version",tagClass:z.Class.UNIVERSAL,type:z.Type.INTEGER,constructed:!1,capture:"version"},{name:"EnvelopedData.RecipientInfos",tagClass:z.Class.UNIVERSAL,type:z.Type.SET,constructed:!0,captureAsn1:"recipientInfos"}].concat(ZE)};zo.encryptedDataValidator={name:"EncryptedData",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedData.Version",tagClass:z.Class.UNIVERSAL,type:z.Type.INTEGER,constructed:!1,capture:"version"}].concat(ZE)};var sse={name:"SignerInfo",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.version",tagClass:z.Class.UNIVERSAL,type:z.Type.INTEGER,constructed:!1},{name:"SignerInfo.issuerAndSerialNumber",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.issuerAndSerialNumber.issuer",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,captureAsn1:"issuer"},{name:"SignerInfo.issuerAndSerialNumber.serialNumber",tagClass:z.Class.UNIVERSAL,type:z.Type.INTEGER,constructed:!1,capture:"serial"}]},{name:"SignerInfo.digestAlgorithm",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.digestAlgorithm.algorithm",tagClass:z.Class.UNIVERSAL,type:z.Type.OID,constructed:!1,capture:"digestAlgorithm"},{name:"SignerInfo.digestAlgorithm.parameter",tagClass:z.Class.UNIVERSAL,constructed:!1,captureAsn1:"digestParameter",optional:!0}]},{name:"SignerInfo.authenticatedAttributes",tagClass:z.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"authenticatedAttributes"},{name:"SignerInfo.digestEncryptionAlgorithm",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,capture:"signatureAlgorithm"},{name:"SignerInfo.encryptedDigest",tagClass:z.Class.UNIVERSAL,type:z.Type.OCTETSTRING,constructed:!1,capture:"signature"},{name:"SignerInfo.unauthenticatedAttributes",tagClass:z.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0,capture:"unauthenticatedAttributes"}]};zo.signedDataValidator={name:"SignedData",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"SignedData.Version",tagClass:z.Class.UNIVERSAL,type:z.Type.INTEGER,constructed:!1,capture:"version"},{name:"SignedData.DigestAlgorithms",tagClass:z.Class.UNIVERSAL,type:z.Type.SET,constructed:!0,captureAsn1:"digestAlgorithms"},JE,{name:"SignedData.Certificates",tagClass:z.Class.CONTEXT_SPECIFIC,type:0,optional:!0,captureAsn1:"certificates"},{name:"SignedData.CertificateRevocationLists",tagClass:z.Class.CONTEXT_SPECIFIC,type:1,optional:!0,captureAsn1:"crls"},{name:"SignedData.SignerInfos",tagClass:z.Class.UNIVERSAL,type:z.Type.SET,capture:"signerInfos",optional:!0,value:[sse]}]};zo.recipientInfoValidator={name:"RecipientInfo",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.version",tagClass:z.Class.UNIVERSAL,type:z.Type.INTEGER,constructed:!1,capture:"version"},{name:"RecipientInfo.issuerAndSerial",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.issuerAndSerial.issuer",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,captureAsn1:"issuer"},{name:"RecipientInfo.issuerAndSerial.serialNumber",tagClass:z.Class.UNIVERSAL,type:z.Type.INTEGER,constructed:!1,capture:"serial"}]},{name:"RecipientInfo.keyEncryptionAlgorithm",tagClass:z.Class.UNIVERSAL,type:z.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.keyEncryptionAlgorithm.algorithm",tagClass:z.Class.UNIVERSAL,type:z.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"RecipientInfo.keyEncryptionAlgorithm.parameter",tagClass:z.Class.UNIVERSAL,constructed:!1,captureAsn1:"encParameter",optional:!0}]},{name:"RecipientInfo.encryptedKey",tagClass:z.Class.UNIVERSAL,type:z.Type.OCTETSTRING,constructed:!1,capture:"encKey"}]};var yi=Vt;yi.mgf=yi.mgf||{};var ise=yi.mgf.mgf1=yi.mgf1=yi.mgf1||{};ise.create=function(r){var e={generate:function(t,n){for(var s=new yi.util.ByteBuffer,i=Math.ceil(n/r.digestLength),o=0;o<i;o++){var a=new yi.util.ByteBuffer;a.putInt32(o),r.start(),r.update(t+a.getBytes()),s.putBuffer(r.digest())}return s.truncate(s.length()-n),s.getBytes()}};return e};var Iu=Vt;Iu.mgf=Iu.mgf||{};Iu.mgf.mgf1=Iu.mgf1;var ci=Vt,ose=ci.pss=ci.pss||{};ose.create=function(r){arguments.length===3&&(r={md:arguments[0],mgf:arguments[1],saltLength:arguments[2]});var e=r.md,t=r.mgf,n=e.digestLength,s=r.salt||null;typeof s=="string"&&(s=ci.util.createBuffer(s));var i;if("saltLength"in r)i=r.saltLength;else if(s!==null)i=s.length();else throw new Error("Salt length not specified or specific salt not given.");if(s!==null&&s.length()!==i)throw new Error("Given salt length does not match length of given salt.");var o=r.prng||ci.random,a={};return a.encode=function(c,h){var l,u=h-1,f=Math.ceil(u/8),g=c.digest().getBytes();if(f<n+i+2)throw new Error("Message is too long to encrypt.");var d;s===null?d=o.getBytesSync(i):d=s.bytes();var p=new ci.util.ByteBuffer;p.fillWithByte(0,8),p.putBytes(g),p.putBytes(d),e.start(),e.update(p.getBytes());var w=e.digest().getBytes(),y=new ci.util.ByteBuffer;y.fillWithByte(0,f-i-n-2),y.putByte(1),y.putBytes(d);var _=y.getBytes(),m=f-n-1,b=t.generate(w,m),S="";for(l=0;l<m;l++)S+=String.fromCharCode(_.charCodeAt(l)^b.charCodeAt(l));var A=65280>>8*f-u&255;return S=String.fromCharCode(S.charCodeAt(0)&~A)+S.substr(1),S+w+String.fromCharCode(188)},a.verify=function(c,h,l){var u,f=l-1,g=Math.ceil(f/8);if(h=h.substr(-g),g<n+i+2)throw new Error("Inconsistent parameters to PSS signature verification.");if(h.charCodeAt(g-1)!==188)throw new Error("Encoded message does not end in 0xBC.");var d=g-n-1,p=h.substr(0,d),w=h.substr(d,n),y=65280>>8*g-f&255;if(p.charCodeAt(0)&y)throw new Error("Bits beyond keysize not zero as expected.");var _=t.generate(w,d),m="";for(u=0;u<d;u++)m+=String.fromCharCode(p.charCodeAt(u)^_.charCodeAt(u));m=String.fromCharCode(m.charCodeAt(0)&~y)+m.substr(1);var b=g-n-i-2;for(u=0;u<b;u++)if(m.charCodeAt(u)!==0)throw new Error("Leftmost octets not zero as expected");if(m.charCodeAt(b)!==1)throw new Error("Inconsistent PSS signature, 0x01 marker not found");var S=m.substr(-i),A=new ci.util.ByteBuffer;A.fillWithByte(0,8),A.putBytes(c),A.putBytes(S),e.start(),e.update(A.getBytes());var E=e.digest().getBytes();return w===E},a};var q=Vt,R=q.asn1,M=q.pki=q.pki||{},he=M.oids,He={};He.CN=he.commonName;He.commonName="CN";He.C=he.countryName;He.countryName="C";He.L=he.localityName;He.localityName="L";He.ST=he.stateOrProvinceName;He.stateOrProvinceName="ST";He.O=he.organizationName;He.organizationName="O";He.OU=he.organizationalUnitName;He.organizationalUnitName="OU";He.E=he.emailAddress;He.emailAddress="E";var e_=q.pki.rsa.publicKeyValidator,ase={name:"Certificate",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"tbsCertificate",value:[{name:"Certificate.TBSCertificate.version",tagClass:R.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.version.integer",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"certVersion"}]},{name:"Certificate.TBSCertificate.serialNumber",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"certSerialNumber"},{name:"Certificate.TBSCertificate.signature",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.signature.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"certinfoSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:R.Class.UNIVERSAL,optional:!0,captureAsn1:"certinfoSignatureParams"}]},{name:"Certificate.TBSCertificate.issuer",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certIssuer"},{name:"Certificate.TBSCertificate.validity",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.validity.notBefore (utc)",tagClass:R.Class.UNIVERSAL,type:R.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity1UTCTime"},{name:"Certificate.TBSCertificate.validity.notBefore (generalized)",tagClass:R.Class.UNIVERSAL,type:R.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity2GeneralizedTime"},{name:"Certificate.TBSCertificate.validity.notAfter (utc)",tagClass:R.Class.UNIVERSAL,type:R.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity3UTCTime"},{name:"Certificate.TBSCertificate.validity.notAfter (generalized)",tagClass:R.Class.UNIVERSAL,type:R.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity4GeneralizedTime"}]},{name:"Certificate.TBSCertificate.subject",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certSubject"},e_,{name:"Certificate.TBSCertificate.issuerUniqueID",tagClass:R.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.issuerUniqueID.id",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"certIssuerUniqueId"}]},{name:"Certificate.TBSCertificate.subjectUniqueID",tagClass:R.Class.CONTEXT_SPECIFIC,type:2,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.subjectUniqueID.id",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"certSubjectUniqueId"}]},{name:"Certificate.TBSCertificate.extensions",tagClass:R.Class.CONTEXT_SPECIFIC,type:3,constructed:!0,captureAsn1:"certExtensions",optional:!0}]},{name:"Certificate.signatureAlgorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.signatureAlgorithm.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"certSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:R.Class.UNIVERSAL,optional:!0,captureAsn1:"certSignatureParams"}]},{name:"Certificate.signatureValue",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"certSignature"}]},cse={name:"rsapss",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.hashAlgorithm",tagClass:R.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier",tagClass:R.Class.UNIVERSAL,type:R.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"hashOid"}]}]},{name:"rsapss.maskGenAlgorithm",tagClass:R.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier",tagClass:R.Class.UNIVERSAL,type:R.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"maskGenOid"},{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"maskGenHashOid"}]}]}]},{name:"rsapss.saltLength",tagClass:R.Class.CONTEXT_SPECIFIC,type:2,optional:!0,value:[{name:"rsapss.saltLength.saltLength",tagClass:R.Class.UNIVERSAL,type:R.Class.INTEGER,constructed:!1,capture:"saltLength"}]},{name:"rsapss.trailerField",tagClass:R.Class.CONTEXT_SPECIFIC,type:3,optional:!0,value:[{name:"rsapss.trailer.trailer",tagClass:R.Class.UNIVERSAL,type:R.Class.INTEGER,constructed:!1,capture:"trailer"}]}]},lse={name:"CertificationRequestInfo",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfo",value:[{name:"CertificationRequestInfo.integer",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"certificationRequestInfoVersion"},{name:"CertificationRequestInfo.subject",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfoSubject"},e_,{name:"CertificationRequestInfo.attributes",tagClass:R.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"certificationRequestInfoAttributes",value:[{name:"CertificationRequestInfo.attributes",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequestInfo.attributes.type",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1},{name:"CertificationRequestInfo.attributes.value",tagClass:R.Class.UNIVERSAL,type:R.Type.SET,constructed:!0}]}]}]},hse={name:"CertificationRequest",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"csr",value:[lse,{name:"CertificationRequest.signatureAlgorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequest.signatureAlgorithm.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"csrSignatureOid"},{name:"CertificationRequest.signatureAlgorithm.parameters",tagClass:R.Class.UNIVERSAL,optional:!0,captureAsn1:"csrSignatureParams"}]},{name:"CertificationRequest.signature",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"csrSignature"}]};M.RDNAttributesAsArray=function(r,e){for(var t=[],n,s,i,o=0;o<r.value.length;++o){n=r.value[o];for(var a=0;a<n.value.length;++a)i={},s=n.value[a],i.type=R.derToOid(s.value[0].value),i.value=s.value[1].value,i.valueTagClass=s.value[1].type,i.type in he&&(i.name=he[i.type],i.name in He&&(i.shortName=He[i.name])),e&&(e.update(i.type),e.update(i.value)),t.push(i)}return t};M.CRIAttributesAsArray=function(r){for(var e=[],t=0;t<r.length;++t)for(var n=r[t],s=R.derToOid(n.value[0].value),i=n.value[1].value,o=0;o<i.length;++o){var a={};if(a.type=s,a.value=i[o].value,a.valueTagClass=i[o].type,a.type in he&&(a.name=he[a.type],a.name in He&&(a.shortName=He[a.name])),a.type===he.extensionRequest){a.extensions=[];for(var c=0;c<a.value.length;++c)a.extensions.push(M.certificateExtensionFromAsn1(a.value[c]))}e.push(a)}return e};function Ys(r,e){typeof e=="string"&&(e={shortName:e});for(var t=null,n,s=0;t===null&&s<r.attributes.length;++s)n=r.attributes[s],(e.type&&e.type===n.type||e.name&&e.name===n.name||e.shortName&&e.shortName===n.shortName)&&(t=n);return t}var Cu=function(r,e,t){var n={};if(r!==he["RSASSA-PSS"])return n;t&&(n={hash:{algorithmOid:he.sha1},mgf:{algorithmOid:he.mgf1,hash:{algorithmOid:he.sha1}},saltLength:20});var s={},i=[];if(!R.validate(e,cse,s,i)){var o=new Error("Cannot read RSASSA-PSS parameter block.");throw o.errors=i,o}return s.hashOid!==void 0&&(n.hash=n.hash||{},n.hash.algorithmOid=R.derToOid(s.hashOid)),s.maskGenOid!==void 0&&(n.mgf=n.mgf||{},n.mgf.algorithmOid=R.derToOid(s.maskGenOid),n.mgf.hash=n.mgf.hash||{},n.mgf.hash.algorithmOid=R.derToOid(s.maskGenHashOid)),s.saltLength!==void 0&&(n.saltLength=s.saltLength.charCodeAt(0)),n},Nd=function(r){switch(he[r.signatureOid]){case"sha1WithRSAEncryption":case"sha1WithRSASignature":return q.md.sha1.create();case"md5WithRSAEncryption":return q.md.md5.create();case"sha256WithRSAEncryption":return q.md.sha256.create();case"sha384WithRSAEncryption":return q.md.sha384.create();case"sha512WithRSAEncryption":return q.md.sha512.create();case"RSASSA-PSS":return q.md.sha256.create();default:var e=new Error("Could not compute "+r.type+" digest. Unknown signature OID.");throw e.signatureOid=r.signatureOid,e}},t_=function(r){var e=r.certificate,t;switch(e.signatureOid){case he.sha1WithRSAEncryption:case he.sha1WithRSASignature:break;case he["RSASSA-PSS"]:var n,s;if(n=he[e.signatureParameters.mgf.hash.algorithmOid],n===void 0||q.md[n]===void 0){var i=new Error("Unsupported MGF hash function.");throw i.oid=e.signatureParameters.mgf.hash.algorithmOid,i.name=n,i}if(s=he[e.signatureParameters.mgf.algorithmOid],s===void 0||q.mgf[s]===void 0){var i=new Error("Unsupported MGF function.");throw i.oid=e.signatureParameters.mgf.algorithmOid,i.name=s,i}if(s=q.mgf[s].create(q.md[n].create()),n=he[e.signatureParameters.hash.algorithmOid],n===void 0||q.md[n]===void 0){var i=new Error("Unsupported RSASSA-PSS hash function.");throw i.oid=e.signatureParameters.hash.algorithmOid,i.name=n,i}t=q.pss.create(q.md[n].create(),s,e.signatureParameters.saltLength);break}return e.publicKey.verify(r.md.digest().getBytes(),r.signature,t)};M.certificateFromPem=function(r,e,t){var n=q.pem.decode(r)[0];if(n.type!=="CERTIFICATE"&&n.type!=="X509 CERTIFICATE"&&n.type!=="TRUSTED CERTIFICATE"){var s=new Error('Could not convert certificate from PEM; PEM header type is not "CERTIFICATE", "X509 CERTIFICATE", or "TRUSTED CERTIFICATE".');throw s.headerType=n.type,s}if(n.procType&&n.procType.type==="ENCRYPTED")throw new Error("Could not convert certificate from PEM; PEM is encrypted.");var i=R.fromDer(n.body,t);return M.certificateFromAsn1(i,e)};M.certificateToPem=function(r,e){var t={type:"CERTIFICATE",body:R.toDer(M.certificateToAsn1(r)).getBytes()};return q.pem.encode(t,{maxline:e})};M.publicKeyFromPem=function(r){var e=q.pem.decode(r)[0];if(e.type!=="PUBLIC KEY"&&e.type!=="RSA PUBLIC KEY"){var t=new Error('Could not convert public key from PEM; PEM header type is not "PUBLIC KEY" or "RSA PUBLIC KEY".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert public key from PEM; PEM is encrypted.");var n=R.fromDer(e.body);return M.publicKeyFromAsn1(n)};M.publicKeyToPem=function(r,e){var t={type:"PUBLIC KEY",body:R.toDer(M.publicKeyToAsn1(r)).getBytes()};return q.pem.encode(t,{maxline:e})};M.publicKeyToRSAPublicKeyPem=function(r,e){var t={type:"RSA PUBLIC KEY",body:R.toDer(M.publicKeyToRSAPublicKey(r)).getBytes()};return q.pem.encode(t,{maxline:e})};M.getPublicKeyFingerprint=function(r,e){e=e||{};var t=e.md||q.md.sha1.create(),n=e.type||"RSAPublicKey",s;switch(n){case"RSAPublicKey":s=R.toDer(M.publicKeyToRSAPublicKey(r)).getBytes();break;case"SubjectPublicKeyInfo":s=R.toDer(M.publicKeyToAsn1(r)).getBytes();break;default:throw new Error('Unknown fingerprint type "'+e.type+'".')}t.start(),t.update(s);var i=t.digest();if(e.encoding==="hex"){var o=i.toHex();return e.delimiter?o.match(/.{2}/g).join(e.delimiter):o}else{if(e.encoding==="binary")return i.getBytes();if(e.encoding)throw new Error('Unknown encoding "'+e.encoding+'".')}return i};M.certificationRequestFromPem=function(r,e,t){var n=q.pem.decode(r)[0];if(n.type!=="CERTIFICATE REQUEST"){var s=new Error('Could not convert certification request from PEM; PEM header type is not "CERTIFICATE REQUEST".');throw s.headerType=n.type,s}if(n.procType&&n.procType.type==="ENCRYPTED")throw new Error("Could not convert certification request from PEM; PEM is encrypted.");var i=R.fromDer(n.body,t);return M.certificationRequestFromAsn1(i,e)};M.certificationRequestToPem=function(r,e){var t={type:"CERTIFICATE REQUEST",body:R.toDer(M.certificationRequestToAsn1(r)).getBytes()};return q.pem.encode(t,{maxline:e})};M.createCertificate=function(){var r={};return r.version=2,r.serialNumber="00",r.signatureOid=null,r.signature=null,r.siginfo={},r.siginfo.algorithmOid=null,r.validity={},r.validity.notBefore=new Date,r.validity.notAfter=new Date,r.issuer={},r.issuer.getField=function(e){return Ys(r.issuer,e)},r.issuer.addField=function(e){Er([e]),r.issuer.attributes.push(e)},r.issuer.attributes=[],r.issuer.hash=null,r.subject={},r.subject.getField=function(e){return Ys(r.subject,e)},r.subject.addField=function(e){Er([e]),r.subject.attributes.push(e)},r.subject.attributes=[],r.subject.hash=null,r.extensions=[],r.publicKey=null,r.md=null,r.setSubject=function(e,t){Er(e),r.subject.attributes=e,delete r.subject.uniqueId,t&&(r.subject.uniqueId=t),r.subject.hash=null},r.setIssuer=function(e,t){Er(e),r.issuer.attributes=e,delete r.issuer.uniqueId,t&&(r.issuer.uniqueId=t),r.issuer.hash=null},r.setExtensions=function(e){for(var t=0;t<e.length;++t)r_(e[t],{cert:r});r.extensions=e},r.getExtension=function(e){typeof e=="string"&&(e={name:e});for(var t=null,n,s=0;t===null&&s<r.extensions.length;++s)n=r.extensions[s],(e.id&&n.id===e.id||e.name&&n.name===e.name)&&(t=n);return t},r.sign=function(e,t){r.md=t||q.md.sha1.create();var n=he[r.md.algorithm+"WithRSAEncryption"];if(!n){var s=new Error("Could not compute certificate digest. Unknown message digest algorithm OID.");throw s.algorithm=r.md.algorithm,s}r.signatureOid=r.siginfo.algorithmOid=n,r.tbsCertificate=M.getTBSCertificate(r);var i=R.toDer(r.tbsCertificate);r.md.update(i.getBytes()),r.signature=e.sign(r.md)},r.verify=function(e){var t=!1;if(!r.issued(e)){var n=e.issuer,s=r.subject,i=new Error("The parent certificate did not issue the given child certificate; the child certificate's issuer does not match the parent's subject.");throw i.expectedIssuer=s.attributes,i.actualIssuer=n.attributes,i}var o=e.md;if(o===null){o=Nd({signatureOid:e.signatureOid,type:"certificate"});var a=e.tbsCertificate||M.getTBSCertificate(e),c=R.toDer(a);o.update(c.getBytes())}return o!==null&&(t=t_({certificate:r,md:o,signature:e.signature})),t},r.isIssuer=function(e){var t=!1,n=r.issuer,s=e.subject;if(n.hash&&s.hash)t=n.hash===s.hash;else if(n.attributes.length===s.attributes.length){t=!0;for(var i,o,a=0;t&&a<n.attributes.length;++a)i=n.attributes[a],o=s.attributes[a],(i.type!==o.type||i.value!==o.value)&&(t=!1)}return t},r.issued=function(e){return e.isIssuer(r)},r.generateSubjectKeyIdentifier=function(){return M.getPublicKeyFingerprint(r.publicKey,{type:"RSAPublicKey"})},r.verifySubjectKeyIdentifier=function(){for(var e=he.subjectKeyIdentifier,t=0;t<r.extensions.length;++t){var n=r.extensions[t];if(n.id===e){var s=r.generateSubjectKeyIdentifier().getBytes();return q.util.hexToBytes(n.subjectKeyIdentifier)===s}}return!1},r};M.certificateFromAsn1=function(r,e){var t={},n=[];if(!R.validate(r,ase,t,n)){var s=new Error("Cannot read X.509 certificate. ASN.1 object is not an X509v3 Certificate.");throw s.errors=n,s}var i=R.derToOid(t.publicKeyOid);if(i!==M.oids.rsaEncryption)throw new Error("Cannot read public key. OID is not RSA.");var o=M.createCertificate();o.version=t.certVersion?t.certVersion.charCodeAt(0):0;var a=q.util.createBuffer(t.certSerialNumber);o.serialNumber=a.toHex(),o.signatureOid=q.asn1.derToOid(t.certSignatureOid),o.signatureParameters=Cu(o.signatureOid,t.certSignatureParams,!0),o.siginfo.algorithmOid=q.asn1.derToOid(t.certinfoSignatureOid),o.siginfo.parameters=Cu(o.siginfo.algorithmOid,t.certinfoSignatureParams,!1),o.signature=t.certSignature;var c=[];if(t.certValidity1UTCTime!==void 0&&c.push(R.utcTimeToDate(t.certValidity1UTCTime)),t.certValidity2GeneralizedTime!==void 0&&c.push(R.generalizedTimeToDate(t.certValidity2GeneralizedTime)),t.certValidity3UTCTime!==void 0&&c.push(R.utcTimeToDate(t.certValidity3UTCTime)),t.certValidity4GeneralizedTime!==void 0&&c.push(R.generalizedTimeToDate(t.certValidity4GeneralizedTime)),c.length>2)throw new Error("Cannot read notBefore/notAfter validity times; more than two times were provided in the certificate.");if(c.length<2)throw new Error("Cannot read notBefore/notAfter validity times; they were not provided as either UTCTime or GeneralizedTime.");if(o.validity.notBefore=c[0],o.validity.notAfter=c[1],o.tbsCertificate=t.tbsCertificate,e){o.md=Nd({signatureOid:o.signatureOid,type:"certificate"});var h=R.toDer(o.tbsCertificate);o.md.update(h.getBytes())}var l=q.md.sha1.create(),u=R.toDer(t.certIssuer);l.update(u.getBytes()),o.issuer.getField=function(d){return Ys(o.issuer,d)},o.issuer.addField=function(d){Er([d]),o.issuer.attributes.push(d)},o.issuer.attributes=M.RDNAttributesAsArray(t.certIssuer),t.certIssuerUniqueId&&(o.issuer.uniqueId=t.certIssuerUniqueId),o.issuer.hash=l.digest().toHex();var f=q.md.sha1.create(),g=R.toDer(t.certSubject);return f.update(g.getBytes()),o.subject.getField=function(d){return Ys(o.subject,d)},o.subject.addField=function(d){Er([d]),o.subject.attributes.push(d)},o.subject.attributes=M.RDNAttributesAsArray(t.certSubject),t.certSubjectUniqueId&&(o.subject.uniqueId=t.certSubjectUniqueId),o.subject.hash=f.digest().toHex(),t.certExtensions?o.extensions=M.certificateExtensionsFromAsn1(t.certExtensions):o.extensions=[],o.publicKey=M.publicKeyFromAsn1(t.subjectPublicKeyInfo),o};M.certificateExtensionsFromAsn1=function(r){for(var e=[],t=0;t<r.value.length;++t)for(var n=r.value[t],s=0;s<n.value.length;++s)e.push(M.certificateExtensionFromAsn1(n.value[s]));return e};M.certificateExtensionFromAsn1=function(r){var e={};if(e.id=R.derToOid(r.value[0].value),e.critical=!1,r.value[1].type===R.Type.BOOLEAN?(e.critical=r.value[1].value.charCodeAt(0)!==0,e.value=r.value[2].value):e.value=r.value[1].value,e.id in he){if(e.name=he[e.id],e.name==="keyUsage"){var t=R.fromDer(e.value),n=0,s=0;t.value.length>1&&(n=t.value.charCodeAt(1),s=t.value.length>2?t.value.charCodeAt(2):0),e.digitalSignature=(n&128)===128,e.nonRepudiation=(n&64)===64,e.keyEncipherment=(n&32)===32,e.dataEncipherment=(n&16)===16,e.keyAgreement=(n&8)===8,e.keyCertSign=(n&4)===4,e.cRLSign=(n&2)===2,e.encipherOnly=(n&1)===1,e.decipherOnly=(s&128)===128}else if(e.name==="basicConstraints"){var t=R.fromDer(e.value);t.value.length>0&&t.value[0].type===R.Type.BOOLEAN?e.cA=t.value[0].value.charCodeAt(0)!==0:e.cA=!1;var i=null;t.value.length>0&&t.value[0].type===R.Type.INTEGER?i=t.value[0].value:t.value.length>1&&(i=t.value[1].value),i!==null&&(e.pathLenConstraint=R.derToInteger(i))}else if(e.name==="extKeyUsage")for(var t=R.fromDer(e.value),o=0;o<t.value.length;++o){var a=R.derToOid(t.value[o].value);a in he?e[he[a]]=!0:e[a]=!0}else if(e.name==="nsCertType"){var t=R.fromDer(e.value),n=0;t.value.length>1&&(n=t.value.charCodeAt(1)),e.client=(n&128)===128,e.server=(n&64)===64,e.email=(n&32)===32,e.objsign=(n&16)===16,e.reserved=(n&8)===8,e.sslCA=(n&4)===4,e.emailCA=(n&2)===2,e.objCA=(n&1)===1}else if(e.name==="subjectAltName"||e.name==="issuerAltName"){e.altNames=[];for(var c,t=R.fromDer(e.value),h=0;h<t.value.length;++h){c=t.value[h];var l={type:c.type,value:c.value};switch(e.altNames.push(l),c.type){case 1:case 2:case 6:break;case 7:l.ip=q.util.bytesToIP(c.value);break;case 8:l.oid=R.derToOid(c.value);break}}}else if(e.name==="subjectKeyIdentifier"){var t=R.fromDer(e.value);e.subjectKeyIdentifier=q.util.bytesToHex(t.value)}}return e};M.certificationRequestFromAsn1=function(r,e){var t={},n=[];if(!R.validate(r,hse,t,n)){var s=new Error("Cannot read PKCS#10 certificate request. ASN.1 object is not a PKCS#10 CertificationRequest.");throw s.errors=n,s}var i=R.derToOid(t.publicKeyOid);if(i!==M.oids.rsaEncryption)throw new Error("Cannot read public key. OID is not RSA.");var o=M.createCertificationRequest();if(o.version=t.csrVersion?t.csrVersion.charCodeAt(0):0,o.signatureOid=q.asn1.derToOid(t.csrSignatureOid),o.signatureParameters=Cu(o.signatureOid,t.csrSignatureParams,!0),o.siginfo.algorithmOid=q.asn1.derToOid(t.csrSignatureOid),o.siginfo.parameters=Cu(o.siginfo.algorithmOid,t.csrSignatureParams,!1),o.signature=t.csrSignature,o.certificationRequestInfo=t.certificationRequestInfo,e){o.md=Nd({signatureOid:o.signatureOid,type:"certification request"});var a=R.toDer(o.certificationRequestInfo);o.md.update(a.getBytes())}var c=q.md.sha1.create();return o.subject.getField=function(h){return Ys(o.subject,h)},o.subject.addField=function(h){Er([h]),o.subject.attributes.push(h)},o.subject.attributes=M.RDNAttributesAsArray(t.certificationRequestInfoSubject,c),o.subject.hash=c.digest().toHex(),o.publicKey=M.publicKeyFromAsn1(t.subjectPublicKeyInfo),o.getAttribute=function(h){return Ys(o,h)},o.addAttribute=function(h){Er([h]),o.attributes.push(h)},o.attributes=M.CRIAttributesAsArray(t.certificationRequestInfoAttributes||[]),o};M.createCertificationRequest=function(){var r={};return r.version=0,r.signatureOid=null,r.signature=null,r.siginfo={},r.siginfo.algorithmOid=null,r.subject={},r.subject.getField=function(e){return Ys(r.subject,e)},r.subject.addField=function(e){Er([e]),r.subject.attributes.push(e)},r.subject.attributes=[],r.subject.hash=null,r.publicKey=null,r.attributes=[],r.getAttribute=function(e){return Ys(r,e)},r.addAttribute=function(e){Er([e]),r.attributes.push(e)},r.md=null,r.setSubject=function(e){Er(e),r.subject.attributes=e,r.subject.hash=null},r.setAttributes=function(e){Er(e),r.attributes=e},r.sign=function(e,t){r.md=t||q.md.sha1.create();var n=he[r.md.algorithm+"WithRSAEncryption"];if(!n){var s=new Error("Could not compute certification request digest. Unknown message digest algorithm OID.");throw s.algorithm=r.md.algorithm,s}r.signatureOid=r.siginfo.algorithmOid=n,r.certificationRequestInfo=M.getCertificationRequestInfo(r);var i=R.toDer(r.certificationRequestInfo);r.md.update(i.getBytes()),r.signature=e.sign(r.md)},r.verify=function(){var e=!1,t=r.md;if(t===null){t=Nd({signatureOid:r.signatureOid,type:"certification request"});var n=r.certificationRequestInfo||M.getCertificationRequestInfo(r),s=R.toDer(n);t.update(s.getBytes())}return t!==null&&(e=t_({certificate:r,md:t,signature:r.signature})),e},r};function Ao(r){for(var e=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]),t,n,s=r.attributes,i=0;i<s.length;++i){t=s[i];var o=t.value,a=R.Type.PRINTABLESTRING;"valueTagClass"in t&&(a=t.valueTagClass,a===R.Type.UTF8&&(o=q.util.encodeUtf8(o))),n=R.create(R.Class.UNIVERSAL,R.Type.SET,!0,[R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(t.type).getBytes()),R.create(R.Class.UNIVERSAL,a,!1,o)])]),e.value.push(n)}return e}function Er(r){for(var e,t=0;t<r.length;++t){if(e=r[t],typeof e.name>"u"&&(e.type&&e.type in M.oids?e.name=M.oids[e.type]:e.shortName&&e.shortName in He&&(e.name=M.oids[He[e.shortName]])),typeof e.type>"u")if(e.name&&e.name in M.oids)e.type=M.oids[e.name];else{var n=new Error("Attribute type not specified.");throw n.attribute=e,n}if(typeof e.shortName>"u"&&e.name&&e.name in He&&(e.shortName=He[e.name]),e.type===he.extensionRequest&&(e.valueConstructed=!0,e.valueTagClass=R.Type.SEQUENCE,!e.value&&e.extensions)){e.value=[];for(var s=0;s<e.extensions.length;++s)e.value.push(M.certificateExtensionToAsn1(r_(e.extensions[s])))}if(typeof e.value>"u"){var n=new Error("Attribute value not specified.");throw n.attribute=e,n}}}function r_(r,e){if(e=e||{},typeof r.name>"u"&&r.id&&r.id in M.oids&&(r.name=M.oids[r.id]),typeof r.id>"u")if(r.name&&r.name in M.oids)r.id=M.oids[r.name];else{var t=new Error("Extension ID not specified.");throw t.extension=r,t}if(typeof r.value<"u")return r;if(r.name==="keyUsage"){var n=0,s=0,i=0;r.digitalSignature&&(s|=128,n=7),r.nonRepudiation&&(s|=64,n=6),r.keyEncipherment&&(s|=32,n=5),r.dataEncipherment&&(s|=16,n=4),r.keyAgreement&&(s|=8,n=3),r.keyCertSign&&(s|=4,n=2),r.cRLSign&&(s|=2,n=1),r.encipherOnly&&(s|=1,n=0),r.decipherOnly&&(i|=128,n=7);var o=String.fromCharCode(n);i!==0?o+=String.fromCharCode(s)+String.fromCharCode(i):s!==0&&(o+=String.fromCharCode(s)),r.value=R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,o)}else if(r.name==="basicConstraints")r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]),r.cA&&r.value.value.push(R.create(R.Class.UNIVERSAL,R.Type.BOOLEAN,!1,String.fromCharCode(255))),"pathLenConstraint"in r&&r.value.value.push(R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(r.pathLenConstraint).getBytes()));else if(r.name==="extKeyUsage"){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);var a=r.value.value;for(var c in r)r[c]===!0&&(c in he?a.push(R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(he[c]).getBytes())):c.indexOf(".")!==-1&&a.push(R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(c).getBytes())))}else if(r.name==="nsCertType"){var n=0,s=0;r.client&&(s|=128,n=7),r.server&&(s|=64,n=6),r.email&&(s|=32,n=5),r.objsign&&(s|=16,n=4),r.reserved&&(s|=8,n=3),r.sslCA&&(s|=4,n=2),r.emailCA&&(s|=2,n=1),r.objCA&&(s|=1,n=0);var o=String.fromCharCode(n);s!==0&&(o+=String.fromCharCode(s)),r.value=R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,o)}else if(r.name==="subjectAltName"||r.name==="issuerAltName"){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);for(var h,l=0;l<r.altNames.length;++l){h=r.altNames[l];var o=h.value;if(h.type===7&&h.ip){if(o=q.util.bytesFromIP(h.ip),o===null){var t=new Error('Extension "ip" value is not a valid IPv4 or IPv6 address.');throw t.extension=r,t}}else h.type===8&&(h.oid?o=R.oidToDer(R.oidToDer(h.oid)):o=R.oidToDer(o));r.value.value.push(R.create(R.Class.CONTEXT_SPECIFIC,h.type,!1,o))}}else if(r.name==="nsComment"&&e.cert){if(!/^[\x00-\x7F]*$/.test(r.comment)||r.comment.length<1||r.comment.length>128)throw new Error('Invalid "nsComment" content.');r.value=R.create(R.Class.UNIVERSAL,R.Type.IA5STRING,!1,r.comment)}else if(r.name==="subjectKeyIdentifier"&&e.cert){var u=e.cert.generateSubjectKeyIdentifier();r.subjectKeyIdentifier=u.toHex(),r.value=R.create(R.Class.UNIVERSAL,R.Type.OCTETSTRING,!1,u.getBytes())}else if(r.name==="authorityKeyIdentifier"&&e.cert){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);var a=r.value.value;if(r.keyIdentifier){var f=r.keyIdentifier===!0?e.cert.generateSubjectKeyIdentifier().getBytes():r.keyIdentifier;a.push(R.create(R.Class.CONTEXT_SPECIFIC,0,!1,f))}if(r.authorityCertIssuer){var g=[R.create(R.Class.CONTEXT_SPECIFIC,4,!0,[Ao(r.authorityCertIssuer===!0?e.cert.issuer:r.authorityCertIssuer)])];a.push(R.create(R.Class.CONTEXT_SPECIFIC,1,!0,g))}if(r.serialNumber){var d=q.util.hexToBytes(r.serialNumber===!0?e.cert.serialNumber:r.serialNumber);a.push(R.create(R.Class.CONTEXT_SPECIFIC,2,!1,d))}}else if(r.name==="cRLDistributionPoints"){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);for(var a=r.value.value,p=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]),w=R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[]),h,l=0;l<r.altNames.length;++l){h=r.altNames[l];var o=h.value;if(h.type===7&&h.ip){if(o=q.util.bytesFromIP(h.ip),o===null){var t=new Error('Extension "ip" value is not a valid IPv4 or IPv6 address.');throw t.extension=r,t}}else h.type===8&&(h.oid?o=R.oidToDer(R.oidToDer(h.oid)):o=R.oidToDer(o));w.value.push(R.create(R.Class.CONTEXT_SPECIFIC,h.type,!1,o))}p.value.push(R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[w])),a.push(p)}if(typeof r.value>"u"){var t=new Error("Extension value not specified.");throw t.extension=r,t}return r}function ig(r,e){switch(r){case he["RSASSA-PSS"]:var t=[];return e.hash.algorithmOid!==void 0&&t.push(R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(e.hash.algorithmOid).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")])])),e.mgf.algorithmOid!==void 0&&t.push(R.create(R.Class.CONTEXT_SPECIFIC,1,!0,[R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(e.mgf.algorithmOid).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(e.mgf.hash.algorithmOid).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")])])])),e.saltLength!==void 0&&t.push(R.create(R.Class.CONTEXT_SPECIFIC,2,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(e.saltLength).getBytes())])),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,t);default:return R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")}}function use(r){var e=R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[]);if(r.attributes.length===0)return e;for(var t=r.attributes,n=0;n<t.length;++n){var s=t[n],i=s.value,o=R.Type.UTF8;"valueTagClass"in s&&(o=s.valueTagClass),o===R.Type.UTF8&&(i=q.util.encodeUtf8(i));var a=!1;"valueConstructed"in s&&(a=s.valueConstructed);var c=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(s.type).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.SET,!0,[R.create(R.Class.UNIVERSAL,o,a,i)])]);e.value.push(c)}return e}var dse=new Date("1950-01-01T00:00:00Z"),fse=new Date("2050-01-01T00:00:00Z");function U6(r){return r>=dse&&r<fse?R.create(R.Class.UNIVERSAL,R.Type.UTCTIME,!1,R.dateToUtcTime(r)):R.create(R.Class.UNIVERSAL,R.Type.GENERALIZEDTIME,!1,R.dateToGeneralizedTime(r))}M.getTBSCertificate=function(r){var e=U6(r.validity.notBefore),t=U6(r.validity.notAfter),n=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(r.version).getBytes())]),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,q.util.hexToBytes(r.serialNumber)),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.siginfo.algorithmOid).getBytes()),ig(r.siginfo.algorithmOid,r.siginfo.parameters)]),Ao(r.issuer),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[e,t]),Ao(r.subject),M.publicKeyToAsn1(r.publicKey)]);return r.issuer.uniqueId&&n.value.push(R.create(R.Class.CONTEXT_SPECIFIC,1,!0,[R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.issuer.uniqueId)])),r.subject.uniqueId&&n.value.push(R.create(R.Class.CONTEXT_SPECIFIC,2,!0,[R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.subject.uniqueId)])),r.extensions.length>0&&n.value.push(M.certificateExtensionsToAsn1(r.extensions)),n};M.getCertificationRequestInfo=function(r){var e=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(r.version).getBytes()),Ao(r.subject),M.publicKeyToAsn1(r.publicKey),use(r)]);return e};M.distinguishedNameToAsn1=function(r){return Ao(r)};M.certificateToAsn1=function(r){var e=r.tbsCertificate||M.getTBSCertificate(r);return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[e,R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.signatureOid).getBytes()),ig(r.signatureOid,r.signatureParameters)]),R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.signature)])};M.certificateExtensionsToAsn1=function(r){var e=R.create(R.Class.CONTEXT_SPECIFIC,3,!0,[]),t=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);e.value.push(t);for(var n=0;n<r.length;++n)t.value.push(M.certificateExtensionToAsn1(r[n]));return e};M.certificateExtensionToAsn1=function(r){var e=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);e.value.push(R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.id).getBytes())),r.critical&&e.value.push(R.create(R.Class.UNIVERSAL,R.Type.BOOLEAN,!1,String.fromCharCode(255)));var t=r.value;return typeof r.value!="string"&&(t=R.toDer(t).getBytes()),e.value.push(R.create(R.Class.UNIVERSAL,R.Type.OCTETSTRING,!1,t)),e};M.certificationRequestToAsn1=function(r){var e=r.certificationRequestInfo||M.getCertificationRequestInfo(r);return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[e,R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.signatureOid).getBytes()),ig(r.signatureOid,r.signatureParameters)]),R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.signature)])};M.createCaStore=function(r){var e={certs:{}};e.getIssuer=function(o){var a=t(o.issuer);return a},e.addCertificate=function(o){if(typeof o=="string"&&(o=q.pki.certificateFromPem(o)),n(o.subject),!e.hasCertificate(o))if(o.subject.hash in e.certs){var a=e.certs[o.subject.hash];q.util.isArray(a)||(a=[a]),a.push(o),e.certs[o.subject.hash]=a}else e.certs[o.subject.hash]=o},e.hasCertificate=function(o){typeof o=="string"&&(o=q.pki.certificateFromPem(o));var a=t(o.subject);if(!a)return!1;q.util.isArray(a)||(a=[a]);for(var c=R.toDer(M.certificateToAsn1(o)).getBytes(),h=0;h<a.length;++h){var l=R.toDer(M.certificateToAsn1(a[h])).getBytes();if(c===l)return!0}return!1},e.listAllCertificates=function(){var o=[];for(var a in e.certs)if(e.certs.hasOwnProperty(a)){var c=e.certs[a];if(!q.util.isArray(c))o.push(c);else for(var h=0;h<c.length;++h)o.push(c[h])}return o},e.removeCertificate=function(o){var a;if(typeof o=="string"&&(o=q.pki.certificateFromPem(o)),n(o.subject),!e.hasCertificate(o))return null;var c=t(o.subject);if(!q.util.isArray(c))return a=e.certs[o.subject.hash],delete e.certs[o.subject.hash],a;for(var h=R.toDer(M.certificateToAsn1(o)).getBytes(),l=0;l<c.length;++l){var u=R.toDer(M.certificateToAsn1(c[l])).getBytes();h===u&&(a=c[l],c.splice(l,1))}return c.length===0&&delete e.certs[o.subject.hash],a};function t(o){return n(o),e.certs[o.hash]||null}function n(o){if(!o.hash){var a=q.md.sha1.create();o.attributes=M.RDNAttributesAsArray(Ao(o),a),o.hash=a.digest().toHex()}}if(r)for(var s=0;s<r.length;++s){var i=r[s];e.addCertificate(i)}return e};M.certificateError={bad_certificate:"forge.pki.BadCertificate",unsupported_certificate:"forge.pki.UnsupportedCertificate",certificate_revoked:"forge.pki.CertificateRevoked",certificate_expired:"forge.pki.CertificateExpired",certificate_unknown:"forge.pki.CertificateUnknown",unknown_ca:"forge.pki.UnknownCertificateAuthority"};M.verifyCertificateChain=function(r,e,t){typeof t=="function"&&(t={verify:t}),t=t||{},e=e.slice(0);var n=e.slice(0),s=t.validityCheckDate;typeof s>"u"&&(s=new Date);var i=!0,o=null,a=0;do{var c=e.shift(),h=null,l=!1;if(s&&(s<c.validity.notBefore||s>c.validity.notAfter)&&(o={message:"Certificate is not valid yet or has expired.",error:M.certificateError.certificate_expired,notBefore:c.validity.notBefore,notAfter:c.validity.notAfter,now:s}),o===null){if(h=e[0]||r.getIssuer(c),h===null&&c.isIssuer(c)&&(l=!0,h=c),h){var u=h;q.util.isArray(u)||(u=[u]);for(var f=!1;!f&&u.length>0;){h=u.shift();try{f=h.verify(c)}catch{}}f||(o={message:"Certificate signature is invalid.",error:M.certificateError.bad_certificate})}o===null&&(!h||l)&&!r.hasCertificate(c)&&(o={message:"Certificate is not trusted.",error:M.certificateError.unknown_ca})}if(o===null&&h&&!c.isIssuer(h)&&(o={message:"Certificate issuer is invalid.",error:M.certificateError.bad_certificate}),o===null)for(var g={keyUsage:!0,basicConstraints:!0},d=0;o===null&&d<c.extensions.length;++d){var p=c.extensions[d];p.critical&&!(p.name in g)&&(o={message:"Certificate has an unsupported critical extension.",error:M.certificateError.unsupported_certificate})}if(o===null&&(!i||e.length===0&&(!h||l))){var w=c.getExtension("basicConstraints"),y=c.getExtension("keyUsage");if(y!==null&&(!y.keyCertSign||w===null)&&(o={message:"Certificate keyUsage or basicConstraints conflict or indicate that the certificate is not a CA. If the certificate is the only one in the chain or isn't the first then the certificate must be a valid CA.",error:M.certificateError.bad_certificate}),o===null&&w!==null&&!w.cA&&(o={message:"Certificate basicConstraints indicates the certificate is not a CA.",error:M.certificateError.bad_certificate}),o===null&&y!==null&&"pathLenConstraint"in w){var _=a-1;_>w.pathLenConstraint&&(o={message:"Certificate basicConstraints pathLenConstraint violated.",error:M.certificateError.bad_certificate})}}var m=o===null?!0:o.error,b=t.verify?t.verify(m,a,n):m;if(b===!0)o=null;else throw m===!0&&(o={message:"The application rejected the certificate.",error:M.certificateError.bad_certificate}),(b||b===0)&&(typeof b=="object"&&!q.util.isArray(b)?(b.message&&(o.message=b.message),b.error&&(o.error=b.error)):typeof b=="string"&&(o.error=b)),o;i=!1,++a}while(e.length>0);return!0};var U=Vt,T=U.asn1,jt=U.pkcs7=U.pkcs7||{};jt.messageFromPem=function(r){var e=U.pem.decode(r)[0];if(e.type!=="PKCS7"){var t=new Error('Could not convert PKCS#7 message from PEM; PEM header type is not "PKCS#7".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert PKCS#7 message from PEM; PEM is encrypted.");var n=T.fromDer(e.body);return jt.messageFromAsn1(n)};jt.messageToPem=function(r,e){var t={type:"PKCS7",body:T.toDer(r.toAsn1()).getBytes()};return U.pem.encode(t,{maxline:e})};jt.messageFromAsn1=function(r){var e={},t=[];if(!T.validate(r,jt.asn1.contentInfoValidator,e,t)){var n=new Error("Cannot read PKCS#7 message. ASN.1 object is not an PKCS#7 ContentInfo.");throw n.errors=t,n}var s=T.derToOid(e.contentType),i;switch(s){case U.pki.oids.envelopedData:i=jt.createEnvelopedData();break;case U.pki.oids.encryptedData:i=jt.createEncryptedData();break;case U.pki.oids.signedData:i=jt.createSignedData();break;default:throw new Error("Cannot read PKCS#7 message. ContentType with OID "+s+" is not (yet) supported.")}return i.fromAsn1(e.content.value[0]),i};jt.createSignedData=function(){var r=null;return r={type:U.pki.oids.signedData,version:1,certificates:[],crls:[],signers:[],digestAlgorithmIdentifiers:[],contentInfo:null,signerInfos:[],fromAsn1:function(n){if(og(r,n,jt.asn1.signedDataValidator),r.certificates=[],r.crls=[],r.digestAlgorithmIdentifiers=[],r.contentInfo=null,r.signerInfos=[],r.rawCapture.certificates)for(var s=r.rawCapture.certificates.value,i=0;i<s.length;++i)r.certificates.push(U.pki.certificateFromAsn1(s[i]))},toAsn1:function(){r.contentInfo||r.sign();for(var n=[],s=0;s<r.certificates.length;++s)n.push(U.pki.certificateToAsn1(r.certificates[s]));var i=[],o=T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SET,!0,r.digestAlgorithmIdentifiers),r.contentInfo])]);return n.length>0&&o.value[0].value.push(T.create(T.Class.CONTEXT_SPECIFIC,0,!0,n)),i.length>0&&o.value[0].value.push(T.create(T.Class.CONTEXT_SPECIFIC,1,!0,i)),o.value[0].value.push(T.create(T.Class.UNIVERSAL,T.Type.SET,!0,r.signerInfos)),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.type).getBytes()),o])},addSigner:function(n){var s=n.issuer,i=n.serialNumber;if(n.certificate){var o=n.certificate;typeof o=="string"&&(o=U.pki.certificateFromPem(o)),s=o.issuer.attributes,i=o.serialNumber}var a=n.key;if(!a)throw new Error("Could not add PKCS#7 signer; no private key specified.");typeof a=="string"&&(a=U.pki.privateKeyFromPem(a));var c=n.digestAlgorithm||U.pki.oids.sha1;switch(c){case U.pki.oids.sha1:case U.pki.oids.sha256:case U.pki.oids.sha384:case U.pki.oids.sha512:case U.pki.oids.md5:break;default:throw new Error("Could not add PKCS#7 signer; unknown message digest algorithm: "+c)}var h=n.authenticatedAttributes||[];if(h.length>0){for(var l=!1,u=!1,f=0;f<h.length;++f){var g=h[f];if(!l&&g.type===U.pki.oids.contentType){if(l=!0,u)break;continue}if(!u&&g.type===U.pki.oids.messageDigest){if(u=!0,l)break;continue}}if(!l||!u)throw new Error("Invalid signer.authenticatedAttributes. If signer.authenticatedAttributes is specified, then it must contain at least two attributes, PKCS #9 content-type and PKCS #9 message-digest.")}r.signers.push({key:a,version:1,issuer:s,serialNumber:i,digestAlgorithm:c,signatureAlgorithm:U.pki.oids.rsaEncryption,signature:null,authenticatedAttributes:h,unauthenticatedAttributes:[]})},sign:function(n){if(n=n||{},(typeof r.content!="object"||r.contentInfo===null)&&(r.contentInfo=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(U.pki.oids.data).getBytes())]),"content"in r)){var s;r.content instanceof U.util.ByteBuffer?s=r.content.bytes():typeof r.content=="string"&&(s=U.util.encodeUtf8(r.content)),n.detached?r.detachedContent=T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,s):r.contentInfo.value.push(T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,s)]))}if(r.signers.length!==0){var i=e();t(i)}},verify:function(){throw new Error("PKCS#7 signature verification not yet implemented.")},addCertificate:function(n){typeof n=="string"&&(n=U.pki.certificateFromPem(n)),r.certificates.push(n)},addCertificateRevokationList:function(n){throw new Error("PKCS#7 CRL support not yet implemented.")}},r;function e(){for(var n={},s=0;s<r.signers.length;++s){var i=r.signers[s],o=i.digestAlgorithm;o in n||(n[o]=U.md[U.pki.oids[o]].create()),i.authenticatedAttributes.length===0?i.md=n[o]:i.md=U.md[U.pki.oids[o]].create()}r.digestAlgorithmIdentifiers=[];for(var o in n)r.digestAlgorithmIdentifiers.push(T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(o).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")]));return n}function t(n){var s;if(r.detachedContent?s=r.detachedContent:(s=r.contentInfo.value[1],s=s.value[0]),!s)throw new Error("Could not sign PKCS#7 message; there is no content to sign.");var i=T.derToOid(r.contentInfo.value[0].value),o=T.toDer(s);o.getByte(),T.getBerValueLength(o),o=o.getBytes();for(var a in n)n[a].start().update(o);for(var c=new Date,h=0;h<r.signers.length;++h){var l=r.signers[h];if(l.authenticatedAttributes.length===0){if(i!==U.pki.oids.data)throw new Error("Invalid signer; authenticatedAttributes must be present when the ContentInfo content type is not PKCS#7 Data.")}else{l.authenticatedAttributesAsn1=T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[]);for(var u=T.create(T.Class.UNIVERSAL,T.Type.SET,!0,[]),f=0;f<l.authenticatedAttributes.length;++f){var g=l.authenticatedAttributes[f];g.type===U.pki.oids.messageDigest?g.value=n[l.digestAlgorithm].digest():g.type===U.pki.oids.signingTime&&(g.value||(g.value=c)),u.value.push(sp(g)),l.authenticatedAttributesAsn1.value.push(sp(g))}o=T.toDer(u).getBytes(),l.md.start().update(o)}l.signature=l.key.sign(l.md,"RSASSA-PKCS1-V1_5")}r.signerInfos=bse(r.signers)}};jt.createEncryptedData=function(){var r=null;return r={type:U.pki.oids.encryptedData,version:0,encryptedContent:{algorithm:U.pki.oids["aes256-CBC"]},fromAsn1:function(e){og(r,e,jt.asn1.encryptedDataValidator)},decrypt:function(e){e!==void 0&&(r.encryptedContent.key=e),n_(r)}},r};jt.createEnvelopedData=function(){var r=null;return r={type:U.pki.oids.envelopedData,version:0,recipients:[],encryptedContent:{algorithm:U.pki.oids["aes256-CBC"]},fromAsn1:function(e){var t=og(r,e,jt.asn1.envelopedDataValidator);r.recipients=yse(t.recipientInfos.value)},toAsn1:function(){return T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.type).getBytes()),T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SET,!0,wse(r.recipients)),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,Ese(r.encryptedContent))])])])},findRecipient:function(e){for(var t=e.issuer.attributes,n=0;n<r.recipients.length;++n){var s=r.recipients[n],i=s.issuer;if(s.serialNumber===e.serialNumber&&i.length===t.length){for(var o=!0,a=0;a<t.length;++a)if(i[a].type!==t[a].type||i[a].value!==t[a].value){o=!1;break}if(o)return s}}return null},decrypt:function(e,t){if(r.encryptedContent.key===void 0&&e!==void 0&&t!==void 0)switch(e.encryptedContent.algorithm){case U.pki.oids.rsaEncryption:case U.pki.oids.desCBC:var n=t.decrypt(e.encryptedContent.content);r.encryptedContent.key=U.util.createBuffer(n);break;default:throw new Error("Unsupported asymmetric cipher, OID "+e.encryptedContent.algorithm)}n_(r)},addRecipient:function(e){r.recipients.push({version:0,issuer:e.issuer.attributes,serialNumber:e.serialNumber,encryptedContent:{algorithm:U.pki.oids.rsaEncryption,key:e.publicKey}})},encrypt:function(e,t){if(r.encryptedContent.content===void 0){t=t||r.encryptedContent.algorithm,e=e||r.encryptedContent.key;var n,s,i;switch(t){case U.pki.oids["aes128-CBC"]:n=16,s=16,i=U.aes.createEncryptionCipher;break;case U.pki.oids["aes192-CBC"]:n=24,s=16,i=U.aes.createEncryptionCipher;break;case U.pki.oids["aes256-CBC"]:n=32,s=16,i=U.aes.createEncryptionCipher;break;case U.pki.oids["des-EDE3-CBC"]:n=24,s=8,i=U.des.createEncryptionCipher;break;default:throw new Error("Unsupported symmetric cipher, OID "+t)}if(e===void 0)e=U.util.createBuffer(U.random.getBytes(n));else if(e.length()!=n)throw new Error("Symmetric key has wrong length; got "+e.length()+" bytes, expected "+n+".");r.encryptedContent.algorithm=t,r.encryptedContent.key=e,r.encryptedContent.parameter=U.util.createBuffer(U.random.getBytes(s));var o=i(e);if(o.start(r.encryptedContent.parameter.copy()),o.update(r.content),!o.finish())throw new Error("Symmetric encryption failed.");r.encryptedContent.content=o.output}for(var a=0;a<r.recipients.length;++a){var c=r.recipients[a];if(c.encryptedContent.content===void 0)switch(c.encryptedContent.algorithm){case U.pki.oids.rsaEncryption:c.encryptedContent.content=c.encryptedContent.key.encrypt(r.encryptedContent.key.data);break;default:throw new Error("Unsupported asymmetric cipher, OID "+c.encryptedContent.algorithm)}}}},r};function pse(r){var e={},t=[];if(!T.validate(r,jt.asn1.recipientInfoValidator,e,t)){var n=new Error("Cannot read PKCS#7 RecipientInfo. ASN.1 object is not an PKCS#7 RecipientInfo.");throw n.errors=t,n}return{version:e.version.charCodeAt(0),issuer:U.pki.RDNAttributesAsArray(e.issuer),serialNumber:U.util.createBuffer(e.serial).toHex(),encryptedContent:{algorithm:T.derToOid(e.encAlgorithm),parameter:e.encParameter?e.encParameter.value:void 0,content:e.encKey}}}function gse(r){return T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[U.pki.distinguishedNameToAsn1({attributes:r.issuer}),T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,U.util.hexToBytes(r.serialNumber))]),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.encryptedContent.algorithm).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")]),T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.encryptedContent.content)])}function yse(r){for(var e=[],t=0;t<r.length;++t)e.push(pse(r[t]));return e}function wse(r){for(var e=[],t=0;t<r.length;++t)e.push(gse(r[t]));return e}function mse(r){var e=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[U.pki.distinguishedNameToAsn1({attributes:r.issuer}),T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,U.util.hexToBytes(r.serialNumber))]),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.digestAlgorithm).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")])]);if(r.authenticatedAttributesAsn1&&e.value.push(r.authenticatedAttributesAsn1),e.value.push(T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.signatureAlgorithm).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")])),e.value.push(T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.signature)),r.unauthenticatedAttributes.length>0){for(var t=T.create(T.Class.CONTEXT_SPECIFIC,1,!0,[]),n=0;n<r.unauthenticatedAttributes.length;++n){var s=r.unauthenticatedAttributes[n];t.values.push(sp(s))}e.value.push(t)}return e}function bse(r){for(var e=[],t=0;t<r.length;++t)e.push(mse(r[t]));return e}function sp(r){var e;if(r.type===U.pki.oids.contentType)e=T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.value).getBytes());else if(r.type===U.pki.oids.messageDigest)e=T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.value.bytes());else if(r.type===U.pki.oids.signingTime){var t=new Date("1950-01-01T00:00:00Z"),n=new Date("2050-01-01T00:00:00Z"),s=r.value;if(typeof s=="string"){var i=Date.parse(s);isNaN(i)?s.length===13?s=T.utcTimeToDate(s):s=T.generalizedTimeToDate(s):s=new Date(i)}s>=t&&s<n?e=T.create(T.Class.UNIVERSAL,T.Type.UTCTIME,!1,T.dateToUtcTime(s)):e=T.create(T.Class.UNIVERSAL,T.Type.GENERALIZEDTIME,!1,T.dateToGeneralizedTime(s))}return T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.type).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SET,!0,[e])])}function Ese(r){return[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(U.pki.oids.data).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.algorithm).getBytes()),r.parameter?T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.parameter.getBytes()):void 0]),T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.content.getBytes())])]}function og(r,e,t){var n={},s=[];if(!T.validate(e,t,n,s)){var i=new Error("Cannot read PKCS#7 message. ASN.1 object is not a supported PKCS#7 message.");throw i.errors=i,i}var o=T.derToOid(n.contentType);if(o!==U.pki.oids.data)throw new Error("Unsupported PKCS#7 message. Only wrapped ContentType Data supported.");if(n.encryptedContent){var a="";if(U.util.isArray(n.encryptedContent))for(var c=0;c<n.encryptedContent.length;++c){if(n.encryptedContent[c].type!==T.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting encrypted content constructed of only OCTET STRING objects.");a+=n.encryptedContent[c].value}else a=n.encryptedContent;r.encryptedContent={algorithm:T.derToOid(n.encAlgorithm),parameter:U.util.createBuffer(n.encParameter.value),content:U.util.createBuffer(a)}}if(n.content){var a="";if(U.util.isArray(n.content))for(var c=0;c<n.content.length;++c){if(n.content[c].type!==T.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting content constructed of only OCTET STRING objects.");a+=n.content[c].value}else a=n.content;r.content=U.util.createBuffer(a)}return r.version=n.version.charCodeAt(0),r.rawCapture=n,n}function n_(r){if(r.encryptedContent.key===void 0)throw new Error("Symmetric key not available.");if(r.content===void 0){var e;switch(r.encryptedContent.algorithm){case U.pki.oids["aes128-CBC"]:case U.pki.oids["aes192-CBC"]:case U.pki.oids["aes256-CBC"]:e=U.aes.createDecryptionCipher(r.encryptedContent.key);break;case U.pki.oids.desCBC:case U.pki.oids["des-EDE3-CBC"]:e=U.des.createDecryptionCipher(r.encryptedContent.key);break;default:throw new Error("Unsupported symmetric cipher, OID "+r.encryptedContent.algorithm)}if(e.start(r.encryptedContent.parameter),e.update(r.encryptedContent.content),!e.finish())throw new Error("Symmetric decryption failed.");r.content=e.output}}const B6=Vt.pki,_se=(r,e)=>{const t=B6.rsa.setPublicKey(e.n,e.e),n=B6.createCertificate();n.publicKey=t,n.serialNumber="01",n.validity.notBefore=new Date,n.validity.notAfter=new Date,n.validity.notAfter.setFullYear(n.validity.notBefore.getFullYear()+10);const s=[{name:"organizationName",value:"ipfs"},{shortName:"OU",value:"keystore"},{name:"commonName",value:r.id}];return n.setSubject(s),n.setIssuer(s),n.setExtensions([{name:"basicConstraints",cA:!0},{name:"keyUsage",keyCertSign:!0,digitalSignature:!0,nonRepudiation:!0,keyEncipherment:!0,dataEncipherment:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0,codeSigning:!0,emailProtection:!0,timeStamping:!0},{name:"nsCertType",client:!0,server:!0,email:!0,objsign:!0,sslCA:!0,emailCA:!0,objCA:!0}]),n.sign(e),n};async function vse(r,e){const t=r.map(e),s=(await Promise.all(t)).findIndex(i=>i);return r[s]}const Sse=P("libp2p:keychain:cms"),qf=new WeakMap;class Rse{constructor(e,t){if(e==null)throw v(new Error("keychain is required"),k.ERR_KEYCHAIN_REQUIRED);this.keychain=e,qf.set(this,{dek:t})}async encrypt(e,t){if(!(t instanceof Uint8Array))throw v(new Error("Plain data must be a Uint8Array"),k.ERR_INVALID_PARAMETERS);const n=await this.keychain.findKeyByName(e),s=await this.keychain.getPrivateKey(e),i=qf.get(this);if(i==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const o=i.dek,a=Vt.pki.decryptRsaPrivateKey(s,o),c=await _se(n,a),h=Vt.pkcs7.createEnvelopedData();h.addRecipient(c),h.content=Vt.util.createBuffer(t),h.encrypt();const l=Vt.asn1.toDer(h.toAsn1()).getBytes();return L(l,"ascii")}async decrypt(e){if(!(e instanceof Uint8Array))throw v(new Error("CMS data is required"),k.ERR_INVALID_PARAMETERS);let t;try{const l=Vt.util.createBuffer(B(e,"ascii")),u=Vt.asn1.fromDer(l);t=Vt.pkcs7.messageFromAsn1(u)}catch(l){throw Sse.error(l),v(new Error("Invalid CMS"),k.ERR_INVALID_CMS)}const n=t.recipients.filter(l=>l.issuer.find(u=>u.shortName==="O"&&u.value==="ipfs")).filter(l=>l.issuer.find(u=>u.shortName==="CN")).map(l=>({recipient:l,keyId:l.issuer.find(u=>u.shortName==="CN").value})),s=await vse(n,async l=>{try{if(await this.keychain.findKeyById(l.keyId)!=null)return!0}catch{return!1}return!1});if(s==null){const l=n.map(u=>u.keyId);throw v(new Error(`Decryption needs one of the key(s): ${l.join(", ")}`),k.ERR_MISSING_KEYS,{missingKeys:l})}const i=await this.keychain.findKeyById(s.keyId);if(i==null)throw v(new Error("No key available to decrypto"),k.ERR_NO_KEY);const o=await this.keychain.getPrivateKey(i.name),a=qf.get(this);if(a==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const c=a.dek,h=Vt.pki.decryptRsaPrivateKey(o,c);return t.decrypt(s.recipient,h),L(t.content.getBytes(),"ascii")}}const _l=P("libp2p:keychain"),Ase="/pkcs8/",s_="/info/",ls=new WeakMap,ni={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Gf={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function vn(r){return r==null||typeof r!="string"?!1:r===nse(r.trim())&&r.length>0}async function Ee(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function jr(r){return new X(Ase+r)}function Sn(r){return new X(s_+r)}class Tu{constructor(e,t){if(this.components=e,this.init=Ue(Gf,t),this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<ni.minKeyLength)throw new Error(`dek.keyLength must be least ${ni.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<ni.minSaltLength)throw new Error(`dek.saltLength must be least ${ni.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<ni.minIterationCount)throw new Error(`dek.iterationCount must be least ${ni.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?Cg(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";ls.set(this,{dek:n}),this.started=!1}isStarted(){return this.started}async start(){const e=Sn("self");await this.components.datastore.has(e)||await this.importPeer("self",this.components.peerId),this.started=!0}stop(){this.started=!1}get cms(){const e=ls.get(this);if(e==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const t=e.dek;return new Rse(this,t)}static generateOptions(){const e=Object.assign({},Gf),t=Math.ceil(ni.minSaltLength/3)*3;return e.dek.salt=B(Yu(t),"base64"),e}static get options(){return Gf}async createKey(e,t,n=2048){if(!vn(e)||e==="self")throw await Ee(),v(new Error("Invalid key name"),k.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await Ee(),v(new Error("Invalid key type"),k.ERR_INVALID_KEY_TYPE);const s=jr(e);if(await this.components.datastore.has(s))throw await Ee(),v(new Error("Key name already exists"),k.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(n)||n<2048)throw await Ee(),v(new Error("Invalid RSA key size"),k.ERR_INVALID_KEY_SIZE);break}let o;try{const a=await Sp(t,n),c=await a.id(),h=ls.get(this);if(h==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const l=h.dek,u=await a.export(l);o={name:e,id:c};const f=this.components.datastore.batch();f.put(s,L(u)),f.put(Sn(e),L(JSON.stringify(o))),await f.commit()}catch(a){throw await Ee(),a}return o}async listKeys(){const e={prefix:s_},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(B(n.value)));return t}async findKeyById(e){try{return(await this.listKeys()).find(n=>n.id===e)}catch(t){throw await Ee(),t}}async findKeyByName(e){if(!vn(e))throw await Ee(),v(new Error(`Invalid key name '${e}'`),k.ERR_INVALID_KEY_NAME);const t=Sn(e);try{const n=await this.components.datastore.get(t);return JSON.parse(B(n))}catch(n){throw await Ee(),_l.error(n),v(new Error(`Key '${e}' does not exist.`),k.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!vn(e)||e==="self")throw await Ee(),v(new Error(`Invalid key name '${e}'`),k.ERR_INVALID_KEY_NAME);const t=jr(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(Sn(e)),await s.commit(),n}async renameKey(e,t){if(!vn(e)||e==="self")throw await Ee(),v(new Error(`Invalid old key name '${e}'`),k.ERR_OLD_KEY_NAME_INVALID);if(!vn(t)||t==="self")throw await Ee(),v(new Error(`Invalid new key name '${t}'`),k.ERR_NEW_KEY_NAME_INVALID);const n=jr(e),s=jr(t),i=Sn(e),o=Sn(t);if(await this.components.datastore.has(s))throw await Ee(),v(new Error(`Key '${t}' already exists`),k.ERR_KEY_ALREADY_EXISTS);try{const c=await this.components.datastore.get(n),h=await this.components.datastore.get(i),l=JSON.parse(B(h));l.name=t;const u=this.components.datastore.batch();return u.put(s,c),u.put(o,L(JSON.stringify(l))),u.delete(n),u.delete(i),await u.commit(),l}catch(c){throw await Ee(),c}}async exportKey(e,t){if(!vn(e))throw await Ee(),v(new Error(`Invalid key name '${e}'`),k.ERR_INVALID_KEY_NAME);if(t==null)throw await Ee(),v(new Error("Password is required"),k.ERR_PASSWORD_REQUIRED);const n=jr(e);try{const s=await this.components.datastore.get(n),i=B(s),o=ls.get(this);if(o==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const a=o.dek;return await(await Qi(i,a)).export(t)}catch(s){throw await Ee(),s}}async exportPeerId(e){const t="temporary-password",n=await this.exportKey(e,t),s=await Qi(n,t);return await Ir(s.public.bytes,s.bytes)}async importKey(e,t,n){if(!vn(e)||e==="self")throw await Ee(),v(new Error(`Invalid key name '${e}'`),k.ERR_INVALID_KEY_NAME);if(t==null)throw await Ee(),v(new Error("PEM encoded key is required"),k.ERR_PEM_REQUIRED);const s=jr(e);if(await this.components.datastore.has(s))throw await Ee(),v(new Error(`Key '${e}' already exists`),k.ERR_KEY_ALREADY_EXISTS);let o;try{o=await Qi(t,n)}catch{throw await Ee(),v(new Error("Cannot read the key, most likely the password is wrong"),k.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();const l=ls.get(this);if(l==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const u=l.dek;t=await o.export(u)}catch(l){throw await Ee(),l}const c={name:e,id:a},h=this.components.datastore.batch();return h.put(s,L(t)),h.put(Sn(e),L(JSON.stringify(c))),await h.commit(),c}async importPeer(e,t){try{if(!vn(e))throw v(new Error(`Invalid key name '${e}'`),k.ERR_INVALID_KEY_NAME);if(t==null)throw v(new Error("PeerId is required"),k.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw v(new Error("PeerId.privKey is required"),k.ERR_MISSING_PRIVATE_KEY);const n=await Qs(t.privateKey),s=jr(e);if(await this.components.datastore.has(s))throw await Ee(),v(new Error(`Key '${e}' already exists`),k.ERR_KEY_ALREADY_EXISTS);const o=ls.get(this);if(o==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const a=o.dek,c=await n.export(a),h={name:e,id:t.toString()},l=this.components.datastore.batch();return l.put(s,L(c)),l.put(Sn(e),L(JSON.stringify(h))),await l.commit(),h}catch(n){throw await Ee(),n}}async getPrivateKey(e){if(!vn(e))throw await Ee(),v(new Error(`Invalid key name '${e}'`),k.ERR_INVALID_KEY_NAME);try{const t=jr(e),n=await this.components.datastore.get(t);return B(n)}catch(t){throw await Ee(),_l.error(t),v(new Error(`Key '${e}' does not exist.`),k.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Ee(),v(new Error(`Invalid old pass type '${typeof e}'`),k.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await Ee(),v(new Error(`Invalid new pass type '${typeof t}'`),k.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await Ee(),v(new Error(`Invalid pass length ${t.length}`),k.ERR_INVALID_PASS_LENGTH);_l("recreating keychain");const n=ls.get(this);if(n==null)throw v(new Error("dek missing"),k.ERR_INVALID_PARAMETERS);const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?Cg(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";ls.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(jr(a.name)),h=B(c),l=await Qi(h,s),u=i.toString(),f=await l.export(u),g=this.components.datastore.batch(),d={name:a.name,id:a.id};g.put(jr(a.name),L(f)),g.put(Sn(a.name),L(JSON.stringify(d))),await g.commit()}_l("keychain reconstructed")}}async function Wf(r){try{return{status:"fulfilled",value:await r,isFulfilled:!0,isRejected:!1}}catch(e){return{status:"rejected",reason:e,isFulfilled:!1,isRejected:!0}}}class Ise{constructor(e){Md(this,"value");Md(this,"next");this.value=e}}var Zr,pi,gi;class Cse{constructor(){zc(this,Zr,void 0);zc(this,pi,void 0);zc(this,gi,void 0);this.clear()}enqueue(e){const t=new Ise(e);ss(this,Zr)?(ss(this,pi).next=t,wn(this,pi,t)):(wn(this,Zr,t),wn(this,pi,t)),Ud(this,gi)._++}dequeue(){const e=ss(this,Zr);if(e)return wn(this,Zr,ss(this,Zr).next),Ud(this,gi)._--,e.value}clear(){wn(this,Zr,void 0),wn(this,pi,void 0),wn(this,gi,0)}get size(){return ss(this,gi)}*[Symbol.iterator](){let e=ss(this,Zr);for(;e;)yield e.value,e=e.next}}Zr=new WeakMap,pi=new WeakMap,gi=new WeakMap;function Tse(r){if(!((Number.isInteger(r)||r===Number.POSITIVE_INFINITY)&&r>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up");const e=new Cse;let t=0;const n=()=>{t--,e.size>0&&e.dequeue()()},s=async(a,c,h)=>{t++;const l=(async()=>a(...h))();c(l);try{await l}catch{}n()},i=(a,c,h)=>{e.enqueue(s.bind(void 0,a,c,h)),(async()=>(await Promise.resolve(),t<r&&e.size>0&&e.dequeue()()))()},o=(a,...c)=>new Promise(h=>{i(a,h,c)});return Object.defineProperties(o,{activeCount:{get:()=>t},pendingCount:{get:()=>e.size},clearQueue:{value:()=>{e.clear()}}}),o}async function kse(r,e={}){const{concurrency:t=Number.POSITIVE_INFINITY}=e,n=Tse(t);return Promise.all(r.map(s=>s&&typeof s.then=="function"?Wf(s):Wf(typeof s=="function"?n(()=>s()):Promise.resolve(s))))}class Dse extends Map{constructor(e){super();const{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Ii(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new Dse({name:e,metrics:t}):n=new Map,n}const si=P("libp2p:transports");class Pse extends Fe{constructor(e,t={}){super(),this.components=e,this.started=!1,this.transports=new Map,this.listeners=Ii({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??lo.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw v(new Error("Transport must have a valid tag"),k.ERR_INVALID_KEY);if(this.transports.has(t))throw v(new Error("There is already a transport with this tag"),k.ERR_DUPLICATE_TRANSPORT);si("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}async start(){const e=this.components.addressManager.getListenAddrs();await this.listen(e),this.started=!0}async stop(){const e=[];for(const[t,n]of this.listeners)for(si("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),si("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.transportForMultiaddr(e);if(n==null)throw v(new Error(`No transport available for address ${String(e)}`),k.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(s){throw s.code==null&&(s.code=k.ERR_TRANSPORT_DIAL_FAILED),s}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}transportForMultiaddr(e){for(const t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(e==null||e.length===0){si("no addresses were provided for listening, this node is dial only");return}const t=[];for(const[n,s]of this.transports.entries()){const i=s.filter(e),o=[];for(const h of i){si("creating listener for %s on %s",n,h);const l=s.createListener({upgrader:this.components.upgrader});let u=this.listeners.get(n);u==null&&(u=[],this.listeners.set(n,u)),u.push(l),l.addEventListener("listening",()=>{this.dispatchEvent(new F("listener:listening",{detail:l}))}),l.addEventListener("close",()=>{this.dispatchEvent(new F("listener:close",{detail:l}))}),o.push(l.listen(h))}if(o.length===0){t.push(n);continue}if((await kse(o)).find(h=>h.isFulfilled)==null&&this.faultTolerance!==lo.NO_FATAL)throw v(new Error(`Transport (${n}) could not listen on any available address`),k.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const n=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===lo.FATAL_ALL)throw v(new Error(n),k.ERR_NO_VALID_ADDRESSES);si(`libp2p in dial mode only: ${n}`)}}async remove(e){si("removing %s",e);for(const t of this.listeners.get(e)??[])await t.close();this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const uo="/multistream/1.0.0",Ose=1024,Nse=P("libp2p:mss"),i_=L(`
`);function ag(r){const e=new ke(r,i_);return ar.single(e)}function Pa(r,e,t={}){const n=ag(e);t.writeBytes===!0?r.push(n.subarray()):r.push(n)}function xse(r,e,t={}){const n=new ke;for(const s of e)n.append(ag(s));t.writeBytes===!0?r.push(n.subarray()):r.push(n)}async function $se(r,e){let t=1;const n={[Symbol.asyncIterator]:()=>n,next:async()=>await r.next(t)};let s=n;e?.signal!=null&&(s=Zt(n,e.signal));const o=await ie(s,er({onLength:a=>{t=a},maxDataLength:Ose}),async a=>await Rr(a));if(o==null||o.length===0)throw v(new Error("no buffer returned"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==i_[0])throw Nse.error("Invalid mss message - missing newline - %s",o.subarray()),v(new Error("missing newline"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}async function Xl(r,e){const t=await $se(r,e);return B(t.subarray())}const ga=P("libp2p:mss:select");async function Yf(r,e,t={}){e=Array.isArray(e)?[...e]:[e];const{reader:n,writer:s,rest:i,stream:o}=kd(r),a=e.shift();if(a==null)throw new Error("At least one protocol must be specified");ga('select: write ["%s", "%s"]',uo,a);const c=L(uo),h=L(a);xse(s,[c,h],t);let l=await Xl(n,t);if(ga('select: read "%s"',l),l===uo&&(l=await Xl(n,t),ga('select: read "%s"',l)),l===a)return i(),{stream:o,protocol:a};for(const u of e){ga('select: write "%s"',u),Pa(s,L(u),t);const f=await Xl(n,t);if(ga('select: read "%s" for "%s"',f,u),f===u)return i(),{stream:o,protocol:u}}throw i(),v(new Error("protocol selection failed"),"ERR_UNSUPPORTED_PROTOCOL")}const ya=P("libp2p:mss:handle");async function Qf(r,e,t){e=Array.isArray(e)?e:[e];const{writer:n,reader:s,rest:i,stream:o}=kd(r);for(;;){const a=await Xl(s,t);if(ya('read "%s"',a),a===uo){ya('respond with "%s" for "%s"',uo,a),Pa(n,L(uo),t);continue}if(e.includes(a))return Pa(n,L(a),t),ya('respond with "%s" for "%s"',a,a),i(),{stream:o,protocol:a};if(a==="ls"){Pa(n,new ke(...e.map(c=>ag(L(c)))),t),ya('respond with "%s" for %s',e,a);continue}Pa(n,L("na"),t),ya('respond with "na" for "%s"',a)}}const Lse=Symbol.for("@libp2p/connection"),Mse=P("libp2p:connection");class Use{constructor(e){const{remoteAddr:t,remotePeer:n,newStream:s,close:i,getStreams:o,stat:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.stat={...a,status:BE},this._newStream=s,this._close=i,this._getStreams=o,this.tags=[],this._closing=!1}get[Symbol.toStringTag](){return"Connection"}get[Lse](){return!0}get streams(){return this._getStreams()}async newStream(e,t){if(this.stat.status===S6)throw v(new Error("the connection is being closed"),"ERR_CONNECTION_BEING_CLOSED");if(this.stat.status===Hf)throw v(new Error("the connection is closed"),"ERR_CONNECTION_CLOSED");Array.isArray(e)||(e=[e]);const n=await this._newStream(e,t);return n.stat.direction="outbound",n}addStream(e){e.stat.direction="inbound"}removeStream(e){}async close(){if(!(this.stat.status===Hf||this._closing)){this.stat.status=S6;try{this.streams.forEach(e=>e.close())}catch(e){Mse.error(e)}this._closing=!0,await this._close(),this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=Hf}}}function Bse(r){return new Use(r)}const Xf=P("libp2p:registrar"),o_=32,a_=64;class zse{constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onProtocolChange=this._onProtocolChange.bind(this),this._onConnect=this._onConnect.bind(this),this.components.connectionManager.addEventListener("peer:disconnect",this._onDisconnect),this.components.connectionManager.addEventListener("peer:connect",this._onConnect),this.components.peerStore.addEventListener("change:protocols",this._onProtocolChange)}getProtocols(){return Array.from(new Set([...this.topologies.keys(),...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw v(new Error(`No handler registered for protocol ${e}`),k.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw v(new Error(`Handler already registered for protocol ${e}`),k.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const s=Ue.bind({ignoreUndefined:!0})({maxInboundStreams:o_,maxOutboundStreams:a_},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.protoBook.add(this.components.peerId,[e])}async unhandle(e){const t=Array.isArray(e)?e:[e];t.forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.protoBook.remove(this.components.peerId,t)}async register(e,t){if(!wG(t))throw Xf.error("topology must be an instance of interfaces/topology"),v(new Error("topology must be an instance of interfaces/topology"),k.ERR_INVALID_PARAMETERS);const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),await t.setRegistrar(this),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then(n=>{for(const s of n){const i=this.topologies.get(s);if(i!=null)for(const o of i.values())o.onDisconnect(t.remotePeer)}}).catch(n=>{Xf.error(n)})}_onConnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then(n=>{for(const s of n){const i=this.topologies.get(s);if(i!=null)for(const o of i.values())o.onConnect(t.remotePeer,t)}}).catch(n=>{Xf.error(n)})}_onProtocolChange(e){const{peerId:t,protocols:n,oldProtocols:s}=e.detail,i=s.filter(a=>!n.includes(a)),o=n.filter(a=>!s.includes(a));for(const a of i){const c=this.topologies.get(a);if(c!=null)for(const h of c.values())h.onDisconnect(t)}for(const a of o){const c=this.topologies.get(a);if(c!=null)for(const h of c.values()){const l=this.components.connectionManager.getConnections(t)[0];l!=null&&h.onConnect(t,l)}}}}const Ae=P("libp2p:upgrader");function Fse(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.code!==k.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return o_}function Vse(r,e){try{const{options:t}=e.getHandler(r);return t.maxOutboundStreams}catch(t){if(t.code!==k.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return a_}function z6(r,e,t){let n=0;return t.streams.forEach(s=>{s.stat.direction===e&&s.stat.protocol===r&&n++}),n}class Kse extends Fe{constructor(e,t){super(),this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(n=>{this.connectionEncryption.set(n.protocol,n)}),this.muxers=new Map,t.muxers.forEach(n=>{this.muxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw v(new Error("connection denied"),k.ERR_CONNECTION_DENIED);let s,i,o,a,c;const h=new ze.TimeoutController(this.inboundUpgradeTimeout);try{Ce.setMaxListeners?.(1/0,h.signal)}catch{}try{const l=sn(e,h.signal);if(e.source=l.source,e.sink=l.sink,await this.components.connectionGater.denyInboundConnection(e))throw v(new Error("The multiaddr connection is blocked by gater.acceptConnection"),k.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),Ae("starting the inbound connection upgrade");let u=e;if(t?.skipProtection!==!0){const f=this.components.connectionProtector;f!=null&&(Ae("protecting the inbound connection"),u=await f.protect(e))}try{if(s=u,t?.skipEncryption!==!0){if({conn:s,remotePeer:i,protocol:c}=await this._encryptInbound(u),await this.components.connectionGater.denyInboundEncryptedConnection(i,{...u,...s}))throw v(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),k.ERR_CONNECTION_INTERCEPTED)}else{const f=e.remoteAddr.getPeerId();if(f==null)throw v(new Error("inbound connection that skipped encryption must have a peer id"),k.ERR_INVALID_MULTIADDR);const g=Z(f);c="native",i=g}if(o=s,t?.muxerFactory!=null)a=t.muxerFactory;else if(this.muxers.size>0){const f=await this._multiplexInbound({...u,...s},this.muxers);a=f.muxerFactory,o=f.stream}}catch(f){throw Ae.error("Failed to upgrade inbound connection",f),f}if(await this.components.connectionGater.denyInboundUpgradedConnection(i,{...u,...s}))throw v(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),k.ERR_CONNECTION_INTERCEPTED);return Ae("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i})}finally{this.components.connectionManager.afterUpgradeInbound(),h.clear()}}async upgradeOutbound(e,t){const n=e.remoteAddr.getPeerId();let s;if(n!=null&&(s=Z(n),await this.components.connectionGater.denyOutboundConnection(s,e)))throw v(new Error("The multiaddr connection is blocked by connectionGater.denyOutboundConnection"),k.ERR_CONNECTION_INTERCEPTED);let i,o,a,c,h;this.components.metrics?.trackMultiaddrConnection(e),Ae("Starting the outbound connection upgrade");let l=e;if(t?.skipProtection!==!0){const u=this.components.connectionProtector;u!=null&&(l=await u.protect(e))}try{if(i=l,t?.skipEncryption!==!0){if({conn:i,remotePeer:o,protocol:c}=await this._encryptOutbound(l,s),await this.components.connectionGater.denyOutboundEncryptedConnection(o,{...l,...i}))throw v(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),k.ERR_CONNECTION_INTERCEPTED)}else{if(s==null)throw v(new Error("Encryption was skipped but no peer id was passed"),k.ERR_INVALID_PEER);c="native",o=s}if(a=i,t?.muxerFactory!=null)h=t.muxerFactory;else if(this.muxers.size>0){const u=await this._multiplexOutbound({...l,...i},this.muxers);h=u.muxerFactory,a=u.stream}}catch(u){throw Ae.error("Failed to upgrade outbound connection",u),await e.close(u),u}if(await this.components.connectionGater.denyOutboundUpgradedConnection(o,{...l,...i}))throw v(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),k.ERR_CONNECTION_INTERCEPTED);return Ae("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:h,remotePeer:o})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a}=e;let c,h,l;a!=null&&(c=a.createStreamMuxer({direction:n,onIncomingStream:g=>{l!=null&&Promise.resolve().then(async()=>{const d=this.components.registrar.getProtocols(),{stream:p,protocol:w}=await Qf(g,d);if(Ae("%s: incoming stream opened on %s",n,w),l==null)return;const y=Fse(w,this.components.registrar);if(z6(w,"inbound",l)===y){g.abort(v(new Error(`Too many inbound protocol streams for protocol "${w}" - limit ${y}`),k.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS));return}g.source=p.source,g.sink=p.sink,g.stat.protocol=w,this.components.peerStore.protoBook.add(o,[w]).catch(m=>Ae.error(m)),l.addStream(g),this.components.metrics?.trackProtocolStream(g,l),this._onStream({connection:l,stream:g,protocol:w})}).catch(d=>{Ae.error(d),g.stat.timeline.close==null&&g.close()})},onStreamEnd:g=>{l?.removeStream(g.id)}}),h=async(g,d={})=>{if(c==null)throw v(new Error("Stream is not multiplexed"),k.ERR_MUXER_UNAVAILABLE);Ae("%s: starting new stream on %s",n,g);const p=await c.newStream();let w;try{if(d.signal==null){Ae("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",g),w=new ze.TimeoutController(3e4),d.signal=w.signal;try{Ce.setMaxListeners?.(1/0,w.signal)}catch{}}const{stream:y,protocol:_}=await Yf(p,g,d),m=Vse(_,this.components.registrar);if(z6(_,"outbound",l)===m){const S=v(new Error(`Too many outbound protocol streams for protocol "${_}" - limit ${m}`),k.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw p.abort(S),S}return this.components.peerStore.protoBook.add(o,[_]).catch(S=>Ae.error(S)),p.source=y.source,p.sink=y.sink,p.stat.protocol=_,this.components.metrics?.trackProtocolStream(p,l),p}catch(y){throw Ae.error("could not create new stream",y),p.stat.timeline.close==null&&p.close(),y.code!=null?y:v(y,k.ERR_UNSUPPORTED_PROTOCOL)}finally{w?.clear()}},Promise.all([c.sink(i.source),i.sink(c.source)]).catch(g=>{Ae.error(g)}));const u=s.timeline;s.timeline=new Proxy(u,{set:(...g)=>(l!=null&&g[1]==="close"&&g[2]!=null&&u.close==null&&(async()=>{try{l.stat.status==="OPEN"&&await l.close()}catch(d){Ae.error(d)}finally{this.dispatchEvent(new F("connectionEnd",{detail:l}))}})().catch(d=>{Ae.error(d)}),Reflect.set(...g))}),s.timeline.upgraded=Date.now();const f=()=>{throw v(new Error("connection is not multiplexed"),k.ERR_CONNECTION_NOT_MULTIPLEXED)};return l=Bse({remoteAddr:s.remoteAddr,remotePeer:o,stat:{status:"OPEN",direction:n,timeline:s.timeline,multiplexer:c?.protocol,encryption:t},newStream:h??f,getStreams:()=>c!=null?c.streams:f(),close:async()=>{await s.close(),c?.close()}}),this.dispatchEvent(new F("connection",{detail:l})),l}_onStream(e){const{connection:t,stream:n,protocol:s}=e,{handler:i}=this.components.registrar.getHandler(s);i({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());Ae("handling inbound crypto protocol selection",t);try{const{stream:n,protocol:s}=await Qf(e,t,{writeBytes:!0}),i=this.connectionEncryption.get(s);if(i==null)throw new Error(`no crypto module found for ${s}`);return Ae("encrypting inbound connection..."),{...await i.secureInbound(this.components.peerId,n),protocol:s}}catch(n){throw v(n,k.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());Ae("selecting outbound crypto protocol",n);try{const{stream:s,protocol:i}=await Yf(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(i);if(o==null)throw new Error(`no crypto module found for ${i}`);return Ae("encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,s,t),protocol:i}}catch(s){throw v(s,k.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());Ae("outbound selecting muxer %s",n);try{const{stream:s,protocol:i}=await Yf(e,n,{writeBytes:!0});Ae("%s selected as muxer protocol",i);const o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw Ae.error("error multiplexing outbound stream",s),v(s,k.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());Ae("inbound handling muxers %s",n);try{const{stream:s,protocol:i}=await Qf(e,n,{writeBytes:!0}),o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw Ae.error("error multiplexing inbound stream",s),v(s,k.ERR_MUXER_UNAVAILABLE)}}}var eo;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={listenAddrs:[],protocols:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 5:s.protocolVersion=t.string();break;case 6:s.agentVersion=t.string();break;case 1:s.publicKey=t.bytes();break;case 2:s.listenAddrs.push(t.bytes());break;case 4:s.observedAddr=t.bytes();break;case 3:s.protocols.push(t.string());break;case 8:s.signedPeerRecord=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(eo||(eo={}));const c_="0.0.0",jse="libp2p",l_=`js-libp2p/${c_}`,Hse="0.1.0",qse="id",Gse="id/push",Wse="1.0.0",Yse="1.0.0",Se=P("libp2p:identify"),F6=1024*8;class cg{constructor(e,t){this.components=e,this.started=!1,this.init=t,this.identifyProtocolStr=`/${t.protocolPrefix}/${qse}/${Wse}`,this.identifyPushProtocolStr=`/${t.protocolPrefix}/${Gse}/${Yse}`,this.host={protocolVersion:`${t.protocolPrefix}/${Hse}`,...t.host},this.components.connectionManager.addEventListener("peer:connect",n=>{const s=n.detail;this.identify(s).catch(Se.error)}),this.components.peerStore.addEventListener("change:multiaddrs",n=>{const{peerId:s}=n.detail;this.components.peerId.equals(s)&&this.pushToPeerStore().catch(i=>Se.error(i))}),this.components.peerStore.addEventListener("change:protocols",n=>{const{peerId:s}=n.detail;this.components.peerId.equals(s)&&this.pushToPeerStore().catch(i=>Se.error(i))})}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.metadataBook.setValue(this.components.peerId,"AgentVersion",L(this.host.agentVersion)),await this.components.peerStore.metadataBook.setValue(this.components.peerId,"ProtocolVersion",L(this.host.protocolVersion)),await this.components.registrar.handle(this.identifyProtocolStr,e=>{this._handleIdentify(e).catch(t=>{Se.error(t)})},{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),await this.components.registrar.handle(this.identifyPushProtocolStr,e=>{this._handlePush(e).catch(t=>{Se.error(t)})},{maxInboundStreams:this.init.maxPushIncomingStreams,maxOutboundStreams:this.init.maxPushOutgoingStreams}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.identifyProtocolStr),await this.components.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async push(e){const t=await this.components.peerStore.addressBook.getRawEnvelope(this.components.peerId),n=this.components.addressManager.getAddresses().map(o=>o.bytes),s=await this.components.peerStore.protoBook.get(this.components.peerId),i=e.map(async o=>{let a;const c=new ze.TimeoutController(this.init.timeout);try{Ce.setMaxListeners?.(1/0,c.signal)}catch{}try{a=await o.newStream([this.identifyPushProtocolStr],{signal:c.signal}),await sn(a,c.signal).sink(ie([eo.encode({listenAddrs:n,signedPeerRecord:t,protocols:s})],ar()))}catch(h){Se.error("could not push identify update to peer",h)}finally{a?.close(),c.clear()}});await Promise.all(i)}async pushToPeerStore(){if(!this.isStarted())return;const e=[];for(const t of this.components.connectionManager.getConnections()){const n=t.remotePeer;(await this.components.peerStore.get(n)).protocols.includes(this.identifyPushProtocolStr)&&e.push(t)}await this.push(e)}async _identify(e,t={}){let n,s=t.signal,i;if(s==null){n=new ze.TimeoutController(this.init.timeout),s=n.signal;try{Ce.setMaxListeners?.(1/0,n.signal)}catch{}}try{i=await e.newStream([this.identifyProtocolStr],{signal:s});const o=sn(i,s),a=await ie([],o,er({maxDataLength:this.init.maxIdentifyMessageSize??F6}),async c=>await Rr(c));if(a==null)throw v(new Error("No data could be retrieved"),k.ERR_CONNECTION_ENDED);try{return eo.decode(a)}catch(c){throw v(c,k.ERR_INVALID_MESSAGE)}}finally{n?.clear(),i?.close()}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,listenAddrs:i,protocols:o,observedAddr:a,signedPeerRecord:c,agentVersion:h,protocolVersion:l}=n;if(s==null)throw v(new Error("public key was missing from identify message"),k.ERR_MISSING_PUBLIC_KEY);const u=await Ir(s);if(!e.remotePeer.equals(u))throw v(new Error("identified peer does not match the expected peer"),k.ERR_INVALID_PEER);if(this.components.peerId.equals(u))throw v(new Error("identified peer is our own peer id?"),k.ERR_INVALID_PEER);const f=cg.getCleanMultiaddr(a);if(c!=null){Se("received signed peer record from %p",u);try{const g=await or.openAndCertify(c,Jt.DOMAIN);if(!g.peerId.equals(u))throw v(new Error("identified peer does not match the expected peer"),k.ERR_INVALID_PEER);if(await this.components.peerStore.addressBook.consumePeerRecord(g)){await this.components.peerStore.protoBook.set(u,o),h!=null&&await this.components.peerStore.metadataBook.setValue(u,"AgentVersion",L(h)),l!=null&&await this.components.peerStore.metadataBook.setValue(u,"ProtocolVersion",L(l)),Se("identify completed for peer %p and protocols %o",u,o);return}}catch(g){Se("received invalid envelope, discard it and fallback to listenAddrs is available",g)}}else Se("no signed peer record received from %p",u);Se("falling back to legacy addresses from %p",u);try{await this.components.peerStore.addressBook.set(u,i.map(g=>G(g)))}catch(g){Se.error("received invalid addrs",g)}await this.components.peerStore.protoBook.set(u,o),h!=null&&await this.components.peerStore.metadataBook.setValue(u,"AgentVersion",L(h)),l!=null&&await this.components.peerStore.metadataBook.setValue(u,"ProtocolVersion",L(l)),Se("identify completed for peer %p and protocols %o",u,o),Se("received observed address of %s",f?.toString())}async _handleIdentify(e){const{connection:t,stream:n}=e,s=new ze.TimeoutController(this.init.timeout);try{Ce.setMaxListeners?.(1/0,s.signal)}catch{}try{const i=this.components.peerId.publicKey??new Uint8Array(0),o=await this.components.peerStore.get(this.components.peerId),a=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(Qu("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const f=new Jt({peerId:this.components.peerId,multiaddrs:a}),g=await or.seal(f,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(g),c=g.marshal().subarray()}const h=eo.encode({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:i,listenAddrs:a.map(f=>f.bytes),signedPeerRecord:c,observedAddr:t.remoteAddr.bytes,protocols:o.protocols}),l=sn(n,s.signal),u=ie([h],ar());await l.sink(u)}catch(i){Se.error("could not respond to identify request",i)}finally{n.close(),s.clear()}}async _handlePush(e){const{connection:t,stream:n}=e,s=new ze.TimeoutController(this.init.timeout);try{Ce.setMaxListeners?.(1/0,s.signal)}catch{}let i;try{const a=sn(n,s.signal),c=await ie([],a,er({maxDataLength:this.init.maxIdentifyMessageSize??F6}),async h=>await Rr(h));c!=null&&(i=eo.decode(c))}catch(a){return Se.error("received invalid message",a)}finally{n.close(),s.clear()}if(i==null)return Se.error("received invalid message");const o=t.remotePeer;if(this.components.peerId.equals(o)){Se("received push from ourselves?");return}if(Se("received push from %p",o),i.signedPeerRecord!=null){Se("received signedPeerRecord in push");try{const a=await or.openAndCertify(i.signedPeerRecord,Jt.DOMAIN);if(await this.components.peerStore.addressBook.consumePeerRecord(a)){Se("consumed signedPeerRecord sent in push"),await this.components.peerStore.protoBook.set(o,i.protocols);return}else Se("failed to consume signedPeerRecord sent in push")}catch(a){Se("received invalid envelope, discard it and fallback to listenAddrs is available",a)}}else Se("did not receive signedPeerRecord in push");try{await this.components.peerStore.addressBook.set(o,i.listenAddrs.map(a=>G(a)))}catch(a){Se.error("received invalid addrs",a)}try{await this.components.peerStore.protoBook.set(o,i.protocols)}catch(a){Se.error("received invalid protocols",a)}Se("handled push from %p",o)}static getCleanMultiaddr(e){if(e!=null&&e.length>0)try{return G(e)}catch{}}}var ku;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.identifier!=="")&&(n.uint32(10),n.string(t.identifier)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={identifier:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.identifier=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(ku||(ku={}));var Qr;(function(r){let e;(function(s){s.OK="OK",s.NOT_FOUND="NOT_FOUND",s.ERROR="ERROR"})(e=r.StatusCode||(r.StatusCode={}));let t;(function(s){s[s.OK=0]="OK",s[s.NOT_FOUND=1]="NOT_FOUND",s[s.ERROR=2]="ERROR"})(t||(t={})),function(s){s.codec=()=>fo(t)}(e=r.StatusCode||(r.StatusCode={}));let n;r.codec=()=>(n==null&&(n=Qe((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),(o.writeDefaults===!0||s.status!=null&&t[s.status]!==0)&&(i.uint32(8),r.StatusCode.codec().encode(s.status,i)),(o.writeDefaults===!0||s.data!=null&&s.data.byteLength>0)&&(i.uint32(18),i.bytes(s.data)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={status:e.OK,data:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.status=r.StatusCode.codec().decode(s);break;case 2:o.data=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>Xe(s,r.codec()),r.decode=s=>Je(s,r.codec())})(Qr||(Qr={}));const Qse="0.0.1",Xse="fetch",fr=P("libp2p:fetch");class Jse{constructor(e,t){this.started=!1,this.components=e,this.protocol=`/${t.protocolPrefix??"libp2p"}/${Xse}/${Qse}`,this.lookupFunctions=new Map,this.handleMessage=this.handleMessage.bind(this),this.init=t}async start(){await this.components.registrar.handle(this.protocol,e=>{this.handleMessage(e).catch(t=>{fr.error(t)}).finally(()=>{e.stream.close()})},{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async fetch(e,t,n={}){fr("dialing %s to %p",this.protocol,e);const s=await this.components.connectionManager.openConnection(e,n);let i,o=n.signal,a;if(o==null){fr("using default timeout of %d ms",this.init.timeout),i=new ze.TimeoutController(this.init.timeout),o=i.signal;try{Ce.setMaxListeners?.(1/0,i.signal)}catch{}}try{a=await s.newStream(this.protocol,{signal:o});const c=sn(a,o);return fr("fetch %s",t),await ie([ku.encode({identifier:t})],ar(),c,er(),async function(l){const u=await Rr(l);if(u==null)throw v(new Error("No data received"),k.ERR_INVALID_MESSAGE);const f=Qr.decode(u);switch(f.status){case Qr.StatusCode.OK:return fr("received status for %s ok",t),f.data;case Qr.StatusCode.NOT_FOUND:return fr("received status for %s not found",t),null;case Qr.StatusCode.ERROR:{fr("received status for %s error",t);const g=B(f.data);throw v(new Error("Error in fetch protocol response: "+g),k.ERR_INVALID_PARAMETERS)}default:throw fr("received status for %s unknown",t),v(new Error("Unknown response status"),k.ERR_INVALID_MESSAGE)}})??null}finally{i?.clear(),a?.close()}}async handleMessage(e){const{stream:t}=e,n=this;await ie(t,er(),async function*(s){const i=await Rr(s);if(i==null)throw v(new Error("No data received"),k.ERR_INVALID_MESSAGE);const o=ku.decode(i);let a;const c=n._getLookupFunction(o.identifier);if(c!=null){fr("look up data with identifier %s",o.identifier);const h=await c(o.identifier);h!=null?(fr("sending status for %s ok",o.identifier),a={status:Qr.StatusCode.OK,data:h}):(fr("sending status for %s not found",o.identifier),a={status:Qr.StatusCode.NOT_FOUND,data:new Uint8Array(0)})}else{fr("sending status for %s error",o.identifier);const h=L(`No lookup function registered for key: ${o.identifier}`);a={status:Qr.StatusCode.ERROR,data:h}}yield Qr.encode(a)},ar(),t)}_getLookupFunction(e){for(const t of this.lookupFunctions.keys())if(e.startsWith(t))return this.lookupFunctions.get(t)}registerLookupFunction(e,t){if(this.lookupFunctions.has(e))throw v(new Error("Fetch protocol handler for key prefix '"+e+"' already registered"),k.ERR_KEY_ALREADY_EXISTS);this.lookupFunctions.set(e,t)}unregisterLookupFunction(e,t){t!=null&&this.lookupFunctions.get(e)!==t||this.lookupFunctions.delete(e)}}const Zse=32,eie="1.0.0",tie="ping",V6=P("libp2p:ping");class rie{constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix}/${tie}/${eie}`,this.init=t}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const{stream:t}=e;ie(t,t).catch(n=>{V6.error(n)})}async ping(e,t={}){V6("dialing %s to %p",this.protocol,e);const n=Date.now(),s=Yu(Zse),i=await this.components.connectionManager.openConnection(e,t);let o,a=t.signal,c;if(a==null){o=new ze.TimeoutController(this.init.timeout),a=o.signal;try{Ce.setMaxListeners?.(1/0,o.signal)}catch{}}try{c=await i.newStream([this.protocol],{signal:a});const h=sn(c,a),l=await ie([s],h,async f=>await Rr(f)),u=Date.now();if(l==null||!Ye(s,l.subarray()))throw v(new Error("Received wrong ping ack"),k.ERR_WRONG_PING_ACK);return u-n}finally{o?.clear(),c?.close()}}}async function nie(){throw new Error("Not supported in browsers")}function sie(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function iie(r){const{address:e}=r.nodeAddress();return sie(e)}const Jf=P("libp2p:nat"),Zf=7200;function oie(r=1024,e=65535){return Math.floor(Math.random()*(e-r+1)+r)}class aie{constructor(e,t){if(this.components=e,this.started=!1,this.enabled=t.enabled,this.externalAddress=t.externalAddress,this.localAddress=t.localAddress,this.description=t.description??`${jse}@${c_} ${this.components.peerId.toString()}`,this.ttl=t.ttl??Zf,this.keepAlive=t.keepAlive??!0,this.gateway=t.gateway,this.ttl<Zf)throw v(new Error(`NatManager ttl should be at least ${Zf} seconds`),k.ERR_INVALID_PARAMETERS)}isStarted(){return this.started}start(){}afterStart(){qa||!this.enabled||this.started||(this.started=!0,this._start().catch(e=>{Jf.error(e)}))}async _start(){const e=this.components.transportManager.getAddrs();for(const t of e){const{family:n,host:s,port:i,transport:o}=t.toOptions();if(!t.isThinWaistAddress()||o!=="tcp"||iie(t)||n!==4)continue;const a=await this._getClient(),c=this.externalAddress??await a.externalIp(),h=Od(c);if(h===!0)throw new Error(`${c} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`);if(h==null)throw new Error(`${c} is not an IP address`);const l=oie();Jf(`opening uPnP connection from ${c}:${l} to ${s}:${i}`),await a.map({publicPort:l,localPort:i,localAddress:this.localAddress,protocol:o.toUpperCase()==="TCP"?"TCP":"UDP"}),this.components.addressManager.addObservedAddr(kv({family:4,address:c,port:l},o))}}async _getClient(){return this.client!=null?this.client:(this.client=await nie({description:this.description,ttl:this.ttl,keepAlive:this.keepAlive,gateway:this.gateway}),this.client)}async stop(){if(!(qa||this.client==null))try{await this.client.close(),this.client=void 0}catch(e){Jf.error(e)}}}const cie=P("libp2p:peer-record-updater");class lie{constructor(e){this.components=e,this.started=!1,this.update=this.update.bind(this)}isStarted(){return this.started}async start(){this.started=!0,this.components.transportManager.addEventListener("listener:listening",this.update),this.components.transportManager.addEventListener("listener:close",this.update),this.components.addressManager.addEventListener("change:addresses",this.update)}async stop(){this.started=!1,this.components.transportManager.removeEventListener("listener:listening",this.update),this.components.transportManager.removeEventListener("listener:close",this.update),this.components.addressManager.removeEventListener("change:addresses",this.update)}update(){Promise.resolve().then(async()=>{const e=new Jt({peerId:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(n=>n.decapsulateCode(Qu("p2p").code))}),t=await or.seal(e,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(t)}).catch(e=>{cie.error("Could not update self peer record: %o",e)})}}class hie{constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw v(new Error(we.NOT_FOUND),k.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const ue={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS",ERR_NOT_FOUND:"ERR_NOT_FOUND"};async function*uie(r,e){for await(const t of r)await e(t),yield t}const _e=P("libp2p:peer-store:address-book"),vl="change:multiaddrs";async function die(){return!0}class fie{constructor(e,t,n){this.dispatchEvent=e,this.store=t,this.addressFilter=n??die}async consumePeerRecord(e){_e.trace("consumePeerRecord await write lock");const t=await this.store.lock.writeLock();_e.trace("consumePeerRecord got write lock");let n,s,i;try{let o;try{o=Jt.createFromProtobuf(e.payload)}catch{return _e.error("invalid peer record received"),!1}n=o.peerId;const a=o.multiaddrs;if(!n.equals(e.peerId))return _e("signing key does not match PeerId in the PeerRecord"),!1;if(a==null||a.length===0)return!1;if(await this.store.has(n)&&(s=await this.store.load(n),s.peerRecordEnvelope!=null)){const h=await or.createFromProtobuf(s.peerRecordEnvelope),l=Jt.createFromProtobuf(h.payload);if(l.seqNumber>=o.seqNumber)return _e("sequence number was lower or equal to existing sequence number - stored: %d received: %d",l.seqNumber,o.seqNumber),!1}const c=await e1(n,a,this.addressFilter,!0);i=await this.store.patchOrCreate(n,{addresses:c,peerRecordEnvelope:e.marshal().subarray()}),_e("stored provided peer record for %p",o.peerId)}finally{_e.trace("consumePeerRecord release write lock"),t()}return this.dispatchEvent(new F(vl,{detail:{peerId:n,multiaddrs:i.addresses.map(({multiaddr:o})=>o),oldMultiaddrs:s==null?[]:s.addresses.map(({multiaddr:o})=>o)}})),!0}async getRawEnvelope(e){_e.trace("getRawEnvelope await read lock");const t=await this.store.lock.readLock();_e.trace("getRawEnvelope got read lock");try{return(await this.store.load(e)).peerRecordEnvelope}catch(n){if(n.code!==ue.ERR_NOT_FOUND)throw n}finally{_e.trace("getRawEnvelope release read lock"),t()}}async getPeerRecord(e){const t=await this.getRawEnvelope(e);if(t!=null)return await or.createFromProtobuf(t)}async get(e){e=gt(e),_e.trace("get wait for read lock");const t=await this.store.lock.readLock();_e.trace("get got read lock");try{return(await this.store.load(e)).addresses}catch(n){if(n.code!==ue.ERR_NOT_FOUND)throw n}finally{_e.trace("get release read lock"),t()}return[]}async set(e,t){if(e=gt(e),!Array.isArray(t))throw _e.error("multiaddrs must be an array of Multiaddrs"),v(new Error("multiaddrs must be an array of Multiaddrs"),ue.ERR_INVALID_PARAMETERS);_e.trace("set await write lock");const n=await this.store.lock.writeLock();_e.trace("set got write lock");let s=!1,i,o;try{const a=await e1(e,t,this.addressFilter);if(a.length===0)return;try{if(i=await this.store.load(e),s=!0,new Set([...a.map(({multiaddr:c})=>c.toString()),...i.addresses.map(({multiaddr:c})=>c.toString())]).size===i.addresses.length&&a.length===i.addresses.length)return}catch(c){if(c.code!==ue.ERR_NOT_FOUND)throw c}o=await this.store.patchOrCreate(e,{addresses:a}),_e("set multiaddrs for %p",e)}finally{_e.trace("set multiaddrs for %p",e),_e("set release write lock"),n()}this.dispatchEvent(new F(vl,{detail:{peerId:e,multiaddrs:o.addresses.map(a=>a.multiaddr),oldMultiaddrs:i==null?[]:i.addresses.map(({multiaddr:a})=>a)}})),s||this.dispatchEvent(new F("peer",{detail:{id:e,multiaddrs:o.addresses.map(a=>a.multiaddr),protocols:o.protocols}}))}async add(e,t){if(e=gt(e),!Array.isArray(t))throw _e.error("multiaddrs must be an array of Multiaddrs"),v(new Error("multiaddrs must be an array of Multiaddrs"),ue.ERR_INVALID_PARAMETERS);_e.trace("add await write lock");const n=await this.store.lock.writeLock();_e.trace("add got write lock");let s,i,o;try{const a=await e1(e,t,this.addressFilter);if(a.length===0)return;try{if(i=await this.store.load(e),s=!0,new Set([...a.map(({multiaddr:c})=>c.toString()),...i.addresses.map(({multiaddr:c})=>c.toString())]).size===i.addresses.length)return}catch(c){if(c.code!==ue.ERR_NOT_FOUND)throw c}o=await this.store.mergeOrCreate(e,{addresses:a}),_e("added multiaddrs for %p",e)}finally{_e.trace("set release write lock"),n()}this.dispatchEvent(new F(vl,{detail:{peerId:e,multiaddrs:o.addresses.map(a=>a.multiaddr),oldMultiaddrs:i==null?[]:i.addresses.map(({multiaddr:a})=>a)}})),s===!0&&this.dispatchEvent(new F("peer",{detail:{id:e,multiaddrs:o.addresses.map(a=>a.multiaddr),protocols:o.protocols}}))}async delete(e){e=gt(e),_e.trace("delete await write lock");const t=await this.store.lock.writeLock();_e.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{addresses:[]})}finally{_e.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new F(vl,{detail:{peerId:e,multiaddrs:[],oldMultiaddrs:n==null?[]:n.addresses.map(({multiaddr:s})=>s)}}))}}async function e1(r,e,t,n=!1){return await ie(e,s=>uie(s,i=>{if(!Ln(i))throw _e.error("multiaddr must be an instance of Multiaddr"),v(new Error("multiaddr must be an instance of Multiaddr"),ue.ERR_INVALID_PARAMETERS)}),s=>$e(s,async i=>await t(r,i)),s=>zt(s,i=>({multiaddr:i,isCertified:n})),async s=>await Kn(s))}const Hr=P("libp2p:peer-store:key-book"),K6="change:pubkey";class pie{constructor(e,t){this.dispatchEvent=e,this.store=t}async set(e,t){if(e=gt(e),!(t instanceof Uint8Array))throw Hr.error("publicKey must be an instance of Uint8Array to store data"),v(new Error("publicKey must be an instance of PublicKey"),ue.ERR_INVALID_PARAMETERS);Hr.trace("set await write lock");const n=await this.store.lock.writeLock();Hr.trace("set got write lock");let s=!1,i;try{try{if(i=await this.store.load(e),i.pubKey!=null&&Ye(i.pubKey,t))return}catch(o){if(o.code!==ue.ERR_NOT_FOUND)throw o}await this.store.patchOrCreate(e,{pubKey:t}),s=!0}finally{Hr.trace("set release write lock"),n()}s&&this.dispatchEvent(new F(K6,{detail:{peerId:e,publicKey:t,oldPublicKey:i?.pubKey}}))}async get(e){e=gt(e),Hr.trace("get await write lock");const t=await this.store.lock.readLock();Hr.trace("get got write lock");try{return(await this.store.load(e)).pubKey}catch(n){if(n.code!==ue.ERR_NOT_FOUND)throw n}finally{Hr("get release write lock"),t()}}async delete(e){e=gt(e),Hr.trace("delete await write lock");const t=await this.store.lock.writeLock();Hr.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{pubKey:void 0})}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s}finally{Hr.trace("delete release write lock"),t()}this.dispatchEvent(new F(K6,{detail:{peerId:e,publicKey:void 0,oldPublicKey:n?.pubKey}}))}}const tt=P("libp2p:peer-store:metadata-book"),Sl="change:metadata";class gie{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){e=gt(e),tt.trace("get await read lock");const t=await this.store.lock.readLock();tt.trace("get got read lock");try{return(await this.store.load(e)).metadata}catch(n){if(n.code!==ue.ERR_NOT_FOUND)throw n}finally{tt.trace("get release read lock"),t()}return new Map}async getValue(e,t){e=gt(e),tt.trace("getValue await read lock");const n=await this.store.lock.readLock();tt.trace("getValue got read lock");try{return(await this.store.load(e)).metadata.get(t)}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s}finally{tt.trace("getValue release write lock"),n()}}async set(e,t){if(e=gt(e),!(t instanceof Map))throw tt.error("valid metadata must be provided to store data"),v(new Error("valid metadata must be provided"),ue.ERR_INVALID_PARAMETERS);tt.trace("set await write lock");const n=await this.store.lock.writeLock();tt.trace("set got write lock");let s;try{try{s=await this.store.load(e)}catch(i){if(i.code!==ue.ERR_NOT_FOUND)throw i}await this.store.mergeOrCreate(e,{metadata:t})}finally{tt.trace("set release write lock"),n()}this.dispatchEvent(new F(Sl,{detail:{peerId:e,metadata:t,oldMetadata:s==null?new Map:s.metadata}}))}async setValue(e,t,n){if(e=gt(e),typeof t!="string"||!(n instanceof Uint8Array))throw tt.error("valid key and value must be provided to store data"),v(new Error("valid key and value must be provided"),ue.ERR_INVALID_PARAMETERS);tt.trace("setValue await write lock");const s=await this.store.lock.writeLock();tt.trace("setValue got write lock");let i,o;try{try{i=await this.store.load(e);const a=i.metadata.get(t);if(a!=null&&Ye(n,a))return}catch(a){if(a.code!==ue.ERR_NOT_FOUND)throw a}o=await this.store.mergeOrCreate(e,{metadata:new Map([[t,n]])})}finally{tt.trace("setValue release write lock"),s()}this.dispatchEvent(new F(Sl,{detail:{peerId:e,metadata:o.metadata,oldMetadata:i==null?new Map:i.metadata}}))}async delete(e){e=gt(e),tt.trace("delete await write lock");const t=await this.store.lock.writeLock();tt.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s}n!=null&&await this.store.patch(e,{metadata:new Map})}finally{tt.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new F(Sl,{detail:{peerId:e,metadata:new Map,oldMetadata:n.metadata}}))}async deleteValue(e,t){e=gt(e),tt.trace("deleteValue await write lock");const n=await this.store.lock.writeLock();tt.trace("deleteValue got write lock");let s,i;try{i=await this.store.load(e),s=i.metadata,s.delete(t),await this.store.patch(e,{metadata:s})}catch(o){if(o.code!==ue.ERR_NOT_FOUND)throw o}finally{tt.trace("deleteValue release write lock"),n()}s!=null&&this.dispatchEvent(new F(Sl,{detail:{peerId:e,metadata:s,oldMetadata:i==null?new Map:i.metadata}}))}}const rt=P("libp2p:peer-store:proto-book"),Rl="change:protocols";class yie{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){rt.trace("get wait for read lock");const t=await this.store.lock.readLock();rt.trace("get got read lock");try{return(await this.store.load(e)).protocols}catch(n){if(n.code!==ue.ERR_NOT_FOUND)throw n}finally{rt.trace("get release read lock"),t()}return[]}async set(e,t){if(e=gt(e),!Array.isArray(t))throw rt.error("protocols must be provided to store data"),v(new Error("protocols must be provided"),ue.ERR_INVALID_PARAMETERS);rt.trace("set await write lock");const n=await this.store.lock.writeLock();rt.trace("set got write lock");let s,i;try{try{if(s=await this.store.load(e),new Set([...t]).size===s.protocols.length)return}catch(o){if(o.code!==ue.ERR_NOT_FOUND)throw o}i=await this.store.patchOrCreate(e,{protocols:t}),rt("stored provided protocols for %p",e)}finally{rt.trace("set release write lock"),n()}this.dispatchEvent(new F(Rl,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async add(e,t){if(e=gt(e),!Array.isArray(t))throw rt.error("protocols must be provided to store data"),v(new Error("protocols must be provided"),ue.ERR_INVALID_PARAMETERS);rt.trace("add await write lock");const n=await this.store.lock.writeLock();rt.trace("add got write lock");let s,i;try{try{if(s=await this.store.load(e),new Set([...s.protocols,...t]).size===s.protocols.length)return}catch(o){if(o.code!==ue.ERR_NOT_FOUND)throw o}i=await this.store.mergeOrCreate(e,{protocols:t}),rt("added provided protocols for %p",e)}finally{rt.trace("add release write lock"),n()}this.dispatchEvent(new F(Rl,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async remove(e,t){if(e=gt(e),!Array.isArray(t))throw rt.error("protocols must be provided to store data"),v(new Error("protocols must be provided"),ue.ERR_INVALID_PARAMETERS);rt.trace("remove await write lock");const n=await this.store.lock.writeLock();rt.trace("remove got write lock");let s,i;try{try{s=await this.store.load(e);const o=new Set(s.protocols);for(const a of t)o.delete(a);if(s.protocols.length===o.size)return;t=Array.from(o)}catch(o){if(o.code!==ue.ERR_NOT_FOUND)throw o}i=await this.store.patchOrCreate(e,{protocols:t})}finally{rt.trace("remove release write lock"),n()}this.dispatchEvent(new F(Rl,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async delete(e){e=gt(e),rt.trace("delete await write lock");const t=await this.store.lock.writeLock();rt.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{protocols:[]})}finally{rt.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new F(Rl,{detail:{peerId:e,protocols:[],oldProtocols:n.protocols}}))}}let wie=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},mie=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return h_(this,e)}},bie=class{constructor(e){this.decoders=e}or(e){return h_(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const h_=(r,e)=>new bie({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Eie=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new wie(e,t,n),this.decoder=new mie(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const _ie=({name:r,prefix:e,encode:t,decode:n})=>new Eie(r,e,t,n),vie=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Sie=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},es=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>_ie({prefix:e,name:r,encode(s){return Sie(s,n,t)},decode(s){return vie(s,n,t,r)}}),Rie=es({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});es({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});es({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});es({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});es({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});es({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});es({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});es({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});es({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Du;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),Pu.codec().encode(i,n,{writeDefaults:!0});if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.metadata!=null)for(const i of t.metadata)n.uint32(26),Ou.codec().encode(i,n,{writeDefaults:!0});t.pubKey!=null&&(n.uint32(34),n.bytes(t.pubKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={addresses:[],protocols:[],metadata:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.addresses.push(Pu.codec().decode(t,t.uint32()));break;case 2:s.protocols.push(t.string());break;case 3:s.metadata.push(Ou.codec().decode(t,t.uint32()));break;case 4:s.pubKey=t.bytes();break;case 5:s.peerRecordEnvelope=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(Du||(Du={}));var Pu;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.multiaddr!=null&&t.multiaddr.byteLength>0)&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={multiaddr:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.multiaddr=t.bytes();break;case 2:s.isCertified=t.bool();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(Pu||(Pu={}));var Ou;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.key!=="")&&(n.uint32(10),n.string(t.key)),(s.writeDefaults===!0||t.value!=null&&t.value.byteLength>0)&&(n.uint32(18),n.bytes(t.value)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={key:"",value:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.string();break;case 2:s.value=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(Ou||(Ou={}));const j6=P("libp2p:peer-store:store"),H6="/peers/";class Aie{constructor(e){this.components=e,this.lock=_2({name:"peer-store",singleProcess:!0})}_peerIdToDatastoreKey(e){if(e.type==null)throw j6.error("peerId must be an instance of peer-id to store data"),v(new Error("peerId must be an instance of peer-id"),ue.ERR_INVALID_PARAMETERS);const t=e.toCID().toString();return new X(`${H6}${t}`)}async has(e){return await this.components.datastore.has(this._peerIdToDatastoreKey(e))}async delete(e){await this.components.datastore.delete(this._peerIdToDatastoreKey(e))}async load(e){const t=await this.components.datastore.get(this._peerIdToDatastoreKey(e)),n=Du.decode(t),s=new Map;for(const i of n.metadata)s.set(i.key,i.value);return{...n,id:e,addresses:n.addresses.map(({multiaddr:i,isCertified:o})=>({multiaddr:G(i),isCertified:o??!1})),metadata:s,pubKey:n.pubKey??void 0,peerRecordEnvelope:n.peerRecordEnvelope??void 0}}async save(e){if(e.pubKey!=null&&e.id.publicKey!=null&&!Ye(e.pubKey,e.id.publicKey))throw j6.error("peer publicKey bytes do not match peer id publicKey bytes"),v(new Error("publicKey bytes do not match peer id publicKey bytes"),ue.ERR_INVALID_PARAMETERS);const t=new Set,n=e.addresses.filter(o=>t.has(o.multiaddr.toString())?!1:(t.add(o.multiaddr.toString()),!0)).sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({multiaddr:o,isCertified:a})=>({multiaddr:o.bytes,isCertified:a})),s=[];[...e.metadata.keys()].sort().forEach(o=>{const a=e.metadata.get(o);a!=null&&s.push({key:o,value:a})});const i=Du.encode({addresses:n,protocols:e.protocols.sort(),pubKey:e.pubKey,metadata:s,peerRecordEnvelope:e.peerRecordEnvelope});return await this.components.datastore.put(this._peerIdToDatastoreKey(e.id),i.subarray()),await this.load(e.id)}async patch(e,t){const n=await this.load(e);return await this._patch(e,t,n)}async patchOrCreate(e,t){let n;try{n=await this.load(e)}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._patch(e,t,n)}async _patch(e,t,n){return await this.save({...n,...t,id:e})}async merge(e,t){const n=await this.load(e);return await this._merge(e,t,n)}async mergeOrCreate(e,t){let n;try{n=await this.load(e)}catch(s){if(s.code!==ue.ERR_NOT_FOUND)throw s;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._merge(e,t,n)}async _merge(e,t,n){const s=new Map;return n.addresses.forEach(i=>{s.set(i.multiaddr.toString(),i.isCertified)}),(t.addresses??[]).forEach(i=>{const o=i.multiaddr.toString(),c=Boolean(s.get(o))||i.isCertified;s.set(o,c)}),await this.save({id:e,addresses:Array.from(s.entries()).map(([i,o])=>({multiaddr:G(i),isCertified:o})),protocols:Array.from(new Set([...n.protocols??[],...t.protocols??[]])),metadata:new Map([...n.metadata?.entries()??[],...t.metadata?.entries()??[]]),pubKey:t.pubKey??n?.pubKey,peerRecordEnvelope:t.peerRecordEnvelope??n?.peerRecordEnvelope})}async*all(){for await(const e of this.components.datastore.queryKeys({prefix:H6})){const t=e.toString().split("/")[2],n=Rie.decode(t);yield this.load(Fr(n))}}}var As;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.tags!=null)for(const i of t.tags)n.uint32(10),Nu.codec().encode(i,n,{writeDefaults:!0});s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={tags:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.tags.push(Nu.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(As||(As={}));var Nu;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.name!=="")&&(n.uint32(10),n.string(t.name)),t.value!=null&&(n.uint32(16),n.uint32(t.value)),t.expiry!=null&&(n.uint32(24),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={name:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.name=t.string();break;case 2:s.value=t.uint32();break;case 3:s.expiry=t.uint64();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(Nu||(Nu={}));const pr=P("libp2p:peer-store");class Iie extends Fe{constructor(e,t={}){super(),this.components=e,this.store=new Aie(e),this.addressBook=new fie(this.dispatchEvent.bind(this),this.store,t.addressFilter),this.keyBook=new pie(this.dispatchEvent.bind(this),this.store),this.metadataBook=new gie(this.dispatchEvent.bind(this),this.store),this.protoBook=new yie(this.dispatchEvent.bind(this),this.store)}async forEach(e){pr.trace("getPeers await read lock");const t=await this.store.lock.readLock();pr.trace("getPeers got read lock");try{for await(const n of this.store.all())n.id.equals(this.components.peerId)||e(n)}finally{pr.trace("getPeers release read lock"),t()}}async all(){const e=[];return await this.forEach(t=>{e.push(t)}),e}async delete(e){pr.trace("delete await write lock");const t=await this.store.lock.writeLock();pr.trace("delete got write lock");try{await this.store.delete(e)}finally{pr.trace("delete release write lock"),t()}}async get(e){pr.trace("get await read lock");const t=await this.store.lock.readLock();pr.trace("get got read lock");try{return await this.store.load(e)}finally{pr.trace("get release read lock"),t()}}async has(e){pr.trace("has await read lock");const t=await this.store.lock.readLock();pr.trace("has got read lock");try{return await this.store.has(e)}finally{pr.trace("has release read lock"),t()}}async tagPeer(e,t,n={}){const s=n.value??0,i=Math.round(s),o=n.ttl??void 0;if(i!==s||i<0||i>100)throw v(new Error("Tag value must be between 0-100"),"ERR_TAG_VALUE_OUT_OF_BOUNDS");const a=await this.metadataBook.getValue(e,"tags");let c=[];a!=null&&(c=As.decode(a).tags);for(const h of c)if(h.name===t)throw v(new Error("Peer already tagged"),"ERR_DUPLICATE_TAG");c.push({name:t,value:i,expiry:o==null?void 0:BigInt(Date.now()+o)}),await this.metadataBook.setValue(e,"tags",As.encode({tags:c}).subarray())}async unTagPeer(e,t){const n=await this.metadataBook.getValue(e,"tags");let s=[];n!=null&&(s=As.decode(n).tags),s=s.filter(i=>i.name!==t),await this.metadataBook.setValue(e,"tags",As.encode({tags:s}).subarray())}async getTags(e){const t=await this.metadataBook.getValue(e,"tags");let n=[];t!=null&&(n=As.decode(t).tags);const s=BigInt(Date.now()),i=n.filter(o=>o.expiry==null||o.expiry>s);return i.length!==n.length&&await this.metadataBook.setValue(e,"tags",As.encode({tags:i}).subarray()),i.map(o=>({name:o.name,value:o.value??0}))}}class Cie{constructor(e){this.dht=e}async provide(e){await ot(this.dht.provide(e))}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await ot(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw v(new Error("Not found"),"ERR_NOT_FOUND")}}class Tie{constructor(e={}){this._started=!1,this._peerId=e.peerId,this._addressManager=e.addressManager,this._peerStore=e.peerStore,this._upgrader=e.upgrader,this._metrics=e.metrics,this._registrar=e.registrar,this._connectionManager=e.connectionManager,this._transportManager=e.transportManager,this._connectionGater=e.connectionGater,this._contentRouting=e.contentRouting,this._peerRouting=e.peerRouting,this._datastore=e.datastore,this._connectionProtector=e.connectionProtector,this._dht=e.dht,this._pubsub=e.pubsub,this._dialer=e.dialer}isStarted(){return this._started}async beforeStart(){await Promise.all(Object.values(this).filter(e=>ii(e)).map(async e=>{e.beforeStart!=null&&await e.beforeStart()}))}async start(){await Promise.all(Object.values(this).filter(e=>ii(e)).map(async e=>{await e.start()})),this._started=!0}async afterStart(){await Promise.all(Object.values(this).filter(e=>ii(e)).map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async beforeStop(){await Promise.all(Object.values(this).filter(e=>ii(e)).map(async e=>{e.beforeStop!=null&&await e.beforeStop()}))}async stop(){await Promise.all(Object.values(this).filter(e=>ii(e)).map(async e=>{await e.stop()})),this._started=!1}async afterStop(){await Promise.all(Object.values(this).filter(e=>ii(e)).map(async e=>{e.afterStop!=null&&await e.afterStop()}))}get peerId(){if(this._peerId==null)throw v(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this._peerId}set peerId(e){this._peerId=e}get addressManager(){if(this._addressManager==null)throw v(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this._addressManager}set addressManager(e){this._addressManager=e}get peerStore(){if(this._peerStore==null)throw v(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this._peerStore}set peerStore(e){this._peerStore=e}get upgrader(){if(this._upgrader==null)throw v(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this._upgrader}set upgrader(e){this._upgrader=e}get registrar(){if(this._registrar==null)throw v(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this._registrar}set registrar(e){this._registrar=e}get connectionManager(){if(this._connectionManager==null)throw v(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this._connectionManager}set connectionManager(e){this._connectionManager=e}get transportManager(){if(this._transportManager==null)throw v(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this._transportManager}set transportManager(e){this._transportManager=e}get connectionGater(){if(this._connectionGater==null)throw v(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this._connectionGater}set connectionGater(e){this._connectionGater=e}get contentRouting(){if(this._contentRouting==null)throw v(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this._contentRouting}set contentRouting(e){this._contentRouting=e}get peerRouting(){if(this._peerRouting==null)throw v(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this._peerRouting}set peerRouting(e){this._peerRouting=e}get datastore(){if(this._datastore==null)throw v(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this._datastore}set datastore(e){this._datastore=e}get connectionProtector(){return this._connectionProtector}set connectionProtector(e){this._connectionProtector=e}get dialer(){if(this._dialer==null)throw v(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this._dialer}set dialer(e){this._dialer=e}get metrics(){return this._metrics}set metrics(e){this._metrics=e}get dht(){return this._dht}set dht(e){this._dht=e}get pubsub(){return this._pubsub}set pubsub(e){this._pubsub=e}}var Io=1e3,Co=Io*60,To=Co*60,Ci=To*24,kie=Ci*7,Die=Ci*365.25,Pie=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return Oie(r);if(t==="number"&&isFinite(r))return e.long?xie(r):Nie(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Oie(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*Die;case"weeks":case"week":case"w":return t*kie;case"days":case"day":case"d":return t*Ci;case"hours":case"hour":case"hrs":case"hr":case"h":return t*To;case"minutes":case"minute":case"mins":case"min":case"m":return t*Co;case"seconds":case"second":case"secs":case"sec":case"s":return t*Io;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Nie(r){var e=Math.abs(r);return e>=Ci?Math.round(r/Ci)+"d":e>=To?Math.round(r/To)+"h":e>=Co?Math.round(r/Co)+"m":e>=Io?Math.round(r/Io)+"s":r+"ms"}function xie(r){var e=Math.abs(r);return e>=Ci?Al(r,e,Ci,"day"):e>=To?Al(r,e,To,"hour"):e>=Co?Al(r,e,Co,"minute"):e>=Io?Al(r,e,Io,"second"):r+" ms"}function Al(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}var q6=u_,$ie=Pie,Xs=u_.prototype,Lie=new Date%1e9;function Mie(){return(Math.random()*1e9>>>0)+Lie++}function u_(r){r=r||{},this.id=r.id||Mie(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var e,t,n=this.items.length;n--;)e=this.items[n],t=new Date(e.expires)-new Date,this._lookup[e.key]=e,t>0?this.expire(e.key,t):t<=0&&this.delete(e.key)}Xs.has=function(r){return r in this._lookup};Xs.get=function(r){if(!this.has(r))return null;var e=this._lookup[r];return e.refresh&&this.expire(r,e.refresh),this.items.splice(this.items.indexOf(e),1),this.items.push(e),e.value};Xs.meta=function(r){if(!this.has(r))return null;var e=this._lookup[r];return"meta"in e?e.meta:null};Xs.set=function(r,e,t){var n=this._lookup[r],s=this._lookup[r]={key:r,value:e};return this.lastModified=new Date,n?(clearTimeout(n.timeout),this.items.splice(this.items.indexOf(n),1,s)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(s),this.size++),t&&("ttl"in t&&this.expire(r,t.ttl),"meta"in t&&(s.meta=t.meta),t.refresh&&(s.refresh=t.ttl)),this};Xs.delete=function(r){var e=this._lookup[r];return e?(this.lastModified=new Date,this.items.splice(this.items.indexOf(e),1),clearTimeout(e.timeout),delete this._lookup[r],this.size--,this):!1};Xs.expire=function(r,e){var t=e||0,n=this._lookup[r];if(!n)return this;if(typeof t=="string"&&(t=$ie(e)),typeof t!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(n.timeout),n.timeout=setTimeout(this.delete.bind(this,n.key),t),n.expires=Number(new Date)+t,this};Xs.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};Xs.toJSON=function(){for(var r=new Array(this.items.length),e,t=r.length;t--;)e=this.items[t],r[t]={key:e.key,meta:e.meta,value:e.value,expires:e.expires,refresh:e.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}};const Uie=globalThis.fetch,Bie=globalThis.Headers;function t1(r,e,t){return`${r}?name=${e}&type=${t}`}async function zie(r,e){return await(await Uie(r,{headers:new Bie({accept:"application/dns-json"}),signal:e})).json()}function ji(r,e){return`${e}_${r}`}const r1=Object.assign(Br("dns-over-http-resolver"),{error:Br("dns-over-http-resolver:error")});class Fie{constructor(e={}){this._cache=new q6({max:e?.maxCache??100}),this._TXTcache=new q6({max:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??zie,this._abortControllers=[]}cancel(){this._abortControllers.forEach(e=>e.abort())}getServers(){return this._servers}_getShuffledServers(){const e=[...this._servers];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),s=e[t];e[t]=e[n],e[n]=s}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return await this.resolve4(e);case"AAAA":return await this.resolve6(e);case"TXT":return await this.resolveTxt(e);default:throw new Error(`${t} is not supported`)}}async resolve4(e){const t="A",n=this._cache.get(ji(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(t1(i,e,t),o.signal),c=a.Answer.map(l=>l.data),h=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(ji(e,t),c,{ttl:h}),c}catch{o.signal.aborted&&(s=!0),r1.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){const t="AAAA",n=this._cache.get(ji(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(t1(i,e,t),o.signal),c=a.Answer.map(l=>l.data),h=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(ji(e,t),c,{ttl:h}),c}catch{o.signal.aborted&&(s=!0),r1.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){const t="TXT",n=this._TXTcache.get(ji(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(t1(i,e,t),o.signal),c=a.Answer.map(l=>[l.data.replace(/['"]+/g,"")]),h=Math.min(...a.Answer.map(l=>l.TTL));return this._TXTcache.set(ji(e,t),c,{ttl:h}),c}catch{o.signal.aborted&&(s=!0),r1.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}}const{code:Vie}=Qu("dnsaddr");async function Kie(r,e={}){const t=new Fie;e.signal!=null&&e.signal.addEventListener("abort",()=>{t.cancel()});const n=r.getPeerId(),[,s]=r.stringTuples().find(([a])=>a===Vie)??[];if(s==null)throw new Error("No hostname found in multiaddr");let o=(await t.resolveTxt(`_dnsaddr.${s}`)).flat().map(a=>a.split("=")[1]);return n!=null&&(o=o.filter(a=>a.includes(n))),o}const d_=3e4,jie=3e4,f_=100,p_=4,Hie=25,qie={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{maxConnections:300,minConnections:50,autoDial:!0,autoDialInterval:1e4,maxParallelDials:f_,maxDialsPerPeer:p_,dialTimeout:d_,inboundUpgradeTimeout:jie,resolvers:{dnsaddr:Kie},addressSorter:sg},connectionGater:{},transportManager:{faultTolerance:lo.FATAL_ALL},peerRouting:{refreshManager:{enabled:!0,interval:6e5,bootDelay:1e4}},nat:{enabled:!0,ttl:7200,keepAlive:!0},relay:{enabled:!0,advertise:{bootDelay:Ine,enabled:!1,ttl:Cne},hop:{enabled:!1,active:!1,timeout:3e4},autoRelay:{enabled:!1,maxListeners:2}},identify:{protocolPrefix:"ipfs",host:{agentVersion:l_},timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1},ping:{protocolPrefix:"ipfs",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4},fetch:{protocolPrefix:"libp2p",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4}};function Gie(r){const e=Ue(qie,r);if(e.transports==null||e.transports.length<1)throw v(new Error(we.ERR_TRANSPORTS_REQUIRED),k.ERR_TRANSPORTS_REQUIRED);if(e.connectionEncryption==null||e.connectionEncryption.length===0)throw v(new Error(we.CONN_ENCRYPTION_REQUIRED),k.CONN_ENCRYPTION_REQUIRED);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw v(new Error(we.ERR_PROTECTOR_REQUIRED),k.ERR_PROTECTOR_REQUIRED);return e.identify.host.agentVersion===l_&&(Dv||Pv?e.identify.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(qa||Rp||nm||Ov)&&(e.identify.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`)),e}var G6;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.id!=null&&t.id.byteLength>0)&&(n.uint32(10),n.bytes(t.id)),t.pubKey!=null&&(n.uint32(18),n.bytes(t.pubKey)),t.privKey!=null&&(n.uint32(26),n.bytes(t.privKey)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={id:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.id=t.bytes();break;case 2:s.pubKey=t.bytes();break;case 3:s.privKey=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(G6||(G6={}));const g_=async()=>{const r=await Sp("Ed25519"),e=await y_(r);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)},Wie=async r=>{const e=await Sp("RSA",r?.bits??2048),t=await y_(e);if(t.type==="RSA")return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)};async function y_(r){return await Ir(vp(r.public),Nv(r))}class Yie extends Fe{get[Mc](){return!0}get[Symbol.toStringTag](){return"@libp2p/dummy-dht"}get wan(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}get lan(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}get(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}findProviders(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}findPeer(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}getClosestPeers(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}provide(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}put(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}async getMode(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}async setMode(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}async refreshRoutingTable(){throw v(new Error(we.DHT_DISABLED),k.DHT_DISABLED)}}class Qie extends Fe{constructor(){super(...arguments),this.topicValidators=new Map}isStarted(){return!1}start(){}stop(){}get globalSignaturePolicy(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}get multicodecs(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}getPeers(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}getTopics(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}subscribe(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}unsubscribe(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}getSubscribers(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}async publish(){throw v(new Error(we.PUBSUB_DISABLED),k.ERR_PUBSUB_DISABLED)}}var Xie=class{constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return this.buffer[this.btm]===void 0}};const W6=Xie;var Jie=class{constructor(e){this.hwm=e||16,this.head=new W6(this.hwm),this.tail=this.head}push(e){if(!this.head.push(e)){const t=this.head;this.head=t.next=new W6(2*this.head.buffer.length),this.head.push(e)}}shift(){const e=this.tail.shift();if(e===void 0&&this.tail.next){const t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return e}peek(){return this.tail.peek()}isEmpty(){return this.head.isEmpty()}};const Zie=()=>{const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r};var eoe=Zie;const Y6=Jie,Q6=eoe;var toe=class{constructor(){this._buffer=new Y6,this._waitingConsumers=new Y6}push(e){const{promise:t,resolve:n}=Q6();return this._buffer.push({chunk:e,resolve:n}),this._consume(),t}_consume(){for(;!this._waitingConsumers.isEmpty()&&!this._buffer.isEmpty();){const e=this._waitingConsumers.shift(),t=this._buffer.shift();e.resolve(t.chunk),t.resolve()}}shift(){const{promise:e,resolve:t}=Q6();return this._waitingConsumers.push({resolve:t}),this._consume(),e}isEmpty(){return this._buffer.isEmpty()}};const X6=P("libp2p:dialer:dial-request");class roe{constructor(e){const{addrs:t,dialAction:n,dialer:s}=e;this.addrs=t,this.dialer=s,this.dialAction=n}async run(e={}){const t=this.dialer.getTokens(this.addrs.length);if(t.length<1)throw v(new Error("No dial tokens available"),k.ERR_NO_DIAL_TOKENS);const n=new toe;for(const a of t)n.push(a).catch(c=>{X6.error(c)});const s=this.addrs.map(()=>{const a=new AbortController;try{Ce.setMaxListeners?.(1/0,a.signal)}catch{}return a});if(e.signal!=null)try{Ce.setMaxListeners?.(1/0,e.signal)}catch{}let i=0,o=!1;try{return await Promise.any(this.addrs.map(async(a,c)=>{const h=await n.shift();if(o)throw this.dialer.releaseToken(t.splice(t.indexOf(h),1)[0]),v(new Error("dialAction already succeeded"),k.ERR_ALREADY_SUCCEEDED);const l=s[c];if(l==null)throw v(new Error("dialAction did not come with an AbortController"),k.ERR_INVALID_PARAMETERS);let u;try{const f=l.signal;u=await this.dialAction(a,{...e,signal:e.signal!=null?Ur([f,e.signal]):f}),s[c]=void 0}finally{i++,this.addrs.length-i>=t.length?n.push(h).catch(f=>{X6.error(f)}):this.dialer.releaseToken(t.splice(t.indexOf(h),1)[0])}if(u==null)throw v(new Error("dialAction led to empty object"),k.ERR_TRANSPORT_DIAL_FAILED);return o=!0,u}))}finally{s.forEach(a=>{a!==void 0&&a.abort()}),t.forEach(a=>this.dialer.releaseToken(a))}}}const qr=P("libp2p:dialer");class noe{constructor(e,t={}){this.started=!1,this.addressSorter=t.addressSorter??sg,this.maxAddrsToDial=t.maxAddrsToDial??Hie,this.timeout=t.dialTimeout??d_,this.maxDialsPerPeer=t.maxDialsPerPeer??p_,this.tokens=[...new Array(t.maxParallelDials??f_)].map((n,s)=>s),this.components=e,this.pendingDials=Ii({name:"libp2p_dialler_pending_dials",metrics:e.metrics}),this.pendingDialTargets=Ii({name:"libp2p_dialler_pending_dial_targets",metrics:e.metrics});for(const[n,s]of Object.entries(t.resolvers??{}))xv.set(n,s)}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1;for(const e of this.pendingDials.values())try{e.controller.abort()}catch(t){qr.error(t)}this.pendingDials.clear();for(const e of this.pendingDialTargets.values())e.abort();this.pendingDialTargets.clear()}async dial(e,t={}){const{peerId:n,multiaddr:s}=zE(e);if(n!=null){if(this.components.peerId.equals(n))throw v(new Error("Tried to dial self"),k.ERR_DIALED_SELF);if(s!=null&&(qr("storing multiaddrs %p",n,s),await this.components.peerStore.addressBook.add(n,[s])),await this.components.connectionGater.denyDialPeer(n))throw v(new Error("The dial request is blocked by gater.allowDialPeer"),k.ERR_PEER_DIAL_INTERCEPTED)}qr("creating dial target for %p",n);const i=new AbortController,o=J6();this.pendingDialTargets.set(o,i);let a=i.signal;t.signal!=null&&(a=Ur([a,t.signal]));let c;try{c=await this._createDialTarget({peerId:n,multiaddr:s},{...t,signal:a})}finally{this.pendingDialTargets.delete(o)}if(c.addrs.length===0)throw v(new Error("The dial request has no valid addresses"),k.ERR_NO_VALID_ADDRESSES);const h=this.pendingDials.get(c.id)??this._createPendingDial(c,t);try{const l=await h.promise;return qr("dial succeeded to %s",c.id),l}catch(l){throw qr("dial failed to %s",c.id,l),h.controller.signal.aborted&&(l.code=k.ERR_TIMEOUT),qr.error(l),l}finally{h.destroy()}}async _createDialTarget(e,t){let n=[];if(Ln(e.multiaddr)&&n.push(e.multiaddr),!Ln(e.multiaddr)&&Mn(e.peerId)&&n.push(...await this._loadAddresses(e.peerId)),n=(await Promise.all(n.map(async i=>await this._resolve(i,t)))).flat().filter(i=>Boolean(this.components.transportManager.transportForMultiaddr(i))),n=[...new Set(n.map(i=>i.toString()))].map(i=>G(i)),n.length>this.maxAddrsToDial)throw v(new Error("dial with more addresses than allowed"),k.ERR_TOO_MANY_ADDRESSES);const s=Mn(e.peerId)?e.peerId:void 0;if(s!=null){const i=`/p2p/${s.toString()}`;n=n.map(o=>{const a=o.getPeerId();return a==null||!s.equals(a)?o.encapsulate(i):o})}return{id:s==null?J6():s.toString(),addrs:n}}async _loadAddresses(e){const t=await this.components.peerStore.addressBook.get(e);return(await Promise.all(t.map(async n=>await this.components.connectionGater.denyDialMultiaddr(e,n.multiaddr)?!1:n))).filter(soe).sort(this.addressSorter).map(n=>n.multiaddr)}_createPendingDial(e,t={}){const n=async(h,l={})=>{if(l.signal?.aborted===!0)throw v(new Error("already aborted"),k.ERR_ALREADY_ABORTED);return await this.components.transportManager.dial(h,l).catch(u=>{throw qr.error("dial to %s failed",h,u),u})},s=new roe({addrs:e.addrs,dialAction:n,dialer:this}),i=new ze.TimeoutController(this.timeout),o=[i.signal];t.signal!=null&&o.push(t.signal);const a=Ur(o);try{Ce.setMaxListeners?.(1/0,a)}catch{}const c={dialRequest:s,controller:i,promise:s.run({...t,signal:a}),destroy:()=>{i.clear(),this.pendingDials.delete(e.id)}};return this.pendingDials.set(e.id,c),c}getTokens(e){const t=Math.min(e,this.maxDialsPerPeer,this.tokens.length),n=this.tokens.splice(0,t);return qr("%d tokens request, returning %d, %d remaining",e,t,this.tokens.length),n}releaseToken(e){this.tokens.includes(e)||(qr("token %d released",e),this.tokens.push(e))}async _resolve(e,t){if(!e.protoNames().includes("dnsaddr"))return[e];const s=await this._resolveRecord(e,t);return(await Promise.all(s.map(async a=>await this._resolve(a,t)))).flat().reduce((a,c)=>(a.find(h=>h.equals(c))==null&&a.push(c),a),[])}async _resolveRecord(e,t){try{return e=G(e.toString()),await e.resolve(t)}catch(n){return qr.error(`multiaddr ${e.toString()} could not be resolved`,n),[]}}}function soe(r){return Boolean(r)}function J6(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}const Rn=P("libp2p");class ioe extends Fe{constructor(e){super(),this.started=!1,this.peerId=e.peerId;const t=this.components=new Tie({peerId:e.peerId,datastore:e.datastore??new EO,connectionGater:{denyDialPeer:async()=>await Promise.resolve(!1),denyDialMultiaddr:async()=>await Promise.resolve(!1),denyInboundConnection:async()=>await Promise.resolve(!1),denyOutboundConnection:async()=>await Promise.resolve(!1),denyInboundEncryptedConnection:async()=>await Promise.resolve(!1),denyOutboundEncryptedConnection:async()=>await Promise.resolve(!1),denyInboundUpgradedConnection:async()=>await Promise.resolve(!1),denyOutboundUpgradedConnection:async()=>await Promise.resolve(!1),filterMultiaddrForPeer:async()=>await Promise.resolve(!0),...e.connectionGater}});t.peerStore=new Iie(t,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore}),this.services=[t],e.metrics!=null&&(this.metrics=this.components.metrics=this.configureComponent(e.metrics(this.components))),this.peerStore=this.components.peerStore,this.peerStore.addEventListener("peer",o=>{const{detail:a}=o;this.dispatchEvent(new F("peer:discovery",{detail:a}))}),e.connectionProtector!=null&&(this.components.connectionProtector=e.connectionProtector(t)),this.components.upgrader=new Kse(this.components,{connectionEncryption:(e.connectionEncryption??[]).map(o=>this.configureComponent(o(this.components))),muxers:(e.streamMuxers??[]).map(o=>this.configureComponent(o(this.components))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.components.dialer=new noe(this.components,e.connectionManager),this.connectionManager=this.components.connectionManager=new Pre(this.components,e.connectionManager),this.components.connectionManager.addEventListener("peer:disconnect",o=>{this.dispatchEvent(new F("peer:disconnect",{detail:o.detail}))}),this.components.connectionManager.addEventListener("peer:connect",o=>{this.dispatchEvent(new F("peer:connect",{detail:o.detail}))}),this.registrar=this.components.registrar=new zse(this.components),this.components.transportManager=new Pse(this.components,e.transportManager),this.components.addressManager=new Sre(this.components,e.addresses),this.configureComponent(new lie(this.components)),this.configureComponent(new Nre(this.components,{enabled:e.connectionManager.autoDial,minConnections:e.connectionManager.minConnections,autoDialInterval:e.connectionManager.autoDialInterval}));const n=Tu.generateOptions();this.keychain=this.configureComponent(new Tu(this.components,{...n,...e.keychain})),this.services.push(new aie(this.components,e.nat)),e.transports.forEach(o=>{this.components.transportManager.add(this.configureComponent(o(this.components)))}),this.identifyService=new cg(this.components,{...e.identify}),this.configureComponent(this.identifyService),e.dht!=null?this.dht=this.components.dht=e.dht(this.components):this.dht=new Yie,e.pubsub!=null?this.pubsub=this.components.pubsub=e.pubsub(this.components):this.pubsub=new Qie;const s=(e.peerRouters??[]).map(o=>this.configureComponent(o(this.components)));e.dht!=null&&(s.push(this.configureComponent(new hie(this.dht))),this.dht.addEventListener("peer",o=>{this.onDiscoveryPeer(o)})),this.peerRouting=this.components.peerRouting=this.configureComponent(new Ere(this.components,{...e.peerRouting,routers:s}));const i=(e.contentRouters??[]).map(o=>this.configureComponent(o(this.components)));e.dht!=null&&i.push(this.configureComponent(new Cie(this.dht))),this.contentRouting=this.components.contentRouting=this.configureComponent(new _re(this.components,{routers:i})),e.relay.enabled&&(this.components.transportManager.add(this.configureComponent(new Vre(this.components,e.relay))),this.configureComponent(new Fne(this.components,{addressSorter:e.connectionManager.addressSorter,...e.relay}))),this.fetchService=this.configureComponent(new Jse(this.components,{...e.fetch})),this.pingService=this.configureComponent(new rie(this.components,{...e.ping}));for(const o of e.peerDiscovery??[])this.configureComponent(o(this.components)).addEventListener("peer",c=>{this.onDiscoveryPeer(c)})}configureComponent(e){return ii(e)&&this.services.push(e),e}async start(){if(!this.started){this.started=!0,Rn("libp2p is starting");try{await Promise.all(this.services.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(this.services.map(e=>e.start())),await Promise.all(this.services.map(async e=>{e.afterStart!=null&&await e.afterStart()})),Rn("libp2p has started")}catch(e){throw Rn.error("An error occurred starting libp2p",e),await this.stop(),e}}}async stop(){this.started&&(Rn("libp2p is stopping"),this.started=!1,await Promise.all(this.services.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(this.services.map(e=>e.stop())),await Promise.all(this.services.map(async e=>{e.afterStop!=null&&await e.afterStop()})),Rn("libp2p has stopped"))}isStarted(){return this.started}getConnections(e){return this.components.connectionManager.getConnections(e)}getPeers(){const e=new Vs;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return await this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t,n={}){if(t==null)throw v(new Error("no protocols were provided to open a stream"),k.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(t=Array.isArray(t)?t:[t],t.length===0)throw v(new Error("no protocols were provided to open a stream"),k.ERR_INVALID_PROTOCOLS_FOR_STREAM);return await(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e){Ln(e)&&(e=Z(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e)}async getPublicKey(e,t={}){if(Rn("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;const n=await this.peerStore.get(e);if(n.pubKey!=null)return n.pubKey;if(this.dht==null)throw v(new Error("Public key was not in the peer store and the DHT is not enabled"),k.ERR_NO_ROUTERS_AVAILABLE);const s=qe([L("/pk/"),e.multihash.digest]);for await(const i of this.dht.get(s,t))if(i.name==="VALUE"){const o=mi(i.value);return await this.peerStore.keyBook.set(e,i.value),o.bytes}throw v(new Error(`Node not responding with its public key: ${e.toString()}`),k.ERR_INVALID_RECORD)}async fetch(e,t,n={}){if(Ln(e)){const s=Z(e.getPeerId()??"");await this.components.peerStore.addressBook.add(s,[e]),e=s}return await this.fetchService.fetch(e,t,n)}async ping(e,t={}){if(Ln(e)){const n=Z(e.getPeerId()??"");await this.components.peerStore.addressBook.add(n,[e]),e=n}return await this.pingService.ping(e,t)}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}async register(e,t){return await this.registrar.register(e,t)}unregister(e){this.registrar.unregister(e)}onDiscoveryPeer(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){Rn.error(new Error(k.ERR_DISCOVERED_SELF));return}t.multiaddrs.length>0&&this.components.peerStore.addressBook.add(t.id,t.multiaddrs).catch(n=>Rn.error(n)),t.protocols.length>0&&this.components.peerStore.protoBook.set(t.id,t.protocols).catch(n=>Rn.error(n)),this.dispatchEvent(new F("peer:discovery",{detail:t}))}}async function ooe(r){if(r.peerId==null){const e=r.datastore;if(e!=null)try{const t=new Tu({datastore:e},{...Tu.generateOptions(),...r.keychain??{}});r.peerId=await t.exportPeerId("self")}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}}return r.peerId==null&&(r.peerId=await g_()),new ioe(Gie(r))}async function aoe(r){const e=await ooe(r);return r.start!==!1&&await e.start(),e}const coe=$v(),{EventEmitter:loe}=Ce;function Z6(r,e){if(r===e)return!0;if(r.length!==e.length)return!1;for(let t=0,n=r.length;t<n;++t)if(r[t]!==e[t])return!1;return!0}function n1(){return{contacts:[],dontSplit:!1,left:null,right:null}}function wa(r,e){if(!(e instanceof Uint8Array))throw new TypeError(r+" is not a Uint8Array")}class xu extends loe{constructor(e={}){super(),this.localNodeId=e.localNodeId||coe(20),this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket||20,this.numberOfNodesToPing=e.numberOfNodesToPing||3,this.distance=e.distance||xu.distance,this.arbiter=e.arbiter||xu.arbiter,this.metadata=Object.assign({},e.metadata),wa("option.localNodeId as parameter 1",this.localNodeId),this.root=n1()}static arbiter(e,t){return e.vectorClock>t.vectorClock?e:t}static distance(e,t){let n=0,s=0;const i=Math.min(e.length,t.length),o=Math.max(e.length,t.length);for(;s<i;++s)n=n*256+(e[s]^t[s]);for(;s<o;++s)n=n*256+255;return n}add(e){wa("contact.id",(e||{}).id);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e.id,t++);const s=this._indexOf(n,e.id);return s>=0?(this._update(n,s,e),this):n.contacts.length<this.numberOfNodesPerKBucket?(n.contacts.push(e),this.emit("added",e),this):n.dontSplit?(this.emit("ping",n.contacts.slice(0,this.numberOfNodesToPing),e),this):(this._split(n,t),this.add(e))}closest(e,t=1/0){if(wa("id",e),!Number.isInteger(t)&&t!==1/0||t<=0)throw new TypeError("n is not positive number");let n=[];for(let s=[this.root],i=0;s.length>0&&n.length<t;){const o=s.pop();if(o.contacts===null){const a=this._determineNode(o,e,i++);s.push(o.left===a?o.right:o.left),s.push(a)}else n=n.concat(o.contacts)}return n.map(s=>[this.distance(s.id,e),s]).sort((s,i)=>s[0]-i[0]).slice(0,t).map(s=>s[1])}count(){let e=0;for(const t=[this.root];t.length>0;){const n=t.pop();n.contacts===null?t.push(n.right,n.left):e+=n.contacts.length}return e}_determineNode(e,t,n){const s=n>>3,i=n%8;return t.length<=s&&i!==0?e.left:t[s]&1<<7-i?e.right:e.left}get(e){wa("id",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);const s=this._indexOf(n,e);return s>=0?n.contacts[s]:null}_indexOf(e,t){for(let n=0;n<e.contacts.length;++n)if(Z6(e.contacts[n].id,t))return n;return-1}remove(e){wa("the id as parameter 1",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);const s=this._indexOf(n,e);if(s>=0){const i=n.contacts.splice(s,1)[0];this.emit("removed",i)}return this}_split(e,t){e.left=n1(),e.right=n1();for(const i of e.contacts)this._determineNode(e,i.id,t).contacts.push(i);e.contacts=null;const n=this._determineNode(e,this.localNodeId,t),s=e.left===n?e.right:e.left;s.dontSplit=!0}toArray(){let e=[];for(const t=[this.root];t.length>0;){const n=t.pop();n.contacts===null?t.push(n.right,n.left):e=e.concat(n.contacts)}return e}*toIterable(){for(const e=[this.root];e.length>0;){const t=e.pop();t.contacts===null?e.push(t.right,t.left):yield*t.contacts}}_update(e,t,n){if(!Z6(e.contacts[t].id,n.id))throw new Error("wrong index for _update");const s=e.contacts[t],i=this.arbiter(s,n);i===s&&s!==n||(e.contacts.splice(t,1),e.contacts.push(i),this.emit("updated",s,i))}}var hoe=xu;const uoe=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},lg=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var doe=w_,ew=128,foe=127,poe=~foe,goe=Math.pow(2,31);function w_(r,e,t){e=e||[],t=t||0;for(var n=t;r>=goe;)e[t++]=r&255|ew,r/=128;for(;r&poe;)e[t++]=r&255|ew,r>>>=7;return e[t]=r|0,w_.bytes=t-n+1,e}var yoe=ip,woe=128,tw=127;function ip(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw ip.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&tw)<<s:(o&tw)*Math.pow(2,s),s+=7}while(o>=woe);return ip.bytes=i-n,t}var moe=Math.pow(2,7),boe=Math.pow(2,14),Eoe=Math.pow(2,21),_oe=Math.pow(2,28),voe=Math.pow(2,35),Soe=Math.pow(2,42),Roe=Math.pow(2,49),Aoe=Math.pow(2,56),Ioe=Math.pow(2,63),Coe=function(r){return r<moe?1:r<boe?2:r<Eoe?3:r<_oe?4:r<voe?5:r<Soe?6:r<Roe?7:r<Aoe?8:r<Ioe?9:10},Toe={encode:doe,decode:yoe,encodingLength:Coe},$u=Toe;const op=(r,e=0)=>[$u.decode(r,e),$u.decode.bytes],Lu=(r,e,t=0)=>($u.encode(r,e,t),e),Mu=r=>$u.encodingLength(r),ap=(r,e)=>{const t=e.byteLength,n=Mu(r),s=n+Mu(t),i=new Uint8Array(s+t);return Lu(r,i,0),Lu(t,i,n),i.set(e,s),new hg(r,t,e,i)},koe=r=>{const e=lg(r),[t,n]=op(e),[s,i]=op(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new hg(t,s,o,e)},Doe=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&uoe(r.bytes,t.bytes)}};let hg=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const m_=({name:r,code:e,encode:t})=>new Poe(r,e,t);let Poe=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ap(this.code,t):t.then(n=>ap(this.code,n))}else throw Error("Unknown type, must be binary type")}};const b_=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),E_=m_({name:"sha2-256",code:18,encode:b_("SHA-256")});m_({name:"sha2-512",code:19,encode:b_("SHA-512")});const xd=1e3,ug=60*xd,dg=60*ug,Ooe=36*dg,Noe="/lan",xoe="/ipfs",$oe="/kad/1.0.0",Loe="/dht/record",__="/dht/provider",Moe=256,Uoe=24*dg,Boe=dg,cp=20,Uu=3,zoe=Number(5*ug),Foe=Number(30*xd),Voe=Number(5*ug),Koe=Number(30*xd),joe=Number(30*xd),Hoe=L("/pk/");function fg(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const s=Od(n);return s==null?!0:!s})}}function pg(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(n==="localhost")return!0;if(t!==4&&t!==6||n==null)return!1;const s=Od(n);return s??!1})}}async function ko(r){return(await E_.digest(r)).digest}async function $n(r){return await ko(r.toBytes())}function to(r){return new X(`${Loe}/${B(r,"base32")}`,!1)}function qoe(r){return qe([Hoe,r.toBytes()])}function Goe(r){return B(r.subarray(0,4))==="/pk/"}function Woe(r){return Fr(r.subarray(4))}function rw(r,e){const t=new Date;return new Kt(r,e,t).serialize()}function Yoe(r,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>r(),e)}}const Qoe="kad-close",Xoe=50,nw=20,Joe=1e4,Zoe=10;class eae{constructor(e,t){const{kBucketSize:n,pingTimeout:s,lan:i,pingConcurrency:o,protocol:a,tagName:c,tagValue:h}=t;this.components=e,this.log=P(`libp2p:kad-dht:${i?"lan":"wan"}:routing-table`),this.kBucketSize=n??nw,this.pingTimeout=s??Joe,this.pingConcurrency=o??Zoe,this.lan=i,this.running=!1,this.protocol=a,this.tagName=c??Qoe,this.tagValue=h??Xoe;const l=()=>{this.metrics?.pingQueueSize.update(this.pingQueue.size),this.metrics?.pingRunning.update(this.pingQueue.pending)};this.pingQueue=new lt({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",l),this.pingQueue.addListener("next",l),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_routing_table_size`),pingQueueSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_queue_size`),pingRunning:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_running`)});const e=new hoe({localNodeId:await $n(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.on("ping",this._onPing),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new Vs;const n=Yoe(()=>{const s=new Vs(e.closest(e.localNodeId,nw).map(a=>a.peer)),i=s.difference(t),o=t.difference(s);Promise.resolve().then(async()=>{for(const a of i)await this.components.peerStore.tagPeer(a,this.tagName,{value:this.tagValue});for(const a of o)await this.components.peerStore.unTagPeer(a,this.tagName)}).catch(a=>{this.log.error("Could not update peer tags",a)}),t=s});e.on("added",()=>{n()}),e.on("removed",()=>{n()})}_onPing(e,t){this.pingQueue.add(async()=>{if(!this.running)return;let n=0;try{await Promise.all(e.map(async s=>{let i;try{i=new ze.TimeoutController(this.pingTimeout);const o={signal:i.signal};this.log("pinging old contact %p",s.peer),(await(await this.components.connectionManager.openConnection(s.peer,o)).newStream(this.protocol,o)).close(),n++}catch(o){this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",s.peer,o),this.log("evicting old contact after ping failed %p",s),this.kb.remove(s.id))}finally{i?.clear(),this.metrics?.routingTableSize.update(this.size)}})),this.running&&n<e.length&&this.kb!=null&&(this.log("adding new contact %p",t.peer),this.kb.add(t))}catch(s){this.log.error("could not process k-bucket ping event",s)}}).catch(n=>{this.log.error("could not process k-bucket ping event",n)})}get size(){return this.kb==null?0:this.kb.count()}async find(e){const t=await $n(e),n=this.closestPeer(t);if(n!=null&&e.equals(n))return n}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return this.kb==null?[]:this.kb.closest(e,t).map(s=>s.peer)}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");const t=await $n(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.metrics?.routingTableSize.update(this.size)}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");const t=await $n(e);this.kb.remove(t),this.metrics?.routingTableSize.update(this.size)}}const tae=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Il=15;class rae{constructor(e){const{peerRouting:t,routingTable:n,refreshInterval:s,refreshQueryTimeout:i,lan:o}=e;this.log=P(`libp2p:kad-dht:${o?"lan":"wan"}:routing-table:refresh`),this.peerRouting=t,this.routingTable=n,this.refreshInterval=s??Voe,this.refreshQueryTimeout=i??Koe,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(n.map(async(s,i)=>{try{if(await this._refreshCommonPrefixLength(i,s,e),this._numPeersForCpl(t)===0){const o=Math.min(2*(i+1),n.length-1);for(let a=i+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,s,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const i=new ze.TimeoutController(this.refreshQueryTimeout);try{const o=await Eo(this.peerRouting.getClosestPeers(s.toBytes(),{signal:i.signal}));this.log(`found ${o} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}finally{i.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Il&&(e=Il);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");const t=Yu(2),n=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localNodeId,n,e);return Fr(s)}async _makePeerId(e,t,n){if(n>Il)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Il}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,h=tae[c],l=new ArrayBuffer(34),u=new DataView(l,0,l.byteLength);return u.setUint8(0,E_.code),u.setUint8(1,32),u.setUint32(2,h,!1),new Uint8Array(u.buffer,u.byteOffset,u.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(const{id:e}of this.routingTable.kb.toIterable()){const t=Ga(this.routingTable.kb.localNodeId,e);let n=0;for(const s of t)if(s===0)n++;else break;yield n}}}var sw;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 3:s.author=t.bytes();break;case 4:s.signature=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(sw||(sw={}));var wi;(function(r){(function(s){s.PUT_VALUE="PUT_VALUE",s.GET_VALUE="GET_VALUE",s.ADD_PROVIDER="ADD_PROVIDER",s.GET_PROVIDERS="GET_PROVIDERS",s.FIND_NODE="FIND_NODE",s.PING="PING"})(r.MessageType||(r.MessageType={}));let e;(function(s){s[s.PUT_VALUE=0]="PUT_VALUE",s[s.GET_VALUE=1]="GET_VALUE",s[s.ADD_PROVIDER=2]="ADD_PROVIDER",s[s.GET_PROVIDERS=3]="GET_PROVIDERS",s[s.FIND_NODE=4]="FIND_NODE",s[s.PING=5]="PING"})(e||(e={})),function(s){s.codec=()=>fo(e)}(r.MessageType||(r.MessageType={})),function(s){s.NOT_CONNECTED="NOT_CONNECTED",s.CONNECTED="CONNECTED",s.CAN_CONNECT="CAN_CONNECT",s.CANNOT_CONNECT="CANNOT_CONNECT"}(r.ConnectionType||(r.ConnectionType={}));let t;(function(s){s[s.NOT_CONNECTED=0]="NOT_CONNECTED",s[s.CONNECTED=1]="CONNECTED",s[s.CAN_CONNECT=2]="CAN_CONNECT",s[s.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(t||(t={})),function(s){s.codec=()=>fo(t)}(r.ConnectionType||(r.ConnectionType={})),function(s){let i;s.codec=()=>(i==null&&(i=Qe((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const h of o.addrs)a.uint32(18),a.bytes(h);else throw new Error('Protocol error: required field "addrs" was not found in object');o.connection!=null&&(a.uint32(24),r.ConnectionType.codec().encode(o.connection,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={addrs:[]},h=a==null?o.len:o.pos+a;for(;o.pos<h;){const l=o.uint32();switch(l>>>3){case 1:c.id=o.bytes();break;case 2:c.addrs.push(o.bytes());break;case 3:c.connection=r.ConnectionType.codec().decode(o);break;default:o.skipType(l&7);break}}return c})),i),s.encode=o=>Xe(o,s.codec()),s.decode=o=>Je(o,s.codec())}(r.Peer||(r.Peer={}));let n;r.codec=()=>(n==null&&(n=Qe((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.MessageType.codec().encode(s.type,i)),s.clusterLevelRaw!=null&&(i.uint32(80),i.int32(s.clusterLevelRaw)),s.key!=null&&(i.uint32(18),i.bytes(s.key)),s.record!=null&&(i.uint32(26),i.bytes(s.record)),s.closerPeers!=null)for(const a of s.closerPeers)i.uint32(66),r.Peer.codec().encode(a,i);else throw new Error('Protocol error: required field "closerPeers" was not found in object');if(s.providerPeers!=null)for(const a of s.providerPeers)i.uint32(74),r.Peer.codec().encode(a,i);else throw new Error('Protocol error: required field "providerPeers" was not found in object');o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={closerPeers:[],providerPeers:[]},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.type=r.MessageType.codec().decode(s);break;case 10:o.clusterLevelRaw=s.int32();break;case 2:o.key=s.bytes();break;case 3:o.record=s.bytes();break;case 8:o.closerPeers.push(r.Peer.codec().decode(s,s.uint32()));break;case 9:o.providerPeers.push(r.Peer.codec().decode(s,s.uint32()));break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>Xe(s,r.codec()),r.decode=s=>Je(s,r.codec())})(wi||(wi={}));const Ut=wi.MessageType,nae=wi.ConnectionType,sae=Object.keys(Ut);let _r=class v_{constructor(e,t,n){if(!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this.clusterLevelRaw=n,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){const e=this.clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this.clusterLevelRaw=e}serialize(){return wi.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map(iw),providerPeers:this.providerPeers.map(iw),record:this.record==null?void 0:this.record.serialize().subarray()})}static deserialize(e){const t=wi.decode(e),n=new v_(t.type??wi.MessageType.PUT_VALUE,t.key??Uint8Array.from([]),t.clusterLevelRaw??0);return n.closerPeers=t.closerPeers.map(ow),n.providerPeers=t.providerPeers.map(ow),t.record?.length!=null&&(n.record=Kt.deserialize(t.record)),n}};function iw(r){return{id:r.id.toBytes(),addrs:(r.multiaddrs??[]).map(t=>t.bytes),connection:nae.CONNECTED}}function ow(r){if(r.id==null)throw new Error("Invalid peer in message");return{id:Fr(r.id),multiaddrs:(r.addrs??[]).map(e=>G(e)),protocols:[]}}function aw(r){return{...r,name:"SENDING_QUERY",type:0,messageName:r.type,messageType:sae.indexOf(r.type.toString())}}function lp(r){return{...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer!=null?r.closer:[],providers:r.providers!=null?r.providers:[]}}function Cl(r){return{...r,name:"FINAL_PEER",type:2}}function Bn(r){return{...r,name:"QUERY_ERROR",type:3}}function cw(r){return{...r,name:"PROVIDER",type:4}}function hp(r){return{...r,name:"VALUE",type:5}}function lw(r){return{...r,name:"DIALING_PEER",type:7}}let iae=class extends Fe{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=P(`libp2p:kad-dht:${s?"lan":"wan"}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(this.running){this.log("sending %s to %p",t.type,e),yield lw({peer:e}),yield aw({to:e,type:t.type});try{const i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),o=await this._writeReadMessage(i,t.serialize(),n);yield lp({from:e,messageType:o.type,closer:o.closerPeers,providers:o.providerPeers,record:o.record})}catch(s){yield Bn({from:e,error:s})}finally{}}}async*sendMessage(e,t,n={}){if(this.running){this.log("sending %s to %p",t.type,e),yield lw({peer:e}),yield aw({to:e,type:t.type});try{const i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n);await this._writeMessage(i,t.serialize(),n),yield lp({from:e,messageType:t.type})}catch(s){yield Bn({from:e,error:s})}finally{}}}async _writeMessage(e,t,n){n.signal!=null&&(e=sn(e,n.signal)),await ie([t],ar(),e,ot)}async _writeReadMessage(e,t,n){n.signal!=null&&(e=sn(e,n.signal));const s=await ie([t],ar(),e,er(),async o=>{const a=await Rr(o);if(a!=null)return a;throw v(new Error("No message received"),"ERR_NO_MESSAGE_RECEIVED")}),i=_r.deserialize(s);return i.closerPeers.forEach(o=>{this.dispatchEvent(new F("peer",{detail:o}))}),i.providerPeers.forEach(o=>{this.dispatchEvent(new F("peer",{detail:o}))}),i}};var oae=S_,hw=128,aae=127,cae=~aae,lae=Math.pow(2,31);function S_(r,e,t){e=e||[],t=t||0;for(var n=t;r>=lae;)e[t++]=r&255|hw,r/=128;for(;r&cae;)e[t++]=r&255|hw,r>>>=7;return e[t]=r|0,S_.bytes=t-n+1,e}var hae=up,uae=128,uw=127;function up(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw up.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&uw)<<s:(o&uw)*Math.pow(2,s),s+=7}while(o>=uae);return up.bytes=i-n,t}var dae=Math.pow(2,7),fae=Math.pow(2,14),pae=Math.pow(2,21),gae=Math.pow(2,28),yae=Math.pow(2,35),wae=Math.pow(2,42),mae=Math.pow(2,49),bae=Math.pow(2,56),Eae=Math.pow(2,63),_ae=function(r){return r<dae?1:r<fae?2:r<pae?3:r<gae?4:r<yae?5:r<wae?6:r<mae?7:r<bae?8:r<Eae?9:10},vae={encode:oae,decode:hae,encodingLength:_ae},R_=vae;const dw=(r,e,t=0)=>(R_.encode(r,e,t),e),fw=r=>R_.encodingLength(r),pw=(r,e)=>{const t=e.byteLength,n=fw(r),s=n+fw(t),i=new Uint8Array(s+t);return dw(r,i,0),dw(t,i,n),i.set(e,s),new Sae(r,t,e,i)};let Sae=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const A_=({name:r,code:e,encode:t})=>new Rae(r,e,t);let Rae=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?pw(this.code,t):t.then(n=>pw(this.code,n))}else throw Error("Unknown type, must be binary type")}};const I_=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Aae=A_({name:"sha2-256",code:18,encode:I_("SHA-256")});A_({name:"sha2-512",code:19,encode:I_("SHA-512")});function gg(r,e){const t=e.key,s=B(t).split("/");if(s.length<3)return;const i=r[s[1].toString()];if(i==null){const o="Invalid record keytype";throw v(new Error(o),"ERR_INVALID_RECORD_KEY_TYPE")}return i(t,e.value)}const Iae=async(r,e)=>{if(!(r instanceof Uint8Array))throw v(new Error('"key" must be a Uint8Array'),"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(r.byteLength<5)throw v(new Error("invalid public key record"),"ERR_INVALID_RECORD_KEY_TOO_SHORT");if(B(r.subarray(0,4))!=="/pk/")throw v(new Error("key was not prefixed with /pk/"),"ERR_INVALID_RECORD_KEY_BAD_PREFIX");const n=r.slice(4),s=await Aae.digest(e);if(!Ye(n,s.bytes))throw v(new Error("public key does not match passed in key"),"ERR_INVALID_RECORD_HASH_MISMATCH")},Cae={pk:Iae};function Tae(r,e,t){if(t.length===0){const o="No records given";throw v(new Error(o),"ERR_NO_RECORDS_RECEIVED")}const s=B(e).split("/");if(s.length<3){const o="Record key does not have a selector function";throw v(new Error(o),"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}const i=r[s[1].toString()];if(i==null){const o=`Unrecognized key prefix: ${s[1]}`;throw v(new Error(o),"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:i(e,t)}function kae(r,e){return 0}const Dae={pk:kae};class Pae{constructor(e,t){const{validators:n,selectors:s,peerRouting:i,queryManager:o,routingTable:a,network:c,lan:h}=t;this.components=e,this.log=P(`libp2p:kad-dht:${h?"lan":"wan"}:content-fetching`),this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.routingTable=a,this.network=c}async putLocal(e,t){const n=to(e);await this.components.datastore.put(n,t)}async getLocal(e){this.log("getLocal %b",e);const t=to(e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const s=Kt.deserialize(n);return await gg(this.validators,s),s}async*sendCorrectionRecord(e,t,n,s={}){this.log("sendCorrection for %b",e);const i=await rw(e,n);for(const{value:o,from:a}of t){if(Ye(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const l=to(e);this.log(`Storing corrected record for key ${l.toString()}`),await this.components.datastore.put(l,i.subarray())}catch(l){this.log.error("Failed error correcting self",l)}continue}let c=!1;const h=new _r(Ut.PUT_VALUE,e,0);h.record=Kt.deserialize(i);for await(const l of this.network.sendRequest(a,h,s))l.name==="PEER_RESPONSE"&&l.record!=null&&Ye(l.record.value,Kt.deserialize(i).value)&&(c=!0),yield l;c||(yield Bn({from:a,error:v(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")})),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const s=await rw(e,t),i=to(e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray()),yield*ie(this.peerRouting.getClosestPeers(e,{signal:n.signal}),o=>zt(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],h=new _r(Ut.PUT_VALUE,e,0);h.record=Kt.deserialize(s),this.log("send put to %p",a.peer.id);for await(const l of this.network.sendRequest(a.peer.id,h,n))c.push(l),l.name==="PEER_RESPONSE"&&(l.record!=null&&Ye(l.record.value,Kt.deserialize(s).value)||c.push(Bn({from:a.peer.id,error:v(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")})));return c}),o=>cd(o,{ordered:!1,concurrency:Uu}),async function*(o){for await(const a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;const s=n.map(a=>a.value);let i=0;try{i=Tae(this.selectors,e,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw v(new Error("best value was not found"),"ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,o,t),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const a=await this.getLocal(e);yield hp({value:a.value,from:this.components.peerId})}catch(a){this.log("error getting local value for %b",e,a)}const n=await ko(e),s=this.routingTable.closestPeers(n);this.log("found %d peers in routing table",s.length);const i=this,o=async function*({peer:a,signal:c}){for await(const h of i.peerRouting.getValueOrPeers(a,e,{signal:c}))yield h,h.name==="PEER_RESPONSE"&&h.record!=null&&(yield hp({from:a,value:h.record.value}))};yield*this.queryManager.run(e,s,o,t)}}class Oae{constructor(e,t){const{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,lan:c}=t;this.components=e,this.log=P(`libp2p:kad-dht:${c?"lan":"wan"}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a}async*provide(e,t,n={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);const s=new _r(Ut.ADD_PROVIDER,e.multihash.bytes,0);s.providerPeers=[{id:this.components.peerId,multiaddrs:t,protocols:[]}];let i=0;const o=a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[];this.log("putProvider %s to %p",e,a.peer.id);try{this.log("sending provider record for %s to %p",e,a.peer.id);for await(const h of this.network.sendMessage(a.peer.id,s,n))h.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,a.peer.id),i++),c.push(h)}catch(h){this.log.error("error sending provide record to peer %p",a.peer.id,h),c.push(Bn({from:a.peer.id,error:h}))}return c};yield*ie(this.peerRouting.getClosestPeers(e.multihash.bytes,n),a=>zt(a,c=>o(c)),a=>cd(a,{ordered:!1,concurrency:Uu}),async function*(a){for await(const c of a)yield*c}),this.log("sent provider records to %d peers",i)}async*findProviders(e,t){const n=this.routingTable.kBucketSize,s=e.multihash.bytes,i=await ko(s),o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e);if(a.length>0){const l=[];for(const u of a.slice(0,n))l.push({id:u,multiaddrs:(await this.components.peerStore.addressBook.get(u)??[]).map(f=>f.multiaddr),protocols:[]});yield lp({from:this.components.peerId,messageType:Ut.GET_PROVIDERS,providers:l}),yield cw({from:this.components.peerId,providers:l})}if(a.length>=n)return;const c=async function*({peer:l,signal:u}){const f=new _r(Ut.GET_PROVIDERS,s,0);yield*o.network.sendRequest(l,f,{signal:u})},h=new Set(a.map(l=>l.toString()));for await(const l of this.queryManager.run(s,this.routingTable.closestPeers(i),c,t))if(yield l,l.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",l.providers.length,e,l.closer.length);const u=[];for(const f of l.providers)h.has(f.id.toString())||(h.add(f.id.toString()),u.push(f));if(u.length>0&&(yield cw({from:l.from,providers:u})),h.size===n)return}}}class Nae{constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(s=>s.peerId.equals(e))!=null)return;const t=await $n(e),n={peerId:e,distance:Ga(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((s,i)=>c1(s.distance,i.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(e.length===0)return!1;if(this.length===0)return!0;const t=await Promise.all(e.map($n)),n=this.peerDistances[this.peerDistances.length-1].distance;for(const s of t){const i=Ga(this.originDhtKey,s);if(c1(i,n)<0)return!0}return!1}}class xae{constructor(e,t){const{routingTable:n,network:s,validators:i,queryManager:o,lan:a}=t;this.components=e,this.routingTable=n,this.network=s,this.validators=i,this.queryManager=o,this.log=P(`libp2p:kad-dht:${a?"lan":"wan"}:peer-routing`)}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.components.peerStore.get(n)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(t==null)try{t=await this.components.peerStore.get(e)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(s=>s.multiaddr),protocols:[]}}async*_getValueSingle(e,t,n={}){const s=new _r(Ut.GET_VALUE,t,0);yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=qoe(e);for await(const s of this._getValueSingle(e,n,t))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const i=await Ir(vp({bytes:s.record.value}));if(!i.equals(e))throw v(new Error("public key does not match id"),"ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(i.publicKey==null)throw v(new Error("public key missing"),"ERR_PUBLIC_KEY_MISSING");yield hp({from:e,value:i.publicKey})}throw v(new Error(`Node not responding with its public key: ${e.toString()}`),"ERR_INVALID_RECORD")}async*findPeer(e,t={}){this.log("findPeer %p",e);const n=await this.findPeerLocal(e);if(n!=null){this.log("found local"),yield Cl({from:this.components.peerId,peer:n});return}const s=await $n(e),i=this.routingTable.closestPeers(s);if(i.find(l=>l.equals(e))!=null)try{const l=await this.components.peerStore.get(e);this.log("found in peerStore"),yield Cl({from:this.components.peerId,peer:{id:l.id,multiaddrs:l.addresses.map(u=>u.multiaddr),protocols:[]}});return}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}const a=this,c=async function*({peer:l,signal:u}){const f=new _r(Ut.FIND_NODE,e.toBytes(),0);for await(const g of a.network.sendRequest(l,f,{signal:u}))if(yield g,g.name==="PEER_RESPONSE"){const d=g.closer.find(p=>p.id.equals(e));d!=null&&(yield Cl({from:g.from,peer:d}))}};let h=!1;for await(const l of this.queryManager.run(e.toBytes(),i,c,t))l.name==="FINAL_PEER"&&(h=!0),yield l;h||(yield Bn({from:this.components.peerId,error:v(new Error("Not found"),"ERR_NOT_FOUND")}))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await ko(e),s=this.routingTable.closestPeers(n),i=this,o=new Nae(n,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>await o.add(c)));const a=async function*({peer:c,signal:h}){i.log("closerPeersSingle %s from %p",B(e,"base32"),c);const l=new _r(Ut.FIND_NODE,e,0);yield*i.network.sendRequest(c,l,{signal:h})};for await(const c of this.queryManager.run(e,s,a,t))yield c,c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async h=>await o.add(h.id)));this.log("found %d peers close to %b",o.length,e);for(const c of o.peers)yield Cl({from:this.components.peerId,peer:{id:c,multiaddrs:(await this.components.peerStore.addressBook.get(c)??[]).map(h=>h.multiaddr),protocols:[]}})}async*getValueOrPeers(e,t,n={}){for await(const s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{const o="invalid record received, discarded";this.log(o),yield Bn({from:s.from,error:v(new Error(o),"ERR_INVALID_RECORD")});continue}yield s}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw v(new Error("invalid record received"),"ERR_INVALID_RECORD");await gg(this.validators,new Kt(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=await ko(e),s=this.routingTable.closestPeers(n),i=[];for(const o of s)if(!o.equals(t))try{const a=await this.components.peerStore.addressBook.get(o),c=await this.components.peerStore.protoBook.get(o);i.push({id:o,multiaddrs:a.map(h=>h.multiaddr),protocols:c})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),i}}const An=P("libp2p:kad-dht:providers");class $ae{constructor(e,t={}){const{cacheSize:n,cleanupInterval:s,provideValidity:i}=t;this.components=e,this.cleanupInterval=s??Boe,this.provideValidity=i??Uoe,this.cache=nd(n??Moe),this.syncQueue=new lt({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{An.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){return await this.syncQueue.add(async()=>{const e=Date.now();let t=0,n=0;const s=new Map,i=this.components.datastore.batch(),o=this.components.datastore.query({prefix:__});for await(const a of o)try{const{cid:c,peerId:h}=C_(a.key),l=T_(a.value).getTime(),u=Date.now(),f=u-l,g=f>this.provideValidity;if(An("comparing: %d - %d = %d > %d %s",u,l,f,this.provideValidity,g?"(expired)":""),g){n++,i.delete(a.key);const d=s.get(c)??new Set;d.add(h),s.set(c,d)}t++}catch(c){An.error(c.message)}s.size>0?(An("deleting %d / %d entries",n,t),await i.commit()):An("nothing to delete");for(const[a,c]of s){const h=Ka(a),l=this.cache.get(h);if(l!=null){for(const u of c)l.delete(u);l.size===0?this.cache.remove(h):this.cache.set(h,l)}}An("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){const t=Ka(e);let n=this.cache.get(t);return n==null&&(n=await Mae(this.components.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){return await this.syncQueue.add(async()=>{An("%p provides %s",t,e);const n=await this._getProvidersMap(e);An("loaded %s provs",n.size);const s=new Date;n.set(t.toString(),s);const i=Ka(e);this.cache.set(i,n),await Lae(this.components.datastore,e,t,s)})}async getProviders(e){return await this.syncQueue.add(async()=>(An("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(n=>Z(n))))}}function Ka(r){const e=typeof r=="string"?r:B(r.multihash.bytes,"base32");return`${__}/${e}`}async function Lae(r,e,t,n){const s=[Ka(e),"/",t.toString()].join(""),i=new X(s),o=Uint8Array.from(je.encode(n.getTime()));return await r.put(i,o)}function C_(r){const e=r.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:e[3],peerId:e[4]}}async function Mae(r,e){const t=new Map,n=r.query({prefix:Ka(e)});for await(const s of n){const{peerId:i}=C_(s.key);t.set(i,T_(s.value))}return t}function T_(r){return new Date(je.decode(r))}const Uae=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*Bae(r){const{key:e,startingPeer:t,ourPeerId:n,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,cleanUp:h,queryFuncTimeout:l,log:u,peersSeen:f}=r,g=new lt({concurrency:o}),d=await ko(e);function p(w,y){if(w==null)return;f.add(w);const _=BigInt("0x"+B(Ga(y,d),"base16"));g.add(async()=>{let m;const b=[s];l!=null&&(m=new ze.TimeoutController(l),b.push(m.signal));const S=Ur(b);try{for await(const A of i({key:e,peer:w,signal:S,pathIndex:a,numPaths:c})){if(S.aborted)return;if(A.name==="PEER_RESPONSE")for(const E of A.closer){if(f.has(E.id)){u("already seen %p in query",E.id);continue}if(n.equals(E.id)){u("not querying ourselves");continue}const I=await $n(E.id);if(BigInt("0x"+B(Ga(I,d),"base16"))>_){u("skipping %p as they are not closer to %b than %p",E.id,e,w);continue}u("querying closer peer %p",E.id),p(E.id,I)}g.emit("completed",A)}m?.clear()}catch(A){s.aborted?g.emit("error",A):g.emit("completed",Bn({from:w,error:A}))}finally{m?.clear()}},{priority:Uae-_}).catch(m=>{u.error(m)})}p(t,await $n(t)),yield*zae(g,s,h,u)}async function*zae(r,e,t,n){let s=We(),i=!0;const o=[],a=()=>{i&&(n("clean up queue, results %d, queue size %d, pending tasks %d",o.length,r.size,r.pending),i=!1,r.clear(),o.splice(0,o.length))};for(r.on("completed",c=>{o.push(c),s.resolve()}),r.on("error",c=>{n("queue error",c),a(),s.reject(c)}),r.on("idle",()=>{n("queue idle"),i=!1,s.resolve()}),e.addEventListener("abort",()=>{n("abort queue");const c=i;a(),c&&s.reject(v(new Error("Query aborted"),"ERR_QUERY_ABORTED"))}),t.addEventListener("cleanup",()=>{a(),s.resolve()});i;)for(await s.promise,s=We();o.length>0;){const c=o.shift();c!=null&&(yield c)}yield*o}class Fae{constructor(e,t){const{lan:n=!1,disjointPaths:s=cp,alpha:i=Uu}=t;this.components=e,this.disjointPaths=s??cp,this.controllers=new Set,this.running=!1,this.alpha=i??Uu,this.lan=n,this.queries=0}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&this.metrics==null&&(this.metrics={runningQueries:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_running_queries`),queryTime:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_query_time_seconds`)})}async stop(){this.running=!1;for(const e of this.controllers)e.abort();this.controllers.clear()}async*run(e,t,n,s={}){if(!this.running)throw new Error("QueryManager not started");const i=this.metrics?.queryTime.timer();let o;if(s.signal==null){o=new ze.TimeoutController(joe),s.signal=o.signal;try{Ce.setMaxListeners!=null&&Ce.setMaxListeners(1/0,o.signal)}catch{}}const a=new AbortController;this.controllers.add(a);const c=[a.signal];s.signal!=null&&c.push(s.signal);const h=Ur(c);try{Ce.setMaxListeners!=null&&Ce.setMaxListeners(1/0,h)}catch{}const l=P(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+B(e,"base58btc")),u=t.slice(0,Math.min(this.disjointPaths,t.length)),f=Date.now(),g=new Fe;try{if(l("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries),t.length===0){l.error("Running query with no peers");return}const d=new Vs,p=u.map((w,y)=>Bae({key:e,startingPeer:w,ourPeerId:this.components.peerId,signal:h,query:n,pathIndex:y,numPaths:u.length,alpha:this.alpha,cleanUp:g,queryFuncTimeout:s.queryFuncTimeout,log:l,peersSeen:d}));for await(const w of Yt(...p))yield w,w.name==="QUERY_ERROR"&&l("error",w.error)}catch(d){if(!(!this.running&&d.code==="ERR_QUERY_ABORTED"))throw d}finally{this.controllers.delete(a),o?.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),i?.(),g.dispatchEvent(new F("cleanup")),l("query:done in %dms",Date.now()-f)}}}function Vae(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var Kae=Vae,jae=Kae;let Hae=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},qae=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return k_(this,e)}},Gae=class{constructor(e){this.decoders=e}or(e){return k_(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const k_=(r,e)=>new Gae({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Wae=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Hae(e,t,n),this.decoder=new qae(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const D_=({name:r,prefix:e,encode:t,decode:n})=>new Wae(r,e,t,n),P_=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=jae(t,e);return D_({prefix:r,name:e,encode:n,decode:i=>lg(s(i))})},Yae=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Qae=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},ts=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>D_({prefix:e,name:r,encode(s){return Qae(s,n,t)},decode(s){return Yae(s,n,t,r)}}),Is=P_({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});P_({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Jl=ts({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ts({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ts({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ts({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ts({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ts({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ts({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ts({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ts({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const gw=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Jae(t,dp(r),e||Is.encoder);default:return Zae(t,dp(r),e||Jl.encoder)}},yw=new WeakMap,dp=r=>{const e=yw.get(r);if(e==null){const t=new Map;return yw.set(r,t),t}return e};let O_=class xt{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ma)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==ece)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return xt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=ap(e,t);return xt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return xt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Doe(e.multihash,n.multihash)}toString(e){return gw(this,e)}toJSON(){return{"/":gw(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof xt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new xt(n,s,i,o||ww(n,s,i.bytes))}else if(t[tce]===!0){const{version:n,multihash:s,code:i}=t,o=koe(s);return xt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ma)throw new Error(`Version 0 CID must use dag-pb (code: ${ma}) block encoding`);return new xt(e,t,n,n.bytes)}case 1:{const s=ww(e,t,n.bytes);return new xt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return xt.create(0,ma,e)}static createV1(e,t){return xt.create(1,e,t)}static decode(e){const[t,n]=xt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=xt.inspectBytes(e),n=t.size-t.multihashSize,s=lg(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new hg(t.multihashCode,t.digestSize,i,s);return[t.version===0?xt.createV0(o):xt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=op(e.subarray(t));return t+=f,u};let s=n(),i=ma;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=Xae(e,t),i=xt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return dp(i).set(n,e),i}};const Xae=(r,e)=>{switch(r[0]){case"Q":{const t=e||Is;return[Is.prefix,t.decode(`${Is.prefix}${r}`)]}case Is.prefix:{const t=e||Is;return[Is.prefix,t.decode(r)]}case Jl.prefix:{const t=e||Jl;return[Jl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Jae=(r,e,t)=>{const{prefix:n}=t;if(n!==Is.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Zae=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ma=112,ece=18,ww=(r,e,t)=>{const n=Mu(r),s=n+Mu(e),i=new Uint8Array(s+t.byteLength);return Lu(r,i,0),Lu(e,i,n),i.set(t,s),i},tce=Symbol.for("@ipld/js-cid/CID"),ba=P("libp2p:kad-dht:rpc:handlers:add-provider");class rce{constructor(e){const{providers:t}=e;this.providers=t}async handle(e,t){if(ba("start"),t.key==null||t.key.length===0)throw v(new Error("Missing key"),"ERR_MISSING_KEY");let n;try{n=O_.decode(t.key)}catch{throw v(new Error("Invalid CID"),"ERR_INVALID_CID")}(t.providerPeers==null||t.providerPeers.length===0)&&ba.error("no providers found in message"),await Promise.all(t.providerPeers.map(async s=>{if(!s.id.equals(e)){ba("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){ba("no valid addresses for provider %p. Ignore",e);return}ba("received provider %p for %s (addrs %s)",e,n,s.multiaddrs.map(i=>i.toString())),await this.providers.addProvider(n,s.id)}))}}const mw=P("libp2p:kad-dht:rpc:handlers:find-node");class nce{constructor(e,t){const{peerRouting:n,lan:s}=t;this.components=e,this.peerRouting=n,this.lan=Boolean(s)}async handle(e,t){mw("incoming request from %p for peers closer to %b",e,t.key);let n=[];Ye(this.components.peerId.toBytes(),t.key)?n=[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(i=>i.decapsulateCode(Qu("p2p").code)),protocols:[]}]:n=await this.peerRouting.getCloserPeersOffline(t.key,e),n=n.map(this.lan?pg:fg).filter(({multiaddrs:i})=>i.length);const s=new _r(t.type,new Uint8Array(0),t.clusterLevel);return n.length>0?s.closerPeers=n:mw("could not find any peers closer to %b than %p",t.key,e),s}}const bw=P("libp2p:kad-dht:rpc:handlers:get-providers");class sce{constructor(e,t){const{peerRouting:n,providers:s,lan:i}=t;this.components=e,this.peerRouting=n,this.providers=s,this.lan=Boolean(i)}async handle(e,t){let n;try{n=O_.decode(t.key)}catch{throw v(new Error("Invalid CID"),"ERR_INVALID_CID")}bw("%p asking for providers for %s",e,n);const[s,i]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(s),a=await this._getPeers(i.map(({id:h})=>h)),c=new _r(t.type,t.key,t.clusterLevel);return o.length>0&&(c.providerPeers=o),a.length>0&&(c.closerPeers=a),bw("got %s providers %s closerPeers",o.length,a.length),c}async _getAddresses(e){return(await this.components.peerStore.addressBook.get(e)).map(n=>n.multiaddr)}async _getPeers(e){const t=[],n=this.lan?pg:fg;for(const s of e){const i=n({id:s,multiaddrs:await this._getAddresses(s),protocols:[]});i.multiaddrs.length>0&&t.push(i)}return t}}const Hi=P("libp2p:kad-dht:rpc:handlers:get-value");class ice{constructor(e,t){const{peerRouting:n}=t;this.components=e,this.peerRouting=n}async handle(e,t){const n=t.key;if(Hi("%p asked for key %b",e,n),n==null||n.length===0)throw v(new Error("Invalid key"),"ERR_INVALID_KEY");const s=new _r(Ut.GET_VALUE,n,t.clusterLevel);if(Goe(n)){Hi("is public key");const a=Woe(n);let c;try{const h=await this.components.peerStore.keyBook.get(a);if(h==null)throw v(new Error("No public key found in key book"),"ERR_NOT_FOUND");c=h}catch(h){if(h.code!=="ERR_NOT_FOUND")throw h}if(c!=null)return Hi("returning found public key"),s.record=new Kt(n,c,new Date),s}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(t.key,e)]);return i!=null&&(Hi("had record for %b in local datastore",n),s.record=i),o.length>0&&(Hi("had %s closer peers in routing table",o.length),s.closerPeers=o),s}async _checkLocalDatastore(e){Hi("checkLocalDatastore looking for %b",e);const t=to(e);let n;try{n=await this.components.datastore.get(t)}catch(i){if(i.code==="ERR_NOT_FOUND")return;throw i}const s=Kt.deserialize(n);if(s==null)throw v(new Error("Invalid record"),"ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>Ooe){await this.components.datastore.delete(t);return}return s}}const oce=P("libp2p:kad-dht:rpc:handlers:ping");class ace{async handle(e,t){return oce("ping from %p",e),t}}class cce{constructor(e,t){const{validators:n}=t;this.components=e,this.log=P("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=n}async handle(e,t){const n=t.key;this.log("%p asked us to store value for key %b",e,n);const s=t.record;if(s==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),v(new Error(i),"ERR_EMPTY_RECORD")}try{await gg(this.validators,s),s.timeReceived=new Date;const i=to(s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}}class lce{constructor(e,t){const{providers:n,peerRouting:s,validators:i,lan:o}=t;this.log=P("libp2p:kad-dht:rpc"),this.routingTable=t.routingTable,this.handlers={[Ut.GET_VALUE]:new ice(e,{peerRouting:s}),[Ut.PUT_VALUE]:new cce(e,{validators:i}),[Ut.FIND_NODE]:new nce(e,{peerRouting:s,lan:o}),[Ut.ADD_PROVIDER]:new rce({providers:n}),[Ut.GET_PROVIDERS]:new sce(e,{peerRouting:s,providers:n,lan:o}),[Ut.PING]:new ace}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(s){this.log.error("Failed to update the kbucket store",s)}const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}return await n.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{const{stream:t,connection:n}=e,s=n.remotePeer;try{await this.routingTable.add(s)}catch(o){this.log.error(o)}const i=this;await ie(t,er(),async function*(o){for await(const a of o){const c=_r.deserialize(a);i.log("incoming %s from %p",c.type,s);const h=await i.handleMessage(s,c);h!=null&&(yield h.serialize())}},ar(),t)}).catch(t=>{this.log.error(t)})}}class hce extends Fe{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=P(`libp2p:kad-dht:topology-listener:${s?"lan":"wan"}`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){if(this.running)return;this.running=!0;const e=z2({onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new F("peer",{detail:t}))}});this.registrarId=await this.components.registrar.register(this.protocol,e)}stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class uce{constructor(e,t){const{peerRouting:n,lan:s,count:i,interval:o,queryTimeout:a}=t;this.components=e,this.log=P(`libp2p:kad-dht:${s?"lan":"wan"}:query-self`),this.running=!1,this.peerRouting=n,this.count=i??cp,this.interval=o??zoe,this.queryTimeout=a??Foe}isStarted(){return this.running}async start(){this.running||(this.running=!0,this._querySelf())}async stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}_querySelf(){Promise.resolve().then(async()=>{const e=new ze.TimeoutController(this.queryTimeout);try{this.controller=new AbortController;const t=Ur([this.controller.signal,e.signal]);try{Ce.setMaxListeners!=null&&Ce.setMaxListeners(1/0,t)}catch{}const n=await ie(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:t}),s=>Ei(s,this.count),async s=>await Eo(s));this.log("query ran successfully - found %d peers",n)}catch(t){this.log("query error",t)}finally{this.timeoutId=setTimeout(this._querySelf.bind(this),this.interval),e.clear()}}).catch(e=>{this.log("query error",e)})}}const dce=32,fce=64;let Ew=class extends Fe{constructor(e,t){super();const{kBucketSize:n,clientMode:s,validators:i,selectors:o,querySelfInterval:a,lan:c,protocolPrefix:h,pingTimeout:l,pingConcurrency:u,maxInboundStreams:f,maxOutboundStreams:g,providers:d}=t;this.running=!1,this.components=e,this.lan=Boolean(c),this.log=P(`libp2p:kad-dht:${c===!0?"lan":"wan"}`),this.protocol=`${h??xoe}${c===!0?Noe:""}${$oe}`,this.kBucketSize=n??20,this.clientMode=s??!0,this.maxInboundStreams=f??dce,this.maxOutboundStreams=g??fce,this.routingTable=new eae(e,{kBucketSize:n,lan:this.lan,pingTimeout:l,pingConcurrency:u,protocol:this.protocol}),this.providers=new $ae(e,d??{}),this.validators={...Cae,...i},this.selectors={...Dae,...o},this.network=new iae(e,{protocol:this.protocol,lan:this.lan}),this.queryManager=new Fae(e,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:c}),this.peerRouting=new xae(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new Pae(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,network:this.network,lan:this.lan}),this.contentRouting=new Oae(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new rae({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new lce(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new hce(e,{protocol:this.protocol,lan:this.lan}),this.querySelf=new uce(e,{peerRouting:this.peerRouting,interval:a,lan:this.lan}),this.network.addEventListener("peer",p=>{const w=p.detail;this.onPeerConnect(w).catch(y=>{this.log.error("could not add %p to routing table",w.id,y)}),this.dispatchEvent(new F("peer",{detail:w}))}),this.topologyListener.addEventListener("peer",p=>{const w=p.detail;Promise.resolve().then(async()=>{const y=await this.components.peerStore.addressBook.get(w),_={id:w,multiaddrs:y.map(m=>m.multiaddr),protocols:[]};await this.onPeerConnect(_)}).catch(y=>{this.log.error("could not add %p to routing table",w,y)})})}get[Mc](){return!0}get[Symbol.toStringTag](){return"@libp2p/kad-dht"}async onPeerConnect(e){if(this.log("peer %p connected with protocols %s",e.id,e.protocols),this.lan?e=pg(e):e=fg(e),e.multiaddrs.length===0){this.log("ignoring %p as they do not have any %s addresses in %s",e.id,this.lan?"private":"public",e.multiaddrs.map(t=>t.toString()));return}try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start(),this.querySelf.start()]),await this.routingTableRefresh.start()}async stop(){this.running=!1,await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop(),this.querySelf.stop()])}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){await this.routingTableRefresh.refreshTable(!0)}};const pce=P("libp2p:kad-dht");class gce extends Fe{constructor(e,t,n){super(),this.components=e,this.wan=t,this.lan=n,this.wan.addEventListener("peer",s=>{this.dispatchEvent(new F("peer",{detail:s.detail}))}),this.lan.addEventListener("peer",s=>{this.dispatchEvent(new F("peer",{detail:s.detail}))})}get[Mc](){return!0}get[Symbol.toStringTag](){return"@libp2p/dual-kad-dht"}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return await this.wan.getMode()}async setMode(e){await this.wan.setMode(e)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(e,t,n={}){for await(const s of Yt(this.lan.put(e,t,n),this.wan.put(e,t,n)))yield s}async*get(e,t={}){let n=!1,s=!1;for await(const i of Yt(this.lan.get(e,t),this.wan.get(e,t)))yield i,i.name==="DIALING_PEER"&&(n=!0),i.name==="VALUE"&&(n=!0,i.value!=null&&(s=!0)),i.name==="SENDING_QUERY"&&(n=!0);if(!n)throw v(new Error("No peers found in routing table!"),"ERR_NO_PEERS_IN_ROUTING_TABLE");s||(yield Bn({from:this.components.peerId,error:v(new Error("Not found"),"ERR_NOT_FOUND")}))}async*provide(e,t={}){let n=0,s=0;const i=[],o=[this.lan];await this.wan.getMode()==="server"&&o.push(this.wan);for await(const a of Yt(...o.map(c=>c.provide(e,t))))yield a,a.name==="SENDING_QUERY"&&n++,a.name==="QUERY_ERROR"&&i.push(a.error),a.name==="PEER_RESPONSE"&&a.messageName==="ADD_PROVIDER"&&(pce("sent provider record for %s to %p",e,a.from),s++);if(s===0)throw i.length>0?v(new Error(`Failed to provide to ${i.length} of ${n} peers`),"ERR_PROVIDES_FAILED",{errors:i}):v(new Error("Failed to provide - no peers found"),"ERR_PROVIDES_FAILED")}async*findProviders(e,t={}){yield*Yt(this.lan.findProviders(e,t),this.wan.findProviders(e,t))}async*findPeer(e,t={}){let n=!1;for await(const s of Yt(this.lan.findPeer(e,t),this.wan.findPeer(e,t)))yield s,(s.name==="SENDING_QUERY"||s.name==="FINAL_PEER")&&(n=!0);if(!n)throw v(new Error("Peer lookup failed"),"ERR_LOOKUP_FAILED")}async*getClosestPeers(e,t={}){yield*Yt(this.lan.getClosestPeers(e,t),this.wan.getClosestPeers(e,t))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}}class yce extends gce{constructor(e,t){super(e,new Ew(e,{protocolPrefix:"/ipfs",...t,lan:!1}),new Ew(e,{protocolPrefix:"/ipfs",...t,clientMode:!1,lan:!0}))}}function wce(r){return e=>new yce(e,r)}const Tl=P("libp2p:bootstrap"),mce="bootstrap",bce=50,Ece=12e4,_ce=1e3;class N_ extends Fe{constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.timeout=t.timeout??_ce,this.list=[];for(const n of t.list){if(!t8.matches(n)){Tl.error("Invalid multiaddr");continue}const s=G(n),i=s.getPeerId();if(i==null){Tl.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:Z(i),multiaddrs:[s],protocols:[]};this.list.push(o)}this._init=t}get[Mc](){return!0}get[Symbol.toStringTag](){return"@libp2p/bootstrap"}isStarted(){return Boolean(this.timer)}start(){this.isStarted()||(Tl("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{Tl.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.tagPeer(e.id,this._init.tagName??mce,{value:this._init.tagValue??bce,ttl:this._init.tagTTL??Ece}),this.timer==null)return;this.dispatchEvent(new F("peer",{detail:e}))}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}N_.tag="bootstrap";function vce(r){return e=>new N_(e,r)}const Sce=WebSocket;var $d={},Ld={};Object.defineProperty(Ld,"__esModule",{value:!0});class Rce{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,s)=>{this.pullQueue.push({resolve:n,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let x_=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){const s=new Rce;s.highWaterMark=t,s.lowWaterMark=n,s.removeCallback=e({push:i=>s.push(i),stop:()=>s.stop(),fail:i=>s.fail(i),on:(i,o)=>{s.eventHandlers[i]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};Ld.EventIterator=x_;Ld.default=x_;Object.defineProperty($d,"__esModule",{value:!0});const yg=Ld;var Ace=$d.EventIterator=yg.EventIterator;function Ice(r,e,t){return new yg.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}$d.subscribe=Ice;$d.default=yg.EventIterator;function _w(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}const Cce=r=>{r.binaryType="arraybuffer";const e=async()=>await new Promise((i,o)=>{if(n)return i();if(s!=null)return o(s);const a=l=>{r.removeEventListener("open",c),r.removeEventListener("error",h),l()},c=()=>a(i),h=l=>{a(()=>o(l.error??new Error(`connect ECONNREFUSED ${r.url}`)))};r.addEventListener("open",c),r.addEventListener("error",h)}),t=async function*(){const i=new Ace(({push:o,stop:a,fail:c})=>{const h=u=>{let f=null;typeof u.data=="string"&&(f=L(u.data)),_w(u.data)&&(f=new Uint8Array(u.data)),u.data instanceof Uint8Array&&(f=u.data),f!=null&&o(f)},l=u=>c(u.error??new Error("Socket error"));return r.addEventListener("message",h),r.addEventListener("error",l),r.addEventListener("close",a),()=>{r.removeEventListener("message",h),r.removeEventListener("error",l),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of i)yield _w(o)?new Uint8Array(o):o}();let n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",i=>{n||(s=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},Tce=r=>{if(r.readyState>=2)throw new Error("socket closed");if(r.readyState!==1)return new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",i)}function s(){n(),e()}function i(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",i)})},kce=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const s of n){try{await Tce(r)}catch(i){if(i.message==="socket closed")break;throw i}r.send(s)}if(e.closeOnEnd!=null&&r.readyState<=1)return await new Promise((s,i)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>r.close())})}),Dce=(r,e)=>{e=e??{};const t=Cce(r);let n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,s=parseInt(o.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:kce(r,e),source:t,connected:async()=>await t.connected(),close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}},Pce={http:"ws",https:"wss"},Oce="ws",Nce=(r,e)=>em.relative(r,e,Pce,Oce);function xce(r,e){const t=typeof window>"u"?"":window.location;e=e??{};const n=Nce(r,t.toString()),s=new Sce(n,e.websocket);return Dce(s,e)}function $ce(){throw new Error("WebSocket Servers can not be created in the browser!")}const $_=421,L_=290,Lce=6,Mce=478,Uce=2e3;class Bce extends Error{constructor(e){super(e),this.name="TimeoutError"}}class zce extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const vw=r=>globalThis.DOMException===void 0?new zce(r):new DOMException(r),Sw=r=>{const e=r.reason===void 0?vw("This operation was aborted."):r.reason;return e instanceof Error?e:vw(e)};function Fce(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o;const a=new Promise((c,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(t===Number.POSITIVE_INFINITY){c(r);return}if(e.signal){const{signal:l}=e;l.aborted&&h(Sw(l)),l.addEventListener("abort",()=>{h(Sw(l))})}o=i.setTimeout.call(void 0,()=>{if(n){try{c(n())}catch(l){h(l)}return}if(typeof r.cancel=="function"&&r.cancel(),s===!1)c();else if(s instanceof Error)h(s);else{const l=s??`Promise timed out after ${t} milliseconds`;h(new Bce(l))}},t),(async()=>{try{c(await r)}catch(l){h(l)}finally{i.clearTimeout.call(void 0,o)}})()});return a.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},a}const Rw=P("libp2p:websockets:socket");function Vce(r,e,t){t=t??{};const n={async sink(s){t?.signal!=null&&(s=Zt(s,t.signal));try{await r.sink(s)}catch(i){i.type!=="aborted"&&Rw.error(i)}},source:t.signal!=null?Zt(r.source,t.signal):r.source,remoteAddr:e,timeline:{open:Date.now()},async close(){const s=Date.now();try{await Fce(r.close(),{milliseconds:Uce})}catch{const{host:o,port:a}=n.remoteAddr.toOptions();Rw("timeout closing stream to %s:%s after %dms, destroying it manually",o,a,Date.now()-s),r.destroy()}finally{n.timeline.close=Date.now()}}};return r.socket.addEventListener("close",()=>{n.timeline.close==null&&(n.timeline.close=Date.now())},{once:!0}),n}function Kce(r){return r.filter(e=>{if(e.protoCodes().includes(L_))return!1;const t=e.decapsulateCode($_);return mh.matches(t)||Qa.matches(t)})}function jce(r){return r.filter(e=>{if(e.protoCodes().includes(L_))return!1;const t=e.decapsulateCode($_);return Qa.matches(t)&&Ti.matches(t.decapsulateCode(Lce).decapsulateCode(Mce))})}const hs=P("libp2p:websockets");class Hce{constructor(e){this.init=e}get[Symbol.toStringTag](){return"@libp2p/websockets"}get[eg](){return!0}async dial(e,t){hs("dialing %s",e),t=t??{};const n=await this._connect(e,t),s=Vce(n,e);hs("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s);return hs("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){if(t?.signal?.aborted===!0)throw new x3;const n=e.toOptions();hs("dialing %s:%s",n.host,n.port);const s=We(),i=h=>{hs.error("connection error:",h),s.reject(h)},o=xce(E2(e),this.init);if(o.socket.on!=null?o.socket.on("error",i):o.socket.onerror=i,t.signal==null)return await Promise.race([o.connected(),s.promise]),hs("connected %s",e),o;let a;const c=new Promise((h,l)=>{if(a=()=>{l(new x3),o.close().catch(u=>{hs.error("error closing raw socket",u)})},t?.signal?.aborted===!0)return a();t?.signal?.addEventListener("abort",a)});try{await Promise.race([c,s.promise,o.connected()])}finally{a!=null&&t?.signal?.removeEventListener("abort",a)}return hs("connected %s",e),o}createListener(e){return $ce({...this.init,...e})}filter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):qa||Rp?jce(e):Kce(e)}}function qce(r={}){return()=>new Hce(r)}function Aw(r,e={}){const t=kd(r),n=er.fromReader(t.reader,e),s={read:async i=>{const{value:o}=await t.reader.next(i);if(o==null)throw new Error("Value is null");return o},readLP:async()=>{const{value:i}=await n.next();if(i==null)throw new Error("Value is null");return i},readPB:async i=>{const o=await s.readLP();if(o==null)throw new Error("Value is null");const a=o instanceof Uint8Array?o:o.subarray();return i.decode(a)},write:i=>{i instanceof Uint8Array?t.writer.push(i):t.writer.push(i.subarray())},writeLP:i=>{s.write(ar.single(i,e))},writePB:(i,o)=>{s.writeLP(o.encode(i))},pb:i=>({read:async()=>await s.readPB(i),write:o=>s.writePB(o,i)}),unwrap:()=>(t.rest(),t.stream)};return s}function Iw(){const r=We();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function Gce(){const r=Iw(),e=Iw();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}const fc=65535,Cw=fc-16,Wce=Boolean(globalThis.process?.env?.DUMP_SESSION_KEYS);var M_={},Uc={},wg={};Object.defineProperty(wg,"__esModule",{value:!0});function Yce(r){return typeof r.saveState<"u"&&typeof r.restoreState<"u"&&typeof r.cleanSavedState<"u"}wg.isSerializableHash=Yce;Object.defineProperty(Uc,"__esModule",{value:!0});var Gr=wg,Qce=Lv,Xce=sm,U_=function(){function r(e,t){this._finished=!1,this._inner=new e,this._outer=new e,this.blockSize=this._outer.blockSize,this.digestLength=this._outer.digestLength;var n=new Uint8Array(this.blockSize);t.length>this.blockSize?this._inner.update(t).finish(n).clean():n.set(t);for(var s=0;s<n.length;s++)n[s]^=54;this._inner.update(n);for(var s=0;s<n.length;s++)n[s]^=106;this._outer.update(n),Gr.isSerializableHash(this._inner)&&Gr.isSerializableHash(this._outer)&&(this._innerKeyedState=this._inner.saveState(),this._outerKeyedState=this._outer.saveState()),Xce.wipe(n)}return r.prototype.reset=function(){if(!Gr.isSerializableHash(this._inner)||!Gr.isSerializableHash(this._outer))throw new Error("hmac: can't reset() because hash doesn't implement restoreState()");return this._inner.restoreState(this._innerKeyedState),this._outer.restoreState(this._outerKeyedState),this._finished=!1,this},r.prototype.clean=function(){Gr.isSerializableHash(this._inner)&&this._inner.cleanSavedState(this._innerKeyedState),Gr.isSerializableHash(this._outer)&&this._outer.cleanSavedState(this._outerKeyedState),this._inner.clean(),this._outer.clean()},r.prototype.update=function(e){return this._inner.update(e),this},r.prototype.finish=function(e){return this._finished?(this._outer.finish(e),this):(this._inner.finish(e),this._outer.update(e.subarray(0,this.digestLength)).finish(e),this._finished=!0,this)},r.prototype.digest=function(){var e=new Uint8Array(this.digestLength);return this.finish(e),e},r.prototype.saveState=function(){if(!Gr.isSerializableHash(this._inner))throw new Error("hmac: can't saveState() because hash doesn't implement it");return this._inner.saveState()},r.prototype.restoreState=function(e){if(!Gr.isSerializableHash(this._inner)||!Gr.isSerializableHash(this._outer))throw new Error("hmac: can't restoreState() because hash doesn't implement it");return this._inner.restoreState(e),this._outer.restoreState(this._outerKeyedState),this._finished=!1,this},r.prototype.cleanSavedState=function(e){if(!Gr.isSerializableHash(this._inner))throw new Error("hmac: can't cleanSavedState() because hash doesn't implement it");this._inner.cleanSavedState(e)},r}();Uc.HMAC=U_;function Jce(r,e,t){var n=new U_(r,e);n.update(t);var s=n.digest();return n.clean(),s}Uc.hmac=Jce;Uc.equal=Qce.equal;Object.defineProperty(M_,"__esModule",{value:!0});var Tw=Uc,kw=sm,Zce=function(){function r(e,t,n,s){n===void 0&&(n=new Uint8Array(0)),this._counter=new Uint8Array(1),this._hash=e,this._info=s;var i=Tw.hmac(this._hash,n,t);this._hmac=new Tw.HMAC(e,i),this._buffer=new Uint8Array(this._hmac.digestLength),this._bufpos=this._buffer.length}return r.prototype._fillBuffer=function(){this._counter[0]++;var e=this._counter[0];if(e===0)throw new Error("hkdf: cannot expand more");this._hmac.reset(),e>1&&this._hmac.update(this._buffer),this._info&&this._hmac.update(this._info),this._hmac.update(this._counter),this._hmac.finish(this._buffer),this._bufpos=0},r.prototype.expand=function(e){for(var t=new Uint8Array(e),n=0;n<t.length;n++)this._bufpos===this._buffer.length&&this._fillBuffer(),t[n]=this._buffer[this._bufpos++];return t},r.prototype.clean=function(){this._hmac.clean(),kw.wipe(this._buffer),kw.wipe(this._counter),this._bufpos=0},r}(),ele=M_.HKDF=Zce;const tle={hashSHA256(r){return Ag.hash(r)},getHKDF(r,e){const s=new ele(Ag.SHA256,e,r).expand(96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const r=Bd.generateKeyPair();return{publicKey:r.publicKey,privateKey:r.secretKey}},generateX25519KeyPairFromSeed(r){const e=Bd.generateKeyPairFromSeed(r);return{publicKey:e.publicKey,privateKey:e.secretKey}},generateX25519SharedKey(r,e){return Bd.sharedKey(r,e)},chaCha20Poly1305Encrypt(r,e,t,n){return new rh.ChaCha20Poly1305(n).seal(e,r,t)},chaCha20Poly1305Decrypt(r,e,t,n,s){return new rh.ChaCha20Poly1305(n).open(e,r,t,s)}},rle=r=>globalThis.Buffer?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r),Bu=r=>{const e=rle(2);return new DataView(e.buffer,e.byteOffset,e.byteLength).setUint16(0,r,!1),e};Bu.bytes=2;const Zl=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");return r instanceof Uint8Array?new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,!1):r.getUint16(0)};Zl.bytes=2;function nle(r){return qe([r.ne,r.ciphertext],r.ne.length+r.ciphertext.length)}function sle(r){return qe([r.ne,r.ns,r.ciphertext],r.ne.length+r.ns.length+r.ciphertext.length)}function ile(r){return qe([r.ns,r.ciphertext],r.ns.length+r.ciphertext.length)}function ole(r){if(r.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:r.subarray(0,32),ciphertext:r.subarray(32,r.length),ns:new Uint8Array(0)}}function ale(r){if(r.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:r.subarray(0,32),ns:r.subarray(32,80),ciphertext:r.subarray(80,r.length)}}function cle(r){if(r.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:r.subarray(0,48),ciphertext:r.subarray(48,r.length)}}function lle(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=Cw){let i=s+Cw;i>n.length&&(i=n.length);const o=r.encrypt(n.subarray(s,i),r.session);e?.encryptedPackets.increment(),yield Bu(o.byteLength),yield o}}}function hle(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=fc){let i=s+fc;if(i>n.length&&(i=n.length),i-rh.TAG_LENGTH<s)throw new Error("Invalid chunk");const o=n.subarray(s,i),a=n.subarray(s,i-rh.TAG_LENGTH),{plaintext:c,valid:h}=r.decrypt(o,r.session,a);if(!h)throw e?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");e?.decryptedPackets.increment(),yield c}}}class zu extends Error{constructor(e="Unexpected Peer"){super(e),this.code=zu.code}static get code(){return"ERR_UNEXPECTED_PEER"}}class ro extends Error{constructor(e="Invalid crypto exchange"){super(e),this.code=ro.code}static get code(){return"ERR_INVALID_CRYPTO_EXCHANGE"}}var Fu;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={webtransportCerthashes:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.webtransportCerthashes.push(t.bytes());break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(Fu||(Fu={}));var Vu;(function(r){let e;r.codec=()=>(e==null&&(e=Qe((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.identityKey!=null&&t.identityKey.byteLength>0)&&(n.uint32(10),n.bytes(t.identityKey)),(s.writeDefaults===!0||t.identitySig!=null&&t.identitySig.byteLength>0)&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),Fu.codec().encode(t.extensions,n,{writeDefaults:!1})),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.identityKey=t.bytes();break;case 2:s.identitySig=t.bytes();break;case 4:s.extensions=Fu.codec().decode(t,t.uint32());break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xe(t,r.codec()),r.decode=t=>Je(t,r.codec())})(Vu||(Vu={}));async function ule(r,e,t){const n=await fle(r,B_(e));if(r.publicKey==null)throw new Error("PublicKey was missing from local PeerId");return dle(r.publicKey,n,t)}function dle(r,e,t){return Vu.encode({identityKey:r,identitySig:e,extensions:t??{webtransportCerthashes:[]}}).subarray()}async function fle(r,e){if(r.privateKey==null)throw new Error("PrivateKey was missing from PeerId");return await(await Qs(r.privateKey)).sign(e)}async function Dw(r){return await Ir(r.identityKey)}function Pw(r){return Vu.decode(r)}function B_(r){const e=L("noise-libp2p-static-key:");return qe([e,r],e.length+r.length)}async function Ow(r,e,t){const n=await Ir(e.identityKey);if(!n.equals(t))throw new Error("Peer ID doesn't match libp2p public key.");const s=B_(r);if(n.publicKey==null)throw new Error("PublicKey was missing from PeerId");if(e.identitySig==null)throw new Error("Signature was missing from message");if(!await mi(n.publicKey).verify(s,e.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return n}function kl(r){return!(!(r instanceof Uint8Array)||r.length!==32)}const $t=P("libp2p:noise");let vr;Wce?vr=$t:vr=Object.assign(()=>{},{enabled:!1,trace:()=>{},error:()=>{}});function ple(r){vr(`LOCAL_STATIC_PUBLIC_KEY ${B(r.publicKey,"hex")}`),vr(`LOCAL_STATIC_PRIVATE_KEY ${B(r.privateKey,"hex")}`)}function Nw(r){r?(vr(`LOCAL_PUBLIC_EPHEMERAL_KEY ${B(r.publicKey,"hex")}`),vr(`LOCAL_PRIVATE_EPHEMERAL_KEY ${B(r.privateKey,"hex")}`)):vr("Missing local ephemeral keys.")}function gle(r){vr(`REMOTE_STATIC_PUBLIC_KEY ${B(r,"hex")}`)}function xw(r){vr(`REMOTE_EPHEMERAL_PUBLIC_KEY ${B(r,"hex")}`)}function yle(r){r.cs1&&r.cs2?(vr(`CIPHER_STATE_1 ${r.cs1.n.getUint64()} ${B(r.cs1.k,"hex")}`),vr(`CIPHER_STATE_2 ${r.cs2.n.getUint64()} ${B(r.cs2.k,"hex")}`)):vr("Missing cipher state.")}const wle=0,mle=4294967295,ble="Cipherstate has reached maximum n, a new handshake must be performed";class Ele{constructor(e=wle){this.n=e,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>mle)throw new Error(ble)}}class _le{constructor(e){this.crypto=e}encryptWithAd(e,t,n){const s=this.encrypt(e.k,e.n,t,n);return e.n.increment(),s}decryptWithAd(e,t,n,s){const{plaintext:i,valid:o}=this.decrypt(e.k,e.n,t,n,s);return o&&e.n.increment(),{plaintext:i,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return new Uint8Array(32)}isEmptyKey(e){const t=this.createEmptyKey();return Ye(t,e)}encrypt(e,t,n,s){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(s,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return this.hasKey(e.cs)?n=this.encryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,n),n}decrypt(e,t,n,s,i){t.assertValue();const o=this.crypto.chaCha20Poly1305Decrypt(s,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}decryptAndHash(e,t){let n,s=!0;return this.hasKey(e.cs)?{plaintext:n,valid:s}=this.decryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,t),{plaintext:n,valid:s}}dh(e,t){try{const n=this.crypto.generateX25519SharedKey(e,t);return n.length===32?n:n.subarray(0,32)}catch(n){return $t(n.message),new Uint8Array(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256(qe([e,t],e.length+t.length))}mixKey(e,t){const[n,s]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(s),e.ck=n}initializeKey(e){return{k:e,n:new Ele}}initializeSymmetric(e){const t=L(e,"utf-8"),n=this.hashProtocolName(t),s=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:s,h:n}}hashProtocolName(e){if(e.length<=32){const t=new Uint8Array(32);return t.set(e),t}else return this.getHash(e,new Uint8Array(0))}split(e){const[t,n]=this.crypto.getHKDF(e.ck,new Uint8Array(0)),s=this.initializeKey(t),i=this.initializeKey(n);return{cs1:s,cs2:i}}writeMessageRegular(e,t){const n=this.encryptWithAd(e,new Uint8Array(0),t),s=this.createEmptyKey(),i=new Uint8Array(0);return{ne:s,ns:i,ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}}class vle extends _le{initializeInitiator(e,t,n,s){const i="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(i);this.mixHash(o,e);const a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:s,re:a}}initializeResponder(e,t,n,s){const i="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(i);this.mixHash(o,e);const a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:s,re:a}}writeMessageA(e,t,n){const s=new Uint8Array(0);n!==void 0?e.e=n:e.e=this.crypto.generateX25519KeyPair();const i=e.e.publicKey;this.mixHash(e.ss,i);const o=this.encryptAndHash(e.ss,t);return{ne:i,ns:s,ciphertext:o}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();const n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const s=e.s.publicKey,i=this.encryptAndHash(e.ss,s);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const o=this.encryptAndHash(e.ss,t);return{ne:n,ns:i,ciphertext:o}}writeMessageC(e,t){const n=e.s.publicKey,s=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const i=this.encryptAndHash(e.ss,t),a={ne:this.createEmptyKey(),ns:s,ciphertext:i},{cs1:c,cs2:h}=this.split(e.ss);return{h:e.ss.h,messageBuffer:a,cs1:c,cs2:h}}readMessageA(e,t){return kl(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(kl(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);s&&kl(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:i,valid:s&&o}}readMessageC(e,t){const{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);if(s&&kl(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:a,cs2:c}=this.split(e.ss);return{h:e.ss.h,plaintext:i,valid:s&&o,cs1:a,cs2:c}}initSession(e,t,n){const s=this.createEmptyKey(),i=new Uint8Array(32);let o;return e?o=this.initializeInitiator(t,n,i,s):o=this.initializeResponder(t,n,i,s),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let s;if(e.mc===0)s=this.writeMessageA(e.hs,t,n);else if(e.mc===1)s=this.writeMessageB(e.hs,t);else if(e.mc===2){const{h:i,messageBuffer:o,cs1:a,cs2:c}=this.writeMessageC(e.hs,t);s=o,e.h=i,e.cs1=a,e.cs2=c}else if(e.mc>2)if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");s=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");s=this.writeMessageRegular(e.cs2,t)}else throw new Error("Session invalid.");return e.mc++,s}recvMessage(e,t){let n=new Uint8Array(0),s=!1;if(e.mc===0)({plaintext:n,valid:s}=this.readMessageA(e.hs,t));else if(e.mc===1)({plaintext:n,valid:s}=this.readMessageB(e.hs,t));else if(e.mc===2){const{h:i,plaintext:o,valid:a,cs1:c,cs2:h}=this.readMessageC(e.hs,t);n=o,s=a,e.h=i,e.cs1=c,e.cs2=h}return e.mc++,{plaintext:n,valid:s}}}class Sle{constructor(e,t,n,s,i,o,a,c){this.remoteExtensions={webtransportCerthashes:[]},this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=i,this.connection=o,a&&(this.remotePeer=a),this.xx=c??new vle(s),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){if(ple(this.session.hs.s),this.isInitiator){$t("Stage 0 - Initiator starting to send first message.");const e=this.xx.sendMessage(this.session,new Uint8Array(0));this.connection.writeLP(nle(e)),$t("Stage 0 - Initiator finished sending first message."),Nw(this.session.hs.e)}else{$t("Stage 0 - Responder waiting to receive first message...");const e=ole((await this.connection.readLP()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new ro("xx handshake stage 0 validation fail");$t("Stage 0 - Responder received first message."),xw(this.session.hs.re)}}async exchange(){if(this.isInitiator){$t("Stage 1 - Initiator waiting to receive first message from responder...");const e=ale((await this.connection.readLP()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new ro("xx handshake stage 1 validation fail");$t("Stage 1 - Initiator received the message."),xw(this.session.hs.re),gle(this.session.hs.rs),$t("Initiator going to check remote's signature...");try{const s=Pw(t);this.remotePeer=this.remotePeer||await Dw(s),await Ow(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){const i=s;throw new zu(`Error occurred while verifying signed payload: ${i.message}`)}$t("All good with the signature!")}else{$t("Stage 1 - Responder sending out first message with signed payload and static key.");const e=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(sle(e)),$t("Stage 1 - Responder sent the second handshake message with signed payload."),Nw(this.session.hs.e)}}async finish(){if(this.isInitiator){$t("Stage 2 - Initiator sending third handshake message.");const e=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(ile(e)),$t("Stage 2 - Initiator sent message with signed payload.")}else{$t("Stage 2 - Responder waiting for third handshake message...");const e=cle((await this.connection.readLP()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new ro("xx handshake stage 2 validation fail");$t("Stage 2 - Responder received the message, finished handshake.");try{const s=Pw(t);this.remotePeer=this.remotePeer||await Dw(s),await Ow(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){const i=s;throw new zu(`Error occurred while verifying signed payload: ${i.message}`)}}yle(this.session)}encrypt(e,t){const n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}decrypt(e,t,n){const s=this.getCS(t,!1);return this.xx.decryptWithAd(s,new Uint8Array(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e,t=!0){if(!e.cs1||!e.cs2)throw new ro("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}}function Rle(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}class Ale{constructor(e={}){this.protocol="/noise";const{staticNoiseKey:t,extensions:n,crypto:s,prologueBytes:i,metrics:o}=e;this.crypto=s??tle,this.extensions=n,this.metrics=o?Rle(o):void 0,t?this.staticKeys=this.crypto.generateX25519KeyPairFromSeed(t):this.staticKeys=this.crypto.generateX25519KeyPair(),this.prologue=i??new Uint8Array(0)}async secureOutbound(e,t,n){const s=Aw(t,{lengthEncoder:Bu,lengthDecoder:Zl,maxDataLength:fc}),i=await this.performHandshake({connection:s,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,i),remoteExtensions:i.remoteExtensions,remotePeer:i.remotePeer}}async secureInbound(e,t,n){const s=Aw(t,{lengthEncoder:Bu,lengthDecoder:Zl,maxDataLength:fc}),i=await this.performHandshake({connection:s,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,i),remotePeer:i.remotePeer,remoteExtensions:i.remoteExtensions}}async performHandshake(e){const t=await ule(e.localPeer,this.staticKeys.publicKey,this.extensions);return await this.performXXHandshake(e,t)}async performXXHandshake(e,t){const{isInitiator:n,remotePeer:s,connection:i}=e,o=new Sle(n,t,this.prologue,this.crypto,this.staticKeys,i,s);try{await o.propose(),await o.exchange(),await o.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){if(this.metrics?.xxHandshakeErrors.increment(),a instanceof Error)throw a.message=`Error occurred during XX handshake: ${a.message}`,a}return o}async createSecureConnection(e,t){const[n,s]=Gce(),i=e.unwrap();return await ie(n,lle(t,this.metrics),i,er({lengthDecoder:Zl}),hle(t,this.metrics),n),s}}function z_(r={}){return()=>new Ale(r)}const Ile=Ue.bind({ignoreUndefined:!0,concatArrays:!0});function mg({options:r={},peerId:e,multiaddrs:t=[],repo:n,keychainConfig:s={},config:i={}}){const{datastore:o}=n,a=Cle({options:r,config:i,datastore:o,keychainConfig:s,peerId:e,multiaddrs:t});return typeof r.libp2p=="function"?r.libp2p({libp2pOptions:a,options:r,config:i,datastore:o,peerId:e}):(a.start=!1,aoe(a))}function Cle({options:r,config:e,datastore:t,keychainConfig:n,peerId:s,multiaddrs:i}){const o=()=>{const g=le(e,"Pubsub.Router")||"gossipsub",d=wY();if(!d[g])throw v(new Error(`Router unavailable. Configure libp2p.modules.pubsub to use the ${g} router.`),"ERR_NOT_SUPPORTED");return d[g]},a={datastore:t,peerId:s},c={addresses:{listen:i.map(g=>g.toString()),announce:le(r,"addresses.announce",le(e,"Addresses.Announce",[])),noAnnounce:le(r,"addresses.noAnnounce",le(e,"Addresses.NoAnnounce",[]))},connectionManager:le(r,"connectionManager",{maxConnections:le(r,"config.Swarm.ConnMgr.HighWater",le(e,"Swarm.ConnMgr.HighWater")),minConnections:le(r,"config.Swarm.ConnMgr.LowWater",le(e,"Swarm.ConnMgr.LowWater"))}),keychain:n,identify:{host:{agentVersion:`js-ipfs/${Fh}`}},contentRouters:[],peerRouters:[],peerDiscovery:[],transports:[],streamMuxers:[ym({maxInboundStreams:256,maxOutboundStreams:1024})],connectionEncryption:[z_()],relay:{enabled:le(r,"relay.enabled",le(e,"relay.enabled",!0)),hop:{enabled:le(r,"relay.hop.enabled",le(e,"relay.hop.enabled",!1)),active:le(r,"relay.hop.active",le(e,"relay.hop.active",!1))}},nat:{enabled:!le(e,"Swarm.DisableNatPortMap",!1)}};le(r,"config.Pubsub.Enabled",le(e,"Pubsub.Enabled",!0))&&(c.pubsub=o()),le(e,"Routing.Type","dhtclient")!=="none"&&(c.dht=wce({clientMode:le(e,"Routing.Type","dht")!=="dhtserver",kBucketSize:le(r,"dht.kBucketSize",20),validators:{ipns:Qp},selectors:{ipns:K8}}));const h=le(r,"config.Bootstrap",le(e,"Bootstrap",[]));h.length>0&&c.peerDiscovery?.push(vce({list:h}));let l=le(r,"libp2p",void 0);typeof l=="function"&&(l=void 0);const u=Ile(a,gre(),c,l),f=le(r,"config.Addresses.Delegates",le(e,"Addresses.Delegates",[]));if(f.length>0){const g=f[Math.floor(Math.random()*f.length)],d=G(g).toOptions(),p={host:d.host,protocol:parseInt(d.port)===443?"https":"http",port:d.port},w=Zee(p);u.contentRouters?.push(oQ(w)),u.peerRouters?.push(rQ(w))}return le(r,"config.Discovery.MDNS.Enabled",le(e,"Discovery.MDNS.Enabled",!0))||(u.peerDiscovery=u.peerDiscovery?.filter(g=>{try{if(typeof g=="function")return g({})[Symbol.toStringTag]!=="@libp2p/mdns"}catch{}return!0})),u.transports==null&&(u.transports=[]),u.transports.find(g=>{try{if(typeof g=="function")return g({})[Symbol.toStringTag]==="@libp2p/websockets"}catch{}return!1})==null&&u.transports.push(qce()),u}const F_=Ue.bind({ignoreUndefined:!0}),ja=P("ipfs:components:peer:storage");class bg{constructor(e,t,n,s,i){this.print=s,this.peerId=e,this.keychain=t,this.repo=n,this.print=s,this.isNew=i}static async start(e,t,n){const{repoAutoMigrate:s,repo:i,onMigrationProgress:o}=n,a=typeof i=="string"||i==null?nG(e,t,{path:i,autoMigrate:s,onMigrationProgress:o}):i,{peerId:c,keychain:h,isNew:l}=await Tle(e,a,n);return new bg(c,h,a,e,l)}}const Tle=async(r,e,t)=>{if(!e.closed)return{...await $w(e,t),isNew:!1};try{return await e.open(),{...await $w(e,t),isNew:!1}}catch(n){if(n.code!==Ca)throw n;if(t.init&&t.init.allowNew===!1)throw new Po("Initialization of new repos disabled by config, pass `config.init.isNew: true` to enable it");return{...await kle(r,e,t),isNew:!0}}},kle=async(r,e,t)=>{const n=t.init||{},s=await e.exists();if(ja("repo exists?",s),s===!0)throw new Error("repo already exists");const i=n.privateKey?await Dle(n.privateKey):await Ple(r,n),o=Ole(i);ja("peer identity: %s",o.PeerID);const a={...F_(V_(oo(),n.profiles),t.config),Identity:o};await e.init(a),await e.open(),ja("repo opened");const c={pass:t.pass};try{c.dek=await e.config.get("Keychain.DEK")}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}const h=await mg({options:void 0,multiaddrs:void 0,peerId:i,repo:e,config:a,keychainConfig:c});return await e.datastore.has(new X("/info/self"))||await h.keychain.importPeer("self",i),await e.config.set("Keychain",{DEK:h.keychain.init.dek}),{peerId:i,keychain:h.keychain}},Dle=async r=>{if(ja("using user-supplied private-key"),Mn(r))return r;const e=L(r,"base64pad"),t=await Qs(e);return await Ir(t.public.bytes,t.bytes)},Ple=(r,{algorithm:e="Ed25519",bits:t=2048})=>{if(r("generating %s keypair...",e),e==="Ed25519")return g_();if(e==="RSA")return Wie({bits:t});throw v(new Error("Unknown PeerId algorithm"),"ERR_UNKNOWN_PEER_ID_ALGORITHM")},Ole=r=>{if(r.privateKey==null)throw v(new Error("Private key missing"),"ERR_MISSING_PRIVATE_KEY");return{PeerID:r.toString(),PrivKey:B(r.privateKey,"base64pad")}},$w=async(r,e)=>{const t=e.config,n=e.init&&e.init.profiles||[],s=e.pass,i=await r.config.getAll(),o=Nle(V_(i,n),t);if(i!==o&&await r.config.replace(o),!o.Identity||!o.Identity.PrivKey)throw new yc("No private key was found in the config, please intialize the repo");const a=L(o.Identity.PrivKey,"base64pad"),c=await Qs(a),h=await Ir(c.public.bytes,c.bytes),l=await mg({options:void 0,multiaddrs:void 0,peerId:h,repo:r,config:o,keychainConfig:{pass:s,...o.Keychain}});return{peerId:h,keychain:l.keychain}},Nle=(r,e)=>e?F_(r,e):r,V_=(r,e)=>(e||[]).reduce((t,n)=>{const s=Vh[n];if(!s)throw new Error(`Could not find profile with name '${n}'`);return ja("applying profile %s",n),s.transform(t)},r);var xle=K_,Lw=128,$le=127,Lle=~$le,Mle=Math.pow(2,31);function K_(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Mle;)e[t++]=r&255|Lw,r/=128;for(;r&Lle;)e[t++]=r&255|Lw,r>>>=7;return e[t]=r|0,K_.bytes=t-n+1,e}var Ule=fp,Ble=128,Mw=127;function fp(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw fp.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Mw)<<s:(o&Mw)*Math.pow(2,s),s+=7}while(o>=Ble);return fp.bytes=i-n,t}var zle=Math.pow(2,7),Fle=Math.pow(2,14),Vle=Math.pow(2,21),Kle=Math.pow(2,28),jle=Math.pow(2,35),Hle=Math.pow(2,42),qle=Math.pow(2,49),Gle=Math.pow(2,56),Wle=Math.pow(2,63),Yle=function(r){return r<zle?1:r<Fle?2:r<Vle?3:r<Kle?4:r<jle?5:r<Hle?6:r<qle?7:r<Gle?8:r<Wle?9:10},Qle={encode:xle,decode:Ule,encodingLength:Yle},Ku=Qle;const pp=(r,e=0)=>[Ku.decode(r,e),Ku.decode.bytes],ju=(r,e,t=0)=>(Ku.encode(r,e,t),e),Hu=r=>Ku.encodingLength(r),Xle=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Eg=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},gp=(r,e)=>{const t=e.byteLength,n=Hu(r),s=n+Hu(t),i=new Uint8Array(s+t);return ju(r,i,0),ju(t,i,n),i.set(e,s),new _g(r,t,e,i)},Jle=r=>{const e=Eg(r),[t,n]=pp(e),[s,i]=pp(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new _g(t,s,o,e)},Zle=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Xle(r.bytes,t.bytes)}};class _g{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}function ehe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var the=ehe,rhe=the;let nhe=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},she=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return j_(this,e)}},ihe=class{constructor(e){this.decoders=e}or(e){return j_(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const j_=(r,e)=>new ihe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let ohe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new nhe(e,t,n),this.decoder=new she(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const H_=({name:r,prefix:e,encode:t,decode:n})=>new ohe(r,e,t,n),q_=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=rhe(t,e);return H_({prefix:r,name:e,encode:n,decode:i=>Eg(s(i))})},ahe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},che=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},rs=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>H_({prefix:e,name:r,encode(s){return che(s,n,t)},decode(s){return ahe(s,n,t,r)}}),Le=q_({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});q_({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const eh=rs({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});rs({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});rs({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});rs({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});rs({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});rs({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});rs({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});rs({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});rs({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Uw=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return hhe(t,yp(r),e||Le.encoder);default:return uhe(t,yp(r),e||eh.encoder)}},Bw=new WeakMap,yp=r=>{const e=Bw.get(r);if(e==null){const t=new Map;return Bw.set(r,t),t}return e};class Ie{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ea)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==dhe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ie.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=gp(e,t);return Ie.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ie.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Zle(e.multihash,n.multihash)}toString(e){return Uw(this,e)}toJSON(){return{"/":Uw(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ie)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Ie(n,s,i,o||zw(n,s,i.bytes))}else if(t[fhe]===!0){const{version:n,multihash:s,code:i}=t,o=Jle(s);return Ie.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ea)throw new Error(`Version 0 CID must use dag-pb (code: ${Ea}) block encoding`);return new Ie(e,t,n,n.bytes)}case 1:{const s=zw(e,t,n.bytes);return new Ie(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Ie.create(0,Ea,e)}static createV1(e,t){return Ie.create(1,e,t)}static decode(e){const[t,n]=Ie.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ie.inspectBytes(e),n=t.size-t.multihashSize,s=Eg(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new _g(t.multihashCode,t.digestSize,i,s);return[t.version===0?Ie.createV0(o):Ie.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[u,f]=pp(e.subarray(t));return t+=f,u};let s=n(),i=Ea;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),h=t+c,l=h-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:h}}static parse(e,t){const[n,s]=lhe(e,t),i=Ie.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return yp(i).set(n,e),i}}const lhe=(r,e)=>{switch(r[0]){case"Q":{const t=e||Le;return[Le.prefix,t.decode(`${Le.prefix}${r}`)]}case Le.prefix:{const t=e||Le;return[Le.prefix,t.decode(r)]}case eh.prefix:{const t=e||eh;return[eh.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},hhe=(r,e,t)=>{const{prefix:n}=t;if(n!==Le.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},uhe=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Ea=112,dhe=18,zw=(r,e,t)=>{const n=Hu(r),s=n+Hu(e),i=new Uint8Array(s+t.byteLength);return ju(r,i,0),ju(e,i,n),i.set(t,s),i},fhe=Symbol.for("@ipld/js-cid/CID"),G_=({name:r,code:e,encode:t})=>new phe(r,e,t);class phe{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?gp(this.code,t):t.then(n=>gp(this.code,n))}else throw Error("Unknown type, must be binary type")}}const W_=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),s1=G_({name:"sha2-256",code:18,encode:W_("SHA-256")});G_({name:"sha2-512",code:19,encode:W_("SHA-512")});var ghe=Y_,Fw=128,yhe=127,whe=~yhe,mhe=Math.pow(2,31);function Y_(r,e,t){e=e||[],t=t||0;for(var n=t;r>=mhe;)e[t++]=r&255|Fw,r/=128;for(;r&whe;)e[t++]=r&255|Fw,r>>>=7;return e[t]=r|0,Y_.bytes=t-n+1,e}var bhe=wp,Ehe=128,Vw=127;function wp(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw wp.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Vw)<<s:(o&Vw)*Math.pow(2,s),s+=7}while(o>=Ehe);return wp.bytes=i-n,t}var _he=Math.pow(2,7),vhe=Math.pow(2,14),She=Math.pow(2,21),Rhe=Math.pow(2,28),Ahe=Math.pow(2,35),Ihe=Math.pow(2,42),Che=Math.pow(2,49),The=Math.pow(2,56),khe=Math.pow(2,63),Dhe=function(r){return r<_he?1:r<vhe?2:r<She?3:r<Rhe?4:r<Ahe?5:r<Ihe?6:r<Che?7:r<The?8:r<khe?9:10},Phe={encode:ghe,decode:bhe,encodingLength:Dhe};const Kw=Phe;var Ohe=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=Kw.decode(r);e.push(t),r=r.slice(Kw.decode.bytes)}return e};function Nhe(r){let e=new Uint8Array(r.reduce((n,s)=>n+je.encodingLength(s),0)),t=0;for(const n of r)e=je.encode(n,e,t),t+=je.encodingLength(n);return e}class Q_{constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t||1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(Le)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}}const Wr=j.Reader,_a=j.Writer,fe=j.util,ce=j.roots["ipfs-bitswap"]||(j.roots["ipfs-bitswap"]={}),Lr=ce.Message=(()=>{function r(e){if(this.blocks=[],this.payload=[],this.blockPresences=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.wantlist=null,r.prototype.blocks=fe.emptyArray,r.prototype.payload=fe.emptyArray,r.prototype.blockPresences=fe.emptyArray,r.prototype.pendingBytes=0,r.encode=function(t,n){if(n||(n=_a.create()),t.wantlist!=null&&Object.hasOwnProperty.call(t,"wantlist")&&ce.Message.Wantlist.encode(t.wantlist,n.uint32(10).fork()).ldelim(),t.blocks!=null&&t.blocks.length)for(var s=0;s<t.blocks.length;++s)n.uint32(18).bytes(t.blocks[s]);if(t.payload!=null&&t.payload.length)for(var s=0;s<t.payload.length;++s)ce.Message.Block.encode(t.payload[s],n.uint32(26).fork()).ldelim();if(t.blockPresences!=null&&t.blockPresences.length)for(var s=0;s<t.blockPresences.length;++s)ce.Message.BlockPresence.encode(t.blockPresences[s],n.uint32(34).fork()).ldelim();return t.pendingBytes!=null&&Object.hasOwnProperty.call(t,"pendingBytes")&&n.uint32(40).int32(t.pendingBytes),n},r.decode=function(t,n){t instanceof Wr||(t=Wr.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new ce.Message;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:{i.wantlist=ce.Message.Wantlist.decode(t,t.uint32());break}case 2:{i.blocks&&i.blocks.length||(i.blocks=[]),i.blocks.push(t.bytes());break}case 3:{i.payload&&i.payload.length||(i.payload=[]),i.payload.push(ce.Message.Block.decode(t,t.uint32()));break}case 4:{i.blockPresences&&i.blockPresences.length||(i.blockPresences=[]),i.blockPresences.push(ce.Message.BlockPresence.decode(t,t.uint32()));break}case 5:{i.pendingBytes=t.int32();break}default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof ce.Message)return t;var n=new ce.Message;if(t.wantlist!=null){if(typeof t.wantlist!="object")throw TypeError(".Message.wantlist: object expected");n.wantlist=ce.Message.Wantlist.fromObject(t.wantlist)}if(t.blocks){if(!Array.isArray(t.blocks))throw TypeError(".Message.blocks: array expected");n.blocks=[];for(var s=0;s<t.blocks.length;++s)typeof t.blocks[s]=="string"?fe.base64.decode(t.blocks[s],n.blocks[s]=fe.newBuffer(fe.base64.length(t.blocks[s])),0):t.blocks[s].length>=0&&(n.blocks[s]=t.blocks[s])}if(t.payload){if(!Array.isArray(t.payload))throw TypeError(".Message.payload: array expected");n.payload=[];for(var s=0;s<t.payload.length;++s){if(typeof t.payload[s]!="object")throw TypeError(".Message.payload: object expected");n.payload[s]=ce.Message.Block.fromObject(t.payload[s])}}if(t.blockPresences){if(!Array.isArray(t.blockPresences))throw TypeError(".Message.blockPresences: array expected");n.blockPresences=[];for(var s=0;s<t.blockPresences.length;++s){if(typeof t.blockPresences[s]!="object")throw TypeError(".Message.blockPresences: object expected");n.blockPresences[s]=ce.Message.BlockPresence.fromObject(t.blockPresences[s])}}return t.pendingBytes!=null&&(n.pendingBytes=t.pendingBytes|0),n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.blocks=[],s.payload=[],s.blockPresences=[]),n.defaults&&(s.wantlist=null,s.pendingBytes=0),t.wantlist!=null&&t.hasOwnProperty("wantlist")&&(s.wantlist=ce.Message.Wantlist.toObject(t.wantlist,n)),t.blocks&&t.blocks.length){s.blocks=[];for(var i=0;i<t.blocks.length;++i)s.blocks[i]=n.bytes===String?fe.base64.encode(t.blocks[i],0,t.blocks[i].length):n.bytes===Array?Array.prototype.slice.call(t.blocks[i]):t.blocks[i]}if(t.payload&&t.payload.length){s.payload=[];for(var i=0;i<t.payload.length;++i)s.payload[i]=ce.Message.Block.toObject(t.payload[i],n)}if(t.blockPresences&&t.blockPresences.length){s.blockPresences=[];for(var i=0;i<t.blockPresences.length;++i)s.blockPresences[i]=ce.Message.BlockPresence.toObject(t.blockPresences[i],n)}return t.pendingBytes!=null&&t.hasOwnProperty("pendingBytes")&&(s.pendingBytes=t.pendingBytes),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.getTypeUrl=function(t){return t===void 0&&(t="type.googleapis.com"),t+"/Message"},r.Wantlist=function(){function e(t){if(this.entries=[],t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.entries=fe.emptyArray,e.prototype.full=!1,e.encode=function(n,s){if(s||(s=_a.create()),n.entries!=null&&n.entries.length)for(var i=0;i<n.entries.length;++i)ce.Message.Wantlist.Entry.encode(n.entries[i],s.uint32(10).fork()).ldelim();return n.full!=null&&Object.hasOwnProperty.call(n,"full")&&s.uint32(16).bool(n.full),s},e.decode=function(n,s){n instanceof Wr||(n=Wr.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new ce.Message.Wantlist;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.entries&&o.entries.length||(o.entries=[]),o.entries.push(ce.Message.Wantlist.Entry.decode(n,n.uint32()));break}case 2:{o.full=n.bool();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof ce.Message.Wantlist)return n;var s=new ce.Message.Wantlist;if(n.entries){if(!Array.isArray(n.entries))throw TypeError(".Message.Wantlist.entries: array expected");s.entries=[];for(var i=0;i<n.entries.length;++i){if(typeof n.entries[i]!="object")throw TypeError(".Message.Wantlist.entries: object expected");s.entries[i]=ce.Message.Wantlist.Entry.fromObject(n.entries[i])}}return n.full!=null&&(s.full=Boolean(n.full)),s},e.toObject=function(n,s){s||(s={});var i={};if((s.arrays||s.defaults)&&(i.entries=[]),s.defaults&&(i.full=!1),n.entries&&n.entries.length){i.entries=[];for(var o=0;o<n.entries.length;++o)i.entries[o]=ce.Message.Wantlist.Entry.toObject(n.entries[o],s)}return n.full!=null&&n.hasOwnProperty("full")&&(i.full=n.full),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.Wantlist"},e.WantType=function(){const t={},n=Object.create(t);return n[t[0]="Block"]=0,n[t[1]="Have"]=1,n}(),e.Entry=function(){function t(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}return t.prototype.block=fe.newBuffer([]),t.prototype.priority=0,t.prototype.cancel=!1,t.prototype.wantType=0,t.prototype.sendDontHave=!1,t.encode=function(s,i){return i||(i=_a.create()),s.block!=null&&Object.hasOwnProperty.call(s,"block")&&i.uint32(10).bytes(s.block),s.priority!=null&&Object.hasOwnProperty.call(s,"priority")&&i.uint32(16).int32(s.priority),s.cancel!=null&&Object.hasOwnProperty.call(s,"cancel")&&i.uint32(24).bool(s.cancel),s.wantType!=null&&Object.hasOwnProperty.call(s,"wantType")&&i.uint32(32).int32(s.wantType),s.sendDontHave!=null&&Object.hasOwnProperty.call(s,"sendDontHave")&&i.uint32(40).bool(s.sendDontHave),i},t.decode=function(s,i){s instanceof Wr||(s=Wr.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new ce.Message.Wantlist.Entry;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:{a.block=s.bytes();break}case 2:{a.priority=s.int32();break}case 3:{a.cancel=s.bool();break}case 4:{a.wantType=s.int32();break}case 5:{a.sendDontHave=s.bool();break}default:s.skipType(c&7);break}}return a},t.fromObject=function(s){if(s instanceof ce.Message.Wantlist.Entry)return s;var i=new ce.Message.Wantlist.Entry;switch(s.block!=null&&(typeof s.block=="string"?fe.base64.decode(s.block,i.block=fe.newBuffer(fe.base64.length(s.block)),0):s.block.length>=0&&(i.block=s.block)),s.priority!=null&&(i.priority=s.priority|0),s.cancel!=null&&(i.cancel=Boolean(s.cancel)),s.wantType){case"Block":case 0:i.wantType=0;break;case"Have":case 1:i.wantType=1;break}return s.sendDontHave!=null&&(i.sendDontHave=Boolean(s.sendDontHave)),i},t.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(i.bytes===String?o.block="":(o.block=[],i.bytes!==Array&&(o.block=fe.newBuffer(o.block))),o.priority=0,o.cancel=!1,o.wantType=i.enums===String?"Block":0,o.sendDontHave=!1),s.block!=null&&s.hasOwnProperty("block")&&(o.block=i.bytes===String?fe.base64.encode(s.block,0,s.block.length):i.bytes===Array?Array.prototype.slice.call(s.block):s.block),s.priority!=null&&s.hasOwnProperty("priority")&&(o.priority=s.priority),s.cancel!=null&&s.hasOwnProperty("cancel")&&(o.cancel=s.cancel),s.wantType!=null&&s.hasOwnProperty("wantType")&&(o.wantType=i.enums===String?ce.Message.Wantlist.WantType[s.wantType]:s.wantType),s.sendDontHave!=null&&s.hasOwnProperty("sendDontHave")&&(o.sendDontHave=s.sendDontHave),o},t.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},t.getTypeUrl=function(s){return s===void 0&&(s="type.googleapis.com"),s+"/Message.Wantlist.Entry"},t}(),e}(),r.Block=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.prefix=fe.newBuffer([]),e.prototype.data=fe.newBuffer([]),e.encode=function(n,s){return s||(s=_a.create()),n.prefix!=null&&Object.hasOwnProperty.call(n,"prefix")&&s.uint32(10).bytes(n.prefix),n.data!=null&&Object.hasOwnProperty.call(n,"data")&&s.uint32(18).bytes(n.data),s},e.decode=function(n,s){n instanceof Wr||(n=Wr.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new ce.Message.Block;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.prefix=n.bytes();break}case 2:{o.data=n.bytes();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof ce.Message.Block)return n;var s=new ce.Message.Block;return n.prefix!=null&&(typeof n.prefix=="string"?fe.base64.decode(n.prefix,s.prefix=fe.newBuffer(fe.base64.length(n.prefix)),0):n.prefix.length>=0&&(s.prefix=n.prefix)),n.data!=null&&(typeof n.data=="string"?fe.base64.decode(n.data,s.data=fe.newBuffer(fe.base64.length(n.data)),0):n.data.length>=0&&(s.data=n.data)),s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.prefix="":(i.prefix=[],s.bytes!==Array&&(i.prefix=fe.newBuffer(i.prefix))),s.bytes===String?i.data="":(i.data=[],s.bytes!==Array&&(i.data=fe.newBuffer(i.data)))),n.prefix!=null&&n.hasOwnProperty("prefix")&&(i.prefix=s.bytes===String?fe.base64.encode(n.prefix,0,n.prefix.length):s.bytes===Array?Array.prototype.slice.call(n.prefix):n.prefix),n.data!=null&&n.hasOwnProperty("data")&&(i.data=s.bytes===String?fe.base64.encode(n.data,0,n.data.length):s.bytes===Array?Array.prototype.slice.call(n.data):n.data),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.Block"},e}(),r.BlockPresenceType=function(){const e={},t=Object.create(e);return t[e[0]="Have"]=0,t[e[1]="DontHave"]=1,t}(),r.BlockPresence=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.cid=fe.newBuffer([]),e.prototype.type=0,e.encode=function(n,s){return s||(s=_a.create()),n.cid!=null&&Object.hasOwnProperty.call(n,"cid")&&s.uint32(10).bytes(n.cid),n.type!=null&&Object.hasOwnProperty.call(n,"type")&&s.uint32(16).int32(n.type),s},e.decode=function(n,s){n instanceof Wr||(n=Wr.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new ce.Message.BlockPresence;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.cid=n.bytes();break}case 2:{o.type=n.int32();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof ce.Message.BlockPresence)return n;var s=new ce.Message.BlockPresence;switch(n.cid!=null&&(typeof n.cid=="string"?fe.base64.decode(n.cid,s.cid=fe.newBuffer(fe.base64.length(n.cid)),0):n.cid.length>=0&&(s.cid=n.cid)),n.type){case"Have":case 0:s.type=0;break;case"DontHave":case 1:s.type=1;break}return s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.cid="":(i.cid=[],s.bytes!==Array&&(i.cid=fe.newBuffer(i.cid))),i.type=s.enums===String?"Have":0),n.cid!=null&&n.hasOwnProperty("cid")&&(i.cid=s.bytes===String?fe.base64.encode(n.cid,0,n.cid.length):s.bytes===Array?Array.prototype.slice.call(n.cid):n.cid),n.type!=null&&n.hasOwnProperty("type")&&(i.type=s.enums===String?ce.Message.BlockPresenceType[n.type]:n.type),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.BlockPresence"},e}(),r})(),jw={Block:Lr.Wantlist.WantType.Block,Have:Lr.Wantlist.WantType.Have},xhe=(r,e)=>Array.prototype.slice.call(e,0).sort((t,n)=>{const s=r(t),i=r(n);return s<i?-1:s>i?1:0});class Bc{constructor(e,t){this.set=t?Ii({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){const s=e.toString(Le),i=this.set.get(s);i?(i.inc(),i.priority=t,i.wantType===jw.Have&&n===jw.Block&&(i.wantType=n)):(this.set.set(s,new Q_(e,t,n)),this._stats&&this._stats.push(null,"wantListSize",1))}remove(e){const t=e.toString(Le),n=this.set.get(t);n&&(n.dec(),!n.hasRefs()&&(this.set.delete(t),this._stats&&this._stats.push(null,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){return this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(xhe(e=>e[1].key,Array.from(this.set.entries())))}contains(e){const t=e.toString(Le);return this.set.has(t)}get(e){const t=e.toString(Le);return this.set.get(t)}}Bc.Entry=Q_;const $he=Bc.Entry;class qu{constructor(e,t,n,s,i){this.entry=new $he(e,t,n),this.cancel=Boolean(s),this.sendDontHave=Boolean(i)}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(Le)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}}const Fo=(r,e)=>{const t=["bitswap"];return e&&t.push(e),r&&t.push(`${r.toString().slice(0,8)}`),P(t.join(":"))},i1=(r,e)=>{if(r.size!==e.size)return!1;for(const[t,n]of r){const s=e.get(t);if(s===void 0||n instanceof Uint8Array&&s instanceof Uint8Array&&!Ye(n,s)||n instanceof qu&&s instanceof qu&&!n.equals(s))return!1}return!0};class Me{constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,n,s,i){n==null&&(n=Me.WantType.Block);const o=e.toString(Le),a=this.wantlist.get(o);a?(a.wantType===n&&(a.priority=t),s&&(a.cancel=Boolean(s)),i&&(a.sendDontHave=Boolean(i)),n===Me.WantType.Block&&a.wantType===Me.WantType.Have&&(a.wantType=n)):this.wantlist.set(o,new qu(e,t,n,s,i))}addBlock(e,t){const n=e.toString(Le);this.blocks.set(n,t)}addHave(e){const t=e.toString(Le);this.blockPresences.has(t)||this.blockPresences.set(t,Me.BlockPresenceType.Have)}addDontHave(e){const t=e.toString(Le);this.blockPresences.has(t)||this.blockPresences.set(t,Me.BlockPresenceType.DontHave)}cancel(e){const t=e.toString(Le);this.wantlist.delete(t),this.addEntry(e,0,Me.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),cancel:Boolean(t.cancel)})),full:this.full?!0:void 0},blocks:Array.from(this.blocks.values())};return Lr.encode(e).finish()}serializeToBitswap110(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:Boolean(t.cancel),sendDontHave:Boolean(t.sendDontHave)})),full:this.full?!0:void 0},blockPresences:[],payload:[],pendingBytes:this.pendingBytes};for(const[t,n]of this.blocks.entries()){const s=Ie.parse(t),i=s.version,o=s.code,a=s.multihash.code,c=s.multihash.digest.length,h=Nhe([i,o,a,c]);e.payload.push(new Lr.Block({prefix:h,data:n}))}for(const[t,n]of this.blockPresences)e.blockPresences.push(new Lr.BlockPresence({cid:Ie.parse(t).bytes,type:n}));return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),Lr.encode(e).finish()}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!i1(this.wantlist,e.wantlist)||!i1(this.blocks,e.blocks)||!i1(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){const e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}}Me.deserialize=async(r,e)=>{const t=Lr.decode(r),n=t.wantlist&&t.wantlist.full||!1,s=new Me(n);return t.wantlist&&t.wantlist.entries&&t.wantlist.entries.forEach(i=>{if(!i.block)return;const o=Ie.decode(i.block);s.addEntry(o,i.priority||0,i.wantType,Boolean(i.cancel),Boolean(i.sendDontHave))}),t.blockPresences&&t.blockPresences.forEach(i=>{if(!i.cid)return;const o=Ie.decode(i.cid);i.type===Me.BlockPresenceType.Have?s.addHave(o):s.addDontHave(o)}),t.blocks.length>0?(await Promise.all(t.blocks.map(async i=>{const o=await s1.digest(i),a=Ie.createV0(o);s.addBlock(a,i)})),s):(t.payload.length>0&&(await Promise.all(t.payload.map(async i=>{if(!i.prefix||!i.data)return;const o=Ohe(i.prefix),a=o[0],c=o[1],h=o[2],l=h===s1.code?s1:e&&await e.getHasher(h);if(!l)throw new ee("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");const u=await l.digest(i.data),f=Ie.create(a,c,u);s.addBlock(f,i.data)})),s.setPendingBytes(t.pendingBytes)),s)};Me.blockPresenceSize=r=>r.bytes.length+1;Me.Entry=qu;Me.WantType={Block:Lr.Wantlist.WantType.Block,Have:Lr.Wantlist.WantType.Have};Me.BlockPresenceType={Have:Lr.BlockPresenceType.Have,DontHave:Lr.BlockPresenceType.DontHave};const Lhe=3,Mhe=Math.pow(2,31)-1,Uhe=1e3,Bhe=1;var zhe=Fhe;function Fhe(r,e,t){var n=null,s=null,i=function(){n&&(clearTimeout(n),s=null,n=null)},o=function(){var c=s;i(),c&&c()},a=function(){if(!e)return r.apply(this,arguments);var c=this,h=arguments,l=t&&!n;if(i(),s=function(){r.apply(c,h)},n=setTimeout(function(){if(n=null,!l){var u=s;return s=null,u()}},e),l)return s()};return a.cancel=i,a.flush=o,a}class Vhe{constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=Fo(e,"msgqueue"),this.sendEntries=zhe(this._sendEntries.bind(this),Bhe)}addMessage(e){e.empty||this.send(e)}addEntries(e){this._entries=this._entries.concat(e),this.sendEntries()}_sendEntries(){if(!this._entries.length)return;const e=new Me(!1);this._entries.forEach(t=>{t.cancel?e.cancel(t.cid):e.addEntry(t.cid,t.priority)}),this._entries=[],this.addMessage(e)}async send(e){try{await this.network.connectTo(this.peerId)}catch(t){this._log.error("cant connect to peer %s: %s",this.peerId.toString(),t.message);return}this._log("sending message to peer %s",this.peerId.toString()),this.network.sendMessage(this.peerId,e).catch(t=>{this._log.error("send error: %s",t.message)})}}class Khe{constructor(e,t,n,s){this.peers=Ii({name:"ipfs_bitswap_want_manager_peers",metrics:s.metrics}),this.wantlist=new Bc(n,s),this.network=t,this._stats=n,this._peerId=e,this._log=Fo(e,"want")}_addEntries(e,t,n){const s=e.map((i,o)=>new Me.Entry(i,Mhe-o,Me.WantType.Block,t));s.forEach(i=>{i.cancel?n?this.wantlist.removeForce(i.cid.toString(Le)):this.wantlist.remove(i.cid):(this._log("adding to wl"),this.wantlist.add(i.cid,i.priority))});for(const i of this.peers.values())i.addEntries(s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t){t.refcnt++;return}t=new Vhe(this._peerId,e,this.network);const n=new Me(!0);for(const s of this.wantlist.entries())n.addEntry(s[1].cid,s[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){const t=this.peers.get(e.toString());t&&(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>this.disconnected(e.peerId))}}const mp="/ipfs/bitswap/1.0.0",bp="/ipfs/bitswap/1.1.0",Ep="/ipfs/bitswap/1.2.0",jhe=32,Hhe=128,qhe=3e4;let Ghe=class{constructor(e,t,n,s={}){this._log=Fo(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[mp],s.b100Only||(this._protocols.unshift(bp),this._protocols.unshift(Ep)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader,this._maxInboundStreams=s.maxInboundStreams??jhe,this._maxOutboundStreams=s.maxOutboundStreams??Hhe,this._incomingStreamTimeout=s.incomingStreamTimeout??qhe}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});const e=z2({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(const t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(const e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection({stream:e,connection:t}){if(!this._running)return;const n=new ze.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",e.stat.protocol,t.remotePeer),await ie(Zt(e.source,n.signal),er(),async s=>{for await(const i of s){try{const o=await Me.deserialize(i.subarray(),this._hashLoader);await this._bitswap._receiveMessage(t.remotePeer,o)}catch(o){this._bitswap._receiveError(o);break}n.reset()}})}).catch(s=>{this._log(s),e.abort(s)}).finally(()=>{n.clear(),e.close()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){const n=[];let s=0;for await(const i of this.findProviders(e,t))if(this._log(`connecting to provider ${i.id}`),n.push(this.connectTo(i.id,t).catch(o=>{this._log.error(o)})),s++,s===Lhe)break;await Promise.all(n)}async provide(e,t){await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t){if(!this._running)throw new Error("network isn't running");const n=e.toString();this._log("sendMessage to %s",n,t);const i=await(await this._libp2p.dial(e)).newStream([Ep,bp,mp]);await Whe(i,t,this._log),this._updateSentStats(e,t.blocks)}async connectTo(e,t){if(!this._running)throw new Error("network isn't running");return this._libp2p.dial(e,t)}_updateSentStats(e,t){const n=e.toString();if(this._stats){for(const s of t.values())this._stats.push(n,"dataSent",s.length);this._stats.push(n,"blocksSent",t.size)}}};async function Whe(r,e,t){try{let n;switch(r.stat.protocol){case mp:n=e.serializeToBitswap100();break;case bp:case Ep:n=e.serializeToBitswap110();break;default:throw new Error("Unknown protocol: "+r.stat.protocol)}await ie([n],ar(),r)}catch(n){t(n)}finally{r.close()}}class Yhe{constructor(e){this.partner=e,this.wantlist=new Bc,this.exchangeCount=0,this.sentToPeer=new Map,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}class X_ extends Map{constructor(e,t){super(),this._cmp=t||this._defaultSort,this._keys=[];for(const[n,s]of e||[])this.set(n,s)}update(e){if(e<0||e>=this._keys.length)return;const t=this._keys[e];this._keys.splice(e,1);const n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){const s=this.indexOf(e);this._keys.splice(s,1)}super.set(e,t);const n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;const t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;const t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){const s=t+n>>>1,i=this._kCmp(this._keys[s],e);if(i<0)t=s+1;else if(i>0)n=s;else return s}return t}*keys(){for(const e of this._keys)yield e}*values(){for(const e of this._keys)yield this.get(e)}*entries(){for(const e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t){if(e)for(const n of this._keys)e.apply(t,[[n,this.get(n)]])}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}}const Qhe={hasNewInfo(){return!1},merge(){}};class Xhe{constructor(e=Qhe){this._taskMerger=e,this._byPeer=new X_([],Hw.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n||(n=new Hw(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){const t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};const{tasks:n,pendingSize:s}=t.popTasks(e);if(n.length===0)return{tasks:n,pendingSize:s};const i=t.peerId;return t.isIdle()?this._byPeer.delete(i.toString()):this._byPeer.update(0),{peerId:i,tasks:n,pendingSize:s}}_head(){if(this._byPeer.size!==0)for(const[,e]of this._byPeer)return e}remove(e,t){const n=this._byPeer.get(t.toString());n&&n.remove(e)}tasksDone(e,t){const n=this._byPeer.get(e.toString());if(!n)return;const s=this._byPeer.indexOf(e.toString());for(const i of t)n.taskDone(i);this._byPeer.update(s)}}class Hw{constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new Jhe,this._active=new Set}pushTasks(e){for(const t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;const t=this._pending.get(e.topic);if(t){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){const t=[];for(const n of this._active)n.topic===e.topic&&t.push(n);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0;const n=[],s=this._pending.tasks();for(let i=0;i<s.length&&t<e;i++){const o=s[i];n.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}}class Jhe{constructor(){this._tasks=new X_([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return(this._tasks.get(e)||{}).task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){const n=this._tasks.get(e);if(!n)return;const s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}}const Zhe={hasNewInfo(r,e){let t=!1,n=!1;for(const s of e)s.data.haveBlock&&(t=!0),s.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!t&&r.data.haveBlock)},merge(r,e){const t=r.data,n=e.data;!n.haveBlock&&t.haveBlock&&(n.haveBlock=t.haveBlock,n.blockSize=t.blockSize),!n.isWantBlock&&t.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||t.haveBlock)&&(n.haveBlock=t.haveBlock,e.size=r.size)),n.isWantBlock&&n.haveBlock&&(e.size=n.blockSize)}},qw=Me.WantType,eue=16*1024,tue=1024;class rue{constructor(e,t,n,s,i,o={}){this._log=Fo(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=Ii({name:"ipfs_bitswap_ledger_map",metrics:i.metrics}),this._running=!1,this._requestQueue=new Xhe(Zhe)}_processOpts(e){return{maxSizeReplaceHasWithBlock:tue,targetMessageSize:eue,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks()})}async _processTasks(){if(!this._running)return;const{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;const s=new Me(!1);s.setPendingBytes(n);const i=[],o=new Map;for(const c of t){const h=Ie.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(i.push(h),o.set(c.topic,c.data)):s.addHave(h):s.addDontHave(h)}const a=await this._getBlocks(i);for(const[c,h]of o){const l=Ie.parse(c),u=a.get(c);u?s.addBlock(l,u):h.sendDontHave&&s.addDontHave(l)}if(s.empty){e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e&&await this.network.sendMessage(e,s);for(const[c,h]of a.entries())e&&this.messageSent(e,Ie.parse(c),h)}catch(c){this._log.error(c)}e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}:null}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(e.length){for(const t of this.ledgerMap.values())for(const n of e){const s=t.wantlistContains(n.cid);if(!s)continue;const i=n.data.length,o=this._sendAsBlock(s.wantType,i);let a=i;o||(a=Me.blockPresenceSize(s.cid)),this._requestQueue.pushTasks(t.partner,[{topic:s.cid.toString(Le),priority:s.priority,size:a,data:{blockSize:i,isWantBlock:o,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){const n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new Bc),this._updateBlockAccounting(t.blocks,n),t.wantlist.size===0){this._scheduleProcessTasks();return}const s=[],i=[];t.wantlist.forEach(o=>{o.cancel?(n.cancelWant(o.cid),s.push(o.cid)):(n.wants(o.cid,o.priority,o.wantType),i.push(o))}),this._cancelWants(e,s),await this._addWants(e,i),this._scheduleProcessTasks()}_cancelWants(e,t){for(const n of t)this._requestQueue.remove(n.toString(Le),e)}async _addWants(e,t){const n=await this._getBlockSizes(t.map(i=>i.cid)),s=[];for(const i of t){const o=i.cid.toString(Le),a=n.get(o);if(a==null)i.sendDontHave&&s.push({topic:o,priority:i.priority,size:Me.blockPresenceSize(i.cid),data:{isWantBlock:i.wantType===qw.Block,blockSize:0,haveBlock:!1,sendDontHave:i.sendDontHave}});else{const c=this._sendAsBlock(i.wantType,a);let h=a;c||(h=Me.blockPresenceSize(i.cid)),s.push({topic:o,priority:i.priority,size:h,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:i.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===qw.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){const t=await this._getBlocks(e);return new Map([...t].map(([n,s])=>[n,s.length]))}async _getBlocks(e){const t=new Map;return await Promise.all(e.map(async n=>{try{const s=await this.blockstore.get(n);t.set(n.toString(Le),s)}catch(s){s.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,s)}})),t}_updateBlockAccounting(e,t){for(const n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){const s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){const t=e.toString(),n=this.ledgerMap.get(t);if(n)return n;const s=new Yhe(e);return this.ledgerMap.set(t,s),this._stats&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}}const Gw=r=>`unwant:${B(r.multihash.bytes,"base64")}`,Ww=r=>`block:${B(r.multihash.bytes,"base64")}`;class nue extends Ce.EventEmitter{constructor(e){super(),this.setMaxListeners(Uhe),this._log=Fo(e,"notif")}hasBlock(e,t){const n=Ww(e);this._log(n),this.emit(n,t)}wantBlock(e,t={}){if(!e)throw new Error("Not a valid cid");const n=Ww(e),s=Gw(e);return this._log(`wantBlock:${e}`),new Promise((i,o)=>{const a=()=>{this.removeListener(n,c),o(new Error(`Block for ${e} unwanted`))},c=h=>{this.removeListener(s,a),i(h)};this.once(s,a),this.once(n,c),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(s,a),o(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){const t=Gw(e);this._log(t),this.emit(t)}}var Gu={},sue={get exports(){return Gu},set exports(r){Gu=r}};(function(r,e){const t=Math.exp;r.exports=function(s){if(typeof s!="number")throw new Error("must provide a timespan to the moving average constructor");if(s<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let i,o=0,a=0,c=0,h,l={};function u(f,g){return 1-t(-(f-g)/s)}return l.push=function(g,d){if(h){const p=u(g,h),w=d-i,y=p*w;i=p*d+(1-p)*i,o=(1-p)*(o+w*y),a=Math.sqrt(o),c=i+p*w}else i=d;h=g},l.movingAverage=function(){return i},l.variance=function(){return o},l.deviation=function(){return a},l.forecast=function(){return c},l}})(sue);class Yw extends Ce.EventEmitter{constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(s=>{(this._movingAverages[n][s]=Gu(s)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._disabled=!0}stop(){this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){const e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=null,this._queue.length){let e;for(;this._queue.length;){const t=e=this._queue.shift();t&&this._applyOp(t)}e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){const t=e-this._frequencyLastTime;t&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){const s=this._frequencyAccumulators[e]||0;this._frequencyAccumulators[e]=0;const i=s/t*1e3;let o=this._movingAverages[e];o||(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c||(c=o[a]=Gu(a)),c.push(n,i)})}_applyOp(e){const t=e[0],n=e[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]||(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}}const Qw={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]};class iue extends Ce.EventEmitter{constructor(e,t=[],n=Qw){super();const s=Object.assign({},Qw,n);if(typeof s.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof s.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new Yw(t,s),this._global.on("update",i=>this.emit("update",i)),this._peers=Ii({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(const e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){const t=typeof e!="string"&&e.toString?e.toString():`${e}`;return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e)){let s=this._peers.get(e);s||(s=new Yw(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){const t=e.toString(),n=this._peers.get(t);n&&(n.stop(),this._peers.delete(t))}}const oue={statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},aue=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"];class cue extends U2{constructor(e,t,n={}){super(),this._libp2p=e,this._log=Fo(this.peerId),this._options=Object.assign({},oue,n),this._stats=new iue(e,aue,{enabled:this._options.statsEnabled,computeThrottleTimeout:this._options.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:this._options.statsComputeThrottleMaxQueueSize}),this.network=new Ghe(e,this,this._stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new rue(this.peerId,t,this.network,this._stats,e),this.wm=new Khe(this.peerId,this.network,this._stats,e),this.notifications=new nue(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;const n=[];for(const[s,i]of t.blocks.entries()){const o=Ie.parse(s);n.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:i})}this.wm.cancelWants(n.filter(({wasWanted:s})=>s).map(({cid:s})=>s)),await Promise.all(n.map(({cid:s,wasWanted:i,data:o})=>this._handleReceivedBlock(e,s,o,i)))}async _handleReceivedBlock(e,t,n,s){this._log("received block");const i=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,i),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this._stats.push(e,"blocksReceived",1),this._stats.push(e,"dataReceived",n.length),s&&(this._stats.push(e,"dupBlksReceived",1),this._stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError: %s",e.message)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this._stats.disconnected(e)}enableStats(){this._stats.enable()}disableStats(){this._stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async get(e,t={}){const n=(c,h)=>(this.wm.wantBlocks([c],h),this.notifications.wantBlock(c,h));let s=!1;const i=async(c,h)=>{try{return await this.blockstore.get(c,h)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l;return s||(s=!0,this.network.findAndConnect(c,h).catch(u=>this._log.error(u))),n(c,h)}},o=new AbortController,a=t.signal?Ur([t.signal,o.signal]):o.signal;try{return await Promise.race([this.notifications.wantBlock(e,{signal:a}),i(e,{signal:a})])}finally{o.abort()}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}unwant(e){const t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(n=>this.notifications.unwantBlock(n))}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this._sendHaveBlockNotifications(e,t)}async*putMany(e,t){for await(const{key:n,value:s}of this.blockstore.putMany(e,t))this._sendHaveBlockNotifications(n,s),yield{key:n,value:s}}_sendHaveBlockNotifications(e,t){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,data:t}]),this.network.provide(e).catch(n=>{this._log.error("Failed to provide: %s",n.message)})}getWantlist(){return this.wm.wantlist.entries()}peers(){return this.engine.peers()}stat(){return this._stats}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this._stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}unwrap(){return this.blockstore}has(e){return this.blockstore.has(e)}}const lue=(r,e,t={})=>new cue(r,e,t);function hue(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,w=0,y=0,_=d.length;y!==_&&d[y]===0;)y++,p++;for(var m=(_-y)*l+1>>>0,b=new Uint8Array(m);y!==_;){for(var S=d[y],A=0,E=m-1;(S!==0||A<w)&&E!==-1;E--,A++)S+=256*b[E]>>>0,b[E]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=A,y++}for(var I=m-w;I!==m&&b[I]===0;)I++;for(var C=c.repeat(p);I<m;++I)C+=r.charAt(b[I]);return C}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var w=0,y=0;d[p]===c;)w++,p++;for(var _=(d.length-p)*h+1>>>0,m=new Uint8Array(_);d[p];){var b=t[d.charCodeAt(p)];if(b===255)return;for(var S=0,A=_-1;(b!==0||S<y)&&A!==-1;A--,S++)b+=a*m[A]>>>0,m[A]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=S,p++}if(d[p]!==" "){for(var E=_-y;E!==_&&m[E]===0;)E++;for(var I=new Uint8Array(w+(_-E)),C=w;E!==_;)I[C++]=m[E++];return I}}}function g(d){var p=f(d);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:u,decodeUnsafe:f,decode:g}}var uue=hue,due=uue;const fue=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};class pue{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class gue{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return J_(this,e)}}class yue{constructor(e){this.decoders=e}or(e){return J_(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const J_=(r,e)=>new yue({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class wue{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new pue(e,t,n),this.decoder=new gue(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Z_=({name:r,prefix:e,encode:t,decode:n})=>new wue(r,e,t,n),ev=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=due(t,e);return Z_({prefix:r,name:e,encode:n,decode:i=>fue(s(i))})},mue=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,h=0;for(let l=0;l<i;++l){const u=s[r[l]];if(u===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|u,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},bue=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},ns=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Z_({prefix:e,name:r,encode(s){return bue(s,n,t)},decode(s){return mue(s,n,t,r)}});ns({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ns({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ns({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ns({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ns({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ns({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ns({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ns({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ns({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});ev({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});ev({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});class Eue extends U2{constructor(e,t){super(),this.child=e,this.bitswap=t}open(){return this.child.open()}close(){return this.child.close()}unwrap(){return this.child}async put(e,t,n={}){await this.has(e)||(this.bitswap.isStarted()?await this.bitswap.put(e,t,n):await this.child.put(e,t,n))}async*putMany(e,t={}){const n=$e(e,async({key:s})=>!await this.has(s));this.bitswap.isStarted()?yield*this.bitswap.putMany(n,t):yield*this.child.putMany(n,t)}async get(e,t={}){return!await this.has(e)&&this.bitswap.isStarted()?this.bitswap.get(e,t):this.child.get(e,t)}async*getMany(e,t={}){const n=Bt({objectMode:!0}),s=Bt({objectMode:!0});Promise.resolve().then(async()=>{for await(const i of e)!await this.has(i)&&this.bitswap.isStarted()?n.push(i):s.push(i);n.end(),s.end()}),yield*Yt(this.bitswap.getMany(n,t),this.child.getMany(s,t))}async delete(e,t){await this.child.delete(e,t)}async*deleteMany(e,t){yield*this.child.deleteMany(e,t)}async has(e,t={}){return this.child.has(e,t)}async*query(e,t={}){yield*this.child.query(e,t)}async*queryKeys(e,t={}){yield*this.child.queryKeys(e,t)}}class vg{constructor(e,t,n,s,i){this.peerId=e,this.libp2p=t,this.bitswap=n,this.repo=s,this.blockstore=i}static async start({peerId:e,repo:t,print:n,hashers:s,options:i}){t.closed&&await t.open();const o=await t.config.getAll(),a=await mg({options:i,repo:t,peerId:e,multiaddrs:_ue(e,o),config:o,keychainConfig:void 0});await a.start();for(const l of a.getMultiaddrs())n(`Swarm listening on ${l.toString()}`);const c=lue(a,t.blocks,{statsEnabled:!0,hashLoader:s,maxInboundStreams:1024,maxOutboundStreams:1024});await c.start();const h=new Eue(t.blocks,c);return t.blocks=h,t.pins.blockstore=h,new vg(e,a,c,t,h)}static async stop(e){e.repo.blocks=e.blockstore.unwrap(),e.repo.pins.blockstore=e.blockstore.unwrap(),await e.bitswap.stop(),await e.libp2p.stop()}}const _ue=(r,e)=>{const t=r.toString(),n=[],s=e.Addresses&&e.Addresses.Swarm||[];for(const i of s){let o=G(i);if(o.protoCodes().includes(vue))throw v(new Error("websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779"),"ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED");const a=o.getPeerId();a&&a!==t&&(o=o.encapsulate(`/p2p/${t}`)),n.push(o)}return n},vue=479;function Sue({network:r}){async function e(t={}){const n=[],{libp2p:s}=await r.use(t);return await s.peerStore.forEach(i=>{n.push({id:i.id,addrs:i.addresses.map(o=>o.multiaddr)})}),n}return x(e)}function Rue({network:r}){async function e(t,n={}){const{libp2p:s}=await r.use(n);await s.dial(t,n)}return x(e)}function Aue({network:r}){async function e(t,n={}){const{libp2p:s}=await r.use(n);await s.hangUp(t)}return x(e)}function Iue({network:r}){async function e(t={}){const{libp2p:n}=await r.use(t);return n.getMultiaddrs()}return x(e)}function Cue({network:r}){async function e(t={}){const{libp2p:n}=await r.use(t);if(t.verbose){const i=[];for(const o of n.getConnections()){const a={addr:o.remoteAddr,peer:o.remotePeer};(t.verbose||t.direction)&&(a.direction=o.stat.direction),t.verbose&&(a.muxer=o.stat.multiplexer,a.latency="n/a",a.streams=[]),i.push(a)}return i}const s=new Map;for(const i of n.getConnections()){const o={addr:i.remoteAddr,peer:i.remotePeer};s.set(i.remotePeer.toString(),o)}return Array.from(s.values())}return x(e)}class Tue{constructor({network:e}){this.addrs=Sue({network:e}),this.connect=Rue({network:e}),this.disconnect=Aue({network:e}),this.localAddrs=Iue({network:e}),this.peers=Cue({network:e})}}const va={success:!0,time:0,text:""};function kue({network:r}){async function*e(t,n={}){const{libp2p:s}=await r.use();n.count=n.count||10;const i=await s.peerStore.get(t);let o=i&&i.id;if(!o){yield{...va,text:`Looking up peer ${t}`};const h=await s.peerRouting.findPeer(t);o=h&&h.id}if(!o)throw new Error("Peer was not found");yield{...va,text:`PING ${o.toString()}`};let a=0,c=0;for(let h=0;h<n.count;h++)try{const l=await s.ping(o);c+=l,a++,yield{...va,time:l}}catch(l){yield{...va,success:!1,text:l.toString()}}if(a){const h=c/a;yield{...va,text:`Average latency: ${h}ms`}}}return x(e)}const o1="/ipns/";function Xw(r){r.startsWith(o1)&&(r=r.substring(o1.length));let e;if((r[0]==="1"||r[0]==="Q")&&(r=`z${r}`),r[0]==="z"&&(e=sr.decode(r)),r[0]==="k"&&(e=ph.decode(r)),!e)throw new Error("Could not parse string");if(e[0]!==1&&e[1]!==114&&(e=qe([[1,114],e])),e.length!==40)throw new Error("Incorrect length "+e.length);return qe([L(o1),e.subarray(2)])}function Due({network:r,repo:e,peerId:t}){const{get:n,put:s,findProvs:i,findPeer:o,provide:a,query:c}={async*get(h,l={}){const{libp2p:u}=await qi(r,t,l),f=h instanceof Uint8Array?h:Xw(h);if(u.dht==null)throw v(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*u.dht.get(f,l)},async*put(h,l,u){const{libp2p:f}=await qi(r,t,u),g=h instanceof Uint8Array?h:Xw(h);if(f.dht==null)throw v(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*f.dht.put(g,l,u)},async*findProvs(h,l={}){const{libp2p:u}=await qi(r,t,l);if(u.dht==null)throw v(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*u.dht.findProviders(h,{signal:l.signal})},async*findPeer(h,l={}){const{libp2p:u}=await qi(r,t,l);if(u.dht==null)throw v(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*u.dht.findPeer(h,{signal:l.signal})},async*provide(h,l={recursive:!1}){const{libp2p:u}=await qi(r,t,l);if(!await e.blocks.has(h))throw v(new Error("block(s) not found locally, cannot provide"),"ERR_BLOCK_NOT_FOUND");if(l.recursive)throw v(new Error("not implemented yet"),"ERR_NOT_IMPLEMENTED_YET");if(u.dht==null)throw v(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*u.dht.provide(h)},async*query(h,l={}){const{libp2p:u}=await qi(r,t,l);let f;const g=J.asCID(h);if(g!=null?f=g.multihash.bytes:f=Z(h.toString()).toBytes(),u.dht==null)throw v(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*u.dht.getClosestPeers(f,l)}};return{get:x(n),put:x(s),findProvs:x(i),findPeer:x(o),provide:x(a),query:x(c)}}const qi=async(r,e,t)=>{const n=await r.use(t);if(n.libp2p.dht!=null)return n;{const s=async function*(){yield{from:e,name:"QUERY_ERROR",type:3,error:new Po("dht not enabled")}};return{libp2p:{dht:{get:s,put:s,findProviders:s,findPeer:s,provide:s,getClosestPeers:s}}}}};function Pue({network:r,config:e}){const t=le(e||{},"Pubsub.Enabled",!0),n={};let s;return{subscribe:t?x(i):Sa,unsubscribe:t?x(o):Sa,publish:t?x(a):Sa,ls:t?x(c):Sa,peers:t?x(h):Sa};async function i(l,u,f={}){const{libp2p:g}=await r.use(f);g.pubsub.subscribe(l),s==null&&(s=d=>{const p=d.detail;n[p.topic]&&n[p.topic].forEach(w=>{if(typeof w=="function"){w(p);return}w!=null&&w.handleEvent!=null&&w.handleEvent(p)})},g.pubsub.addEventListener("message",s)),u!=null&&(n[l]==null&&(n[l]=[]),n[l].push(u))}async function o(l,u,f={}){const{libp2p:g}=await r.use(f);u!=null&&n[l]!=null&&(n[l]=n[l].filter(d=>d!==u),n[l].length===0&&delete n[l]),typeof u!="function"&&delete n[l],n[l]==null&&g.pubsub.unsubscribe(l),Object.keys(n).length===0&&(g.pubsub.removeEventListener("message",s),s=void 0)}async function a(l,u,f={}){const{libp2p:g}=await r.use(f);if(!u)throw v(new Error('argument "data" is required'),"ERR_ARG_REQUIRED");await g.pubsub.publish(l,u)}async function c(l={}){const{libp2p:u}=await r.use(l);return u.pubsub.getTopics()}async function h(l,u={}){const{libp2p:f}=await r.use(u);return f.pubsub.getSubscribers(l)}}const Sa=async()=>{throw new Po("pubsub not enabled")},Oue=Ue.bind({ignoreUndefined:!0}),us=P("ipfs"),Nue=3e4;class xue{constructor({print:e,storage:t,codecs:n,options:s}){const{peerId:i,repo:o,keychain:a}=t,c=Pr.create(vg),h=VF(s.preload),l=Ok(),u=Nk({network:c}),f=new PO(s),g=Object.values(BC);(s.ipld&&s.ipld.hashers?s.ipld.hashers:[]).forEach(Q=>g.push(Q)),this.hashers=new G9({hashers:g,loadHasher:s.ipld&&s.ipld.loadHasher});const d=Object.values(UC);(s.ipld&&s.ipld.bases?s.ipld.bases:[]).forEach(Q=>d.push(Q)),this.bases=new H9({bases:d,loadBase:s.ipld&&s.ipld.loadBase});const p=new dP({repo:o,codecs:n}),w=new fN({codecs:n,hashers:this.hashers,preload:h,repo:o}),y=new KO({dns:l,ipns:f,repo:o,codecs:n,peerId:i,isOnline:u,keychain:a,options:s}),_=nP({repo:o,codecs:n,bases:this.bases,name:y}),m=new xF({repo:o,codecs:n,hashers:this.hashers,preload:h}),b=Object.assign(HO({repo:o,codecs:n,resolve:_,preload:h}),{local:XO({repo:t.repo})}),{add:S,addAll:A,cat:E,get:I,ls:C}=new dz({preload:h,repo:o,options:s.EXPERIMENTAL,hashers:this.hashers}),D=sK({repo:o,preload:h,hashers:this.hashers,options:s}),$=KF({files:D,preload:h,options:s.preload});this.preload=h,this.name=y,this.ipns=f,this.pin=p,this.resolve=_,this.block=w,this.refs=b,this.start=Rk({network:c,peerId:i,repo:o,preload:h,ipns:f,mfsPreload:$,print:e,keychain:a,hashers:this.hashers,options:s}),this.stop=Ak({network:c,preload:h,mfsPreload:$,ipns:f,repo:o}),this.dht=Due({network:c,repo:o,peerId:i}),this.pubsub=Pue({network:c,config:s.config}),this.dns=l,this.isOnline=u,this.id=wz({network:c,peerId:i}),this.version=gz({repo:o}),this.bitswap=new tN({network:c}),this.bootstrap=new aN({repo:o}),this.config=vz({repo:o}),this.ping=kue({network:c}),this.add=S,this.addAll=A,this.cat=E,this.get=I,this.ls=C,this.dag=m,this.files=D,this.key=new dK({keychain:a}),this.object=new vK({preload:h,codecs:n,repo:o}),this.repo=new IK({repo:o,hashers:this.hashers}),this.stats=new TK({repo:o,network:c}),this.swarm=new Tue({network:c}),Object.defineProperty(this,"libp2p",{get(){const Q=c.try();return Q?Q.libp2p:void 0}});const K=()=>Promise.reject(v(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")),W=async function*(){throw v(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")};this.commands=K,this.diag={cmds:K,net:K,sys:K},this.log={level:K,ls:K,tail:W},this.mount=K,this.codecs=n}async init(){throw new bi}}const $ue=async r=>{const e=De({Data:new Pe({type:"directory"}).marshal(),Links:[]}),t=await r.block.put(e,{mhtype:"sha2-256",format:"dag-pb"});return await r.pin.add(t),t},Lue=()=>({start:!0,EXPERIMENTAL:{},preload:{enabled:!Hs.isTest,addresses:["/dns4/node0.preload.ipfs.io/https","/dns4/node1.preload.ipfs.io/https","/dns4/node2.preload.ipfs.io/https","/dns4/node3.preload.ipfs.io/https"]}});async function Mue(r={}){r=Oue(Lue(),r);const e=r.init||{},t={name:E1.name,code:E1.code,encode:h=>h,decode:h=>h},n=Object.values(zC);[Ks,rm,km,Um,t].concat(r.ipld&&r.ipld.codecs||[]).forEach(h=>n.push(h));const s=new q9({codecs:n,loadCodec:r.ipld&&r.ipld.loadCodec}),i=r.silent?us:console.log;us("creating repo");const o=await bg.start(i,s,r);us("getting repo config");const a=await o.repo.config.getAll(),c=new xue({storage:o,print:i,codecs:s,options:{...r,config:a}});if(us("starting preload"),await c.preload.start(),us("starting storage"),c.ipns.startOffline(o),o.isNew&&!e.emptyRepo){const h=await $ue(c);if(us("adding default assets"),await(c.addAll,void 0),us("initializing IPNS keyspace"),o.peerId.publicKey==null)throw v(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");const l=new ze.TimeoutController(Nue);try{await c.ipns.initializeKeyspace(o.peerId,L(`/ipfs/${h}`),{signal:l.signal})}finally{l.clear()}}return r.start!==!1&&(us("starting node"),await c.start()),c}const Uue=Mue,Bue=Uue,zue=async()=>qa||nm?(await zd(()=>import("./configNavigateur-dfb85e83.js"),["configNavigateur-dfb85e83.js","const-b6190579.js","index-bb67a2e0.js","index-050f9adb.css"])).default:Rp?(await zd(()=>import("./configTravailleur-a17bb644.js"),["configTravailleur-a17bb644.js","index-bb67a2e0.js","index-050f9adb.css"])).default:(await zd(()=>import("./configNode-c4866404.js"),["configNode-c4866404.js","const-b6190579.js","index-bb67a2e0.js","index-050f9adb.css"])).default,Fue=()=>({libp2p:{streamMuxers:[ym()],connectionEncryption:[z_()]},relay:{enabled:!0,hop:{enabled:!0,active:!0}}});async function Vue(r="./constl/sfip"){const e=Fue(),t=await zue();e.repo=r;const n=Ue(e,t);return Bue(n)}const O1e=Object.freeze(Object.defineProperty({__proto__:null,default:Vue},Symbol.toStringTag,{value:"Module"}));export{nh as A,nre as W,Zt as a,Zm as b,pre as c,Uie as g,O1e as i,wce as k,eg as s,qce as w};
//# sourceMappingURL=index-182d9333.js.map

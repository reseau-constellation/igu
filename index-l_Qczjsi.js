import{b as Ge,S as ge,g as Fe,r as de,i as yt,e as cs,a as Bo,f as Ho,m as jo,L as sn,M as tt,c as ds,t as Se,d as z,s as us,h as ae,j as J,k as Z,l as Te,p as on,u as an,n as vt,o as nt,q as Vo,v as nr,w as hs,x as Uo}from"./index-BSvBYzJE.js";import{c as rr,g as sr}from"./index-CR2rYOXb.js";class mt{#e={};#t=0;emit(t,...n){if(!this.#e[t])return!1;const r=[...this.#e[t]];for(let s=0;s<r.length;s++){const{once:i,fn:o}=r[s];i&&this.removeListener(t,o),o(...n)}return!0}addListener(t,n){return this.#s(t,n,!1)}on=this.addListener;once(t,n){return this.#s(t,n,!0)}removeListener(t,n){const r=this.#e[t];if(r){if(!n)this.removeAllListeners(t);else{const s=[];for(let i=0;i<r.length;i++)r[i].fn===n&&(r[i],this.#t-=1,this.#t===0?(this.#e={},this.#t=0):r.length===1?delete this.#e[t]:s.push(i));for(let i=s.length-1;i>=0;i--)r.splice(s[i],1)}return this}}off=this.removeListener;removeAllListeners(t){if(t){const n=this.#e[t];n&&(this.#t-=n.length,this.#t===0?this.#e={}:delete this.#e[t])}else this.#e={},this.#t=0;return this}#s(t,n,r=!1){const s={fn:n,once:r},i=this.#e[t]??[];return i.push(s),this.#e[t]=i,this.#t++,this}}function b(e,t="Assertion failed"){if(e===!1||e===null||e===void 0){const n=new Error(Go(t));throw n.stack=Fo(n.stack,"assert.js"),n}}const Go=e=>e.split(`
`).map(t=>t.trim()).join(`
`),Fo=(e="",t)=>e.split(`
`).filter(n=>!n.includes(t)).join(`
`);function Q(e){return e!=null&&typeof e=="object"}var Yo="[object Symbol]";function cn(e){return typeof e=="symbol"||Q(e)&&Ge(e)==Yo}function Wo(e,t){for(var n=-1,r=e==null?0:e.length,s=Array(r);++n<r;)s[n]=t(e[n],n,e);return s}var j=Array.isArray,zo=1/0,ir=ge?ge.prototype:void 0,or=ir?ir.toString:void 0;function ls(e){if(typeof e=="string")return e;if(j(e))return Wo(e,ls)+"";if(cn(e))return or?or.call(e):"";var t=e+"";return t=="0"&&1/e==-zo?"-0":t}function qo(e){return e}var jt=Fe(de,"WeakMap"),ar=Object.create,Jo=function(){function e(){}return function(t){if(!yt(t))return{};if(ar)return ar(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();function Xo(){}function Zo(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}var cr=function(){try{var e=Fe(Object,"defineProperty");return e({},"",{}),e}catch{}}();function Qo(e,t){for(var n=-1,r=e==null?0:e.length;++n<r&&t(e[n],n,e)!==!1;);return e}function ea(e,t,n,r){for(var s=e.length,i=n+(r?1:-1);r?i--:++i<s;)if(t(e[i],i,e))return i;return-1}function ta(e){return e!==e}function na(e,t,n){for(var r=n-1,s=e.length;++r<s;)if(e[r]===t)return r;return-1}function ra(e,t,n){return t===t?na(e,t,n):ea(e,ta,n)}function sa(e,t){var n=e==null?0:e.length;return!!n&&ra(e,t,0)>-1}var ia=9007199254740991,oa=/^(?:0|[1-9]\d*)$/;function fs(e,t){var n=typeof e;return t=t??ia,!!t&&(n=="number"||n!="symbol"&&oa.test(e))&&e>-1&&e%1==0&&e<t}function ps(e,t,n){t=="__proto__"&&cr?cr(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}var aa=Object.prototype,ca=aa.hasOwnProperty;function ys(e,t,n){var r=e[t];(!(ca.call(e,t)&&cs(r,n))||n===void 0&&!(t in e))&&ps(e,t,n)}function gt(e,t,n,r){var s=!n;n||(n={});for(var i=-1,o=t.length;++i<o;){var a=t[i],c=r?r(n[a],e[a],a,n,e):void 0;c===void 0&&(c=e[a]),s?ps(n,a,c):ys(n,a,c)}return n}var da=9007199254740991;function dn(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=da}function vs(e){return e!=null&&dn(e.length)&&!Bo(e)}var ua=Object.prototype;function un(e){var t=e&&e.constructor,n=typeof t=="function"&&t.prototype||ua;return e===n}function ha(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}var la="[object Arguments]";function dr(e){return Q(e)&&Ge(e)==la}var ms=Object.prototype,fa=ms.hasOwnProperty,pa=ms.propertyIsEnumerable,gs=dr(function(){return arguments}())?dr:function(e){return Q(e)&&fa.call(e,"callee")&&!pa.call(e,"callee")};function ya(){return!1}var Es=typeof exports=="object"&&exports&&!exports.nodeType&&exports,ur=Es&&typeof module=="object"&&module&&!module.nodeType&&module,va=ur&&ur.exports===Es,hr=va?de.Buffer:void 0,ma=hr?hr.isBuffer:void 0,rt=ma||ya,ga="[object Arguments]",Ea="[object Array]",ba="[object Boolean]",Ia="[object Date]",_a="[object Error]",Sa="[object Function]",Ta="[object Map]",Aa="[object Number]",Ma="[object Object]",wa="[object RegExp]",Ra="[object Set]",Oa="[object String]",ka="[object WeakMap]",La="[object ArrayBuffer]",xa="[object DataView]",Ca="[object Float32Array]",Da="[object Float64Array]",$a="[object Int8Array]",Na="[object Int16Array]",Ka="[object Int32Array]",Pa="[object Uint8Array]",Ba="[object Uint8ClampedArray]",Ha="[object Uint16Array]",ja="[object Uint32Array]",T={};T[Ca]=T[Da]=T[$a]=T[Na]=T[Ka]=T[Pa]=T[Ba]=T[Ha]=T[ja]=!0;T[ga]=T[Ea]=T[La]=T[ba]=T[xa]=T[Ia]=T[_a]=T[Sa]=T[Ta]=T[Aa]=T[Ma]=T[wa]=T[Ra]=T[Oa]=T[ka]=!1;function Va(e){return Q(e)&&dn(e.length)&&!!T[Ge(e)]}function hn(e){return function(t){return e(t)}}var bs=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Le=bs&&typeof module=="object"&&module&&!module.nodeType&&module,Ua=Le&&Le.exports===bs,Lt=Ua&&Ho.process,Ee=function(){try{var e=Le&&Le.require&&Le.require("util").types;return e||Lt&&Lt.binding&&Lt.binding("util")}catch{}}(),lr=Ee&&Ee.isTypedArray,Is=lr?hn(lr):Va,Ga=Object.prototype,Fa=Ga.hasOwnProperty;function _s(e,t){var n=j(e),r=!n&&gs(e),s=!n&&!r&&rt(e),i=!n&&!r&&!s&&Is(e),o=n||r||s||i,a=o?ha(e.length,String):[],c=a.length;for(var d in e)(t||Fa.call(e,d))&&!(o&&(d=="length"||s&&(d=="offset"||d=="parent")||i&&(d=="buffer"||d=="byteLength"||d=="byteOffset")||fs(d,c)))&&a.push(d);return a}function Ss(e,t){return function(n){return e(t(n))}}var Ya=Ss(Object.keys,Object),Wa=Object.prototype,za=Wa.hasOwnProperty;function qa(e){if(!un(e))return Ya(e);var t=[];for(var n in Object(e))za.call(e,n)&&n!="constructor"&&t.push(n);return t}function Et(e){return vs(e)?_s(e):qa(e)}function Ja(e){var t=[];if(e!=null)for(var n in Object(e))t.push(n);return t}var Xa=Object.prototype,Za=Xa.hasOwnProperty;function Qa(e){if(!yt(e))return Ja(e);var t=un(e),n=[];for(var r in e)r=="constructor"&&(t||!Za.call(e,r))||n.push(r);return n}function ln(e){return vs(e)?_s(e,!0):Qa(e)}var ec=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,tc=/^\w*$/;function fn(e,t){if(j(e))return!1;var n=typeof e;return n=="number"||n=="symbol"||n=="boolean"||e==null||cn(e)?!0:tc.test(e)||!ec.test(e)||t!=null&&e in Object(t)}var nc=500;function rc(e){var t=jo(e,function(r){return n.size===nc&&n.clear(),r}),n=t.cache;return t}var sc=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ic=/\\(\\)?/g,oc=rc(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(sc,function(n,r,s,i){t.push(s?i.replace(ic,"$1"):r||n)}),t});function ac(e){return e==null?"":ls(e)}function Ts(e,t){return j(e)?e:fn(e,t)?[e]:oc(ac(e))}var cc=1/0;function bt(e){if(typeof e=="string"||cn(e))return e;var t=e+"";return t=="0"&&1/e==-cc?"-0":t}function As(e,t){t=Ts(t,e);for(var n=0,r=t.length;e!=null&&n<r;)e=e[bt(t[n++])];return n&&n==r?e:void 0}function dc(e,t,n){var r=e==null?void 0:As(e,t);return r===void 0?n:r}function Ms(e,t){for(var n=-1,r=t.length,s=e.length;++n<r;)e[s+n]=t[n];return e}var uc=Ss(Object.getPrototypeOf,Object);const ws=uc;function hc(){this.__data__=new sn,this.size=0}function lc(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}function fc(e){return this.__data__.get(e)}function pc(e){return this.__data__.has(e)}var yc=200;function vc(e,t){var n=this.__data__;if(n instanceof sn){var r=n.__data__;if(!tt||r.length<yc-1)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new ds(r)}return n.set(e,t),this.size=n.size,this}function H(e){var t=this.__data__=new sn(e);this.size=t.size}H.prototype.clear=hc;H.prototype.delete=lc;H.prototype.get=fc;H.prototype.has=pc;H.prototype.set=vc;function mc(e,t){return e&&gt(t,Et(t),e)}function gc(e,t){return e&&gt(t,ln(t),e)}var Rs=typeof exports=="object"&&exports&&!exports.nodeType&&exports,fr=Rs&&typeof module=="object"&&module&&!module.nodeType&&module,Ec=fr&&fr.exports===Rs,pr=Ec?de.Buffer:void 0,yr=pr?pr.allocUnsafe:void 0;function bc(e,t){if(t)return e.slice();var n=e.length,r=yr?yr(n):new e.constructor(n);return e.copy(r),r}function Ic(e,t){for(var n=-1,r=e==null?0:e.length,s=0,i=[];++n<r;){var o=e[n];t(o,n,e)&&(i[s++]=o)}return i}function Os(){return[]}var _c=Object.prototype,Sc=_c.propertyIsEnumerable,vr=Object.getOwnPropertySymbols,pn=vr?function(e){return e==null?[]:(e=Object(e),Ic(vr(e),function(t){return Sc.call(e,t)}))}:Os;function Tc(e,t){return gt(e,pn(e),t)}var Ac=Object.getOwnPropertySymbols,ks=Ac?function(e){for(var t=[];e;)Ms(t,pn(e)),e=ws(e);return t}:Os;function Mc(e,t){return gt(e,ks(e),t)}function Ls(e,t,n){var r=t(e);return j(e)?r:Ms(r,n(e))}function Vt(e){return Ls(e,Et,pn)}function wc(e){return Ls(e,ln,ks)}var Ut=Fe(de,"DataView"),Gt=Fe(de,"Promise"),ve=Fe(de,"Set"),mr="[object Map]",Rc="[object Object]",gr="[object Promise]",Er="[object Set]",br="[object WeakMap]",Ir="[object DataView]",Oc=Se(Ut),kc=Se(tt),Lc=Se(Gt),xc=Se(ve),Cc=Se(jt),re=Ge;(Ut&&re(new Ut(new ArrayBuffer(1)))!=Ir||tt&&re(new tt)!=mr||Gt&&re(Gt.resolve())!=gr||ve&&re(new ve)!=Er||jt&&re(new jt)!=br)&&(re=function(e){var t=Ge(e),n=t==Rc?e.constructor:void 0,r=n?Se(n):"";if(r)switch(r){case Oc:return Ir;case kc:return mr;case Lc:return gr;case xc:return Er;case Cc:return br}return t});const Ne=re;var Dc=Object.prototype,$c=Dc.hasOwnProperty;function Nc(e){var t=e.length,n=new e.constructor(t);return t&&typeof e[0]=="string"&&$c.call(e,"index")&&(n.index=e.index,n.input=e.input),n}var st=de.Uint8Array;function yn(e){var t=new e.constructor(e.byteLength);return new st(t).set(new st(e)),t}function Kc(e,t){var n=t?yn(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}var Pc=/\w*$/;function Bc(e){var t=new e.constructor(e.source,Pc.exec(e));return t.lastIndex=e.lastIndex,t}var _r=ge?ge.prototype:void 0,Sr=_r?_r.valueOf:void 0;function Hc(e){return Sr?Object(Sr.call(e)):{}}function jc(e,t){var n=t?yn(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}var Vc="[object Boolean]",Uc="[object Date]",Gc="[object Map]",Fc="[object Number]",Yc="[object RegExp]",Wc="[object Set]",zc="[object String]",qc="[object Symbol]",Jc="[object ArrayBuffer]",Xc="[object DataView]",Zc="[object Float32Array]",Qc="[object Float64Array]",ed="[object Int8Array]",td="[object Int16Array]",nd="[object Int32Array]",rd="[object Uint8Array]",sd="[object Uint8ClampedArray]",id="[object Uint16Array]",od="[object Uint32Array]";function ad(e,t,n){var r=e.constructor;switch(t){case Jc:return yn(e);case Vc:case Uc:return new r(+e);case Xc:return Kc(e,n);case Zc:case Qc:case ed:case td:case nd:case rd:case sd:case id:case od:return jc(e,n);case Gc:return new r;case Fc:case zc:return new r(e);case Yc:return Bc(e);case Wc:return new r;case qc:return Hc(e)}}function cd(e){return typeof e.constructor=="function"&&!un(e)?Jo(ws(e)):{}}var dd="[object Map]";function ud(e){return Q(e)&&Ne(e)==dd}var Tr=Ee&&Ee.isMap,hd=Tr?hn(Tr):ud,ld="[object Set]";function fd(e){return Q(e)&&Ne(e)==ld}var Ar=Ee&&Ee.isSet,pd=Ar?hn(Ar):fd,yd=1,vd=2,md=4,xs="[object Arguments]",gd="[object Array]",Ed="[object Boolean]",bd="[object Date]",Id="[object Error]",Cs="[object Function]",_d="[object GeneratorFunction]",Sd="[object Map]",Td="[object Number]",Ds="[object Object]",Ad="[object RegExp]",Md="[object Set]",wd="[object String]",Rd="[object Symbol]",Od="[object WeakMap]",kd="[object ArrayBuffer]",Ld="[object DataView]",xd="[object Float32Array]",Cd="[object Float64Array]",Dd="[object Int8Array]",$d="[object Int16Array]",Nd="[object Int32Array]",Kd="[object Uint8Array]",Pd="[object Uint8ClampedArray]",Bd="[object Uint16Array]",Hd="[object Uint32Array]",_={};_[xs]=_[gd]=_[kd]=_[Ld]=_[Ed]=_[bd]=_[xd]=_[Cd]=_[Dd]=_[$d]=_[Nd]=_[Sd]=_[Td]=_[Ds]=_[Ad]=_[Md]=_[wd]=_[Rd]=_[Kd]=_[Pd]=_[Bd]=_[Hd]=!0;_[Id]=_[Cs]=_[Od]=!1;function Xe(e,t,n,r,s,i){var o,a=t&yd,c=t&vd,d=t&md;if(n&&(o=s?n(e,r,s,i):n(e)),o!==void 0)return o;if(!yt(e))return e;var h=j(e);if(h){if(o=Nc(e),!a)return Zo(e,o)}else{var u=Ne(e),l=u==Cs||u==_d;if(rt(e))return bc(e,a);if(u==Ds||u==xs||l&&!s){if(o=c||l?{}:cd(e),!a)return c?Mc(e,gc(o,e)):Tc(e,mc(o,e))}else{if(!_[u])return s?e:{};o=ad(e,u,a)}}i||(i=new H);var p=i.get(e);if(p)return p;i.set(e,o),pd(e)?e.forEach(function(v){o.add(Xe(v,t,n,v,e,i))}):hd(e)&&e.forEach(function(v,I){o.set(I,Xe(v,t,n,I,e,i))});var y=d?c?wc:Vt:c?ln:Et,m=h?void 0:y(e);return Qo(m||e,function(v,I){m&&(I=v,v=e[I]),ys(o,I,Xe(v,t,n,I,e,i))}),o}var jd=4;function Vd(e){return Xe(e,jd)}var Ud="__lodash_hash_undefined__";function Gd(e){return this.__data__.set(e,Ud),this}function Fd(e){return this.__data__.has(e)}function Ke(e){var t=-1,n=e==null?0:e.length;for(this.__data__=new ds;++t<n;)this.add(e[t])}Ke.prototype.add=Ke.prototype.push=Gd;Ke.prototype.has=Fd;function Yd(e,t){for(var n=-1,r=e==null?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}function $s(e,t){return e.has(t)}var Wd=1,zd=2;function Ns(e,t,n,r,s,i){var o=n&Wd,a=e.length,c=t.length;if(a!=c&&!(o&&c>a))return!1;var d=i.get(e),h=i.get(t);if(d&&h)return d==t&&h==e;var u=-1,l=!0,p=n&zd?new Ke:void 0;for(i.set(e,t),i.set(t,e);++u<a;){var y=e[u],m=t[u];if(r)var v=o?r(m,y,u,t,e,i):r(y,m,u,e,t,i);if(v!==void 0){if(v)continue;l=!1;break}if(p){if(!Yd(t,function(I,R){if(!$s(p,R)&&(y===I||s(y,I,n,r,i)))return p.push(R)})){l=!1;break}}else if(!(y===m||s(y,m,n,r,i))){l=!1;break}}return i.delete(e),i.delete(t),l}function qd(e){var t=-1,n=Array(e.size);return e.forEach(function(r,s){n[++t]=[s,r]}),n}function vn(e){var t=-1,n=Array(e.size);return e.forEach(function(r){n[++t]=r}),n}var Jd=1,Xd=2,Zd="[object Boolean]",Qd="[object Date]",eu="[object Error]",tu="[object Map]",nu="[object Number]",ru="[object RegExp]",su="[object Set]",iu="[object String]",ou="[object Symbol]",au="[object ArrayBuffer]",cu="[object DataView]",Mr=ge?ge.prototype:void 0,xt=Mr?Mr.valueOf:void 0;function du(e,t,n,r,s,i,o){switch(n){case cu:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case au:return!(e.byteLength!=t.byteLength||!i(new st(e),new st(t)));case Zd:case Qd:case nu:return cs(+e,+t);case eu:return e.name==t.name&&e.message==t.message;case ru:case iu:return e==t+"";case tu:var a=qd;case su:var c=r&Jd;if(a||(a=vn),e.size!=t.size&&!c)return!1;var d=o.get(e);if(d)return d==t;r|=Xd,o.set(e,t);var h=Ns(a(e),a(t),r,s,i,o);return o.delete(e),h;case ou:if(xt)return xt.call(e)==xt.call(t)}return!1}var uu=1,hu=Object.prototype,lu=hu.hasOwnProperty;function fu(e,t,n,r,s,i){var o=n&uu,a=Vt(e),c=a.length,d=Vt(t),h=d.length;if(c!=h&&!o)return!1;for(var u=c;u--;){var l=a[u];if(!(o?l in t:lu.call(t,l)))return!1}var p=i.get(e),y=i.get(t);if(p&&y)return p==t&&y==e;var m=!0;i.set(e,t),i.set(t,e);for(var v=o;++u<c;){l=a[u];var I=e[l],R=t[l];if(r)var P=o?r(R,I,l,t,e,i):r(I,R,l,e,t,i);if(!(P===void 0?I===R||s(I,R,n,r,i):P)){m=!1;break}v||(v=l=="constructor")}if(m&&!v){var $=e.constructor,V=t.constructor;$!=V&&"constructor"in e&&"constructor"in t&&!(typeof $=="function"&&$ instanceof $&&typeof V=="function"&&V instanceof V)&&(m=!1)}return i.delete(e),i.delete(t),m}var pu=1,wr="[object Arguments]",Rr="[object Array]",qe="[object Object]",yu=Object.prototype,Or=yu.hasOwnProperty;function vu(e,t,n,r,s,i){var o=j(e),a=j(t),c=o?Rr:Ne(e),d=a?Rr:Ne(t);c=c==wr?qe:c,d=d==wr?qe:d;var h=c==qe,u=d==qe,l=c==d;if(l&&rt(e)){if(!rt(t))return!1;o=!0,h=!1}if(l&&!h)return i||(i=new H),o||Is(e)?Ns(e,t,n,r,s,i):du(e,t,c,n,r,s,i);if(!(n&pu)){var p=h&&Or.call(e,"__wrapped__"),y=u&&Or.call(t,"__wrapped__");if(p||y){var m=p?e.value():e,v=y?t.value():t;return i||(i=new H),s(m,v,n,r,i)}}return l?(i||(i=new H),fu(e,t,n,r,s,i)):!1}function mn(e,t,n,r,s){return e===t?!0:e==null||t==null||!Q(e)&&!Q(t)?e!==e&&t!==t:vu(e,t,n,r,mn,s)}var mu=1,gu=2;function Eu(e,t,n,r){var s=n.length,i=s,o=!r;if(e==null)return!i;for(e=Object(e);s--;){var a=n[s];if(o&&a[2]?a[1]!==e[a[0]]:!(a[0]in e))return!1}for(;++s<i;){a=n[s];var c=a[0],d=e[c],h=a[1];if(o&&a[2]){if(d===void 0&&!(c in e))return!1}else{var u=new H;if(r)var l=r(d,h,c,e,t,u);if(!(l===void 0?mn(h,d,mu|gu,r,u):l))return!1}}return!0}function Ks(e){return e===e&&!yt(e)}function bu(e){for(var t=Et(e),n=t.length;n--;){var r=t[n],s=e[r];t[n]=[r,s,Ks(s)]}return t}function Ps(e,t){return function(n){return n==null?!1:n[e]===t&&(t!==void 0||e in Object(n))}}function Iu(e){var t=bu(e);return t.length==1&&t[0][2]?Ps(t[0][0],t[0][1]):function(n){return n===e||Eu(n,e,t)}}function _u(e,t){return e!=null&&t in Object(e)}function Su(e,t,n){t=Ts(t,e);for(var r=-1,s=t.length,i=!1;++r<s;){var o=bt(t[r]);if(!(i=e!=null&&n(e,o)))break;e=e[o]}return i||++r!=s?i:(s=e==null?0:e.length,!!s&&dn(s)&&fs(o,s)&&(j(e)||gs(e)))}function Tu(e,t){return e!=null&&Su(e,t,_u)}var Au=1,Mu=2;function wu(e,t){return fn(e)&&Ks(t)?Ps(bt(e),t):function(n){var r=dc(n,e);return r===void 0&&r===t?Tu(n,e):mn(t,r,Au|Mu)}}function Ru(e){return function(t){return t?.[e]}}function Ou(e){return function(t){return As(t,e)}}function ku(e){return fn(e)?Ru(bt(e)):Ou(e)}function Lu(e){return typeof e=="function"?e:e==null?qo:typeof e=="object"?j(e)?wu(e[0],e[1]):Iu(e):ku(e)}function xu(e,t,n){for(var r=-1,s=e==null?0:e.length;++r<s;)if(n(t,e[r]))return!0;return!1}var Cu=1/0,Du=ve&&1/vn(new ve([,-0]))[1]==Cu?function(e){return new ve(e)}:Xo,$u=200;function Bs(e,t,n){var r=-1,s=sa,i=e.length,o=!0,a=[],c=a;if(n)o=!1,s=xu;else if(i>=$u){var d=t?null:Du(e);if(d)return vn(d);o=!1,s=$s,c=new Ke}else c=t?[]:a;e:for(;++r<i;){var h=e[r],u=t?t(h):h;if(h=n||h!==0?h:0,o&&u===u){for(var l=c.length;l--;)if(c[l]===u)continue e;t&&c.push(u),a.push(h)}else s(c,u,n)||(c!==a&&c.push(u),a.push(h))}return a}function gn(e){return e&&e.length?Bs(e):[]}function Nu(e,t){return e&&e.length?Bs(e,Lu(t)):[]}var te={},S={},w={};Object.defineProperty(w,"__esModule",{value:!0});w.output=w.exists=w.hash=w.bytes=w.bool=w.number=w.isBytes=void 0;function it(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}w.number=it;function Hs(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}w.bool=Hs;function js(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}w.isBytes=js;function En(e,...t){if(!js(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}w.bytes=En;function Vs(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");it(e.outputLen),it(e.blockLen)}w.hash=Vs;function Us(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}w.exists=Us;function Gs(e,t){En(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}w.output=Gs;const Ku={number:it,bool:Hs,bytes:En,hash:Vs,exists:Us,output:Gs};w.default=Ku;var g={};Object.defineProperty(g,"__esModule",{value:!0});g.add5L=g.add5H=g.add4H=g.add4L=g.add3H=g.add3L=g.add=g.rotlBL=g.rotlBH=g.rotlSL=g.rotlSH=g.rotr32L=g.rotr32H=g.rotrBL=g.rotrBH=g.rotrSL=g.rotrSH=g.shrSL=g.shrSH=g.toBig=g.split=g.fromBig=void 0;const Je=BigInt(2**32-1),Ft=BigInt(32);function bn(e,t=!1){return t?{h:Number(e&Je),l:Number(e>>Ft&Je)}:{h:Number(e>>Ft&Je)|0,l:Number(e&Je)|0}}g.fromBig=bn;function Fs(e,t=!1){let n=new Uint32Array(e.length),r=new Uint32Array(e.length);for(let s=0;s<e.length;s++){const{h:i,l:o}=bn(e[s],t);[n[s],r[s]]=[i,o]}return[n,r]}g.split=Fs;const Ys=(e,t)=>BigInt(e>>>0)<<Ft|BigInt(t>>>0);g.toBig=Ys;const Ws=(e,t,n)=>e>>>n;g.shrSH=Ws;const zs=(e,t,n)=>e<<32-n|t>>>n;g.shrSL=zs;const qs=(e,t,n)=>e>>>n|t<<32-n;g.rotrSH=qs;const Js=(e,t,n)=>e<<32-n|t>>>n;g.rotrSL=Js;const Xs=(e,t,n)=>e<<64-n|t>>>n-32;g.rotrBH=Xs;const Zs=(e,t,n)=>e>>>n-32|t<<64-n;g.rotrBL=Zs;const Qs=(e,t)=>t;g.rotr32H=Qs;const ei=(e,t)=>e;g.rotr32L=ei;const ti=(e,t,n)=>e<<n|t>>>32-n;g.rotlSH=ti;const ni=(e,t,n)=>t<<n|e>>>32-n;g.rotlSL=ni;const ri=(e,t,n)=>t<<n-32|e>>>64-n;g.rotlBH=ri;const si=(e,t,n)=>e<<n-32|t>>>64-n;g.rotlBL=si;function ii(e,t,n,r){const s=(t>>>0)+(r>>>0);return{h:e+n+(s/2**32|0)|0,l:s|0}}g.add=ii;const oi=(e,t,n)=>(e>>>0)+(t>>>0)+(n>>>0);g.add3L=oi;const ai=(e,t,n,r)=>t+n+r+(e/2**32|0)|0;g.add3H=ai;const ci=(e,t,n,r)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0);g.add4L=ci;const di=(e,t,n,r,s)=>t+n+r+s+(e/2**32|0)|0;g.add4H=di;const ui=(e,t,n,r,s)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0)+(s>>>0);g.add5L=ui;const hi=(e,t,n,r,s,i)=>t+n+r+s+i+(e/2**32|0)|0;g.add5H=hi;const Pu={fromBig:bn,split:Fs,toBig:Ys,shrSH:Ws,shrSL:zs,rotrSH:qs,rotrSL:Js,rotrBH:Xs,rotrBL:Zs,rotr32H:Qs,rotr32L:ei,rotlSH:ti,rotlSL:ni,rotlBH:ri,rotlBL:si,add:ii,add3L:oi,add3H:ai,add4L:ci,add4H:di,add5H:hi,add5L:ui};g.default=Pu;var li={},It={};Object.defineProperty(It,"__esModule",{value:!0});It.crypto=void 0;It.crypto=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;(function(e){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.randomBytes=e.wrapXOFConstructorWithOpts=e.wrapConstructorWithOpts=e.wrapConstructor=e.checkOpts=e.Hash=e.concatBytes=e.toBytes=e.utf8ToBytes=e.asyncLoop=e.nextTick=e.hexToBytes=e.bytesToHex=e.byteSwap32=e.byteSwapIfBE=e.byteSwap=e.isLE=e.rotl=e.rotr=e.createView=e.u32=e.u8=e.isBytes=void 0;const t=It,n=w;function r(f){return f instanceof Uint8Array||f!=null&&typeof f=="object"&&f.constructor.name==="Uint8Array"}e.isBytes=r;const s=f=>new Uint8Array(f.buffer,f.byteOffset,f.byteLength);e.u8=s;const i=f=>new Uint32Array(f.buffer,f.byteOffset,Math.floor(f.byteLength/4));e.u32=i;const o=f=>new DataView(f.buffer,f.byteOffset,f.byteLength);e.createView=o;const a=(f,E)=>f<<32-E|f>>>E;e.rotr=a;const c=(f,E)=>f<<E|f>>>32-E>>>0;e.rotl=c,e.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;const d=f=>f<<24&4278190080|f<<8&16711680|f>>>8&65280|f>>>24&255;e.byteSwap=d,e.byteSwapIfBE=e.isLE?f=>f:f=>(0,e.byteSwap)(f);function h(f){for(let E=0;E<f.length;E++)f[E]=(0,e.byteSwap)(f[E])}e.byteSwap32=h;const u=Array.from({length:256},(f,E)=>E.toString(16).padStart(2,"0"));function l(f){(0,n.bytes)(f);let E="";for(let M=0;M<f.length;M++)E+=u[f[M]];return E}e.bytesToHex=l;const p={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function y(f){if(f>=p._0&&f<=p._9)return f-p._0;if(f>=p._A&&f<=p._F)return f-(p._A-10);if(f>=p._a&&f<=p._f)return f-(p._a-10)}function m(f){if(typeof f!="string")throw new Error("hex string expected, got "+typeof f);const E=f.length,M=E/2;if(E%2)throw new Error("padded hex string expected, got unpadded hex of length "+E);const A=new Uint8Array(M);for(let O=0,x=0;O<M;O++,x+=2){const er=y(f.charCodeAt(x)),tr=y(f.charCodeAt(x+1));if(er===void 0||tr===void 0){const Po=f[x]+f[x+1];throw new Error('hex string expected, got non-hex character "'+Po+'" at index '+x)}A[O]=er*16+tr}return A}e.hexToBytes=m;const v=async()=>{};e.nextTick=v;async function I(f,E,M){let A=Date.now();for(let O=0;O<f;O++){M(O);const x=Date.now()-A;x>=0&&x<E||(await(0,e.nextTick)(),A+=x)}}e.asyncLoop=I;function R(f){if(typeof f!="string")throw new Error(`utf8ToBytes expected string, got ${typeof f}`);return new Uint8Array(new TextEncoder().encode(f))}e.utf8ToBytes=R;function P(f){return typeof f=="string"&&(f=R(f)),(0,n.bytes)(f),f}e.toBytes=P;function $(...f){let E=0;for(let A=0;A<f.length;A++){const O=f[A];(0,n.bytes)(O),E+=O.length}const M=new Uint8Array(E);for(let A=0,O=0;A<f.length;A++){const x=f[A];M.set(x,O),O+=x.length}return M}e.concatBytes=$;class V{clone(){return this._cloneInto()}}e.Hash=V;const kt={}.toString;function Co(f,E){if(E!==void 0&&kt.call(E)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(f,E)}e.checkOpts=Co;function Do(f){const E=A=>f().update(P(A)).digest(),M=f();return E.outputLen=M.outputLen,E.blockLen=M.blockLen,E.create=()=>f(),E}e.wrapConstructor=Do;function $o(f){const E=(A,O)=>f(O).update(P(A)).digest(),M=f({});return E.outputLen=M.outputLen,E.blockLen=M.blockLen,E.create=A=>f(A),E}e.wrapConstructorWithOpts=$o;function No(f){const E=(A,O)=>f(O).update(P(A)).digest(),M=f({});return E.outputLen=M.outputLen,E.blockLen=M.blockLen,E.create=A=>f(A),E}e.wrapXOFConstructorWithOpts=No;function Ko(f=32){if(t.crypto&&typeof t.crypto.getRandomValues=="function")return t.crypto.getRandomValues(new Uint8Array(f));throw new Error("crypto.getRandomValues must be defined")}e.randomBytes=Ko})(li);Object.defineProperty(S,"__esModule",{value:!0});S.shake256=S.shake128=S.keccak_512=S.keccak_384=S.keccak_256=S.keccak_224=S.sha3_512=S.sha3_384=S.sha3_256=S.sha3_224=S.Keccak=S.keccakP=void 0;const ue=w,Pe=g,F=li,fi=[],pi=[],yi=[],Bu=BigInt(0),Me=BigInt(1),Hu=BigInt(2),ju=BigInt(7),Vu=BigInt(256),Uu=BigInt(113);for(let e=0,t=Me,n=1,r=0;e<24;e++){[n,r]=[r,(2*n+3*r)%5],fi.push(2*(5*r+n)),pi.push((e+1)*(e+2)/2%64);let s=Bu;for(let i=0;i<7;i++)t=(t<<Me^(t>>ju)*Uu)%Vu,t&Hu&&(s^=Me<<(Me<<BigInt(i))-Me);yi.push(s)}const[Gu,Fu]=(0,Pe.split)(yi,!0),kr=(e,t,n)=>n>32?(0,Pe.rotlBH)(e,t,n):(0,Pe.rotlSH)(e,t,n),Lr=(e,t,n)=>n>32?(0,Pe.rotlBL)(e,t,n):(0,Pe.rotlSL)(e,t,n);function vi(e,t=24){const n=new Uint32Array(10);for(let r=24-t;r<24;r++){for(let o=0;o<10;o++)n[o]=e[o]^e[o+10]^e[o+20]^e[o+30]^e[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,d=n[c],h=n[c+1],u=kr(d,h,1)^n[a],l=Lr(d,h,1)^n[a+1];for(let p=0;p<50;p+=10)e[o+p]^=u,e[o+p+1]^=l}let s=e[2],i=e[3];for(let o=0;o<24;o++){const a=pi[o],c=kr(s,i,a),d=Lr(s,i,a),h=fi[o];s=e[h],i=e[h+1],e[h]=c,e[h+1]=d}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)n[a]=e[o+a];for(let a=0;a<10;a++)e[o+a]^=~n[(a+2)%10]&n[(a+4)%10]}e[0]^=Gu[r],e[1]^=Fu[r]}n.fill(0)}S.keccakP=vi;class Ye extends F.Hash{constructor(t,n,r,s=!1,i=24){if(super(),this.blockLen=t,this.suffix=n,this.outputLen=r,this.enableXOF=s,this.rounds=i,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,ue.number)(r),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,F.u32)(this.state)}keccak(){F.isLE||(0,F.byteSwap32)(this.state32),vi(this.state32,this.rounds),F.isLE||(0,F.byteSwap32)(this.state32),this.posOut=0,this.pos=0}update(t){(0,ue.exists)(this);const{blockLen:n,state:r}=this;t=(0,F.toBytes)(t);const s=t.length;for(let i=0;i<s;){const o=Math.min(n-this.pos,s-i);for(let a=0;a<o;a++)r[this.pos++]^=t[i++];this.pos===n&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:t,suffix:n,pos:r,blockLen:s}=this;t[r]^=n,n&128&&r===s-1&&this.keccak(),t[s-1]^=128,this.keccak()}writeInto(t){(0,ue.exists)(this,!1),(0,ue.bytes)(t),this.finish();const n=this.state,{blockLen:r}=this;for(let s=0,i=t.length;s<i;){this.posOut>=r&&this.keccak();const o=Math.min(r-this.posOut,i-s);t.set(n.subarray(this.posOut,this.posOut+o),s),this.posOut+=o,s+=o}return t}xofInto(t){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(t)}xof(t){return(0,ue.number)(t),this.xofInto(new Uint8Array(t))}digestInto(t){if((0,ue.output)(t,this),this.finished)throw new Error("digest() was already called");return this.writeInto(t),this.destroy(),t}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(t){const{blockLen:n,suffix:r,outputLen:s,rounds:i,enableXOF:o}=this;return t||(t=new Ye(n,r,s,o,i)),t.state32.set(this.state32),t.pos=this.pos,t.posOut=this.posOut,t.finished=this.finished,t.rounds=i,t.suffix=r,t.outputLen=s,t.enableXOF=o,t.destroyed=this.destroyed,t}}S.Keccak=Ye;const ne=(e,t,n)=>(0,F.wrapConstructor)(()=>new Ye(t,e,n));S.sha3_224=ne(6,144,224/8);S.sha3_256=ne(6,136,256/8);S.sha3_384=ne(6,104,384/8);S.sha3_512=ne(6,72,512/8);S.keccak_224=ne(1,144,224/8);S.keccak_256=ne(1,136,256/8);S.keccak_384=ne(1,104,384/8);S.keccak_512=ne(1,72,512/8);const mi=(e,t,n)=>(0,F.wrapXOFConstructorWithOpts)((r={})=>new Ye(t,e,r.dkLen===void 0?n:r.dkLen,!0));S.shake128=mi(31,168,128/8);S.shake256=mi(31,136,256/8);const{sha3_512:Yu}=S,gi=24,xe=32,Yt=(e=4,t=Math.random)=>{let n="";for(;n.length<e;)n=n+Math.floor(t()*36).toString(36);return n};function Ei(e){let t=8n,n=0n;for(const r of e.values()){const s=BigInt(r);n=(n<<t)+s}return n}const bi=(e="")=>Ei(Yu(e)).toString(36).slice(1),xr=Array.from({length:26},(e,t)=>String.fromCharCode(t+97)),Wu=e=>xr[Math.floor(e()*xr.length)],Ii=({globalObj:e=typeof rr<"u"?rr:typeof window<"u"?window:{},random:t=Math.random}={})=>{const n=Object.keys(e).toString(),r=n.length?n+Yt(xe,t):Yt(xe,t);return bi(r).substring(0,xe)},_i=e=>()=>e++,zu=476782367,Si=({random:e=Math.random,counter:t=_i(Math.floor(e()*zu)),length:n=gi,fingerprint:r=Ii({random:e})}={})=>function(){const i=Wu(e),o=Date.now().toString(36),a=t().toString(36),c=Yt(n,e),d=`${o+c+a+r}`;return`${i+bi(d).substring(1,n)}`},qu=Si(),Ju=(e,{minLength:t=2,maxLength:n=xe}={})=>{const r=e.length,s=/^[0-9a-z]+$/;try{if(typeof e=="string"&&r>=t&&r<=n&&s.test(e))return!0}finally{}return!1};te.getConstants=()=>({defaultLength:gi,bigLength:xe});te.init=Si;te.createId=qu;te.bufToBigInt=Ei;te.createCounter=_i;te.createFingerprint=Ii;te.isCuid=Ju;const{createId:Xu,init:$p,getConstants:Np,isCuid:Kp}=te;var In=Xu,Zu="SIGNATURE",Qu="ENCRYPTION",eh="SYMMETRIC",th="LINK_HASH",Ti={SIGNATURE:Zu,ENCRYPTION:Qu,SYMMETRIC:eh,LINK_HASH:th},_t="ROOT",pe={isValid:!0},Ai={type:"EPHEMERAL",name:"EPHEMERAL"},{LINK_HASH:nh}=Ti,Be=e=>J(nh,e),Mi=({graph:e,action:t,user:n,context:r={},keys:s})=>{const{publicKey:i,secretKey:o}=n.keys.encryption,{publicKey:a}=s.encryption,c={...t,...r,userId:n.userId,timestamp:Date.now(),prev:e.head??[]},d=Z.encryptBytes({secret:c,recipientPublicKey:a,senderSecretKey:o}),h=Be(d),u={hash:h,body:c},l={senderPublicKey:i,recipientPublicKey:a,encryptedBody:d};return{root:e.root??h,head:[h],encryptedLinks:{...e.encryptedLinks,[h]:l},links:{...e.links,[h]:u}}},ot=(e,t)=>e.links[t],wi=(e,t)=>rh(e)[t]||[],rh=z(e=>{const t={};for(const n of Object.values(e.links)){const r=n.body.prev;for(const s of r){const i=t[s]||[];i.push(n.hash),t[s]=i}}return t}),at=e=>Object.keys(e.links),sh=(e,t)=>`${e.head.join("")}:${t}`,He=z((e,t)=>{const n=ot(e,t);b(n);const r=n.body.prev,s=r.flatMap(i=>He(e,i));return gn(r.concat(s))},sh),ih=(e,t,n)=>t!==void 0&&n!==void 0&&t.hash in e.links&&n.hash in e.links&&He(e,n.hash).includes(t.hash),oh=(e,t,n)=>He(e,n).includes(t),ah=(e,t)=>`${e.head.join("")}:${t}`,Ri=z((e,t)=>{const n=wi(e,t),r=n.flatMap(s=>Ri(e,s));return gn(n.concat(r))},ah),ch=(e,t,n)=>Ri(e,n).includes(t),dh=(e,t)=>uh(e)[t],uh=z(e=>{const t={};for(const n in e.links){const r=n;t[r]=at(e).filter(s=>hh(e,r,s)).sort()}return t}),hh=(e,t,n)=>t!==n&&!oh(e,t,n)&&!ch(e,t,n),lh=e=>{const t={},n=s=>{const i=[s];for(const o of dh(e,s))t[o]||(t[o]=!0,i.push(...n(o)));return i},r=[];for(const s in e.links){const i=s;if(!t[i]){t[i]=!0;const o=n(i);o.length>1&&r.push(o)}}return r},fh={root:void 0,head:void 0,encryptedLinks:{},links:{}},ph=({user:e,id:t=In(),name:n=t,rootPayload:r={},context:s={},keys:i})=>{const o={name:n,id:t,...r};return Mi({graph:fh,action:{type:_t,prev:[],payload:o},user:e,context:s,keys:i})},yh=e=>(t,n)=>{const r=typeof e=="function"?e(n):n[e];return{...t,[r]:n}},vh={GRAPH:"GRAPH",USER:"USER"},mh=e=>e.encryption.hasOwnProperty("secretKey")&&e.signature.hasOwnProperty("secretKey")&&"secretKey"in e,St=e=>e!==void 0&&"secretKey"in e&&"encryption"in e&&"signature"in e,gh=e=>!Array.isArray(e)&&!St(e),Ae=e=>gh(e)?e:(St(e)&&(e=[e]),e.reduce(yh(t=>t.encryption.publicKey),{})),Oi=(e,t)=>{const{senderPublicKey:n,recipientPublicKey:r,encryptedBody:s}=e,o=Ae(t)[r];b(o,"Can't decrypt link: don't have the correct keyset");const a=Eh(s),c=Z.decryptBytes({cipher:a,recipientSecretKey:o.encryption.secretKey,senderPublicKey:n});return{hash:Be(s),body:c}},_n=({encryptedGraph:e,keys:t})=>{const{encryptedLinks:n,root:r,childMap:s={}}=e,i=e.links??{},o=(c,d={})=>{const h=n[c],u=i[c]??Oi(h,t);let l={[c]:u};const p=s[c]??[];for(const y of p)l={...l,...o(y,l)};return{...d,...l}},a=o(r);return{...e,links:a}},Eh=e=>bh(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e),bh=e=>"buffer"in e&&"byteOffset"in e&&"byteLength"in e,Ih=(e,t)=>Object.fromEntries(t.map(n=>[n,_h(e,n)])),_h=(e,t)=>e.encryptedLinks[t],Sh=e=>e.head.map(t=>ot(e,t));function Wt(e,t){return typeof t=="string"?ot(e,t).body.prev:t.body.prev.map(r=>ot(e,r))}var Ct={},zt=({graph:e,depth:t,start:n=e.head,end:r=[],prev:s,hashes:i})=>i?i.reduce((o,a)=>({...o,[a]:Wt(e,a)}),Ct):(s&&(n=Th(s)),t===0?Ct:n.reduce((o,a)=>{const c=Wt(e,a),d=c.filter(u=>!(u in o)).filter(u=>!r.includes(u)),h=zt({graph:e,depth:t?t-1:void 0,start:d,end:r});return{...o,[a]:c,...h}},Ct)),Th=e=>Object.keys(e).flatMap(s=>e[s]).filter(s=>!(s in e)),Sn=e=>{const t={};for(const n of at(e))for(const r of Wt(e,n))t[r]||(t[r]=[]),t[r].push(n);return t},Ah=e=>{const t={},n=Object.keys(e);for(const r of n)for(const s of e[r])t[s]||(t[s]=[]),t[s].push(r);return t},Mh=e=>e.links[e.root],wh=(e,t={})=>{const{comparator:n=ki}=t;let r=Object.values(e.links);const s=Object.fromEntries(r.map(a=>[a.hash,a.body.prev.length])),i=[],o=a=>{i.push(a),r=r.filter(u=>u.hash!==a.hash);const c=wi(e,a.hash);for(const u of c)s[u]--;if(c.length!==1)return;const d=c[0];if(s[d]>0)return;const h=e.links[d];o(h)};for(;r.length>0;){const c=r.filter(d=>s[d.hash]===0).sort(n).shift();o(c)}return i},ki=(e,t)=>e.hash<t.hash?-1:e.hash>t.hash?1:0,Li=(e,t=xi)=>{const{sort:n=ki,filter:r=Rh}=t(e);return wh(e,{comparator:n}).map(i=>{const o=i.isInvalid??!r(i);return{...i,isInvalid:o}})},xi=e=>({}),Rh=e=>!0,Ze=(e,t)=>e===void 0||t===void 0||e.length!==t.length?!1:(e.sort(),t.sort(),e.every((n,r)=>n===t[r])),Ci=(e,t)=>{if(e.root!==t.root)throw new Error("Cannot merge two graphs with different roots");const n={...t.links,...e.links},r={...t.encryptedLinks,...e.encryptedLinks},i=gn([...e.head,...t.head]).filter(Oh(n)),o={root:e.root,head:i,encryptedLinks:r,links:n};return o.head=o.head.sort(),o},Oh=e=>t=>!Object.values(e).some(kh(t)),kh=e=>t=>t.body.prev.includes(e),Lh=e=>{const{head:t,root:n,encryptedLinks:r}=e,s=Sn(e);return{head:t,root:n,encryptedLinks:r,childMap:s}},xh=e=>on(Lh(e)),Ch=(e,t)=>{const n=an(e);return _n({encryptedGraph:n,keys:t})},{SIGNATURE:Dh,ENCRYPTION:$h,SYMMETRIC:Nh}=Ti,q=(e,t=Te())=>{const{type:n,name:r=n}=e,s=us(`${r}:${n}:${t}`);return{type:n,name:r,generation:0,signature:ae.keyPair(J(Dh,s).slice(0,32)),encryption:Z.keyPair(J($h,s).slice(0,32)),secretKey:J(Nh,s)}},Kh=e=>{let t;for(const n in e){const r=e[n];(t===void 0||r.generation>t.generation)&&(t=r)}return t},X=e=>mh(e)?{type:e.type,name:e.name,generation:e.generation,encryption:e.encryption.publicKey,signature:e.signature.publicKey}:e,Ph=class extends Error{name;details;constructor(t,n){super(),this.message=t,this.details=n}},Bh={validateHash(e,t){const{hash:n}=e,{encryptedBody:r}=t.encryptedLinks[n],s=Be(r);return n===s?pe:Y("The hash calculated for this link does not match.",{link:e,hash:n,expected:s})},validatePrev(e,t){for(const n of e.body.prev)if(!(n in t.links))return Y("The link referenced by one of the hashes in the `prev` property does not exist.");return pe},validateRoot(e,t){const n=e.body.prev.length===0,r="type"in e.body&&e.body.type===_t,s=Mh(t)===e;return n===s&&s===r?pe:Y(r?n?"The ROOT link has to be the link referenced by the graph `root` property":"The ROOT link cannot have any predecessors":n?"Non-ROOT links must have predecessors":"The link referenced by the graph `root` property must be a ROOT link",{link:e,graph:t})},validateTimestamps(e,t){const{timestamp:n}=e.body,r=Date.now();if(n>r)return Y("The link's timestamp is in the future.",{link:e,now:r});for(const s of e.body.prev){const i=t.links[s];if(i.body.timestamp>n)return Y("This link's timestamp can't be earlier than a previous link.",{link:e,prevLink:i})}return pe}},Y=(e,t)=>({isValid:!1,error:new Ph(e,t)}),Hh=e=>{const t={},n=(r,s)=>`${J("memoize",r)}:${J("memoize",s)}`;for(const r in e)t[r]=z(e[r],n);return t},jh=Hh(Bh),Tn=(e,t={})=>{{const o=e.root,a=e.encryptedLinks[o],c=Be(a.encryptedBody);if(c!==o)return Y("Root hash does not match the hash of the root link",{rootHash:o,computedHash:c,rootLink:a})}for(const o of e.head){const a=e.encryptedLinks[o],c=Be(a.encryptedBody);if(c!==o)return Y("Head hash does not match the hash of the head link",{headHash:o,computedHash:c,headLink:a})}const n=Object.keys(e.encryptedLinks),r=Object.keys(e.links);if(n.length!==r.length)return Y("Number of encrypted links does not match number of links",{encryptedLinkHashes:n,linkHashes:r});const i=((...o)=>a=>{const c=Vh(o);for(const d in c){const h=c[d];try{const u=h(a,e);if(!u.isValid)return u}catch(u){const{message:l}=u;return Y(l,u)}}return pe})(jh,t);for(const o of Object.values(e.links)){const a=i(o);if(!a.isValid)return a}return pe},Vh=e=>e.reduce((t,n)=>Object.assign(t,n),{}),Di=({initialState:e,reducer:t,resolver:n,validators:r})=>s=>(Tn(s,r),Li(s,n).reduce(t,e)),Uh=class extends mt{user;context;initialState;reducer;resolver;validators;keyring;graph;state;constructor({user:e,context:t={},graph:n,rootPayload:r,initialState:s={},reducer:i,validators:o,resolver:a=xi,keys:c}){super(),n===void 0?(b(St(c),"If no graph is provided, only pass a single keyset, not a keyring."),this.graph=ph({user:e,rootPayload:r,keys:c})):Gh(n)?this.graph=n:(b(c),this.graph=Ch(n,c)),this.context=t,this.initialState=s,this.reducer=i,this.validators=o,this.resolver=a,this.user=e,this.keyring=Ae(c),this.updateState()}getState(){return this.state}getGraph(){return this.graph}save(){return xh(this.graph)}dispatch(e,t){const n={payload:void 0,...e};if(t===void 0){const s=this.graph.head.sort()[0],i=this.graph.encryptedLinks[s].recipientPublicKey;t=this.keyring[i]}else this.keyring[t.encryption.publicKey]=t;this.graph=Mi({graph:this.graph,action:n,user:this.user,keys:t,context:this.context});const[r]=Sh(this.graph);return this.state=this.reducer(this.state,r),this.emit("updated",{head:this.graph.head}),e}merge(e){this.graph=Ci(this.graph,e),this.updateState()}validate(){return Tn(this.graph,this.validators)}updateState(){const e=Di({initialState:this.initialState,reducer:this.reducer,resolver:this.resolver,validators:this.validators});this.state=e(this.graph),this.emit("updated",{head:this.graph.head})}},Gh=e=>e?.hasOwnProperty("root"),Cr=e=>new Uh(e),Fh=(e,t)=>{const n={root:e.root,head:e.head},{their:r,our:s,lastCommonHead:i}=t,o={...t},a=e.head,c=r.head;if(s.reportedError)return n.error=s.reportedError,delete s.reportedError,[o,n];if(Ze(a,i))return[o,void 0];if(Ze(a,c))return o.lastCommonHead=a,[o,n];const u=Object.fromEntries([...c,...c.flatMap(v=>He(e,v)),...i,...i.flatMap(v=>He(e,v)),...Object.keys(r.parentMap),...s.links].map(v=>[v,!0]));let l=[];if(c.length>0&&c.every(v=>v in e.links))l=at(e).filter(v=>!(v in u));else{if(r.parentMap){const v={...e.encryptedLinks,...r.encryptedLinks};n.need=Object.keys(u).filter(I=>!(I in v)),l=at(e).filter(I=>!(I in u))}Ze(a,s.parentMapAtHead)||(n.parentMap=zt({graph:e,end:i}),o.our.parentMapAtHead=a)}const m=r.need.concat(l);if(m.length>0){n.links=Ih(e,m);const v=zt({graph:e,hashes:m});n.parentMap={...n.parentMap,...v}}return o.our.links=s.links.concat(m),o.their.need=[],[o,n]},Dr=()=>({their:{head:[],encryptedLinks:{},need:[],parentMap:{}},our:{head:[],links:[]},lastCommonHead:[],failedSyncCount:0}),Yh=(e,t,n,r,s=_n)=>{const i=Ae(r),o=n;b(e.root===o.root,"Can't sync graphs with different roots");const a={...t,their:{head:o.head,need:o.need??[],encryptedLinks:{...t.their.encryptedLinks,...o.links},parentMap:{...t.their.parentMap,...o.parentMap}}};if(Object.keys(a.their.encryptedLinks).length>0){const{head:c}=o,d=Sn(e),h=Ah(a.their.parentMap),u={...d,...h},l={...e.encryptedLinks,...a.their.encryptedLinks},p={...e,head:c,encryptedLinks:l,childMap:u},y=s({encryptedGraph:p,keys:i}),m=Ci(e,y),v=Tn(m);v.isValid?e=m:(a.failedSyncCount+=1,a.our.reportedError=v.error),a.their.encryptedLinks={},a.their.parentMap={}}return[e,a]},Bp=(e,t=In(),n=Te())=>({userName:e,userId:t,keys:q({type:vh.USER,name:t},n)}),Wh=e=>{const{userId:t,userName:n}=e;return{userId:t,userName:n,keys:X(e.keys)}};function zh(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof sr<"u")return sr}function qh(){const e=zh();if(e.__xstate__)return e.__xstate__}const Jh=e=>{if(typeof window>"u")return;const t=qh();t&&t.register(e)};class $r{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const n={value:t,next:null};if(this._current){this._last.next=n,this._last=n;return}this._current=n,this._last=n,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const $i=".",Xh="",Ni="",Zh="#",Qh="*",Ki="xstate.init",qt="xstate.stop";function el(e,t){return{type:`xstate.after.${e}.${t}`}}function Jt(e,t){return{type:`xstate.done.state.${e}`,output:t}}function tl(e,t){return{type:`xstate.done.actor.${e}`,output:t}}function nl(e,t){return{type:`xstate.error.actor.${e}`,error:t}}function Pi(e){return{type:Ki,input:e}}function U(e){setTimeout(()=>{throw e})}const rl=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Nr(e,t){return`${e.sessionId}.${t}`}let sl=0;function il(e,t){const n=new Map,r=new Map,s=new WeakMap,i=new Set,o={},a=t.clock,c={schedule:(u,l,p,y,m=Math.random().toString(36).slice(2))=>{const v={source:u,target:l,event:p,delay:y,id:m,startedAt:Date.now()},I=Nr(u,m);h._snapshot._scheduledEvents[I]=v;const R=a.setTimeout(()=>{delete o[I],delete h._snapshot._scheduledEvents[I],h._relay(u,l,p)},y);o[I]=R},cancel:(u,l)=>{const p=Nr(u,l),y=o[p];delete o[p],delete h._snapshot._scheduledEvents[p],a.clearTimeout(y)},cancelAll:u=>{for(const l in h._snapshot._scheduledEvents){const p=h._snapshot._scheduledEvents[l];p.source===u&&c.cancel(u,p.id)}}},d=u=>{if(!i.size)return;const l={...u,rootId:e.sessionId};i.forEach(p=>p.next?.(l))},h={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${sl++}`,_register:(u,l)=>(n.set(u,l),u),_unregister:u=>{n.delete(u.sessionId);const l=s.get(u);l!==void 0&&(r.delete(l),s.delete(u))},get:u=>r.get(u),_set:(u,l)=>{const p=r.get(u);if(p&&p!==l)throw new Error(`Actor with system ID '${u}' already exists.`);r.set(u,l),s.set(l,u)},inspect:u=>{i.add(u)},_sendInspectionEvent:d,_relay:(u,l,p)=>{h._sendInspectionEvent({type:"@xstate.event",sourceRef:u,actorRef:l,event:p}),l._send(p)},scheduler:c,getSnapshot:()=>({_scheduledEvents:{...h._snapshot._scheduledEvents}}),start:()=>{const u=h._snapshot._scheduledEvents;h._snapshot._scheduledEvents={};for(const l in u){const{source:p,target:y,event:m,delay:v,id:I}=u[l];c.schedule(p,y,m,v,I)}}};return h}function Bi(e,t){const n=Kr(e),r=Kr(t);return typeof r=="string"?typeof n=="string"?r===n:!1:typeof n=="string"?n in r:Object.keys(n).every(s=>s in r?Bi(n[s],r[s]):!1)}function An(e){if(ji(e))return e;let t=[],n="";for(let r=0;r<e.length;r++){switch(e.charCodeAt(r)){case 92:n+=e[r+1],r++;continue;case 46:t.push(n),n="";continue}n+=e[r]}return t.push(n),t}function Kr(e){if(Kl(e))return e.value;if(typeof e!="string")return e;const t=An(e);return ol(t)}function ol(e){if(e.length===1)return e[0];const t={};let n=t;for(let r=0;r<e.length-1;r++)if(r===e.length-2)n[e[r]]=e[r+1];else{const s=n;n={},s[e[r]]=n}return t}function Pr(e,t){const n={},r=Object.keys(e);for(let s=0;s<r.length;s++){const i=r[s];n[i]=t(e[i],i,e,s)}return n}function Hi(e){return ji(e)?e:[e]}function W(e){return e===void 0?[]:Hi(e)}function Xt(e,t,n,r){return typeof e=="function"?e({context:t,event:n,self:r}):e}function ji(e){return Array.isArray(e)}function al(e){return e.type.startsWith("xstate.error.actor")}function fe(e){return Hi(e).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function Vi(e){if(!(e===void 0||e===Xh))return W(e)}function Br(e,t,n){const r=typeof e=="object",s=r?e:void 0;return{next:(r?e.next:e)?.bind(s),error:(r?e.error:t)?.bind(s),complete:(r?e.complete:n)?.bind(s)}}function Hr(e,t){return`${t}.${e}`}function Mn(e,t){const n=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!n)return e.implementations.actors[t];const[,r,s]=n,o=e.getStateNodeById(s).config.invoke;return(Array.isArray(o)?o[r]:o).src}const wn=1;let L=function(e){return e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped",e}({});const cl={clock:{setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e)},logger:console.log.bind(console),devTools:!1};class dl{constructor(t,n){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new $r(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=L.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const r={...cl,...n},{clock:s,logger:i,parent:o,syncSnapshot:a,id:c,systemId:d,inspect:h}=r;this.system=o?o.system:il(this,{clock:s}),h&&!o&&this.system.inspect(Br(h)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=i,this.clock=s,this._parent=o,this._syncSnapshot=a,this.options=r,this.src=r.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:u=>{this._deferred.push(u)},system:this.system,stopChild:u=>{if(u._parent!==this)throw new Error(`Cannot stop child actor ${u.id} of ${this.id} because it is not a child`);u._stop()},emit:u=>{const l=this.eventListeners.get(u.type);if(l)for(const p of Array.from(l))p(u)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),d&&(this._systemId=d,this.system._set(d,this)),this._initState(n?.snapshot??n?.state),d&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(n){this._snapshot={status:"error",output:void 0,error:n}}}update(t,n){this._snapshot=t;let r;for(;r=this._deferred.shift();)try{r()}catch(s){this._deferred.length=0,this._snapshot={...t,status:"error",error:s}}switch(this._snapshot.status){case"active":for(const s of this.observers)try{s.next?.(t)}catch(i){U(i)}break;case"done":for(const s of this.observers)try{s.next?.(t)}catch(i){U(i)}this._stopProcedure(),this._complete(),this._doneEvent=tl(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:n,snapshot:t})}subscribe(t,n,r){const s=Br(t,n,r);if(this._processingStatus!==L.Stopped)this.observers.add(s);else switch(this._snapshot.status){case"done":try{s.complete?.()}catch(i){U(i)}break;case"error":{const i=this._snapshot.error;if(!s.error)U(i);else try{s.error(i)}catch(o){U(o)}break}}return{unsubscribe:()=>{this.observers.delete(s)}}}on(t,n){let r=this.eventListeners.get(t);r||(r=new Set,this.eventListeners.set(t,r));const s=n.bind(void 0);return r.add(s),{unsubscribe:()=>{r.delete(s)}}}start(){if(this._processingStatus===L.Running)return this;this._syncSnapshot&&this.subscribe({next:r=>{r.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:r})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=L.Running;const t=Pi(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(r){return this._snapshot={...this._snapshot,status:"error",error:r},this._error(r),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let n,r;try{n=this.logic.transition(this._snapshot,t,this._actorScope)}catch(s){r={err:s}}if(r){const{err:s}=r;this._snapshot={...this._snapshot,status:"error",error:s},this._error(s);return}this.update(n,t),t.type===qt&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===L.Stopped?this:(this.mailbox.clear(),this._processingStatus===L.NotStarted?(this._processingStatus=L.Stopped,this):(this.mailbox.enqueue({type:qt}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(const t of this.observers)try{t.complete?.()}catch(n){U(n)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||U(t);return}let n=!1;for(const r of this.observers){const s=r.error;n||=!s;try{s?.(t)}catch(i){U(i)}}this.observers.clear(),n&&U(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,nl(this.id,t))}_stopProcedure(){return this._processingStatus!==L.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new $r(this._process.bind(this)),this._processingStatus=L.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==L.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:Jh)(this)}toJSON(){return{xstate$$type:wn,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[rl](){return this}getSnapshot(){return this._snapshot}}function je(e,...[t]){return new dl(e,t)}function ul(e,t,n,r,{sendId:s}){const i=typeof s=="function"?s(n,r):s;return[t,i]}function hl(e,t){e.defer(()=>{e.system.scheduler.cancel(e.self,t)})}function ll(e){function t(n,r){}return t.type="xstate.cancel",t.sendId=e,t.resolve=ul,t.execute=hl,t}function fl(e,t,n,r,{id:s,systemId:i,src:o,input:a,syncSnapshot:c}){const d=typeof o=="string"?Mn(t.machine,o):o,h=typeof s=="function"?s(n):s;let u;return d&&(u=je(d,{id:h,src:o,parent:e.self,syncSnapshot:c,systemId:i,input:typeof a=="function"?a({context:t.context,event:n.event,self:e.self}):a})),[ce(t,{children:{...t.children,[h]:u}}),{id:s,actorRef:u}]}function pl(e,{id:t,actorRef:n}){n&&e.defer(()=>{n._processingStatus!==L.Stopped&&n.start()})}function yl(...[e,{id:t,systemId:n,input:r,syncSnapshot:s=!1}={}]){function i(o,a){}return i.type="snapshot.spawnChild",i.id=t,i.systemId=n,i.src=e,i.input=r,i.syncSnapshot=s,i.resolve=fl,i.execute=pl,i}function vl(e,t,n,r,{actorRef:s}){const i=typeof s=="function"?s(n,r):s,o=typeof i=="string"?t.children[i]:i;let a=t.children;return o&&(a={...a},delete a[o.id]),[ce(t,{children:a}),o]}function ml(e,t){if(t){if(e.system._unregister(t),t._processingStatus!==L.Running){e.stopChild(t);return}e.defer(()=>{e.stopChild(t)})}}function Ui(e){function t(n,r){}return t.type="xstate.stopChild",t.actorRef=e,t.resolve=vl,t.execute=ml,t}function gl(e,{context:t,event:n},{guards:r}){return r.every(s=>Tt(s,t,n,e))}function jr(e){function t(n,r){return!1}return t.check=gl,t.guards=e,t}function Tt(e,t,n,r){const{machine:s}=r,i=typeof e=="function",o=i?e:s.implementations.guards[typeof e=="string"?e:e.type];if(!i&&!o)throw new Error(`Guard '${typeof e=="string"?e:e.type}' is not implemented.'.`);if(typeof o!="function")return Tt(o,t,n,r);const a={context:t,event:n},c=i||typeof e=="string"?void 0:"params"in e?typeof e.params=="function"?e.params({context:t,event:n}):e.params:void 0;return"check"in o?o.check(r,a,o):o(a,c)}const Rn=e=>e.type==="atomic"||e.type==="final";function be(e){return Object.values(e.states).filter(t=>t.type!=="history")}function We(e,t){const n=[];if(t===e)return n;let r=e.parent;for(;r&&r!==t;)n.push(r),r=r.parent;return n}function ct(e){const t=new Set(e),n=Fi(t);for(const r of t)if(r.type==="compound"&&(!n.get(r)||!n.get(r).length))Vr(r).forEach(s=>t.add(s));else if(r.type==="parallel"){for(const s of be(r))if(s.type!=="history"&&!t.has(s)){const i=Vr(s);for(const o of i)t.add(o)}}for(const r of t){let s=r.parent;for(;s;)t.add(s),s=s.parent}return t}function Gi(e,t){const n=t.get(e);if(!n)return{};if(e.type==="compound"){const s=n[0];if(s){if(Rn(s))return s.key}else return{}}const r={};for(const s of n)r[s.key]=Gi(s,t);return r}function Fi(e){const t=new Map;for(const n of e)t.has(n)||t.set(n,[]),n.parent&&(t.has(n.parent)||t.set(n.parent,[]),t.get(n.parent).push(n));return t}function Yi(e,t){const n=ct(t);return Gi(e,Fi(n))}function On(e,t){return t.type==="compound"?be(t).some(n=>n.type==="final"&&e.has(n)):t.type==="parallel"?be(t).every(n=>On(e,n)):t.type==="final"}const At=e=>e[0]===Zh;function El(e,t){return e.transitions.get(t)||[...e.transitions.keys()].filter(r=>{if(r===Qh)return!0;if(!r.endsWith(".*"))return!1;const s=r.split("."),i=t.split(".");for(let o=0;o<s.length;o++){const a=s[o],c=i[o];if(a==="*")return o===s.length-1;if(a!==c)return!1}return!0}).sort((r,s)=>s.length-r.length).flatMap(r=>e.transitions.get(r))}function bl(e){const t=e.config.after;if(!t)return[];const n=(s,i)=>{const o=el(s,e.id),a=o.type;return e.entry.push(Yl(o,{id:a,delay:s})),e.exit.push(ll(a)),a};return Object.keys(t).flatMap((s,i)=>{const o=t[s],a=typeof o=="string"?{target:o}:o,c=Number.isNaN(+s)?s:+s,d=n(c);return W(a).map(h=>({...h,event:d,delay:c}))}).map(s=>{const{delay:i}=s;return{...se(e,s.event,s),delay:i}})}function se(e,t,n){const r=Vi(n.target),s=n.reenter??!1,i=Sl(e,r),o={...n,actions:W(n.actions),guard:n.guard,target:i,source:e,reenter:s,eventType:t,toJSON:()=>({...o,source:`#${e.id}`,target:i?i.map(a=>`#${a.id}`):void 0})};return o}function Il(e){const t=new Map;if(e.config.on)for(const n of Object.keys(e.config.on)){if(n===Ni)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const r=e.config.on[n];t.set(n,fe(r).map(s=>se(e,n,s)))}if(e.config.onDone){const n=`xstate.done.state.${e.id}`;t.set(n,fe(e.config.onDone).map(r=>se(e,n,r)))}for(const n of e.invoke){if(n.onDone){const r=`xstate.done.actor.${n.id}`;t.set(r,fe(n.onDone).map(s=>se(e,r,s)))}if(n.onError){const r=`xstate.error.actor.${n.id}`;t.set(r,fe(n.onError).map(s=>se(e,r,s)))}if(n.onSnapshot){const r=`xstate.snapshot.${n.id}`;t.set(r,fe(n.onSnapshot).map(s=>se(e,r,s)))}}for(const n of e.after){let r=t.get(n.eventType);r||(r=[],t.set(n.eventType,r)),r.push(n)}return t}function _l(e,t){const n=typeof t=="string"?e.states[t]:t?e.states[t.target]:void 0;if(!n&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${e.id}`);const r={source:e,actions:!t||typeof t=="string"?[]:W(t.actions),eventType:null,reenter:!1,target:n?[n]:[],toJSON:()=>({...r,source:`#${e.id}`,target:n?[`#${n.id}`]:[]})};return r}function Sl(e,t){if(t!==void 0)return t.map(n=>{if(typeof n!="string")return n;if(At(n))return e.machine.getStateNodeById(n);const r=n[0]===$i;if(r&&!e.parent)return dt(e,n.slice(1));const s=r?e.key+n:n;if(e.parent)try{return dt(e.parent,s)}catch(i){throw new Error(`Invalid transition definition for state node '${e.id}':
${i.message}`)}else throw new Error(`Invalid target: "${n}" is not a valid target from the root node. Did you mean ".${n}"?`)})}function Wi(e){const t=Vi(e.config.target);return t?{target:t.map(n=>typeof n=="string"?dt(e.parent,n):n)}:e.parent.initial}function ie(e){return e.type==="history"}function Vr(e){const t=zi(e);for(const n of t)for(const r of We(n,e))t.add(r);return t}function zi(e){const t=new Set;function n(r){if(!t.has(r)){if(t.add(r),r.type==="compound")n(r.initial.target[0]);else if(r.type==="parallel")for(const s of be(r))n(s)}}return n(e),t}function Ie(e,t){if(At(t))return e.machine.getStateNodeById(t);if(!e.states)throw new Error(`Unable to retrieve child state '${t}' from '${e.id}'; no child states exist.`);const n=e.states[t];if(!n)throw new Error(`Child state '${t}' does not exist on '${e.id}'`);return n}function dt(e,t){if(typeof t=="string"&&At(t))try{return e.machine.getStateNodeById(t)}catch{}const n=An(t).slice();let r=e;for(;n.length;){const s=n.shift();if(!s.length)break;r=Ie(r,s)}return r}function ut(e,t){if(typeof t=="string"){const s=e.states[t];if(!s)throw new Error(`State '${t}' does not exist on '${e.id}'`);return[e,s]}const n=Object.keys(t),r=n.map(s=>Ie(e,s)).filter(Boolean);return[e.machine.root,e].concat(r,n.reduce((s,i)=>{const o=Ie(e,i);if(!o)return s;const a=ut(o,t[i]);return s.concat(a)},[]))}function Tl(e,t,n,r){const i=Ie(e,t).next(n,r);return!i||!i.length?e.next(n,r):i}function Al(e,t,n,r){const s=Object.keys(t),i=Ie(e,s[0]),o=kn(i,t[s[0]],n,r);return!o||!o.length?e.next(n,r):o}function Ml(e,t,n,r){const s=[];for(const i of Object.keys(t)){const o=t[i];if(!o)continue;const a=Ie(e,i),c=kn(a,o,n,r);c&&s.push(...c)}return s.length?s:e.next(n,r)}function kn(e,t,n,r){return typeof t=="string"?Tl(e,t,n,r):Object.keys(t).length===1?Al(e,t,n,r):Ml(e,t,n,r)}function wl(e){return Object.keys(e.states).map(t=>e.states[t]).filter(t=>t.type==="history")}function ee(e,t){let n=e;for(;n.parent&&n.parent!==t;)n=n.parent;return n.parent===t}function Rl(e,t){const n=new Set(e),r=new Set(t);for(const s of n)if(r.has(s))return!0;for(const s of r)if(n.has(s))return!0;return!1}function qi(e,t,n){const r=new Set;for(const s of e){let i=!1;const o=new Set;for(const a of r)if(Rl(Zt([s],t,n),Zt([a],t,n)))if(ee(s.source,a.source))o.add(a);else{i=!0;break}if(!i){for(const a of o)r.delete(a);r.add(s)}}return Array.from(r)}function Ol(e){const[t,...n]=e;for(const r of We(t,void 0))if(n.every(s=>ee(s,r)))return r}function Ln(e,t){if(!e.target)return[];const n=new Set;for(const r of e.target)if(ie(r))if(t[r.id])for(const s of t[r.id])n.add(s);else for(const s of Ln(Wi(r),t))n.add(s);else n.add(r);return[...n]}function Ji(e,t){const n=Ln(e,t);if(!n)return;if(!e.reenter&&n.every(s=>s===e.source||ee(s,e.source)))return e.source;const r=Ol(n.concat(e.source));if(r)return r;if(!e.reenter)return e.source.machine.root}function Zt(e,t,n){const r=new Set;for(const s of e)if(s.target?.length){const i=Ji(s,n);s.reenter&&s.source===i&&r.add(i);for(const o of t)ee(o,i)&&r.add(o)}return[...r]}function kl(e,t){if(e.length!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function Qt(e,t,n,r,s,i){if(!e.length)return t;const o=new Set(t._nodes);let a=t.historyValue;const c=qi(e,o,a);let d=t;s||([d,a]=Dl(d,r,n,c,o,a,i)),d=_e(d,r,n,c.flatMap(u=>u.actions),i),d=xl(d,r,n,c,o,i,a,s);const h=[...o];d.status==="done"&&(d=_e(d,r,n,h.sort((u,l)=>l.order-u.order).flatMap(u=>u.exit),i));try{return a===t.historyValue&&kl(t._nodes,o)?d:ce(d,{_nodes:h,historyValue:a})}catch(u){throw u}}function Ll(e,t,n,r,s){if(r.output===void 0)return;const i=Jt(s.id,s.output!==void 0&&s.parent?Xt(s.output,e.context,t,n.self):void 0);return Xt(r.output,e.context,i,n.self)}function xl(e,t,n,r,s,i,o,a){let c=e;const d=new Set,h=new Set;Cl(r,o,h,d),a&&h.add(e.machine.root);const u=new Set;for(const l of[...d].sort((p,y)=>p.order-y.order)){s.add(l);const p=[];p.push(...l.entry);for(const y of l.invoke)p.push(yl(y.src,{...y,syncSnapshot:!!y.onSnapshot}));if(h.has(l)){const y=l.initial.actions;p.push(...y)}if(c=_e(c,t,n,p,i,l.invoke.map(y=>y.id)),l.type==="final"){const y=l.parent;let m=y?.type==="parallel"?y:y?.parent,v=m||l;for(y?.type==="compound"&&i.push(Jt(y.id,l.output!==void 0?Xt(l.output,c.context,t,n.self):void 0));m?.type==="parallel"&&!u.has(m)&&On(s,m);)u.add(m),i.push(Jt(m.id)),v=m,m=m.parent;if(m)continue;c=ce(c,{status:"done",output:Ll(c,t,n,c.machine.root,v)})}}return c}function Cl(e,t,n,r){for(const s of e){const i=Ji(s,t);for(const a of s.target||[])!ie(a)&&(s.source!==a||s.source!==i||s.reenter)&&(r.add(a),n.add(a)),ye(a,t,n,r);const o=Ln(s,t);for(const a of o){const c=We(a,i);i?.type==="parallel"&&c.push(i),Xi(r,t,n,c,!s.source.parent&&s.reenter?void 0:i)}}}function ye(e,t,n,r){if(ie(e))if(t[e.id]){const s=t[e.id];for(const i of s)r.add(i),ye(i,t,n,r);for(const i of s)Dt(i,e.parent,r,t,n)}else{const s=Wi(e);for(const i of s.target)r.add(i),s===e.parent?.initial&&n.add(e.parent),ye(i,t,n,r);for(const i of s.target)Dt(i,e.parent,r,t,n)}else if(e.type==="compound"){const[s]=e.initial.target;ie(s)||(r.add(s),n.add(s)),ye(s,t,n,r),Dt(s,e,r,t,n)}else if(e.type==="parallel")for(const s of be(e).filter(i=>!ie(i)))[...r].some(i=>ee(i,s))||(ie(s)||(r.add(s),n.add(s)),ye(s,t,n,r))}function Xi(e,t,n,r,s){for(const i of r)if((!s||ee(i,s))&&e.add(i),i.type==="parallel")for(const o of be(i).filter(a=>!ie(a)))[...e].some(a=>ee(a,o))||(e.add(o),ye(o,t,n,e))}function Dt(e,t,n,r,s){Xi(n,r,s,We(e,t))}function Dl(e,t,n,r,s,i,o){let a=e;const c=Zt(r,s,i);c.sort((h,u)=>u.order-h.order);let d;for(const h of c)for(const u of wl(h)){let l;u.history==="deep"?l=p=>Rn(p)&&ee(p,h):l=p=>p.parent===h,d??={...i},d[u.id]=Array.from(s).filter(l)}for(const h of c)a=_e(a,t,n,[...h.exit,...h.invoke.map(u=>Ui(u.id))],o),s.delete(h);return[a,d||i]}function Zi(e,t,n,r,s,i){const{machine:o}=e;let a=e;for(const c of r){let p=function(){n.system._sendInspectionEvent({type:"@xstate.action",actorRef:n.self,action:{type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",params:l}}),h(u,l)};const d=typeof c=="function",h=d?c:o.implementations.actions[typeof c=="string"?c:c.type];if(!h)continue;const u={context:a.context,event:t,self:n.self,system:n.system},l=d||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:t}):c.params:void 0;if(!("resolve"in h)){n.self._processingStatus===L.Running?p():n.defer(()=>{p()});continue}const y=h,[m,v,I]=y.resolve(n,a,u,l,h,s);a=m,"retryResolve"in y&&i?.push([y,v]),"execute"in y&&(n.self._processingStatus===L.Running?y.execute(n,v):n.defer(y.execute.bind(null,n,v))),I&&(a=Zi(a,t,n,I,s,i))}return a}function _e(e,t,n,r,s,i){const o=i?[]:void 0,a=Zi(e,t,n,r,{internalQueue:s,deferredActorIds:i},o);return o?.forEach(([c,d])=>{c.retryResolve(n,a,d)}),a}function $t(e,t,n,r=[]){let s=e;const i=[];function o(d,h,u){n.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:n.self,event:h,snapshot:d,_transitions:u}),i.push(d)}if(t.type===qt)return s=ce(Ur(s,t,n),{status:"stopped"}),o(s,t,[]),{snapshot:s,microstates:i};let a=t;if(a.type!==Ki){const d=a,h=al(d),u=Gr(d,s);if(h&&!u.length)return s=ce(e,{status:"error",error:d.error}),o(s,d,[]),{snapshot:s,microstates:i};s=Qt(u,e,n,a,!1,r),o(s,d,u)}let c=!0;for(;s.status==="active";){let d=c?$l(s,a):[];const h=d.length?s:void 0;if(!d.length){if(!r.length)break;a=r.shift(),d=Gr(a,s)}s=Qt(d,s,n,a,!1,r),c=s!==h,o(s,a,d)}return s.status!=="active"&&Ur(s,a,n),{snapshot:s,microstates:i}}function Ur(e,t,n){return _e(e,t,n,Object.values(e.children).map(r=>Ui(r)),[])}function Gr(e,t){return t.machine.getTransitionData(t,e)}function $l(e,t){const n=new Set,r=e._nodes.filter(Rn);for(const s of r)e:for(const i of[s].concat(We(s,void 0)))if(i.always){for(const o of i.always)if(o.guard===void 0||Tt(o.guard,e.context,t,e)){n.add(o);break e}}return qi(Array.from(n),new Set(e._nodes),e.historyValue)}function Nl(e,t){const n=ct(ut(e,t));return Yi(e,[...n])}function Kl(e){return!!e&&typeof e=="object"&&"machine"in e&&"value"in e}const Pl=function(t){return Bi(t,this.value)},Bl=function(t){return this.tags.has(t)},Hl=function(t){const n=this.machine.getTransitionData(this,t);return!!n?.length&&n.some(r=>r.target!==void 0||r.actions.length)},jl=function(){const{_nodes:t,tags:n,machine:r,getMeta:s,toJSON:i,can:o,hasTag:a,matches:c,...d}=this;return{...d,tags:Array.from(n)}},Vl=function(){return this._nodes.reduce((t,n)=>(n.meta!==void 0&&(t[n.id]=n.meta),t),{})};function Qe(e,t){return{status:e.status,output:e.output,error:e.error,machine:t,context:e.context,_nodes:e._nodes,value:Yi(t.root,e._nodes),tags:new Set(e._nodes.flatMap(n=>n.tags)),children:e.children,historyValue:e.historyValue||{},matches:Pl,hasTag:Bl,can:Hl,getMeta:Vl,toJSON:jl}}function ce(e,t={}){return Qe({...e,...t},e.machine)}function Ul(e,t){const{_nodes:n,tags:r,machine:s,children:i,context:o,can:a,hasTag:c,matches:d,getMeta:h,toJSON:u,...l}=e,p={};for(const m in i){const v=i[m];p[m]={snapshot:v.getPersistedSnapshot(t),src:v.src,systemId:v._systemId,syncSnapshot:v._syncSnapshot}}return{...l,context:Qi(o),children:p}}function Qi(e){let t;for(const n in e){const r=e[n];if(r&&typeof r=="object")if("sessionId"in r&&"send"in r&&"ref"in r)t??=Array.isArray(e)?e.slice():{...e},t[n]={xstate$$type:wn,id:r.id};else{const s=Qi(r);s!==r&&(t??=Array.isArray(e)?e.slice():{...e},t[n]=s)}}return t??e}function Gl(e,t,n,r,{event:s,id:i,delay:o},{internalQueue:a}){const c=t.machine.implementations.delays;if(typeof s=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${s}" }) instead`);const d=typeof s=="function"?s(n,r):s;let h;if(typeof o=="string"){const u=c&&c[o];h=typeof u=="function"?u(n,r):u}else h=typeof o=="function"?o(n,r):o;return typeof h!="number"&&a.push(d),[t,{event:d,id:i,delay:h}]}function Fl(e,t){const{event:n,delay:r,id:s}=t;if(typeof r=="number"){e.defer(()=>{const i=e.self;e.system.scheduler.schedule(i,i,n,r,s)});return}}function Yl(e,t){function n(r,s){}return n.type="xstate.raise",n.event=e,n.id=t?.id,n.delay=t?.delay,n.resolve=Gl,n.execute=Fl,n}function Wl(e,{machine:t,context:n},r,s){const i=(o,a={})=>{const{systemId:c,input:d}=a;if(typeof o=="string"){const h=Mn(t,o);if(!h)throw new Error(`Actor logic '${o}' not implemented in machine '${t.id}'`);const u=je(h,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:typeof d=="function"?d({context:n,event:r,self:e.self}):d,src:o,systemId:c});return s[u.id]=u,u}else return je(o,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:a.input,src:o,systemId:c})};return(o,a)=>{const c=i(o,a);return s[c.id]=c,e.defer(()=>{c._processingStatus!==L.Stopped&&c.start()}),c}}function zl(e,t,n,r,{assignment:s}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const i={},o={context:t.context,event:n.event,spawn:Wl(e,t,n.event,i),self:e.self,system:e.system};let a={};if(typeof s=="function")a=s(o,r);else for(const d of Object.keys(s)){const h=s[d];a[d]=typeof h=="function"?h(o,r):h}const c=Object.assign({},t.context,a);return[ce(t,{context:c,children:Object.keys(i).length?{...t.children,...i}:t.children})]}function C(e){function t(n,r){}return t.type="xstate.assign",t.assignment=e,t.resolve=zl,t}const Fr=new WeakMap;function he(e,t,n){let r=Fr.get(e);return r?t in r||(r[t]=n()):(r={[t]:n()},Fr.set(e,r)),r[t]}const ql={},we=e=>typeof e=="string"?{type:e}:typeof e=="function"?"resolve"in e?{type:e.type}:{type:e.name}:e;class xn{constructor(t,n){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=n._parent,this.key=n._key,this.machine=n._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join($i),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?Pr(this.config.states,(r,s)=>new xn(r,{_parent:this,_key:s,_machine:this.machine})):ql,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=W(this.config.entry).slice(),this.exit=W(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=W(t.tags).slice()}_initialize(){this.transitions=Il(this),this.config.always&&(this.always=fe(this.config.always).map(t=>se(this,Ni,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(we),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(we),eventType:null})}:void 0,history:this.history,states:Pr(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(we)})),entry:this.entry.map(we),exit:this.exit.map(we),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return he(this,"invoke",()=>W(this.config.invoke).map((t,n)=>{const{src:r,systemId:s}=t,i=t.id??Hr(this.id,n),o=typeof r=="string"?r:`xstate.invoke.${Hr(this.id,n)}`;return{...t,src:o,id:i,systemId:s,toJSON(){const{onDone:a,onError:c,...d}=t;return{...d,type:"xstate.invoke",src:o,id:i}}}}))}get on(){return he(this,"on",()=>[...this.transitions].flatMap(([n,r])=>r.map(s=>[n,s])).reduce((n,[r,s])=>(n[r]=n[r]||[],n[r].push(s),n),{}))}get after(){return he(this,"delayedTransitions",()=>bl(this))}get initial(){return he(this,"initial",()=>_l(this,this.config.initial))}next(t,n){const r=n.type,s=[];let i;const o=he(this,`candidates-${r}`,()=>El(this,r));for(const a of o){const{guard:c}=a,d=t.context;let h=!1;try{h=!c||Tt(c,d,n,t)}catch(u){const l=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${l?`'${l}' `:""}in transition for event '${r}' in state node '${this.id}':
${u.message}`)}if(h){s.push(...a.actions),i=a;break}}return i?[i]:void 0}get events(){return he(this,"events",()=>{const{states:t}=this,n=new Set(this.ownEvents);if(t)for(const r of Object.keys(t)){const s=t[r];if(s.states)for(const i of s.events)n.add(`${i}`)}return Array.from(n)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(n=>this.transitions.get(n).some(r=>!(!r.target&&!r.actions.length&&!r.reenter))));return Array.from(t)}}const Jl="#";class Cn{constructor(t,n){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.__TResolvedTypesMeta=void 0,this.id=t.id||"(machine)",this.implementations={actors:n?.actors??{},actions:n?.actions??{},delays:n?.delays??{},guards:n?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new xn(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:n,guards:r,actors:s,delays:i}=this.implementations;return new Cn(this.config,{actions:{...n,...t.actions},guards:{...r,...t.guards},actors:{...s,...t.actors},delays:{...i,...t.delays}})}resolveState(t){const n=Nl(this.root,t.value),r=ct(ut(this.root,n));return Qe({_nodes:[...r],context:t.context||{},children:{},status:On(r,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,n,r){return $t(t,n,r).snapshot}microstep(t,n,r){return $t(t,n,r).microstates}getTransitionData(t,n){return kn(this.root,t.value,t,n)||[]}getPreInitialState(t,n,r){const{context:s}=this.config,i=Qe({context:typeof s!="function"&&s?s:{},_nodes:[this.root],children:{},status:"active"},this);return typeof s=="function"?_e(i,n,t,[C(({spawn:a,event:c,self:d})=>s({spawn:a,input:c.input,self:d}))],r):i}getInitialSnapshot(t,n){const r=Pi(n),s=[],i=this.getPreInitialState(t,r,s),o=Qt([{target:[...zi(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],i,t,r,!0,s),{snapshot:a}=$t(o,r,t,s);return a}start(t){Object.values(t.children).forEach(n=>{n.getSnapshot().status==="active"&&n.start()})}getStateNodeById(t){const n=An(t),r=n.slice(1),s=At(n[0])?n[0].slice(Jl.length):n[0],i=this.idMap.get(s);if(!i)throw new Error(`Child state node '#${s}' does not exist on machine '${this.id}'`);return dt(i,r)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,n){return Ul(t,n)}restoreSnapshot(t,n){const r={},s=t.children;Object.keys(s).forEach(c=>{const d=s[c],h=d.snapshot,u=d.src,l=typeof u=="string"?Mn(this,u):u;if(!l)return;const p=je(l,{id:c,parent:n.self,syncSnapshot:d.syncSnapshot,snapshot:h,src:u,systemId:d.systemId});r[c]=p});const i=Qe({...t,children:r,_nodes:Array.from(ct(ut(this.root,t.value)))},this);let o=new Set;function a(c,d){if(!o.has(c)){o.add(c);for(let h in c){const u=c[h];if(u&&typeof u=="object"){if("xstate$$type"in u&&u.xstate$$type===wn){c[h]=d[u.id];continue}a(u,d)}}}}return a(i.context,r),i}}function Xl(e,t){return new Cn(e,t)}function Zl({schemas:e,actors:t,actions:n,guards:r,delays:s}){return{createMachine:i=>Xl({...i,schemas:e},{actors:t,actions:n,guards:r,delays:s})}}function B(e,t){const n=W(t);if(!n.includes(e.type)){const r=n.length===1?`type "${n[0]}"`:`one of types "${n.join('", "')}"`;throw new Error(`Expected event ${JSON.stringify(e)} to have ${r}`)}}var Ql=Object.defineProperty,Mt=(e,t)=>{for(var n in t)Ql(e,n,{get:t[n],enumerable:!0})},ef={};Mt(ef,{Connection:()=>Lp,DEVICE_REMOVED:()=>Nn,DEVICE_UNKNOWN:()=>Kn,ENCRYPTION_FAILURE:()=>lt,IDENTITY_PROOF_INVALID:()=>Pn,INVITATION_PROOF_INVALID:()=>Bn,JOINED_WRONG_TEAM:()=>Hn,MEMBER_REMOVED:()=>jn,NEITHER_IS_MEMBER:()=>Vn,SERVER_REMOVED:()=>Un,TIMEOUT:()=>Gn,connectionErrors:()=>ho,createErrorMessage:()=>en,isInviteeClaim:()=>me,isInviteeContext:()=>Ot,isInviteeDeviceClaim:()=>kp,isInviteeDeviceContext:()=>ko,isInviteeMemberClaim:()=>xo,isInviteeMemberContext:()=>Qn,isMemberClaim:()=>rn,isMemberContext:()=>Oo,isServerContext:()=>Lo});var eo=e=>{const t=n=>{switch(n.type){case"ADD_MEMBER":return n.payload.member.userId;case"REMOVE_MEMBER":return n.payload.userId;case"ADD_ROLE":return n.payload.roleName;case"ADD_MEMBER_ROLE":case"REMOVE_MEMBER_ROLE":return`${n.payload.roleName}:${n.payload.userId}`;case"ADD_DEVICE":return n.payload.device.deviceName;case"REMOVE_DEVICE":return n.payload.deviceId;case"INVITE_MEMBER":case"INVITE_DEVICE":return n.payload.invitation.id;case"REVOKE_INVITATION":return n.payload.id;case"ADMIT_MEMBER":case"ADMIT_DEVICE":return n.payload.id;case"CHANGE_MEMBER_KEYS":return JSON.stringify(n.payload.keys);default:return JSON.stringify(n.payload)}};return e.body.type==="ROOT"?"ROOT":`${e.body.type}:${t(e.body)}`},to=(e,t)=>{if(!e||!t)return!1;const n=r=>r.sort().join(",");return n(e)===n(t)},no=e=>!["INVITE_DEVICE","ADD_DEVICE","REMOVE_DEVICE","CHANGE_MEMBER_KEYS","CHANGE_SERVER_KEYS","ADMIT_MEMBER","ADMIT_DEVICE"].includes(e.type),tf={};Mt(tf,{ADMIN:()=>K});var K="admin",nf=e=>(t,n)=>{if(Yr(e,t))return-1;if(Yr(e,n))return 1;const r=o=>{const a=d=>d.body.type==="ADD_MEMBER"&&d.body.payload.member.userId===o,c=Object.values(e.links).find(a);return b(c,`Could not find link that added member ${o}`),c},[s,i]=[t,n].map(r);return ih(e,s,i)?-1:1},Yr=(e,t)=>e.links[e.root].body.userId===t,ht=e=>{const t=lh(e).map(r=>r.map(s=>e.links[s])),n=[];for(let r of t)for(const s in Wr){const i=Wr[s],o=i(r,e),a=o.flatMap(c=>ro(r,c));n.push(...o,...a),r=r.filter(Jr(n))}return{filter:Jr(n)}},ro=(e,t)=>{const n=[];switch(t.body.type){case"INVITE_MEMBER":case"INVITE_DEVICE":{const{invitation:s}=t.body.payload;n.push(...e.filter(lf(s)));break}case"ADMIT_MEMBER":{const s=t.body.payload.memberKeys.name;n.push(...e.filter(ao(s)));break}}const r=n.flatMap(s=>ro(e,s));return n.concat(r)},Wr={resolveMutualRemovals(e,t){const n=zr(e),r=oo(e).map($n);return n.length>0&&to(n,r)?e.filter(ao(rf(t,r))):[]},cantAddBackRemovedMember(e){const t=zr(e);return af(e).filter(n=>t.includes(hf(n)))},cantDoAnythingWhenRemoved(e){const t=df(e);return e.filter(qr(t))},cantDoAdminActionsWhenDemoted(e){const t=uf(e),n=qr(t),r=s=>no(s.body);return e.filter(s=>n(s)&&r(s))}},rf=(e,t)=>t.sort(nf(e)).pop(),sf=e=>["ADD_MEMBER","ADD_MEMBER_ROLE","ADMIT_MEMBER"].includes(e.body.type),of=e=>e.body.type==="REMOVE_MEMBER",af=e=>e.filter(sf),so=e=>e.filter(of),cf=e=>e.body.type==="REMOVE_MEMBER_ROLE"&&e.body.payload.roleName===K,io=e=>e.filter(cf),oo=e=>so(e).concat(io(e)),zr=e=>oo(e).map(Dn),df=e=>so(e).map(Dn),uf=e=>io(e).map(Dn),Dn=e=>e.body.payload.userId,$n=e=>e.body.userId,ao=e=>t=>$n(t)===e,qr=e=>t=>e.includes($n(t)),hf=e=>{switch(e.body.type){case"ADD_MEMBER":return e.body.payload.member.userId;case"ADD_MEMBER_ROLE":return e.body.payload.userId;case"ADMIT_MEMBER":return e.body.payload.memberKeys.name}},Jr=e=>t=>!e.includes(t),lf=e=>t=>(t.body.type==="ADMIT_MEMBER"||t.body.type==="ADMIT_DEVICE")&&t.body.payload.id===e.id,Hp=e=>Li(e,ht).filter(n=>!n.isInvalid).map(n=>eo(n)).join(","),ff="SIGNATURE",pf="ENCRYPTION",yf="SYMMETRIC",vf="LINK_HASH",mf="LINK_TO_PREVIOUS",gf="INVITATION",Ef="DEVICE_ID",bf="SHARED_KEY",co={SIGNATURE:ff,ENCRYPTION:pf,SYMMETRIC:yf,LINK_HASH:vf,LINK_TO_PREVIOUS:mf,INVITATION:gf,DEVICE_ID:Ef,SHARED_KEY:bf},D={isValid:!0},If=e=>t=>e.reduce((n,r)=>r(n),t),Xr=e=>({type:e.type,name:e.name}),_f=e=>`${e.recipient.name}(${Sf(e.recipient.publicKey)}):${e.contents.name}#${e.contents.generation}`,Sf=e=>e.slice(0,5),uo=(e,t)=>e.type===t.type&&e.name===t.name,Zr=(e,t)=>{b(uo(e,t),`The scope of the new keys must match those of the old lockbox. 
     New scope: ${JSON.stringify(Xr(e))} 
     Old scope: ${JSON.stringify(Xr(t))}`)},k={GRAPH:"GRAPH",TEAM:"TEAM",ROLE:"ROLE",USER:"USER",DEVICE:"DEVICE",SERVER:"SERVER",EPHEMERAL:"EPHEMERAL"},Tf=class extends Error{constructor(e,t){super(),this.message=e,this.details=t}name;details},Af=(e,t)=>{const n=typeof e=="string"?nr.decode(e):e,r=typeof t=="string"?nr.decode(t):t,s=[n,r].sort(Mf).reduce((o,a)=>new Uint8Array([...o,...a]),new Uint8Array);return(typeof e=="string"?J:Uo)(co.SHARED_KEY,s)},Mf=(e,t)=>{const n=e.toString(),r=t.toString();return n<r?-1:n>r?1:0},Nn="DEVICE_REMOVED",Kn="DEVICE_UNKNOWN",lt="ENCRYPTION_FAILURE",Pn="IDENTITY_PROOF_INVALID",Bn="INVITATION_PROOF_INVALID",Hn="JOINED_WRONG_TEAM",jn="MEMBER_REMOVED",Vn="NEITHER_IS_MEMBER",Un="SERVER_REMOVED",Gn="TIMEOUT",ho={[Nn]:{localMessage:"The peer's device was removed from this team",remoteMessage:"Your device was removed from this team"},[Kn]:{localMessage:"The peer's device isn't listed on this team",remoteMessage:"Your device isn't listed on this team"},[lt]:{localMessage:"Unable to establish a secure connection"},[Pn]:{localMessage:"The peer's proof of identity is not valid",remoteMessage:"Your proof of identity isn't valid"},[Bn]:{localMessage:"The peer's invitation wasn't accepted",remoteMessage:"Your invitation wasn't accepted"},[Hn]:{localMessage:"This isn't the team you were invited to",remoteMessage:"This isn't the team the peer was invited to"},[jn]:{localMessage:"The peer was removed from this team",remoteMessage:"You were removed from this team"},[Vn]:{localMessage:"The peer is also holding an invitation and cannot admit you to the team"},[Un]:{localMessage:"The server was removed from this team",remoteMessage:"You (a server) were removed from this team"},[Gn]:{localMessage:"We didn't hear back from the peer; giving up",remoteMessage:"The peer didn't hear back from you, so they gave up"}},en=(e,t="LOCAL")=>{const{localMessage:n,remoteMessage:r=n}=ho[e];return{type:t==="LOCAL"?"LOCAL_ERROR":"ERROR",payload:{type:e,message:t==="LOCAL"?n:r}}};function Fn(e){const t=us(e);return J(co.INVITATION,t).slice(0,15)}var Ve=e=>e.replaceAll(/[^a-z\d]/gi,""),ze=z(e=>(e=Ve(e),q(Ai,e))),Ce=z(e=>{e=Ve(e);const t=Fn(e),n=ze(e),r={id:t},s=ae.sign(r,n.signature.secretKey);return{id:t,signature:s}}),wf=e=>{const t=Sn(e),{encryptedLinks:n,head:r,root:s}=e,o=on({encryptedLinks:n,childMap:t,head:r,root:s});return kf(o)},lo=(e,t)=>{const n=an(e);return _n({encryptedGraph:n,keys:t})},Rf=(e,t)=>Of(e)?e:lo(e,t),Of=e=>e?.hasOwnProperty("root"),kf=e=>new Uint8Array(e.buffer,e.byteOffset,e.byteLength),le="ALL",De={head:[],teamName:"",members:[],servers:[],roles:[],lockboxes:[],invitations:{},messages:[],removedMembers:[],removedDevices:[],removedServers:[],pendingKeyRotations:[]},ft={type:k.TEAM,name:k.TEAM},Lf={type:k.ROLE,name:K},jp={type:k.EPHEMERAL,name:k.EPHEMERAL},xf=(e,t)=>{switch(t.body.type){case"ADMIT_MEMBER":{const n=t.body.payload.memberKeys,r=n.name,s={userName:"",userId:r,keys:n,roles:[]},i=[...e.removedMembers,s],o=[...e.pendingKeyRotations];return o.includes(r)||o.push(r),{...e,removedMembers:i,pendingKeyRotations:o}}}return e},Cf=e=>t=>({...t,head:[e.hash]}),Nt=e=>t=>{const{userId:n}=e;return{...t,members:t.members.map(r=>{if(r.userId===n){const{devices:s=[]}=r;return s.find(i=>i.deviceId===e.deviceId)?r:{...r,devices:[...s,e]}}return r}),removedDevices:t.removedDevices.filter(r=>r.keys.name===e.deviceId)}},Kt=e=>t=>({...t,members:[...t.members,{...e,roles:[]}],removedMembers:t.removedMembers.filter(n=>n.userId===e.userId)}),Pt=(e,t=[])=>t.map(n=>r=>({...r,members:r.members.map(s=>({...s,roles:s.userId!==e||s.roles.includes(n)?s.roles:[...s.roles,n]}))})),Df=e=>t=>({...t,messages:[...t.messages,e]}),Qr=e=>t=>({...t,roles:[...t.roles,e]}),fo=Nu,$f=e=>t=>({...t,servers:fo([...t.servers,e]),removedServers:t.removedServers.filter(r=>r.host!==e.host)}),Nf=e=>t=>({...t,members:t.members.map(n=>n.userId===e.name?{...n,keys:e}:n)}),Kf=e=>t=>({...t,servers:t.servers.map(n=>n.host===e.name?{...n,keys:e}:n)}),Pf=e=>t=>{const{lockboxes:n}=t;return e?{...t,lockboxes:n.concat(e)}:t},es=e=>t=>{const n={...e,uses:0,revoked:!1};return{...t,invitations:{...t.invitations,[e.id]:n}}},Yn=(e,t,n={includeRemoved:!1})=>{const s=[...e.servers,...n.includeRemoved?e.removedServers:[]].find(i=>i.host===t);if(s===void 0)throw new Error(`A server with host '${t}' was not found`);return s},Wn=(e,t)=>e.servers.find(n=>n.host===t)!==void 0,Bf=e=>({userId:e.host,userName:e.host,keys:e.keys,roles:[]}),Hf=e=>({userId:e.host,userName:e.host,keys:e.keys}),jf=e=>({userId:e.host,deviceName:e.host,deviceId:e.host,keys:e.keys}),$e={toMember:Bf,toUser:Hf,toDevice:jf},po=(e,t,n={includeRemoved:!1})=>yo(e,t,n)!==void 0,wt=(e,t,n={includeRemoved:!1})=>{const r=yo(e,t,n);return b(r,`Device ${t} not found`),r},yo=(e,t,n={includeRemoved:!1})=>Wn(e,t)?$e.toDevice(Yn(e,t)):e.members.concat(n.includeRemoved?e.removedMembers:[]).flatMap(i=>i.devices??[]).find(i=>i.deviceId===t)??(n.includeRemoved?e.removedDevices.find(i=>i.deviceId===t):void 0),Vf=(e,t)=>po(e,t,{includeRemoved:!0})?e.removedDevices.some(n=>n.keys.name===t):!1,vo=(e,t)=>e.members.find(n=>n.userId===t)!==void 0,Uf=(e,t)=>e.roles.find(n=>n.roleName===t)!==void 0;function zn(e,t){return t in e.invitations}function qn(e,t){return b(zn(e,t),`No invitation with id '${t}' found.`),e.invitations[t]}var ts=e=>e.hasOwnProperty("publicKey"),N=(e,t)=>{const n=ts(t)?t:X(t),r=X(e),s=Z.keyPair(),i=ts(n)?n.publicKey:n.encryption,o=Z.encryptBytes({secret:e,recipientPublicKey:i,senderSecretKey:s.secretKey});return{encryptionKey:{...Ai,publicKey:s.publicKey},recipient:{...n,publicKey:i},contents:{...r,publicKey:e.encryption.publicKey},encryptedPayload:o}},Gf=z((e,t)=>{const{encryptionKey:n,encryptedPayload:r}=e;return Z.decryptBytes({cipher:r,senderPublicKey:n.publicKey,recipientSecretKey:t.encryption.secretKey})}),Ff=({oldLockbox:e,newContents:t,updatedRecipientKeys:n})=>{Zr(t,e.contents),n&&Zr(e.recipient,n),t.generation=e.contents.generation+1;const r=n??e.recipient;return N(t,r)},mo=(e,t)=>{const{lockboxes:n}=e,{publicKey:r}=t.encryption,i=n.filter(({recipient:a})=>a.publicKey===r).map(a=>Gf(a,t)),o=i.flatMap(a=>mo(e,a));return[...i,...o]},go=(e,t)=>mo(e,t).reduce(Yf,{}),Yf=(e,t)=>{const{type:n,name:r,generation:s}=t,i=e[n]??{},o=i[r]??[];return o[s]=t,{...e,[n]:{...i,[r]:o}}},Jn=(e,t,n)=>{const{type:r,name:s}=n,i=go(e,t),o=i[r]?i[r][s]:void 0;b(o,`Couldn't find keys: ${JSON.stringify(n)}
     Device: ${t.name}
     Available lockboxes: 
- ${e.lockboxes.map(_f).join(`
- `)} 
     Keymap: ${JSON.stringify(i,null,2)}`);const a="generation"in n&&n.generation!==void 0?n.generation:o.length-1;return o[a]},Wf=(e,t)=>{const n=e.lockboxes.filter(({contents:i})=>i.type===t.type&&i.name===t.name),r=n.reduce(zf,0);return n.filter(({contents:i})=>i.generation===r)},zf=(e,t)=>{const{generation:n}=t.contents;return n>e?n:e},Rt=(e,t,n={includeRemoved:!1})=>{const s=[...e.members,...n.includeRemoved?e.removedMembers:[]].find(i=>i.userId===t);if(s===void 0)throw new Error(`A member named '${t}' was not found`);return s},Eo=(e,t,n={includeRemoved:!1})=>{if(Wn(e,t))return $e.toMember(Yn(e,t));const{userId:r}=wt(e,t,n);return Rt(e,r,n)},bo=(e,t,n)=>{if(!vo(e,t))return!1;const r=Rt(e,t),{roles:s=[]}=r;return s.includes(n)},et=(e,t)=>bo(e,t,K),qf=(e,t)=>e.removedMembers.some(n=>n.userId===t),Io=(e,t)=>e.members.filter(n=>n.roles?.includes(t)),Jf=e=>Io(e,K),Xf=e=>e.messages,Zf=(e,t)=>{const n=e.roles.find(r=>r.roleName===t);if(!n)throw new Error(`A role called '${t}' was not found`);return n},Qf=(e,t)=>e.removedServers.some(n=>n.host===t),{TEAM:ns}=k,ep=(e,t)=>{const n=go(e,t)[ns][ns];return Ae(n)},_o=(e,{type:t,name:n})=>{const r=e.lockboxes.filter(({recipient:o})=>o.type===t&&o.name===n).map(({contents:{type:o,name:a}})=>({type:o,name:a})),s=r.flatMap(o=>_o(e,o)),i=[...r,...s];return fo(i,o=>o.name+o.type)},tp=e=>t=>{const n=wt(t,e),{userId:r}=Eo(t,e),s=a=>a.userId===r?{...a,devices:a.devices?.filter(c=>c.deviceName!==n.deviceName)}:a,i=t.members.map(s),o=[...t.removedDevices,n];return{...t,members:i,removedDevices:o}},np=e=>t=>{const n=t.members.filter(i=>i.userId!==e),r=t.members.find(i=>i.userId===e),s=[...t.removedMembers];return r&&s.push(r),{...t,members:n,removedMembers:s}},rp=(e,t)=>n=>({...n,members:n.members.map(r=>({...r,roles:r.userId===e?r.roles.filter(s=>s!==t):r.roles})),lockboxes:n.lockboxes.filter(r=>!(r.recipient.name===e&&r.contents.type===k.ROLE&&r.contents.name===t))}),sp=e=>t=>({...t,roles:t.roles.filter(n=>n.roleName!==e),lockboxes:t.lockboxes.filter(n=>!(n.contents.type===k.ROLE&&n.contents.name===e))}),ip=e=>t=>{const n=t.servers.filter(i=>i.host!==e),r=t.servers.find(i=>i.host===e),s=[...t.removedServers];return r&&s.push(r),{...t,servers:n,removedServers:s}},op=e=>t=>{const n={...t.invitations},r={...n[e],revoked:!0};return{...t,invitations:{...n,[e]:r}}},ap=e=>t=>{const n=t.pendingKeyRotations.filter(r=>r!==e);return{...t,pendingKeyRotations:n}},rs=e=>t=>({...t,teamName:e}),ss=e=>t=>{const n={...t.invitations},r=n[e],s=r.uses+1;return{...t,invitations:{...n,[e]:{...r,uses:s}}}},cp={};Mt(cp,{IKEY_LENGTH:()=>So,InvitationValidationError:()=>Ao,create:()=>tn,deriveId:()=>Fn,fail:()=>oe,generateProof:()=>Ce,generateStarterKeys:()=>ze,invitationCanBeUsed:()=>Xn,randomSeed:()=>nn,validate:()=>To});var So=16,tn=({seed:e,maxUses:t=1,expiration:n=0,userId:r})=>{e=Ve(e);const s=Fn(e),i=ze(e),{publicKey:o}=i.signature;return{id:s,publicKey:o,expiration:n,maxUses:t,userId:r}},nn=(e=So)=>Te(e),Xn=(e,t)=>{const{revoked:n,maxUses:r,uses:s,expiration:i}=e;return n?oe("The invitation has been revoked"):r>0&&s>=r?oe("The invitation cannot be used again"):i>0&&i<t?oe("The invitation has expired"):D},To=z((e,t)=>{const{id:n,signature:r}=e;if(n!==t.id)return oe("IDs don't match",{proof:e,invitation:t});const{publicKey:s}=t;return ae.verify({payload:{id:n},signature:r,publicKey:s})?D:oe("Signature provided is not valid",{proof:e,invitation:t})}),oe=(e,t)=>({isValid:!1,error:new Ao(e,t)}),Ao=class extends Error{constructor(e,t){super(),this.name="Invitation validation failed",this.message=e,this.details=t}index;details},dp=vt.extend("auth:validate"),up=(...e)=>{for(const t in is){const n=is[t],r=n(...e);if(!r.isValid)return r}return D},is={rootDeviceBelongsToRootUser(...e){const[t,n]=e,{type:r,payload:s}=n.body;if(r!=="ROOT")return D;const{rootDevice:i,rootMember:o}=s;return i.userId!==o.userId?Re("The founding device must belong to the founding member (userIds must match).",...e):D},mustBeAdmin(...e){const[t,n]=e,r=n.body,{type:s,userId:i}=r;return s===_t?D:no(r)&&!et(t,i)?Re(`Member '${i}' is not an admin`,...e):D},canOnlyRemoveYourOwnDevices(...e){const[t,n]=e,r=n.body.userId;if(et(t,r))return D;if(n.body.type==="REMOVE_DEVICE"){const i=n.body.payload.deviceId,a=wt(t,i).userId;if(r!==a)return Re("Can't remove another user's device.",...e)}return D},canOnlyChangeYourOwnKeys(...e){const[t,n]=e,r=n.body.userId;if(!et(t,r)){if(n.body.type==="CHANGE_MEMBER_KEYS"){const i=n.body.payload.keys.name;if(r!==i)return Re("Can't change another user's keys.",...e)}else if(n.body.type==="CHANGE_SERVER_KEYS"){const i=n.body.payload.keys.name;if(r!==i)return Re("Can't change another server's keys.",...e)}}return D},cantAdmitWithInvalidInvitation(...e){const[t,n]=e;if(n.body.type==="ADMIT_MEMBER"||n.body.type==="ADMIT_DEVICE"){const{id:r}=n.body.payload,s=qn(t,r);return Xn(s,n.body.timestamp)}return D}},Re=(e,t,n)=>(e=hs(`${eo(n)} ${e}`),dp(e),{isValid:!1,error:new Tf(e,{prevState:t,link:n})}),pt=(e,t)=>{if(t.isInvalid)return xf(e,t);e=Vd(e);const n=up(e,t);if(!n.isValid)throw n.error;const r=t.body;return If([Cf(t),Pf(r.payload.lockboxes),...hp(r)])(e)},hp=e=>{switch(e.type){case _t:{const{name:t,rootMember:n,rootDevice:r}=e.payload;return[rs(t),Qr({roleName:K}),Kt(n),Nt(r),...Pt(n.userId,[K])]}case"ADD_MEMBER":{const{member:t,roles:n}=e.payload;return[Kt(t),...Pt(t.userId,n)]}case"ADD_ROLE":{const t=e.payload;return[Qr(t)]}case"ADD_MEMBER_ROLE":{const{userId:t,roleName:n}=e.payload;return[...Pt(t,[n])]}case"REMOVE_MEMBER":{const{userId:t}=e.payload;return[np(t)]}case"ADD_DEVICE":{const{device:t}=e.payload;return[Nt(t)]}case"REMOVE_DEVICE":{const{deviceId:t}=e.payload;return[tp(t)]}case"REMOVE_ROLE":{const{roleName:t}=e.payload;return[sp(t)]}case"REMOVE_MEMBER_ROLE":{const{userId:t,roleName:n}=e.payload;return[rp(t,n)]}case"INVITE_MEMBER":{const{invitation:t}=e.payload;return[es(t)]}case"INVITE_DEVICE":{const{invitation:t}=e.payload;return[es(t)]}case"REVOKE_INVITATION":{const{id:t}=e.payload;return[op(t)]}case"ADMIT_MEMBER":{const{id:t,memberKeys:n,userName:r}=e.payload,i={userId:n.name,userName:r,keys:n,roles:[]};return[ss(t),Kt(i)]}case"ADMIT_DEVICE":{const{id:t,device:n}=e.payload;return[ss(t),Nt(n)]}case"CHANGE_MEMBER_KEYS":{const{keys:t}=e.payload;return[Nf(t)]}case"ROTATE_KEYS":{const{userId:t}=e.payload;return[ap(t)]}case"ADD_SERVER":{const{server:t}=e.payload;return[$f(t)]}case"REMOVE_SERVER":{const{host:t}=e.payload;return[ip(t)]}case"CHANGE_SERVER_KEYS":{const{keys:t}=e.payload;return[Kf(t)]}case"MESSAGE":{const{message:t}=e.payload;return[Df(t)]}case"SET_TEAM_NAME":{const{teamName:t}=e.payload;return[rs(t)]}default:throw lp(e)}};function lp(e){const{type:t}=e;return new Error(`Unrecognized link type: ${t}`)}var fp=Di({initialState:De,reducer:pt,resolver:ht}),Mo=(e,t)=>{const n=lo(e,t);return fp(n)},{USER:pp}=k,yp=({serializedGraph:e,teamKeyring:t,invitationSeed:n})=>{const r=ze(n),s=Ce(n).id,i=Mo(e,t),{userId:o}=qn(i,s);b(o);const{userName:a}=Rt(i,o);b(a);const c=Jn(i,r,{type:pp,name:o});return{userName:a,userId:o,keys:c}},vp=e=>({...e,nonce:Te(),timestamp:Date.now()}),mp=(e,t)=>ae.sign(e,t.signature.secretKey),gp=(e,t,n)=>{const r={challenge:e,signature:t};return ae.verify({payload:e,signature:t,publicKey:n.signature})?D:Ep("Signature is not valid",r)},Ep=(e,t)=>({isValid:!1,error:new bp(e,t)}),bp=class extends Error{constructor(e,t){super(),this.name="Identity challenge failed",this.message=e+`
`+JSON.stringify(t,null,2).replaceAll('"',""),this.details=t}details},Ip={};Mt(Ip,{createDevice:()=>_p,redactDevice:()=>Ue});var _p=(e,t,n=Te())=>{const r=In(),s=q({type:k.DEVICE,name:r},n);return{userId:e,deviceId:r,deviceName:t,keys:s}},Ue=e=>({userId:e.userId,deviceId:e.deviceId,deviceName:e.deviceName,keys:X(e.keys)}),os=e=>({...Wh(e),roles:[]}),Sp=e=>"teamName"in e,{DEVICE:Bt,USER:Ht}=k,Zn=class extends mt{state=De;store;context;log;seed;constructor(e){if(super(),this.seed=e.seed??Te(),"user"in e.context)this.context=e.context;else{const{server:r}=e.context;this.context={...e.context,device:$e.toDevice(r),user:$e.toUser(r)}}const{device:t,user:n}=this.context;if(this.log=vt.extend(`auth:team:${this.userName}`),Sp(e)){b(!this.isServer,"Servers can't create teams");const r=N(e.teamKeys,n.keys),s=q(Lf,this.seed),i=N(s,n.keys),o=N(n.keys,this.context.device.keys),a={name:e.teamName,rootMember:os(n),rootDevice:Ue(t),lockboxes:[r,i,o]};this.store=Cr({user:n,reducer:pt,resolver:ht,initialState:De,rootPayload:a,keys:e.teamKeys})}else this.store=Cr({user:n,reducer:pt,resolver:ht,initialState:De,graph:Rf(e.source,e.teamKeyring),keys:e.teamKeyring});this.state=this.store.getState(),this.on("updated",()=>{this.checkForPendingKeyRotations()})}get graph(){return this.store.getGraph()}get id(){return this.graph.root}get teamName(){return this.state.teamName}setTeamName(e){this.dispatch({type:"SET_TEAM_NAME",payload:{teamName:e}})}get userName(){return this.context.user.userId}get userId(){return this.context.user.userId}get isServer(){return"server"in this.context}save=()=>wf(this.graph);merge=e=>(this.store.merge(e),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head}),this);dispatch(e,t=this.teamKeys()){this.store.dispatch(e,t),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head})}has=e=>vo(this.state,e);members(e=le,t={includeRemoved:!0}){return e===le?this.state.members:Rt(this.state,e,t)}addForTesting=(e,t=[],n)=>{const r={...os(e),roles:t};if(!this.has(r.userId)){const s=this.createMemberLockboxes(r);this.dispatch({type:"ADD_MEMBER",payload:{member:r,roles:t,lockboxes:s}})}if(n){const s=N(e.keys,n.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:n,lockboxes:[s]}})}};remove=e=>{const t=this.rotateKeys({type:Ht,name:e});this.dispatch({type:"REMOVE_MEMBER",payload:{userId:e,lockboxes:t}})};memberWasRemoved=e=>qf(this.state,e);roles(e=le){return e===le?this.state.roles:Zf(this.state,e)}memberHasRole=(e,t)=>bo(this.state,e,t);memberIsAdmin=e=>et(this.state,e);hasRole=e=>Uf(this.state,e);membersInRole=e=>Io(this.state,e);admins=()=>Jf(this.state);addRole=e=>{typeof e=="string"&&(e={roleName:e});const t=q({type:k.ROLE,name:e.roleName},this.seed),n=N(t,this.adminKeys());this.dispatch({type:"ADD_ROLE",payload:{...e,lockboxes:[n]}})};removeRole=e=>{b(e!==K,"Cannot remove admin role"),this.dispatch({type:"REMOVE_ROLE",payload:{roleName:e}})};addMemberRole=(e,t)=>{const n=this.members(e),r=N(this.roleKeys(t),n.keys);this.dispatch({type:"ADD_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:[r]}})};removeMemberRole=(e,t)=>{if(t===K){const r=this.membersInRole(K).length;b(r>1,"Can't remove the last admin")}const n=this.rotateKeys({type:k.ROLE,name:t});this.dispatch({type:"REMOVE_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:n}})};hasDevice=(e,t)=>po(this.state,e,t);device(e,t){return wt(this.state,e,t)}removeDevice=e=>{if(!this.hasDevice(e))throw new Error(`Device ${e} not found`);const t=this.rotateKeys({type:Bt,name:e});this.dispatch({type:"REMOVE_DEVICE",payload:{deviceId:e,lockboxes:t}})};deviceWasRemoved=e=>Vf(this.state,e);memberByDeviceId=(e,t)=>Eo(this.state,e,t);verifyIdentityProof=(e,t)=>{b(e.type===Bt);const n=e.name,r=this.hasServer(n)?this.servers(n):this.device(n,{includeRemoved:!0});return gp(e,t,r.keys).isValid};inviteMember({seed:e=nn(),expiration:t,maxUses:n}={}){e=Ve(e);const r=tn({seed:e,expiration:t,maxUses:n}),{id:s}=r;return this.dispatch({type:"INVITE_MEMBER",payload:{invitation:r}}),{id:s,seed:e}}inviteDevice({seed:e=nn(),expiration:t=Date.now()+30*60*1e3}={}){b(!this.isServer,"Servers can't invite a device"),e=Ve(e);const r=tn({seed:e,expiration:t,maxUses:1,userId:this.userId}),s=ze(e),i=N(this.context.user.keys,s),{id:o}=r;return this.dispatch({type:"INVITE_DEVICE",payload:{invitation:r,lockboxes:[i]}}),{id:o,seed:e}}revokeInvitation=e=>{this.dispatch({type:"REVOKE_INVITATION",payload:{id:e}})};hasInvitation(e){return zn(this.state,e)}getInvitation=e=>qn(this.state,e);validateInvitation=e=>{const{id:t}=e;if(!this.hasInvitation(t))return oe("This invitation code doesn't match.");const n=this.getInvitation(t),r=Xn(n,Date.now());return r!==D?r:To(e,n)};admitMember=(e,t,n)=>{const r=this.validateInvitation(e);if(!r.isValid)throw r.error;const{id:s}=e,i=N(this.teamKeys(),t);this.dispatch({type:"ADMIT_MEMBER",payload:{id:s,userName:n,memberKeys:X(t),lockboxes:[i]}})};admitDevice=(e,t)=>{const n=this.validateInvitation(e);if(!n.isValid)throw n.error;const{id:r}=e,i=this.getInvitation(r).userId,o={...t,userId:i};this.dispatch({type:"ADMIT_DEVICE",payload:{id:r,device:o}})};join=e=>{b(!this.isServer,"Can't join as member on server");const{user:t,device:n}=this.context,r=Kh(e),s=N(t.keys,n.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:Ue(n),lockboxes:[s]}},r)};addServer=e=>{const t=this.createMemberLockboxes($e.toMember(e));this.dispatch({type:"ADD_SERVER",payload:{server:e,lockboxes:t}})};removeServer=e=>{this.dispatch({type:"REMOVE_SERVER",payload:{host:e}})};servers(e=le,t={includeRemoved:!0}){return e===le?this.state.servers:Yn(this.state,e,t)}serverWasRemoved=e=>Qf(this.state,e);hasServer=e=>Wn(this.state,e);addMessage=e=>{this.dispatch({type:"MESSAGE",payload:{message:e}})};messages=()=>Xf(this.state);encrypt=(e,t)=>{const n=t?{type:k.ROLE,name:t}:ft,{secretKey:r,generation:s}=this.keys(n);return{contents:nt.encryptBytes(e,r),recipient:{...n,generation:s}}};decrypt=e=>{const{secretKey:t}=this.keys(e.recipient);return nt.decryptBytes(e.contents,t)};sign=e=>{b(this.context.user);const{keys:{type:t,name:n,generation:r,signature:{secretKey:s}}}=this.context.user;return{contents:e,signature:ae.sign(e,s),author:{type:t,name:n,generation:r}}};verify=e=>ae.verify({payload:e.contents,signature:e.signature,publicKey:this.members(e.author.name).keys.signature});keys=e=>Jn(this.state,this.context.device.keys,e);roleKeys=(e,t)=>this.keys({type:k.ROLE,name:e,generation:t});teamKeys=e=>this.keys({...ft,generation:e});teamKeyring=()=>ep(this.state,this.context.device.keys);adminKeys=e=>this.roleKeys(K,e);changeKeys=e=>{const{device:t,user:n}=this.context,{type:r}=e;b(r!==Bt,"Can't change device keys");const s=r===Ht,i=r===k.SERVER,o=n.keys;e.generation=o.generation+1;const a=this.rotateKeys(e),c=s?"CHANGE_MEMBER_KEYS":"CHANGE_SERVER_KEYS",d=X(e);this.dispatch({type:c,payload:{keys:d,lockboxes:a}}),(i||s)&&(n.keys=e),i&&(t.keys=e)};checkForPendingKeyRotations(){if(this.memberIsAdmin(this.userId))for(const e of this.state.pendingKeyRotations){const t=this.rotateKeys({type:Ht,name:this.userId});this.dispatch({type:"ROTATE_KEYS",payload:{userId:e,lockboxes:t}})}}createMemberLockboxes=e=>{const t=e.roles.map(this.roleKeys),n=r=>N(r,e.keys);return[...t,this.teamKeys()].map(n)};rotateKeys=e=>{const t=St(e)?e:q(e),r=_o(this.state,e).map(o=>q(o)),s=[t,...r];return s.flatMap(o=>Wf(this.state,o).map(c=>{const d=s.find(h=>uo(h,c.recipient));return Ff({oldLockbox:c,newContents:o,updatedRecipientKeys:d?X(d):void 0})}))}};function Vp(e,t,n){const r=q(ft,n);return new Zn({teamName:e,context:t,teamKeys:r})}var Tp=({encryptedGraph:e,teamKeys:t,deviceKeys:n})=>{const r=Ae(t),{encryptedLinks:s,childMap:i,root:o}=e,a=e.links??{},c=(l,p,y={},m=De)=>{const v=s[l],I=a[l]??Oi(v,p);let R={[l]:I};const P=pt(m,I);let $;try{$=Jn(P,n,ft),r[$.encryption.publicKey]=$}catch{$=p}const V=i[l];if(V)for(const kt of V)R={...R,...c(kt,$,R,P)};return{...y,...R}},d=s[o].recipientPublicKey,h=r[d],u=c(o,h);return{...e,links:u}},Up=(e,t,n)=>{const r=Ae(n);return new Zn({source:e,context:t,teamKeyring:r})},wo=e=>{if(e===void 0)return"DONE";const{head:t,links:n,need:r}=e,s={head:t};return n&&(s.links=Object.keys(n).join(", ")),r&&(s.need=r.join(", ")),hs(JSON.stringify(s))},Oe=vt.extend("message-queue"),Ap=class extends mt{#e=!1;#t={};#s=0;#n={};#a;#i={};#r=0;#o;constructor({sendMessage:e,timeout:t=1e3}){super(),this.#o=n=>{this.#r=n.index+1,e(n)},this.#a=t}start(){return this.#e=!0,this.#c(),this.#d(),this}stop(){return this.#e=!1,this}send(e){const t=as(this.#i)+1,n={...e,index:t};return this.#i[t]=n,Oe("send %o",n),this.#e&&this.#o(n),this}resend(e){const t=this.#i[e];if(!t)throw new Error(`Received resend request for message #${e}, which doesn't exist.`);return Oe("resend %o",t),this.#o(t),this}receive(e){const{index:t}=e;return Oe("receive %o",e),this.#t[t]||(this.#t[t]=e,this.#e&&this.#c()),this}#d(){for(Oe("processOutbound");this.#i[this.#r];){const e=this.#i[this.#r];this.#o(e)}}#c(){for(Oe("processInbound");this.#t[this.#s];){const t=this.#t[this.#s];this.#s++,this.emit("message",t)}const e=as(this.#t);for(let t=this.#s;t<e;t++)this.#n[t]||(this.#n[t]=setTimeout(()=>{this.#t[t]||this.emit("request",t),delete this.#n[t]},this.#a))}};function as(e){return Math.max(...Object.keys(e).map(Number),-1)}var Mp=e=>e.type==="SYNC"?`SYNC ${wo(e.payload)}`:`${e.type} ${e.payload?.head?.slice(0,5)||e.payload?.message||""}`,wp=e=>typeof e=="string",Ro=e=>wp(e)?e:Object.keys(e).map(t=>`${t}:${Ro(e[t])}`).filter(t=>t.length).join(","),Rp=e=>{const{keys:t,host:n}=e.server;return{...e,user:{userId:n,userName:n,keys:t},device:{userId:n,deviceId:n,deviceName:n,keys:t}}},Op=e=>"server"in e?e.server.host:"userName"in e?e.userName:"user"in e?e.user.userName:"",Oo=e=>"team"in e&&e.team!==void 0,Ot=e=>"invitationSeed"in e&&e.invitationSeed!==void 0,Qn=e=>Ot(e)&&"user"in e&&e.user!==void 0,ko=e=>Ot(e)&&!Qn(e),Lo=e=>"server"in e&&e.server!==void 0,rn=e=>"deviceId"in e&&e.deviceId!==void 0,xo=e=>me(e)&&"userKeys"in e&&e.userKeys!==void 0,kp=e=>me(e)&&!("userKeys"in e),me=e=>"proofOfInvitation"in e&&e.proofOfInvitation!==void 0,Lp=class extends mt{#e;#t;#s=!1;#n=vt.extend("auth:connection");constructor({sendMessage:e,context:t}){super(),this.#t=this.#a(e),this.#n=this.#n.extend(Op(t));const n=Lo(t)?Rp(t):t,r=Zl({types:{context:{},events:{}},actions:{requestIdentityClaim:()=>{this.#r("REQUEST_IDENTITY")},sendIdentityClaim:C(({context:s})=>{const o=(a=>{if(Oo(a))return{deviceId:a.device.deviceId};if(Qn(a)){b(a.invitationSeed);const{userName:c,keys:d}=a.user;return{proofOfInvitation:Ce(a.invitationSeed),userName:c,userKeys:X(d),device:Ue(a.device)}}if(ko(a)){b(a.invitationSeed);const{userName:c,device:d}=a;return{proofOfInvitation:Ce(a.invitationSeed),userName:c,device:Ue(d)}}throw new Error("Invalid context")})(s);return this.#r("CLAIM_IDENTITY",o),{ourIdentityClaim:o}}),receiveIdentityClaim:C(({event:s})=>{B(s,"CLAIM_IDENTITY");const i=s.payload,o="device"in i?i.device:void 0;return{theirIdentityClaim:i,theirDevice:o}}),acceptInvitation:C(({context:s})=>{const{team:i,theirIdentityClaim:o}=s;b(i),b(o),b(me(o));const{proofOfInvitation:a}=o,d=(()=>{if(xo(o)){const{userName:h,userKeys:u}=o;i.admitMember(a,u,h);const l=u.name;return i.members(l)}else{const{device:h}=o;i.admitDevice(a,h);const{deviceId:u}=h,{userId:l}=i.memberByDeviceId(u);return i.members(l)}})();return this.#r("ACCEPT_INVITATION",{serializedGraph:i.save(),teamKeyring:i.teamKeyring()}),{peer:d}}),joinTeam:C(({context:s,event:i})=>{B(i,"ACCEPT_INVITATION");const{serializedGraph:o,teamKeyring:a}=i.payload,{device:c,invitationSeed:d}=s;b(d);const h=s.user??yp({serializedGraph:o,teamKeyring:a,invitationSeed:d}),u=new Zn({source:o,context:{user:h,device:c},teamKeyring:a});return u.join(a),this.emit("joined",{team:u,user:h}),{user:h,team:u}}),challengeIdentity:C(({context:s})=>{const{team:i,theirIdentityClaim:o}=s;b(i),b(rn(o));const{deviceId:a}=o,c=i.device(a,{includeRemoved:!0}),d=i.memberByDeviceId(a,{includeRemoved:!0});this.#n=this.#n.extend(d.userName);const h=vp({type:k.DEVICE,name:a});return this.#r("CHALLENGE_IDENTITY",{challenge:h}),{theirDevice:c,peer:d,challenge:h}}),proveIdentity:({context:s,event:i})=>{B(i,"CHALLENGE_IDENTITY");const{challenge:o}=i.payload,{keys:a}=s.device,c=mp(o,a);this.#r("PROVE_IDENTITY",{challenge:o,proof:c})},acceptIdentity:()=>this.#r("ACCEPT_IDENTITY"),listenForTeamUpdates:({context:s})=>{b(s.team),s.team.on("updated",({head:i})=>{this.#e.getSnapshot().status!=="done"&&this.#e.send({type:"LOCAL_UPDATE",payload:{head:i}}),this.emit("updated")})},sendSyncMessage:C(({context:s})=>{b(s.team);const i=s.syncState??Dr(),[o,a]=Fh(s.team.graph,i);return a?(this.#n("sending sync message",wo(a)),this.#r("SYNC",a)):this.#n("no sync message to send"),{syncState:o}}),receiveSyncMessage:C(({context:s,event:i})=>{B(i,"SYNC");const o=i.payload,{syncState:a=Dr(),team:c,device:d}=s;b(c);const h=c.teamKeys(),u=d.keys,l=({encryptedGraph:m,keys:v})=>Tp({encryptedGraph:m,teamKeys:v,deviceKeys:u}),[p,y]=Yh(c.graph,a,o,h,l);return Ze(p.head,c.graph.head)?{syncState:y}:(this.emit("updated"),{team:c.merge(p),syncState:y})}),sendSeed:C(({context:s})=>{const{user:i,peer:o,seed:a=Vo()}=s,c=Z.encryptBytes({secret:a,recipientPublicKey:o.keys.encryption,senderSecretKey:i.keys.encryption.secretKey});return this.#r("SEED",{encryptedSeed:c}),{seed:a}}),deriveSharedKey:C(({context:s,event:i})=>{B(i,"SEED");const{encryptedSeed:o}=i.payload,{seed:a,user:c,peer:d}=s;try{const h=Z.decryptBytes({cipher:o,senderPublicKey:d.keys.encryption,recipientSecretKey:c.keys.encryption.secretKey});return{sessionKey:Af(a,h)}}catch(h){if(String(h).includes("incorrect key pair"))return this.#i(lt);throw h}}),receiveEncryptedMessage:({context:s,event:i})=>{B(i,"ENCRYPTED_MESSAGE");const o=s.sessionKey,a=i.payload;try{const c=nt.decryptBytes(a,o);this.emit("message",c)}catch(c){if(String(c).includes("wrong secret key"))return this.#i(lt);throw c}},fail:C((s,{error:i})=>this.#i(i)),receiveError:C(({event:s})=>{B(s,"ERROR");const i=s.payload;return this.#n("receiveError: %o",i),this.emit("remoteError",i),{error:i}}),sendError:C(({event:s})=>{B(s,"LOCAL_ERROR");const i=s.payload;return this.#n("sendError %o",i),this.#t.send(en(i.type,"REMOTE")),this.emit("localError",i),{error:i}}),onConnected:()=>this.emit("connected"),onDisconnected:({event:s})=>this.emit("disconnected",s)},guards:{theySentIdentityClaim:({context:s})=>s.theirIdentityClaim!==void 0,weSentIdentityClaim:({context:s})=>s.ourIdentityClaim!==void 0,bothSentIdentityClaim:jr(["theySentIdentityClaim","weSentIdentityClaim"]),weHaveInvitation:({context:s})=>Ot(s),theyHaveInvitation:({context:s})=>me(s.theirIdentityClaim),neitherIsMember:jr(["weHaveInvitation","theyHaveInvitation"]),invitationIsValid:({context:s})=>{const{team:i,theirIdentityClaim:o}=s;return b(me(o)),i.validateInvitation(o.proofOfInvitation).isValid},joinedTheRightTeam:({context:s,event:i})=>{B(i,"ACCEPT_INVITATION");const o=s.invitationSeed,{serializedGraph:a,teamKeyring:c}=i.payload,d=Mo(a,c),{id:h}=Ce(o);return zn(d,h)},deviceUnknown:({context:s})=>{const{theirIdentityClaim:i}=s;return b(rn(i)),!s.team.hasDevice(i.deviceId,{includeRemoved:!0})},identityIsValid:({context:s,event:i})=>{B(i,"PROVE_IDENTITY");const{challenge:o,proof:a}=i.payload;return s.team.verifyIdentityProof(o,a)},memberWasRemoved:({context:s})=>s.team.memberWasRemoved(s.peer.userId),deviceWasRemoved:({context:s})=>s.team.deviceWasRemoved(s.theirDevice.deviceId),serverWasRemoved:({context:s})=>s.team.serverWasRemoved(s.peer.userId),headsAreEqual:({context:s})=>to(s.team.graph.head,s.syncState?.lastCommonHead)}}).createMachine({context:n,id:"connection",entry:"requestIdentityClaim",initial:"awaitingIdentityClaim",on:{REQUEST_IDENTITY:{actions:"sendIdentityClaim",target:".awaitingIdentityClaim"},ERROR:{actions:"receiveError",target:"#disconnected"},LOCAL_ERROR:{actions:"sendError",target:"#disconnected"}},states:{awaitingIdentityClaim:{always:{guard:"bothSentIdentityClaim",target:"authenticating"},on:{CLAIM_IDENTITY:{actions:"receiveIdentityClaim"}}},authenticating:{initial:"checkingInvitations",states:{checkingInvitations:{always:[{guard:"neitherIsMember",...G(Vn)},{guard:"weHaveInvitation",target:"awaitingInvitationAcceptance"},{guard:"theyHaveInvitation",target:"validatingInvitation"},{target:"#checkingIdentity"}]},awaitingInvitationAcceptance:{on:{ACCEPT_INVITATION:[{guard:"joinedTheRightTeam",actions:"joinTeam",target:"#checkingIdentity"},G(Hn)]},...ke},validatingInvitation:{always:[{guard:"invitationIsValid",actions:"acceptInvitation",target:"#checkingIdentity"},G(Bn)]},checkingIdentity:{id:"checkingIdentity",type:"parallel",states:{provingMyIdentity:{initial:"awaitingIdentityChallenge",states:{awaitingIdentityChallenge:{always:{guard:"weHaveInvitation",target:"done"},on:{CHALLENGE_IDENTITY:{actions:"proveIdentity",target:"awaitingIdentityAcceptance"}},...ke},awaitingIdentityAcceptance:{on:{ACCEPT_IDENTITY:{target:"done"}},...ke},done:{type:"final"}}},verifyingTheirIdentity:{initial:"challengingIdentity",states:{challengingIdentity:{always:[{guard:"theyHaveInvitation",target:"done"},{guard:"deviceUnknown",...G(Kn)},{actions:"challengeIdentity",target:"awaitingIdentityProof"}]},awaitingIdentityProof:{on:{PROVE_IDENTITY:[{guard:"identityIsValid",actions:"acceptIdentity",target:"done"},G(Pn)]},...ke},done:{type:"final"}}}},onDone:{target:"done"}},done:{type:"final"}},onDone:{target:"#negotiating"}},negotiating:{id:"negotiating",entry:"sendSeed",on:{SEED:{actions:"deriveSharedKey",target:"synchronizing"}},...ke},synchronizing:{entry:"sendSyncMessage",always:{guard:"headsAreEqual",target:"connected"},on:{SYNC:{actions:["receiveSyncMessage","sendSyncMessage"]}}},connected:{id:"connected",entry:["onConnected","listenForTeamUpdates"],always:[{guard:"memberWasRemoved",...G(jn)},{guard:"deviceWasRemoved",...G(Nn)},{guard:"serverWasRemoved",...G(Un)}],on:{LOCAL_UPDATE:{actions:"sendSyncMessage"},SYNC:{actions:["receiveSyncMessage","sendSyncMessage"]},ENCRYPTED_MESSAGE:{actions:"receiveEncryptedMessage"},DISCONNECT:"#disconnected"}},disconnected:{id:"disconnected",always:{actions:"onDisconnected"}}}});this.#e=je(r),this.#e.subscribe(s=>{const i=Ro(s.value);this.emit("change",i),this.#n(`⏩ ${i} `)}),this.emit=(s,...i)=>(this.#n(`emit ${s} %o`,...i),super.emit(s,...i))}start=(e=[])=>{this.#n("starting"),this.#e.start(),this.#t.start(),this.#s=!0;for(const t of e)this.deliver(t);return this};stop=()=>{if(this.#s&&this.#e.getSnapshot().status!=="done"){const e={type:"DISCONNECT"};this.#e.send(e),this.#t.send(e)}return this.removeAllListeners(),this.#t.stop(),this.#n("connection stopped"),this};deliver(e){const t=an(e);this.#t.receive(t)}send=e=>{b(this._sessionKey,"Can't send encrypted messages until we've finished connecting");const t=nt.encryptBytes(e,this._sessionKey);this.#r("ENCRYPTED_MESSAGE",t)};get state(){return b(this.#s),this.#e.getSnapshot().value}get team(){return this._context.team}get _sessionKey(){return this._context.sessionKey}get _context(){return b(this.#s),this.#e.getSnapshot().context}#a(e){return new Ap({sendMessage:t=>{this.#o("out",t);const n=on(t);e(n)}}).on("message",t=>{if(this.#o("in",t),t.type==="REQUEST_RESEND"){const{index:n}=t.payload;this.#t.resend(n)}else this.#e.send(t)}).on("request",t=>{this.#r("REQUEST_RESEND",{index:t})})}#i(e){this.#n("error: %o",e);const t=en(e,"LOCAL");return this.#e.send(t),{error:t.payload}}#r(e,t){this.#t.send({type:e,payload:t})}#o(e,t){const n=e==="in"?"<-":"->",r=this.#s?this._context.peer?.userName??"?":"?";this.#n(`${n}${r} #${t.index} ${Mp(t)}`)}},G=e=>({actions:[{type:"fail",params:{error:e}},"onDisconnected"],target:"#disconnected"}),xp=7e3,ke={after:{[xp]:G(Gn)}};export{K as ADMIN,Lf as ADMIN_SCOPE,le as ALL,Lp as Connection,Ef as DEVICE_ID,pf as ENCRYPTION,jp as EPHEMERAL_SCOPE,co as HashPurpose,gf as INVITATION,vf as LINK_HASH,mf as LINK_TO_PREVIOUS,bf as SHARED_KEY,ff as SIGNATURE,yf as SYMMETRIC,ft as TEAM_SCOPE,Zn as Team,D as VALID,Z as asymmetric,$e as castServer,ef as connection,_p as createDevice,q as createKeyset,Vp as createTeam,Bp as createUser,Ip as device,Ce as generateProof,Hp as graphSummary,De as initialState,cp as invitation,Up as loadTeam,Ue as redactDevice,X as redactKeys,Wh as redactUser,tf as role,ae as signatures,nt as symmetric};
//# sourceMappingURL=index-l_Qczjsi.js.map

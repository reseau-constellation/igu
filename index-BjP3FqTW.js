import{b as ht,S as Ce,g as vt,r as Ie,i as Yt,e as Ti,a as Jo,f as Xo,m as Qo,L as Pr,M as kt,c as Ai,t as Be,d as oe,s as Mi,h as be,j as le,k as he,l as je,p as $r,u as Kr,n as Wt,o as Nt,q as Oi,v as Zo,w as bn,x as ea}from"./index-DOKTyow9.js";import{a as ta,c as ra,b as In,E as zt,g as Sn}from"./index-C9JXTq7F.js";function M(e,t="Assertion failed"){if(e===!1||e===null||e===void 0){const r=new Error(na(t));throw r.stack=ia(r.stack,"assert.js"),r}}const na=e=>e.split(`
`).map(t=>t.trim()).join(`
`),ia=(e="",t)=>e.split(`
`).filter(r=>!r.includes(t)).join(`
`);function ve(e){return e!=null&&typeof e=="object"}var sa="[object Symbol]";function Br(e){return typeof e=="symbol"||ve(e)&&ht(e)==sa}function oa(e,t){for(var r=-1,n=e==null?0:e.length,i=Array(n);++r<n;)i[r]=t(e[r],r,e);return i}var ie=Array.isArray,aa=1/0,wn=Ce?Ce.prototype:void 0,Tn=wn?wn.toString:void 0;function xi(e){if(typeof e=="string")return e;if(ie(e))return oa(e,xi)+"";if(Br(e))return Tn?Tn.call(e):"";var t=e+"";return t=="0"&&1/e==-aa?"-0":t}function ca(e){return e}var pr=vt(Ie,"WeakMap"),An=Object.create,ua=function(){function e(){}return function(t){if(!Yt(t))return{};if(An)return An(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}();function da(){}function la(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t}var Mn=function(){try{var e=vt(Object,"defineProperty");return e({},"",{}),e}catch{}}();function fa(e,t){for(var r=-1,n=e==null?0:e.length;++r<n&&t(e[r],r,e)!==!1;);return e}function ha(e,t,r,n){for(var i=e.length,s=r+(n?1:-1);n?s--:++s<i;)if(t(e[s],s,e))return s;return-1}function va(e){return e!==e}function ya(e,t,r){for(var n=r-1,i=e.length;++n<i;)if(e[n]===t)return n;return-1}function pa(e,t,r){return t===t?ya(e,t,r):ha(e,va,r)}function ma(e,t){var r=e==null?0:e.length;return!!r&&pa(e,t,0)>-1}var ga=9007199254740991,Ea=/^(?:0|[1-9]\d*)$/;function _i(e,t){var r=typeof e;return t=t??ga,!!t&&(r=="number"||r!="symbol"&&Ea.test(e))&&e>-1&&e%1==0&&e<t}function Ri(e,t,r){t=="__proto__"&&Mn?Mn(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}var ba=Object.prototype,Ia=ba.hasOwnProperty;function Li(e,t,r){var n=e[t];(!(Ia.call(e,t)&&Ti(n,r))||r===void 0&&!(t in e))&&Ri(e,t,r)}function qt(e,t,r,n){var i=!r;r||(r={});for(var s=-1,o=t.length;++s<o;){var a=t[s],c=n?n(r[a],e[a],a,r,e):void 0;c===void 0&&(c=e[a]),i?Ri(r,a,c):Li(r,a,c)}return r}var Sa=9007199254740991;function jr(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=Sa}function ki(e){return e!=null&&jr(e.length)&&!Jo(e)}var wa=Object.prototype;function Hr(e){var t=e&&e.constructor,r=typeof t=="function"&&t.prototype||wa;return e===r}function Ta(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}var Aa="[object Arguments]";function On(e){return ve(e)&&ht(e)==Aa}var Ni=Object.prototype,Ma=Ni.hasOwnProperty,Oa=Ni.propertyIsEnumerable,Di=On(function(){return arguments}())?On:function(e){return ve(e)&&Ma.call(e,"callee")&&!Oa.call(e,"callee")};function xa(){return!1}var Ci=typeof exports=="object"&&exports&&!exports.nodeType&&exports,xn=Ci&&typeof module=="object"&&module&&!module.nodeType&&module,_a=xn&&xn.exports===Ci,_n=_a?Ie.Buffer:void 0,Ra=_n?_n.isBuffer:void 0,Dt=Ra||xa,La="[object Arguments]",ka="[object Array]",Na="[object Boolean]",Da="[object Date]",Ca="[object Error]",Pa="[object Function]",$a="[object Map]",Ka="[object Number]",Ba="[object Object]",ja="[object RegExp]",Ha="[object Set]",Va="[object String]",Ua="[object WeakMap]",Fa="[object ArrayBuffer]",Ga="[object DataView]",Ya="[object Float32Array]",Wa="[object Float64Array]",za="[object Int8Array]",qa="[object Int16Array]",Ja="[object Int32Array]",Xa="[object Uint8Array]",Qa="[object Uint8ClampedArray]",Za="[object Uint16Array]",ec="[object Uint32Array]",H={};H[Ya]=H[Wa]=H[za]=H[qa]=H[Ja]=H[Xa]=H[Qa]=H[Za]=H[ec]=!0;H[La]=H[ka]=H[Fa]=H[Na]=H[Ga]=H[Da]=H[Ca]=H[Pa]=H[$a]=H[Ka]=H[Ba]=H[ja]=H[Ha]=H[Va]=H[Ua]=!1;function tc(e){return ve(e)&&jr(e.length)&&!!H[ht(e)]}function Vr(e){return function(t){return e(t)}}var Pi=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Qe=Pi&&typeof module=="object"&&module&&!module.nodeType&&module,rc=Qe&&Qe.exports===Pi,or=rc&&Xo.process,Pe=function(){try{var e=Qe&&Qe.require&&Qe.require("util").types;return e||or&&or.binding&&or.binding("util")}catch{}}(),Rn=Pe&&Pe.isTypedArray,$i=Rn?Vr(Rn):tc,nc=Object.prototype,ic=nc.hasOwnProperty;function Ki(e,t){var r=ie(e),n=!r&&Di(e),i=!r&&!n&&Dt(e),s=!r&&!n&&!i&&$i(e),o=r||n||i||s,a=o?Ta(e.length,String):[],c=a.length;for(var u in e)(t||ic.call(e,u))&&!(o&&(u=="length"||i&&(u=="offset"||u=="parent")||s&&(u=="buffer"||u=="byteLength"||u=="byteOffset")||_i(u,c)))&&a.push(u);return a}function Bi(e,t){return function(r){return e(t(r))}}var sc=Bi(Object.keys,Object),oc=Object.prototype,ac=oc.hasOwnProperty;function cc(e){if(!Hr(e))return sc(e);var t=[];for(var r in Object(e))ac.call(e,r)&&r!="constructor"&&t.push(r);return t}function Jt(e){return ki(e)?Ki(e):cc(e)}function uc(e){var t=[];if(e!=null)for(var r in Object(e))t.push(r);return t}var dc=Object.prototype,lc=dc.hasOwnProperty;function fc(e){if(!Yt(e))return uc(e);var t=Hr(e),r=[];for(var n in e)n=="constructor"&&(t||!lc.call(e,n))||r.push(n);return r}function Ur(e){return ki(e)?Ki(e,!0):fc(e)}var hc=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,vc=/^\w*$/;function Fr(e,t){if(ie(e))return!1;var r=typeof e;return r=="number"||r=="symbol"||r=="boolean"||e==null||Br(e)?!0:vc.test(e)||!hc.test(e)||t!=null&&e in Object(t)}var yc=500;function pc(e){var t=Qo(e,function(n){return r.size===yc&&r.clear(),n}),r=t.cache;return t}var mc=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,gc=/\\(\\)?/g,Ec=pc(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(mc,function(r,n,i,s){t.push(i?s.replace(gc,"$1"):n||r)}),t});function bc(e){return e==null?"":xi(e)}function ji(e,t){return ie(e)?e:Fr(e,t)?[e]:Ec(bc(e))}var Ic=1/0;function Xt(e){if(typeof e=="string"||Br(e))return e;var t=e+"";return t=="0"&&1/e==-Ic?"-0":t}function Hi(e,t){t=ji(t,e);for(var r=0,n=t.length;e!=null&&r<n;)e=e[Xt(t[r++])];return r&&r==n?e:void 0}function Sc(e,t,r){var n=e==null?void 0:Hi(e,t);return n===void 0?r:n}function Vi(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e}var wc=Bi(Object.getPrototypeOf,Object);const Ui=wc;function Tc(){this.__data__=new Pr,this.size=0}function Ac(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r}function Mc(e){return this.__data__.get(e)}function Oc(e){return this.__data__.has(e)}var xc=200;function _c(e,t){var r=this.__data__;if(r instanceof Pr){var n=r.__data__;if(!kt||n.length<xc-1)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new Ai(n)}return r.set(e,t),this.size=r.size,this}function ne(e){var t=this.__data__=new Pr(e);this.size=t.size}ne.prototype.clear=Tc;ne.prototype.delete=Ac;ne.prototype.get=Mc;ne.prototype.has=Oc;ne.prototype.set=_c;function Rc(e,t){return e&&qt(t,Jt(t),e)}function Lc(e,t){return e&&qt(t,Ur(t),e)}var Fi=typeof exports=="object"&&exports&&!exports.nodeType&&exports,Ln=Fi&&typeof module=="object"&&module&&!module.nodeType&&module,kc=Ln&&Ln.exports===Fi,kn=kc?Ie.Buffer:void 0,Nn=kn?kn.allocUnsafe:void 0;function Nc(e,t){if(t)return e.slice();var r=e.length,n=Nn?Nn(r):new e.constructor(r);return e.copy(n),n}function Dc(e,t){for(var r=-1,n=e==null?0:e.length,i=0,s=[];++r<n;){var o=e[r];t(o,r,e)&&(s[i++]=o)}return s}function Gi(){return[]}var Cc=Object.prototype,Pc=Cc.propertyIsEnumerable,Dn=Object.getOwnPropertySymbols,Gr=Dn?function(e){return e==null?[]:(e=Object(e),Dc(Dn(e),function(t){return Pc.call(e,t)}))}:Gi;function $c(e,t){return qt(e,Gr(e),t)}var Kc=Object.getOwnPropertySymbols,Yi=Kc?function(e){for(var t=[];e;)Vi(t,Gr(e)),e=Ui(e);return t}:Gi;function Bc(e,t){return qt(e,Yi(e),t)}function Wi(e,t,r){var n=t(e);return ie(e)?n:Vi(n,r(e))}function mr(e){return Wi(e,Jt,Gr)}function jc(e){return Wi(e,Ur,Yi)}var gr=vt(Ie,"DataView"),Er=vt(Ie,"Promise"),ke=vt(Ie,"Set"),Cn="[object Map]",Hc="[object Object]",Pn="[object Promise]",$n="[object Set]",Kn="[object WeakMap]",Bn="[object DataView]",Vc=Be(gr),Uc=Be(kt),Fc=Be(Er),Gc=Be(ke),Yc=Be(pr),ge=ht;(gr&&ge(new gr(new ArrayBuffer(1)))!=Bn||kt&&ge(new kt)!=Cn||Er&&ge(Er.resolve())!=Pn||ke&&ge(new ke)!=$n||pr&&ge(new pr)!=Kn)&&(ge=function(e){var t=ht(e),r=t==Hc?e.constructor:void 0,n=r?Be(r):"";if(n)switch(n){case Vc:return Bn;case Uc:return Cn;case Fc:return Pn;case Gc:return $n;case Yc:return Kn}return t});const it=ge;var Wc=Object.prototype,zc=Wc.hasOwnProperty;function qc(e){var t=e.length,r=new e.constructor(t);return t&&typeof e[0]=="string"&&zc.call(e,"index")&&(r.index=e.index,r.input=e.input),r}var Ct=Ie.Uint8Array;function Yr(e){var t=new e.constructor(e.byteLength);return new Ct(t).set(new Ct(e)),t}function Jc(e,t){var r=t?Yr(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}var Xc=/\w*$/;function Qc(e){var t=new e.constructor(e.source,Xc.exec(e));return t.lastIndex=e.lastIndex,t}var jn=Ce?Ce.prototype:void 0,Hn=jn?jn.valueOf:void 0;function Zc(e){return Hn?Object(Hn.call(e)):{}}function eu(e,t){var r=t?Yr(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}var tu="[object Boolean]",ru="[object Date]",nu="[object Map]",iu="[object Number]",su="[object RegExp]",ou="[object Set]",au="[object String]",cu="[object Symbol]",uu="[object ArrayBuffer]",du="[object DataView]",lu="[object Float32Array]",fu="[object Float64Array]",hu="[object Int8Array]",vu="[object Int16Array]",yu="[object Int32Array]",pu="[object Uint8Array]",mu="[object Uint8ClampedArray]",gu="[object Uint16Array]",Eu="[object Uint32Array]";function bu(e,t,r){var n=e.constructor;switch(t){case uu:return Yr(e);case tu:case ru:return new n(+e);case du:return Jc(e,r);case lu:case fu:case hu:case vu:case yu:case pu:case mu:case gu:case Eu:return eu(e,r);case nu:return new n;case iu:case au:return new n(e);case su:return Qc(e);case ou:return new n;case cu:return Zc(e)}}function Iu(e){return typeof e.constructor=="function"&&!Hr(e)?ua(Ui(e)):{}}var Su="[object Map]";function wu(e){return ve(e)&&it(e)==Su}var Vn=Pe&&Pe.isMap,Tu=Vn?Vr(Vn):wu,Au="[object Set]";function Mu(e){return ve(e)&&it(e)==Au}var Un=Pe&&Pe.isSet,Ou=Un?Vr(Un):Mu,xu=1,_u=2,Ru=4,zi="[object Arguments]",Lu="[object Array]",ku="[object Boolean]",Nu="[object Date]",Du="[object Error]",qi="[object Function]",Cu="[object GeneratorFunction]",Pu="[object Map]",$u="[object Number]",Ji="[object Object]",Ku="[object RegExp]",Bu="[object Set]",ju="[object String]",Hu="[object Symbol]",Vu="[object WeakMap]",Uu="[object ArrayBuffer]",Fu="[object DataView]",Gu="[object Float32Array]",Yu="[object Float64Array]",Wu="[object Int8Array]",zu="[object Int16Array]",qu="[object Int32Array]",Ju="[object Uint8Array]",Xu="[object Uint8ClampedArray]",Qu="[object Uint16Array]",Zu="[object Uint32Array]",K={};K[zi]=K[Lu]=K[Uu]=K[Fu]=K[ku]=K[Nu]=K[Gu]=K[Yu]=K[Wu]=K[zu]=K[qu]=K[Pu]=K[$u]=K[Ji]=K[Ku]=K[Bu]=K[ju]=K[Hu]=K[Ju]=K[Xu]=K[Qu]=K[Zu]=!0;K[Du]=K[qi]=K[Vu]=!1;function At(e,t,r,n,i,s){var o,a=t&xu,c=t&_u,u=t&Ru;if(r&&(o=i?r(e,n,i,s):r(e)),o!==void 0)return o;if(!Yt(e))return e;var d=ie(e);if(d){if(o=qc(e),!a)return la(e,o)}else{var f=it(e),l=f==qi||f==Cu;if(Dt(e))return Nc(e,a);if(f==Ji||f==zi||l&&!i){if(o=c||l?{}:Iu(e),!a)return c?Bc(e,Lc(o,e)):$c(e,Rc(o,e))}else{if(!K[f])return i?e:{};o=bu(e,f,a)}}s||(s=new ne);var h=s.get(e);if(h)return h;s.set(e,o),Ou(e)?e.forEach(function(m){o.add(At(m,t,r,m,e,s))}):Tu(e)&&e.forEach(function(m,g){o.set(g,At(m,t,r,g,e,s))});var p=u?c?jc:mr:c?Ur:Jt,y=d?void 0:p(e);return fa(y||e,function(m,g){y&&(g=m,m=e[g]),Li(o,g,At(m,t,r,g,e,s))}),o}var ed=4;function td(e){return At(e,ed)}var rd="__lodash_hash_undefined__";function nd(e){return this.__data__.set(e,rd),this}function id(e){return this.__data__.has(e)}function st(e){var t=-1,r=e==null?0:e.length;for(this.__data__=new Ai;++t<r;)this.add(e[t])}st.prototype.add=st.prototype.push=nd;st.prototype.has=id;function sd(e,t){for(var r=-1,n=e==null?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}function Xi(e,t){return e.has(t)}var od=1,ad=2;function Qi(e,t,r,n,i,s){var o=r&od,a=e.length,c=t.length;if(a!=c&&!(o&&c>a))return!1;var u=s.get(e),d=s.get(t);if(u&&d)return u==t&&d==e;var f=-1,l=!0,h=r&ad?new st:void 0;for(s.set(e,t),s.set(t,e);++f<a;){var p=e[f],y=t[f];if(n)var m=o?n(y,p,f,t,e,s):n(p,y,f,e,t,s);if(m!==void 0){if(m)continue;l=!1;break}if(h){if(!sd(t,function(g,b){if(!Xi(h,b)&&(p===g||i(p,g,r,n,s)))return h.push(b)})){l=!1;break}}else if(!(p===y||i(p,y,r,n,s))){l=!1;break}}return s.delete(e),s.delete(t),l}function cd(e){var t=-1,r=Array(e.size);return e.forEach(function(n,i){r[++t]=[i,n]}),r}function Wr(e){var t=-1,r=Array(e.size);return e.forEach(function(n){r[++t]=n}),r}var ud=1,dd=2,ld="[object Boolean]",fd="[object Date]",hd="[object Error]",vd="[object Map]",yd="[object Number]",pd="[object RegExp]",md="[object Set]",gd="[object String]",Ed="[object Symbol]",bd="[object ArrayBuffer]",Id="[object DataView]",Fn=Ce?Ce.prototype:void 0,ar=Fn?Fn.valueOf:void 0;function Sd(e,t,r,n,i,s,o){switch(r){case Id:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case bd:return!(e.byteLength!=t.byteLength||!s(new Ct(e),new Ct(t)));case ld:case fd:case yd:return Ti(+e,+t);case hd:return e.name==t.name&&e.message==t.message;case pd:case gd:return e==t+"";case vd:var a=cd;case md:var c=n&ud;if(a||(a=Wr),e.size!=t.size&&!c)return!1;var u=o.get(e);if(u)return u==t;n|=dd,o.set(e,t);var d=Qi(a(e),a(t),n,i,s,o);return o.delete(e),d;case Ed:if(ar)return ar.call(e)==ar.call(t)}return!1}var wd=1,Td=Object.prototype,Ad=Td.hasOwnProperty;function Md(e,t,r,n,i,s){var o=r&wd,a=mr(e),c=a.length,u=mr(t),d=u.length;if(c!=d&&!o)return!1;for(var f=c;f--;){var l=a[f];if(!(o?l in t:Ad.call(t,l)))return!1}var h=s.get(e),p=s.get(t);if(h&&p)return h==t&&p==e;var y=!0;s.set(e,t),s.set(t,e);for(var m=o;++f<c;){l=a[f];var g=e[l],b=t[l];if(n)var S=o?n(b,g,l,t,e,s):n(g,b,l,e,t,s);if(!(S===void 0?g===b||i(g,b,r,n,s):S)){y=!1;break}m||(m=l=="constructor")}if(y&&!m){var T=e.constructor,_=t.constructor;T!=_&&"constructor"in e&&"constructor"in t&&!(typeof T=="function"&&T instanceof T&&typeof _=="function"&&_ instanceof _)&&(y=!1)}return s.delete(e),s.delete(t),y}var Od=1,Gn="[object Arguments]",Yn="[object Array]",gt="[object Object]",xd=Object.prototype,Wn=xd.hasOwnProperty;function _d(e,t,r,n,i,s){var o=ie(e),a=ie(t),c=o?Yn:it(e),u=a?Yn:it(t);c=c==Gn?gt:c,u=u==Gn?gt:u;var d=c==gt,f=u==gt,l=c==u;if(l&&Dt(e)){if(!Dt(t))return!1;o=!0,d=!1}if(l&&!d)return s||(s=new ne),o||$i(e)?Qi(e,t,r,n,i,s):Sd(e,t,c,r,n,i,s);if(!(r&Od)){var h=d&&Wn.call(e,"__wrapped__"),p=f&&Wn.call(t,"__wrapped__");if(h||p){var y=h?e.value():e,m=p?t.value():t;return s||(s=new ne),i(y,m,r,n,s)}}return l?(s||(s=new ne),Md(e,t,r,n,i,s)):!1}function zr(e,t,r,n,i){return e===t?!0:e==null||t==null||!ve(e)&&!ve(t)?e!==e&&t!==t:_d(e,t,r,n,zr,i)}var Rd=1,Ld=2;function kd(e,t,r,n){var i=r.length,s=i,o=!n;if(e==null)return!s;for(e=Object(e);i--;){var a=r[i];if(o&&a[2]?a[1]!==e[a[0]]:!(a[0]in e))return!1}for(;++i<s;){a=r[i];var c=a[0],u=e[c],d=a[1];if(o&&a[2]){if(u===void 0&&!(c in e))return!1}else{var f=new ne;if(n)var l=n(u,d,c,e,t,f);if(!(l===void 0?zr(d,u,Rd|Ld,n,f):l))return!1}}return!0}function Zi(e){return e===e&&!Yt(e)}function Nd(e){for(var t=Jt(e),r=t.length;r--;){var n=t[r],i=e[n];t[r]=[n,i,Zi(i)]}return t}function es(e,t){return function(r){return r==null?!1:r[e]===t&&(t!==void 0||e in Object(r))}}function Dd(e){var t=Nd(e);return t.length==1&&t[0][2]?es(t[0][0],t[0][1]):function(r){return r===e||kd(r,e,t)}}function Cd(e,t){return e!=null&&t in Object(e)}function Pd(e,t,r){t=ji(t,e);for(var n=-1,i=t.length,s=!1;++n<i;){var o=Xt(t[n]);if(!(s=e!=null&&r(e,o)))break;e=e[o]}return s||++n!=i?s:(i=e==null?0:e.length,!!i&&jr(i)&&_i(o,i)&&(ie(e)||Di(e)))}function $d(e,t){return e!=null&&Pd(e,t,Cd)}var Kd=1,Bd=2;function jd(e,t){return Fr(e)&&Zi(t)?es(Xt(e),t):function(r){var n=Sc(r,e);return n===void 0&&n===t?$d(r,e):zr(t,n,Kd|Bd)}}function Hd(e){return function(t){return t?.[e]}}function Vd(e){return function(t){return Hi(t,e)}}function Ud(e){return Fr(e)?Hd(Xt(e)):Vd(e)}function Fd(e){return typeof e=="function"?e:e==null?ca:typeof e=="object"?ie(e)?jd(e[0],e[1]):Dd(e):Ud(e)}function Gd(e,t,r){for(var n=-1,i=e==null?0:e.length;++n<i;)if(r(t,e[n]))return!0;return!1}var Yd=1/0,Wd=ke&&1/Wr(new ke([,-0]))[1]==Yd?function(e){return new ke(e)}:da,zd=200;function ts(e,t,r){var n=-1,i=ma,s=e.length,o=!0,a=[],c=a;if(r)o=!1,i=Gd;else if(s>=zd){var u=t?null:Wd(e);if(u)return Wr(u);o=!1,i=Xi,c=new st}else c=t?[]:a;e:for(;++n<s;){var d=e[n],f=t?t(d):d;if(d=r||d!==0?d:0,o&&f===f){for(var l=c.length;l--;)if(c[l]===f)continue e;t&&c.push(f),a.push(d)}else i(c,f,r)||(c!==a&&c.push(f),a.push(d))}return a}function qr(e){return e&&e.length?ts(e):[]}function qd(e,t){return e&&e.length?ts(e,Fd(t)):[]}var ye={},B={},W={};Object.defineProperty(W,"__esModule",{value:!0});W.output=W.exists=W.hash=W.bytes=W.bool=W.number=void 0;function Pt(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}W.number=Pt;function rs(e){if(typeof e!="boolean")throw new Error(`Expected boolean, not ${e}`)}W.bool=rs;function Jd(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}function Jr(e,...t){if(!Jd(e))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}W.bytes=Jr;function ns(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Pt(e.outputLen),Pt(e.blockLen)}W.hash=ns;function is(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}W.exists=is;function ss(e,t){Jr(e);const r=t.outputLen;if(e.length<r)throw new Error(`digestInto() expects output buffer of length at least ${r}`)}W.output=ss;const Xd={number:Pt,bool:rs,bytes:Jr,hash:ns,exists:is,output:ss};W.default=Xd;var O={};Object.defineProperty(O,"__esModule",{value:!0});O.add5L=O.add5H=O.add4H=O.add4L=O.add3H=O.add3L=O.add=O.rotlBL=O.rotlBH=O.rotlSL=O.rotlSH=O.rotr32L=O.rotr32H=O.rotrBL=O.rotrBH=O.rotrSL=O.rotrSH=O.shrSL=O.shrSH=O.toBig=O.split=O.fromBig=void 0;const Et=BigInt(2**32-1),br=BigInt(32);function Xr(e,t=!1){return t?{h:Number(e&Et),l:Number(e>>br&Et)}:{h:Number(e>>br&Et)|0,l:Number(e&Et)|0}}O.fromBig=Xr;function os(e,t=!1){let r=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let i=0;i<e.length;i++){const{h:s,l:o}=Xr(e[i],t);[r[i],n[i]]=[s,o]}return[r,n]}O.split=os;const as=(e,t)=>BigInt(e>>>0)<<br|BigInt(t>>>0);O.toBig=as;const cs=(e,t,r)=>e>>>r;O.shrSH=cs;const us=(e,t,r)=>e<<32-r|t>>>r;O.shrSL=us;const ds=(e,t,r)=>e>>>r|t<<32-r;O.rotrSH=ds;const ls=(e,t,r)=>e<<32-r|t>>>r;O.rotrSL=ls;const fs=(e,t,r)=>e<<64-r|t>>>r-32;O.rotrBH=fs;const hs=(e,t,r)=>e>>>r-32|t<<64-r;O.rotrBL=hs;const vs=(e,t)=>t;O.rotr32H=vs;const ys=(e,t)=>e;O.rotr32L=ys;const ps=(e,t,r)=>e<<r|t>>>32-r;O.rotlSH=ps;const ms=(e,t,r)=>t<<r|e>>>32-r;O.rotlSL=ms;const gs=(e,t,r)=>t<<r-32|e>>>64-r;O.rotlBH=gs;const Es=(e,t,r)=>e<<r-32|t>>>64-r;O.rotlBL=Es;function bs(e,t,r,n){const i=(t>>>0)+(n>>>0);return{h:e+r+(i/2**32|0)|0,l:i|0}}O.add=bs;const Is=(e,t,r)=>(e>>>0)+(t>>>0)+(r>>>0);O.add3L=Is;const Ss=(e,t,r,n)=>t+r+n+(e/2**32|0)|0;O.add3H=Ss;const ws=(e,t,r,n)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0);O.add4L=ws;const Ts=(e,t,r,n,i)=>t+r+n+i+(e/2**32|0)|0;O.add4H=Ts;const As=(e,t,r,n,i)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0)+(i>>>0);O.add5L=As;const Ms=(e,t,r,n,i,s)=>t+r+n+i+s+(e/2**32|0)|0;O.add5H=Ms;const Qd={fromBig:Xr,split:os,toBig:as,shrSH:cs,shrSL:us,rotrSH:ds,rotrSL:ls,rotrBH:fs,rotrBL:hs,rotr32H:vs,rotr32L:ys,rotlSH:ps,rotlSL:ms,rotlBH:gs,rotlBL:Es,add:bs,add3L:Is,add3H:Ss,add4L:ws,add4H:Ts,add5H:Ms,add5L:As};O.default=Qd;var Os={};const Zd=ta(ra);(function(e){/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.randomBytes=e.wrapXOFConstructorWithOpts=e.wrapConstructorWithOpts=e.wrapConstructor=e.checkOpts=e.Hash=e.concatBytes=e.toBytes=e.utf8ToBytes=e.asyncLoop=e.nextTick=e.hexToBytes=e.bytesToHex=e.isLE=e.rotr=e.createView=e.u32=e.u8=void 0;const t=Zd,r=v=>new Uint8Array(v.buffer,v.byteOffset,v.byteLength);e.u8=r;const n=v=>new Uint32Array(v.buffer,v.byteOffset,Math.floor(v.byteLength/4));e.u32=n;function i(v){return v instanceof Uint8Array||v!=null&&typeof v=="object"&&v.constructor.name==="Uint8Array"}const s=v=>new DataView(v.buffer,v.byteOffset,v.byteLength);e.createView=s;const o=(v,I)=>v<<32-I|v>>>I;if(e.rotr=o,e.isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68,!e.isLE)throw new Error("Non little-endian hardware is not supported");const a=Array.from({length:256},(v,I)=>I.toString(16).padStart(2,"0"));function c(v){if(!i(v))throw new Error("Uint8Array expected");let I="";for(let x=0;x<v.length;x++)I+=a[v[x]];return I}e.bytesToHex=c;const u={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function d(v){if(v>=u._0&&v<=u._9)return v-u._0;if(v>=u._A&&v<=u._F)return v-(u._A-10);if(v>=u._a&&v<=u._f)return v-(u._a-10)}function f(v){if(typeof v!="string")throw new Error("hex string expected, got "+typeof v);const I=v.length,x=I/2;if(I%2)throw new Error("padded hex string expected, got unpadded hex of length "+I);const w=new Uint8Array(x);for(let A=0,P=0;A<x;A++,P+=2){const Y=d(v.charCodeAt(P)),ae=d(v.charCodeAt(P+1));if(Y===void 0||ae===void 0){const Se=v[P]+v[P+1];throw new Error('hex string expected, got non-hex character "'+Se+'" at index '+P)}w[A]=Y*16+ae}return w}e.hexToBytes=f;const l=async()=>{};e.nextTick=l;async function h(v,I,x){let w=Date.now();for(let A=0;A<v;A++){x(A);const P=Date.now()-w;P>=0&&P<I||(await(0,e.nextTick)(),w+=P)}}e.asyncLoop=h;function p(v){if(typeof v!="string")throw new Error(`utf8ToBytes expected string, got ${typeof v}`);return new Uint8Array(new TextEncoder().encode(v))}e.utf8ToBytes=p;function y(v){if(typeof v=="string"&&(v=p(v)),!i(v))throw new Error(`expected Uint8Array, got ${typeof v}`);return v}e.toBytes=y;function m(...v){let I=0;for(let w=0;w<v.length;w++){const A=v[w];if(!i(A))throw new Error("Uint8Array expected");I+=A.length}const x=new Uint8Array(I);for(let w=0,A=0;w<v.length;w++){const P=v[w];x.set(P,A),A+=P.length}return x}e.concatBytes=m;class g{clone(){return this._cloneInto()}}e.Hash=g;const b={}.toString;function S(v,I){if(I!==void 0&&b.call(I)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(v,I)}e.checkOpts=S;function T(v){const I=w=>v().update(y(w)).digest(),x=v();return I.outputLen=x.outputLen,I.blockLen=x.blockLen,I.create=()=>v(),I}e.wrapConstructor=T;function _(v){const I=(w,A)=>v(A).update(y(w)).digest(),x=v({});return I.outputLen=x.outputLen,I.blockLen=x.blockLen,I.create=w=>v(w),I}e.wrapConstructorWithOpts=_;function D(v){const I=(w,A)=>v(A).update(y(w)).digest(),x=v({});return I.outputLen=x.outputLen,I.blockLen=x.blockLen,I.create=w=>v(w),I}e.wrapXOFConstructorWithOpts=D;function L(v=32){if(t.crypto&&typeof t.crypto.getRandomValues=="function")return t.crypto.getRandomValues(new Uint8Array(v));throw new Error("crypto.getRandomValues must be defined")}e.randomBytes=L})(Os);Object.defineProperty(B,"__esModule",{value:!0});B.shake256=B.shake128=B.keccak_512=B.keccak_384=B.keccak_256=B.keccak_224=B.sha3_512=B.sha3_384=B.sha3_256=B.sha3_224=B.Keccak=B.keccakP=void 0;const Ae=W,ot=O,Ze=Os,[xs,_s,Rs]=[[],[],[]],el=BigInt(0),Ue=BigInt(1),tl=BigInt(2),rl=BigInt(7),nl=BigInt(256),il=BigInt(113);for(let e=0,t=Ue,r=1,n=0;e<24;e++){[r,n]=[n,(2*r+3*n)%5],xs.push(2*(5*n+r)),_s.push((e+1)*(e+2)/2%64);let i=el;for(let s=0;s<7;s++)t=(t<<Ue^(t>>rl)*il)%nl,t&tl&&(i^=Ue<<(Ue<<BigInt(s))-Ue);Rs.push(i)}const[sl,ol]=(0,ot.split)(Rs,!0),zn=(e,t,r)=>r>32?(0,ot.rotlBH)(e,t,r):(0,ot.rotlSH)(e,t,r),qn=(e,t,r)=>r>32?(0,ot.rotlBL)(e,t,r):(0,ot.rotlSL)(e,t,r);function Ls(e,t=24){const r=new Uint32Array(10);for(let n=24-t;n<24;n++){for(let o=0;o<10;o++)r[o]=e[o]^e[o+10]^e[o+20]^e[o+30]^e[o+40];for(let o=0;o<10;o+=2){const a=(o+8)%10,c=(o+2)%10,u=r[c],d=r[c+1],f=zn(u,d,1)^r[a],l=qn(u,d,1)^r[a+1];for(let h=0;h<50;h+=10)e[o+h]^=f,e[o+h+1]^=l}let i=e[2],s=e[3];for(let o=0;o<24;o++){const a=_s[o],c=zn(i,s,a),u=qn(i,s,a),d=xs[o];i=e[d],s=e[d+1],e[d]=c,e[d+1]=u}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)r[a]=e[o+a];for(let a=0;a<10;a++)e[o+a]^=~r[(a+2)%10]&r[(a+4)%10]}e[0]^=sl[n],e[1]^=ol[n]}r.fill(0)}B.keccakP=Ls;class yt extends Ze.Hash{constructor(t,r,n,i=!1,s=24){if(super(),this.blockLen=t,this.suffix=r,this.outputLen=n,this.enableXOF=i,this.rounds=s,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,(0,Ae.number)(n),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=(0,Ze.u32)(this.state)}keccak(){Ls(this.state32,this.rounds),this.posOut=0,this.pos=0}update(t){(0,Ae.exists)(this);const{blockLen:r,state:n}=this;t=(0,Ze.toBytes)(t);const i=t.length;for(let s=0;s<i;){const o=Math.min(r-this.pos,i-s);for(let a=0;a<o;a++)n[this.pos++]^=t[s++];this.pos===r&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:t,suffix:r,pos:n,blockLen:i}=this;t[n]^=r,r&128&&n===i-1&&this.keccak(),t[i-1]^=128,this.keccak()}writeInto(t){(0,Ae.exists)(this,!1),(0,Ae.bytes)(t),this.finish();const r=this.state,{blockLen:n}=this;for(let i=0,s=t.length;i<s;){this.posOut>=n&&this.keccak();const o=Math.min(n-this.posOut,s-i);t.set(r.subarray(this.posOut,this.posOut+o),i),this.posOut+=o,i+=o}return t}xofInto(t){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(t)}xof(t){return(0,Ae.number)(t),this.xofInto(new Uint8Array(t))}digestInto(t){if((0,Ae.output)(t,this),this.finished)throw new Error("digest() was already called");return this.writeInto(t),this.destroy(),t}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(t){const{blockLen:r,suffix:n,outputLen:i,rounds:s,enableXOF:o}=this;return t||(t=new yt(r,n,i,o,s)),t.state32.set(this.state32),t.pos=this.pos,t.posOut=this.posOut,t.finished=this.finished,t.rounds=s,t.suffix=n,t.outputLen=i,t.enableXOF=o,t.destroyed=this.destroyed,t}}B.Keccak=yt;const pe=(e,t,r)=>(0,Ze.wrapConstructor)(()=>new yt(t,e,r));B.sha3_224=pe(6,144,224/8);B.sha3_256=pe(6,136,256/8);B.sha3_384=pe(6,104,384/8);B.sha3_512=pe(6,72,512/8);B.keccak_224=pe(1,144,224/8);B.keccak_256=pe(1,136,256/8);B.keccak_384=pe(1,104,384/8);B.keccak_512=pe(1,72,512/8);const ks=(e,t,r)=>(0,Ze.wrapXOFConstructorWithOpts)((n={})=>new yt(t,e,n.dkLen===void 0?r:n.dkLen,!0));B.shake128=ks(31,168,128/8);B.shake256=ks(31,136,256/8);const{sha3_512:al}=B,Ns=24,et=32,Ir=(e=4,t=Math.random)=>{let r="";for(;r.length<e;)r=r+Math.floor(t()*36).toString(36);return r};function Ds(e){let t=8n,r=0n;for(const n of e.values()){const i=BigInt(n);r=(r<<t)+i}return r}const Cs=(e="")=>Ds(al(e)).toString(36).slice(1),Jn=Array.from({length:26},(e,t)=>String.fromCharCode(t+97)),cl=e=>Jn[Math.floor(e()*Jn.length)],Ps=({globalObj:e=typeof In<"u"?In:typeof window<"u"?window:{},random:t=Math.random}={})=>{const r=Object.keys(e).toString(),n=r.length?r+Ir(et,t):Ir(et,t);return Cs(n).substring(0,et)},$s=e=>()=>e++,ul=476782367,Ks=({random:e=Math.random,counter:t=$s(Math.floor(e()*ul)),length:r=Ns,fingerprint:n=Ps({random:e})}={})=>function(){const s=cl(e),o=Date.now().toString(36),a=t().toString(36),c=Ir(r,e),u=`${o+c+a+n}`;return`${s+Cs(u).substring(1,r)}`},dl=Ks(),ll=(e,{minLength:t=2,maxLength:r=et}={})=>{const n=e.length,i=/^[0-9a-z]+$/;try{if(typeof e=="string"&&n>=t&&n<=r&&i.test(e))return!0}finally{}return!1};ye.getConstants=()=>({defaultLength:Ns,bigLength:et});ye.init=Ks;ye.createId=dl;ye.bufToBigInt=Ds;ye.createCounter=$s;ye.createFingerprint=Ps;ye.isCuid=ll;const{createId:fl,init:jv,getConstants:Hv,isCuid:Vv}=ye;var Qr=fl,hl="SIGNATURE",vl="ENCRYPTION",yl="SYMMETRIC",pl="LINK_HASH",Bs={SIGNATURE:hl,ENCRYPTION:vl,SYMMETRIC:yl,LINK_HASH:pl},Qt="ROOT",Le={isValid:!0},js={type:"EPHEMERAL",name:"EPHEMERAL"},{LINK_HASH:ml}=Bs,at=e=>le(ml,e),Hs=({graph:e,action:t,user:r,context:n={},keys:i})=>{const{publicKey:s,secretKey:o}=r.keys.encryption,{publicKey:a}=i.encryption,c={...t,...n,userId:r.userId,timestamp:Date.now(),prev:e.head??[]},u=he.encryptBytes({secret:c,recipientPublicKey:a,senderSecretKey:o}),d=at(u),f={hash:d,body:c},l={senderPublicKey:s,recipientPublicKey:a,encryptedBody:u};return{root:e.root??d,head:[d],encryptedLinks:{...e.encryptedLinks,[d]:l},links:{...e.links,[d]:f}}},$t=(e,t)=>e.links[t],Vs=(e,t)=>gl(e)[t]||[],gl=oe(e=>{const t={};for(const r of Object.values(e.links)){const n=r.body.prev;for(const i of n){const s=t[i]||[];s.push(r.hash),t[i]=s}}return t}),Kt=e=>Object.keys(e.links),El=(e,t)=>`${e.head.join("")}:${t}`,ct=oe((e,t)=>{const r=$t(e,t);M(r);const n=r.body.prev,i=n.flatMap(s=>ct(e,s));return qr(n.concat(i))},El),bl=(e,t,r)=>t!==void 0&&r!==void 0&&t.hash in e.links&&r.hash in e.links&&ct(e,r.hash).includes(t.hash),Il=(e,t,r)=>ct(e,r).includes(t),Sl=(e,t)=>`${e.head.join("")}:${t}`,Us=oe((e,t)=>{const r=Vs(e,t),n=r.flatMap(i=>Us(e,i));return qr(r.concat(n))},Sl),wl=(e,t,r)=>Us(e,r).includes(t),Tl=(e,t)=>Al(e)[t],Al=oe(e=>{const t={};for(const r in e.links){const n=r;t[n]=Kt(e).filter(i=>Ml(e,n,i)).sort()}return t}),Ml=(e,t,r)=>t!==r&&!Il(e,t,r)&&!wl(e,t,r),Ol=e=>{const t={},r=i=>{const s=[i];for(const o of Tl(e,i))t[o]||(t[o]=!0,s.push(...r(o)));return s},n=[];for(const i in e.links){const s=i;if(!t[s]){t[s]=!0;const o=r(s);o.length>1&&n.push(o)}}return n},xl={root:void 0,head:void 0,encryptedLinks:{},links:{}},_l=({user:e,id:t=Qr(),name:r=t,rootPayload:n={},context:i={},keys:s})=>{const o={name:r,id:t,...n};return Hs({graph:xl,action:{type:Qt,prev:[],payload:o},user:e,context:i,keys:s})},Rl=e=>(t,r)=>{const n=typeof e=="function"?e(r):r[e];return{...t,[n]:r}},Ll={GRAPH:"GRAPH",USER:"USER"},kl=e=>e.encryption.hasOwnProperty("secretKey")&&e.signature.hasOwnProperty("secretKey")&&"secretKey"in e,Zt=e=>e!==void 0&&"secretKey"in e&&"encryption"in e&&"signature"in e,Nl=e=>!Array.isArray(e)&&!Zt(e),He=e=>Nl(e)?e:(Zt(e)&&(e=[e]),e.reduce(Rl(t=>t.encryption.publicKey),{})),Fs=(e,t)=>{const{senderPublicKey:r,recipientPublicKey:n,encryptedBody:i}=e,o=He(t)[n];M(o,"Can't decrypt link: don't have the correct keyset");const a=Dl(i),c=he.decryptBytes({cipher:a,recipientSecretKey:o.encryption.secretKey,senderPublicKey:r});return{hash:at(i),body:c}},Zr=({encryptedGraph:e,keys:t})=>{const{encryptedLinks:r,root:n,childMap:i={}}=e,s=e.links??{},o=(c,u={})=>{const d=r[c],f=s[c]??Fs(d,t);let l={[c]:f};const h=i[c]??[];for(const p of h)l={...l,...o(p,l)};return{...u,...l}},a=o(n);return{...e,links:a}},Dl=e=>Cl(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e),Cl=e=>"buffer"in e&&"byteOffset"in e&&"byteLength"in e,Pl=(e,t)=>Object.fromEntries(t.map(r=>[r,$l(e,r)])),$l=(e,t)=>e.encryptedLinks[t],Kl=e=>e.head.map(t=>$t(e,t));function Sr(e,t){return typeof t=="string"?$t(e,t).body.prev:t.body.prev.map(n=>$t(e,n))}var cr={},wr=({graph:e,depth:t,start:r=e.head,end:n=[],prev:i,hashes:s})=>s?s.reduce((o,a)=>({...o,[a]:Sr(e,a)}),cr):(i&&(r=Bl(i)),t===0?cr:r.reduce((o,a)=>{const c=Sr(e,a),u=c.filter(f=>!(f in o)).filter(f=>!n.includes(f)),d=wr({graph:e,depth:t?t-1:void 0,start:u,end:n});return{...o,[a]:c,...d}},cr)),Bl=e=>Object.keys(e).flatMap(i=>e[i]).filter(i=>!(i in e)),en=e=>{const t={};for(const r of Kt(e))for(const n of Sr(e,r))t[n]||(t[n]=[]),t[n].push(r);return t},jl=e=>{const t={},r=Object.keys(e);for(const n of r)for(const i of e[n])t[i]||(t[i]=[]),t[i].push(n);return t},Hl=e=>e.links[e.root],Vl=(e,t={})=>{const{comparator:r=Gs}=t;let n=Object.values(e.links);const i=Object.fromEntries(n.map(a=>[a.hash,a.body.prev.length])),s=[],o=a=>{s.push(a),n=n.filter(f=>f.hash!==a.hash);const c=Vs(e,a.hash);for(const f of c)i[f]--;if(c.length!==1)return;const u=c[0];if(i[u]>0)return;const d=e.links[u];o(d)};for(;n.length>0;){const c=n.filter(u=>i[u.hash]===0).sort(r).shift();o(c)}return s},Gs=(e,t)=>e.hash<t.hash?-1:e.hash>t.hash?1:0,Ys=(e,t=Ws)=>{const{sort:r=Gs,filter:n=Ul}=t(e);return Vl(e,{comparator:r}).map(s=>{const o=s.isInvalid??!n(s);return{...s,isInvalid:o}})},Ws=e=>({}),Ul=e=>!0,Mt=(e,t)=>e===void 0||t===void 0||e.length!==t.length?!1:(e.sort(),t.sort(),e.every((r,n)=>r===t[n])),zs=(e,t)=>{if(e.root!==t.root)throw new Error("Cannot merge two graphs with different roots");const r={...t.links,...e.links},n={...t.encryptedLinks,...e.encryptedLinks},s=qr([...e.head,...t.head]).filter(Fl(r)),o={root:e.root,head:s,encryptedLinks:n,links:r};return o.head=o.head.sort(),o},Fl=e=>t=>!Object.values(e).some(Gl(t)),Gl=e=>t=>t.body.prev.includes(e),Yl=e=>{const{head:t,root:r,encryptedLinks:n}=e,i=en(e);return{head:t,root:r,encryptedLinks:n,childMap:i}},Wl=e=>$r(Yl(e)),zl=(e,t)=>{const r=Kr(e);return Zr({encryptedGraph:r,keys:t})},{SIGNATURE:ql,ENCRYPTION:Jl,SYMMETRIC:Xl}=Bs,de=(e,t=je())=>{const{type:r,name:n=r}=e,i=Mi(`${n}:${r}:${t}`);return{type:r,name:n,generation:0,signature:be.keyPair(le(ql,i).slice(0,32)),encryption:he.keyPair(le(Jl,i).slice(0,32)),secretKey:le(Xl,i)}},Ql=e=>{let t;for(const r in e){const n=e[r];(t===void 0||n.generation>t.generation)&&(t=n)}return t},fe=e=>kl(e)?{type:e.type,name:e.name,generation:e.generation,encryption:e.encryption.publicKey,signature:e.signature.publicKey}:e,Zl=class extends Error{name;details;constructor(t,r){super(),this.message=t,this.details=r}},ef={validateHash(e,t){const{hash:r}=e,{encryptedBody:n}=t.encryptedLinks[r],i=at(n);return r===i?Le:se("The hash calculated for this link does not match.",{link:e,hash:r,expected:i})},validatePrev(e,t){for(const r of e.body.prev)if(!(r in t.links))return se("The link referenced by one of the hashes in the `prev` property does not exist.");return Le},validateRoot(e,t){const r=e.body.prev.length===0,n="type"in e.body&&e.body.type===Qt,i=Hl(t)===e;return r===i&&i===n?Le:se(n?r?"The ROOT link has to be the link referenced by the graph `root` property":"The ROOT link cannot have any predecessors":r?"Non-ROOT links must have predecessors":"The link referenced by the graph `root` property must be a ROOT link",{link:e,graph:t})},validateTimestamps(e,t){const{timestamp:r}=e.body,n=Date.now();if(r>n)return se("The link's timestamp is in the future.",{link:e,now:n});for(const i of e.body.prev){const s=t.links[i];if(s.body.timestamp>r)return se("This link's timestamp can't be earlier than a previous link.",{link:e,prevLink:s})}return Le}},se=(e,t)=>({isValid:!1,error:new Zl(e,t)}),tf=e=>{const t={},r=(n,i)=>`${le("memoize",n)}:${le("memoize",i)}`;for(const n in e)t[n]=oe(e[n],r);return t},rf=tf(ef),tn=(e,t={})=>{{const o=e.root,a=e.encryptedLinks[o],c=at(a.encryptedBody);if(c!==o)return se("Root hash does not match the hash of the root link",{rootHash:o,computedHash:c,rootLink:a})}for(const o of e.head){const a=e.encryptedLinks[o],c=at(a.encryptedBody);if(c!==o)return se("Head hash does not match the hash of the head link",{headHash:o,computedHash:c,headLink:a})}const r=Object.keys(e.encryptedLinks),n=Object.keys(e.links);if(r.length!==n.length)return se("Number of encrypted links does not match number of links",{encryptedLinkHashes:r,linkHashes:n});const s=((...o)=>a=>{const c=nf(o);for(const u in c){const d=c[u];try{const f=d(a,e);if(!f.isValid)return f}catch(f){const{message:l}=f;return se(l,f)}}return Le})(rf,t);for(const o of Object.values(e.links)){const a=s(o);if(!a.isValid)return a}return Le},nf=e=>e.reduce((t,r)=>Object.assign(t,r),{}),qs=({initialState:e,reducer:t,resolver:r,validators:n})=>i=>(tn(i,n),Ys(i,r).reduce(t,e)),sf=class extends zt{user;context;initialState;reducer;resolver;validators;keyring;graph;state;constructor({user:e,context:t={},graph:r,rootPayload:n,initialState:i={},reducer:s,validators:o,resolver:a=Ws,keys:c}){super(),r===void 0?(M(Zt(c),"If no graph is provided, only pass a single keyset, not a keyring."),this.graph=_l({user:e,rootPayload:n,keys:c})):of(r)?this.graph=r:(M(c),this.graph=zl(r,c)),this.context=t,this.initialState=i,this.reducer=s,this.validators=o,this.resolver=a,this.user=e,this.keyring=He(c),this.updateState()}getState(){return this.state}getGraph(){return this.graph}save(){return Wl(this.graph)}dispatch(e,t){const r={payload:void 0,...e};if(t===void 0){const i=this.graph.head.sort()[0],s=this.graph.encryptedLinks[i].recipientPublicKey;t=this.keyring[s]}else this.keyring[t.encryption.publicKey]=t;this.graph=Hs({graph:this.graph,action:r,user:this.user,keys:t,context:this.context});const[n]=Kl(this.graph);return this.state=this.reducer(this.state,n),this.emit("updated",{head:this.graph.head}),e}merge(e){this.graph=zs(this.graph,e),this.updateState()}validate(){return tn(this.graph,this.validators)}updateState(){const e=qs({initialState:this.initialState,reducer:this.reducer,resolver:this.resolver,validators:this.validators});this.state=e(this.graph),this.emit("updated",{head:this.graph.head})}},of=e=>e?.hasOwnProperty("root"),Xn=e=>new sf(e),af=(e,t)=>{const r={root:e.root,head:e.head},{their:n,our:i,lastCommonHead:s}=t,o={...t},a=e.head,c=n.head;if(i.reportedError)return r.error=i.reportedError,delete i.reportedError,[o,r];if(Mt(a,s))return[o,void 0];if(Mt(a,c))return o.lastCommonHead=a,[o,r];const f=Object.fromEntries([...c,...c.flatMap(m=>ct(e,m)),...s,...s.flatMap(m=>ct(e,m)),...Object.keys(n.parentMap),...i.links].map(m=>[m,!0]));let l=[];if(c.length>0&&c.every(m=>m in e.links))l=Kt(e).filter(m=>!(m in f));else{if(n.parentMap){const m={...e.encryptedLinks,...n.encryptedLinks};r.need=Object.keys(f).filter(g=>!(g in m)),l=Kt(e).filter(g=>!(g in f))}Mt(a,i.parentMapAtHead)||(r.parentMap=wr({graph:e,end:s}),o.our.parentMapAtHead=a)}const y=n.need.concat(l);if(y.length>0){r.links=Pl(e,y);const m=wr({graph:e,hashes:y});r.parentMap={...r.parentMap,...m}}return o.our.links=i.links.concat(y),o.their.need=[],[o,r]},Qn=()=>({their:{head:[],encryptedLinks:{},need:[],parentMap:{}},our:{head:[],links:[]},lastCommonHead:[],failedSyncCount:0}),cf=(e,t,r,n,i=Zr)=>{const s=He(n),o=r;M(e.root===o.root,"Can't sync graphs with different roots");const a={...t,their:{head:o.head,need:o.need??[],encryptedLinks:{...t.their.encryptedLinks,...o.links},parentMap:{...t.their.parentMap,...o.parentMap}}};if(Object.keys(a.their.encryptedLinks).length>0){const{head:c}=o,u=en(e),d=jl(a.their.parentMap),f={...u,...d},l={...e.encryptedLinks,...a.their.encryptedLinks},h={...e,head:c,encryptedLinks:l,childMap:f},p=i({encryptedGraph:h,keys:s}),y=zs(e,p),m=tn(y);m.isValid?e=y:(a.failedSyncCount+=1,a.our.reportedError=m.error),a.their.encryptedLinks={},a.their.parentMap={}}return[e,a]},Fv=(e,t=Qr(),r=je())=>({userName:e,userId:t,keys:de({type:Ll.USER,name:t},r)}),uf=e=>{const{userId:t,userName:r}=e;return{userId:t,userName:r,keys:fe(e.keys)}};/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var E=function(){return E=Object.assign||function(t){for(var r,n=1,i=arguments.length;n<i;n++){r=arguments[n];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t},E.apply(this,arguments)};function rn(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r}function R(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function k(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,s=[],o;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(a){o={error:a}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(o)throw o.error}}return s}function j(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,s;n<i;n++)(s||!(n in t))&&(s||(s=Array.prototype.slice.call(t,0,n)),s[n]=t[n]);return e.concat(s||Array.prototype.slice.call(t))}var $;(function(e){e.Start="xstate.start",e.Stop="xstate.stop",e.Raise="xstate.raise",e.Send="xstate.send",e.Cancel="xstate.cancel",e.NullEvent="",e.Assign="xstate.assign",e.After="xstate.after",e.DoneState="done.state",e.DoneInvoke="done.invoke",e.Log="xstate.log",e.Init="xstate.init",e.Invoke="xstate.invoke",e.ErrorExecution="error.execution",e.ErrorCommunication="error.communication",e.ErrorPlatform="error.platform",e.ErrorCustom="xstate.error",e.Update="xstate.update",e.Pure="xstate.pure",e.Choose="xstate.choose"})($||($={}));var $e;(function(e){e.Parent="#_parent",e.Internal="#_internal"})($e||($e={}));var Tr=$.Start,nn=$.Stop,pt=$.Raise,er=$.Send,Js=$.Cancel,df=$.NullEvent,sn=$.Assign;$.After;$.DoneState;var Xs=$.Log,lf=$.Init,Ar=$.Invoke;$.ErrorExecution;var Zn=$.ErrorPlatform,ff=$.ErrorCustom,Qs=$.Update,hf=$.Choose,vf=$.Pure,Zs=".",ei={},Mr="xstate.guard",yf="",bt;function on(e,t,r){r===void 0&&(r=Zs);var n=tt(e,r),i=tt(t,r);return C(i)?C(n)?i===n:!1:C(n)?n in i:Object.keys(n).every(function(s){return s in i?on(n[s],i[s]):!1})}function eo(e){try{return C(e)||typeof e=="number"?"".concat(e):e.type}catch{throw new Error("Events must be strings or objects with a string event.type property.")}}function Or(e,t){try{return Ve(e)?e:e.toString().split(t)}catch{throw new Error("'".concat(e,"' is not a valid state path."))}}function pf(e){return typeof e=="object"&&"value"in e&&"context"in e&&"event"in e&&"_event"in e}function tt(e,t){if(pf(e))return e.value;if(Ve(e))return Bt(e);if(typeof e!="string")return e;var r=Or(e,t);return Bt(r)}function Bt(e){if(e.length===1)return e[0];for(var t={},r=t,n=0;n<e.length-1;n++)n===e.length-2?r[e[n]]=e[n+1]:(r[e[n]]={},r=r[e[n]]);return t}function ze(e,t){for(var r={},n=Object.keys(e),i=0;i<n.length;i++){var s=n[i];r[s]=t(e[s],s,e,i)}return r}function ti(e,t,r){var n,i,s={};try{for(var o=R(Object.keys(e)),a=o.next();!a.done;a=o.next()){var c=a.value,u=e[c];r(u)&&(s[c]=t(u,c,e))}}catch(d){n={error:d}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}var mf=function(e){return function(t){var r,n,i=t;try{for(var s=R(e),o=s.next();!o.done;o=s.next()){var a=o.value;i=i[a]}}catch(c){r={error:c}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return i}};function gf(e,t){return function(r){var n,i,s=r;try{for(var o=R(e),a=o.next();!a.done;a=o.next()){var c=a.value;s=s[t][c]}}catch(u){n={error:u}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}}function Ot(e){if(!e)return[[]];if(C(e))return[[e]];var t=V(Object.keys(e).map(function(r){var n=e[r];return typeof n!="string"&&(!n||!Object.keys(n).length)?[[r]]:Ot(e[r]).map(function(i){return[r].concat(i)})}));return t}function V(e){var t;return(t=[]).concat.apply(t,j([],k(e),!1))}function to(e){return Ve(e)?e:[e]}function Z(e){return e===void 0?[]:to(e)}function jt(e,t,r){var n,i;if(N(e))return e(t,r.data);var s={};try{for(var o=R(Object.keys(e)),a=o.next();!a.done;a=o.next()){var c=a.value,u=e[c];N(u)?s[c]=u(t,r.data):s[c]=u}}catch(d){n={error:d}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return s}function Ef(e){return/^(done|error)\./.test(e)}function ri(e){return!!(e instanceof Promise||e!==null&&(N(e)||typeof e=="object")&&N(e.then))}function bf(e){return e!==null&&typeof e=="object"&&"transition"in e&&typeof e.transition=="function"}function If(e,t){var r,n,i=k([[],[]],2),s=i[0],o=i[1];try{for(var a=R(e),c=a.next();!c.done;c=a.next()){var u=c.value;t(u)?s.push(u):o.push(u)}}catch(d){r={error:d}}finally{try{c&&!c.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return[s,o]}function ro(e,t){return ze(e.states,function(r,n){if(r){var i=(C(t)?void 0:t[n])||(r?r.current:void 0);if(i)return{current:i,states:ro(r,i)}}})}function Sf(e,t){return{current:t,states:ro(e,t)}}function ni(e,t,r,n){var i=e&&r.reduce(function(s,o){var a,c,u=o.assignment,d={state:n,action:o,_event:t},f={};if(N(u))f=u(s,t.data,d);else try{for(var l=R(Object.keys(u)),h=l.next();!h.done;h=l.next()){var p=h.value,y=u[p];f[p]=N(y)?y(s,t.data,d):y}}catch(m){a={error:m}}finally{try{h&&!h.done&&(c=l.return)&&c.call(l)}finally{if(a)throw a.error}}return Object.assign({},s,f)},e);return i}var wf=function(){};function Ve(e){return Array.isArray(e)}function N(e){return typeof e=="function"}function C(e){return typeof e=="string"}function no(e,t){if(e)return C(e)?{type:Mr,name:e,predicate:t?t[e]:void 0}:N(e)?{type:Mr,name:e.name,predicate:e}:e}function Tf(e){try{return"subscribe"in e&&N(e.subscribe)}catch{return!1}}var ce=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();bt={},bt[ce]=function(){return this},bt[Symbol.observable]=function(){return this};function Ke(e){return!!e&&"__xstatenode"in e}function Af(e){return!!e&&typeof e.send=="function"}function tr(e,t){return C(e)||typeof e=="number"?E({type:e},t):e}function F(e,t){if(!C(e)&&"$$type"in e&&e.$$type==="scxml")return e;var r=tr(e);return E({name:r.type,data:r,$$type:"scxml",type:"external"},t)}function Me(e,t){var r=to(t).map(function(n){return typeof n>"u"||typeof n=="string"||Ke(n)?{target:n,event:e}:E(E({},n),{event:e})});return r}function Mf(e){if(!(e===void 0||e===yf))return Z(e)}function io(e,t,r,n,i){var s=e.options.guards,o={state:i,cond:t,_event:n};if(t.type===Mr)return(s?.[t.name]||t.predicate)(r,n.data,o);var a=s?.[t.type];if(!a)throw new Error("Guard '".concat(t.type,"' is not implemented on machine '").concat(e.id,"'."));return a(r,n.data,o)}function so(e){return typeof e=="string"?{type:e}:e}function xt(e,t,r){var n=function(){},i=typeof e=="object",s=i?e:null;return{next:((i?e.next:e)||n).bind(s),error:((i?e.error:t)||n).bind(s),complete:((i?e.complete:r)||n).bind(s)}}function It(e,t){return"".concat(e,":invocation[").concat(t,"]")}function xr(e){return(e.type===pt||e.type===er&&e.to===$e.Internal)&&typeof e.delay!="number"}var Ne=F({type:lf});function _r(e,t){return t&&t[e]||void 0}function ut(e,t){var r;if(C(e)||typeof e=="number"){var n=_r(e,t);N(n)?r={type:e,exec:n}:n?r=n:r={type:e,exec:void 0}}else if(N(e))r={type:e.name||e.toString(),exec:e};else{var n=_r(e.type,t);if(N(n))r=E(E({},e),{exec:n});else if(n){var i=n.type||e.type;r=E(E(E({},n),e),{type:i})}else r=e}return r}var ue=function(e,t){if(!e)return[];var r=Ve(e)?e:[e];return r.map(function(n){return ut(n,t)})};function an(e){var t=ut(e);return E(E({id:C(e)?e:t.id},t),{type:t.type})}function Of(e,t){return{type:pt,event:typeof e=="function"?e:tr(e),delay:t?t.delay:void 0,id:t?.id}}function xf(e,t,r,n){var i={_event:r},s=F(N(e.event)?e.event(t,r.data,i):e.event),o;if(C(e.delay)){var a=n&&n[e.delay];o=N(a)?a(t,r.data,i):a}else o=N(e.delay)?e.delay(t,r.data,i):e.delay;return E(E({},e),{type:pt,_event:s,delay:o})}function _f(e,t){return{to:t?t.to:void 0,type:er,event:N(e)?e:tr(e),delay:t?t.delay:void 0,id:t&&t.id!==void 0?t.id:N(e)?e.name:eo(e)}}function Rf(e,t,r,n){var i={_event:r},s=F(N(e.event)?e.event(t,r.data,i):e.event),o;if(C(e.delay)){var a=n&&n[e.delay];o=N(a)?a(t,r.data,i):a}else o=N(e.delay)?e.delay(t,r.data,i):e.delay;var c=N(e.to)?e.to(t,r.data,i):e.to;return E(E({},e),{to:c,_event:s,event:s.data,delay:o})}var Lf=function(e,t,r){return E(E({},e),{value:C(e.expr)?e.expr:e.expr(t,r.data,{_event:r})})},kf=function(e){return{type:Js,sendId:e}};function Nf(e){var t=an(e);return{type:$.Start,activity:t,exec:void 0}}function Df(e){var t=N(e)?e:an(e);return{type:$.Stop,activity:t,exec:void 0}}function Cf(e,t,r){var n=N(e.activity)?e.activity(t,r.data):e.activity,i=typeof n=="string"?{id:n}:n,s={type:$.Stop,activity:i};return s}var Pf=function(e){return{type:sn,assignment:e}};function $f(e,t){var r=t?"#".concat(t):"";return"".concat($.After,"(").concat(e,")").concat(r)}function St(e,t){var r="".concat($.DoneState,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function _t(e,t){var r="".concat($.DoneInvoke,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}function qe(e,t){var r="".concat($.ErrorPlatform,".").concat(e),n={type:r,data:t};return n.toString=function(){return r},n}var Kf=function(e){var t,r,n=[];try{for(var i=R(e),s=i.next();!s.done;s=i.next())for(var o=s.value,a=0;a<o.actions.length;){if(o.actions[a].type===sn){n.push(o.actions[a]),o.actions.splice(a,1);continue}a++}}catch(c){t={error:c}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return n};function Ht(e,t,r,n,i,s,o){o===void 0&&(o=!1);var a=o?[]:Kf(i),c=a.length?ni(r,n,a,t):r,u=o?[r]:void 0,d=[];function f(p,y){var m;switch(y.type){case pt:{var g=xf(y,c,n,e.options.delays);return s&&typeof g.delay=="number"&&s(g,c,n),g}case er:var b=Rf(y,c,n,e.options.delays);return s&&b.to!==$e.Internal&&(p==="entry"?d.push(b):s(b,c,n)),b;case Xs:{var S=Lf(y,c,n);return s?.(S,c,n),S}case hf:{var T=y,_=(m=T.conds.find(function(Se){var te=no(Se.cond,e.options.guards);return!te||io(e,te,c,n,s?void 0:t)}))===null||m===void 0?void 0:m.actions;if(!_)return[];var D=k(Ht(e,t,c,n,[{type:p,actions:ue(Z(_),e.options.actions)}],s,o),2),L=D[0],v=D[1];return c=v,u?.push(c),L}case vf:{var _=y.get(c,n.data);if(!_)return[];var I=k(Ht(e,t,c,n,[{type:p,actions:ue(Z(_),e.options.actions)}],s,o),2),x=I[0],w=I[1];return c=w,u?.push(c),x}case nn:{var S=Cf(y,c,n);return s?.(S,r,n),S}case sn:{c=ni(c,n,[y],s?void 0:t),u?.push(c);break}default:var A=ut(y,e.options.actions),P=A.exec;if(s)s(A,c,n);else if(P&&u){var Y=u.length-1,ae=E(E({},A),{exec:function(Se){for(var te=[],me=1;me<arguments.length;me++)te[me-1]=arguments[me];P.apply(void 0,j([u[Y]],k(te),!1))}});A=ae}return A}}function l(p){var y,m,g=[];try{for(var b=R(p.actions),S=b.next();!S.done;S=b.next()){var T=S.value,_=f(p.type,T);_&&(g=g.concat(_))}}catch(D){y={error:D}}finally{try{S&&!S.done&&(m=b.return)&&m.call(b)}finally{if(y)throw y.error}}return d.forEach(function(D){s(D,c,n)}),d.length=0,g}var h=V(i.map(l));return[h,c]}var ii=[],Re=function(e,t){ii.push(e);var r=t(e);return ii.pop(),r};function oo(e){var t;return t={id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:e}}},t[ce]=function(){return this},t}function Bf(e,t,r,n){var i,s=so(e.src),o=(i=t?.options.services)===null||i===void 0?void 0:i[s.type],a=e.data?jt(e.data,r,n):void 0,c=o?ao(o,e.id,a):oo(e.id);return c.meta=e,c}function ao(e,t,r){var n=oo(t);if(n.deferred=!0,Ke(e)){var i=n.state=Re(void 0,function(){return(r?e.withContext(r):e).initialState});n.getSnapshot=function(){return i}}return n}function jf(e){try{return typeof e.send=="function"}catch{return!1}}function Hf(e){return jf(e)&&"id"in e}function Vf(e){var t;return E((t={subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},t[ce]=function(){return this},t),e)}var Vt=function(e){return e.type==="atomic"||e.type==="final"};function co(e){return Object.keys(e.states).map(function(t){return e.states[t]})}function dt(e){return co(e).filter(function(t){return t.type!=="history"})}function uo(e){var t=[e];return Vt(e)?t:t.concat(V(dt(e).map(uo)))}function Je(e,t){var r,n,i,s,o,a,c,u,d=new Set(e),f=Rr(d),l=new Set(t);try{for(var h=R(l),p=h.next();!p.done;p=h.next())for(var y=p.value,m=y.parent;m&&!l.has(m);)l.add(m),m=m.parent}catch(I){r={error:I}}finally{try{p&&!p.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}var g=Rr(l);try{for(var b=R(l),S=b.next();!S.done;S=b.next()){var y=S.value;if(y.type==="compound"&&(!g.get(y)||!g.get(y).length))f.get(y)?f.get(y).forEach(function(x){return l.add(x)}):y.initialStateNodes.forEach(function(x){return l.add(x)});else if(y.type==="parallel")try{for(var T=(o=void 0,R(dt(y))),_=T.next();!_.done;_=T.next()){var D=_.value;l.has(D)||(l.add(D),f.get(D)?f.get(D).forEach(function(x){return l.add(x)}):D.initialStateNodes.forEach(function(x){return l.add(x)}))}}catch(x){o={error:x}}finally{try{_&&!_.done&&(a=T.return)&&a.call(T)}finally{if(o)throw o.error}}}}catch(I){i={error:I}}finally{try{S&&!S.done&&(s=b.return)&&s.call(b)}finally{if(i)throw i.error}}try{for(var L=R(l),v=L.next();!v.done;v=L.next())for(var y=v.value,m=y.parent;m&&!l.has(m);)l.add(m),m=m.parent}catch(I){c={error:I}}finally{try{v&&!v.done&&(u=L.return)&&u.call(L)}finally{if(c)throw c.error}}return l}function lo(e,t){var r=t.get(e);if(!r)return{};if(e.type==="compound"){var n=r[0];if(n){if(Vt(n))return n.key}else return{}}var i={};return r.forEach(function(s){i[s.key]=lo(s,t)}),i}function Rr(e){var t,r,n=new Map;try{for(var i=R(e),s=i.next();!s.done;s=i.next()){var o=s.value;n.has(o)||n.set(o,[]),o.parent&&(n.has(o.parent)||n.set(o.parent,[]),n.get(o.parent).push(o))}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return n}function Uf(e,t){var r=Je([e],t);return lo(e,Rr(r))}function Xe(e,t){return Array.isArray(e)?e.some(function(r){return r===t}):e instanceof Set?e.has(t):!1}function Ff(e){return j([],k(new Set(V(j([],k(e.map(function(t){return t.ownEvents})),!1)))),!1)}function Rt(e,t){return t.type==="compound"?dt(t).some(function(r){return r.type==="final"&&Xe(e,r)}):t.type==="parallel"?dt(t).every(function(r){return Rt(e,r)}):!1}function Gf(e){return e===void 0&&(e=[]),e.reduce(function(t,r){return r.meta!==void 0&&(t[r.id]=r.meta),t},{})}function si(e){return new Set(V(e.map(function(t){return t.tags})))}function fo(e,t){if(e===t)return!0;if(e===void 0||t===void 0)return!1;if(C(e)||C(t))return e===t;var r=Object.keys(e),n=Object.keys(t);return r.length===n.length&&r.every(function(i){return fo(e[i],t[i])})}function Yf(e){return typeof e!="object"||e===null?!1:"value"in e&&"_event"in e}function Wf(e,t){var r=e.exec,n=E(E({},e),{exec:r!==void 0?function(){return r(t.context,t.event,{action:e,state:t,_event:t._event})}:void 0});return n}var re=function(){function e(t){var r=this,n;this.actions=[],this.activities=ei,this.meta={},this.events=[],this.value=t.value,this.context=t.context,this._event=t._event,this._sessionid=t._sessionid,this.event=this._event.data,this.historyValue=t.historyValue,this.history=t.history,this.actions=t.actions||[],this.activities=t.activities||ei,this.meta=Gf(t.configuration),this.events=t.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=t.configuration,this.transitions=t.transitions,this.children=t.children,this.done=!!t.done,this.tags=(n=Array.isArray(t.tags)?new Set(t.tags):t.tags)!==null&&n!==void 0?n:new Set,this.machine=t.machine,Object.defineProperty(this,"nextEvents",{get:function(){return Ff(r.configuration)}})}return e.from=function(t,r){if(t instanceof e)return t.context!==r?new e({value:t.value,context:r,_event:t._event,_sessionid:null,historyValue:t.historyValue,history:t.history,actions:[],activities:t.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):t;var n=Ne;return new e({value:t,context:r,_event:n,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},e.create=function(t){return new e(t)},e.inert=function(t,r){if(t instanceof e){if(!t.actions.length)return t;var n=Ne;return new e({value:t.value,context:r,_event:n,_sessionid:null,historyValue:t.historyValue,history:t.history,activities:t.activities,configuration:t.configuration,transitions:[],children:{}})}return e.from(t,r)},e.prototype.toStrings=function(t,r){var n=this;if(t===void 0&&(t=this.value),r===void 0&&(r="."),C(t))return[t];var i=Object.keys(t);return i.concat.apply(i,j([],k(i.map(function(s){return n.toStrings(t[s],r).map(function(o){return s+r+o})})),!1))},e.prototype.toJSON=function(){var t=this;t.configuration,t.transitions;var r=t.tags;t.machine;var n=rn(t,["configuration","transitions","tags","machine"]);return E(E({},n),{tags:Array.from(r)})},e.prototype.matches=function(t){return on(t,this.value)},e.prototype.hasTag=function(t){return this.tags.has(t)},e.prototype.can=function(t){var r;wf(!!this.machine);var n=(r=this.machine)===null||r===void 0?void 0:r.getTransitionData(this,t);return!!n?.transitions.length&&n.transitions.some(function(i){return i.target!==void 0||i.actions.length})},e}(),zf={deferEvents:!1},oi=function(){function e(t){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=E(E({},zf),t)}return e.prototype.initialize=function(t){if(this.initialized=!0,t){if(!this.options.deferEvents){this.schedule(t);return}this.process(t)}this.flushEvents()},e.prototype.schedule=function(t){if(!this.initialized||this.processingEvent){this.queue.push(t);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(t),this.flushEvents()},e.prototype.clear=function(){this.queue=[]},e.prototype.flushEvents=function(){for(var t=this.queue.shift();t;)this.process(t),t=this.queue.shift()},e.prototype.process=function(t){this.processingEvent=!0;try{t()}catch(r){throw this.clear(),r}finally{this.processingEvent=!1}},e}(),ur=new Map,qf=0,Fe={bookId:function(){return"x:".concat(qf++)},register:function(e,t){return ur.set(e,t),e},get:function(e){return ur.get(e)},free:function(e){ur.delete(e)}};function cn(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof Sn<"u")return Sn}function Jf(){var e=cn();if(e&&"__xstate__"in e)return e.__xstate__}function Xf(e){if(cn()){var t=Jf();t&&t.register(e)}}function Qf(e,t){t===void 0&&(t={});var r=e.initialState,n=new Set,i=[],s=!1,o=function(){if(!s){for(s=!0;i.length>0;){var u=i.shift();r=e.transition(r,u,c),n.forEach(function(d){return d.next(r)})}s=!1}},a=Vf({id:t.id,send:function(u){i.push(u),o()},getSnapshot:function(){return r},subscribe:function(u,d,f){var l=xt(u,d,f);return n.add(l),l.next(r),{unsubscribe:function(){n.delete(l)}}}}),c={parent:t.parent,self:a,id:t.id||"anonymous",observers:n};return r=e.start?e.start(c):r,a}var Zf={sync:!1,autoForward:!1},U;(function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped"})(U||(U={}));var eh=function(){function e(t,r){r===void 0&&(r=e.defaultOptions);var n=this;this.machine=t,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=U.NotStarted,this.children=new Map,this.forwardTo=new Set,this._outgoingQueue=[],this.init=this.start,this.send=function(d,f){if(Ve(d))return n.batch(d),n.state;var l=F(tr(d,f));if(n.status===U.Stopped)return n.state;if(n.status!==U.Running&&!n.options.deferEvents)throw new Error('Event "'.concat(l.name,'" was sent to uninitialized service "').concat(n.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(l.data)));return n.scheduler.schedule(function(){n.forward(l);var h=n._nextState(l);n.update(h,l)}),n._state},this.sendTo=function(d,f,l){var h=n.parent&&(f===$e.Parent||n.parent.id===f),p=h?n.parent:C(f)?f===$e.Internal?n:n.children.get(f)||Fe.get(f):Af(f)?f:void 0;if(!p){if(!h)throw new Error("Unable to send event to child '".concat(f,"' from service '").concat(n.id,"'."));return}if("machine"in p){if(n.status!==U.Stopped||n.parent!==p||n.state.done){var y=E(E({},d),{name:d.name===ff?"".concat(qe(n.id)):d.name,origin:n.sessionId});!l&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([p,y]):p.send(y)}}else!l&&n.machine.config.predictableActionArguments?n._outgoingQueue.push([p,d.data]):p.send(d.data)},this._exec=function(d,f,l,h){h===void 0&&(h=n.machine.options.actions);var p=d.exec||_r(d.type,h),y=N(p)?p:p?p.exec:d.exec;if(y)try{return y(f,l.data,n.machine.config.predictableActionArguments?{action:d,_event:l}:{action:d,state:n.state,_event:l})}catch(Y){throw n.parent&&n.parent.send({type:"xstate.error",data:Y}),Y}switch(d.type){case pt:{var m=d;n.defer(m);break}case er:var g=d;if(typeof g.delay=="number"){n.defer(g);return}else g.to?n.sendTo(g._event,g.to,l===Ne):n.send(g._event);break;case Js:n.cancel(d.sendId);break;case Tr:{if(n.status!==U.Running)return;var b=d.activity;if(!n.machine.config.predictableActionArguments&&!n.state.activities[b.id||b.type])break;if(b.type===$.Invoke){var S=so(b.src),T=n.machine.options.services?n.machine.options.services[S.type]:void 0,_=b.id,D=b.data,L="autoForward"in b?b.autoForward:!!b.forward;if(!T)return;var v=D?jt(D,f,l):void 0;if(typeof T=="string")return;var I=N(T)?T(f,l.data,{data:v,src:S,meta:b.meta}):T;if(!I)return;var x=void 0;Ke(I)&&(I=v?I.withContext(v):I,x={autoForward:L}),n.spawn(I,_,x)}else n.spawnActivity(b);break}case nn:{n.stopChild(d.activity.id);break}case Xs:var w=d,A=w.label,P=w.value;A?n.logger(A,P):n.logger(P);break}};var i=E(E({},e.defaultOptions),r),s=i.clock,o=i.logger,a=i.parent,c=i.id,u=c!==void 0?c:t.id;this.id=u,this.logger=o,this.clock=s,this.parent=a,this.options=i,this.scheduler=new oi({deferEvents:this.options.deferEvents}),this.sessionId=Fe.bookId()}return Object.defineProperty(e.prototype,"initialState",{get:function(){var t=this;return this._initialState?this._initialState:Re(this,function(){return t._initialState=t.machine.initialState,t._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),e.prototype.execute=function(t,r){var n,i;try{for(var s=R(t.actions),o=s.next();!o.done;o=s.next()){var a=o.value;this.exec(a,t,r)}}catch(c){n={error:c}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}},e.prototype.update=function(t,r){var n,i,s,o,a,c,u,d,f=this;if(t._sessionid=this.sessionId,this._state=t,(!this.machine.config.predictableActionArguments||r===Ne)&&this.options.execute)this.execute(this.state);else for(var l=void 0;l=this._outgoingQueue.shift();)l[0].send(l[1]);if(this.children.forEach(function(I){f.state.children[I.id]=I}),this.devTools&&this.devTools.send(r.data,t),t.event)try{for(var h=R(this.eventListeners),p=h.next();!p.done;p=h.next()){var y=p.value;y(t.event)}}catch(I){n={error:I}}finally{try{p&&!p.done&&(i=h.return)&&i.call(h)}finally{if(n)throw n.error}}try{for(var m=R(this.listeners),g=m.next();!g.done;g=m.next()){var y=g.value;y(t,t.event)}}catch(I){s={error:I}}finally{try{g&&!g.done&&(o=m.return)&&o.call(m)}finally{if(s)throw s.error}}try{for(var b=R(this.contextListeners),S=b.next();!S.done;S=b.next()){var T=S.value;T(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(I){a={error:I}}finally{try{S&&!S.done&&(c=b.return)&&c.call(b)}finally{if(a)throw a.error}}if(this.state.done){var _=t.configuration.find(function(I){return I.type==="final"&&I.parent===f.machine}),D=_&&_.doneData?jt(_.doneData,t.context,r):void 0;this._doneEvent=_t(this.id,D);try{for(var L=R(this.doneListeners),v=L.next();!v.done;v=L.next()){var y=v.value;y(this._doneEvent)}}catch(I){u={error:I}}finally{try{v&&!v.done&&(d=L.return)&&d.call(L)}finally{if(u)throw u.error}}this._stop(),this._stopChildren(),Fe.free(this.sessionId)}},e.prototype.onTransition=function(t){return this.listeners.add(t),this.status===U.Running&&t(this.state,this.state.event),this},e.prototype.subscribe=function(t,r,n){var i=this,s=xt(t,r,n);this.listeners.add(s.next),this.status!==U.NotStarted&&s.next(this.state);var o=function(){i.doneListeners.delete(o),i.stopListeners.delete(o),s.complete()};return this.status===U.Stopped?s.complete():(this.onDone(o),this.onStop(o)),{unsubscribe:function(){i.listeners.delete(s.next),i.doneListeners.delete(o),i.stopListeners.delete(o)}}},e.prototype.onEvent=function(t){return this.eventListeners.add(t),this},e.prototype.onSend=function(t){return this.sendListeners.add(t),this},e.prototype.onChange=function(t){return this.contextListeners.add(t),this},e.prototype.onStop=function(t){return this.stopListeners.add(t),this},e.prototype.onDone=function(t){return this.status===U.Stopped&&this._doneEvent?t(this._doneEvent):this.doneListeners.add(t),this},e.prototype.off=function(t){return this.listeners.delete(t),this.eventListeners.delete(t),this.sendListeners.delete(t),this.stopListeners.delete(t),this.doneListeners.delete(t),this.contextListeners.delete(t),this},e.prototype.start=function(t){var r=this;if(this.status===U.Running)return this;this.machine._init(),Fe.register(this.sessionId,this),this.initialized=!0,this.status=U.Running;var n=t===void 0?this.initialState:Re(this,function(){return Yf(t)?r.machine.resolveState(t):r.machine.resolveState(re.from(t,r.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){r.update(n,Ne)}),this},e.prototype._stopChildren=function(){this.children.forEach(function(t){N(t.stop)&&t.stop()}),this.children.clear()},e.prototype._stop=function(){var t,r,n,i,s,o,a,c,u,d;try{for(var f=R(this.listeners),l=f.next();!l.done;l=f.next()){var h=l.value;this.listeners.delete(h)}}catch(L){t={error:L}}finally{try{l&&!l.done&&(r=f.return)&&r.call(f)}finally{if(t)throw t.error}}try{for(var p=R(this.stopListeners),y=p.next();!y.done;y=p.next()){var h=y.value;h(),this.stopListeners.delete(h)}}catch(L){n={error:L}}finally{try{y&&!y.done&&(i=p.return)&&i.call(p)}finally{if(n)throw n.error}}try{for(var m=R(this.contextListeners),g=m.next();!g.done;g=m.next()){var h=g.value;this.contextListeners.delete(h)}}catch(L){s={error:L}}finally{try{g&&!g.done&&(o=m.return)&&o.call(m)}finally{if(s)throw s.error}}try{for(var b=R(this.doneListeners),S=b.next();!S.done;S=b.next()){var h=S.value;this.doneListeners.delete(h)}}catch(L){a={error:L}}finally{try{S&&!S.done&&(c=b.return)&&c.call(b)}finally{if(a)throw a.error}}if(!this.initialized)return this;this.initialized=!1,this.status=U.Stopped,this._initialState=void 0;try{for(var T=R(Object.keys(this.delayedEventsMap)),_=T.next();!_.done;_=T.next()){var D=_.value;this.clock.clearTimeout(this.delayedEventsMap[D])}}catch(L){u={error:L}}finally{try{_&&!_.done&&(d=T.return)&&d.call(T)}finally{if(u)throw u.error}}this.scheduler.clear(),this.scheduler=new oi({deferEvents:this.options.deferEvents})},e.prototype.stop=function(){var t=this,r=this.scheduler;return this._stop(),r.schedule(function(){var n;if(!(!((n=t._state)===null||n===void 0)&&n.done)){var i=F({type:"xstate.stop"}),s=Re(t,function(){var o=V(j([],k(t.state.configuration),!1).sort(function(f,l){return l.order-f.order}).map(function(f){return ue(f.onExit,t.machine.options.actions)})),a=k(Ht(t.machine,t.state,t.state.context,i,[{type:"exit",actions:o}],t.machine.config.predictableActionArguments?t._exec:void 0,t.machine.config.predictableActionArguments||t.machine.config.preserveActionOrder),2),c=a[0],u=a[1],d=new re({value:t.state.value,context:u,_event:i,_sessionid:t.sessionId,historyValue:void 0,history:t.state,actions:c.filter(function(f){return!xr(f)}),activities:{},events:[],configuration:[],transitions:[],children:{},done:t.state.done,tags:t.state.tags,machine:t.machine});return d.changed=!0,d});t.update(s,i),t._stopChildren(),Fe.free(t.sessionId)}}),this},e.prototype.batch=function(t){var r=this;if(!(this.status===U.NotStarted&&this.options.deferEvents)){if(this.status!==U.Running)throw new Error("".concat(t.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'))}if(t.length){var n=!!this.machine.config.predictableActionArguments&&this._exec;this.scheduler.schedule(function(){var i,s,o=r.state,a=!1,c=[],u=function(h){var p=F(h);r.forward(p),o=Re(r,function(){return r.machine.transition(o,p,void 0,n||void 0)}),c.push.apply(c,j([],k(r.machine.config.predictableActionArguments?o.actions:o.actions.map(function(y){return Wf(y,o)})),!1)),a=a||!!o.changed};try{for(var d=R(t),f=d.next();!f.done;f=d.next()){var l=f.value;u(l)}}catch(h){i={error:h}}finally{try{f&&!f.done&&(s=d.return)&&s.call(d)}finally{if(i)throw i.error}}o.changed=a,o.actions=c,r.update(o,F(t[t.length-1]))})}},e.prototype.sender=function(t){return this.send.bind(this,t)},e.prototype._nextState=function(t,r){var n=this;r===void 0&&(r=!!this.machine.config.predictableActionArguments&&this._exec);var i=F(t);if(i.name.indexOf(Zn)===0&&!this.state.nextEvents.some(function(o){return o.indexOf(Zn)===0}))throw i.data.data;var s=Re(this,function(){return n.machine.transition(n.state,i,void 0,r||void 0)});return s},e.prototype.nextState=function(t){return this._nextState(t,!1)},e.prototype.forward=function(t){var r,n;try{for(var i=R(this.forwardTo),s=i.next();!s.done;s=i.next()){var o=s.value,a=this.children.get(o);if(!a)throw new Error("Unable to forward event '".concat(t,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(o,"'."));a.send(t)}}catch(c){r={error:c}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}},e.prototype.defer=function(t){var r=this,n=this.clock.setTimeout(function(){"to"in t&&t.to?r.sendTo(t._event,t.to,!0):r.send(t._event)},t.delay);t.id&&(this.delayedEventsMap[t.id]=n)},e.prototype.cancel=function(t){this.clock.clearTimeout(this.delayedEventsMap[t]),delete this.delayedEventsMap[t]},e.prototype.exec=function(t,r,n){n===void 0&&(n=this.machine.options.actions),this._exec(t,r.context,r._event,n)},e.prototype.removeChild=function(t){var r;this.children.delete(t),this.forwardTo.delete(t),(r=this.state)===null||r===void 0||delete r.children[t]},e.prototype.stopChild=function(t){var r=this.children.get(t);r&&(this.removeChild(t),N(r.stop)&&r.stop())},e.prototype.spawn=function(t,r,n){if(this.status!==U.Running)return ao(t,r);if(ri(t))return this.spawnPromise(Promise.resolve(t),r);if(N(t))return this.spawnCallback(t,r);if(Hf(t))return this.spawnActor(t,r);if(Tf(t))return this.spawnObservable(t,r);if(Ke(t))return this.spawnMachine(t,E(E({},n),{id:r}));if(bf(t))return this.spawnBehavior(t,r);throw new Error('Unable to spawn entity "'.concat(r,'" of type "').concat(typeof t,'".'))},e.prototype.spawnMachine=function(t,r){var n=this;r===void 0&&(r={});var i=new e(t,E(E({},this.options),{parent:this,id:r.id||t.id})),s=E(E({},Zf),r);s.sync&&i.onTransition(function(a){n.send(Qs,{state:a,id:i.id})});var o=i;return this.children.set(i.id,o),s.autoForward&&this.forwardTo.add(i.id),i.onDone(function(a){n.removeChild(i.id),n.send(F(a,{origin:i.id}))}).start(),o},e.prototype.spawnBehavior=function(t,r){var n=Qf(t,{id:r,parent:this});return this.children.set(r,n),n},e.prototype.spawnPromise=function(t,r){var n,i=this,s=!1,o;t.then(function(c){s||(o=c,i.removeChild(r),i.send(F(_t(r,c),{origin:r})))},function(c){if(!s){i.removeChild(r);var u=qe(r,c);try{i.send(F(u,{origin:r}))}catch{i.devTools&&i.devTools.send(u,i.state),i.machine.strict&&i.stop()}}});var a=(n={id:r,send:function(){},subscribe:function(c,u,d){var f=xt(c,u,d),l=!1;return t.then(function(h){l||(f.next(h),!l&&f.complete())},function(h){l||f.error(h)}),{unsubscribe:function(){return l=!0}}},stop:function(){s=!0},toJSON:function(){return{id:r}},getSnapshot:function(){return o}},n[ce]=function(){return this},n);return this.children.set(r,a),a},e.prototype.spawnCallback=function(t,r){var n,i=this,s=!1,o=new Set,a=new Set,c,u=function(l){c=l,a.forEach(function(h){return h(l)}),!s&&i.send(F(l,{origin:r}))},d;try{d=t(u,function(l){o.add(l)})}catch(l){this.send(qe(r,l))}if(ri(d))return this.spawnPromise(d,r);var f=(n={id:r,send:function(l){return o.forEach(function(h){return h(l)})},subscribe:function(l){var h=xt(l);return a.add(h.next),{unsubscribe:function(){a.delete(h.next)}}},stop:function(){s=!0,N(d)&&d()},toJSON:function(){return{id:r}},getSnapshot:function(){return c}},n[ce]=function(){return this},n);return this.children.set(r,f),f},e.prototype.spawnObservable=function(t,r){var n,i=this,s,o=t.subscribe(function(c){s=c,i.send(F(c,{origin:r}))},function(c){i.removeChild(r),i.send(F(qe(r,c),{origin:r}))},function(){i.removeChild(r),i.send(F(_t(r),{origin:r}))}),a=(n={id:r,send:function(){},subscribe:function(c,u,d){return t.subscribe(c,u,d)},stop:function(){return o.unsubscribe()},getSnapshot:function(){return s},toJSON:function(){return{id:r}}},n[ce]=function(){return this},n);return this.children.set(r,a),a},e.prototype.spawnActor=function(t,r){return this.children.set(r,t),t},e.prototype.spawnActivity=function(t){var r=this.machine.options&&this.machine.options.activities?this.machine.options.activities[t.type]:void 0;if(r){var n=r(this.state.context,t);this.spawnEffect(t.id,n)}},e.prototype.spawnEffect=function(t,r){var n;this.children.set(t,(n={id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:r||void 0,getSnapshot:function(){},toJSON:function(){return{id:t}}},n[ce]=function(){return this},n))},e.prototype.attachDev=function(){var t=cn();if(this.options.devTools&&t){if(t.__REDUX_DEVTOOLS_EXTENSION__){var r=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=t.__REDUX_DEVTOOLS_EXTENSION__.connect(E(E({name:this.id,autoPause:!0,stateSanitizer:function(n){return{value:n.value,context:n.context,actions:n.actions}}},r),{features:E({jump:!1,skip:!1},r?r.features:void 0)}),this.machine),this.devTools.init(this.state)}Xf(this)}},e.prototype.toJSON=function(){return{id:this.id}},e.prototype[ce]=function(){return this},e.prototype.getSnapshot=function(){return this.status===U.NotStarted?this.initialState:this._state},e.defaultOptions={execute:!0,deferEvents:!0,clock:{setTimeout:function(t,r){return setTimeout(t,r)},clearTimeout:function(t){return clearTimeout(t)}},logger:console.log.bind(console),devTools:!1},e.interpret=ho,e}();function ho(e,t){var r=new eh(e,t);return r}function th(e){if(typeof e=="string"){var t={type:e};return t.toString=function(){return e},t}return e}function wt(e){return E(E({type:Ar},e),{toJSON:function(){e.onDone,e.onError;var t=rn(e,["onDone","onError"]);return E(E({},t),{type:Ar,src:th(e.src)})}})}var Tt="",Lr="#",dr="*",Oe={},xe=function(e){return e[0]===Lr},rh=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},nh=function(){function e(t,r,n,i){n===void 0&&(n="context"in t?t.context:void 0);var s=this,o;this.config=t,this._context=n,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.tags=[],this.options=Object.assign(rh(),r),this.parent=i?.parent,this.key=this.config.key||i?.key||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:Zs),this.id=this.config.id||j([this.machine.key],k(this.path),!1).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.schema=this.parent?this.machine.schema:(o=this.config.schema)!==null&&o!==void 0?o:{},this.description=this.config.description,this.initial=this.config.initial,this.states=this.config.states?ze(this.config.states,function(u,d){var f,l=new e(u,{},void 0,{parent:s,key:d});return Object.assign(s.idMap,E((f={},f[l.id]=l,f),l.idMap)),l}):Oe;var a=0;function c(u){var d,f;u.order=a++;try{for(var l=R(co(u)),h=l.next();!h.done;h=l.next()){var p=h.value;c(p)}}catch(y){d={error:y}}finally{try{h&&!h.done&&(f=l.return)&&f.call(l)}finally{if(d)throw d.error}}}c(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(u){var d=u.event;return d===Tt}):Tt in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=Z(this.config.entry||this.config.onEntry).map(function(u){return ut(u)}),this.onExit=Z(this.config.exit||this.config.onExit).map(function(u){return ut(u)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=Z(this.config.invoke).map(function(u,d){var f,l;if(Ke(u)){var h=It(s.id,d);return s.machine.options.services=E((f={},f[h]=u,f),s.machine.options.services),wt({src:h,id:h})}else if(C(u.src)){var h=u.id||It(s.id,d);return wt(E(E({},u),{id:h,src:u.src}))}else if(Ke(u.src)||N(u.src)){var h=u.id||It(s.id,d);return s.machine.options.services=E((l={},l[h]=u.src,l),s.machine.options.services),wt(E(E({id:h},u),{src:h}))}else{var p=u.src;return wt(E(E({id:It(s.id,d)},u),{src:p}))}}),this.activities=Z(this.config.activities).concat(this.invoke).map(function(u){return an(u)}),this.transition=this.transition.bind(this),this.tags=Z(this.config.tags)}return e.prototype._init=function(){this.__cache.transitions||uo(this).forEach(function(t){return t.on})},e.prototype.withConfig=function(t,r){var n=this.options,i=n.actions,s=n.activities,o=n.guards,a=n.services,c=n.delays;return new e(this.config,{actions:E(E({},i),t.actions),activities:E(E({},s),t.activities),guards:E(E({},o),t.guards),services:E(E({},a),t.services),delays:E(E({},c),t.delays)},r??this.context)},e.prototype.withContext=function(t){return new e(this.config,this.options,t)},Object.defineProperty(e.prototype,"context",{get:function(){return N(this._context)?this._context():this._context},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:ze(this.states,function(t){return t.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke,description:this.description,tags:this.tags}},enumerable:!1,configurable:!0}),e.prototype.toJSON=function(){return this.definition},Object.defineProperty(e.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var t=this.transitions;return this.__cache.on=t.reduce(function(r,n){return r[n.eventType]=r[n.eventType]||[],r[n.eventType].push(n),r},{})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),e.prototype.getCandidates=function(t){if(this.__cache.candidates[t])return this.__cache.candidates[t];var r=t===Tt,n=this.transitions.filter(function(i){var s=i.eventType===t;return r?s:s||i.eventType===dr});return this.__cache.candidates[t]=n,n},e.prototype.getDelayedTransitions=function(){var t=this,r=this.config.after;if(!r)return[];var n=function(s,o){var a=N(s)?"".concat(t.id,":delay[").concat(o,"]"):s,c=$f(a,t.id);return t.onEntry.push(_f(c,{delay:s})),t.onExit.push(kf(c)),c},i=Ve(r)?r.map(function(s,o){var a=n(s.delay,o);return E(E({},s),{event:a})}):V(Object.keys(r).map(function(s,o){var a=r[s],c=C(a)?{target:a}:a,u=isNaN(+s)?s:+s,d=n(u,o);return Z(c).map(function(f){return E(E({},f),{event:d,delay:u})})}));return i.map(function(s){var o=s.delay;return E(E({},t.formatTransition(s)),{delay:o})})},e.prototype.getStateNodes=function(t){var r,n=this;if(!t)return[];var i=t instanceof re?t.value:tt(t,this.delimiter);if(C(i)){var s=this.getStateNode(i).initial;return s!==void 0?this.getStateNodes((r={},r[i]=s,r)):[this,this.states[i]]}var o=Object.keys(i),a=[this];return a.push.apply(a,j([],k(V(o.map(function(c){return n.getStateNode(c).getStateNodes(i[c])}))),!1)),a},e.prototype.handles=function(t){var r=eo(t);return this.events.includes(r)},e.prototype.resolveState=function(t){var r=t instanceof re?t:re.create(t),n=Array.from(Je([],this.getStateNodes(r.value)));return new re(E(E({},r),{value:this.resolve(r.value),configuration:n,done:Rt(n,this),tags:si(n),machine:this.machine}))},e.prototype.transitionLeafNode=function(t,r,n){var i=this.getStateNode(t),s=i.next(r,n);return!s||!s.transitions.length?this.next(r,n):s},e.prototype.transitionCompoundNode=function(t,r,n){var i=Object.keys(t),s=this.getStateNode(i[0]),o=s._transition(t[i[0]],r,n);return!o||!o.transitions.length?this.next(r,n):o},e.prototype.transitionParallelNode=function(t,r,n){var i,s,o={};try{for(var a=R(Object.keys(t)),c=a.next();!c.done;c=a.next()){var u=c.value,d=t[u];if(d){var f=this.getStateNode(u),l=f._transition(d,r,n);l&&(o[u]=l)}}}catch(g){i={error:g}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}var h=Object.keys(o).map(function(g){return o[g]}),p=V(h.map(function(g){return g.transitions})),y=h.some(function(g){return g.transitions.length>0});if(!y)return this.next(r,n);var m=V(Object.keys(o).map(function(g){return o[g].configuration}));return{transitions:p,exitSet:V(h.map(function(g){return g.exitSet})),configuration:m,source:r,actions:V(Object.keys(o).map(function(g){return o[g].actions}))}},e.prototype._transition=function(t,r,n){return C(t)?this.transitionLeafNode(t,r,n):Object.keys(t).length===1?this.transitionCompoundNode(t,r,n):this.transitionParallelNode(t,r,n)},e.prototype.getTransitionData=function(t,r){return this._transition(t.value,t,F(r))},e.prototype.next=function(t,r){var n,i,s=this,o=r.name,a=[],c=[],u;try{for(var d=R(this.getCandidates(o)),f=d.next();!f.done;f=d.next()){var l=f.value,h=l.cond,p=l.in,y=t.context,m=p?C(p)&&xe(p)?t.matches(tt(this.getStateNodeById(p).path,this.delimiter)):on(tt(p,this.delimiter),mf(this.path.slice(0,-2))(t.value)):!0,g=!1;try{g=!h||io(this.machine,h,y,r,t)}catch(T){throw new Error("Unable to evaluate guard '".concat(h.name||h.type,"' in transition for event '").concat(o,"' in state node '").concat(this.id,`':
`).concat(T.message))}if(g&&m){l.target!==void 0&&(c=l.target),a.push.apply(a,j([],k(l.actions),!1)),u=l;break}}}catch(T){n={error:T}}finally{try{f&&!f.done&&(i=d.return)&&i.call(d)}finally{if(n)throw n.error}}if(u){if(!c.length)return{transitions:[u],exitSet:[],configuration:t.value?[this]:[],source:t,actions:a};var b=V(c.map(function(T){return s.getRelativeStateNodes(T,t.historyValue)})),S=!!u.internal;return{transitions:[u],exitSet:S?[]:V(c.map(function(T){return s.getPotentiallyReenteringNodes(T)})),configuration:b,source:t,actions:a}}},e.prototype.getPotentiallyReenteringNodes=function(t){if(this.order<t.order)return[this];for(var r=[],n=this,i=t;n&&n!==i;)r.push(n),n=n.parent;return n!==i?[]:(r.push(i),r)},e.prototype.getActions=function(t,r,n,i,s,o,a){var c,u,d,f,l=this,h=o?Je([],this.getStateNodes(o.value)):[],p=new Set;try{for(var y=R(Array.from(t).sort(function(w,A){return w.order-A.order})),m=y.next();!m.done;m=y.next()){var g=m.value;(!Xe(h,g)||Xe(n.exitSet,g)||g.parent&&p.has(g.parent))&&p.add(g)}}catch(w){c={error:w}}finally{try{m&&!m.done&&(u=y.return)&&u.call(y)}finally{if(c)throw c.error}}try{for(var b=R(h),S=b.next();!S.done;S=b.next()){var g=S.value;(!Xe(t,g)||Xe(n.exitSet,g.parent))&&n.exitSet.push(g)}}catch(w){d={error:w}}finally{try{S&&!S.done&&(f=b.return)&&f.call(b)}finally{if(d)throw d.error}}n.exitSet.sort(function(w,A){return A.order-w.order});var T=Array.from(p).sort(function(w,A){return w.order-A.order}),_=new Set(n.exitSet),D=V(T.map(function(w){var A=[];if(w.type!=="final")return A;var P=w.parent;if(!P.parent)return A;A.push(St(w.id,w.doneData),St(P.id,w.doneData?jt(w.doneData,i,s):void 0));var Y=P.parent;return Y.type==="parallel"&&dt(Y).every(function(ae){return Rt(n.configuration,ae)})&&A.push(St(Y.id)),A})),L=T.map(function(w){var A=w.onEntry,P=w.activities.map(function(Y){return Nf(Y)});return{type:"entry",actions:ue(a?j(j([],k(A),!1),k(P),!1):j(j([],k(P),!1),k(A),!1),l.machine.options.actions)}}).concat({type:"state_done",actions:D.map(function(w){return Of(w)})}),v=Array.from(_).map(function(w){return{type:"exit",actions:ue(j(j([],k(w.onExit),!1),k(w.activities.map(function(A){return Df(A)})),!1),l.machine.options.actions)}}),I=v.concat({type:"transition",actions:ue(n.actions,this.machine.options.actions)}).concat(L);if(r){var x=ue(V(j([],k(t),!1).sort(function(w,A){return A.order-w.order}).map(function(w){return w.onExit})),this.machine.options.actions).filter(function(w){return!xr(w)});return I.concat({type:"stop",actions:x})}return I},e.prototype.transition=function(t,r,n,i){t===void 0&&(t=this.initialState);var s=F(r),o;if(t instanceof re)o=n===void 0?t:this.resolveState(re.from(t,n));else{var a=C(t)?this.resolve(Bt(this.getResolvedPath(t))):this.resolve(t),c=n??this.machine.context;o=this.resolveState(re.from(a,c))}if(this.strict&&!this.events.includes(s.name)&&!Ef(s.name))throw new Error("Machine '".concat(this.id,"' does not accept event '").concat(s.name,"'"));var u=this._transition(o.value,o,s)||{transitions:[],configuration:[],exitSet:[],source:o,actions:[]},d=Je([],this.getStateNodes(o.value)),f=u.configuration.length?Je(d,u.configuration):d;return u.configuration=j([],k(f),!1),this.resolveTransition(u,o,o.context,i,s)},e.prototype.resolveRaisedTransition=function(t,r,n,i){var s,o=t.actions;return t=this.transition(t,r,void 0,i),t._event=n,t.event=n.data,(s=t.actions).unshift.apply(s,j([],k(o),!1)),t},e.prototype.resolveTransition=function(t,r,n,i,s){var o,a,c,u,d=this;s===void 0&&(s=Ne);var f=t.configuration,l=!r||t.transitions.length>0,h=l?t.configuration:r?r.configuration:[],p=Rt(h,this),y=l?Uf(this.machine,f):void 0,m=r?r.historyValue?r.historyValue:t.source?this.machine.historyValue(r.value):void 0:void 0,g=this.getActions(new Set(h),p,t,n,s,r,i),b=r?E({},r.activities):{};try{for(var S=R(g),T=S.next();!T.done;T=S.next()){var _=T.value;try{for(var D=(c=void 0,R(_.actions)),L=D.next();!L.done;L=D.next()){var v=L.value;v.type===Tr?b[v.activity.id||v.activity.type]=v:v.type===nn&&(b[v.activity.id||v.activity.type]=!1)}}catch(X){c={error:X}}finally{try{L&&!L.done&&(u=D.return)&&u.call(D)}finally{if(c)throw c.error}}}}catch(X){o={error:X}}finally{try{T&&!T.done&&(a=S.return)&&a.call(S)}finally{if(o)throw o.error}}var I=k(Ht(this,r,n,s,g,i,this.machine.config.predictableActionArguments||this.machine.config.preserveActionOrder),2),x=I[0],w=I[1],A=k(If(x,xr),2),P=A[0],Y=A[1],ae=x.filter(function(X){var Te;return X.type===Tr&&((Te=X.activity)===null||Te===void 0?void 0:Te.type)===Ar}),Se=ae.reduce(function(X,Te){return X[Te.activity.id]=Bf(Te.activity,d.machine,w,s),X},r?E({},r.children):{}),te=new re({value:y||r.value,context:w,_event:s,_sessionid:r?r._sessionid:null,historyValue:y?m?Sf(m,y):void 0:r?r.historyValue:void 0,history:!y||t.source?r:void 0,actions:y?Y:[],activities:y?b:r?r.activities:{},events:[],configuration:h,transitions:t.transitions,children:Se,done:p,tags:si(h),machine:this}),me=n!==w;te.changed=s.name===Qs||me;var we=te.history;we&&delete we.history;var En=!p&&(this._transient||f.some(function(X){return X._transient}));if(!l&&(!En||s.name===Tt))return te;var J=te;if(!p)for(En&&(J=this.resolveRaisedTransition(J,{type:df},s,i));P.length;){var zo=P.shift();J=this.resolveRaisedTransition(J,zo._event,s,i)}var qo=J.changed||(we?!!J.actions.length||me||typeof we.value!=typeof J.value||!fo(J.value,we.value):void 0);return J.changed=qo,J.history=we,J},e.prototype.getStateNode=function(t){if(xe(t))return this.machine.getStateNodeById(t);if(!this.states)throw new Error("Unable to retrieve child state '".concat(t,"' from '").concat(this.id,"'; no child states exist."));var r=this.states[t];if(!r)throw new Error("Child state '".concat(t,"' does not exist on '").concat(this.id,"'"));return r},e.prototype.getStateNodeById=function(t){var r=xe(t)?t.slice(Lr.length):t;if(r===this.id)return this;var n=this.machine.idMap[r];if(!n)throw new Error("Child state node '#".concat(r,"' does not exist on machine '").concat(this.id,"'"));return n},e.prototype.getStateNodeByPath=function(t){if(typeof t=="string"&&xe(t))try{return this.getStateNodeById(t.slice(1))}catch{}for(var r=Or(t,this.delimiter).slice(),n=this;r.length;){var i=r.shift();if(!i.length)break;n=n.getStateNode(i)}return n},e.prototype.resolve=function(t){var r,n=this;if(!t)return this.initialStateValue||Oe;switch(this.type){case"parallel":return ze(this.initialStateValue,function(s,o){return s?n.getStateNode(o).resolve(t[o]||s):Oe});case"compound":if(C(t)){var i=this.getStateNode(t);return i.type==="parallel"||i.type==="compound"?(r={},r[t]=i.initialStateValue,r):t}return Object.keys(t).length?ze(t,function(s,o){return s?n.getStateNode(o).resolve(s):Oe}):this.initialStateValue||{};default:return t||Oe}},e.prototype.getResolvedPath=function(t){if(xe(t)){var r=this.machine.idMap[t.slice(Lr.length)];if(!r)throw new Error("Unable to find state node '".concat(t,"'"));return r.path}return Or(t,this.delimiter)},Object.defineProperty(e.prototype,"initialStateValue",{get:function(){var t;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var r;if(this.type==="parallel")r=ti(this.states,function(n){return n.initialStateValue||Oe},function(n){return n.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '".concat(this.initial,"' not found on '").concat(this.key,"'"));r=Vt(this.states[this.initial])?this.initial:(t={},t[this.initial]=this.states[this.initial].initialStateValue,t)}else r={};return this.__cache.initialStateValue=r,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),e.prototype.getInitialState=function(t,r){this._init();var n=this.getStateNodes(t);return this.resolveTransition({configuration:n,exitSet:[],transitions:[],source:void 0,actions:[]},void 0,r??this.machine.context,void 0)},Object.defineProperty(e.prototype,"initialState",{get:function(){var t=this.initialStateValue;if(!t)throw new Error("Cannot retrieve initial state from simple state '".concat(this.id,"'."));return this.getInitialState(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"target",{get:function(){var t;if(this.type==="history"){var r=this.config;C(r.target)?t=xe(r.target)?Bt(this.machine.getStateNodeById(r.target).path.slice(this.path.length-1)):r.target:t=r.target}return t},enumerable:!1,configurable:!0}),e.prototype.getRelativeStateNodes=function(t,r,n){return n===void 0&&(n=!0),n?t.type==="history"?t.resolveHistory(r):t.initialStateNodes:[t]},Object.defineProperty(e.prototype,"initialStateNodes",{get:function(){var t=this;if(Vt(this))return[this];if(this.type==="compound"&&!this.initial)return[this];var r=Ot(this.initialStateValue);return V(r.map(function(n){return t.getFromRelativePath(n)}))},enumerable:!1,configurable:!0}),e.prototype.getFromRelativePath=function(t){if(!t.length)return[this];var r=k(t),n=r[0],i=r.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '".concat(n,"' from node with no states"));var s=this.getStateNode(n);if(s.type==="history")return s.resolveHistory();if(!this.states[n])throw new Error("Child state '".concat(n,"' does not exist on '").concat(this.id,"'"));return this.states[n].getFromRelativePath(i)},e.prototype.historyValue=function(t){if(Object.keys(this.states).length)return{current:t||this.initialStateValue,states:ti(this.states,function(r,n){if(!t)return r.historyValue();var i=C(t)?void 0:t[n];return r.historyValue(i||r.initialStateValue)},function(r){return!r.history})}},e.prototype.resolveHistory=function(t){var r=this;if(this.type!=="history")return[this];var n=this.parent;if(!t){var i=this.target;return i?V(Ot(i).map(function(o){return n.getFromRelativePath(o)})):n.initialStateNodes}var s=gf(n.path,"states")(t).current;return C(s)?[n.getStateNode(s)]:V(Ot(s).map(function(o){return r.history==="deep"?n.getFromRelativePath(o):[n.states[o[0]]]}))},Object.defineProperty(e.prototype,"stateIds",{get:function(){var t=this,r=V(Object.keys(this.states).map(function(n){return t.states[n].stateIds}));return[this.id].concat(r)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"events",{get:function(){var t,r,n,i;if(this.__cache.events)return this.__cache.events;var s=this.states,o=new Set(this.ownEvents);if(s)try{for(var a=R(Object.keys(s)),c=a.next();!c.done;c=a.next()){var u=c.value,d=s[u];if(d.states)try{for(var f=(n=void 0,R(d.events)),l=f.next();!l.done;l=f.next()){var h=l.value;o.add("".concat(h))}}catch(p){n={error:p}}finally{try{l&&!l.done&&(i=f.return)&&i.call(f)}finally{if(n)throw n.error}}}}catch(p){t={error:p}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}return this.__cache.events=Array.from(o)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ownEvents",{get:function(){var t=new Set(this.transitions.filter(function(r){return!(!r.target&&!r.actions.length&&r.internal)}).map(function(r){return r.eventType}));return Array.from(t)},enumerable:!1,configurable:!0}),e.prototype.resolveTarget=function(t){var r=this;if(t!==void 0)return t.map(function(n){if(!C(n))return n;var i=n[0]===r.delimiter;if(i&&!r.parent)return r.getStateNodeByPath(n.slice(1));var s=i?r.key+n:n;if(r.parent)try{var o=r.parent.getStateNodeByPath(s);return o}catch(a){throw new Error("Invalid transition definition for state node '".concat(r.id,`':
`).concat(a.message))}else return r.getStateNodeByPath(s)})},e.prototype.formatTransition=function(t){var r=this,n=Mf(t.target),i="internal"in t?t.internal:n?n.some(function(c){return C(c)&&c[0]===r.delimiter}):!0,s=this.machine.options.guards,o=this.resolveTarget(n),a=E(E({},t),{actions:ue(Z(t.actions)),cond:no(t.cond,s),target:o,source:this,internal:i,eventType:t.event,toJSON:function(){return E(E({},a),{target:a.target?a.target.map(function(c){return"#".concat(c.id)}):void 0,source:"#".concat(r.id)})}});return a},e.prototype.formatTransitions=function(){var t,r,n=this,i;if(!this.config.on)i=[];else if(Array.isArray(this.config.on))i=this.config.on;else{var s=this.config.on,o=dr,a=s[o],c=a===void 0?[]:a,u=rn(s,[typeof o=="symbol"?o:o+""]);i=V(Object.keys(u).map(function(b){var S=Me(b,u[b]);return S}).concat(Me(dr,c)))}var d=this.config.always?Me("",this.config.always):[],f=this.config.onDone?Me(String(St(this.id)),this.config.onDone):[],l=V(this.invoke.map(function(b){var S=[];return b.onDone&&S.push.apply(S,j([],k(Me(String(_t(b.id)),b.onDone)),!1)),b.onError&&S.push.apply(S,j([],k(Me(String(qe(b.id)),b.onError)),!1)),S})),h=this.after,p=V(j(j(j(j([],k(f),!1),k(l),!1),k(i),!1),k(d),!1).map(function(b){return Z(b).map(function(S){return n.formatTransition(S)})}));try{for(var y=R(h),m=y.next();!m.done;m=y.next()){var g=m.value;p.push(g)}}catch(b){t={error:b}}finally{try{m&&!m.done&&(r=y.return)&&r.call(y)}finally{if(t)throw t.error}}return p},e}();function ih(e,t){return new nh(e,t)}var z=Pf,sh=Object.defineProperty,rr=(e,t)=>{for(var r in t)sh(e,r,{get:t[r],enumerable:!0})},oh={};rr(oh,{Connection:()=>Cv,buildError:()=>kr,connectionErrors:()=>To,isInviteeClaim:()=>De,isInviteeContext:()=>sr,isInviteeDeviceClaim:()=>Nv,isInviteeDeviceContext:()=>Fo,isInviteeMemberClaim:()=>Yo,isInviteeMemberContext:()=>gn,isMemberClaim:()=>Cr,isMemberContext:()=>Uo,isServerContext:()=>Go});var vo=e=>{const t=r=>{switch(r.type){case"ADD_MEMBER":return r.payload.member.userId;case"REMOVE_MEMBER":return r.payload.userId;case"ADD_ROLE":return r.payload.roleName;case"ADD_MEMBER_ROLE":case"REMOVE_MEMBER_ROLE":return`${r.payload.roleName}:${r.payload.userId}`;case"ADD_DEVICE":return r.payload.device.deviceName;case"REMOVE_DEVICE":return r.payload.deviceId;case"INVITE_MEMBER":case"INVITE_DEVICE":return r.payload.invitation.id;case"REVOKE_INVITATION":return r.payload.id;case"ADMIT_MEMBER":case"ADMIT_DEVICE":return r.payload.id;case"CHANGE_MEMBER_KEYS":return JSON.stringify(r.payload.keys);default:return JSON.stringify(r.payload)}};return e.body.type==="ROOT"?"ROOT":`${e.body.type}:${t(e.body)}`},yo=(e,t)=>{if(!e||!t)return!1;const r=n=>n.sort().join(",");return r(e)===r(t)},po=e=>!["INVITE_DEVICE","ADD_DEVICE","REMOVE_DEVICE","CHANGE_MEMBER_KEYS","CHANGE_SERVER_KEYS","ADMIT_MEMBER","ADMIT_DEVICE"].includes(e.type),ah={};rr(ah,{ADMIN:()=>ee});var ee="admin",ch=e=>(t,r)=>{if(ai(e,t))return-1;if(ai(e,r))return 1;const n=o=>{const a=u=>u.body.type==="ADD_MEMBER"&&u.body.payload.member.userId===o,c=Object.values(e.links).find(a);return M(c,`Could not find link that added member ${o}`),c},[i,s]=[t,r].map(n);return bl(e,i,s)?-1:1},ai=(e,t)=>e.links[e.root].body.userId===t,Ut=e=>{const t=Ol(e).map(n=>n.map(i=>e.links[i])),r=[];for(let n of t)for(const i in ci){const s=ci[i],o=s(n,e),a=o.flatMap(c=>mo(n,c));r.push(...o,...a),n=n.filter(li(r))}return{filter:li(r)}},mo=(e,t)=>{const r=[];switch(t.body.type){case"INVITE_MEMBER":case"INVITE_DEVICE":{const{invitation:i}=t.body.payload;r.push(...e.filter(mh(i)));break}case"ADMIT_MEMBER":{const i=t.body.payload.memberKeys.name;r.push(...e.filter(Io(i)));break}}const n=r.flatMap(i=>mo(e,i));return r.concat(n)},ci={resolveMutualRemovals(e,t){const r=ui(e),n=bo(e).map(dn);return r.length>0&&yo(r,n)?e.filter(Io(uh(t,n))):[]},cantAddBackRemovedMember(e){const t=ui(e);return fh(e).filter(r=>t.includes(ph(r)))},cantDoAnythingWhenRemoved(e){const t=vh(e);return e.filter(di(t))},cantDoAdminActionsWhenDemoted(e){const t=yh(e),r=di(t),n=i=>po(i.body);return e.filter(i=>r(i)&&n(i))}},uh=(e,t)=>t.sort(ch(e)).pop(),dh=e=>["ADD_MEMBER","ADD_MEMBER_ROLE","ADMIT_MEMBER"].includes(e.body.type),lh=e=>e.body.type==="REMOVE_MEMBER",fh=e=>e.filter(dh),go=e=>e.filter(lh),hh=e=>e.body.type==="REMOVE_MEMBER_ROLE"&&e.body.payload.roleName===ee,Eo=e=>e.filter(hh),bo=e=>go(e).concat(Eo(e)),ui=e=>bo(e).map(un),vh=e=>go(e).map(un),yh=e=>Eo(e).map(un),un=e=>e.body.payload.userId,dn=e=>e.body.userId,Io=e=>t=>dn(t)===e,di=e=>t=>e.includes(dn(t)),ph=e=>{switch(e.body.type){case"ADD_MEMBER":return e.body.payload.member.userId;case"ADD_MEMBER_ROLE":return e.body.payload.userId;case"ADMIT_MEMBER":return e.body.payload.memberKeys.name}},li=e=>t=>!e.includes(t),mh=e=>t=>(t.body.type==="ADMIT_MEMBER"||t.body.type==="ADMIT_DEVICE")&&t.body.payload.id===e.id,Gv=e=>Ys(e,Ut).filter(r=>!r.isInvalid).map(r=>vo(r)).join(","),gh="SIGNATURE",Eh="ENCRYPTION",bh="SYMMETRIC",Ih="LINK_HASH",Sh="LINK_TO_PREVIOUS",wh="INVITATION",Th="DEVICE_ID",Ah="SHARED_KEY",So={SIGNATURE:gh,ENCRYPTION:Eh,SYMMETRIC:bh,LINK_HASH:Ih,LINK_TO_PREVIOUS:Sh,INVITATION:wh,DEVICE_ID:Th,SHARED_KEY:Ah},q={isValid:!0},Mh=e=>t=>e.reduce((r,n)=>n(r),t),fi=e=>({type:e.type,name:e.name}),Oh=e=>`${e.recipient.name}(${xh(e.recipient.publicKey)}):${e.contents.name}#${e.contents.generation}`,xh=e=>e.slice(0,5),wo=(e,t)=>e.type===t.type&&e.name===t.name,hi=(e,t)=>{M(wo(e,t),`The scope of the new keys must match those of the old lockbox. 
     New scope: ${JSON.stringify(fi(e))} 
     Old scope: ${JSON.stringify(fi(t))}`)},G={GRAPH:"GRAPH",TEAM:"TEAM",ROLE:"ROLE",USER:"USER",DEVICE:"DEVICE",SERVER:"SERVER",EPHEMERAL:"EPHEMERAL"},_h=class extends Error{constructor(e,t){super(),this.message=e,this.details=t}name;details},Rh=(e,t)=>{const r=typeof e=="string"?bn.decode(e):e,n=typeof t=="string"?bn.decode(t):t,i=[r,n].sort(Lh).reduce((o,a)=>new Uint8Array([...o,...a]),new Uint8Array);return(typeof e=="string"?le:ea)(So.SHARED_KEY,i)},Lh=(e,t)=>{const r=e.toString(),n=t.toString();return r<n?-1:r>n?1:0},To={MEMBER_UNKNOWN:{localMessage:"The peer is not a member of this team",remoteMessage:"You are not a member of this team"},MEMBER_REMOVED:{localMessage:"The peer was removed from this team",remoteMessage:"You were removed from this team"},DEVICE_UNKNOWN:{localMessage:"The peer's device isn't listed on this team",remoteMessage:"Your device isn't listed on this team"},DEVICE_REMOVED:{localMessage:"The peer's device was removed from this team",remoteMessage:"Your device was removed from this team"},NEITHER_IS_MEMBER:{localMessage:"The peer is also holding an invitation and cannot admit you to the team",remoteMessage:"The peer is also holding an invitation and cannot admit you to the team"},IDENTITY_PROOF_INVALID:{localMessage:"The peer's proof of identity is not valid",remoteMessage:"Your proof of identity isn't valid"},INVITATION_PROOF_INVALID:{localMessage:"The peer's invitation wasn't accepted",remoteMessage:"Your invitation wasn't accepted"},JOINED_WRONG_TEAM:{localMessage:"This isn't the team you were invited to",remoteMessage:"This isn't the team the peer was invited to"},TIMEOUT:{localMessage:"We didn't hear back from the peer; giving up",remoteMessage:"The peer didn't hear back from us, so they gave up"}},kr=(e,t,r="LOCAL")=>{const{localMessage:n,remoteMessage:i}=To[e];return{type:r==="LOCAL"?"LOCAL_ERROR":"ERROR",payload:{type:e,message:r==="LOCAL"?n:i,details:t}}},kh=e=>{const t=en(e),{encryptedLinks:r,head:n,root:i}=e,o=$r({encryptedLinks:r,childMap:t,head:n,root:i});return Ch(o)},Ao=(e,t)=>{const r=Kr(e);return Zr({encryptedGraph:r,keys:t})},Nh=(e,t)=>Dh(e)?e:Ao(e,t),Dh=e=>e?.hasOwnProperty("root"),Ch=e=>new Uint8Array(e.buffer,e.byteOffset,e.byteLength),_e="ALL",rt={head:[],teamName:"",members:[],servers:[],roles:[],lockboxes:[],invitations:{},messages:[],removedMembers:[],removedDevices:[],removedServers:[],pendingKeyRotations:[]},Ft={type:G.TEAM,name:G.TEAM},Ph={type:G.ROLE,name:ee},Yv={type:G.EPHEMERAL,name:G.EPHEMERAL},$h=(e,t)=>{switch(t.body.type){case"ADMIT_MEMBER":{const r=t.body.payload.memberKeys,n=r.name,i={userName:"",userId:n,keys:r,roles:[]},s=[...e.removedMembers,i],o=[...e.pendingKeyRotations];return o.includes(n)||o.push(n),{...e,removedMembers:s,pendingKeyRotations:o}}}return e},Kh=e=>t=>({...t,head:[e.hash]}),lr=e=>t=>{const{userId:r}=e;return{...t,members:t.members.map(n=>{if(n.userId===r){const{devices:i=[]}=n;return i.find(s=>s.deviceId===e.deviceId)?n:{...n,devices:[...i,e]}}return n}),removedDevices:t.removedDevices.filter(n=>n.keys.name===e.deviceId)}},fr=e=>t=>({...t,members:[...t.members,{...e,roles:[]}],removedMembers:t.removedMembers.filter(r=>r.userId===e.userId)}),hr=(e,t=[])=>t.map(r=>n=>({...n,members:n.members.map(i=>({...i,roles:i.userId!==e||i.roles.includes(r)?i.roles:[...i.roles,r]}))})),Bh=e=>t=>({...t,messages:[...t.messages,e]}),vi=e=>t=>({...t,roles:[...t.roles,e]}),Mo=qd,jh=e=>t=>({...t,servers:Mo([...t.servers,e]),removedServers:t.removedServers.filter(n=>n.host!==e.host)}),Hh=e=>t=>({...t,members:t.members.map(r=>r.userId===e.name?{...r,keys:e}:r)}),Vh=e=>t=>({...t,servers:t.servers.map(r=>r.host===e.name?{...r,keys:e}:r)}),Uh=e=>t=>{const{lockboxes:r}=t;return e?{...t,lockboxes:r.concat(e)}:t},yi=e=>t=>{const r={...e,uses:0,revoked:!1};return{...t,invitations:{...t.invitations,[e.id]:r}}},ln=(e,t,r={includeRemoved:!1})=>{const i=[...e.servers,...r.includeRemoved?e.removedServers:[]].find(s=>s.host===t);if(i===void 0)throw new Error(`A server with host '${t}' was not found`);return i},fn=(e,t)=>e.servers.find(r=>r.host===t)!==void 0,Fh=e=>({userId:e.host,userName:e.host,keys:e.keys,roles:[]}),Gh=e=>({userId:e.host,userName:e.host,keys:e.keys}),Yh=e=>({userId:e.host,deviceName:e.host,deviceId:e.host,keys:e.keys}),nt={toMember:Fh,toUser:Gh,toDevice:Yh},Oo=(e,t,r={includeRemoved:!1})=>xo(e,t,r)!==void 0,nr=(e,t,r={includeRemoved:!1})=>{const n=xo(e,t,r);return M(n,`Device ${t} not found`),n},xo=(e,t,r={includeRemoved:!1})=>fn(e,t)?nt.toDevice(ln(e,t)):e.members.concat(r.includeRemoved?e.removedMembers:[]).flatMap(s=>s.devices??[]).find(s=>s.deviceId===t)??(r.includeRemoved?e.removedDevices.find(s=>s.deviceId===t):void 0),Wh=(e,t)=>Oo(e,t,{includeRemoved:!0})?e.removedDevices.some(r=>r.keys.name===t):!1,_o=(e,t)=>e.members.find(r=>r.userId===t)!==void 0,zh=(e,t)=>e.roles.find(r=>r.roleName===t)!==void 0;function hn(e,t){return t in e.invitations}function vn(e,t){return M(hn(e,t),`No invitation with id '${t}' found.`),e.invitations[t]}var pi=e=>e.hasOwnProperty("publicKey"),Q=(e,t)=>{const r=pi(t)?t:fe(t),n=fe(e),i=he.keyPair(),s=pi(r)?r.publicKey:r.encryption,o=he.encryptBytes({secret:e,recipientPublicKey:s,senderSecretKey:i.secretKey});return{encryptionKey:{...js,publicKey:i.publicKey},recipient:{...r,publicKey:s},contents:{...n,publicKey:e.encryption.publicKey},encryptedPayload:o}},qh=oe((e,t)=>{const{encryptionKey:r,encryptedPayload:n}=e;return he.decryptBytes({cipher:n,senderPublicKey:r.publicKey,recipientSecretKey:t.encryption.secretKey})}),Jh=({oldLockbox:e,newContents:t,updatedRecipientKeys:r})=>{hi(t,e.contents),r&&hi(e.recipient,r),t.generation=e.contents.generation+1;const n=r??e.recipient;return Q(t,n)},Ro=(e,t)=>{const{lockboxes:r}=e,{publicKey:n}=t.encryption,s=r.filter(({recipient:a})=>a.publicKey===n).map(a=>qh(a,t)),o=s.flatMap(a=>Ro(e,a));return[...s,...o]},Lo=(e,t)=>Ro(e,t).reduce(Xh,{}),Xh=(e,t)=>{const{type:r,name:n,generation:i}=t,s=e[r]??{},o=s[n]??[];return o[i]=t,{...e,[r]:{...s,[n]:o}}},yn=(e,t,r)=>{const{type:n,name:i}=r,s=Lo(e,t),o=s[n]?s[n][i]:void 0;M(o,`Couldn't find keys: ${JSON.stringify(r)}
     Device: ${t.name}
     Available lockboxes: 
- ${e.lockboxes.map(Oh).join(`
- `)} 
     Keymap: ${JSON.stringify(s,null,2)}`);const a="generation"in r&&r.generation!==void 0?r.generation:o.length-1;return o[a]},Qh=(e,t)=>{const r=e.lockboxes.filter(({contents:s})=>s.type===t.type&&s.name===t.name),n=r.reduce(Zh,0);return r.filter(({contents:s})=>s.generation===n)},Zh=(e,t)=>{const{generation:r}=t.contents;return r>e?r:e},ir=(e,t,r={includeRemoved:!1})=>{const i=[...e.members,...r.includeRemoved?e.removedMembers:[]].find(s=>s.userId===t);if(i===void 0)throw new Error(`A member named '${t}' was not found`);return i},ko=(e,t,r={includeRemoved:!1})=>{if(fn(e,t))return nt.toMember(ln(e,t));const{userId:n}=nr(e,t,r);return ir(e,n,r)},No=(e,t,r)=>{if(!_o(e,t))return!1;const n=ir(e,t),{roles:i=[]}=n;return i.includes(r)},Lt=(e,t)=>No(e,t,ee),ev=(e,t)=>e.removedMembers.some(r=>r.userId===t),Do=(e,t)=>e.members.filter(r=>r.roles?.includes(t)),tv=e=>Do(e,ee),rv=e=>e.messages,nv=(e,t)=>{const r=e.roles.find(n=>n.roleName===t);if(!r)throw new Error(`A role called '${t}' was not found`);return r},iv=(e,t)=>e.removedServers.some(r=>r.host===t),{TEAM:mi}=G,sv=(e,t)=>{const r=Lo(e,t)[mi][mi];return He(r)},Co=(e,{type:t,name:r})=>{const n=e.lockboxes.filter(({recipient:o})=>o.type===t&&o.name===r).map(({contents:{type:o,name:a}})=>({type:o,name:a})),i=n.flatMap(o=>Co(e,o)),s=[...n,...i];return Mo(s,o=>o.name+o.type)},ov=e=>t=>{const r=nr(t,e),{userId:n}=ko(t,e),i=a=>a.userId===n?{...a,devices:a.devices?.filter(c=>c.deviceName!==r.deviceName)}:a,s=t.members.map(i),o=[...t.removedDevices,r];return{...t,members:s,removedDevices:o}},av=e=>t=>{const r=t.members.filter(s=>s.userId!==e),n=t.members.find(s=>s.userId===e),i=[...t.removedMembers];return n&&i.push(n),{...t,members:r,removedMembers:i}},cv=(e,t)=>r=>({...r,members:r.members.map(n=>({...n,roles:n.userId===e?n.roles.filter(i=>i!==t):n.roles})),lockboxes:r.lockboxes.filter(n=>!(n.recipient.name===e&&n.contents.type===G.ROLE&&n.contents.name===t))}),uv=e=>t=>({...t,roles:t.roles.filter(r=>r.roleName!==e),lockboxes:t.lockboxes.filter(r=>!(r.contents.type===G.ROLE&&r.contents.name===e))}),dv=e=>t=>{const r=t.servers.filter(s=>s.host!==e),n=t.servers.find(s=>s.host===e),i=[...t.removedServers];return n&&i.push(n),{...t,servers:r,removedServers:i}},lv=e=>t=>{const r={...t.invitations},n={...r[e],revoked:!0};return{...t,invitations:{...r,[e]:n}}},fv=e=>t=>{const r=t.pendingKeyRotations.filter(n=>n!==e);return{...t,pendingKeyRotations:r}},gi=e=>t=>({...t,teamName:e}),Ei=e=>t=>{const r={...t.invitations},n=r[e],i=n.uses+1;return{...t,invitations:{...r,[e]:{...n,uses:i}}}},hv={};rr(hv,{IKEY_LENGTH:()=>$o,InvitationValidationError:()=>jo,create:()=>Nr,fail:()=>Ee,generateProof:()=>Ko,generateStarterKeys:()=>mt,invitationCanBeUsed:()=>pn,randomSeed:()=>Dr,validate:()=>Bo});var lt=e=>e.toLowerCase().replaceAll(/[^a-z\d]/gi,""),mt=oe(e=>(e=lt(e),de(js,e)));function Po(e){const t=Mi(e);return le(So.INVITATION,t).slice(0,15)}var $o=16,Nr=({seed:e,maxUses:t=1,expiration:r=0,userId:n})=>{e=lt(e);const i=Po(e),s=mt(e),{publicKey:o}=s.signature;return{id:i,publicKey:o,expiration:r,maxUses:t,userId:n}},Dr=(e=$o)=>je(e),Ko=oe(e=>{e=lt(e);const t=Po(e),r=mt(e),n={id:t},i=be.sign(n,r.signature.secretKey);return{id:t,signature:i}}),pn=(e,t)=>{const{revoked:r,maxUses:n,uses:i,expiration:s}=e;return r?Ee("The invitation has been revoked"):n>0&&i>=n?Ee("The invitation cannot be used again"):s>0&&s<t?Ee("The invitation has expired"):q},Bo=oe((e,t)=>{const{id:r,signature:n}=e;if(r!==t.id)return Ee("IDs don't match",{proof:e,invitation:t});const{publicKey:i}=t;return be.verify({payload:{id:r},signature:n,publicKey:i})?q:Ee("Signature provided is not valid",{proof:e,invitation:t})}),Ee=(e,t)=>({isValid:!1,error:new jo(e,t)}),jo=class extends Error{constructor(e,t){super(),this.name="Invitation validation failed",this.message=e,this.details=t}index;details},vv=Wt.extend("auth:validate"),yv=(...e)=>{for(const t in bi){const r=bi[t],n=r(...e);if(!n.isValid)return n}return q},bi={rootDeviceBelongsToRootUser(...e){const[t,r]=e,{type:n,payload:i}=r.body;if(n!=="ROOT")return q;const{rootDevice:s,rootMember:o}=i;return s.userId!==o.userId?Ge("The founding device must belong to the founding member (userIds must match).",...e):q},mustBeAdmin(...e){const[t,r]=e,n=r.body,{type:i,userId:s}=n;return i===Qt?q:po(n)&&!Lt(t,s)?Ge(`Member '${s}' is not an admin`,...e):q},canOnlyRemoveYourOwnDevices(...e){const[t,r]=e,n=r.body.userId;if(Lt(t,n))return q;if(r.body.type==="REMOVE_DEVICE"){const s=r.body.payload.deviceId,a=nr(t,s).userId;if(n!==a)return Ge("Can't remove another user's device.",...e)}return q},canOnlyChangeYourOwnKeys(...e){const[t,r]=e,n=r.body.userId;if(!Lt(t,n)){if(r.body.type==="CHANGE_MEMBER_KEYS"){const s=r.body.payload.keys.name;if(n!==s)return Ge("Can't change another user's keys.",...e)}else if(r.body.type==="CHANGE_SERVER_KEYS"){const s=r.body.payload.keys.name;if(n!==s)return Ge("Can't change another server's keys.",...e)}}return q},cantAdmitWithInvalidInvitation(...e){const[t,r]=e;if(r.body.type==="ADMIT_MEMBER"||r.body.type==="ADMIT_DEVICE"){const{id:n}=r.body.payload,i=vn(t,n);return pn(i,r.body.timestamp)}return q}},Ge=(e,t,r)=>(e=Oi(`${vo(r)} ${e}`),vv(e),{isValid:!1,error:new _h(e,{prevState:t,link:r})}),Gt=(e,t)=>{if(t.isInvalid)return $h(e,t);e=td(e);const r=yv(e,t);if(!r.isValid)throw r.error;const n=t.body;return Mh([Kh(t),Uh(n.payload.lockboxes),...pv(n)])(e)},pv=e=>{switch(e.type){case Qt:{const{name:t,rootMember:r,rootDevice:n}=e.payload;return[gi(t),vi({roleName:ee}),fr(r),lr(n),...hr(r.userId,[ee])]}case"ADD_MEMBER":{const{member:t,roles:r}=e.payload;return[fr(t),...hr(t.userId,r)]}case"ADD_ROLE":{const t=e.payload;return[vi(t)]}case"ADD_MEMBER_ROLE":{const{userId:t,roleName:r}=e.payload;return[...hr(t,[r])]}case"REMOVE_MEMBER":{const{userId:t}=e.payload;return[av(t)]}case"ADD_DEVICE":{const{device:t}=e.payload;return[lr(t)]}case"REMOVE_DEVICE":{const{deviceId:t}=e.payload;return[ov(t)]}case"REMOVE_ROLE":{const{roleName:t}=e.payload;return[uv(t)]}case"REMOVE_MEMBER_ROLE":{const{userId:t,roleName:r}=e.payload;return[cv(t,r)]}case"INVITE_MEMBER":{const{invitation:t}=e.payload;return[yi(t)]}case"INVITE_DEVICE":{const{invitation:t}=e.payload;return[yi(t)]}case"REVOKE_INVITATION":{const{id:t}=e.payload;return[lv(t)]}case"ADMIT_MEMBER":{const{id:t,memberKeys:r,userName:n}=e.payload,s={userId:r.name,userName:n,keys:r,roles:[]};return[Ei(t),fr(s)]}case"ADMIT_DEVICE":{const{id:t,device:r}=e.payload;return[Ei(t),lr(r)]}case"CHANGE_MEMBER_KEYS":{const{keys:t}=e.payload;return[Hh(t)]}case"ROTATE_KEYS":{const{userId:t}=e.payload;return[fv(t)]}case"ADD_SERVER":{const{server:t}=e.payload;return[jh(t)]}case"REMOVE_SERVER":{const{host:t}=e.payload;return[dv(t)]}case"CHANGE_SERVER_KEYS":{const{keys:t}=e.payload;return[Vh(t)]}case"MESSAGE":{const{message:t}=e.payload;return[Bh(t)]}case"SET_TEAM_NAME":{const{teamName:t}=e.payload;return[gi(t)]}default:throw mv(e)}};function mv(e){const{type:t}=e;return new Error(`Unrecognized link type: ${t}`)}var gv=qs({initialState:rt,reducer:Gt,resolver:Ut}),Ho=(e,t)=>{const r=Ao(e,t);return gv(r)},{USER:Ev}=G,bv=({serializedGraph:e,teamKeyring:t,starterKeys:r,invitationId:n})=>{const i=Ho(e,t),{userId:s}=vn(i,n);M(s);const{userName:o}=ir(i,s);M(o);const a=yn(i,r,{type:Ev,name:s});return{userName:o,userId:s,keys:a}},Iv=e=>({...e,nonce:je(),timestamp:Date.now()}),Sv=(e,t)=>be.sign(e,t.signature.secretKey),wv=(e,t,r)=>{const n={challenge:e,signature:t};return be.verify({payload:e,signature:t,publicKey:r.signature})?q:Tv("Signature is not valid",n)},Tv=(e,t)=>({isValid:!1,error:new Av(e,t)}),Av=class extends Error{constructor(e,t){super(),this.name="Identity challenge failed",this.message=e+`
`+JSON.stringify(t,null,2).replaceAll('"',""),this.details=t}details},Mv={};rr(Mv,{createDevice:()=>Ov,redactDevice:()=>ft});var Ov=(e,t,r=je())=>{const n=Qr(),i=de({type:G.DEVICE,name:n},r);return{userId:e,deviceId:n,deviceName:t,keys:i}},ft=e=>({userId:e.userId,deviceId:e.deviceId,deviceName:e.deviceName,keys:fe(e.keys)}),Ii=e=>({...uf(e),roles:[]}),xv=e=>"teamName"in e,{DEVICE:vr,USER:yr}=G,mn=class extends zt{state=rt;store;context;log;seed;constructor(e){if(super(),this.seed=e.seed??je(),"user"in e.context)this.context=e.context;else{const{server:n}=e.context;this.context={...e.context,device:nt.toDevice(n),user:nt.toUser(n)}}const{device:t,user:r}=this.context;if(this.log=Wt.extend(`auth:team:${this.userName}`),xv(e)){M(!this.isServer,"Servers can't create teams");const n=Q(e.teamKeys,r.keys),i=de(Ph,this.seed),s=Q(i,r.keys),o=Q(r.keys,this.context.device.keys),a={name:e.teamName,rootMember:Ii(r),rootDevice:ft(t),lockboxes:[n,s,o]};this.store=Xn({user:r,reducer:Gt,resolver:Ut,initialState:rt,rootPayload:a,keys:e.teamKeys})}else this.store=Xn({user:r,reducer:Gt,resolver:Ut,initialState:rt,graph:Nh(e.source,e.teamKeyring),keys:e.teamKeyring});this.state=this.store.getState(),this.on("updated",()=>{this.checkForPendingKeyRotations()})}get graph(){return this.store.getGraph()}get id(){return this.graph.root}get teamName(){return this.state.teamName}setTeamName(e){this.dispatch({type:"SET_TEAM_NAME",payload:{teamName:e}})}get userName(){return this.context.user.userId}get userId(){return this.context.user.userId}get isServer(){return"server"in this.context}save=()=>kh(this.graph);merge=e=>(this.store.merge(e),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head}),this);dispatch(e,t=this.teamKeys()){this.store.dispatch(e,t),this.state=this.store.getState(),this.emit("updated",{head:this.graph.head})}has=e=>_o(this.state,e);members(e=_e,t={includeRemoved:!0}){return e===_e?this.state.members:ir(this.state,e,t)}addForTesting=(e,t=[],r)=>{const n={...Ii(e),roles:t};if(!this.has(n.userId)){const i=this.createMemberLockboxes(n);this.dispatch({type:"ADD_MEMBER",payload:{member:n,roles:t,lockboxes:i}})}if(r){const i=Q(e.keys,r.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:r,lockboxes:[i]}})}};remove=e=>{const t=this.rotateKeys({type:yr,name:e});this.dispatch({type:"REMOVE_MEMBER",payload:{userId:e,lockboxes:t}})};memberWasRemoved=e=>ev(this.state,e);roles(e=_e){return e===_e?this.state.roles:nv(this.state,e)}memberHasRole=(e,t)=>No(this.state,e,t);memberIsAdmin=e=>Lt(this.state,e);hasRole=e=>zh(this.state,e);membersInRole=e=>Do(this.state,e);admins=()=>tv(this.state);addRole=e=>{typeof e=="string"&&(e={roleName:e});const t=de({type:G.ROLE,name:e.roleName},this.seed),r=Q(t,this.adminKeys());this.dispatch({type:"ADD_ROLE",payload:{...e,lockboxes:[r]}})};removeRole=e=>{M(e!==ee,"Cannot remove admin role"),this.dispatch({type:"REMOVE_ROLE",payload:{roleName:e}})};addMemberRole=(e,t)=>{const r=this.members(e),n=Q(this.roleKeys(t),r.keys);this.dispatch({type:"ADD_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:[n]}})};removeMemberRole=(e,t)=>{if(t===ee){const n=this.membersInRole(ee).length;M(n>1,"Can't remove the last admin")}const r=this.rotateKeys({type:G.ROLE,name:t});this.dispatch({type:"REMOVE_MEMBER_ROLE",payload:{userId:e,roleName:t,lockboxes:r}})};hasDevice=(e,t)=>Oo(this.state,e,t);device(e,t){return nr(this.state,e,t)}removeDevice=e=>{if(!this.hasDevice(e))throw new Error(`Device ${e} not found`);const t=this.rotateKeys({type:vr,name:e});this.dispatch({type:"REMOVE_DEVICE",payload:{deviceId:e,lockboxes:t}})};deviceWasRemoved=e=>Wh(this.state,e);memberByDeviceId=(e,t)=>ko(this.state,e,t);verifyIdentityProof=(e,t)=>{M(e.type===vr);const r=e.name,n=this.hasServer(r)?this.servers(r):this.device(r,{includeRemoved:!0});return wv(e,t,n.keys).isValid};inviteMember({seed:e=Dr(),expiration:t,maxUses:r}={}){e=lt(e);const n=Nr({seed:e,expiration:t,maxUses:r}),{id:i}=n;return this.dispatch({type:"INVITE_MEMBER",payload:{invitation:n}}),{id:i,seed:e}}inviteDevice({seed:e=Dr(),expiration:t=Date.now()+30*60*1e3}={}){M(!this.isServer,"Servers can't invite a device"),e=lt(e);const n=Nr({seed:e,expiration:t,maxUses:1,userId:this.userId}),i=mt(e),s=Q(this.context.user.keys,i),{id:o}=n;return this.dispatch({type:"INVITE_DEVICE",payload:{invitation:n,lockboxes:[s]}}),{id:o,seed:e}}revokeInvitation=e=>{this.dispatch({type:"REVOKE_INVITATION",payload:{id:e}})};hasInvitation(e){return hn(this.state,e)}getInvitation=e=>vn(this.state,e);validateInvitation=e=>{const{id:t}=e;if(!this.hasInvitation(t))return Ee("This invitation code doesn't match.");const r=this.getInvitation(t),n=pn(r,Date.now());return n!==q?n:Bo(e,r)};admitMember=(e,t,r)=>{const n=this.validateInvitation(e);if(!n.isValid)throw n.error;const{id:i}=e,s=Q(this.teamKeys(),t);this.dispatch({type:"ADMIT_MEMBER",payload:{id:i,userName:r,memberKeys:fe(t),lockboxes:[s]}})};admitDevice=(e,t)=>{const r=this.validateInvitation(e);if(!r.isValid)throw r.error;const{id:n}=e,s=this.getInvitation(n).userId,o={...t,userId:s};this.dispatch({type:"ADMIT_DEVICE",payload:{id:n,device:o}})};join=e=>{M(!this.isServer,"Can't join as member on server");const{user:t,device:r}=this.context,n=Ql(e),i=Q(t.keys,r.keys);this.dispatch({type:"ADD_DEVICE",payload:{device:ft(r),lockboxes:[i]}},n)};addServer=e=>{const t=this.createMemberLockboxes(nt.toMember(e));this.dispatch({type:"ADD_SERVER",payload:{server:e,lockboxes:t}})};removeServer=e=>{this.dispatch({type:"REMOVE_SERVER",payload:{host:e}})};servers(e=_e,t={includeRemoved:!0}){return e===_e?this.state.servers:ln(this.state,e,t)}serverWasRemoved=e=>iv(this.state,e);hasServer=e=>fn(this.state,e);addMessage=e=>{this.dispatch({type:"MESSAGE",payload:{message:e}})};messages=()=>rv(this.state);encrypt=(e,t)=>{const r=t?{type:G.ROLE,name:t}:Ft,{secretKey:n,generation:i}=this.keys(r);return{contents:Nt.encryptBytes(e,n),recipient:{...r,generation:i}}};decrypt=e=>{const{secretKey:t}=this.keys(e.recipient);return Nt.decryptBytes(e.contents,t)};sign=e=>{M(this.context.user);const{keys:{type:t,name:r,generation:n,signature:{secretKey:i}}}=this.context.user;return{contents:e,signature:be.sign(e,i),author:{type:t,name:r,generation:n}}};verify=e=>be.verify({payload:e.contents,signature:e.signature,publicKey:this.members(e.author.name).keys.signature});keys=e=>yn(this.state,this.context.device.keys,e);roleKeys=(e,t)=>this.keys({type:G.ROLE,name:e,generation:t});teamKeys=e=>this.keys({...Ft,generation:e});teamKeyring=()=>sv(this.state,this.context.device.keys);adminKeys=e=>this.roleKeys(ee,e);changeKeys=e=>{const{device:t,user:r}=this.context,{type:n}=e;M(n!==vr,"Can't change device keys");const i=n===yr,s=n===G.SERVER,o=r.keys;e.generation=o.generation+1;const a=this.rotateKeys(e),c=i?"CHANGE_MEMBER_KEYS":"CHANGE_SERVER_KEYS",u=fe(e);this.dispatch({type:c,payload:{keys:u,lockboxes:a}}),(s||i)&&(r.keys=e),s&&(t.keys=e)};checkForPendingKeyRotations(){if(this.memberIsAdmin(this.userId))for(const e of this.state.pendingKeyRotations){const t=this.rotateKeys({type:yr,name:this.userId});this.dispatch({type:"ROTATE_KEYS",payload:{userId:e,lockboxes:t}})}}createMemberLockboxes=e=>{const t=e.roles.map(this.roleKeys),r=n=>Q(n,e.keys);return[...t,this.teamKeys()].map(r)};rotateKeys=e=>{const t=Zt(e)?e:de(e),n=Co(this.state,e).map(o=>de(o)),i=[t,...n];return i.flatMap(o=>Qh(this.state,o).map(c=>{const u=i.find(d=>wo(d,c.recipient));return Jh({oldLockbox:c,newContents:o,updatedRecipientKeys:u?fe(u):void 0})}))}};function Wv(e,t,r){const n=de(Ft,r);return new mn({teamName:e,context:t,teamKeys:n})}var _v=({encryptedGraph:e,teamKeys:t,deviceKeys:r})=>{const n=He(t),{encryptedLinks:i,childMap:s,root:o}=e,a=e.links??{},c=(l,h,p={},y=rt)=>{const m=i[l],g=a[l]??Fs(m,h);let b={[l]:g};const S=Gt(y,g);let T;try{T=yn(S,r,Ft),n[T.encryption.publicKey]=T}catch{T=h}const _=s[l];if(_)for(const D of _)b={...b,...c(D,T,b,S)};return{...p,...b}},u=i[o].recipientPublicKey,d=n[u],f=c(o,d);return{...e,links:f}},zv=(e,t,r)=>{const n=He(r);return new mn({source:e,context:t,teamKeyring:n})},Vo=e=>{if(e===void 0)return"DONE";const{head:t,links:r,need:n}=e,i={head:t};return r&&(i.links=Object.keys(r).join(", ")),n&&(i.need=n.join(", ")),Oi(JSON.stringify(i))},Ye=Wt.extend("message-queue"),Rv=class extends zt{#r=!1;#e={};#n=0;#s={};#a;#t={};#o=0;#i;constructor({sendMessage:e,timeout:t=1e3}){super(),this.#i=r=>{this.#o=r.index+1,e(r)},this.#a=t}start(){return this.#r=!0,this.#c(),this.#u(),this}stop(){return this.#r=!1,this}send(e){const t=Si(this.#t)+1,r={...e,index:t};return this.#t[t]=r,Ye("send %o",r),this.#r&&this.#i(r),this}resend(e){const t=this.#t[e];if(!t)throw new Error(`Received resend request for message #${e}, which doesn't exist.`);return Ye("resend %o",t),this.#i(t),this}receive(e){const{index:t}=e;return Ye("receive %o",e),this.#e[t]||(this.#e[t]=e,this.#r&&this.#c()),this}#u(){for(Ye("processOutbound");this.#t[this.#o];){const e=this.#t[this.#o];this.#i(e)}}#c(){for(Ye("processInbound");this.#e[this.#n];){const t=this.#e[this.#n];this.#n++,this.emit("message",t)}const e=Si(this.#e);for(let t=this.#n;t<e;t++)this.#s[t]||(this.#s[t]=setTimeout(()=>{this.#e[t]||this.emit("request",t),delete this.#s[t]},this.#a))}};function Si(e){return Math.max(...Object.keys(e).map(Number),-1)}var Lv=7e3,We={after:{[Lv]:{actions:"failTimeout",target:"#disconnected"}}},kv={predictableActionArguments:!0,id:"connection",initial:"awaitingIdentityClaim",on:{REQUEST_IDENTITY:{actions:"sendIdentityClaim",target:"awaitingIdentityClaim"},CLAIM_IDENTITY:{actions:["receiveIdentityClaim"],target:"awaitingIdentityClaim"},ERROR:{actions:"receiveError",target:"#disconnected"},LOCAL_ERROR:{actions:"sendError",target:"#disconnected"}},states:{awaitingIdentityClaim:{id:"awaitingIdentityClaim",always:{cond:"bothSentIdentityClaim",target:"authenticating"}},authenticating:{id:"authenticating",initial:"checkingInvitations",states:{checkingInvitations:{initial:"checkingForInvitations",states:{checkingForInvitations:{always:[{cond:"bothHaveInvitation",actions:"failNeitherIsMember",target:"#disconnected"},{cond:"weHaveInvitation",target:"awaitingInvitationAcceptance"},{cond:"theyHaveInvitation",target:"validatingInvitation"},{target:"#checkingIdentity"}]},awaitingInvitationAcceptance:{on:{ACCEPT_INVITATION:[{cond:"joinedTheRightTeam",actions:["joinTeam"],target:"#checkingIdentity"},{actions:"rejectTeam",target:"#disconnected"}]},...We},validatingInvitation:{always:[{cond:"invitationProofIsValid",actions:"acceptInvitation",target:"#checkingIdentity"},{actions:"rejectInvitation",target:"#disconnected"}]}}},checkingIdentity:{id:"checkingIdentity",type:"parallel",states:{provingMyIdentity:{initial:"awaitingIdentityChallenge",states:{awaitingIdentityChallenge:{always:{cond:"weHaveInvitation",target:"doneProvingMyIdentity"},on:{CHALLENGE_IDENTITY:{actions:["proveIdentity"],target:"awaitingIdentityAcceptance"}},...We},awaitingIdentityAcceptance:{on:{ACCEPT_IDENTITY:{target:"doneProvingMyIdentity"}},...We},doneProvingMyIdentity:{type:"final"}}},verifyingTheirIdentity:{initial:"challengingIdentity",states:{challengingIdentity:{always:[{cond:"theyHaveInvitation",target:"doneVerifyingTheirIdentity"},{actions:["confirmIdentityExists","challengeIdentity"],target:"awaitingIdentityProof"}]},awaitingIdentityProof:{on:{PROVE_IDENTITY:[{cond:"identityProofIsValid",actions:"acceptIdentity",target:"doneVerifyingTheirIdentity"},{actions:"rejectIdentityProof",target:"#disconnected"}]},...We},doneVerifyingTheirIdentity:{type:"final"}}}},onDone:{target:"doneAuthenticating"}},doneAuthenticating:{type:"final"}},onDone:{actions:["listenForTeamUpdates"],target:"#negotiating"}},negotiating:{id:"negotiating",entry:["generateSeed"],initial:"awaitingSeed",states:{awaitingSeed:{entry:["sendSeed"],on:{SEED:{actions:"receiveSeed",target:"doneNegotiating"}},...We},doneNegotiating:{entry:"deriveSharedKey",type:"final"}},onDone:{actions:["sendSyncMessage"],target:"#synchronizing"}},synchronizing:{id:"synchronizing",always:[{cond:"headsAreEqual",actions:"onConnected",target:"#connected"}],on:{SYNC:{actions:["receiveSyncMessage","sendSyncMessage"],target:"#synchronizing"}}},connected:{id:"connected",always:[{cond:"peerWasRemoved",actions:"failPeerWasRemoved",target:"disconnected"}],on:{LOCAL_UPDATE:{actions:["sendSyncMessage"],target:"#connected"},SYNC:{actions:["receiveSyncMessage","sendSyncMessage"],target:"#connected"},ENCRYPTED_MESSAGE:{actions:"receiveEncryptedMessage",target:"#connected"},DISCONNECT:"#disconnected"}},disconnected:{id:"disconnected",entry:"onDisconnected"}}},Uo=e=>"team"in e&&e.team!==void 0,sr=e=>"invitationSeed"in e&&e.invitationSeed!==void 0,gn=e=>sr(e)&&"user"in e&&e.user!==void 0,Fo=e=>sr(e)&&!gn(e),Go=e=>"server"in e&&e.server!==void 0,Cr=e=>"deviceId"in e&&e.deviceId!==void 0,Yo=e=>De(e)&&"userKeys"in e&&e.userKeys!==void 0,Nv=e=>De(e)&&!("userKeys"in e),De=e=>"proofOfInvitation"in e&&e.proofOfInvitation!==void 0,{DEVICE:Dv}=G,Cv=class extends zt{machine;started=!1;messageQueue;log=Wt.extend("auth:connection");constructor({sendMessage:e,context:t}){super(),this.messageQueue=new Rv({sendMessage:i=>{this.logMessage("out",i);const s=$r(i);e(s)}}).on("message",i=>{if(this.logMessage("in",i),i.type==="REQUEST_RESEND"){const{index:s}=i.payload;this.messageQueue.resend(s);return}this.machine.send(i)}).on("request",i=>{this.sendMessage({type:"REQUEST_RESEND",payload:{index:i}})});const r="server"in t?t.server.host:"userName"in t?t.userName:"user"in t?t.user.userName:"";this.log=this.log.extend(r);const n=Go(t)?$v(t):t;this.machine=ho(ih(kv,{actions:this.actions,guards:this.guards}).withContext(n)).onTransition((i,s)=>{const o=Wo(i.value);this.emit("change",o),this.log(`${wi(s)} ⏩ ${o} `)}),this.emit=(i,...s)=>(this.log(`emit ${i} %o`,...s),super.emit(i,...s))}start=(e=[])=>{this.log("starting"),this.machine.start(),this.messageQueue.start(),this.started=!0,this.sendMessage({type:"REQUEST_IDENTITY"});for(const t of e)this.deliver(t);return this};stop=()=>{if(this.started&&!this.machine.state.done){const e={type:"DISCONNECT"};this.machine.send(e);try{this.sendMessage(e)}catch{}}return this.removeAllListeners(),this.messageQueue.stop(),this.machine.stop(),this.machine.state.done=!0,this.log("machine stopped"),this};get state(){return M(this.started),this.machine.state.value}get context(){return M(this.started),this.machine.state.context}get user(){return this.context.user}get error(){return this.context.error}get team(){return this.context.team}get sessionKey(){return this.context.sessionKey}deliver(e){const t=Kr(e);this.messageQueue.receive(t)}send=e=>{M(this.sessionKey);const t=Nt.encryptBytes(e,this.sessionKey);this.sendMessage({type:"ENCRYPTED_MESSAGE",payload:t})};actions={sendIdentityClaim:z(e=>{const r=(n=>{if(Uo(n))return{deviceId:n.device.deviceId};if(gn(n)){const{userName:i,keys:s}=n.user;return{proofOfInvitation:this.myProofOfInvitation(n),userName:i,userKeys:fe(s),device:ft(n.device)}}if(Fo(n)){const{userName:i,device:s}=n;return{proofOfInvitation:this.myProofOfInvitation(n),userName:i,device:ft(s)}}throw new Error("Invalid context")})(e);return this.sendMessage({type:"CLAIM_IDENTITY",payload:r}),{ourIdentityClaim:r}}),receiveIdentityClaim:z((e,t)=>{const{payload:r}=t;return"userName"in r&&(this.log=this.log.extend(r.userName)),{theirIdentityClaim:r,theirDevice:"device"in r?r.device:void 0}}),acceptInvitation:z(e=>{const{team:t,theirIdentityClaim:r}=e;M(t),M(r),M(De(r));const{proofOfInvitation:n}=r,s=(()=>{if(Yo(r)){const{userName:o,userKeys:a}=r;M(o),t.admitMember(n,a,o);const c=a.name;return t.members(c)}else{const{device:o}=r;t.admitDevice(n,o);const{deviceId:a}=o,{userId:c}=t.memberByDeviceId(a);return t.members(c)}})();return this.sendMessage({type:"ACCEPT_INVITATION",payload:{serializedGraph:t.save(),teamKeyring:t.teamKeyring()}}),{peer:s}}),joinTeam:z((e,t)=>{const{payload:r}=t,{serializedGraph:n,teamKeyring:i}=r,{device:s,invitationSeed:o}=e,a=()=>{const{id:d}=this.myProofOfInvitation(e),f=mt(o);return bv({serializedGraph:n,teamKeyring:i,starterKeys:f,invitationId:d})},c=e.user??a(),u=new mn({source:n,context:{user:c,device:s},teamKeyring:i});return u.join(i),this.emit("joined",{team:u,user:c}),{user:c,team:u}}),confirmIdentityExists:z(e=>{const{team:t,theirIdentityClaim:r}=e;M(r),M(t),M(Cr(r));const{deviceId:n}=r;try{const i=t.device(n,{includeRemoved:!0}),s=t.memberByDeviceId(n,{includeRemoved:!0});return this.log=this.log.extend(s.userName),{theirDevice:i,peer:s}}catch{return{error:this.throwError("DEVICE_UNKNOWN",{message:`Device ${n} not found.`})}}}),challengeIdentity:z(e=>{const{theirIdentityClaim:t}=e;M(t),M(Cr(t));const{deviceId:r}=t,n=Iv({type:Dv,name:r});return this.sendMessage({type:"CHALLENGE_IDENTITY",payload:{challenge:n}}),{challenge:n}}),proveIdentity:(e,t)=>{M(e.user);const{challenge:r}=t.payload,n=Sv(r,e.device.keys);this.sendMessage({type:"PROVE_IDENTITY",payload:{challenge:r,proof:n}})},acceptIdentity:()=>{this.sendMessage({type:"ACCEPT_IDENTITY"})},listenForTeamUpdates:e=>{M(e.team),e.team.on("updated",({head:t})=>{this.machine.state.done||this.machine.send({type:"LOCAL_UPDATE",payload:{head:t}}),this.emit("updated")})},sendSyncMessage:z(e=>{M(e.team);const t=e.syncState??Qn(),[r,n]=af(e.team.graph,t);return n?(this.log("sending sync message",Vo(n)),this.sendMessage({type:"SYNC",payload:n})):this.log("no sync message to send"),{syncState:r}}),receiveSyncMessage:z((e,t)=>{const{team:r,device:n}=e;M(r);const i=e.syncState??Qn(),s=t.payload,o=r.teamKeys(),a=n.keys,c=({encryptedGraph:l,keys:h})=>_v({encryptedGraph:l,teamKeys:h,deviceKeys:a}),[u,d]=cf(r.graph,i,s,o,c);return Mt(u.head,r.graph.head)?{syncState:d}:(this.emit("updated"),{team:r.merge(u),syncState:d})}),generateSeed:z(e=>({seed:Zo()})),sendSeed:e=>{const{user:t,peer:r,seed:n}=e,i=he.encryptBytes({secret:n,recipientPublicKey:r.keys.encryption,senderSecretKey:t.keys.encryption.secretKey});this.sendMessage({type:"SEED",payload:{encryptedSeed:i}})},receiveSeed:z((e,t)=>{const{payload:r}=t;return{theirEncryptedSeed:r.encryptedSeed}}),deriveSharedKey:z({sessionKey:e=>{const{user:t,seed:r,theirEncryptedSeed:n,peer:i}=e;M(r),M(n);const s=he.decryptBytes({cipher:n,senderPublicKey:i.keys.encryption,recipientSecretKey:t.keys.encryption.secretKey});return Rh(r,s)}}),receiveEncryptedMessage:(e,t)=>{const{sessionKey:r}=e;M(r);const{payload:n}=t,i=Nt.decryptBytes(n,r);this.emit("message",i)},receiveError:z((e,t)=>{const r=t.payload;return this.log("receiveError %o",r),this.emit("remoteError",r),{error:r}}),sendError:z((e,t)=>{const r=t.payload;this.log("sendError %o",r);const n=kr(r.type,r.details,"REMOTE");return this.sendMessage(n),this.emit("localError",r),{error:r}}),rejectIdentityProof:this.fail("IDENTITY_PROOF_INVALID"),failNeitherIsMember:this.fail("NEITHER_IS_MEMBER"),rejectInvitation:this.fail("INVITATION_PROOF_INVALID"),rejectTeam:this.fail("JOINED_WRONG_TEAM"),failPeerWasRemoved:this.fail("MEMBER_REMOVED"),failDeviceWasRemoved:this.fail("DEVICE_REMOVED"),failTimeout:this.fail("TIMEOUT"),onConnected:()=>this.emit("connected"),onDisconnected:(e,t)=>this.emit("disconnected",t)};guards={weHaveInvitation:e=>sr(e),theyHaveInvitation:e=>De(e.theirIdentityClaim),bothHaveInvitation:(...e)=>{const t=this.guards.weHaveInvitation(...e),r=this.guards.theyHaveInvitation(...e);return t&&r},invitationProofIsValid:e=>{const{team:t,theirIdentityClaim:r}=e;M(t),M(r),M(De(r));const{proofOfInvitation:n}=r,i=t.validateInvitation(n);return i.isValid?!0:(e.error=i.error,!1)},joinedTheRightTeam:(e,t)=>{const{payload:r}=t,{serializedGraph:n,teamKeyring:i}=r,s=Ho(n,i),{id:o}=this.myProofOfInvitation(e);return hn(s,o)},bothSentIdentityClaim:e=>e.ourIdentityClaim!==void 0&&e.theirIdentityClaim!==void 0,identityProofIsValid(e,t){const{team:r}=e;M(r);const{payload:n}=t,{challenge:i,proof:s}=n;return r.verifyIdentityProof(i,s)},peerWasRemoved(e){const{team:t,peer:r,theirDevice:n}=e;M(t),M(r),M(n);const i=t.serverWasRemoved(r.userId),s=t.memberWasRemoved(r.userId),o=t.deviceWasRemoved(n.deviceId);return i||s||o},headsAreEqual(e){const{team:t,syncState:r}=e;M(t);const n=t.graph.head,i=r?.lastCommonHead;return yo(n,i)}};sendMessage=e=>{this.messageQueue.send(e)};throwError=(e,t)=>{const r=t&&"message"in t?t.message:void 0;this.log("error: %s %o",e,t);const n=kr(e,r,"LOCAL");return this.machine.send(n),n.payload};fail(e){return z({error:t=>{const r=t.error;return this.throwError(e,r)}})}logMessage(e,t){const r=e==="in"?"<-":"->",n=this.started?this.context.peer?.userName??"?":"?";this.log(`${r}${n} #${t.index} ${wi(t)}`)}myProofOfInvitation(e){return M(e.invitationSeed),Ko(e.invitationSeed)}},wi=e=>e.type==="SYNC"?`SYNC ${Vo(e.payload)}`:`${e.type} ${e.payload?.head?.slice(0,5)||e.payload?.message||""}`,Pv=e=>typeof e=="string",Wo=e=>Pv(e)?e:Object.keys(e).map(t=>`${t}:${Wo(e[t])}`).filter(t=>t.length).join(","),$v=e=>{const{keys:t,host:r}=e.server;return{...e,user:{userId:r,userName:r,keys:t},device:{userId:r,deviceId:r,deviceName:r,keys:t}}};export{ee as ADMIN,Ph as ADMIN_SCOPE,_e as ALL,Cv as Connection,Th as DEVICE_ID,Eh as ENCRYPTION,Yv as EPHEMERAL_SCOPE,So as HashPurpose,wh as INVITATION,Ih as LINK_HASH,Sh as LINK_TO_PREVIOUS,Ah as SHARED_KEY,gh as SIGNATURE,bh as SYMMETRIC,Ft as TEAM_SCOPE,mn as Team,q as VALID,he as asymmetric,nt as castServer,oh as connection,Ov as createDevice,de as createKeyset,Wv as createTeam,Fv as createUser,Mv as device,Ko as generateProof,Gv as graphSummary,rt as initialState,hv as invitation,zv as loadTeam,ft as redactDevice,fe as redactKeys,uf as redactUser,ah as role,be as signatures,Nt as symmetric};
//# sourceMappingURL=index-BjP3FqTW.js.map

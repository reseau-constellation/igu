import{l as L,j as z,t as M}from"./index-a388e6bc.js";import{b as $,s as N,A as T,W as k,c as W,g as J}from"./index-0d9cbd8f.js";function P(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),o=0;o<n.length;o++)n[o]=255;for(var s=0;s<r.length;s++){var f=r.charAt(s),v=f.charCodeAt(0);if(n[v]!==255)throw new TypeError(f+" is ambiguous");n[v]=s}var a=r.length,c=r.charAt(0),E=Math.log(a)/Math.log(256),C=Math.log(256)/Math.log(a);function O(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(t.length===0)return"";for(var i=0,d=0,h=0,p=t.length;h!==p&&t[h]===0;)h++,i++;for(var b=(p-h)*C+1>>>0,l=new Uint8Array(b);h!==p;){for(var w=t[h],y=0,u=b-1;(w!==0||y<d)&&u!==-1;u--,y++)w+=256*l[u]>>>0,l[u]=w%a>>>0,w=w/a>>>0;if(w!==0)throw new Error("Non-zero carry");d=y,h++}for(var g=b-d;g!==b&&l[g]===0;)g++;for(var U=c.repeat(i);g<b;++g)U+=r.charAt(l[g]);return U}function m(t){if(typeof t!="string")throw new TypeError("Expected String");if(t.length===0)return new Uint8Array;var i=0;if(t[i]!==" "){for(var d=0,h=0;t[i]===c;)d++,i++;for(var p=(t.length-i)*E+1>>>0,b=new Uint8Array(p);t[i];){var l=n[t.charCodeAt(i)];if(l===255)return;for(var w=0,y=p-1;(l!==0||w<h)&&y!==-1;y--,w++)l+=a*b[y]>>>0,b[y]=l%256>>>0,l=l/256>>>0;if(l!==0)throw new Error("Non-zero carry");h=w,i++}if(t[i]!==" "){for(var u=p-h;u!==p&&b[u]===0;)u++;for(var g=new Uint8Array(d+(p-u)),U=d;u!==p;)g[U++]=b[u++];return g}}}function S(t){var i=m(t);if(i)return i;throw new Error(`Non-${e} character`)}return{encode:O,decodeUnsafe:m,decode:S}}var F=P,I=F;const V=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};class X{constructor(e,n,o){this.name=e,this.prefix=n,this.baseEncode=o}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class B{constructor(e,n,o){if(this.name=e,this.prefix=n,n.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=n.codePointAt(0),this.baseDecode=o}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return R(this,e)}}class Z{constructor(e){this.decoders=e}or(e){return R(this,e)}decode(e){const n=e[0],o=this.decoders[n];if(o)return o.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const R=(r,e)=>new Z({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class j{constructor(e,n,o,s){this.name=e,this.prefix=n,this.baseEncode=o,this.baseDecode=s,this.encoder=new X(e,n,o),this.decoder=new B(e,n,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const q=({name:r,prefix:e,encode:n,decode:o})=>new j(r,e,n,o),_=({prefix:r,name:e,alphabet:n})=>{const{encode:o,decode:s}=I(n,e);return q({prefix:r,name:e,encode:o,decode:f=>V(s(f))})},x=_({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});_({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const G=421,K=290,Q=2e3,D=L("libp2p:webrtc-direct:socket");function Y(r,e){const{sink:n,source:o}=r,s={remoteAddr:e.remoteAddr,async sink(f){e.signal!=null&&(f=$(f,e.signal));try{await n(f)}catch(v){v.type!=="aborted"&&D.error(v)}},source:e.signal!=null?$(o,e.signal):o,timeline:{open:Date.now()},async close(){if(r.closed)return;const f=Date.now(),v=setTimeout(()=>{if(s.remoteAddr!=null){const{host:a,port:c}=s.remoteAddr.toOptions();D("timeout closing socket to %s:%s after %dms, destroying it manually",a,c,Date.now()-f)}r.closed||r.close().catch(a=>{D.error("could not close socket",a)})},Q);try{await r.close()}finally{clearTimeout(v)}}};return r.addEventListener("close",()=>{s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}function H(){throw new Error("WebRTCDirect Servers can not be created in the browser!")}const A=L("libp2p:webrtc-direct");class ee{constructor(e){this.initiatorOptions=e?.initiatorOptions,this.recieverOptions=e?.recieverOptions,this.wrtc=e?.wrtc}get[N](){return!0}get[Symbol.toStringTag](){return"@libp2p/webrtc-direct"}async dial(e,n){const o=await this._connect(e,n),s=Y(o,{remoteAddr:e,signal:n.signal});A("new outbound connection %s",s.remoteAddr);const f=await n.upgrader.upgradeOutbound(s);return A("outbound connection %s upgraded",s.remoteAddr),f}async _connect(e,n){if(n.signal?.aborted===!0)throw new T;const o={initiator:!0,trickle:!1,...this.initiatorOptions};return this.wrtc!=null&&(o.wrtc=this.wrtc),await new Promise((s,f)=>{let v;const a=e.toOptions();A("Dialing %s:%s",a.host,a.port);const c=new k(o),E=t=>{const i=t.detail;if(!v){const d=`connection error ${a.host}:${a.port}: ${i.message}`;A.error(d),i.message=d,m(i)}},C=()=>{v=!0,A("connection opened %s:%s",a.host,a.port),m()},O=()=>{A.error("connection aborted %s:%s",a.host,a.port),c.close().finally(()=>{m(new T)})},m=t=>{c.removeEventListener("error",E),c.removeEventListener("ready",C),n.signal?.removeEventListener("abort",O),t!=null?f(t):s(c)};c.addEventListener("error",E,{once:!0}),c.addEventListener("ready",C,{once:!0}),c.addEventListener("close",()=>{c.removeEventListener("error",E)}),n.signal?.addEventListener("abort",O);const S=async t=>{if(t.type!=="offer")return;const i=JSON.stringify(t);let d=a.host;a.family===6&&!d.startsWith("[")&&(d=`[${d}]`);const h=`http://${d}:${a.port}`,p=`/?signal=${x.encode(z(i))}`,b=h+p;try{const w=await(await J(b)).text();if(w.trim()==="")return;const y=x.decode(w),u=M(y),g=JSON.parse(u);c.handleSignal(g)}catch(l){await c.close(l),f(l)}};c.addEventListener("signal",t=>{const i=t.detail;S(i).catch(async d=>{await c.close(d)})})})}createListener(e){return H({...e,receiverOptions:this.recieverOptions,wrtc:this.wrtc})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(n=>n.protoCodes().includes(K)?!1:W.matches(n.decapsulateCode(G)))}}function ne(r={}){return()=>new ee(r)}export{ne as w};
//# sourceMappingURL=index-f5acf23b.js.map

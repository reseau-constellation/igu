var x9=Object.defineProperty;var $9=(r,e,t)=>e in r?x9(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var zd=(r,e,t)=>($9(r,typeof e!="symbol"?e+"":e,t),t),bp=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var Kn=(r,e,t)=>(bp(r,e,"read from private field"),t?t.call(r):e.get(r)),lc=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},nn=(r,e,t,n)=>(bp(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t),Fd=(r,e,t,n)=>({set _(s){nn(r,e,s,t)},get _(){return Kn(r,e,n)}});import{d as E,N as L9,P as M9,a as U9,Q as B9,R as p6,S as z9,T as F9,U as V9,V as j9,J as E0,W as Xs,X as Ir,Y as ue,Z as K,$ as ua,a0 as K9,a1 as q9,a2 as H9,a3 as dt,a4 as G9,H as W9,t as q,j as M,a5 as g6,a6 as Jr,a7 as lt,a8 as Vr,a9 as ji,m as tt,h as rt,i as nt,l as O,k as Ki,c as Jt,u as oi,e as Dt,aa as da,ab as Le,E as X,ac as df,ad as ze,ae as Vd,af as Xt,ag as Y9,ah as Q9,ai as J9,aj as X9,ak as Z9,al as eE,am as tE,an as rE,K as or,ao as nE,ap as yl,aq as id,ar as _0,as as sE,at as js,au as wl,av as Ds,aw as Se,ax as iE,ay as Oi,C as oE,az as aE,aA as Ot,aB as v0,aC as od,n as hf,aD as cE,q as lE,p as uE,I as dE,o as hE,aE as fE,aF as pE,aG as gE,aH as yE,L as wE}from"./index-f368f037.js";import{b as re,c as Sn,d as Xr,i as Ys,a as dr,p as Bt,e as ne,U as Pt,f as jd,m as qt,u as Kd,g as Dr,h as Gr,j as S0,k as bt,l as mE,n as bE}from"./index-2e6f4210.js";import{I as EE,m as y6,b as Ps,E as st,C as Z,w as _E,s as vE,e as jr,f as SE,g as RE,h as IE,i as ad,d as AE,P as CE,a as TE}from"./index-a5e27852.js";import{s as DE}from"./source-55a07a62.js";const Ep={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function _p(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(Ep).join(" / ");throw E(new Error(`Hash '${s}' is unknown or not supported. Must be ${a}`),"ERR_UNSUPPORTED_HASH_TYPE")}const i=Ep[s],o=L9(r,e,t,n,i);return M9.encode64(o,null)}function ff(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}function Ra(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=U9(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return B9(t)}var pf={},PE={get exports(){return pf},set exports(r){pf=r}},w6={},m6={},kE=Ia,R0=p6();(Ia.prototype=Object.create(R0.EventEmitter.prototype)).constructor=Ia;function Ia(r,e,t){if(typeof r!="function")throw TypeError("rpcImpl must be a function");R0.EventEmitter.call(this),this.rpcImpl=r,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(t)}Ia.prototype.rpcCall=function r(e,t,n,s,i){if(!s)throw TypeError("request must be specified");var o=this;if(!i)return R0.asPromise(r,o,e,t,n,s);if(!o.rpcImpl){setTimeout(function(){i(Error("already ended"))},0);return}try{return o.rpcImpl(e,t[o.requestDelimited?"encodeDelimited":"encode"](s).finish(),function(c,u){if(c)return o.emit("error",c,e),i(c);if(u===null){o.end(!0);return}if(!(u instanceof n))try{u=n[o.responseDelimited?"decodeDelimited":"decode"](u)}catch(l){return o.emit("error",l,e),i(l)}return o.emit("data",u,e),i(null,u)})}catch(a){o.emit("error",a,e),setTimeout(function(){i(a)},0);return}};Ia.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};(function(r){var e=r;e.Service=kE})(m6);var OE={};(function(r){var e=r;e.build="minimal",e.Writer=z9,e.BufferWriter=F9,e.Reader=V9,e.BufferReader=j9,e.util=p6(),e.rpc=m6,e.roots=OE,e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()})(w6);(function(r){r.exports=w6})(PE);const j=E0(pf),qi=j.Reader,I0=j.Writer,Y=j.util,mt=j.roots["ipfs-unixfs"]||(j.roots["ipfs-unixfs"]={}),NE=mt.Data=(()=>{function r(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.Type=0,r.prototype.Data=Y.newBuffer([]),r.prototype.filesize=Y.Long?Y.Long.fromBits(0,0,!0):0,r.prototype.blocksizes=Y.emptyArray,r.prototype.hashType=Y.Long?Y.Long.fromBits(0,0,!0):0,r.prototype.fanout=Y.Long?Y.Long.fromBits(0,0,!0):0,r.prototype.mode=0,r.prototype.mtime=null,r.encode=function(t,n){if(n||(n=I0.create()),n.uint32(8).int32(t.Type),t.Data!=null&&Object.hasOwnProperty.call(t,"Data")&&n.uint32(18).bytes(t.Data),t.filesize!=null&&Object.hasOwnProperty.call(t,"filesize")&&n.uint32(24).uint64(t.filesize),t.blocksizes!=null&&t.blocksizes.length)for(var s=0;s<t.blocksizes.length;++s)n.uint32(32).uint64(t.blocksizes[s]);return t.hashType!=null&&Object.hasOwnProperty.call(t,"hashType")&&n.uint32(40).uint64(t.hashType),t.fanout!=null&&Object.hasOwnProperty.call(t,"fanout")&&n.uint32(48).uint64(t.fanout),t.mode!=null&&Object.hasOwnProperty.call(t,"mode")&&n.uint32(56).uint32(t.mode),t.mtime!=null&&Object.hasOwnProperty.call(t,"mtime")&&mt.UnixTime.encode(t.mtime,n.uint32(66).fork()).ldelim(),n},r.decode=function(t,n){t instanceof qi||(t=qi.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new mt.Data;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.Type=t.int32();break;case 2:i.Data=t.bytes();break;case 3:i.filesize=t.uint64();break;case 4:if(i.blocksizes&&i.blocksizes.length||(i.blocksizes=[]),(o&7)===2)for(var a=t.uint32()+t.pos;t.pos<a;)i.blocksizes.push(t.uint64());else i.blocksizes.push(t.uint64());break;case 5:i.hashType=t.uint64();break;case 6:i.fanout=t.uint64();break;case 7:i.mode=t.uint32();break;case 8:i.mtime=mt.UnixTime.decode(t,t.uint32());break;default:t.skipType(o&7);break}}if(!i.hasOwnProperty("Type"))throw Y.ProtocolError("missing required 'Type'",{instance:i});return i},r.fromObject=function(t){if(t instanceof mt.Data)return t;var n=new mt.Data;switch(t.Type){case"Raw":case 0:n.Type=0;break;case"Directory":case 1:n.Type=1;break;case"File":case 2:n.Type=2;break;case"Metadata":case 3:n.Type=3;break;case"Symlink":case 4:n.Type=4;break;case"HAMTShard":case 5:n.Type=5;break}if(t.Data!=null&&(typeof t.Data=="string"?Y.base64.decode(t.Data,n.Data=Y.newBuffer(Y.base64.length(t.Data)),0):t.Data.length&&(n.Data=t.Data)),t.filesize!=null&&(Y.Long?(n.filesize=Y.Long.fromValue(t.filesize)).unsigned=!0:typeof t.filesize=="string"?n.filesize=parseInt(t.filesize,10):typeof t.filesize=="number"?n.filesize=t.filesize:typeof t.filesize=="object"&&(n.filesize=new Y.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0))),t.blocksizes){if(!Array.isArray(t.blocksizes))throw TypeError(".Data.blocksizes: array expected");n.blocksizes=[];for(var s=0;s<t.blocksizes.length;++s)Y.Long?(n.blocksizes[s]=Y.Long.fromValue(t.blocksizes[s])).unsigned=!0:typeof t.blocksizes[s]=="string"?n.blocksizes[s]=parseInt(t.blocksizes[s],10):typeof t.blocksizes[s]=="number"?n.blocksizes[s]=t.blocksizes[s]:typeof t.blocksizes[s]=="object"&&(n.blocksizes[s]=new Y.LongBits(t.blocksizes[s].low>>>0,t.blocksizes[s].high>>>0).toNumber(!0))}if(t.hashType!=null&&(Y.Long?(n.hashType=Y.Long.fromValue(t.hashType)).unsigned=!0:typeof t.hashType=="string"?n.hashType=parseInt(t.hashType,10):typeof t.hashType=="number"?n.hashType=t.hashType:typeof t.hashType=="object"&&(n.hashType=new Y.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0))),t.fanout!=null&&(Y.Long?(n.fanout=Y.Long.fromValue(t.fanout)).unsigned=!0:typeof t.fanout=="string"?n.fanout=parseInt(t.fanout,10):typeof t.fanout=="number"?n.fanout=t.fanout:typeof t.fanout=="object"&&(n.fanout=new Y.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0))),t.mode!=null&&(n.mode=t.mode>>>0),t.mtime!=null){if(typeof t.mtime!="object")throw TypeError(".Data.mtime: object expected");n.mtime=mt.UnixTime.fromObject(t.mtime)}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.blocksizes=[]),n.defaults){if(s.Type=n.enums===String?"Raw":0,n.bytes===String?s.Data="":(s.Data=[],n.bytes!==Array&&(s.Data=Y.newBuffer(s.Data))),Y.Long){var i=new Y.Long(0,0,!0);s.filesize=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.filesize=n.longs===String?"0":0;if(Y.Long){var i=new Y.Long(0,0,!0);s.hashType=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.hashType=n.longs===String?"0":0;if(Y.Long){var i=new Y.Long(0,0,!0);s.fanout=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.fanout=n.longs===String?"0":0;s.mode=0,s.mtime=null}if(t.Type!=null&&t.hasOwnProperty("Type")&&(s.Type=n.enums===String?mt.Data.DataType[t.Type]:t.Type),t.Data!=null&&t.hasOwnProperty("Data")&&(s.Data=n.bytes===String?Y.base64.encode(t.Data,0,t.Data.length):n.bytes===Array?Array.prototype.slice.call(t.Data):t.Data),t.filesize!=null&&t.hasOwnProperty("filesize")&&(typeof t.filesize=="number"?s.filesize=n.longs===String?String(t.filesize):t.filesize:s.filesize=n.longs===String?Y.Long.prototype.toString.call(t.filesize):n.longs===Number?new Y.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0):t.filesize),t.blocksizes&&t.blocksizes.length){s.blocksizes=[];for(var o=0;o<t.blocksizes.length;++o)typeof t.blocksizes[o]=="number"?s.blocksizes[o]=n.longs===String?String(t.blocksizes[o]):t.blocksizes[o]:s.blocksizes[o]=n.longs===String?Y.Long.prototype.toString.call(t.blocksizes[o]):n.longs===Number?new Y.LongBits(t.blocksizes[o].low>>>0,t.blocksizes[o].high>>>0).toNumber(!0):t.blocksizes[o]}return t.hashType!=null&&t.hasOwnProperty("hashType")&&(typeof t.hashType=="number"?s.hashType=n.longs===String?String(t.hashType):t.hashType:s.hashType=n.longs===String?Y.Long.prototype.toString.call(t.hashType):n.longs===Number?new Y.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0):t.hashType),t.fanout!=null&&t.hasOwnProperty("fanout")&&(typeof t.fanout=="number"?s.fanout=n.longs===String?String(t.fanout):t.fanout:s.fanout=n.longs===String?Y.Long.prototype.toString.call(t.fanout):n.longs===Number?new Y.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0):t.fanout),t.mode!=null&&t.hasOwnProperty("mode")&&(s.mode=t.mode),t.mtime!=null&&t.hasOwnProperty("mtime")&&(s.mtime=mt.UnixTime.toObject(t.mtime,n)),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),r})();mt.UnixTime=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.Seconds=Y.Long?Y.Long.fromBits(0,0,!1):0,r.prototype.FractionalNanoseconds=0,r.encode=function(t,n){return n||(n=I0.create()),n.uint32(8).int64(t.Seconds),t.FractionalNanoseconds!=null&&Object.hasOwnProperty.call(t,"FractionalNanoseconds")&&n.uint32(21).fixed32(t.FractionalNanoseconds),n},r.decode=function(t,n){t instanceof qi||(t=qi.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new mt.UnixTime;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(o&7);break}}if(!i.hasOwnProperty("Seconds"))throw Y.ProtocolError("missing required 'Seconds'",{instance:i});return i},r.fromObject=function(t){if(t instanceof mt.UnixTime)return t;var n=new mt.UnixTime;return t.Seconds!=null&&(Y.Long?(n.Seconds=Y.Long.fromValue(t.Seconds)).unsigned=!1:typeof t.Seconds=="string"?n.Seconds=parseInt(t.Seconds,10):typeof t.Seconds=="number"?n.Seconds=t.Seconds:typeof t.Seconds=="object"&&(n.Seconds=new Y.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber())),t.FractionalNanoseconds!=null&&(n.FractionalNanoseconds=t.FractionalNanoseconds>>>0),n},r.toObject=function(t,n){n||(n={});var s={};if(n.defaults){if(Y.Long){var i=new Y.Long(0,0,!1);s.Seconds=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.Seconds=n.longs===String?"0":0;s.FractionalNanoseconds=0}return t.Seconds!=null&&t.hasOwnProperty("Seconds")&&(typeof t.Seconds=="number"?s.Seconds=n.longs===String?String(t.Seconds):t.Seconds:s.Seconds=n.longs===String?Y.Long.prototype.toString.call(t.Seconds):n.longs===Number?new Y.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber():t.Seconds),t.FractionalNanoseconds!=null&&t.hasOwnProperty("FractionalNanoseconds")&&(s.FractionalNanoseconds=t.FractionalNanoseconds),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();mt.Metadata=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.MimeType="",r.encode=function(t,n){return n||(n=I0.create()),t.MimeType!=null&&Object.hasOwnProperty.call(t,"MimeType")&&n.uint32(10).string(t.MimeType),n},r.decode=function(t,n){t instanceof qi||(t=qi.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new mt.Metadata;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof mt.Metadata)return t;var n=new mt.Metadata;return t.MimeType!=null&&(n.MimeType=String(t.MimeType)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(s.MimeType=""),t.MimeType!=null&&t.hasOwnProperty("MimeType")&&(s.MimeType=t.MimeType),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();const sn=NE,vp=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],xE=["directory","hamt-sharded-directory"],Sp=parseInt("0644",8),Rp=parseInt("0755",8);function Ni(r){if(r!=null)return typeof r=="number"?r&4095:(r=r.toString(),r.substring(0,1)==="0"?parseInt(r,8)&4095:parseInt(r,10)&4095)}function Aa(r){if(r==null)return;let e;if(r.secs!=null&&(e={secs:r.secs,nsecs:r.nsecs}),r.Seconds!=null&&(e={secs:r.Seconds,nsecs:r.FractionalNanoseconds}),Array.isArray(r)&&(e={secs:r[0],nsecs:r[1]}),r instanceof Date){const t=r.getTime(),n=Math.floor(t/1e3);e={secs:n,nsecs:(t-n*1e3)*1e3}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(e!=null&&e.nsecs!=null&&(e.nsecs<0||e.nsecs>999999999))throw E(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}class Ce{static unmarshal(e){const t=sn.decode(e),n=sn.toObject(t,{defaults:!1,arrays:!0,longs:Number,objects:!1}),s=new Ce({type:vp[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return s._originalMode=n.mode||0,s}constructor(e={type:"file"}){const{type:t,data:n,blockSizes:s,hashType:i,fanout:o,mtime:a,mode:c}=e;if(t&&!vp.includes(t))throw E(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE");this.type=t||"file",this.data=n,this.hashType=i,this.fanout=o,this.blockSizes=s||[],this._originalMode=0,this.mode=Ni(c),a&&(this.mtime=Aa(a),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(e){this._mode=this.isDirectory()?Rp:Sp;const t=Ni(e);t!==void 0&&(this._mode=t)}get mode(){return this._mode}isDirectory(){return Boolean(this.type&&xE.includes(this.type))}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0;let e=0;return this.blockSizes.forEach(t=>{e+=t}),this.data&&(e+=this.data.length),e}marshal(){let e;switch(this.type){case"raw":e=sn.DataType.Raw;break;case"directory":e=sn.DataType.Directory;break;case"file":e=sn.DataType.File;break;case"metadata":e=sn.DataType.Metadata;break;case"symlink":e=sn.DataType.Symlink;break;case"hamt-sharded-directory":e=sn.DataType.HAMTShard;break;default:throw E(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE")}let t=this.data;(!this.data||!this.data.length)&&(t=void 0);let n;this.mode!=null&&(n=this._originalMode&4294963200|(Ni(this.mode)||0),n===Sp&&!this.isDirectory()&&(n=void 0),n===Rp&&this.isDirectory()&&(n=void 0));let s;if(this.mtime!=null){const o=Aa(this.mtime);o&&(s={Seconds:o.secs,FractionalNanoseconds:o.nsecs},s.FractionalNanoseconds===0&&delete s.FractionalNanoseconds)}const i={Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:n,mtime:s};return sn.encode(i).finish()}}var $E=b6,Ip=128,LE=127,ME=~LE,UE=Math.pow(2,31);function b6(r,e,t){e=e||[],t=t||0;for(var n=t;r>=UE;)e[t++]=r&255|Ip,r/=128;for(;r&ME;)e[t++]=r&255|Ip,r>>>=7;return e[t]=r|0,b6.bytes=t-n+1,e}var BE=gf,zE=128,Ap=127;function gf(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw gf.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Ap)<<s:(o&Ap)*Math.pow(2,s),s+=7}while(o>=zE);return gf.bytes=i-n,t}var FE=Math.pow(2,7),VE=Math.pow(2,14),jE=Math.pow(2,21),KE=Math.pow(2,28),qE=Math.pow(2,35),HE=Math.pow(2,42),GE=Math.pow(2,49),WE=Math.pow(2,56),YE=Math.pow(2,63),QE=function(r){return r<FE?1:r<VE?2:r<jE?3:r<KE?4:r<qE?5:r<HE?6:r<GE?7:r<WE?8:r<YE?9:10},JE={encode:$E,decode:BE,encodingLength:QE},ml=JE;const yf=(r,e=0)=>[ml.decode(r,e),ml.decode.bytes],bl=(r,e,t=0)=>(ml.encode(r,e,t),e),El=r=>ml.encodingLength(r),XE=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},A0=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},ZE=(r,e)=>{const t=e.byteLength,n=El(r),s=n+El(t),i=new Uint8Array(s+t);return bl(r,i,0),bl(t,i,n),i.set(e,s),new C0(r,t,e,i)},e_=r=>{const e=A0(r),[t,n]=yf(e),[s,i]=yf(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new C0(t,s,o,e)},t_=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&XE(r.bytes,t.bytes)}};let C0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function r_(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var n_=r_,s_=n_;let i_=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},o_=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return E6(this,e)}},a_=class{constructor(e){this.decoders=e}or(e){return E6(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const E6=(r,e)=>new a_({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let c_=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new i_(e,t,n),this.decoder=new o_(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const _6=({name:r,prefix:e,encode:t,decode:n})=>new c_(r,e,t,n),v6=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=s_(t,e);return _6({prefix:r,name:e,encode:n,decode:i=>A0(s(i))})},l_=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},u_=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Rn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>_6({prefix:e,name:r,encode(s){return u_(s,n,t)},decode(s){return l_(s,n,t,r)}}),Jn=v6({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});v6({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Wc=Rn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Rn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Rn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Rn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Rn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Rn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Rn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Rn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Rn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Cp=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return h_(t,wf(r),e||Jn.encoder);default:return f_(t,wf(r),e||Wc.encoder)}},Tp=new WeakMap,wf=r=>{const e=Tp.get(r);if(e==null){const t=new Map;return Tp.set(r,t),t}return e};let Je=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Eo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==p_)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Je.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=ZE(e,t);return Je.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Je.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&t_(e.multihash,n.multihash)}toString(e){return Cp(this,e)}toJSON(){return{"/":Cp(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Je)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Je(n,s,i,o||Dp(n,s,i.bytes))}else if(t[g_]===!0){const{version:n,multihash:s,code:i}=t,o=e_(s);return Je.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Eo)throw new Error(`Version 0 CID must use dag-pb (code: ${Eo}) block encoding`);return new Je(e,t,n,n.bytes)}case 1:{const s=Dp(e,t,n.bytes);return new Je(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Je.create(0,Eo,e)}static createV1(e,t){return Je.create(1,e,t)}static decode(e){const[t,n]=Je.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Je.inspectBytes(e),n=t.size-t.multihashSize,s=A0(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new C0(t.multihashCode,t.digestSize,i,s);return[t.version===0?Je.createV0(o):Je.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=yf(e.subarray(t));return t+=f,d};let s=n(),i=Eo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=d_(e,t),i=Je.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return wf(i).set(n,e),i}};const d_=(r,e)=>{switch(r[0]){case"Q":{const t=e||Jn;return[Jn.prefix,t.decode(`${Jn.prefix}${r}`)]}case Jn.prefix:{const t=e||Jn;return[Jn.prefix,t.decode(r)]}case Wc.prefix:{const t=e||Wc;return[Wc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},h_=(r,e,t)=>{const{prefix:n}=t;if(n!==Jn.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},f_=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Eo=112,p_=18,Dp=(r,e,t)=>{const n=El(r),s=n+El(e),i=new Uint8Array(s+t.byteLength);return bl(r,i,0),bl(e,i,n),i.set(t,s),i},g_=Symbol.for("@ipld/js-cid/CID"),y_=new TextDecoder;function T0(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");const s=r[e++];if(t+=n<28?(s&127)<<n:(s&127)*2**n,s<128)break}return[t,e]}function _l(r,e){let t;[t,e]=T0(r,e);const n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function S6(r,e){let t;return[t,e]=T0(r,e),[t&7,t>>3,e]}function w_(r){const e={},t=r.length;let n=0;for(;n<t;){let s,i;if([s,i,n]=S6(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=_l(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=_l(r,n),e.Name=y_.decode(o)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(s!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Tsize`);[e.Tsize,n]=T0(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function m_(r){const e=r.length;let t=0,n,s=!1,i;for(;t<e;){let a,c;if([a,c,t]=S6(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=_l(r,t),n&&(s=!0)}else if(c===2){if(s)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let u;[u,t]=_l(r,t),n.push(w_(u))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return i&&(o.Data=i),o.Links=n||[],o}const R6=new TextEncoder,Pp=2**32,b_=2**31;function E_(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=ha(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){const n=R6.encode(r.Name);t-=n.length,e.set(n,t),t=ha(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=ha(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function __(r){const e=S_(r),t=new Uint8Array(e);let n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=ha(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let s=r.Links.length-1;s>=0;s--){const i=E_(r.Links[s],t.subarray(0,n));n-=i,n=ha(t,n,i)-1,t[n]=18}return t}function v_(r){let e=0;if(r.Hash){const t=r.Hash.length;e+=1+t+xi(t)}if(typeof r.Name=="string"){const t=R6.encode(r.Name).length;e+=1+t+xi(t)}return typeof r.Tsize=="number"&&(e+=1+xi(r.Tsize)),e}function S_(r){let e=0;if(r.Data){const t=r.Data.length;e+=1+t+xi(t)}if(r.Links)for(const t of r.Links){const n=v_(t);e+=1+n+xi(n)}return e}function ha(r,e,t){e-=xi(t);const n=e;for(;t>=b_;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function xi(r){return r%2===0&&r++,Math.floor((R_(r)+6)/7)}function R_(r){let e=0;return r>=Pp&&(r=Math.floor(r/Pp),e=32),r>=1<<16&&(r>>>=16,e+=16),r>=1<<8&&(r>>>=8,e+=8),e+I_[r]}const I_=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],A_=["Data","Links"],C_=["Hash","Name","Tsize"],mf=new TextEncoder;function I6(r,e){if(r===e)return 0;const t=r.Name?mf.encode(r.Name):[],n=e.Name?mf.encode(e.Name):[];let s=t.length,i=n.length;for(let o=0,a=Math.min(s,i);o<a;++o)if(t[o]!==n[o]){s=t[o],i=n[o];break}return s<i?-1:i<s?1:0}function kp(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function A6(r){if(typeof r.asCID=="object"){const t=Je.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Hash){let t=Je.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=Je.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=Je.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function Wr(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=mf.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(A6),e.Links.sort(I6);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function C6(r){if(!r||typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");if(!kp(r,A_))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be a Uint8Array)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be an array)");for(let e=0;e<r.Links.length;e++){const t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t))throw new TypeError("Invalid DAG-PB form (bad link object)");if(!kp(t,C_))throw new TypeError("Invalid DAG-PB form (extraneous properties on link object)");if(!t.Hash)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash.asCID!==t.Hash)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0&&(typeof t.Tsize!="number"||t.Tsize%1!==0))throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(e>0&&I6(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function T_(r,e=[]){return Wr({Data:r,Links:e})}function D_(r,e,t){return A6({Hash:t,Name:r,Tsize:e})}const P_="dag-pb",Ne=112;function Re(r){C6(r);const e={};return r.Links&&(e.Links=r.Links.map(t=>{const n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),__(e)}function Ke(r){const e=m_(r),t={};return e.Data&&(t.Data=e.Data),e.Links&&(t.Links=e.Links.map(n=>{const s={};try{s.Hash=Je.decode(n.Hash)}catch{}if(!s.Hash)throw new Error("Invalid Hash field found in link, expected CID");return n.Name!==void 0&&(s.Name=n.Name),n.Tsize!==void 0&&(s.Tsize=n.Tsize),s})),t}const ks=Object.freeze(Object.defineProperty({__proto__:null,code:Ne,createLink:D_,createNode:T_,decode:Ke,encode:Re,name:P_,prepare:Wr,validate:C6},Symbol.toStringTag,{value:"Module"}));var k_=T6,Op=128,O_=127,N_=~O_,x_=Math.pow(2,31);function T6(r,e,t){e=e||[],t=t||0;for(var n=t;r>=x_;)e[t++]=r&255|Op,r/=128;for(;r&N_;)e[t++]=r&255|Op,r>>>=7;return e[t]=r|0,T6.bytes=t-n+1,e}var $_=bf,L_=128,Np=127;function bf(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw bf.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Np)<<s:(o&Np)*Math.pow(2,s),s+=7}while(o>=L_);return bf.bytes=i-n,t}var M_=Math.pow(2,7),U_=Math.pow(2,14),B_=Math.pow(2,21),z_=Math.pow(2,28),F_=Math.pow(2,35),V_=Math.pow(2,42),j_=Math.pow(2,49),K_=Math.pow(2,56),q_=Math.pow(2,63),H_=function(r){return r<M_?1:r<U_?2:r<B_?3:r<z_?4:r<F_?5:r<V_?6:r<j_?7:r<K_?8:r<q_?9:10},G_={encode:k_,decode:$_,encodingLength:H_},vl=G_;const Ef=(r,e=0)=>[vl.decode(r,e),vl.decode.bytes],Sl=(r,e,t=0)=>(vl.encode(r,e,t),e),Rl=r=>vl.encodingLength(r),W_=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},D0=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Y_=(r,e)=>{const t=e.byteLength,n=Rl(r),s=n+Rl(t),i=new Uint8Array(s+t);return Sl(r,i,0),Sl(t,i,n),i.set(e,s),new P0(r,t,e,i)},Q_=r=>{const e=D0(r),[t,n]=Ef(e),[s,i]=Ef(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new P0(t,s,o,e)},J_=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&W_(r.bytes,t.bytes)}};let P0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function X_(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Z_=X_,ev=Z_;let tv=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},rv=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return D6(this,e)}},nv=class{constructor(e){this.decoders=e}or(e){return D6(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const D6=(r,e)=>new nv({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let sv=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new tv(e,t,n),this.decoder=new rv(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const P6=({name:r,prefix:e,encode:t,decode:n})=>new sv(r,e,t,n),k6=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=ev(t,e);return P6({prefix:r,name:e,encode:n,decode:i=>D0(s(i))})},iv=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},ov=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},In=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>P6({prefix:e,name:r,encode(s){return ov(s,n,t)},decode(s){return iv(s,n,t,r)}}),Xn=k6({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});k6({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Yc=In({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});In({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});In({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});In({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});In({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});In({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});In({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});In({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});In({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const xp=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return cv(t,_f(r),e||Xn.encoder);default:return lv(t,_f(r),e||Yc.encoder)}},$p=new WeakMap,_f=r=>{const e=$p.get(r);if(e==null){const t=new Map;return $p.set(r,t),t}return e};let ft=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==_o)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==uv)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ft.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Y_(e,t);return ft.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ft.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&J_(e.multihash,n.multihash)}toString(e){return xp(this,e)}toJSON(){return{"/":xp(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ft)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new ft(n,s,i,o||Lp(n,s,i.bytes))}else if(t[dv]===!0){const{version:n,multihash:s,code:i}=t,o=Q_(s);return ft.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==_o)throw new Error(`Version 0 CID must use dag-pb (code: ${_o}) block encoding`);return new ft(e,t,n,n.bytes)}case 1:{const s=Lp(e,t,n.bytes);return new ft(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return ft.create(0,_o,e)}static createV1(e,t){return ft.create(1,e,t)}static decode(e){const[t,n]=ft.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ft.inspectBytes(e),n=t.size-t.multihashSize,s=D0(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new P0(t.multihashCode,t.digestSize,i,s);return[t.version===0?ft.createV0(o):ft.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Ef(e.subarray(t));return t+=f,d};let s=n(),i=_o;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=av(e,t),i=ft.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return _f(i).set(n,e),i}};const av=(r,e)=>{switch(r[0]){case"Q":{const t=e||Xn;return[Xn.prefix,t.decode(`${Xn.prefix}${r}`)]}case Xn.prefix:{const t=e||Xn;return[Xn.prefix,t.decode(r)]}case Yc.prefix:{const t=e||Yc;return[Yc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},cv=(r,e,t)=>{const{prefix:n}=t;if(n!==Xn.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},lv=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},_o=112,uv=18,Lp=(r,e,t)=>{const n=Rl(r),s=n+Rl(e),i=new Uint8Array(s+t.byteLength);return Sl(r,i,0),Sl(e,i,n),i.set(t,s),i},dv=Symbol.for("@ipld/js-cid/CID"),O6=42;function hv(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=ft.asCID(r);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new ue(K.tag,O6),new ue(K.bytes,t)]}function fv(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function pv(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const gv={float64:!0,typeEncoders:{Object:hv,undefined:fv,number:pv}};function yv(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return ft.decode(r.subarray(1))}const N6={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,tags:[]};N6.tags[O6]=yv;const wv="dag-cbor",k0=113,x6=r=>Xs(r,gv),O0=r=>Ir(r,N6),$6=Object.freeze(Object.defineProperty({__proto__:null,code:k0,decode:O0,encode:x6,name:wv},Symbol.toStringTag,{value:"Module"}));var mv=L6,Mp=128,bv=127,Ev=~bv,_v=Math.pow(2,31);function L6(r,e,t){e=e||[],t=t||0;for(var n=t;r>=_v;)e[t++]=r&255|Mp,r/=128;for(;r&Ev;)e[t++]=r&255|Mp,r>>>=7;return e[t]=r|0,L6.bytes=t-n+1,e}var vv=vf,Sv=128,Up=127;function vf(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw vf.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Up)<<s:(o&Up)*Math.pow(2,s),s+=7}while(o>=Sv);return vf.bytes=i-n,t}var Rv=Math.pow(2,7),Iv=Math.pow(2,14),Av=Math.pow(2,21),Cv=Math.pow(2,28),Tv=Math.pow(2,35),Dv=Math.pow(2,42),Pv=Math.pow(2,49),kv=Math.pow(2,56),Ov=Math.pow(2,63),Nv=function(r){return r<Rv?1:r<Iv?2:r<Av?3:r<Cv?4:r<Tv?5:r<Dv?6:r<Pv?7:r<kv?8:r<Ov?9:10},xv={encode:mv,decode:vv,encodingLength:Nv},Il=xv;const Sf=(r,e=0)=>[Il.decode(r,e),Il.decode.bytes],Al=(r,e,t=0)=>(Il.encode(r,e,t),e),Cl=r=>Il.encodingLength(r),$v=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},N0=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Lv=(r,e)=>{const t=e.byteLength,n=Cl(r),s=n+Cl(t),i=new Uint8Array(s+t);return Al(r,i,0),Al(t,i,n),i.set(e,s),new x0(r,t,e,i)},Mv=r=>{const e=N0(r),[t,n]=Sf(e),[s,i]=Sf(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new x0(t,s,o,e)},Uv=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&$v(r.bytes,t.bytes)}};let x0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function Bv(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var zv=Bv,Fv=zv;let Vv=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},jv=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return M6(this,e)}},Kv=class{constructor(e){this.decoders=e}or(e){return M6(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const M6=(r,e)=>new Kv({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let qv=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Vv(e,t,n),this.decoder=new jv(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const U6=({name:r,prefix:e,encode:t,decode:n})=>new qv(r,e,t,n),B6=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Fv(t,e);return U6({prefix:r,name:e,encode:n,decode:i=>N0(s(i))})},Hv=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Gv=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Zt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>U6({prefix:e,name:r,encode(s){return Gv(s,n,t)},decode(s){return Hv(s,n,t,r)}}),Zn=B6({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});B6({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Qc=Zt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Zt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Zt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Zt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Zt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Zt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Zt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Zt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Zt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Bp=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Yv(t,Rf(r),e||Zn.encoder);default:return Qv(t,Rf(r),e||Qc.encoder)}},zp=new WeakMap,Rf=r=>{const e=zp.get(r);if(e==null){const t=new Map;return zp.set(r,t),t}return e};let pt=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==vo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Jv)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return pt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Lv(e,t);return pt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return pt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Uv(e.multihash,n.multihash)}toString(e){return Bp(this,e)}toJSON(){return{"/":Bp(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof pt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new pt(n,s,i,o||Fp(n,s,i.bytes))}else if(t[Xv]===!0){const{version:n,multihash:s,code:i}=t,o=Mv(s);return pt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==vo)throw new Error(`Version 0 CID must use dag-pb (code: ${vo}) block encoding`);return new pt(e,t,n,n.bytes)}case 1:{const s=Fp(e,t,n.bytes);return new pt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return pt.create(0,vo,e)}static createV1(e,t){return pt.create(1,e,t)}static decode(e){const[t,n]=pt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=pt.inspectBytes(e),n=t.size-t.multihashSize,s=N0(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new x0(t.multihashCode,t.digestSize,i,s);return[t.version===0?pt.createV0(o):pt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Sf(e.subarray(t));return t+=f,d};let s=n(),i=vo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Wv(e,t),i=pt.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Rf(i).set(n,e),i}};const Wv=(r,e)=>{switch(r[0]){case"Q":{const t=e||Zn;return[Zn.prefix,t.decode(`${Zn.prefix}${r}`)]}case Zn.prefix:{const t=e||Zn;return[Zn.prefix,t.decode(r)]}case Qc.prefix:{const t=e||Qc;return[Qc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Yv=(r,e,t)=>{const{prefix:n}=t;if(n!==Zn.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Qv=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},vo=112,Jv=18,Fp=(r,e,t)=>{const n=Cl(r),s=n+Cl(e),i=new Uint8Array(s+t.byteLength);return Al(r,i,0),Al(e,i,n),i.set(t,s),i},Xv=Symbol.for("@ipld/js-cid/CID"),z6=Zt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});Zt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});Zt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});Zt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});class Zv extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===K.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===K.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[K.uint.major](e,t){this.prefix(e);const n=String(t.value),s=[];for(let i=0;i<n.length;i++)s[i]=n.charCodeAt(i);e.push(s)}[K.negint.major](e,t){this[K.uint.major](e,t)}[K.bytes.major](e,t){throw new Error(`${ua} unsupported type: Uint8Array`)}[K.string.major](e,t){this.prefix(e);const n=K9(JSON.stringify(t.value));e.push(n.length>32?q9(n):n)}[K.array.major](e,t){this.prefix(e),this.inRecursive.push({type:K.array,elements:0}),e.push([91])}[K.map.major](e,t){this.prefix(e),this.inRecursive.push({type:K.map,elements:0}),e.push([123])}[K.tag.major](e,t){}[K.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===K.array)e.push([93]);else if(o.type===K.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${ua} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),s=[];let i=!1;for(let o=0;o<n.length;o++)s[o]=n.charCodeAt(o),!i&&(s[o]===46||s[o]===101||s[o]===69)&&(i=!0);i||(s.push(46),s.push(48)),e.push(s)}}function eS(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${ua} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==K.string||n.type!==K.string)throw new Error(`${ua} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${ua} unexpected duplicate map keys, this is not supported`)}const tS={addBreakTokens:!0,mapSorter:eS};function rS(r,e){return e=Object.assign({},tS,e),H9(r,new Zv,e)}class F6{constructor(e,t={}){this.pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}done(){return this.pos>=this.data.length}ch(){return this.data[this.pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this.pos]}expect(e){if(this.data.length-this.pos<e.length)throw new Error(`${dt} unexpected end of input at position ${this.pos}`);for(let t=0;t<e.length;t++)if(this.data[this.pos++]!==e[t])throw new Error(`${dt} unexpected token at position ${this.pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this.pos;let t=!1,n=!1;const s=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this.pos++;else break}};if(this.ch()===45&&(t=!0,this.pos++),this.ch()===48)if(this.pos++,this.ch()===46)this.pos++,n=!0;else return new ue(K.uint,0,this.pos-e);if(s([48,49,50,51,52,53,54,55,56,57]),t&&this.pos===e+1)throw new Error(`${dt} unexpected token at position ${this.pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${dt} unexpected token at position ${this.pos}`);n=!0,this.pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this.pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this.pos++,s([48,49,50,51,52,53,54,55,56,57]));const i=String.fromCharCode.apply(null,this.data.subarray(e,this.pos)),o=parseFloat(i);return n?new ue(K.float,o,this.pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new ue(o>=0?K.uint:K.negint,o,this.pos-e):new ue(o>=0?K.uint:K.negint,BigInt(i),this.pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${dt} unexpected character at position ${this.pos}; this shouldn't happen`);this.pos++;for(let i=this.pos,o=0;i<this.data.length&&o<65536;i++,o++){const a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this.pos,i));return this.pos=i+1,new ue(K.string,c,o)}}const e=this.pos,t=[],n=()=>{if(this.pos+4>=this.data.length)throw new Error(`${dt} unexpected end of unicode escape sequence at position ${this.pos}`);let i=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${dt} unexpected unicode escape character at position ${this.pos}`);i=i*16+a,this.pos++}return i},s=()=>{const i=this.ch();let o=null,a=i>239?4:i>223?3:i>191?2:1;if(this.pos+a>this.data.length)throw new Error(`${dt} unexpected unicode sequence at position ${this.pos}`);let c,u,l,d;switch(a){case 1:i<128&&(o=i);break;case 2:c=this.data[this.pos+1],(c&192)===128&&(d=(i&31)<<6|c&63,d>127&&(o=d));break;case 3:c=this.data[this.pos+1],u=this.data[this.pos+2],(c&192)===128&&(u&192)===128&&(d=(i&15)<<12|(c&63)<<6|u&63,d>2047&&(d<55296||d>57343)&&(o=d));break;case 4:c=this.data[this.pos+1],u=this.data[this.pos+2],l=this.data[this.pos+3],(c&192)===128&&(u&192)===128&&(l&192)===128&&(d=(i&15)<<18|(c&63)<<12|(u&63)<<6|l&63,d>65535&&d<1114112&&(o=d))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this.pos+=a};for(;!this.done();){const i=this.ch();let o;switch(i){case 92:if(this.pos++,this.done())throw new Error(`${dt} unexpected string termination at position ${this.pos}`);switch(o=this.ch(),this.pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${dt} unexpected string escape character at position ${this.pos}`)}break;case 34:return this.pos++,new ue(K.string,G9(t),this.pos-e);default:if(i<32)throw new Error(`${dt} invalid control character at position ${this.pos}`);i<128?(t.push(i),this.pos++):s()}}throw new Error(`${dt} unexpected end of string at position ${this.pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this.pos++,new ue(K.map,1/0,1);case 91:return this.modeStack.push("array-start"),this.pos++,new ue(K.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new ue(K.null,null,4);case 102:return this.expect([102,97,108,115,101]),new ue(K.false,!1,5);case 116:return this.expect([116,114,117,101]),new ue(K.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${dt} unexpected character at position ${this.pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this.pos++,this.skipWhitespace(),new ue(K.break,void 0,1);if(this.ch()!==44)throw new Error(`${dt} unexpected character at position ${this.pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this.pos++,this.skipWhitespace(),new ue(K.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this.pos++,this.skipWhitespace(),new ue(K.break,void 0,1);if(this.ch()!==44)throw new Error(`${dt} unexpected character at position ${this.pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this.pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this.pos++,this.skipWhitespace(),new ue(K.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${dt} unexpected character at position ${this.pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${dt} unexpected parse state at position ${this.pos}; this shouldn't happen`)}}}function nS(r,e){return e=Object.assign({tokenizer:new F6(r,e)},e),Ir(r,e)}function sS(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=pt.asCID(r);if(!e)return null;const t=e.toString();return[new ue(K.map,1/0,1),new ue(K.string,"/",1),new ue(K.string,t,t.length),new ue(K.break,void 0,1)]}function Vp(r){const e=z6.encode(r).slice(1);return[new ue(K.map,1/0,1),new ue(K.string,"/",1),new ue(K.map,1/0,1),new ue(K.string,"bytes",5),new ue(K.string,e,e.length),new ue(K.break,void 0,1),new ue(K.break,void 0,1)]}function iS(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function oS(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const aS={typeEncoders:{Object:sS,Uint8Array:Vp,Buffer:Vp,undefined:iS,number:oS}};class cS extends F6{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===K.map){const t=this._next();if(t.type===K.string&&t.value==="/"){const n=this._next();if(n.type===K.string){if(this._next().type!==K.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new ue(K.tag,42,0)}if(n.type===K.map){const s=this._next();if(s.type===K.string&&s.value==="bytes"){const i=this._next();if(i.type===K.string){for(let a=0;a<2;a++)if(this._next().type!==K.break)throw new Error("Invalid encoded Bytes form");const o=z6.decode(`m${i.value}`);return new ue(K.bytes,o,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const If={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,tags:[]};If.tags[42]=pt.parse;const lS="dag-json",V6=297,j6=r=>rS(r,aS),K6=r=>{const e=Object.assign(If,{tokenizer:new cS(r,If)});return nS(r,e)},jp=r=>uS.decode(j6(r)),uS=new TextDecoder,dS=r=>K6(hS.encode(r)),hS=new TextEncoder,q6=Object.freeze(Object.defineProperty({__proto__:null,code:V6,decode:K6,encode:j6,format:jp,name:lS,parse:dS,stringify:jp},Symbol.toStringTag,{value:"Module"}));function fS(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var pS=fS,gS=pS;const yS=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},$0=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let wS=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},mS=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return H6(this,e)}},bS=class{constructor(e){this.decoders=e}or(e){return H6(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const H6=(r,e)=>new bS({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let ES=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new wS(e,t,n),this.decoder=new mS(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const G6=({name:r,prefix:e,encode:t,decode:n})=>new ES(r,e,t,n),W6=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=gS(t,e);return G6({prefix:r,name:e,encode:n,decode:i=>$0(s(i))})},_S=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},vS=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},er=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>G6({prefix:e,name:r,encode(s){return vS(s,n,t)},decode(s){return _S(s,n,t,r)}});er({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});er({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});const Y6=er({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});er({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function mn(r){return Y6.encode(r).slice(1)}function Br(r){return Y6.decode(`u${r}`)}var SS=Q6,Kp=128,RS=127,IS=~RS,AS=Math.pow(2,31);function Q6(r,e,t){e=e||[],t=t||0;for(var n=t;r>=AS;)e[t++]=r&255|Kp,r/=128;for(;r&IS;)e[t++]=r&255|Kp,r>>>=7;return e[t]=r|0,Q6.bytes=t-n+1,e}var CS=Af,TS=128,qp=127;function Af(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Af.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&qp)<<s:(o&qp)*Math.pow(2,s),s+=7}while(o>=TS);return Af.bytes=i-n,t}var DS=Math.pow(2,7),PS=Math.pow(2,14),kS=Math.pow(2,21),OS=Math.pow(2,28),NS=Math.pow(2,35),xS=Math.pow(2,42),$S=Math.pow(2,49),LS=Math.pow(2,56),MS=Math.pow(2,63),US=function(r){return r<DS?1:r<PS?2:r<kS?3:r<OS?4:r<NS?5:r<xS?6:r<$S?7:r<LS?8:r<MS?9:10},BS={encode:SS,decode:CS,encodingLength:US},Tl=BS;const Cf=(r,e=0)=>[Tl.decode(r,e),Tl.decode.bytes],Dl=(r,e,t=0)=>(Tl.encode(r,e,t),e),Pl=r=>Tl.encodingLength(r),zS=(r,e)=>{const t=e.byteLength,n=Pl(r),s=n+Pl(t),i=new Uint8Array(s+t);return Dl(r,i,0),Dl(t,i,n),i.set(e,s),new L0(r,t,e,i)},FS=r=>{const e=$0(r),[t,n]=Cf(e),[s,i]=Cf(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new L0(t,s,o,e)},VS=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&yS(r.bytes,t.bytes)}};let L0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const es=W6({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});W6({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Jc=er({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});er({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});er({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});er({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});er({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});er({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});er({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});er({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});er({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const jS=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return qS(t,Tf(r),e||es.encoder);default:return HS(t,Tf(r),e||Jc.encoder)}},Hp=new WeakMap,Tf=r=>{const e=Hp.get(r);if(e==null){const t=new Map;return Hp.set(r,t),t}return e};let ot=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==So)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==GS)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ot.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=zS(e,t);return ot.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ot.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&VS(e.multihash,n.multihash)}toString(e){return jS(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ot)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new ot(n,s,i,o||Gp(n,s,i.bytes))}else if(t[WS]===!0){const{version:n,multihash:s,code:i}=t,o=FS(s);return ot.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==So)throw new Error(`Version 0 CID must use dag-pb (code: ${So}) block encoding`);return new ot(e,t,n,n.bytes)}case 1:{const s=Gp(e,t,n.bytes);return new ot(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return ot.create(0,So,e)}static createV1(e,t){return ot.create(1,e,t)}static decode(e){const[t,n]=ot.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ot.inspectBytes(e),n=t.size-t.multihashSize,s=$0(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new L0(t.multihashCode,t.digestSize,i,s);return[t.version===0?ot.createV0(o):ot.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Cf(e.subarray(t));return t+=f,d};let s=n(),i=So;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=KS(e,t),i=ot.decode(s);return Tf(i).set(n,e),i}};const KS=(r,e)=>{switch(r[0]){case"Q":{const t=e||es;return[es.prefix,t.decode(`${es.prefix}${r}`)]}case es.prefix:{const t=e||es;return[es.prefix,t.decode(r)]}case Jc.prefix:{const t=e||Jc;return[Jc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},qS=(r,e,t)=>{const{prefix:n}=t;if(n!==es.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},HS=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},So=112,GS=18,Gp=(r,e,t)=>{const n=Pl(r),s=n+Pl(e),i=new Uint8Array(s+t.byteLength);return Dl(r,i,0),Dl(e,i,n),i.set(t,s),i},WS=Symbol.for("@ipld/js-cid/CID");function YS(r){const[e,t,n]=r;return{payload:t,signatures:[{protected:e,signature:n}],link:ot.decode(Br(t))}}function QS(r){const e={signature:Br(r.signature)};return r.header&&(e.header=r.header),r.protected&&(e.protected=Br(r.protected)),e}function JS(r){const e=Br(r.payload);try{ot.decode(e)}catch{throw new Error("Not a valid DagJWS")}return{payload:e,signatures:r.signatures.map(QS)}}function XS(r){const e={signature:mn(r.signature)};return r.header&&(e.header=r.header),r.protected&&(e.protected=mn(r.protected)),e}function ZS(r){const e={payload:mn(r.payload),signatures:r.signatures.map(XS)};return e.link=ot.decode(new Uint8Array(r.payload)),e}function eR(r){const[e,t,n,s,i]=r,o={ciphertext:s,iv:n,protected:e,tag:i};return t&&(o.recipients=[{encrypted_key:t}]),o}function tR(r){const e={};return r.encrypted_key&&(e.encrypted_key=Br(r.encrypted_key)),r.header&&(e.header=r.header),e}function rR(r){const e={ciphertext:Br(r.ciphertext),protected:Br(r.protected),iv:Br(r.iv),tag:Br(r.tag)};return r.aad&&(e.aad=Br(r.aad)),r.recipients&&(e.recipients=r.recipients.map(tR)),r.unprotected&&(e.unprotected=r.unprotected),e}function nR(r){const e={};return r.encrypted_key&&(e.encrypted_key=mn(r.encrypted_key)),r.header&&(e.header=r.header),e}function sR(r){const e={ciphertext:mn(r.ciphertext),protected:mn(r.protected),iv:mn(r.iv),tag:mn(r.tag)};return r.aad&&(e.aad=mn(r.aad)),r.recipients&&(e.recipients=r.recipients.map(nR)),r.unprotected&&(e.unprotected=r.unprotected),e}const iR="dag-jose",oR=133;function J6(r){return"payload"in r&&typeof r.payload=="string"&&"signatures"in r&&Array.isArray(r.signatures)}function aR(r){return"payload"in r&&r.payload instanceof Uint8Array&&"signatures"in r&&Array.isArray(r.signatures)}function cR(r){return"ciphertext"in r&&r.ciphertext instanceof Uint8Array&&"iv"in r&&r.iv instanceof Uint8Array&&"protected"in r&&r.protected instanceof Uint8Array&&"tag"in r&&r.tag instanceof Uint8Array}function X6(r){return"ciphertext"in r&&typeof r.ciphertext=="string"&&"iv"in r&&typeof r.iv=="string"&&"protected"in r&&typeof r.protected=="string"&&"tag"in r&&typeof r.tag=="string"}function Z6(r){if(typeof r=="string"){const e=r.split(".");if(e.length===3)return YS(e);if(e.length===5)return eR(e);throw new Error("Not a valid JOSE string")}if(J6(r)||X6(r))return r;throw new Error("Not a valid unencoded JOSE object")}function lR(r){typeof r=="string"&&(r=Z6(r));let e;if(J6(r))e=JS(r);else if(X6(r))e=rR(r);else throw new Error("Not a valid JOSE object");return new Uint8Array(x6(e))}function uR(r){let e;try{e=O0(r)}catch{throw new Error("Not a valid DAG-JOSE object")}if(aR(e))return ZS(e);if(cR(e))return sR(e);throw new Error("Not a valid DAG-JOSE object")}const e8=Object.freeze(Object.defineProperty({__proto__:null,code:oR,decode:uR,encode:lR,name:iR,toGeneral:Z6},Symbol.toStringTag,{value:"Module"})),dR=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},co=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},hR=r=>new TextEncoder().encode(r),fR=r=>new TextDecoder().decode(r);var pR=t8,Wp=128,gR=127,yR=~gR,wR=Math.pow(2,31);function t8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=wR;)e[t++]=r&255|Wp,r/=128;for(;r&yR;)e[t++]=r&255|Wp,r>>>=7;return e[t]=r|0,t8.bytes=t-n+1,e}var mR=Df,bR=128,Yp=127;function Df(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Df.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Yp)<<s:(o&Yp)*Math.pow(2,s),s+=7}while(o>=bR);return Df.bytes=i-n,t}var ER=Math.pow(2,7),_R=Math.pow(2,14),vR=Math.pow(2,21),SR=Math.pow(2,28),RR=Math.pow(2,35),IR=Math.pow(2,42),AR=Math.pow(2,49),CR=Math.pow(2,56),TR=Math.pow(2,63),DR=function(r){return r<ER?1:r<_R?2:r<vR?3:r<SR?4:r<RR?5:r<IR?6:r<AR?7:r<CR?8:r<TR?9:10},PR={encode:pR,decode:mR,encodingLength:DR},kl=PR;const Pf=(r,e=0)=>[kl.decode(r,e),kl.decode.bytes],Ol=(r,e,t=0)=>(kl.encode(r,e,t),e),Nl=r=>kl.encodingLength(r),xl=(r,e)=>{const t=e.byteLength,n=Nl(r),s=n+Nl(t),i=new Uint8Array(s+t);return Ol(r,i,0),Ol(t,i,n),i.set(e,s),new M0(r,t,e,i)},r8=r=>{const e=co(r),[t,n]=Pf(e),[s,i]=Pf(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new M0(t,s,o,e)},kR=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&dR(r.bytes,t.bytes)}};let M0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const n8=0,OR="identity",s8=co,NR=r=>xl(n8,s8(r)),kf={code:n8,name:OR,encode:s8,digest:NR},xR=Object.freeze(Object.defineProperty({__proto__:null,identity:kf},Symbol.toStringTag,{value:"Module"}));function $R(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var LR=$R,MR=LR;let UR=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},BR=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return i8(this,e)}},zR=class{constructor(e){this.decoders=e}or(e){return i8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const i8=(r,e)=>new zR({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let FR=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new UR(e,t,n),this.decoder=new BR(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const cd=({name:r,prefix:e,encode:t,decode:n})=>new FR(r,e,t,n),ja=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=MR(t,e);return cd({prefix:r,name:e,encode:n,decode:i=>co(s(i))})},VR=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},jR=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},vt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>cd({prefix:e,name:r,encode(s){return jR(s,n,t)},decode(s){return VR(s,n,t,r)}}),KR=cd({prefix:"\0",name:"identity",encode:r=>fR(r),decode:r=>hR(r)}),qR=Object.freeze(Object.defineProperty({__proto__:null,identity:KR},Symbol.toStringTag,{value:"Module"})),HR=vt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),GR=Object.freeze(Object.defineProperty({__proto__:null,base2:HR},Symbol.toStringTag,{value:"Module"})),WR=vt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),YR=Object.freeze(Object.defineProperty({__proto__:null,base8:WR},Symbol.toStringTag,{value:"Module"})),QR=ja({prefix:"9",name:"base10",alphabet:"0123456789"}),JR=Object.freeze(Object.defineProperty({__proto__:null,base10:QR},Symbol.toStringTag,{value:"Module"})),XR=vt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ZR=vt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),eI=Object.freeze(Object.defineProperty({__proto__:null,base16:XR,base16upper:ZR},Symbol.toStringTag,{value:"Module"})),fa=vt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),tI=vt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),rI=vt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),nI=vt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),sI=vt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),iI=vt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),oI=vt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),aI=vt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),cI=vt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),lI=Object.freeze(Object.defineProperty({__proto__:null,base32:fa,base32hex:sI,base32hexpad:oI,base32hexpadupper:aI,base32hexupper:iI,base32pad:rI,base32padupper:nI,base32upper:tI,base32z:cI},Symbol.toStringTag,{value:"Module"})),$l=ja({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),uI=ja({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),dI=Object.freeze(Object.defineProperty({__proto__:null,base36:$l,base36upper:uI},Symbol.toStringTag,{value:"Module"})),Ht=ja({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),hI=ja({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),fI=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Ht,base58flickr:hI},Symbol.toStringTag,{value:"Module"})),pI=vt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),gI=vt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),yI=vt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),wI=vt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),mI=Object.freeze(Object.defineProperty({__proto__:null,base64:pI,base64pad:gI,base64url:yI,base64urlpad:wI},Symbol.toStringTag,{value:"Module"})),o8=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),bI=o8.reduce((r,e,t)=>(r[t]=e,r),[]),EI=o8.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function _I(r){return r.reduce((e,t)=>(e+=bI[t],e),"")}function vI(r){const e=[];for(const t of r){const n=EI[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const SI=cd({prefix:"🚀",name:"base256emoji",encode:_I,decode:vI}),RI=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:SI},Symbol.toStringTag,{value:"Module"})),a8=({name:r,code:e,encode:t})=>new II(r,e,t);let II=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?xl(this.code,t):t.then(n=>xl(this.code,n))}else throw Error("Unknown type, must be binary type")}};const c8=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Hi=a8({name:"sha2-256",code:18,encode:c8("SHA-256")}),AI=a8({name:"sha2-512",code:19,encode:c8("SHA-512")}),CI=Object.freeze(Object.defineProperty({__proto__:null,sha256:Hi,sha512:AI},Symbol.toStringTag,{value:"Module"})),TI="raw",U0=85,DI=r=>co(r),PI=r=>co(r),kI=Object.freeze(Object.defineProperty({__proto__:null,code:U0,decode:PI,encode:DI,name:TI},Symbol.toStringTag,{value:"Module"})),OI=new TextEncoder,NI=new TextDecoder,xI="json",l8=512,$I=r=>OI.encode(JSON.stringify(r)),LI=r=>JSON.parse(NI.decode(r)),MI=Object.freeze(Object.defineProperty({__proto__:null,code:l8,decode:LI,encode:$I,name:xI},Symbol.toStringTag,{value:"Module"})),UI=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return zI(t,Of(r),e||Ht.encoder);default:return FI(t,Of(r),e||fa.encoder)}},Qp=new WeakMap,Of=r=>{const e=Qp.get(r);if(e==null){const t=new Map;return Qp.set(r,t),t}return e};let V=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ro)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==VI)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return V.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=xl(e,t);return V.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return V.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&kR(e.multihash,n.multihash)}toString(e){return UI(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof V)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new V(n,s,i,o||Jp(n,s,i.bytes))}else if(t[jI]===!0){const{version:n,multihash:s,code:i}=t,o=r8(s);return V.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ro)throw new Error(`Version 0 CID must use dag-pb (code: ${Ro}) block encoding`);return new V(e,t,n,n.bytes)}case 1:{const s=Jp(e,t,n.bytes);return new V(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return V.create(0,Ro,e)}static createV1(e,t){return V.create(1,e,t)}static decode(e){const[t,n]=V.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=V.inspectBytes(e),n=t.size-t.multihashSize,s=co(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new M0(t.multihashCode,t.digestSize,i,s);return[t.version===0?V.createV0(o):V.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Pf(e.subarray(t));return t+=f,d};let s=n(),i=Ro;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=BI(e,t),i=V.decode(s);return Of(i).set(n,e),i}};const BI=(r,e)=>{switch(r[0]){case"Q":{const t=e||Ht;return[Ht.prefix,t.decode(`${Ht.prefix}${r}`)]}case Ht.prefix:{const t=e||Ht;return[Ht.prefix,t.decode(r)]}case fa.prefix:{const t=e||fa;return[fa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},zI=(r,e,t)=>{const{prefix:n}=t;if(n!==Ht.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},FI=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Ro=112,VI=18,Jp=(r,e,t)=>{const n=Nl(r),s=n+Nl(e),i=new Uint8Array(s+t.byteLength);return Ol(r,i,0),Ol(e,i,n),i.set(t,s),i},jI=Symbol.for("@ipld/js-cid/CID"),KI={...qR,...GR,...YR,...JR,...eI,...lI,...dI,...fI,...mI,...RI},qI={...CI,...xR},HI={raw:kI,json:MI};class Ka extends Error{constructor(e="not initialized"){super(e),this.name="NotInitializedError",this.code=Ka.code}}Ka.code="ERR_NOT_INITIALIZED";class GI extends Error{constructor(e="cannot initialize an initializing node"){super(e),this.name="AlreadyInitializingError",this.code=Zs.code}}GI.code="ERR_ALREADY_INITIALIZING";class Zs extends Error{constructor(e="cannot re-initialize an initialized node"){super(e),this.name="AlreadyInitializedError",this.code=Zs.code}}Zs.code="ERR_ALREADY_INITIALIZED";class qa extends Error{constructor(e="not started"){super(e),this.name="NotStartedError",this.code=qa.code}}qa.code="ERR_NOT_STARTED";class ld extends Error{constructor(e="cannot start, already startin"){super(e),this.name="AlreadyStartingError",this.code=ld.code}}ld.code="ERR_ALREADY_STARTING";class ud extends Error{constructor(e="cannot start, already started"){super(e),this.name="AlreadyStartedError",this.code=ud.code}}ud.code="ERR_ALREADY_STARTED";class lo extends Error{constructor(e="not enabled"){super(e),this.name="NotEnabledError",this.code=lo.code}}lo.code="ERR_NOT_ENABLED";var WI=function(){return Date.now()};const uc=WI;class YI{constructor(e,t,n){const s=this;this._started=uc(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(uc()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);const t=uc();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=uc(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}}function QI(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new YI(arguments[0],arguments[1],r)}var Gi=QI;const{AbortController:JI}=globalThis,Xp=Gi;class B0 extends JI{constructor(e){super(),this._ms=e,this._timer=Xp(()=>this.abort(),e),Object.setPrototypeOf(this,B0.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=Xp(()=>this.abort(),this._ms)}}var $e={TimeoutController:B0};function XI(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var ZI=XI,eA=ZI;const tA=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},z0=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let rA=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},nA=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return u8(this,e)}},sA=class{constructor(e){this.decoders=e}or(e){return u8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const u8=(r,e)=>new sA({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let iA=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new rA(e,t,n),this.decoder=new nA(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const d8=({name:r,prefix:e,encode:t,decode:n})=>new iA(r,e,t,n),h8=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=eA(t,e);return d8({prefix:r,name:e,encode:n,decode:i=>z0(s(i))})},oA=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},aA=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},An=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>d8({prefix:e,name:r,encode(s){return aA(s,n,t)},decode(s){return oA(s,n,t,r)}}),ts=h8({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});h8({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Xc=An({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});An({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});An({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});An({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});An({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});An({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});An({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});An({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});An({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var cA=f8,Zp=128,lA=127,uA=~lA,dA=Math.pow(2,31);function f8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=dA;)e[t++]=r&255|Zp,r/=128;for(;r&uA;)e[t++]=r&255|Zp,r>>>=7;return e[t]=r|0,f8.bytes=t-n+1,e}var hA=Nf,fA=128,e3=127;function Nf(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Nf.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&e3)<<s:(o&e3)*Math.pow(2,s),s+=7}while(o>=fA);return Nf.bytes=i-n,t}var pA=Math.pow(2,7),gA=Math.pow(2,14),yA=Math.pow(2,21),wA=Math.pow(2,28),mA=Math.pow(2,35),bA=Math.pow(2,42),EA=Math.pow(2,49),_A=Math.pow(2,56),vA=Math.pow(2,63),SA=function(r){return r<pA?1:r<gA?2:r<yA?3:r<wA?4:r<mA?5:r<bA?6:r<EA?7:r<_A?8:r<vA?9:10},RA={encode:cA,decode:hA,encodingLength:SA},Ll=RA;const xf=(r,e=0)=>[Ll.decode(r,e),Ll.decode.bytes],Ml=(r,e,t=0)=>(Ll.encode(r,e,t),e),Ul=r=>Ll.encodingLength(r),IA=(r,e)=>{const t=e.byteLength,n=Ul(r),s=n+Ul(t),i=new Uint8Array(s+t);return Ml(r,i,0),Ml(t,i,n),i.set(e,s),new F0(r,t,e,i)},AA=r=>{const e=z0(r),[t,n]=xf(e),[s,i]=xf(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new F0(t,s,o,e)},CA=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&tA(r.bytes,t.bytes)}};let F0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const TA=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return PA(t,$f(r),e||ts.encoder);default:return kA(t,$f(r),e||Xc.encoder)}},t3=new WeakMap,$f=r=>{const e=t3.get(r);if(e==null){const t=new Map;return t3.set(r,t),t}return e};let at=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Io)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==OA)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return at.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=IA(e,t);return at.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return at.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&CA(e.multihash,n.multihash)}toString(e){return TA(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof at)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new at(n,s,i,o||r3(n,s,i.bytes))}else if(t[NA]===!0){const{version:n,multihash:s,code:i}=t,o=AA(s);return at.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Io)throw new Error(`Version 0 CID must use dag-pb (code: ${Io}) block encoding`);return new at(e,t,n,n.bytes)}case 1:{const s=r3(e,t,n.bytes);return new at(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return at.create(0,Io,e)}static createV1(e,t){return at.create(1,e,t)}static decode(e){const[t,n]=at.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=at.inspectBytes(e),n=t.size-t.multihashSize,s=z0(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new F0(t.multihashCode,t.digestSize,i,s);return[t.version===0?at.createV0(o):at.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=xf(e.subarray(t));return t+=f,d};let s=n(),i=Io;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=DA(e,t),i=at.decode(s);return $f(i).set(n,e),i}};const DA=(r,e)=>{switch(r[0]){case"Q":{const t=e||ts;return[ts.prefix,t.decode(`${ts.prefix}${r}`)]}case ts.prefix:{const t=e||ts;return[ts.prefix,t.decode(r)]}case Xc.prefix:{const t=e||Xc;return[Xc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},PA=(r,e,t)=>{const{prefix:n}=t;if(n!==ts.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},kA=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Io=112,OA=18,r3=(r,e,t)=>{const n=Ul(r),s=n+Ul(e),i=new Uint8Array(s+t.byteLength);return Ml(r,i,0),Ml(e,i,n),i.set(t,s),i},NA=Symbol.for("@ipld/js-cid/CID"),Bl=/^\/(ip[fn]s)\/([^/?#]+)/,p8=1,g8=2,y8=/^https?:\/\/([^/]+)\.(ip[fn]s)\.[^/?]+/,xA=/^(([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])\.)+([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])$/;function V0(r){try{return b8(r)?Boolean(at.parse(r)):r instanceof Uint8Array?Boolean(at.decode(r)):Boolean(at.asCID(r))}catch{return!1}}function w8(r,e,t=p8,n=g8){const s=E8(r);if(s===!1)return!1;const i=s.match(e);if(i==null||i[t]!=="ipfs")return!1;let o=i[n];return o!=null&&e===y8&&(o=o.toLowerCase()),V0(o)}function m8(r,e,t=p8,n=g8){const s=E8(r);if(s===!1)return!1;const i=s.match(e);if(i==null||i[t]!=="ipns")return!1;let o=i[n];if(o!=null&&e===y8){if(o=o.toLowerCase(),V0(o))return!0;try{!o.includes(".")&&o.includes("-")&&(o=o.replace(/--/g,"@").replace(/-/g,".").replace(/@/g,"-"));const{hostname:a}=new W9.URL(`http://${o}`);return xA.test(a)}catch{return!1}}return!0}function b8(r){return typeof r=="string"}function E8(r){return r instanceof Uint8Array?q(r,"base58btc"):b8(r)?r:!1}const _8=r=>w8(r,Bl)||m8(r,Bl),$A=r=>w8(r,Bl),v8=r=>m8(r,Bl),pn="/",S8=new TextEncoder().encode(pn),dc=S8[0];class J{constructor(e,t){if(typeof e=="string")this._buf=M(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==dc)throw new Error("Invalid key")}toString(e="utf8"){return q(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new J(e.join(pn))}static random(){return new J(g6().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new J(e):typeof e.uint8Array=="function"?new J(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=S8),this._buf[0]!==dc){const e=new Uint8Array(this._buf.byteLength+1);e.fill(dc,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===dc;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return J.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(pn).slice(1)}type(){return LA(this.baseNamespace())}name(){return MA(this.baseNamespace())}instance(e){return new J(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(pn)||(e+=pn),e+=this.type(),new J(e)}parent(){const e=this.list();return e.length===1?new J(pn):new J(e.slice(0,-1).join(pn))}child(e){return this.toString()===pn?e:e.toString()===pn?this:new J(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return J.withNamespaces([...this.namespaces(),...UA(e.map(t=>t.namespaces()))])}}function LA(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function MA(r){const e=r.split(":");return e[e.length-1]}function UA(r){return[].concat(...r)}let BA=/(-?(?:\d+\.?\d*|\d*\.?\d+)(?:e[-+]?\d+)?)\s*([\p{L}]*)/uig;ee.nanosecond=ee.ns=1/1e6;ee.µs=ee.μs=ee.us=ee.microsecond=1/1e3;ee.millisecond=ee.ms=ee[""]=1;ee.second=ee.sec=ee.s=ee.ms*1e3;ee.minute=ee.min=ee.m=ee.s*60;ee.hour=ee.hr=ee.h=ee.m*60;ee.day=ee.d=ee.h*24;ee.week=ee.wk=ee.w=ee.d*7;ee.month=ee.b=ee.d*(365.25/12);ee.year=ee.yr=ee.y=ee.d*365.25;function ee(r="",e="ms"){var t=null;return r=(r+"").replace(/(\d)[,_](\d)/g,"$1$2"),r.replace(BA,function(n,s,i){i=n3(i),i&&(t=(t||0)+parseFloat(s,10)*i)}),t&&t/(n3(e)||1)}function n3(r){return ee[r]||ee[r.toLowerCase().replace(/s$/,"")]}let pa=class extends Error{constructor(e="request timed out"){super(e),this.name="TimeoutError",this.code=pa.code}};pa.code="ERR_TIMEOUT";function x(r,e){return(...t)=>{const n=t[e??t.length-1];if(!n||!n.timeout)return r(...t);const s=typeof n.timeout=="string"?ee(n.timeout):n.timeout,i=new $e.TimeoutController(s);n.signal=Jr([n.signal,i.signal]);const o=r(...t),a=new Promise((l,d)=>{i.signal.addEventListener("abort",()=>{d(new pa)})}),c=Date.now(),u=()=>{if(i.signal.aborted)throw new pa;if(Date.now()-c>s)throw i.abort(),new pa};return o[Symbol.asyncIterator]?async function*(){const l=o[Symbol.asyncIterator]();try{for(;;){const{value:d,done:f}=await Promise.race([l.next(),a]);if(f)break;u(),yield d}}catch(d){throw u(),d}finally{i.clear(),l.return&&l.return()}}():(async()=>{try{const l=await Promise.race([o,a]);return u(),l}catch(l){throw u(),l}finally{i.clear()}})()}}var zA=R8,s3=128,FA=127,VA=~FA,jA=Math.pow(2,31);function R8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=jA;)e[t++]=r&255|s3,r/=128;for(;r&VA;)e[t++]=r&255|s3,r>>>=7;return e[t]=r|0,R8.bytes=t-n+1,e}var KA=Lf,qA=128,i3=127;function Lf(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Lf.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&i3)<<s:(o&i3)*Math.pow(2,s),s+=7}while(o>=qA);return Lf.bytes=i-n,t}var HA=Math.pow(2,7),GA=Math.pow(2,14),WA=Math.pow(2,21),YA=Math.pow(2,28),QA=Math.pow(2,35),JA=Math.pow(2,42),XA=Math.pow(2,49),ZA=Math.pow(2,56),eC=Math.pow(2,63),tC=function(r){return r<HA?1:r<GA?2:r<WA?3:r<YA?4:r<QA?5:r<JA?6:r<XA?7:r<ZA?8:r<eC?9:10},rC={encode:zA,decode:KA,encodingLength:tC},zl=rC;const Mf=(r,e=0)=>[zl.decode(r,e),zl.decode.bytes],Fl=(r,e,t=0)=>(zl.encode(r,e,t),e),Vl=r=>zl.encodingLength(r),nC=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},j0=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},sC=(r,e)=>{const t=e.byteLength,n=Vl(r),s=n+Vl(t),i=new Uint8Array(s+t);return Fl(r,i,0),Fl(t,i,n),i.set(e,s),new K0(r,t,e,i)},iC=r=>{const e=j0(r),[t,n]=Mf(e),[s,i]=Mf(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new K0(t,s,o,e)},oC=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&nC(r.bytes,t.bytes)}};let K0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function aC(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var cC=aC,lC=cC;let uC=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},dC=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return I8(this,e)}},hC=class{constructor(e){this.decoders=e}or(e){return I8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const I8=(r,e)=>new hC({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let fC=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new uC(e,t,n),this.decoder=new dC(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const A8=({name:r,prefix:e,encode:t,decode:n})=>new fC(r,e,t,n),C8=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=lC(t,e);return A8({prefix:r,name:e,encode:n,decode:i=>j0(s(i))})},pC=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},gC=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Cn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>A8({prefix:e,name:r,encode(s){return gC(s,n,t)},decode(s){return pC(s,n,t,r)}}),rs=C8({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});C8({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Zc=Cn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Cn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Cn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Cn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Cn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Cn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Cn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Cn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Cn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const yC=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return mC(t,Uf(r),e||rs.encoder);default:return bC(t,Uf(r),e||Zc.encoder)}},o3=new WeakMap,Uf=r=>{const e=o3.get(r);if(e==null){const t=new Map;return o3.set(r,t),t}return e};let je=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ao)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==EC)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return je.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=sC(e,t);return je.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return je.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&oC(e.multihash,n.multihash)}toString(e){return yC(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof je)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new je(n,s,i,o||a3(n,s,i.bytes))}else if(t[_C]===!0){const{version:n,multihash:s,code:i}=t,o=iC(s);return je.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ao)throw new Error(`Version 0 CID must use dag-pb (code: ${Ao}) block encoding`);return new je(e,t,n,n.bytes)}case 1:{const s=a3(e,t,n.bytes);return new je(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return je.create(0,Ao,e)}static createV1(e,t){return je.create(1,e,t)}static decode(e){const[t,n]=je.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=je.inspectBytes(e),n=t.size-t.multihashSize,s=j0(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new K0(t.multihashCode,t.digestSize,i,s);return[t.version===0?je.createV0(o):je.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Mf(e.subarray(t));return t+=f,d};let s=n(),i=Ao;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=wC(e,t),i=je.decode(s);return Uf(i).set(n,e),i}};const wC=(r,e)=>{switch(r[0]){case"Q":{const t=e||rs;return[rs.prefix,t.decode(`${rs.prefix}${r}`)]}case rs.prefix:{const t=e||rs;return[rs.prefix,t.decode(r)]}case Zc.prefix:{const t=e||Zc;return[Zc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},mC=(r,e,t)=>{const{prefix:n}=t;if(n!==rs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},bC=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Ao=112,EC=18,a3=(r,e,t)=>{const n=Vl(r),s=n+Vl(e),i=new Uint8Array(s+t.byteLength);return Fl(r,i,0),Fl(e,i,n),i.set(t,s),i},_C=Symbol.for("@ipld/js-cid/CID"),c3="/ipfs/";function Ha(r){if(r instanceof Uint8Array)try{r=je.decode(r)}catch(s){throw E(s,"ERR_INVALID_CID")}let e=je.asCID(r);if(e)return{cid:e,path:void 0};r=r.toString(),r.startsWith(c3)&&(r=r.substring(c3.length));const t=r.split("/");let n;try{e=je.parse(t.shift()||"")}catch(s){throw E(s,"ERR_INVALID_CID")}return t.length&&(n=`/${t.join("/")}`),{cid:e,path:n}}const vC="ERR_BAD_PATH",T8="This command must be run in online mode. Try running 'ipfs daemon' first.",Bf=new J("/local/filesroot"),zf=262144,SC=r=>{if(V.asCID(r))return`/ipfs/${r}`;const t=r.toString();try{return`/ipfs/${V.parse(t)}`}catch{}if(_8(t))return t;throw E(new Error(`invalid path: ${r}`),vC)},q0=r=>r instanceof Uint8Array?V.decode(r).toString():(r=r.toString(),r.indexOf("/ipfs/")===0&&(r=r.substring(6)),r.charAt(r.length-1)==="/"&&(r=r.substring(0,r.length-1)),r),dd=async function(r,e,t,n={}){const{cid:s,path:i}=Ha(t);i&&(n.path=i);let o=s,a=n.path||"";if(a.startsWith("/")&&(a=a.substring(1)),n.path)try{for await(const{value:c,remainderPath:u}of Ca(s,n.path,e,r,{signal:n.signal})){if(!V.asCID(c))break;a=u,o=c}}catch(c){throw c.message.startsWith("Object has no property")&&(c.message=`no link named "${a.split("/")[0]}" under ${o}`,c.code="ERR_NO_LINK"),c}return{cid:o,remainderPath:a||""}},l3=r=>{if(r.type!=="file"&&r.type!=="directory"&&r.type!=="raw")throw new Error(`Unknown node type '${r.type}'`);const e={cid:r.cid,path:r.path,name:r.name,size:r.size,type:"file"};return r.type==="directory"&&(e.type="dir"),r.type==="file"&&(e.size=r.unixfs.fileSize()),(r.type==="file"||r.type==="directory")&&(e.mode=r.unixfs.mode,r.unixfs.mtime!==void 0&&(e.mtime=r.unixfs.mtime)),e},RC=x(async(r,e)=>await r),Ca=async function*(r,e,t,n,s){const i=async u=>{const l=await t.getCodec(u.code),d=await n.blocks.get(u,s);return l.decode(d)},o=e.split("/").filter(Boolean);let a=await i(r),c=r;for(;o.length;){const u=o.shift();if(!u)throw E(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(r.code===Ne&&Array.isArray(a.Links)){const l=a.Links.find(d=>d.Name===u);if(l){yield{value:l.Hash,remainderPath:o.join("/")},a=await i(l.Hash),c=l.Hash;continue}}if(Object.prototype.hasOwnProperty.call(a,u))a=a[u],yield{value:a,remainderPath:o.join("/")};else throw E(new Error(`no link named "${u}" under ${c}`),"ERR_NO_LINK");V.asCID(a)&&(c=a,a=await i(a))}yield{value:a,remainderPath:""}};class _r{static create({start:e,stop:t}){return new _r(e,t)}static async start(e,t){const{state:n,activate:s}=e;switch(n.status){case"stopped":try{const i=s(t);e.state={status:"starting",ready:i};const o=await i;return e.state={status:"started",value:o},o}catch(i){throw e.state={status:"stopped"},i}case"starting":throw new ld;case"started":throw new ud;case"stopping":return await n.ready,await _r.start(e,t);default:return _r.panic(e)}}static async stop(e){const{state:t,deactivate:n}=e;switch(t.status){case"stopped":break;case"starting":{try{await t.ready}catch{}return await _r.stop(e)}case"stopping":return await t.ready;case"started":{n&&await n(t.value),e.state={status:"stopped"};break}default:_r.panic(t)}}static try({state:e}){switch(e.status){case"started":return e.value;default:return null}}static async use({state:e},t){switch(e.status){case"started":return e.value;case"starting":return await RC(e.ready,t);default:throw new qa}}static panic({state:e}){const t=JSON.stringify({status:e.status});throw RangeError(`Service in invalid state ${t}, should never happen if you see this please report a bug`)}constructor(e,t){this.activate=e,this.deactivate=t,this.state={status:"stopped"}}async use(e){return await _r.use(this,e)}try(){return _r.try(this)}}function IC({network:r,preload:e,peerId:t,keychain:n,repo:s,ipns:i,mfsPreload:o,print:a,hashers:c,options:u}){return async()=>{const{libp2p:d}=await _r.start(r,{peerId:t,repo:s,print:a,hashers:c,options:u});await Promise.all([i.startOnline({keychain:n,libp2p:d,peerId:t,repo:s}),e.start(),o.start()])}}function AC({network:r,preload:e,ipns:t,repo:n,mfsPreload:s}){return async()=>{await Promise.all([e.stop(),t.stop(),s.stop()]),await _r.stop(r),await n.close()}}var Ga=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}};let CC=class{constructor(e){this.lru=Ga(e)}get(e){const t=this.lru.get(e);if(t){if(t.expire&&t.expire<Date.now()){this.lru.remove(e);return}return t.value}}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}};const qd=new CC(1e3),TC=60*1e3,DC=lt.default?lt.default:lt,PC=new DC({concurrency:4}),u3=r=>{if(r.Path)return r.Path;throw new Error(r.Message)};async function kC(r,e){return(async(n,s={})=>{const i=new URLSearchParams(s);i.set("arg",n);const o=i.toString();if(!s.nocache&&qd.has(o)){const c=qd.get(o);return u3(c)}const a=await PC.add(async()=>{const c=await Vr.get("https://ipfs.io/api/v0/dns",{searchParams:i}),u=new URL(c.url).search.slice(1),l=await c.json();return qd.set(u,l,TC),l});return u3(a)})(r,e)}function OC(r){return r.endsWith(".eth")&&(r=r.replace(/.eth$/,".eth.link")),r}function NC(){return x(async(e,t={recursive:!0})=>{if(typeof e!="string")throw new Error("Invalid arguments, domain must be a string");return e=OC(e),kC(e,t)})}function xC({network:r}){return()=>{const e=r.try();return e!=null&&Boolean(e.libp2p.isStarted())}}function $C({repo:r,codecs:e,bases:t,name:n}){async function s(i,o={}){if(!_8(i))throw new Error("invalid argument "+i);if(v8(i))for await(const w of n.resolve(i,o))i=w;const[,a,c,...u]=i.split("/"),l=o.cidBase?await t.getBase(o.cidBase):void 0,d=LC(c);if(u.length===0){const w=l?l.encoder.encode(d):c;return`/${a}/${w}`}const f=V.decode(d);i=u.join("/");const g=Ca(f,i,e,r,o);let h=f,p=i;for await(const w of g)V.asCID(w.value)&&(h=w.value,p=w.remainderPath);return`/ipfs/${h.toString(l&&l.encoder)}${p?"/"+p:""}`}return x(s)}function LC(r){try{return re(r).toBytes()}catch{return V.parse(r).bytes}}async function tr(r){let e;for await(const t of r)e=t;return e}function MC({addAll:r}){return(e,t={})=>{let n;const s=V.asCID(e);return s?n=r([{cid:s,...t}],t):n=r([{path:e.toString(),...t}],t),tr(n)}}async function*Wa(r){if(r==null)throw E(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT");const e=je.asCID(r);if(e){yield gr({cid:e});return}if(r instanceof String||typeof r=="string"){yield gr({path:r});return}if(r.cid!=null||r.path!=null)return yield gr(r);if(Symbol.iterator in r){const t=r[Symbol.iterator](),n=t.next();if(n.done)return t;if(je.asCID(n.value)||n.value instanceof String||typeof n.value=="string"){yield gr({cid:n.value});for(const s of t)yield gr({cid:s});return}if(n.value.cid!=null||n.value.path!=null){yield gr(n.value);for(const s of t)yield gr(s);return}throw E(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}if(Symbol.asyncIterator in r){const t=r[Symbol.asyncIterator](),n=await t.next();if(n.done)return t;if(je.asCID(n.value)||n.value instanceof String||typeof n.value=="string"){yield gr({cid:n.value});for await(const s of t)yield gr({cid:s});return}if(n.value.cid!=null||n.value.path!=null){yield gr(n.value);for await(const s of t)yield gr(s);return}throw E(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}throw E(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}function gr(r){const e=r.cid||`${r.path}`;if(!e)throw E(new Error("Unexpected input: Please path either a CID or an IPFS path"),"ERR_UNEXPECTED_INPUT");const t={path:e,recursive:r.recursive!==!1};return r.metadata!=null&&(t.metadata=r.metadata),t}const fe={direct:"direct",recursive:"recursive",indirect:"indirect",all:"all"};function UC({repo:r,codecs:e}){async function*t(n,s={}){const i=async function*(){for await(const{path:c,recursive:u,metadata:l}of Wa(n)){const{cid:d}=await dd(r,e,c),{reason:f}=await r.pins.isPinnedWithType(d,[fe.recursive,fe.direct]);if(f==="recursive"&&!u)throw new Error(`${d} already pinned recursively`);u?await r.pins.pinRecursively(d,{metadata:l}):await r.pins.pinDirectly(d,{metadata:l}),yield d}};if(!Boolean(s.lock)){yield*i();return}const a=await r.gcLock.readLock();try{yield*i()}finally{a()}}return x(t)}function Co(r,e,t){const n={type:r,cid:e};return t&&(n.metadata=t),n}function BC({repo:r,codecs:e}){async function*t(n={}){let s=fe.all;if(n.type&&(s=n.type,!Object.keys(fe).includes(s)))throw E(new Error("Invalid pin type"),"ERR_INVALID_PIN_TYPE");if(n.paths){let i=!1;for await(const{path:o}of Wa(n.paths)){const{cid:a}=await dd(r,e,o),{reason:c,pinned:u,parent:l,metadata:d}=await r.pins.isPinnedWithType(a,s);if(!u)throw E(new Error(`path '${o}' is not pinned`),"ERR_NOT_PINNED");switch(c){case fe.direct:case fe.recursive:i=!0,yield Co(c,a,d);break;default:i=!0,yield Co(`${fe.indirect} through ${l}`,a,d)}}if(!i)throw new Error("No match found");return}if(s===fe.recursive||s===fe.all)for await(const{cid:i,metadata:o}of r.pins.recursiveKeys())yield Co(fe.recursive,i,o);if(s===fe.indirect||s===fe.all)for await(const i of r.pins.indirectKeys(n))yield Co(fe.indirect,i);if(s===fe.direct||s===fe.all)for await(const{cid:i,metadata:o}of r.pins.directKeys())yield Co(fe.direct,i,o)}return x(t)}function zC({rmAll:r}){async function e(t,n={}){const s=await tr(r([{path:t,...n}],n));if(!s)throw new Error("CID expected");return s}return e}function FC({repo:r,codecs:e}){async function*t(n,s={}){const i=await r.gcLock.readLock();try{for await(const{path:o,recursive:a}of Wa(n)){const{cid:c}=await dd(r,e,o),{pinned:u,reason:l}=await r.pins.isPinnedWithType(c,fe.all);if(!u)throw new Error(`${c} is not pinned`);switch(l){case fe.recursive:if(!a)throw new Error(`${c} is pinned recursively`);await r.pins.unpin(c),yield c;break;case fe.direct:await r.pins.unpin(c),yield c;break;default:throw new Error(`${c} is pinned indirectly under ${l}`)}}}finally{i()}}return x(t)}class VC{constructor({codecs:e,repo:t}){const n=UC({codecs:e,repo:t});this.addAll=n,this.add=MC({addAll:n});const s=FC({codecs:e,repo:t});this.rmAll=s,this.rm=zC({rmAll:s}),this.ls=BC({codecs:e,repo:t}),this.remote={add:(i,o={})=>Promise.reject(new Error("Not implemented")),ls:async function*(i,o={}){return Promise.reject(new Error("Not implemented"))},rm:(i,o={})=>Promise.reject(new Error("Not implemented")),rmAll:(i,o={})=>Promise.reject(new Error("Not implemented")),service:{add:(i,o)=>Promise.reject(new Error("Not implemented")),rm:(i,o={})=>Promise.reject(new Error("Not implemented")),ls:(i={})=>Promise.reject(new Error("Not implemented"))}}}}function D8(r){return r=r||new Error("Cannot open database"),E(r,"ERR_DB_OPEN_FAILED")}function P8(r){return r=r||new Error("Delete failed"),E(r,"ERR_DB_DELETE_FAILED")}function Ff(r){return r=r||new Error("Write failed"),E(r,"ERR_DB_WRITE_FAILED")}function Yr(r){return r=r||new Error("Not Found"),E(r,"ERR_NOT_FOUND")}var Vf={},jC={get exports(){return Vf},set exports(r){Vf=r}};(function(r){(function(){r.exports=w;var e=86400,t=3200,n=146097*t/400,s=e*n,i=1e3*s,o=864e13,a=4294967296,c=1e6,u="000000000",l=Math.trunc||function(C){var P=C-C%1;return P==0&&(C<0||C===0&&1/C!=1/0)?-0:P},d=w.prototype,f=(w.fromDate=function(C){return new w(+C)},w.fromInt64BE=S(0,1,2,3,0,4),w.fromInt64LE=S(3,2,1,0,4,0),w.fromString=function(F){var P,$=new w,F=(F+="").replace(/^\s*[+\-]?\d+/,function(Q){var Q=+Q,z=1970+(Q-1970)%400;return $.year=Q-z,z}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(W,Q,z){return Q<0&&(z*=-1),P=6e4*(60*+Q+ +z),""}).replace(/\.\d+$/,function(W){return $.nano=+(W+u).substr(1,9),""}).split(/\D+/);if(1<F.length?F[1]--:F[1]=0,$.time=P=Date.UTC.apply(Date,F)-(P||0),isNaN(P))throw new TypeError("Invalid Date");return y($)},w.fromTimeT=function(C){return b(C,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(C){return this.nano+=+C||0,this},d.getNano=function(){var C=y(this);return(C.time%1e3*c+ +C.nano+1e9)%1e9},d.getTimeT=function(){var P=y(this),C=Math.floor(P.time/1e3),P=P.year;return P&&(C+=P*n*e/t),C},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return _(y(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(C){var P=this,$=P.toDate(),F={H:function(){return v($.getUTCHours())},L:function(){return A($.getUTCMilliseconds(),3)},M:function(){return v($.getUTCMinutes())},N:function(){return A(P.getNano(),9)},S:function(){return v($.getUTCSeconds())},Y:function(){var W=P.getYear();return 999999<W?"+"+W:9999<W?"+"+A(W,6):0<=W?A(W,4):-999999<=W?"-"+A(-W,6):W},a:function(){return h[$.getUTCDay()]},b:function(){return g[$.getUTCMonth()]},d:function(){return v($.getUTCDate())},e:function(){return function(W){return(9<W?"":" ")+(0|W)}($.getUTCDate())},m:function(){return v($.getUTCMonth()+1)}};return function W(Q){return Q.replace(/%./g,function(z){var Ie=z[1],ge=p[Ie],Ie=F[Ie];return ge?W(ge):Ie?Ie():z})}(C||f)},d.writeInt64BE=m(0,1,2,3,0,4),d.writeInt64LE=m(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return w;function w(C,P,$){var F=this;if(!(F instanceof w))return new w(C,P,$);F.time=+C||0,F.nano=+P||0,F.year=+$||0,y(F)}function y(C){var P,$,F,W=C.year,Q=C.time,z=C.nano,ge=((z<0||c<=z)&&(z-=($=Math.floor(z/c))*c,Q+=$,$=1),W%t);return(Q<-o||o<Q||ge)&&((P=l(Q/i))&&(W+=P*t,Q-=P*i),(F=_(Q)).setUTCFullYear(ge+F.getUTCFullYear()),F=(Q=+F)+(P=l((W-=ge)/t))*i,P&&-o<=F&&F<=o&&(W-=P*t,Q=F),$=1),$&&(C.year=W,C.time=Q,C.nano=z),C}function _(C){var P=new Date(0);return P.setTime(C),P}function b(W,F){W=+W||0;var $=l((F=(F|0)*a)/s)+l(W/s),F=F%s+W%s,W=l(F/s);return W&&($+=W,F-=W*s),new w(1e3*F,0,$*t)}function m(C,P,$,F,W,Q){return function(ge,Ie){var rn=y(this);ge=ge||new Array(8),R(ge,Ie|=0);var fi=Math.floor(rn.time/1e3),rn=rn.year*(n*e/t),tn=l(rn/a)+l(fi/a),rn=rn%a+fi%a,fi=Math.floor(rn/a);return fi&&(tn+=fi,rn-=fi*a),z(ge,Ie+W,tn),z(ge,Ie+Q,rn),ge};function z(ge,Ie,tn){ge[Ie+C]=tn>>24&255,ge[Ie+P]=tn>>16&255,ge[Ie+$]=tn>>8&255,ge[Ie+F]=255&tn}}function S(C,P,$,F,W,Q){return function(ge,Ie){R(ge,Ie|=0);var tn=z(ge,Ie+W);return b(z(ge,Ie+Q),tn)};function z(ge,Ie){return 16777216*ge[Ie+C]+(ge[Ie+P]<<16|ge[Ie+$]<<8|ge[Ie+F])}}function R(C,P){if(C=C&&C.length,C==null)throw new TypeError("Invalid Buffer");if(C<P+8)throw new RangeError("Out of range")}function v(C){return(9<C?"":"0")+(0|C)}function A(C,P){return(u+(0|C)).substr(-P)}})()})(jC);const KC=Vf,k8=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let qC=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},HC=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return O8(this,e)}},GC=class{constructor(e){this.decoders=e}or(e){return O8(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const O8=(r,e)=>new GC({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let WC=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new qC(e,t,n),this.decoder=new HC(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const YC=({name:r,prefix:e,encode:t,decode:n})=>new WC(r,e,t,n),QC=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},JC=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Tn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>YC({prefix:e,name:r,encode(s){return JC(s,n,t)},decode(s){return QC(s,n,t,r)}});Tn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});const XC=Tn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Tn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Tn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Tn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Tn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Tn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Tn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Tn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const ZC="ERR_IPNS_EXPIRED_RECORD",H0="ERR_UNRECOGNIZED_VALIDITY",eT="ERR_SIGNATURE_CREATION",Fs="ERR_SIGNATURE_VERIFICATION",tT="ERR_UNRECOGNIZED_FORMAT",d3="ERR_UNDEFINED_PARAMETER",rT="ERR_INVALID_RECORD_DATA",nT="ERR_INVALID_EMBEDDED_KEY",sT="ERR_MISSING_PRIVATE_KEY";var Qr;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),function(n){n.codec=()=>ji(e)}(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=tt((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.value!=null&&(s.uint32(10),s.bytes(n.value)),n.signature!=null&&(s.uint32(18),s.bytes(n.signature)),n.validityType!=null&&(s.uint32(24),r.ValidityType.codec().encode(n.validityType,s)),n.validity!=null&&(s.uint32(34),s.bytes(n.validity)),n.sequence!=null&&(s.uint32(40),s.uint64(n.sequence)),n.ttl!=null&&(s.uint32(48),s.uint64(n.ttl)),n.pubKey!=null&&(s.uint32(58),s.bytes(n.pubKey)),n.signatureV2!=null&&(s.uint32(66),s.bytes(n.signatureV2)),n.data!=null&&(s.uint32(74),s.bytes(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s)=>{const i={},o=s==null?n.len:n.pos+s;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:i.value=n.bytes();break;case 2:i.signature=n.bytes();break;case 3:i.validityType=r.ValidityType.codec().decode(n);break;case 4:i.validity=n.bytes();break;case 5:i.sequence=n.uint64();break;case 6:i.ttl=n.uint64();break;case 7:i.pubKey=n.bytes();break;case 8:i.signatureV2=n.bytes();break;case 9:i.data=n.bytes();break;default:n.skipType(a&7);break}}return i})),t),r.encode=n=>rt(n,r.codec()),r.decode=n=>nt(n,r.codec())})(Qr||(Qr={}));const h3=O("ipns:utils"),N8=M("/ipns/");function jf(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),u=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,u))}const iT=async(r,e)=>{if(e==null||r==null){const n=new Error("one or more of the provided parameters are not defined");throw h3.error(n),E(n,d3)}let t;if(e.pubKey!=null){try{t=Ki(e.pubKey)}catch(s){throw h3.error(s),s}if(!(await Sn(e.pubKey)).equals(r))throw E(new Error("Embedded public key did not match PeerID"),nT)}else r.publicKey!=null&&(t=Ki(r.publicKey));if(t!=null)return t;throw E(new Error("no public key is available"),d3)},oT=(r,e,t)=>{const n=M(e);return Jt([r,t,n])},x8=r=>{const e=M("ipns-signature:");return Jt([e,r])},aT=r=>Qr.encode(r),hd=r=>{const e=Qr.decode(r);return e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),{value:e.value??new Uint8Array(0),signature:e.signature??new Uint8Array(0),validityType:e.validityType??Qr.ValidityType.EOL,validity:e.validity??new Uint8Array(0),sequence:e.sequence??0n,pubKey:e.pubKey,ttl:e.ttl??void 0,signatureV2:e.signatureV2,data:e.data}},jl=r=>Jt([N8,r.toBytes()]),cT=r=>Xr(r.slice(N8.length)),lT=(r,e,t,n,s)=>{let i;if(t===Qr.ValidityType.EOL)i=0;else throw E(new Error("Unknown validity type"),H0);return Xs({Value:r,Validity:e,ValidityType:i,Sequence:n,TTL:s})},uT=r=>{const e=Ir(r);if(e.ValidityType===0)e.ValidityType=Qr.ValidityType.EOL;else throw E(new Error("Unknown validity type"),H0);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e};var dT=$8,f3=128,hT=127,fT=~hT,pT=Math.pow(2,31);function $8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=pT;)e[t++]=r&255|f3,r/=128;for(;r&fT;)e[t++]=r&255|f3,r>>>=7;return e[t]=r|0,$8.bytes=t-n+1,e}var gT=Kf,yT=128,p3=127;function Kf(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Kf.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&p3)<<s:(o&p3)*Math.pow(2,s),s+=7}while(o>=yT);return Kf.bytes=i-n,t}var wT=Math.pow(2,7),mT=Math.pow(2,14),bT=Math.pow(2,21),ET=Math.pow(2,28),_T=Math.pow(2,35),vT=Math.pow(2,42),ST=Math.pow(2,49),RT=Math.pow(2,56),IT=Math.pow(2,63),AT=function(r){return r<wT?1:r<mT?2:r<bT?3:r<ET?4:r<_T?5:r<vT?6:r<ST?7:r<RT?8:r<IT?9:10},CT={encode:dT,decode:gT,encodingLength:AT},Kl=CT;const g3=(r,e=0)=>[Kl.decode(r,e),Kl.decode.bytes],y3=(r,e,t=0)=>(Kl.encode(r,e,t),e),w3=r=>Kl.encodingLength(r),TT=(r,e)=>{const t=e.byteLength,n=w3(r),s=n+w3(t),i=new Uint8Array(s+t);return y3(r,i,0),y3(t,i,n),i.set(e,s),new L8(r,t,e,i)},DT=r=>{const e=k8(r),[t,n]=g3(e),[s,i]=g3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new L8(t,s,o,e)};let L8=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const M8=0,PT="identity",U8=k8,kT=r=>TT(M8,U8(r)),OT={code:M8,name:PT,encode:U8,digest:kT},B8=O("ipns"),NT=OT.code,el="/ipns/",Hd=el.length,xT=async(r,e,t,n)=>{const s=new KC(Date.now()+Number(n)),i=Qr.ValidityType.EOL,[o,a]=n.toString().split("."),c=BigInt(o)*BigInt(1e5)+BigInt(a??"0");return await $T(r,e,t,i,s,c)},$T=async(r,e,t,n,s,i)=>{t=BigInt(t);const o=M(s.toString());if(r.privateKey==null)throw E(new Error("Missing private key"),sT);const a=await oi(r.privateKey),c=await MT(a,e,n,o),u=lT(e,o,n,t,i),l=x8(u),d=await a.sign(l),f={value:e,signature:c,validityType:n,validity:o,sequence:t,ttl:i,signatureV2:d,data:u};if(r.publicKey!=null){const g=DT(r.toBytes());(g.code!==NT||!Dt(r.publicKey,g.digest))&&(f.pubKey=r.publicKey)}return B8("ipns entry for %b created",e),f},LT=r=>XC.encode(r).slice(1),qf=r=>new J(`/ipns/${LT(r)}`),MT=async(r,e,t,n)=>{try{const s=oT(e,t,n);return await r.sign(s)}catch(s){throw B8.error("record signature creation failed",s),E(new Error("record signature creation failed"),eT)}},rr=O("ipfs:ipns:publisher"),m3=Yr().code,z8=60*60*1e3;class tl{constructor(e,t){this._routing=e,this._datastore=t}async publishWithEOL(e,t,n,s){const i=await this._updateOrCreateRecord(e,t,n,s);return this._putRecordToRouting(i,e,s)}publish(e,t,n){return this.publishWithEOL(e,t,z8,n)}async _putRecordToRouting(e,t,n){if(!Ys(t)){const i="peerId received is not valid";throw rr.error(i),E(new Error(i),"ERR_INVALID_PEER_ID")}if(t.publicKey==null)throw E(new Error("Public key was missing"),"ERR_MISSING_PUBLIC_KEY");const s=jl(t);return await this._publishEntry(s,e,n),e}async _publishEntry(e,t,n){try{const s=await this._routing.put(e,t,n);return rr(`ipns record for ${q(e,"base32")} was stored in the routing`),s}catch(s){const i=`ipns record for ${q(e,"base32")} could not be stored in the routing - ${s.stack}`;throw rr.error(i),rr.error(s),E(new Error(i),"ERR_PUTTING_TO_ROUTING")}}async _getPublished(e,t={}){if(!Ys(e)){const s="peerId received is not valid";throw rr.error(s),E(new Error(s),"ERR_INVALID_PEER_ID")}const n=t.checkRouting!==!1;try{const s=await this._datastore.get(qf(e.toBytes()));return this._unmarshalData(s)}catch(s){if(s.code!==m3){const i=`unexpected error getting the ipns record ${e.toString()} from datastore`;throw rr.error(i),E(new Error(i),"ERR_UNEXPECTED_DATASTORE_RESPONSE")}if(!n)throw E(s,"ERR_NOT_FOUND_AND_CHECK_ROUTING_NOT_ENABLED");try{const i=jl(e),o=await this._routing.get(i);return this._unmarshalData(o)}catch(i){throw rr.error(i),i}}}_unmarshalData(e){try{return hd(e)}catch(t){throw E(t,"ERR_INVALID_RECORD_DATA")}}async _updateOrCreateRecord(e,t,n,s){if(!Ys(e)){const u="peerId received is not valid";throw rr.error(u),E(new Error(u),"ERR_INVALID_PEER_ID")}const i={checkRouting:!0};let o;try{o=await this._getPublished(e,i)}catch(u){if(u.code!==m3){const l=`unexpected error when determining the last published IPNS record for ${e.toString()} ${u.stack}`;throw rr.error(l),E(new Error(l),"ERR_DETERMINING_PUBLISHED_RECORD")}}let a=0n;o&&o.sequence!==void 0&&(a=Dt(o.value,t)?o.sequence:o.sequence+BigInt(1));let c;try{c=await xT(e,t,a,n)}catch(u){const l=`ipns record for ${t} could not be created`;throw rr.error(u),E(new Error(l),"ERR_CREATING_IPNS_RECORD")}try{const u=aT(c);return await this._datastore.put(qf(e.toBytes()),u,s),rr(`ipns record for ${q(t,"base32")} was stored in the datastore`),u}catch{const l=`ipns record for ${t} could not be stored in the datastore`;throw rr.error(l),E(new Error(l),"ERR_STORING_IN_DATASTORE")}}}tl.defaultRecordLifetime=z8;const hc=O("ipfs:ipns:republisher"),F8=60*1e3,V8=60*F8,UT=4*V8,BT=24*V8;class zT{constructor(e,t,n,s,i={pass:""}){this._publisher=e,this._datastore=t,this._peerId=n,this._keychain=s,this._options=i,this._republishHandle=null}async start(){if(this._republishHandle)throw E(new Error("republisher is already running"),"ERR_REPUBLISH_ALREADY_RUNNING");const e={_task:null,_inflightTask:null,_timeoutId:null,runPeriodically:s=>{e._timeoutId=setTimeout(async()=>{e._timeoutId=null;try{e._inflightTask=e._task(),await e._inflightTask,e._task&&e.runPeriodically(s)}catch(i){hc.error(i)}},s())},cancel:async()=>{e._timeoutId!=null&&clearTimeout(e._timeoutId),e._task=null,await e._inflightTask}},{pass:t}=this._options;let n=!0;e._task=async()=>{const s=new $e.TimeoutController(3e4);try{await this._republishEntries(this._peerId,t,{signal:s.signal})}finally{s.clear()}},e.runPeriodically(()=>n?(n=!1,this._options.initialBroadcastInterval||F8):this._options.broadcastInterval||UT),this._republishHandle=e}async stop(){const e=this._republishHandle;if(!e)throw E(new Error("republisher is not running"),"ERR_REPUBLISH_NOT_RUNNING");this._republishHandle=null,await e.cancel()}async _republishEntries(e,t,n){try{await this._republishEntry(e,n)}catch{const i="cannot republish entry for the node's private key";hc.error(i);return}if(t)try{const s=await this._keychain.listKeys();for(const i of s){if(i.name==="self")continue;const o=await this._keychain.exportKey(i.name,t),a=await da(o,t),c=await Sn(a.public.bytes,a.bytes);await this._republishEntry(c,n)}}catch(s){hc.error(s)}}async _republishEntry(e,t){try{const n=await this._getPreviousValue(e);await this._publisher.publishWithEOL(e,n,BT,t)}catch(n){if(n.code==="ERR_NO_ENTRY_FOUND")return;throw n}}async _getPreviousValue(e){if(!Ys(e))throw E(new Error("invalid peer ID"),"ERR_INVALID_PEER_ID");try{const t=await this._datastore.get(qf(e.toBytes()));if(!(t instanceof Uint8Array))throw E(new Error("found ipns record that we couldn't process"),"ERR_INVALID_IPNS_RECORD");try{return hd(t).value}catch(n){throw hc.error(n),E(new Error("found ipns record that we couldn't convert to a value"),"ERR_INVALID_IPNS_RECORD")}}catch(t){throw t&&t.notFound?E(new Error(`no previous entry for record with id: ${e.toString()}`),"ERR_NO_ENTRY_FOUND"):t}}}const To=O("ipns:validator"),FT=async(r,e)=>{const{value:t,validityType:n,validity:s}=e;let i,o;if(e.signatureV2!=null&&e.data!=null)o=e.signatureV2,i=x8(e.data),VT(e);else throw E(new Error("missing data or signatureV2"),Fs);let a;try{a=await r.verify(i,o)}catch{a=!1}if(!a)throw To.error("record signature verification failed"),E(new Error("record signature verification failed"),Fs);if(s!=null&&n===Qr.ValidityType.EOL){let c;try{c=jf(q(s))}catch{throw To.error("unrecognized validity format (not an rfc3339 format)"),E(new Error("unrecognized validity format (not an rfc3339 format)"),tT)}if(c.getTime()<Date.now())throw To.error("record has expired"),E(new Error("record has expired"),ZC)}else if(n!=null)throw To.error("unrecognized validity type"),E(new Error("unrecognized validity type"),H0);To("ipns entry for %b is valid",t)},VT=r=>{if(r.data==null)throw E(new Error("Record data is missing"),rT);const e=uT(r.data);if(!Dt(e.Value,r.value))throw E(new Error('Field "value" did not match between protobuf and CBOR'),Fs);if(!Dt(e.Validity,r.validity))throw E(new Error('Field "validity" did not match between protobuf and CBOR'),Fs);if(e.ValidityType!==r.validityType)throw E(new Error('Field "validityType" did not match between protobuf and CBOR'),Fs);if(e.Sequence!==r.sequence)throw E(new Error('Field "sequence" did not match between protobuf and CBOR'),Fs);if(e.TTL!==r.ttl)throw E(new Error('Field "ttl" did not match between protobuf and CBOR'),Fs)},G0=async(r,e)=>{const t=cT(r),n=hd(e),s=await iT(t,n);await FT(s,n)},Gd=O("ipfs:ipns:resolver"),jT=Yr().code,b3=32;class KT{constructor(e){this._routing=e}async resolve(e,t={}){if(typeof e!="string")throw E(new Error("invalid name"),"ERR_INVALID_NAME");const n=t.recursive&&t.recursive.toString()==="true",s=e.split("/");if(s.length!==3||s[0]!=="")throw E(new Error("invalid name"),"ERR_INVALID_NAME");const i=s[2];let o=1/0;n&&(o=b3);const a=await this.resolver(i,o,t);return Gd(`${e} was locally resolved correctly`),a}async resolver(e,t,n){if(t===0){const o=`could not resolve name (recursion limit of ${b3} exceeded)`;throw Gd.error(o),E(new Error(o),"ERR_RESOLVE_RECURSION_LIMIT")}const s=await this._resolveName(e,n),i=s.split("/");return i[1]==="ipfs"||!t?s:this.resolver(i[2],t-1,n)}async _resolveName(e,t){const n=re(e),s=jl(n);let i;try{i=await this._routing.get(s,t)}catch(o){throw Gd.error("could not get record from routing",o),o.code===jT?E(new Error(`record requested for ${e} was not found in the network`),"ERR_NO_RECORD_FOUND"):E(new Error(`unexpected error getting the ipns record ${n.toString()}`),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}return this._validateRecord(n,i)}async _validateRecord(e,t){await G0(Jt([M("/ipns/"),e.toBytes()]),t);const n=hd(t);return q(n.value)}}class qT{constructor(e){this.lru=Ga(e)}get(e){const t=this.lru.get(e);if(t){if(t.expire&&t.expire<Date.now()){this.lru.remove(e);return}return t.value}}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}}const Do=O("ipfs:ipns"),E3=60*1e3;class _3{constructor(e,t,n,s,i){this.publisher=new tl(e,t),this.republisher=new zT(this.publisher,t,n,s,i),this.resolver=new KT(e),this.cache=new qT(1e3),this.routing=e}async publish(e,t,n=tl.defaultRecordLifetime,s){try{await this.publisher.publishWithEOL(e,t,n,s),Do(`IPNS value ${q(t,"base32")} was published correctly`);const i=e.toString(),o=parseFloat(n),a=o<E3?o:E3;return this.cache.set(i,t,a),Do(`IPNS value ${q(t,"base32")} was cached correctly`),{name:i,value:t}}catch(i){throw Do.error(i),i}}async resolve(e,t={}){if(typeof e!="string")throw E(new Error("name received is not valid"),"ERR_INVALID_NAME");if(!t.nocache&&!t.recursive){const n=e.split("/")[2],s=this.cache.get(n);if(s)return s}try{const n=await this.resolver.resolve(e,t);return Do(`IPNS record from ${e} was resolved correctly`),n}catch(n){throw Do.error(n),n}}async initializeKeyspace(e,t,n){return this.publish(e,t,tl.defaultRecordLifetime,n)}}async function Dn(r){const e=[];for await(const t of r)e.push(t);return e}const v3=(r,e)=>async function*(){yield*(await Dn(r)).sort(e)}();async function Et(r){for await(const e of r);}async function*Ze(r,e){for await(const t of r)await e(t)&&(yield t)}async function*Ta(r,e){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}class fd{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Et(this.putMany(e,n)),e=[],await Et(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null&&(n=Ze(n,s=>s.key.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>Ze(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>v3(s,i),n)),e.offset!=null){let s=0;n=Ze(n,()=>s++>=e.offset)}return e.limit!=null&&(n=Ta(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null&&(n=Ze(n,s=>s.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>Ze(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>v3(s,i),n)),e.offset!=null){let s=0;n=Ze(n,()=>s++>=e.offset)}return e.limit!=null&&(n=Ta(n,e.limit)),n}}const HT=O("datastore:core:tiered");class GT extends fd{constructor(e){super(),this.stores=e.slice()}async open(){try{await Promise.all(this.stores.map(e=>e.open()))}catch(e){throw D8(e)}}async put(e,t,n){try{await Promise.all(this.stores.map(s=>s.put(e,t,n)))}catch(s){throw Ff(s)}}async get(e,t){for(const n of this.stores)try{const s=await n.get(e,t);if(s)return s}catch(s){HT.error(s)}throw Yr()}async has(e,t){for(const n of this.stores)if(await n.has(e,t))return!0;return!1}async delete(e,t){try{await Promise.all(this.stores.map(n=>n.delete(e,t)))}catch(n){throw P8(n)}}async*putMany(e,t={}){let n;const s=this.stores.map(i=>{const o=dr({objectMode:!0});return Et(i.putMany(o,t)).catch(a=>{n=a}),o});try{for await(const i of e){if(n)throw n;s.forEach(o=>o.push(i)),yield i}}finally{s.forEach(i=>i.end())}}async*deleteMany(e,t={}){let n;const s=this.stores.map(i=>{const o=dr({objectMode:!0});return Et(i.deleteMany(o,t)).catch(a=>{n=a}),o});try{for await(const i of e){if(n)throw n;s.forEach(o=>o.push(i)),yield i}}finally{s.forEach(i=>i.end())}}async close(){await Promise.all(this.stores.map(e=>e.close()))}batch(){const e=this.stores.map(t=>t.batch());return{put:(t,n)=>{e.forEach(s=>s.put(t,n))},delete:t=>{e.forEach(n=>n.delete(t))},commit:async t=>{for(const n of e)await n.commit(t)}}}query(e,t){return this.stores[this.stores.length-1].query(e,t)}queryKeys(e,t){return this.stores[this.stores.length-1].queryKeys(e,t)}}function oe(r,e,t,n,s){for(e=e.split?e.split("."):e,n=0;n<e.length;n++)r=r?r[e[n]]:s;return r===s?t:r}const j8=(r,e)=>{const t=e.map((n,s)=>({entry:Qr.decode(n),index:s}));return t.sort((n,s)=>{if(n.entry.signatureV2!=null&&s.entry.signatureV2==null)return-1;if(n.entry.signatureV2==null&&s.entry.signatureV2!=null)return 1;const i=n.entry.sequence??0n,o=s.entry.sequence??0n;if(i>o)return-1;if(i<o)return 1;const a=n.entry.validity??new Uint8Array(0),c=s.entry.validity??new Uint8Array(0),u=jf(q(a)),l=jf(q(c));return u.getTime()>l.getTime()?-1:u.getTime()<l.getTime()?1:0}),t[0].index},WT="SHARDING",YT="_README";class QT extends fd{constructor(){super(),this.data={}}open(){return Promise.resolve()}close(){return Promise.resolve()}async put(e,t){this.data[e.toString()]=t}async get(e){if(!await this.has(e))throw Yr();return this.data[e.toString()]}async has(e){return this.data[e.toString()]!==void 0}async delete(e){delete this.data[e.toString()]}async*_all(){yield*Object.entries(this.data).map(([e,t])=>({key:new J(e),value:t}))}async*_allKeys(){yield*Object.entries(this.data).map(([e])=>new J(e))}}async function*_t(r,e){for await(const t of r)yield e(t)}new J(WT);new J(YT);const rl="/record/";function S3(r){return q(r,"base32")}function fc(r){(typeof r=="string"||r instanceof String)&&(r=M(r.toString()));const e=q(r,"base64url");return`${rl}${e}`}function JT(r){if(r.substring(0,rl.length)!==rl)throw E(new Error("topic received is not from a record"),"ERR_TOPIC_IS_NOT_FROM_RECORD_NAMESPACE");const e=r.substring(rl.length);return M(e,"base64url")}const ht=O("datastore-pubsub:publisher");class XT extends fd{constructor(e,t,n,s,i,o){if(super(),!s)throw E(new TypeError("missing validator"),"ERR_INVALID_PARAMETERS");if(typeof s!="function")throw E(new TypeError("missing validate function"),"ERR_INVALID_PARAMETERS");if(typeof i!="function")throw E(new TypeError("missing select function"),"ERR_INVALID_PARAMETERS");if(o&&typeof o!="function")throw E(new TypeError("invalid subscriptionKeyFn received"),"ERR_INVALID_PARAMETERS");this._pubsub=e,this._datastore=t,this._peerId=n,this._validator=s,this._selector=i,this._handleSubscriptionKeyFn=o,this._onMessage=this._onMessage.bind(this),this._pubsub.addEventListener("message",this._onMessage)}async put(e,t,n){if(!(e instanceof Uint8Array)){const i="datastore key does not have a valid format";throw ht.error(i),E(new Error(i),"ERR_INVALID_DATASTORE_KEY")}if(!(t instanceof Uint8Array)){const i="received value is not a Uint8Array";throw ht.error(i),E(new Error(i),"ERR_INVALID_VALUE_RECEIVED")}const s=fc(e);ht(`publish value for topic ${s}`),await this._pubsub.publish(s,t)}async get(e,t){if(!(e instanceof Uint8Array)){const i="datastore key does not have a valid format";throw ht.error(i),E(new Error(i),"ERR_INVALID_DATASTORE_KEY")}const n=fc(e),s=await this._pubsub.getTopics();if(s&&Array.isArray(s)&&s.indexOf(n)>-1)return this._getLocal(e,t);try{await this._pubsub.subscribe(n)}catch{const o=`cannot subscribe topic ${n}`;throw ht.error(o),E(new Error(o),"ERR_SUBSCRIBING_TOPIC")}return ht(`subscribed values for key ${n}`),this._getLocal(e)}unsubscribe(e){const t=fc(e);return this._pubsub.unsubscribe(t)}async _getLocal(e,t){const n=new J("/"+S3(e),!1);let s;try{s=await this._datastore.get(n,t)}catch(i){if(i.code!=="ERR_NOT_FOUND"){const a=`unexpected error getting the ipns record for ${n.toString()}`;throw ht.error(a),E(new Error(a),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}const o=`local record requested was not found for ${n.toString()}`;throw ht.error(o),E(new Error(o),"ERR_NOT_FOUND")}if(!(s instanceof Uint8Array)){const i="found record that we couldn't convert to a value";throw ht.error(i),E(new Error(i),"ERR_INVALID_RECORD_RECEIVED")}return s}async _onMessage(e){const t=e.detail;if(t.type!=="signed"){ht.error("unsigned message received, this module can only work with signed messages");return}const{data:n,from:s,topic:i}=t;let o;try{o=JT(i)}catch(a){ht.error(a);return}if(ht(`message received for topic ${i}`),this._peerId.equals(s)){ht("message discarded as it is from the same peer");return}if(this._handleSubscriptionKeyFn){let a;try{a=await this._handleSubscriptionKeyFn(o)}catch{ht.error("message discarded by the subscriptionKeyFn");return}o=a}try{await this._storeIfSubscriptionIsBetter(o,n)}catch(a){ht.error(a)}}async _storeIfSubscriptionIsBetter(e,t,n){let s=!1;try{s=await this._isBetter(e,t)}catch(i){if(i.code!=="ERR_NOT_VALID_RECORD")throw i}s&&await this._storeRecord(e,t,n)}async _validateRecord(e,t){return this._validator(e,t)}async _selectRecord(e,t){return await this._selector(e,t)===0}async _isBetter(e,t){try{await this._validateRecord(e,t)}catch{const o="record received through pubsub is not valid";throw ht.error(o),E(new Error(o),"ERR_NOT_VALID_RECORD")}const n=new J(e);let s;try{s=await this._getLocal(n.uint8Array())}catch{return!0}return Dt(s,t)?!1:this._selectRecord(e,[s,t])}async _storeRecord(e,t,n){const s=new J("/"+S3(e),!1);await this._datastore.put(s,t,n),ht(`record for ${fc(e)} was stored in the datastore`)}}const pc=O("ipfs:ipns:pubsub");class Hf{constructor(e,t,n){this._subscriptions={},this._handleSubscriptionKey=this._handleSubscriptionKey.bind(this),this._pubsubDs=new XT(e,t,n,G0,j8,this._handleSubscriptionKey)}async put(e,t,n){try{await this._pubsubDs.put(e,t,n)}catch(s){throw pc.error(s),s}}async get(e,t){let n,s;try{n=await this._pubsubDs.get(e,t)}catch(o){s=o}const i=e.slice(0,Hd);if(q(i)===el){const o=Ht.encode(e).substring(1),a=Ht.encode(e.slice(Hd)).substring(1);this._subscriptions[o]=a,pc(`subscribed to pubsub topic ${o}, id ${a}`)}if(s)throw s;return n}_handleSubscriptionKey(e){e instanceof Uint8Array&&(e=q(e,"base58btc"));const t=this._subscriptions[e];if(!t)throw E(new Error(`key ${e} does not correspond to a subscription`),"ERR_INVALID_KEY");try{return jl(re(t))}catch(n){throw pc.error(n),n}}getSubscriptions(){return Object.values(this._subscriptions).filter(Boolean).map(t=>`${el}${t}`)}async cancel(e){if(typeof e!="string")throw E(new Error("invalid subscription name"),"ERR_INVALID_SUBSCRIPTION_NAME");e.startsWith(el)&&(e=e.substring(Hd));const t=Object.keys(this._subscriptions).find(s=>this._subscriptions[s]===e);if(!t)return{canceled:!1};const n=M(t);return this._pubsubDs.unsubscribe(n),delete this._subscriptions[t],pc(`unsubscribed pubsub ${t}: ${e}`),{canceled:!0}}}var ql;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.key!=null&&t.key.byteLength>0)&&(n.uint32(10),n.bytes(t.key)),(s.writeDefaults===!0||t.value!=null&&t.value.byteLength>0)&&(n.uint32(18),n.bytes(t.value)),(s.writeDefaults===!0||t.timeReceived!=="")&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={key:new Uint8Array(0),value:new Uint8Array(0),timeReceived:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(ql||(ql={}));function ZT(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function eD(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),u=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,u))}class Nt{constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return ql.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:ZT(this.timeReceived)}}static deserialize(e){const t=ql.decode(e);return new Nt(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=eD(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Nt(e.key,e.value,t)}}const Wd=O("ipfs:ipns:offline-datastore");class K8{constructor(e){this._datastore=e,this.stores=[]}async put(e,t,n){if(!(e instanceof Uint8Array))throw E(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");if(!(t instanceof Uint8Array))throw E(new Error("Offline datastore value must be a Uint8Array"),"ERR_INVALID_VALUE");let s;try{s=this._routingKey(e)}catch(o){throw Wd.error(o),E(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const i=new Nt(e,t,new Date);await this._datastore.put(s,i.serialize(),n)}async get(e,t){if(!(e instanceof Uint8Array))throw E(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");let n;try{n=this._routingKey(e)}catch(o){throw Wd.error(o),E(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const s=await this._datastore.get(n,t);let i;try{i=Nt.deserialize(s)}catch(o){throw Wd.error(o),o}return i.value}_routingKey(e){return new J("/dht/record/"+q(e,"base32"),!1)}}const tD=O("ipfs:ipns:dht-datastore");class rD{constructor(e){this._dht=e}async put(e,t,n){try{await Et(this._dht.put(e,t,n))}catch(s){throw tD.error(s),s}}async get(e,t){for await(const n of this._dht.get(e,t))if(n.name==="VALUE")return n.value;throw Yr()}}function nD({libp2p:r,repo:e,peerId:t,options:n}){const s=[];let i;if(oe(n,"EXPERIMENTAL.ipnsPubsub",!1)&&(i=new Hf(r.pubsub,e.datastore,t),s.push(i)),oe(n,"offline",!1)!==!0&&["dht","dhtclient","dhtserver"].includes(oe(n,"config.Routing.Type","none"))&&s.push(new rD(r.dht)),oe(n,"offline",!1)||s.length===0){const o=new K8(e.datastore);s.push(o)}return new GT(s)}const sD=O("ipfs:components:ipns");class iD{constructor(e={pass:""}){this.options=e,this.offline=null,this.online=null}getIPNS(){const e=this.online||this.offline;if(e)return e;throw new Ka}get routing(){return this.getIPNS().routing}startOffline({repo:e,peerId:t,keychain:n}){if(this.offline!=null)throw new Zs;sD("initializing IPNS keyspace (offline)");const s=new K8(e.datastore),i=new _3(s,e.datastore,t,n,this.options);this.offline=i}async startOnline({libp2p:e,repo:t,peerId:n,keychain:s}){if(this.online!=null)throw new Zs;const i=nD({libp2p:e,repo:t,peerId:n,options:this.options}),o=new _3(i,t.datastore,n,s,this.options);await o.republisher.start(),this.online=o}async stop(){const e=this.online;e&&(await e.republisher.stop(),this.online=null)}publish(e,t,n,s){return this.getIPNS().publish(e,t,n,s)}resolve(e,t){return this.getIPNS().resolve(e,t)}initializeKeyspace(e,t,n){return this.getIPNS().initializeKeyspace(e,t,n)}}async function oD({ipns:r,repo:e,codecs:t},n,s){if(v8(n))return r.resolve(n);const{cid:i,path:o}=Ha(n);await Et(Ca(i,o||"",t,e,s))}const Yd=O("ipfs:name:publish");function aD({ipns:r,repo:e,codecs:t,peerId:n,isOnline:s,keychain:i}){const o=async c=>{let u;if(c==="self"&&n.privateKey!=null)u=await oi(n.privateKey);else try{const l=await i.exportKey(c,"temp");u=await da(l,"temp")}catch(l){throw Yd.error(l),E(l,"ERR_CANNOT_GET_KEY")}return Sn(u.public.bytes,u.bytes)};async function a(c,u={}){const l=u.resolve!==!1,d=u.lifetime||"24h",f=u.key||"self";if(!s())throw E(new Error(T8),"OFFLINE_ERROR");try{c=SC(c)}catch(y){throw Yd.error(y),y}let g=0;try{g=ee(d)||0,g=parseFloat(g.toFixed(6))}catch(y){throw Yd.error(y),y}const h=await Promise.all([o(f),l?oD({ipns:r,repo:e,codecs:t},c):Promise.resolve()]),p=M(c),w=await r.publish(h[0],p,g,u);return{name:w.name,value:q(w.value)}}return x(a)}var cD=/^(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9])?\.){0,126}(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9]))\.?$/i,lD=function(e,t){if(t==null&&(t=!1),e.length<2||e.length>255)return!1;var n=e[e.length-1];if(t){if(n!==".")return!1}else if(n===".")return!1;return cD.test(e)};const uD=Le.bind({ignoreUndefined:!0}),dD=O("ipfs:name:resolve"),R3=(r,e)=>e.length>0?r+"/"+e.join("/"):r;function hD({dns:r,ipns:e,isOnline:t,options:{offline:n}}){async function*s(i,o={}){if(o=uD({nocache:!1,recursive:!0},o),n&&o&&o.nocache)throw E(new Error("cannot specify both offline and nocache"),"ERR_NOCACHE_AND_OFFLINE");if(!t()&&!n)throw E(new Error(T8),"OFFLINE_ERROR");let a=i.toString();a.startsWith("/ipns/")||(a=`/ipns/${a}`);let[c,u,...l]=a.slice(1).split("/");try{if(u.substring(0,1)==="1"){const f=re(u),g=r8(f.toBytes());u=V.createV1(114,g).toString($l)}else{const f=V.parse(u);f.version===1&&(u=f.toString($l))}}catch(f){if(lD(u)){yield R3(await r(u,o),l);return}throw dD.error(f),E(new Error("Invalid IPNS name"),"ERR_IPNS_INVALID_NAME")}const d=await e.resolve(`/${c}/${u}`,o);yield R3(d instanceof Uint8Array?q(d):d,l)}return x(s)}function W0(r,e){if(!r||!(e&&e.ipnsPubsub))throw E(new Error("IPNS pubsub subsystem is not enabled"),"ERR_IPNS_PUBSUB_NOT_ENABLED");if(r.routing instanceof Hf)return r.routing;const t=(r.routing.stores||[]).find(n=>n instanceof Hf);if(!t)throw E(new Error("IPNS pubsub datastore not found"),"ERR_PUBSUB_DATASTORE_NOT_FOUND");return t}function fD({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s,i={}){return W0(r,t).cancel(s,i)}return x(n)}function pD({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s={}){try{return{enabled:Boolean(W0(r,t))}}catch{return{enabled:!1}}}return x(n)}function gD({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s={}){return W0(r,t).getSubscriptions(s)}return x(n)}class yD{constructor({ipns:e,options:t}){this.cancel=fD({ipns:e,options:t}),this.state=pD({ipns:e,options:t}),this.subs=gD({ipns:e,options:t})}}class wD{constructor({dns:e,ipns:t,repo:n,codecs:s,peerId:i,isOnline:o,keychain:a,options:c}){this.publish=aD({ipns:t,repo:n,codecs:s,peerId:i,isOnline:o,keychain:a}),this.resolve=hD({dns:e,ipns:t,isOnline:o,options:c}),this.pubsub=new yD({ipns:t,options:c})}}const mD=Yr().code,Gf={default:"<dst>",edges:"<src> -> <dst>"};function bD({repo:r,codecs:e,resolve:t,preload:n}){async function*s(i,o={}){if(o.maxDepth===0)return;if(o.edges&&o.format&&o.format!==Gf.default)throw new Error("Cannot set edges to true and also specify format");if(o.format=o.edges?Gf.edges:o.format,typeof o.maxDepth!="number"&&(o.maxDepth=o.recursive?1/0:1),o.timeout){const l=[new $e.TimeoutController(o.timeout).signal];o.signal&&l.push(o.signal),o.signal=Jr(l)}const c=(Array.isArray(i)?i:[i]).map(u=>ED(n,u,o));for(const u of c)try{yield*_D(t,r,e,u,o)}catch(l){yield{ref:"",err:l.message}}}return s}function ED(r,e,t){const{cid:n,path:s}=Ha(e);return t.preload!==!1&&r(n),`/ipfs/${n}${s||""}`}async function*_D(r,e,t,n,s){const i=await r(n,s),{cid:o}=Ha(i),a=s.maxDepth!=null?s.maxDepth:1/0,c=s.unique||!1;for await(const u of SD(e,t,o,a,c,s))u.parent&&(u.isDuplicate||(yield{ref:vD(u.parent.cid,u.node.cid,u.node.name,s.format)}))}function vD(r,e,t="",n=Gf.default){let s=n.replace(/<src>/g,r.toString());return s=s.replace(/<dst>/g,e.toString()),s=s.replace(/<linkname>/g,t),s}async function*SD(r,e,t,n,s,i){const o=new Set;async function*a(c,u){const l=u+1;if(!(l>n))try{for await(const d of RD(r,e,c.cid,i))yield{parent:c,node:d,isDuplicate:s&&o.has(d.cid.toString())},s&&o.add(d.cid.toString()),yield*a(d,l)}catch(d){throw d.code===mD&&(d.message=`Could not find object with CID: ${c.cid}`),d}}yield*a({cid:t},0)}async function*RD(r,e,t,n){const s=await r.blocks.get(t,n),o=(await e.getCodec(t.code)).decode(s),a=t.code===Ne,c=[];for(const[u,l]of Wf(o,c)){if(a){const d=u.match(/^Links\/(\d+)\/Hash$/);if(d){const f=Number(d[1]);if(f<o.Links.length){yield{name:o.Links[f].Name,cid:l};continue}}}yield{name:u,cid:l}}}const Wf=function*(r,e){if(r!=null&&!(r instanceof Uint8Array)){for(const[t,n]of Object.entries(r)){const s=[...e,t];if(n!=null&&typeof n=="object")if(Array.isArray(n))for(const[i,o]of n.entries()){const a=[...s,i],c=V.asCID(o);c?yield[a.join("/"),c]:typeof o=="object"&&(yield*Wf(o,a))}else{const i=V.asCID(n);i?yield[s.join("/"),i]:yield*Wf(n,s)}}return[]}};function ID({repo:r}){async function*e(t={}){for await(const n of r.blocks.queryKeys({},{signal:t.signal}))yield{ref:n.toString()}}return x(e)}function AD({network:r}){async function e(t={}){const{bitswap:n}=await r.use(t),s=n.getWantlist();return Array.from(s).map(i=>i[1].cid)}return x(e)}function CD({network:r}){async function e(t,n={}){const{bitswap:s}=await r.use(n),i=s.wantlistForPeer(t);return Array.from(i).map(o=>o[1].cid)}return x(e)}function TD({network:r}){async function e(t,n={}){const{bitswap:s}=await r.use(n);return Array.isArray(t)||(t=[t]),s.unwant(t)}return x(e)}function q8({network:r}){async function e(t={}){const n=(await r.use(t)).bitswap,s=n.stat().snapshot;return{provideBufLen:parseInt(s.providesBufferLength.toString()),blocksReceived:BigInt(s.blocksReceived.toString()),wantlist:Array.from(n.getWantlist()).map(i=>i[1].cid),peers:n.peers(),dupBlksReceived:BigInt(s.dupBlksReceived.toString()),dupDataReceived:BigInt(s.dupDataReceived.toString()),dataReceived:BigInt(s.dataReceived.toString()),blocksSent:BigInt(s.blocksSent.toString()),dataSent:BigInt(s.dataSent.toString())}}return x(e)}class DD{constructor({network:e}){this.wantlist=AD({network:e}),this.wantlistForPeer=CD({network:e}),this.unwant=TD({network:e}),this.stat=q8({network:e})}}function H8(r){try{return EE.matches(r)}catch{return!1}}function PD({repo:r}){async function e(t,n={}){if(!H8(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await r.config.getAll(n),i=s.Bootstrap||[];return i.push(t.toString()),s.Bootstrap=Array.from(new Set(i)).sort((o,a)=>o.localeCompare(a)),await r.config.replace(s),{Peers:[t]}}return x(e)}function kD({repo:r}){async function e(t={}){const n=await r.config.getAll(t),s=n.Bootstrap||[];return n.Bootstrap=[],await r.config.replace(n),{Peers:s.map(i=>X(i))}}return x(e)}function OD({repo:r}){async function e(t={}){return{Peers:(await r.config.get("Bootstrap",t)||[]).map(s=>X(s))}}return x(e)}const $i=()=>({Addresses:{Swarm:[],Announce:[],NoAnnounce:[],API:"",Gateway:"",RPC:"",Delegates:["/dns4/node0.delegate.ipfs.io/tcp/443/https","/dns4/node1.delegate.ipfs.io/tcp/443/https","/dns4/node2.delegate.ipfs.io/tcp/443/https","/dns4/node3.delegate.ipfs.io/tcp/443/https"]},Discovery:{MDNS:{Enabled:!1,Interval:10},webRTCStar:{Enabled:!0}},Bootstrap:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"],Pubsub:{Enabled:!0},Swarm:{ConnMgr:{LowWater:5,HighWater:20},DisableNatPortMap:!0},Routing:{Type:"dhtclient"}});function ND({repo:r}){async function e(t={}){const n=await r.config.getAll(t);return n.Bootstrap=$i().Bootstrap,await r.config.replace(n),{Peers:$i().Bootstrap.map(s=>X(s))}}return x(e)}function xD({repo:r}){async function e(t,n={}){if(!H8(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await r.config.getAll(n);return s.Bootstrap=(s.Bootstrap||[]).filter(i=>i.toString()!==t.toString()),await r.config.replace(s),{Peers:[t]}}return x(e)}class $D{constructor({repo:e}){this.add=PD({repo:e}),this.list=OD({repo:e}),this.rm=xD({repo:e}),this.clear=kD({repo:e}),this.reset=ND({repo:e})}}function LD({preload:r,repo:e}){async function t(n,s={}){return s.preload!==!1&&r(n),e.blocks.get(n,s)}return x(t)}function MD({codecs:r,hashers:e,repo:t,preload:n}){async function s(i,o={}){const a=o.pin?await t.gcLock.readLock():null;try{const c=o.version!=null?o.version:0,u=o.format||(c===0?"dag-pb":"raw"),d=await(await e.getHasher(o.mhtype||"sha2-256")).digest(i),f=await r.getCodec(u),g=V.create(c,f.code,d);return await t.blocks.put(g,i,{signal:o.signal}),o.preload!==!1&&n(g),o.pin===!0&&await t.pins.pinRecursively(g,{signal:o.signal}),g}finally{a&&a()}}return x(s)}const gc=globalThis.CustomEvent??Event;async function*pd(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered==null?!1:e.ordered,s=new EventTarget,i=[];let o=Bt(),a=Bt(),c=!1,u,l=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const h of r){if(i.length===t&&(o=Bt(),await o.promise),l)break;const p={done:!1};i.push(p),h().then(w=>{p.done=!0,p.ok=!0,p.value=w,s.dispatchEvent(new gc("task-complete"))},w=>{p.done=!0,p.err=w,s.dispatchEvent(new gc("task-complete"))})}c=!0,s.dispatchEvent(new gc("task-complete"))}catch(h){u=h,s.dispatchEvent(new gc("task-complete"))}});function d(){return n?i[0]?.done:Boolean(i.find(h=>h.done))}function*f(){for(;i.length>0&&i[0].done;){const h=i[0];if(i.shift(),h.ok)yield h.value;else throw l=!0,o.resolve(),h.err;o.resolve()}}function*g(){for(;d();)for(let h=0;h<i.length;h++)if(i[h].done){const p=i[h];if(i.splice(h,1),h--,p.ok)yield p.value;else throw l=!0,o.resolve(),p.err;o.resolve()}}for(;;){if(d()||(a=Bt(),await a.promise),u!=null)throw u;if(n?yield*f():yield*g(),c&&i.length===0)break}}function G8(r){return r instanceof Uint8Array?V.decode(r):V.parse(r.toString())}const UD=8;function BD({repo:r}){async function*e(t,n={}){Array.isArray(t)||(t=[t]);const s=await r.gcLock.writeLock();try{yield*ne(t,i=>_t(i,o=>async()=>{o=G8(o);const a={cid:o};try{if(!await r.blocks.has(o))throw E(new Error("block not found"),"ERR_BLOCK_NOT_FOUND");await r.blocks.delete(o)}catch(c){n.force||(c.message=`cannot remove ${o}: ${c.message}`,a.error=c)}return a}),i=>pd(i,{concurrency:UD}),i=>Ze(i,()=>!n.quiet))}finally{s()}}return x(e)}function zD({repo:r,preload:e}){async function t(n,s={}){n=G8(n),s.preload!==!1&&e(n);const i=await r.blocks.get(n);return{cid:n,size:i.length}}return x(t)}class FD{constructor({codecs:e,hashers:t,preload:n,repo:s}){this.get=LD({preload:n,repo:s}),this.put=MD({codecs:e,hashers:t,preload:n,repo:s}),this.rm=BD({repo:s}),this.stat=zD({preload:n,repo:s})}}async function*Wi(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}function VD(r){return typeof r.stream=="function"?Wi(r.stream()):Wi(new Response(r).body)}function Ya(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function Os(r){return ArrayBuffer.isView(r)||r instanceof ArrayBuffer}function Da(r){return r.constructor&&(r.constructor.name==="Blob"||r.constructor.name==="File")&&typeof r.stream=="function"}function Yf(r){return typeof r=="object"&&(r.path||r.content)}const Pa=r=>r&&typeof r.getReader=="function";async function*yc(r){yield r}async function W8(r){if(Os(r))return yc(Qd(r));if(typeof r=="string"||r instanceof String)return yc(Qd(r.toString()));if(Da(r))return VD(r);if(Pa(r)&&(r=Wi(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const e=Ya(r),{value:t,done:n}=await e.peek();if(n)return yc(new Uint8Array(0));if(e.push(t),Number.isInteger(t))return yc(Uint8Array.from(await Dn(e)));if(Os(t)||typeof t=="string"||t instanceof String)return _t(e,Qd)}throw E(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT")}function Qd(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r instanceof ArrayBuffer?new Uint8Array(r):Array.isArray(r)?Uint8Array.from(r):M(r.toString())}async function*jD(r,e){if(r==null)throw E(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT");if(typeof r=="string"||r instanceof String){yield wc(r.toString(),e);return}if(Os(r)||Da(r)){yield wc(r,e);return}if(Pa(r)&&(r=Wi(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const t=Ya(r),{value:n,done:s}=await t.peek();if(s){yield{content:[]};return}if(t.push(n),Number.isInteger(n)||Os(n)||typeof n=="string"||n instanceof String){yield wc(t,e);return}throw E(new Error("Unexpected input: multiple items passed - if you are using ipfs.add, please use ipfs.addAll instead"),"ERR_UNEXPECTED_INPUT")}if(Yf(r)){yield wc(r,e);return}throw E(new Error('Unexpected input: cannot convert "'+typeof r+'" into ImportCandidate'),"ERR_UNEXPECTED_INPUT")}async function wc(r,e){const{path:t,mode:n,mtime:s,content:i}=r,o={path:t||"",mode:Ni(n),mtime:Aa(s)};return i?o.content=await e(i):t||(o.content=await e(r)),o}function Y8(r){return jD(r,W8)}function KD({addAll:r}){async function e(t,n={}){const s=await tr(r(Y8(t),n));if(s==null)throw Error("Failed to add a file, if you see this please report a bug");return s}return e}async function*Y0(r,e=1){let t=[];e<1&&(e=1);for await(const n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}async function*Q0(r,e=1){for await(const t of Y0(r,e)){const n=t.map(async s=>await s().then(i=>({ok:!0,value:i}),i=>({ok:!1,err:i})));for(let s=0;s<n.length;s++){const i=await n[s];if(i.ok)yield i.value;else throw i.err}}}const qD=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Qa=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var HD=Q8,I3=128,GD=127,WD=~GD,YD=Math.pow(2,31);function Q8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=YD;)e[t++]=r&255|I3,r/=128;for(;r&WD;)e[t++]=r&255|I3,r>>>=7;return e[t]=r|0,Q8.bytes=t-n+1,e}var QD=Qf,JD=128,A3=127;function Qf(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Qf.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&A3)<<s:(o&A3)*Math.pow(2,s),s+=7}while(o>=JD);return Qf.bytes=i-n,t}var XD=Math.pow(2,7),ZD=Math.pow(2,14),eP=Math.pow(2,21),tP=Math.pow(2,28),rP=Math.pow(2,35),nP=Math.pow(2,42),sP=Math.pow(2,49),iP=Math.pow(2,56),oP=Math.pow(2,63),aP=function(r){return r<XD?1:r<ZD?2:r<eP?3:r<tP?4:r<rP?5:r<nP?6:r<sP?7:r<iP?8:r<oP?9:10},cP={encode:HD,decode:QD,encodingLength:aP},Hl=cP;const Jf=(r,e=0)=>[Hl.decode(r,e),Hl.decode.bytes],Gl=(r,e,t=0)=>(Hl.encode(r,e,t),e),Wl=r=>Hl.encodingLength(r),Xf=(r,e)=>{const t=e.byteLength,n=Wl(r),s=n+Wl(t),i=new Uint8Array(s+t);return Gl(r,i,0),Gl(t,i,n),i.set(e,s),new J0(r,t,e,i)},lP=r=>{const e=Qa(r),[t,n]=Jf(e),[s,i]=Jf(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new J0(t,s,o,e)},uP=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&qD(r.bytes,t.bytes)}};let J0=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const J8=({name:r,code:e,encode:t})=>new dP(r,e,t);let dP=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Xf(this.code,t):t.then(n=>Xf(this.code,n))}else throw Error("Unknown type, must be binary type")}};const X8=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Zf=J8({name:"sha2-256",code:18,encode:X8("SHA-256")});J8({name:"sha2-512",code:19,encode:X8("SHA-512")});const hP=new Uint8Array(0),Z8=r=>{const e=r.match(/../g);return e?new Uint8Array(e.map(t=>parseInt(t,16))):hP},fP=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var pP=ew,C3=128,gP=127,yP=~gP,wP=Math.pow(2,31);function ew(r,e,t){e=e||[],t=t||0;for(var n=t;r>=wP;)e[t++]=r&255|C3,r/=128;for(;r&yP;)e[t++]=r&255|C3,r>>>=7;return e[t]=r|0,ew.bytes=t-n+1,e}var mP=e1,bP=128,T3=127;function e1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw e1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&T3)<<s:(o&T3)*Math.pow(2,s),s+=7}while(o>=bP);return e1.bytes=i-n,t}var EP=Math.pow(2,7),_P=Math.pow(2,14),vP=Math.pow(2,21),SP=Math.pow(2,28),RP=Math.pow(2,35),IP=Math.pow(2,42),AP=Math.pow(2,49),CP=Math.pow(2,56),TP=Math.pow(2,63),DP=function(r){return r<EP?1:r<_P?2:r<vP?3:r<SP?4:r<RP?5:r<IP?6:r<AP?7:r<CP?8:r<TP?9:10},PP={encode:pP,decode:mP,encodingLength:DP},tw=PP;const D3=(r,e,t=0)=>(tw.encode(r,e,t),e),P3=r=>tw.encodingLength(r),k3=(r,e)=>{const t=e.byteLength,n=P3(r),s=n+P3(t),i=new Uint8Array(s+t);return D3(r,i,0),D3(t,i,n),i.set(e,s),new kP(r,t,e,i)};let kP=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const X0=({name:r,code:e,encode:t})=>new OP(r,e,t);let OP=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?k3(this.code,t):t.then(n=>k3(this.code,n))}else throw Error("Unknown type, must be binary type")}};function NP(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var xP=NP,$P=xP;let LP=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},MP=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return rw(this,e)}},UP=class{constructor(e){this.decoders=e}or(e){return rw(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const rw=(r,e)=>new UP({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let BP=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new LP(e,t,n),this.decoder=new MP(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const nw=({name:r,prefix:e,encode:t,decode:n})=>new BP(r,e,t,n),sw=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=$P(t,e);return nw({prefix:r,name:e,encode:n,decode:i=>fP(s(i))})},zP=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},FP=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Pn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>nw({prefix:e,name:r,encode(s){return FP(s,n,t)},decode(s){return zP(s,n,t,r)}});sw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});sw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});Pn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Pn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Pn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Pn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Pn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Pn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Pn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Pn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Pn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var t1={},VP={get exports(){return t1},set exports(r){t1=r}},Yl={},jP={get exports(){return Yl},set exports(r){Yl=r}};(function(r,e){(function(t,n){var s={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(p){if(!Array.isArray(p)&&!ArrayBuffer.isView(p))return!1;for(var w=0;w<p.length;w++)if(!Number.isInteger(p[w])||p[w]<0||p[w]>255)return!1;return!0}function o(p,w){return(p&65535)*w+(((p>>>16)*w&65535)<<16)}function a(p,w){return p<<w|p>>>32-w}function c(p){return p^=p>>>16,p=o(p,2246822507),p^=p>>>13,p=o(p,3266489909),p^=p>>>16,p}function u(p,w){p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var y=[0,0,0,0];return y[3]+=p[3]+w[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=p[2]+w[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=p[1]+w[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=p[0]+w[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function l(p,w){p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var y=[0,0,0,0];return y[3]+=p[3]*w[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=p[2]*w[3],y[1]+=y[2]>>>16,y[2]&=65535,y[2]+=p[3]*w[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=p[1]*w[3],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=p[2]*w[2],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=p[3]*w[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=p[0]*w[3]+p[1]*w[2]+p[2]*w[1]+p[3]*w[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function d(p,w){return w%=64,w===32?[p[1],p[0]]:w<32?[p[0]<<w|p[1]>>>32-w,p[1]<<w|p[0]>>>32-w]:(w-=32,[p[1]<<w|p[0]>>>32-w,p[0]<<w|p[1]>>>32-w])}function f(p,w){return w%=64,w===0?p:w<32?[p[0]<<w|p[1]>>>32-w,p[1]<<w]:[p[1]<<w-32,0]}function g(p,w){return[p[0]^w[0],p[1]^w[1]]}function h(p){return p=g(p,[0,p[0]>>>1]),p=l(p,[4283543511,3981806797]),p=g(p,[0,p[0]>>>1]),p=l(p,[3301882366,444984403]),p=g(p,[0,p[0]>>>1]),p}s.x86.hash32=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%4,_=p.length-y,b=w,m=0,S=3432918353,R=461845907,v=0;v<_;v=v+4)m=p[v]|p[v+1]<<8|p[v+2]<<16|p[v+3]<<24,m=o(m,S),m=a(m,15),m=o(m,R),b^=m,b=a(b,13),b=o(b,5)+3864292196;switch(m=0,y){case 3:m^=p[v+2]<<16;case 2:m^=p[v+1]<<8;case 1:m^=p[v],m=o(m,S),m=a(m,15),m=o(m,R),b^=m}return b^=p.length,b=c(b),b>>>0},s.x86.hash128=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%16,_=p.length-y,b=w,m=w,S=w,R=w,v=0,A=0,C=0,P=0,$=597399067,F=2869860233,W=951274213,Q=2716044179,z=0;z<_;z=z+16)v=p[z]|p[z+1]<<8|p[z+2]<<16|p[z+3]<<24,A=p[z+4]|p[z+5]<<8|p[z+6]<<16|p[z+7]<<24,C=p[z+8]|p[z+9]<<8|p[z+10]<<16|p[z+11]<<24,P=p[z+12]|p[z+13]<<8|p[z+14]<<16|p[z+15]<<24,v=o(v,$),v=a(v,15),v=o(v,F),b^=v,b=a(b,19),b+=m,b=o(b,5)+1444728091,A=o(A,F),A=a(A,16),A=o(A,W),m^=A,m=a(m,17),m+=S,m=o(m,5)+197830471,C=o(C,W),C=a(C,17),C=o(C,Q),S^=C,S=a(S,15),S+=R,S=o(S,5)+2530024501,P=o(P,Q),P=a(P,18),P=o(P,$),R^=P,R=a(R,13),R+=b,R=o(R,5)+850148119;switch(v=0,A=0,C=0,P=0,y){case 15:P^=p[z+14]<<16;case 14:P^=p[z+13]<<8;case 13:P^=p[z+12],P=o(P,Q),P=a(P,18),P=o(P,$),R^=P;case 12:C^=p[z+11]<<24;case 11:C^=p[z+10]<<16;case 10:C^=p[z+9]<<8;case 9:C^=p[z+8],C=o(C,W),C=a(C,17),C=o(C,Q),S^=C;case 8:A^=p[z+7]<<24;case 7:A^=p[z+6]<<16;case 6:A^=p[z+5]<<8;case 5:A^=p[z+4],A=o(A,F),A=a(A,16),A=o(A,W),m^=A;case 4:v^=p[z+3]<<24;case 3:v^=p[z+2]<<16;case 2:v^=p[z+1]<<8;case 1:v^=p[z],v=o(v,$),v=a(v,15),v=o(v,F),b^=v}return b^=p.length,m^=p.length,S^=p.length,R^=p.length,b+=m,b+=S,b+=R,m+=b,S+=b,R+=b,b=c(b),m=c(m),S=c(S),R=c(R),b+=m,b+=S,b+=R,m+=b,S+=b,R+=b,("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(m>>>0).toString(16)).slice(-8)+("00000000"+(S>>>0).toString(16)).slice(-8)+("00000000"+(R>>>0).toString(16)).slice(-8)},s.x64.hash128=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%16,_=p.length-y,b=[0,w],m=[0,w],S=[0,0],R=[0,0],v=[2277735313,289559509],A=[1291169091,658871167],C=0;C<_;C=C+16)S=[p[C+4]|p[C+5]<<8|p[C+6]<<16|p[C+7]<<24,p[C]|p[C+1]<<8|p[C+2]<<16|p[C+3]<<24],R=[p[C+12]|p[C+13]<<8|p[C+14]<<16|p[C+15]<<24,p[C+8]|p[C+9]<<8|p[C+10]<<16|p[C+11]<<24],S=l(S,v),S=d(S,31),S=l(S,A),b=g(b,S),b=d(b,27),b=u(b,m),b=u(l(b,[0,5]),[0,1390208809]),R=l(R,A),R=d(R,33),R=l(R,v),m=g(m,R),m=d(m,31),m=u(m,b),m=u(l(m,[0,5]),[0,944331445]);switch(S=[0,0],R=[0,0],y){case 15:R=g(R,f([0,p[C+14]],48));case 14:R=g(R,f([0,p[C+13]],40));case 13:R=g(R,f([0,p[C+12]],32));case 12:R=g(R,f([0,p[C+11]],24));case 11:R=g(R,f([0,p[C+10]],16));case 10:R=g(R,f([0,p[C+9]],8));case 9:R=g(R,[0,p[C+8]]),R=l(R,A),R=d(R,33),R=l(R,v),m=g(m,R);case 8:S=g(S,f([0,p[C+7]],56));case 7:S=g(S,f([0,p[C+6]],48));case 6:S=g(S,f([0,p[C+5]],40));case 5:S=g(S,f([0,p[C+4]],32));case 4:S=g(S,f([0,p[C+3]],24));case 3:S=g(S,f([0,p[C+2]],16));case 2:S=g(S,f([0,p[C+1]],8));case 1:S=g(S,[0,p[C]]),S=l(S,v),S=d(S,31),S=l(S,A),b=g(b,S)}return b=g(b,[0,p.length]),m=g(m,[0,p.length]),b=u(b,m),m=u(m,b),b=h(b),m=h(m),b=u(b,m),m=u(m,b),("00000000"+(b[0]>>>0).toString(16)).slice(-8)+("00000000"+(b[1]>>>0).toString(16)).slice(-8)+("00000000"+(m[0]>>>0).toString(16)).slice(-8)+("00000000"+(m[1]>>>0).toString(16)).slice(-8)},r.exports&&(e=r.exports=s),e.murmurHash3=s})()})(jP,Yl);(function(r){r.exports=Yl})(VP);const Z0=E0(t1);function KP(r){const e=new Array(4);for(let t=0;t<4;t++)e[t]=r&255,r=r>>8;return new Uint8Array(e)}X0({name:"murmur3-32",code:35,encode:r=>KP(Z0.x86.hash32(r))});const gd=X0({name:"murmur3-128",code:34,encode:r=>Z8(Z0.x64.hash128(r))});X0({name:"murmur3-x64-64",code:34,encode:r=>Z8(Z0.x64.hash128(r)).subarray(0,8)});async function qP(r){return(await gd.encode(r)).slice(0,8).reverse()}const HP={chunker:"fixed",strategy:"balanced",rawLeaves:!1,onlyHash:!1,reduceSingleLeafToSelf:!0,hasher:Zf,leafType:"file",cidVersion:0,progress:()=>()=>{},shardSplitThreshold:1e3,fileImportConcurrency:50,blockWriteConcurrency:10,minChunkSize:262144,maxChunkSize:262144,avgChunkSize:262144,window:16,polynomial:0x3df305dfb2a804,maxChildrenPerNode:174,layerRepeat:4,wrapWithDirectory:!1,recursive:!1,hidden:!1,timeout:void 0,hamtHashFn:qP,hamtHashCode:34,hamtBucketBits:8},GP=(r={})=>Le.bind({ignoreUndefined:!0})(HP,r);function WP(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var YP=WP,QP=YP;let JP=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},XP=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return iw(this,e)}},ZP=class{constructor(e){this.decoders=e}or(e){return iw(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const iw=(r,e)=>new ZP({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let ek=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new JP(e,t,n),this.decoder=new XP(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const ow=({name:r,prefix:e,encode:t,decode:n})=>new ek(r,e,t,n),aw=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=QP(t,e);return ow({prefix:r,name:e,encode:n,decode:i=>Qa(s(i))})},tk=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},rk=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},kn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>ow({prefix:e,name:r,encode(s){return rk(s,n,t)},decode(s){return tk(s,n,t,r)}}),ns=aw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});aw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const nl=kn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});kn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});kn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});kn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});kn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});kn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});kn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});kn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});kn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const nk=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return ik(t,r1(r),e||ns.encoder);default:return ok(t,r1(r),e||nl.encoder)}},O3=new WeakMap,r1=r=>{const e=O3.get(r);if(e==null){const t=new Map;return O3.set(r,t),t}return e};let Rt=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Po)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==ak)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Rt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Xf(e,t);return Rt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Rt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&uP(e.multihash,n.multihash)}toString(e){return nk(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Rt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Rt(n,s,i,o||N3(n,s,i.bytes))}else if(t[ck]===!0){const{version:n,multihash:s,code:i}=t,o=lP(s);return Rt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Po)throw new Error(`Version 0 CID must use dag-pb (code: ${Po}) block encoding`);return new Rt(e,t,n,n.bytes)}case 1:{const s=N3(e,t,n.bytes);return new Rt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Rt.create(0,Po,e)}static createV1(e,t){return Rt.create(1,e,t)}static decode(e){const[t,n]=Rt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Rt.inspectBytes(e),n=t.size-t.multihashSize,s=Qa(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new J0(t.multihashCode,t.digestSize,i,s);return[t.version===0?Rt.createV0(o):Rt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Jf(e.subarray(t));return t+=f,d};let s=n(),i=Po;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=sk(e,t),i=Rt.decode(s);return r1(i).set(n,e),i}};const sk=(r,e)=>{switch(r[0]){case"Q":{const t=e||ns;return[ns.prefix,t.decode(`${ns.prefix}${r}`)]}case ns.prefix:{const t=e||ns;return[ns.prefix,t.decode(r)]}case nl.prefix:{const t=e||nl;return[nl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},ik=(r,e,t)=>{const{prefix:n}=t;if(n!==ns.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},ok=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Po=112,ak=18,N3=(r,e,t)=>{const n=Wl(r),s=n+Wl(e),i=new Uint8Array(s+t.byteLength);return Gl(r,i,0),Gl(e,i,n),i.set(t,s),i},ck=Symbol.for("@ipld/js-cid/CID"),Yi=async(r,e,t)=>{t.codec||(t.codec=ks),t.hasher||(t.hasher=Zf),t.cidVersion===void 0&&(t.cidVersion=1),t.codec===ks&&t.hasher!==Zf&&(t.cidVersion=1);const n=await t.hasher.digest(r),s=Rt.create(t.cidVersion,t.codec.code,n);return t.onlyHash||await e.put(s,r,{signal:t.signal}),s},lk=async(r,e,t)=>{const n=new Ce({type:"directory",mtime:r.mtime,mode:r.mode}),s=Re(Wr({Data:n.marshal()})),i=await Yi(s,e,t),o=r.path;return{cid:i,path:o,unixfs:n,size:s.length}},uk="raw",n1=85,dk=r=>Qa(r),hk=r=>Qa(r),fk=Object.freeze(Object.defineProperty({__proto__:null,code:n1,decode:hk,encode:dk,name:uk},Symbol.toStringTag,{value:"Module"}));async function pk(r,e){return e(await Dn(r))}function gk(r,e,t){return cw(r,e,t)}async function cw(r,e,t){const n=[];for await(const s of Y0(r,t.maxChildrenPerNode))n.push(await e(s));return n.length>1?cw(n,e,t):n[0]}async function yk(r,e,t){const n=new wk(t.layerRepeat);let s=0,i=1,o=n;for await(const a of Y0(r,t.maxChildrenPerNode))o.isFull()&&(o!==n&&n.addChild(await o.reduce(e)),s&&s%t.layerRepeat===0&&i++,o=new lw(i,t.layerRepeat,s),s++),o.append(a);return o&&o!==n&&n.addChild(await o.reduce(e)),n.reduce(e)}class lw{constructor(e,t,n=0){this.maxDepth=e,this.layerRepeat=t,this.currentDepth=1,this.iteration=n,this.root=this.node=this.parent={children:[],depth:this.currentDepth,maxDepth:e,maxChildren:(this.maxDepth-this.currentDepth)*this.layerRepeat}}isFull(){if(!this.root.data)return!1;if(this.currentDepth<this.maxDepth&&this.node.maxChildren)return this._addNextNodeToParent(this.node),!1;const e=this._findParent(this.node,this.currentDepth);return e?(this._addNextNodeToParent(e),!1):!0}_addNextNodeToParent(e){this.parent=e;const t={children:[],depth:e.depth+1,parent:e,maxDepth:this.maxDepth,maxChildren:Math.floor(e.children.length/this.layerRepeat)*this.layerRepeat};e.children.push(t),this.currentDepth=t.depth,this.node=t}append(e){this.node.data=e}reduce(e){return this._reduce(this.root,e)}async _reduce(e,t){let n=[];return e.children.length&&(n=await Promise.all(e.children.filter(s=>s.data).map(s=>this._reduce(s,t)))),t((e.data||[]).concat(n))}_findParent(e,t){const n=e.parent;if(!(!n||n.depth===0))return n.children.length===n.maxChildren||!n.maxChildren?this._findParent(n,t):n}}class wk extends lw{constructor(e){super(0,e),this.root.depth=0,this.currentDepth=1}addChild(e){this.root.children.push(e)}reduce(e){return e((this.root.data||[]).concat(this.root.children))}}async function*mk(r,e,t){for await(let n of r.content)yield async()=>{t.progress(n.length,r.path);let s;const i={codec:ks,cidVersion:t.cidVersion,hasher:t.hasher,onlyHash:t.onlyHash};return t.rawLeaves?(i.codec=fk,i.cidVersion=1):(s=new Ce({type:t.leafType,data:n}),n=Re({Data:s.marshal(),Links:[]})),{cid:await Yi(n,e,i),unixfs:s,size:n.length}}}const bk={flat:pk,balanced:gk,trickle:yk};async function*Ek(r,e,t){let n=-1,s,i;typeof t.bufferImporter=="function"?i=t.bufferImporter:i=mk;for await(const o of Q0(i(r,e,t),t.blockWriteConcurrency)){if(n++,n===0){s=o;continue}else n===1&&s&&(yield s,s=null);yield o}s&&(s.single=!0,yield s)}const _k=(r,e,t)=>{async function n(s){if(s.length===1&&s[0].single&&t.reduceSingleLeafToSelf){const l=s[0];if(r.mtime!==void 0||r.mode!==void 0){let d=await e.get(l.cid);l.unixfs=new Ce({type:"file",mtime:r.mtime,mode:r.mode,data:d}),d=Re(Wr({Data:l.unixfs.marshal()})),l.cid=await Yi(d,e,{...t,codec:ks,hasher:t.hasher,cidVersion:t.cidVersion}),l.size=d.length}return{cid:l.cid,path:r.path,unixfs:l.unixfs,size:l.size}}const i=new Ce({type:"file",mtime:r.mtime,mode:r.mode}),o=s.filter(l=>l.cid.code===n1&&l.size||l.unixfs&&!l.unixfs.data&&l.unixfs.fileSize()?!0:Boolean(l.unixfs&&l.unixfs.data&&l.unixfs.data.length)).map(l=>l.cid.code===n1?(i.addBlockSize(l.size),{Name:"",Tsize:l.size,Hash:l.cid}):(!l.unixfs||!l.unixfs.data?i.addBlockSize(l.unixfs&&l.unixfs.fileSize()||0):i.addBlockSize(l.unixfs.data.length),{Name:"",Tsize:l.size,Hash:l.cid})),a={Data:i.marshal(),Links:o},c=Re(Wr(a));return{cid:await Yi(c,e,t),path:r.path,unixfs:i,size:c.length+a.Links.reduce((l,d)=>l+d.Tsize,0)}}return n};function vk(r,e,t){const n=bk[t.strategy];if(!n)throw E(new Error(`Unknown importer build strategy name: ${t.strategy}`),"ERR_BAD_STRATEGY");return n(Ek(r,e,t),_k(r,e,t),t)}let Sk=class{constructor(e,t=12,n=8*1024,s=32*1024,i=64,o){this.bits=t,this.min=n,this.max=s,this.asModule=e,this.rabin=new e.Rabin(t,n,s,i,o),this.polynomial=o}fingerprint(e){const{__retain:t,__release:n,__allocArray:s,__getInt32Array:i,Int32Array_ID:o,Uint8Array_ID:a}=this.asModule,c=new Int32Array(Math.ceil(e.length/this.min)),u=t(s(o,c)),l=t(s(a,e)),d=this.rabin.fingerprint(l,u),f=i(d);n(l),n(u);const g=f.indexOf(0);return g>=0?f.subarray(0,g):f}};var Rk=Sk,Ja={};const Jd=-8,sl=-4,Ik=0,x3=1,$3=1<<0,mc=1<<1,Ak=5,L3=1<<10,M3=1<<11,Ck=1<<13,Tk=0,Xd=4,Dk=8,Pk=12,U3=12,kk=16,Ok=typeof BigUint64Array<"u",ko=Symbol(),Oo=1024;function uw(r,e){const t=new Uint32Array(r),n=new Uint16Array(r);var s=t[e+sl>>>2]>>>1,i=e>>>1;if(s<=Oo)return String.fromCharCode.apply(String,n.subarray(i,i+s));const o=[];do{const a=n[i+Oo-1],c=a>=55296&&a<56320?Oo-1:Oo;o.push(String.fromCharCode.apply(String,n.subarray(i,i+=c))),s-=c}while(s>Oo);return o.join("")+String.fromCharCode.apply(String,n.subarray(i,i+s))}function e2(r){const e={};function t(s,i){return s?uw(s.buffer,i):"<yet unknown>"}const n=r.env=r.env||{};return n.abort=n.abort||function(i,o,a,c){const u=e.memory||n.memory;throw Error("abort: "+t(u,i)+" at "+t(u,o)+":"+a+":"+c)},n.trace=n.trace||function(i,o){const a=e.memory||n.memory;console.log("trace: "+t(a,i)+(o?" ":"")+Array.prototype.slice.call(arguments,2,2+o).join(", "))},r.Math=r.Math||Math,r.Date=r.Date||Date,e}function t2(r,e){const t=e.exports,n=t.memory,s=t.table,i=t.__alloc,o=t.__retain,a=t.__rtti_base||-1;function c(S){const R=new Uint32Array(n.buffer),v=R[a>>>2];if((S>>>=0)>=v)throw Error("invalid id: "+S);return R[(a+4>>>2)+S*2]}function u(S){const R=new Uint32Array(n.buffer),v=R[a>>>2];if((S>>>=0)>=v)throw Error("invalid id: "+S);return R[(a+4>>>2)+S*2+1]}function l(S){return 31-Math.clz32(S>>>Ak&31)}function d(S){const R=S.length,v=i(R<<1,x3),A=new Uint16Array(n.buffer);for(var C=0,P=v>>>1;C<R;++C)A[P+C]=S.charCodeAt(C);return v}r.__allocString=d;function f(S){const R=n.buffer;if(new Uint32Array(R)[S+Jd>>>2]!==x3)throw Error("not a string: "+S);return uw(R,S)}r.__getString=f;function g(S,R,v){const A=n.buffer;if(v)switch(S){case 2:return new Float32Array(A);case 3:return new Float64Array(A)}else switch(S){case 0:return new(R?Int8Array:Uint8Array)(A);case 1:return new(R?Int16Array:Uint16Array)(A);case 2:return new(R?Int32Array:Uint32Array)(A);case 3:return new(R?BigInt64Array:BigUint64Array)(A)}throw Error("unsupported align: "+S)}function h(S,R){const v=c(S);if(!(v&($3|mc)))throw Error("not an array: "+S+" @ "+v);const A=l(v),C=R.length,P=i(C<<A,Ik),$=i(v&mc?kk:Pk,S),F=new Uint32Array(n.buffer);F[$+Tk>>>2]=o(P),F[$+Xd>>>2]=P,F[$+Dk>>>2]=C<<A,v&mc&&(F[$+U3>>>2]=C);const W=g(A,v&L3,v&M3);if(v&Ck)for(let Q=0;Q<C;++Q)W[(P>>>A)+Q]=o(R[Q]);else W.set(R,P>>>A);return $}r.__allocArray=h;function p(S){const R=new Uint32Array(n.buffer),v=R[S+Jd>>>2],A=c(v);if(!(A&$3))throw Error("not an array: "+v);const C=l(A);var P=R[S+Xd>>>2];const $=A&mc?R[S+U3>>>2]:R[P+sl>>>2]>>>C;return g(C,A&L3,A&M3).subarray(P>>>=C,P+$)}r.__getArrayView=p;function w(S){const R=p(S),v=R.length,A=new Array(v);for(let C=0;C<v;C++)A[C]=R[C];return A}r.__getArray=w;function y(S){const R=n.buffer,v=new Uint32Array(R)[S+sl>>>2];return R.slice(S,S+v)}r.__getArrayBuffer=y;function _(S,R,v){return new S(b(S,R,v))}function b(S,R,v){const A=n.buffer,C=new Uint32Array(A),P=C[v+Xd>>>2];return new S(A,P,C[P+sl>>>2]>>>R)}r.__getInt8Array=_.bind(null,Int8Array,0),r.__getInt8ArrayView=b.bind(null,Int8Array,0),r.__getUint8Array=_.bind(null,Uint8Array,0),r.__getUint8ArrayView=b.bind(null,Uint8Array,0),r.__getUint8ClampedArray=_.bind(null,Uint8ClampedArray,0),r.__getUint8ClampedArrayView=b.bind(null,Uint8ClampedArray,0),r.__getInt16Array=_.bind(null,Int16Array,1),r.__getInt16ArrayView=b.bind(null,Int16Array,1),r.__getUint16Array=_.bind(null,Uint16Array,1),r.__getUint16ArrayView=b.bind(null,Uint16Array,1),r.__getInt32Array=_.bind(null,Int32Array,2),r.__getInt32ArrayView=b.bind(null,Int32Array,2),r.__getUint32Array=_.bind(null,Uint32Array,2),r.__getUint32ArrayView=b.bind(null,Uint32Array,2),Ok&&(r.__getInt64Array=_.bind(null,BigInt64Array,3),r.__getInt64ArrayView=b.bind(null,BigInt64Array,3),r.__getUint64Array=_.bind(null,BigUint64Array,3),r.__getUint64ArrayView=b.bind(null,BigUint64Array,3)),r.__getFloat32Array=_.bind(null,Float32Array,2),r.__getFloat32ArrayView=b.bind(null,Float32Array,2),r.__getFloat64Array=_.bind(null,Float64Array,3),r.__getFloat64ArrayView=b.bind(null,Float64Array,3);function m(S,R){const v=new Uint32Array(n.buffer);var A=v[S+Jd>>>2];if(A<=v[a>>>2])do if(A==R)return!0;while(A=u(A));return!1}return r.__instanceof=m,r.memory=r.memory||n,r.table=r.table||s,pw(t,r)}function dw(r){return typeof Response<"u"&&r instanceof Response}async function hw(r,e){return dw(r=await r)?fw(r,e):t2(e2(e||(e={})),await WebAssembly.instantiate(r instanceof WebAssembly.Module?r:await WebAssembly.compile(r),e))}Ja.instantiate=hw;function Nk(r,e){return t2(e2(e||(e={})),new WebAssembly.Instance(r instanceof WebAssembly.Module?r:new WebAssembly.Module(r),e))}Ja.instantiateSync=Nk;async function fw(r,e){return WebAssembly.instantiateStreaming?t2(e2(e||(e={})),(await WebAssembly.instantiateStreaming(r,e)).instance):hw(dw(r=await r)?r.arrayBuffer():r,e)}Ja.instantiateStreaming=fw;function pw(r,e){var t=e?Object.create(e):{},n=r.__argumentsLength?function(s){r.__argumentsLength.value=s}:r.__setArgumentsLength||r.__setargc||function(){};for(let s in r){if(!Object.prototype.hasOwnProperty.call(r,s))continue;const i=r[s];let o=s.split("."),a=t;for(;o.length>1;){let l=o.shift();Object.prototype.hasOwnProperty.call(a,l)||(a[l]={}),a=a[l]}let c=o[0],u=c.indexOf("#");if(u>=0){let l=c.substring(0,u),d=a[l];if(typeof d>"u"||!d.prototype){let f=function(...g){return f.wrap(f.prototype.constructor(0,...g))};f.prototype={valueOf:function(){return this[ko]}},f.wrap=function(g){return Object.create(f.prototype,{[ko]:{value:g,writable:!1}})},d&&Object.getOwnPropertyNames(d).forEach(g=>Object.defineProperty(f,g,Object.getOwnPropertyDescriptor(d,g))),a[l]=f}if(c=c.substring(u+1),a=a[l].prototype,/^(get|set):/.test(c)){if(!Object.prototype.hasOwnProperty.call(a,c=c.substring(4))){let f=r[s.replace("set:","get:")],g=r[s.replace("get:","set:")];Object.defineProperty(a,c,{get:function(){return f(this[ko])},set:function(h){g(this[ko],h)},enumerable:!0})}}else c==="constructor"?(a[c]=(...f)=>(n(f.length),i(...f))).original=i:(a[c]=function(...f){return n(f.length),i(this[ko],...f)}).original=i}else/^(get|set):/.test(c)?Object.prototype.hasOwnProperty.call(a,c=c.substring(4))||Object.defineProperty(a,c,{get:r[s.replace("set:","get:")],set:r[s.replace("get:","set:")],enumerable:!0}):typeof i=="function"&&i!==n?(a[c]=(...l)=>(n(l.length),i(...l))).original=i:a[c]=i}return t}Ja.demangle=pw;const{instantiate:xk}=Ja;r2.supported=typeof WebAssembly<"u";function r2(r={}){if(!r2.supported)return null;var e=new Uint8Array([0,97,115,109,1,0,0,0,1,78,14,96,2,127,126,0,96,1,127,1,126,96,2,127,127,0,96,1,127,1,127,96,1,127,0,96,2,127,127,1,127,96,3,127,127,127,1,127,96,0,0,96,3,127,127,127,0,96,0,1,127,96,4,127,127,127,127,0,96,5,127,127,127,127,127,1,127,96,1,126,1,127,96,2,126,126,1,126,2,13,1,3,101,110,118,5,97,98,111,114,116,0,10,3,54,53,2,2,8,9,3,5,2,8,6,5,3,4,2,6,9,12,13,2,5,11,3,2,3,2,3,2,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,6,7,7,4,4,5,3,1,0,1,6,47,9,127,1,65,0,11,127,1,65,0,11,127,0,65,3,11,127,0,65,4,11,127,1,65,0,11,127,1,65,0,11,127,1,65,0,11,127,0,65,240,2,11,127,0,65,6,11,7,240,5,41,6,109,101,109,111,114,121,2,0,7,95,95,97,108,108,111,99,0,10,8,95,95,114,101,116,97,105,110,0,11,9,95,95,114,101,108,101,97,115,101,0,12,9,95,95,99,111,108,108,101,99,116,0,51,11,95,95,114,116,116,105,95,98,97,115,101,3,7,13,73,110,116,51,50,65,114,114,97,121,95,73,68,3,2,13,85,105,110,116,56,65,114,114,97,121,95,73,68,3,3,6,100,101,103,114,101,101,0,16,3,109,111,100,0,17,5,82,97,98,105,110,3,8,16,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,0,21,16,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,0,22,21,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,23,21,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,24,14,82,97,98,105,110,35,103,101,116,58,119,112,111,115,0,25,14,82,97,98,105,110,35,115,101,116,58,119,112,111,115,0,26,15,82,97,98,105,110,35,103,101,116,58,99,111,117,110,116,0,27,15,82,97,98,105,110,35,115,101,116,58,99,111,117,110,116,0,28,13,82,97,98,105,110,35,103,101,116,58,112,111,115,0,29,13,82,97,98,105,110,35,115,101,116,58,112,111,115,0,30,15,82,97,98,105,110,35,103,101,116,58,115,116,97,114,116,0,31,15,82,97,98,105,110,35,115,101,116,58,115,116,97,114,116,0,32,16,82,97,98,105,110,35,103,101,116,58,100,105,103,101,115,116,0,33,16,82,97,98,105,110,35,115,101,116,58,100,105,103,101,115,116,0,34,21,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,35,21,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,36,22,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,37,22,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,38,31,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,39,31,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,40,20,82,97,98,105,110,35,103,101,116,58,112,111,108,121,110,111,109,105,97,108,0,41,20,82,97,98,105,110,35,115,101,116,58,112,111,108,121,110,111,109,105,97,108,0,42,17,82,97,98,105,110,35,103,101,116,58,109,105,110,115,105,122,101,0,43,17,82,97,98,105,110,35,115,101,116,58,109,105,110,115,105,122,101,0,44,17,82,97,98,105,110,35,103,101,116,58,109,97,120,115,105,122,101,0,45,17,82,97,98,105,110,35,115,101,116,58,109,97,120,115,105,122,101,0,46,14,82,97,98,105,110,35,103,101,116,58,109,97,115,107,0,47,14,82,97,98,105,110,35,115,101,116,58,109,97,115,107,0,48,17,82,97,98,105,110,35,99,111,110,115,116,114,117,99,116,111,114,0,20,17,82,97,98,105,110,35,102,105,110,103,101,114,112,114,105,110,116,0,49,8,1,50,10,165,31,53,199,1,1,4,127,32,1,40,2,0,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,3,65,4,107,118,65,16,115,33,4,32,3,65,7,107,11,33,3,32,1,40,2,20,33,2,32,1,40,2,16,34,5,4,64,32,5,32,2,54,2,20,11,32,2,4,64,32,2,32,5,54,2,16,11,32,1,32,0,32,4,32,3,65,4,116,106,65,2,116,106,40,2,96,70,4,64,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,2,54,2,96,32,2,69,4,64,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,65,127,115,113,34,1,54,2,4,32,1,69,4,64,32,0,32,0,40,2,0,65,1,32,3,116,65,127,115,113,54,2,0,11,11,11,11,226,2,1,6,127,32,1,40,2,0,33,3,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,34,5,65,1,113,4,64,32,3,65,124,113,65,16,106,32,5,65,124,113,106,34,2,65,240,255,255,255,3,73,4,64,32,0,32,4,16,1,32,1,32,2,32,3,65,3,113,114,34,3,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,33,5,11,11,32,3,65,2,113,4,64,32,1,65,4,107,40,2,0,34,2,40,2,0,34,6,65,124,113,65,16,106,32,3,65,124,113,106,34,7,65,240,255,255,255,3,73,4,64,32,0,32,2,16,1,32,2,32,7,32,6,65,3,113,114,34,3,54,2,0,32,2,33,1,11,11,32,4,32,5,65,2,114,54,2,0,32,4,65,4,107,32,1,54,2,0,32,0,32,3,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,2,65,4,107,118,65,16,115,33,4,32,2,65,7,107,11,34,3,65,4,116,32,4,106,65,2,116,106,40,2,96,33,2,32,1,65,0,54,2,16,32,1,32,2,54,2,20,32,2,4,64,32,2,32,1,54,2,16,11,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,1,54,2,96,32,0,32,0,40,2,0,65,1,32,3,116,114,54,2,0,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,114,54,2,4,11,119,1,1,127,32,2,2,127,32,0,40,2,160,12,34,2,4,64,32,2,32,1,65,16,107,70,4,64,32,2,40,2,0,33,3,32,1,65,16,107,33,1,11,11,32,1,11,107,34,2,65,48,73,4,64,15,11,32,1,32,3,65,2,113,32,2,65,32,107,65,1,114,114,54,2,0,32,1,65,0,54,2,16,32,1,65,0,54,2,20,32,1,32,2,106,65,16,107,34,2,65,2,54,2,0,32,0,32,2,54,2,160,12,32,0,32,1,16,2,11,155,1,1,3,127,35,0,34,0,69,4,64,65,1,63,0,34,0,74,4,127,65,1,32,0,107,64,0,65,0,72,5,65,0,11,4,64,0,11,65,176,3,34,0,65,0,54,2,0,65,208,15,65,0,54,2,0,3,64,32,1,65,23,73,4,64,32,1,65,2,116,65,176,3,106,65,0,54,2,4,65,0,33,2,3,64,32,2,65,16,73,4,64,32,1,65,4,116,32,2,106,65,2,116,65,176,3,106,65,0,54,2,96,32,2,65,1,106,33,2,12,1,11,11,32,1,65,1,106,33,1,12,1,11,11,65,176,3,65,224,15,63,0,65,16,116,16,3,65,176,3,36,0,11,32,0,11,45,0,32,0,65,240,255,255,255,3,79,4,64,65,32,65,224,0,65,201,3,65,29,16,0,0,11,32,0,65,15,106,65,112,113,34,0,65,16,32,0,65,16,75,27,11,169,1,1,1,127,32,0,32,1,65,128,2,73,4,127,32,1,65,4,118,33,1,65,0,5,32,1,65,248,255,255,255,1,73,4,64,32,1,65,1,65,27,32,1,103,107,116,106,65,1,107,33,1,11,32,1,65,31,32,1,103,107,34,2,65,4,107,118,65,16,115,33,1,32,2,65,7,107,11,34,2,65,2,116,106,40,2,4,65,127,32,1,116,113,34,1,4,127,32,0,32,1,104,32,2,65,4,116,106,65,2,116,106,40,2,96,5,32,0,40,2,0,65,127,32,2,65,1,106,116,113,34,1,4,127,32,0,32,0,32,1,104,34,0,65,2,116,106,40,2,4,104,32,0,65,4,116,106,65,2,116,106,40,2,96,5,65,0,11,11,11,111,1,1,127,63,0,34,2,32,1,65,248,255,255,255,1,73,4,127,32,1,65,1,65,27,32,1,103,107,116,65,1,107,106,5,32,1,11,65,16,32,0,40,2,160,12,32,2,65,16,116,65,16,107,71,116,106,65,255,255,3,106,65,128,128,124,113,65,16,118,34,1,32,2,32,1,74,27,64,0,65,0,72,4,64,32,1,64,0,65,0,72,4,64,0,11,11,32,0,32,2,65,16,116,63,0,65,16,116,16,3,11,113,1,2,127,32,1,40,2,0,34,3,65,124,113,32,2,107,34,4,65,32,79,4,64,32,1,32,2,32,3,65,2,113,114,54,2,0,32,2,32,1,65,16,106,106,34,1,32,4,65,16,107,65,1,114,54,2,0,32,0,32,1,16,2,5,32,1,32,3,65,126,113,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,32,1,65,16,106,32,1,40,2,0,65,124,113,106,40,2,0,65,125,113,54,2,0,11,11,91,1,2,127,32,0,32,1,16,5,34,4,16,6,34,3,69,4,64,65,1,36,1,65,0,36,1,32,0,32,4,16,6,34,3,69,4,64,32,0,32,4,16,7,32,0,32,4,16,6,33,3,11,11,32,3,65,0,54,2,4,32,3,32,2,54,2,8,32,3,32,1,54,2,12,32,0,32,3,16,1,32,0,32,3,32,4,16,8,32,3,11,13,0,16,4,32,0,32,1,16,9,65,16,106,11,33,1,1,127,32,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,18,0,32,0,65,172,3,75,4,64,32,0,65,16,107,16,52,11,11,140,3,1,1,127,2,64,32,1,69,13,0,32,0,65,0,58,0,0,32,0,32,1,106,65,1,107,65,0,58,0,0,32,1,65,2,77,13,0,32,0,65,1,106,65,0,58,0,0,32,0,65,2,106,65,0,58,0,0,32,0,32,1,106,34,2,65,2,107,65,0,58,0,0,32,2,65,3,107,65,0,58,0,0,32,1,65,6,77,13,0,32,0,65,3,106,65,0,58,0,0,32,0,32,1,106,65,4,107,65,0,58,0,0,32,1,65,8,77,13,0,32,1,65,0,32,0,107,65,3,113,34,1,107,33,2,32,0,32,1,106,34,0,65,0,54,2,0,32,0,32,2,65,124,113,34,1,106,65,4,107,65,0,54,2,0,32,1,65,8,77,13,0,32,0,65,4,106,65,0,54,2,0,32,0,65,8,106,65,0,54,2,0,32,0,32,1,106,34,2,65,12,107,65,0,54,2,0,32,2,65,8,107,65,0,54,2,0,32,1,65,24,77,13,0,32,0,65,12,106,65,0,54,2,0,32,0,65,16,106,65,0,54,2,0,32,0,65,20,106,65,0,54,2,0,32,0,65,24,106,65,0,54,2,0,32,0,32,1,106,34,2,65,28,107,65,0,54,2,0,32,2,65,24,107,65,0,54,2,0,32,2,65,20,107,65,0,54,2,0,32,2,65,16,107,65,0,54,2,0,32,0,32,0,65,4,113,65,24,106,34,2,106,33,0,32,1,32,2,107,33,1,3,64,32,1,65,32,79,4,64,32,0,66,0,55,3,0,32,0,65,8,106,66,0,55,3,0,32,0,65,16,106,66,0,55,3,0,32,0,65,24,106,66,0,55,3,0,32,1,65,32,107,33,1,32,0,65,32,106,33,0,12,1,11,11,11,11,178,1,1,3,127,32,1,65,240,255,255,255,3,32,2,118,75,4,64,65,144,1,65,192,1,65,23,65,56,16,0,0,11,32,1,32,2,116,34,3,65,0,16,10,34,2,32,3,16,13,32,0,69,4,64,65,12,65,2,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,2,34,1,32,0,40,2,0,34,4,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,32,4,16,12,11,32,0,32,1,54,2,0,32,0,32,2,54,2,4,32,0,32,3,54,2,8,32,0,11,46,1,2,127,65,12,65,5,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,65,128,2,65,3,16,14,11,9,0,65,63,32,0,121,167,107,11,49,1,2,127,65,63,32,1,121,167,107,33,2,3,64,65,63,32,0,121,167,107,32,2,107,34,3,65,0,78,4,64,32,0,32,1,32,3,172,134,133,33,0,12,1,11,11,32,0,11,40,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,163,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,65,0,58,0,0,11,38,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,152,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,45,0,0,11,254,5,2,1,127,4,126,32,0,69,4,64,65,232,0,65,6,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,24,32,0,66,0,55,3,32,32,0,66,0,55,3,40,32,0,66,0,55,3,48,32,0,66,0,55,3,56,32,0,66,0,55,3,64,32,0,66,0,55,3,72,32,0,66,0,55,3,80,32,0,66,0,55,3,88,32,0,66,0,55,3,96,32,0,32,2,173,55,3,80,32,0,32,3,173,55,3,88,65,12,65,4,16,10,34,2,65,172,3,75,4,64,32,2,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,32,4,65,0,16,14,33,2,32,0,40,2,0,16,12,32,0,32,2,54,2,0,32,0,32,4,54,2,4,32,0,66,1,32,1,173,134,66,1,125,55,3,96,32,0,66,243,130,183,218,216,230,232,30,55,3,72,35,4,69,4,64,65,0,33,2,3,64,32,2,65,128,2,72,4,64,32,2,65,255,1,113,173,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,65,0,33,4,3,64,32,4,32,0,40,2,4,65,1,107,72,4,64,32,6,66,8,134,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,32,4,65,1,106,33,4,12,1,11,11,35,6,40,2,4,32,2,65,3,116,106,32,6,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,63,32,0,41,3,72,121,167,107,172,33,7,65,0,33,2,3,64,32,2,65,128,2,72,4,64,35,5,33,1,32,2,172,32,7,134,34,8,33,6,65,63,32,0,41,3,72,34,9,121,167,107,33,3,3,64,65,63,32,6,121,167,107,32,3,107,34,4,65,0,78,4,64,32,6,32,9,32,4,172,134,133,33,6,12,1,11,11,32,1,40,2,4,32,2,65,3,116,106,32,6,32,8,132,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,1,36,4,11,32,0,66,0,55,3,24,32,0,66,0,55,3,32,65,0,33,2,3,64,32,2,32,0,40,2,4,72,4,64,32,0,40,2,0,32,2,16,18,32,2,65,1,106,33,2,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,6,66,45,136,167,65,3,116,106,41,3,0,32,6,66,8,134,66,1,132,133,55,3,40,32,0,11,38,1,1,127,32,0,40,2,0,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,55,1,2,127,32,1,32,0,40,2,0,34,2,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,16,12,11,32,0,32,1,54,2,0,11,7,0,32,0,40,2,4,11,9,0,32,0,32,1,54,2,4,11,7,0,32,0,40,2,8,11,9,0,32,0,32,1,54,2,8,11,7,0,32,0,41,3,16,11,9,0,32,0,32,1,55,3,16,11,7,0,32,0,41,3,24,11,9,0,32,0,32,1,55,3,24,11,7,0,32,0,41,3,32,11,9,0,32,0,32,1,55,3,32,11,7,0,32,0,41,3,40,11,9,0,32,0,32,1,55,3,40,11,7,0,32,0,41,3,48,11,9,0,32,0,32,1,55,3,48,11,7,0,32,0,41,3,56,11,9,0,32,0,32,1,55,3,56,11,7,0,32,0,41,3,64,11,9,0,32,0,32,1,55,3,64,11,7,0,32,0,41,3,72,11,9,0,32,0,32,1,55,3,72,11,7,0,32,0,41,3,80,11,9,0,32,0,32,1,55,3,80,11,7,0,32,0,41,3,88,11,9,0,32,0,32,1,55,3,88,11,7,0,32,0,41,3,96,11,9,0,32,0,32,1,55,3,96,11,172,4,2,5,127,1,126,32,2,65,172,3,75,4,64,32,2,65,16,107,34,4,32,4,40,2,4,65,1,106,54,2,4,11,32,2,33,4,65,0,33,2,32,1,40,2,8,33,5,32,1,40,2,4,33,6,3,64,2,127,65,0,33,3,3,64,32,3,32,5,72,4,64,32,3,32,6,106,45,0,0,33,1,32,0,40,2,0,32,0,40,2,8,16,19,33,7,32,0,40,2,8,32,0,40,2,0,40,2,4,106,32,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,7,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,1,173,32,8,66,8,134,132,133,55,3,40,32,0,32,0,41,3,16,66,1,124,55,3,16,32,0,32,0,41,3,24,66,1,124,55,3,24,32,0,41,3,16,32,0,41,3,80,90,4,127,32,0,41,3,40,32,0,41,3,96,131,80,5,65,0,11,4,127,65,1,5,32,0,41,3,16,32,0,41,3,88,90,11,4,64,32,0,32,0,41,3,32,55,3,48,32,0,32,0,41,3,16,55,3,56,32,0,32,0,41,3,40,55,3,64,65,0,33,1,3,64,32,1,32,0,40,2,4,72,4,64,32,0,40,2,0,32,1,16,18,32,1,65,1,106,33,1,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,8,66,8,134,66,1,132,133,55,3,40,32,3,65,1,106,12,3,11,32,3,65,1,106,33,3,12,1,11,11,65,127,11,34,1,65,0,78,4,64,32,5,32,1,107,33,5,32,1,32,6,106,33,6,32,2,34,1,65,1,106,33,2,32,4,40,2,4,32,1,65,2,116,106,32,0,41,3,56,62,2,0,12,1,11,11,32,4,11,10,0,16,15,36,5,16,15,36,6,11,3,0,1,11,73,1,2,127,32,0,40,2,4,34,1,65,255,255,255,255,0,113,34,2,65,1,70,4,64,32,0,65,16,106,16,53,32,0,32,0,40,2,0,65,1,114,54,2,0,35,0,32,0,16,2,5,32,0,32,2,65,1,107,32,1,65,128,128,128,128,127,113,114,54,2,4,11,11,58,0,2,64,2,64,2,64,32,0,65,8,107,40,2,0,14,7,0,0,1,1,1,1,1,2,11,15,11,32,0,40,2,0,34,0,4,64,32,0,65,172,3,79,4,64,32,0,65,16,107,16,52,11,11,15,11,0,11,11,137,3,7,0,65,16,11,55,40,0,0,0,1,0,0,0,1,0,0,0,40,0,0,0,97,0,108,0,108,0,111,0,99,0,97,0,116,0,105,0,111,0,110,0,32,0,116,0,111,0,111,0,32,0,108,0,97,0,114,0,103,0,101,0,65,208,0,11,45,30,0,0,0,1,0,0,0,1,0,0,0,30,0,0,0,126,0,108,0,105,0,98,0,47,0,114,0,116,0,47,0,116,0,108,0,115,0,102,0,46,0,116,0,115,0,65,128,1,11,43,28,0,0,0,1,0,0,0,1,0,0,0,28,0,0,0,73,0,110,0,118,0,97,0,108,0,105,0,100,0,32,0,108,0,101,0,110,0,103,0,116,0,104,0,65,176,1,11,53,38,0,0,0,1,0,0,0,1,0,0,0,38,0,0,0,126,0,108,0,105,0,98,0,47,0,97,0,114,0,114,0,97,0,121,0,98,0,117,0,102,0,102,0,101,0,114,0,46,0,116,0,115,0,65,240,1,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,73,0,110,0,100,0,101,0,120,0,32,0,111,0,117,0,116,0,32,0,111,0,102,0,32,0,114,0,97,0,110,0,103,0,101,0,65,176,2,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,126,0,108,0,105,0,98,0,47,0,116,0,121,0,112,0,101,0,100,0,97,0,114,0,114,0,97,0,121,0,46,0,116,0,115,0,65,240,2,11,53,7,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,145,4,0,0,2,0,0,0,49,0,0,0,2,0,0,0,17,1,0,0,2,0,0,0,16,0,34,16,115,111,117,114,99,101,77,97,112,112,105,110,103,85,82,76,16,46,47,114,97,98,105,110,46,119,97,115,109,46,109,97,112]);return xk(new Response(new Blob([e],{type:"application/wasm"})),r)}var $k=r2;const gw=Rk,Lk=$k,Mk=async(r,e,t,n,s)=>{const i=await Lk();return new gw(i,r,e,t,n,s)};var Uk={Rabin:gw,create:Mk};async function*Bk(r,e){let t,n,s;if(e.minChunkSize&&e.maxChunkSize&&e.avgChunkSize)s=e.avgChunkSize,t=e.minChunkSize,n=e.maxChunkSize;else if(e.avgChunkSize)s=e.avgChunkSize,t=s/3,n=s+s/2;else throw E(new Error("please specify an average chunk size"),"ERR_INVALID_AVG_CHUNK_SIZE");if(t<16)throw E(new Error("rabin min must be greater than 16"),"ERR_INVALID_MIN_CHUNK_SIZE");n<t&&(n=t),s<t&&(s=t);const i=Math.floor(Math.log2(s));for await(const o of zk(r,{min:t,max:n,bits:i,window:e.window,polynomial:e.polynomial}))yield o}async function*zk(r,e){const t=await Uk.create(e.bits,e.min,e.max,e.window),n=new Pt;for await(const s of r){n.append(s);const i=t.fingerprint(s);for(let o=0;o<i.length;o++){const a=i[o],c=n.slice(0,a);n.consume(a),yield c}}n.length&&(yield n.subarray(0))}async function*Fk(r,e){let t=new Pt,n=0,s=!1;const i=e.maxChunkSize;for await(const o of r)for(t.append(o),n+=o.length;n>=i;)if(yield t.slice(0,i),s=!0,i===t.length)t=new Pt,n=0;else{const a=new Pt;a.append(t.sublist(i)),t=a,n-=i}(!s||n)&&(yield t.subarray(0,n))}async function*Vk(r){for await(const e of r){if(e.length===void 0)throw E(new Error("Content was invalid"),"ERR_INVALID_CONTENT");if(typeof e=="string"||e instanceof String)yield M(e.toString());else if(Array.isArray(e))yield Uint8Array.from(e);else if(e instanceof Uint8Array)yield e;else throw E(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}}function jk(r){return Symbol.iterator in r}function Kk(r){return Symbol.asyncIterator in r}function qk(r){try{if(r instanceof Uint8Array)return async function*(){yield r}();if(jk(r))return async function*(){yield*r}();if(Kk(r))return r}catch{throw E(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}throw E(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}async function*Hk(r,e,t){for await(const n of r)if(n.path&&(n.path.substring(0,2)==="./"&&(t.wrapWithDirectory=!0),n.path=n.path.split("/").filter(s=>s&&s!==".").join("/")),n.content){let s;typeof t.chunker=="function"?s=t.chunker:t.chunker==="rabin"?s=Bk:s=Fk;let i;typeof t.chunkValidator=="function"?i=t.chunkValidator:i=Vk;const o={path:n.path,mtime:n.mtime,mode:n.mode,content:s(i(qk(n.content),t),t)};yield()=>vk(o,e,t)}else if(n.path){const s={path:n.path,mtime:n.mtime,mode:n.mode};yield()=>lk(s,e,t)}else throw new Error("Import candidate must have content or path or both")}let ka=class{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}};class n2 extends ka{constructor(e,t){super(e,t),this._children={}}async put(e,t){this.cid=void 0,this.size=void 0,this._children[e]=t}get(e){return Promise.resolve(this._children[e])}childCount(){return Object.keys(this._children).length}directChildrenCount(){return this.childCount()}onlyChild(){return this._children[Object.keys(this._children)[0]]}async*eachChildSeries(){const e=Object.keys(this._children);for(let t=0;t<e.length;t++){const n=e[t];yield{key:n,child:this._children[n]}}}async*flush(e){const t=Object.keys(this._children),n=[];for(let u=0;u<t.length;u++){let l=this._children[t[u]];if(l instanceof ka)for await(const d of l.flush(e))l=d,yield l;l.size!=null&&l.cid&&n.push({Name:t[u],Tsize:l.size,Hash:l.cid})}const s=new Ce({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:s.marshal(),Links:n},o=Re(Wr(i)),a=await Yi(o,e,this.options),c=o.length+i.Links.reduce((u,l)=>u+(l.Tsize==null?0:l.Tsize),0);this.cid=a,this.size=c,yield{cid:a,unixfs:s,path:this.path,size:c}}}const bc=7;var Gk=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(t===void 0)n!==-1&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let s=!1;n===-1?(n=this._data.length,this._setBit(e),this._changedData=!0):s=!0,this._setInternalPos(n,e,t,s),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,s=t;for(;n<this.length;){const i=this.get(n);s=e(s,i,n),n++}return s}find(e){let t=0,n,s;for(;t<this.length&&!n;)s=this.get(t),n=e(s),t++;return n?s:void 0}_internalPositionFor(e,t){const n=this._bytePosFor(e,t);if(n>=this._bitArrays.length)return-1;const s=this._bitArrays[n],i=e-n*bc;if(!((s&1<<i)>0))return-1;const a=this._bitArrays.slice(0,n).reduce(Wk,0),c=~(4294967295<<i+1),u=yw(s&c);return a+u-1}_bytePosFor(e,t){const n=Math.floor(e/bc),s=n+1;for(;!t&&this._bitArrays.length<s;)this._bitArrays.push(0);return n}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*bc}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*bc)}_setInternalPos(e,t,n,s){const i=this._data,o=[t,n];if(s)this._sortData(),i[e]=o;else{if(i.length)if(i[i.length-1][0]>=t)i.push(o);else if(i[0][0]<=t)i.unshift(o);else{const a=Math.round(i.length/2);this._data=i.slice(0,a).concat(o).concat(i.slice(a))}else this._data.push(o);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(Yk),this._changedData=!1}bitField(){const e=[];let t=8,n=0,s=0,i;const o=this._bitArrays.slice();for(;o.length||n;){n===0&&(i=o.shift(),n=7);const c=Math.min(n,t),u=~(255<<c),l=i&u;s|=l<<8-t,i=i>>>c,n-=c,t-=c,(!t||!n&&!o.length)&&(e.push(s),s=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(Qk)}};function Wk(r,e){return r+yw(e)}function yw(r){let e=r;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function Yk(r,e){return r[0]-e[0]}function Qk(r){return r[1]}class Ct{constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new Gk,this.key=null}async put(e,t){const n=await this._findNewBucketAndPos(e);await n.bucket._putAt(n,e,t)}async get(e){const t=await this._findChild(e);if(t!=null)return t.value}async del(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);n!=null&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,n)=>n instanceof Ct?t+n.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof Ct?yield*t.eachLeafSeries():yield t}serialize(e,t){const n=[];return t(this._children.reduce((s,i,o)=>(i!=null&&(i instanceof Ct?s.push(i.serialize(e,t)):s.push(e(i,o))),s),n))}async asyncTransform(e,t){return await ww(this,e,t)}toJSON(){return this.serialize(Xk,Zk)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof Ct)&&n!=null&&n.key===e)return n}async _findPlace(e){const t=this._options.hash(typeof e=="string"?M(e):e),n=await t.take(this._options.bits),s=this._children.get(n);return s instanceof Ct?await s._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:s}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){const n=new Ct(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,n);const s=await n._findPlace(t.existingChild.hash);return s.bucket._putAt(s,t.existingChild.key,t.existingChild.value),await n._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const e=this._children.find(Jk);if(e!=null&&!(e instanceof Ct)){const t=e.hash;t.untake(this._options.bits);const n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function Jk(r){return Boolean(r)}function Xk(r,e){return r.key}function Zk(r){return r}async function ww(r,e,t){const n=[];for(const s of r._children.compactArray())if(s instanceof Ct)await ww(s,e,t);else{const i=await e(s);n.push({bitField:r._children.bitField(),children:i})}return await t(n)}const eO=[255,254,252,248,240,224,192,128],tO=[1,3,7,15,31,63,127,255];class rO{constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const s=this._value[this._currentBytePos],i=this._currentBitPos+1,o=Math.min(i,t),a=nO(s,i-o,o);n=(n<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function nO(r,e,t){const n=sO(e,t);return(r&n)>>>e}function sO(r,e){return eO[r]&tO[Math.min(e+r-1,7)]}function iO(r){function e(t){return t instanceof B3?t:new B3(t,r)}return e}class B3{constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const s=this._buffers[this._currentBufferIndex],i=Math.min(s.availableBits(),t),o=s.take(i);n=(n<<i)+o,t-=i,this._availableBits-=i,s.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const n=this._buffers[this._currentBufferIndex],s=Math.min(n.totalBits()-n.availableBits(),t);n.untake(s),t-=s,this._availableBits+=s,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?Jt([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new rO(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}function yd(r){if(r==null||r.hashFn==null)throw new Error("please define an options.hashFn");const e={bits:r.bits??8,hash:iO(r.hashFn)};return new Ct(e)}let oO=class extends ka{constructor(e,t){super(e,t),this._bucket=yd({hashFn:t.hamtHashFn,bits:t.hamtBucketBits})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){for await(const t of mw(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*mw(r,e,t,n){const s=r._children,i=[];let o=0;for(let g=0;g<s.length;g++){const h=s.get(g);if(!h)continue;const p=g.toString(16).toUpperCase().padStart(2,"0");if(h instanceof Ct){let w;for await(const y of await mw(h,e,null,n))w=y;if(!w)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:p,Tsize:w.size,Hash:w.cid}),o+=w.size}else if(typeof h.value.flush=="function"){const w=h.value;let y;for await(const b of w.flush(e))y=b,yield y;const _=p+h.key;i.push({Name:_,Tsize:y.size,Hash:y.cid}),o+=y.size}else{const w=h.value;if(!w.cid)continue;const y=p+h.key,_=w.size;i.push({Name:y,Tsize:_,Hash:w.cid}),o+=_}}const a=Uint8Array.from(s.bitField().reverse()),c=new Ce({type:"hamt-sharded-directory",data:a,fanout:r.tableSize(),hashType:n.hamtHashCode,mtime:t&&t.mtime,mode:t&&t.mode}),u={Data:c.marshal(),Links:i},l=Re(Wr(u)),d=await Yi(l,e,n),f=l.length+o;yield{cid:d,unixfs:c,size:f}}async function bw(r,e,t,n){let s=e;e instanceof n2&&e.directChildrenCount()>=t&&(s=await aO(e,n));const i=s.parent;if(i){if(s!==e){if(r&&(r.parent=s),!s.parentKey)throw new Error("No parent key found");await i.put(s.parentKey,s)}return bw(s,i,t,n)}return s}async function aO(r,e){const t=new oO({root:r.root,dir:!0,parent:r.parent,parentKey:r.parentKey,path:r.path,dirty:r.dirty,flat:!1,mtime:r.mtime,mode:r.mode},e);for await(const{key:n,child:s}of r.eachChildSeries())await t.put(n,s);return t}const cO=(r="")=>(r.trim().match(/([^\\/]|\\\/)+/g)||[]).filter(Boolean);async function lO(r,e,t){const n=cO(r.path||""),s=n.length-1;let i=e,o="";for(let a=0;a<n.length;a++){const c=n[a];o+=`${o?"/":""}${c}`;const u=a===s;if(i.dirty=!0,i.cid=void 0,i.size=void 0,u)await i.put(c,r),e=await bw(null,i,t.shardSplitThreshold,t);else{let l=await i.get(c);(!l||!(l instanceof ka))&&(l=new n2({root:!1,dir:!0,parent:i,parentKey:c,path:o,dirty:!0,flat:!0,mtime:l&&l.unixfs&&l.unixfs.mtime,mode:l&&l.unixfs&&l.unixfs.mode},t)),await i.put(c,l),i=l}}return e}async function*z3(r,e){if(!(r instanceof ka)){r&&r.unixfs&&r.unixfs.isDirectory()&&(yield r);return}yield*r.flush(e)}async function*uO(r,e,t){let n=new n2({root:!0,dir:!0,path:"",dirty:!0,flat:!0},t);for await(const s of r)s&&(n=await lO(s,n,t),(!s.unixfs||!s.unixfs.isDirectory())&&(yield s));if(t.wrapWithDirectory)yield*z3(n,e);else for await(const s of n.eachChildSeries())s&&(yield*z3(s.child,e))}async function*s2(r,e,t={}){const n=GP(t);let s;typeof t.dagBuilder=="function"?s=t.dagBuilder:s=Hk;let i;typeof t.treeBuilder=="function"?i=t.treeBuilder:i=uO;let o;Symbol.asyncIterator in r||Symbol.iterator in r?o=r:o=[r];for await(const a of i(Q0(s(o,e,n),n.fileImportConcurrency),e,n))yield{cid:a.cid,path:a.path,unixfs:a.unixfs,size:a.size}}async function*Ew(r,e){if(typeof r=="string"||r instanceof String||Os(r)||Da(r)||r._readableState)throw E(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(Pa(r)&&(r=Wi(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const t=Ya(r),{value:n,done:s}=await t.peek();if(s){yield*[];return}if(t.push(n),Number.isInteger(n))throw E(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(n._readableState){yield*_t(t,i=>Zd({content:i},e));return}if(Os(n)){yield Zd({content:t},e);return}if(Yf(n)||n[Symbol.iterator]||n[Symbol.asyncIterator]||Pa(n)||Da(n)){yield*_t(t,i=>Zd(i,e));return}}throw Yf(r)?E(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT"):E(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}async function Zd(r,e){const{path:t,mode:n,mtime:s,content:i}=r,o={path:t||"",mode:Ni(n),mtime:Aa(s)};return i?o.content=await e(i):t||(o.content=await e(r)),o}function dO(r){return Ew(r,W8)}const hO=r=>{if(r)if(r.startsWith("size-")){const e=r.split("-")[1],t=parseInt(e);if(isNaN(t))throw new Error("Chunker parameter size must be an integer");return{chunker:"fixed",maxChunkSize:t}}else{if(r.startsWith("rabin"))return{chunker:"rabin",...fO(r)};throw new Error(`Unrecognized chunker option: ${r}`)}else return{chunker:"fixed"}},fO=r=>{const e={},t=r.split("-");switch(t.length){case 1:e.avgChunkSize=262144;break;case 2:e.avgChunkSize=Ec(t[1],"avg");break;case 4:e.minChunkSize=Ec(t[1],"min"),e.avgChunkSize=Ec(t[2],"avg"),e.maxChunkSize=Ec(t[3],"max");break;default:throw new Error('Incorrect chunker format (expected "rabin" "rabin-[avg]" or "rabin-[min]-[avg]-[max]"')}return e},Ec=(r,e)=>{const t=parseInt(r);if(isNaN(t))throw new Error(`Chunker parameter ${e} must be an integer`);return t},pO=Le.bind({ignoreUndefined:!0});function gO({repo:r,preload:e,hashers:t,options:n}){const s=n&&n.sharding;async function*i(o,a={}){const c=pO({shardSplitThreshold:s?1e3:1/0,strategy:"balanced"},a,{...hO(a.chunker)});c.hashAlg&&c.hashAlg!=="sha2-256"&&c.cidVersion!==1&&(c.cidVersion=1),c.trickle&&(c.strategy="trickle"),c.strategy==="trickle"&&(c.leafType="raw",c.reduceSingleLeafToSelf=!1),c.cidVersion>0&&c.rawLeaves===void 0&&(c.rawLeaves=!0),c.hashAlg!==void 0&&c.rawLeaves===void 0&&(c.rawLeaves=!0),delete c.trickle;const u={};if(c.progress){const g=c.progress;c.progress=(h,p)=>{u[p]||(u[p]=0),u[p]+=h,g(u[p],p)}}let l;c.hashAlg!=null&&(l=await t.getHasher(c.hashAlg));const d=ne(dO(o),g=>s2(g,r.blocks,{...c,hasher:l,pin:!1}),yO(c),wO(e,c),mO(r,c)),f=await r.gcLock.readLock();try{for await(const g of d){const h=g.path??g.cid.toString();delete u[h],yield{...g,path:h}}}finally{f()}}return x(i)}function yO(r){async function*e(t){for await(const n of t){let s=n.cid;r.cidVersion===1&&(s=s.toV1());let i=n.path?n.path:s.toString();r.wrapWithDirectory&&!n.path&&(i=""),yield{path:i,cid:s,size:n.size,mode:n.unixfs&&n.unixfs.mode,mtime:n.unixfs&&n.unixfs.mtime}}}return e}function wO(r,e){async function*t(n){for await(const s of n)(!s.path||e.wrapWithDirectory?s.path==="":!s.path.includes("/"))&&!e.onlyHash&&e.preload!==!1&&r(s.cid),yield s}return t}function mO(r,e){async function*t(n){for await(const s of n){const i=!(s.path&&s.path.includes("/"));(e.pin==null?!0:e.pin)&&i&&!e.onlyHash&&await r.pins.pinRecursively(s.cid),yield s}}return t}var bO=_w,F3=128,EO=127,_O=~EO,vO=Math.pow(2,31);function _w(r,e,t){e=e||[],t=t||0;for(var n=t;r>=vO;)e[t++]=r&255|F3,r/=128;for(;r&_O;)e[t++]=r&255|F3,r>>>=7;return e[t]=r|0,_w.bytes=t-n+1,e}var SO=s1,RO=128,V3=127;function s1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw s1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&V3)<<s:(o&V3)*Math.pow(2,s),s+=7}while(o>=RO);return s1.bytes=i-n,t}var IO=Math.pow(2,7),AO=Math.pow(2,14),CO=Math.pow(2,21),TO=Math.pow(2,28),DO=Math.pow(2,35),PO=Math.pow(2,42),kO=Math.pow(2,49),OO=Math.pow(2,56),NO=Math.pow(2,63),xO=function(r){return r<IO?1:r<AO?2:r<CO?3:r<TO?4:r<DO?5:r<PO?6:r<kO?7:r<OO?8:r<NO?9:10},$O={encode:bO,decode:SO,encodingLength:xO},Ql=$O;const i1=(r,e=0)=>[Ql.decode(r,e),Ql.decode.bytes],Jl=(r,e,t=0)=>(Ql.encode(r,e,t),e),Xl=r=>Ql.encodingLength(r),LO=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},wd=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},vw=(r,e)=>{const t=e.byteLength,n=Xl(r),s=n+Xl(t),i=new Uint8Array(s+t);return Jl(r,i,0),Jl(t,i,n),i.set(e,s),new i2(r,t,e,i)},Sw=r=>{const e=wd(r),[t,n]=i1(e),[s,i]=i1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new i2(t,s,o,e)},MO=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&LO(r.bytes,t.bytes)}};let i2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function UO(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var BO=UO,zO=BO;let FO=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},VO=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Rw(this,e)}},jO=class{constructor(e){this.decoders=e}or(e){return Rw(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Rw=(r,e)=>new jO({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let KO=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new FO(e,t,n),this.decoder=new VO(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Iw=({name:r,prefix:e,encode:t,decode:n})=>new KO(r,e,t,n),Aw=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=zO(t,e);return Iw({prefix:r,name:e,encode:n,decode:i=>wd(s(i))})},qO=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},HO=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},On=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Iw({prefix:e,name:r,encode(s){return HO(s,n,t)},decode(s){return qO(s,n,t,r)}}),ss=Aw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Aw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const il=On({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});On({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});On({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});On({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});On({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});On({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});On({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});On({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});On({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const GO=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return YO(t,o1(r),e||ss.encoder);default:return QO(t,o1(r),e||il.encoder)}},j3=new WeakMap,o1=r=>{const e=j3.get(r);if(e==null){const t=new Map;return j3.set(r,t),t}return e};let et=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==No)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==JO)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return et.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=vw(e,t);return et.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return et.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&MO(e.multihash,n.multihash)}toString(e){return GO(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof et)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new et(n,s,i,o||K3(n,s,i.bytes))}else if(t[XO]===!0){const{version:n,multihash:s,code:i}=t,o=Sw(s);return et.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==No)throw new Error(`Version 0 CID must use dag-pb (code: ${No}) block encoding`);return new et(e,t,n,n.bytes)}case 1:{const s=K3(e,t,n.bytes);return new et(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return et.create(0,No,e)}static createV1(e,t){return et.create(1,e,t)}static decode(e){const[t,n]=et.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=et.inspectBytes(e),n=t.size-t.multihashSize,s=wd(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new i2(t.multihashCode,t.digestSize,i,s);return[t.version===0?et.createV0(o):et.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=i1(e.subarray(t));return t+=f,d};let s=n(),i=No;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=WO(e,t),i=et.decode(s);return o1(i).set(n,e),i}};const WO=(r,e)=>{switch(r[0]){case"Q":{const t=e||ss;return[ss.prefix,t.decode(`${ss.prefix}${r}`)]}case ss.prefix:{const t=e||ss;return[ss.prefix,t.decode(r)]}case il.prefix:{const t=e||il;return[il.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},YO=(r,e,t)=>{const{prefix:n}=t;if(n!==ss.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},QO=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},No=112,JO=18,K3=(r,e,t)=>{const n=Xl(r),s=n+Xl(e),i=new Uint8Array(s+t.byteLength);return Jl(r,i,0),Jl(e,i,n),i.set(t,s),i},XO=Symbol.for("@ipld/js-cid/CID"),Cw=85,Tw=0,ZO="identity",Dw=wd,eN=r=>vw(Tw,Dw(r)),tN={code:Tw,name:ZO,encode:Dw,digest:eN},rN=async function(r){return(await gd.encode(r)).slice(0,8).reverse()},nN=(r,e,t)=>Promise.all(r.map(n=>{if(n.Name==null)throw new Error("Unexpected Link without a Name");if(n.Name.length===2){const s=parseInt(n.Name,16);return e._putObjectAt(s,new Ct({hash:t._options.hash,bits:t._options.bits},e,s))}return t.put(n.Name.substring(2),!0)})),q3=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),sN=r=>{let e=r.bucket;const t=[];for(;e._parent;)t.push(e),e=e._parent;return t.push(e),t.reverse()},Pw=async(r,e,t,n,s)=>{if(!n){const l=yd({hashFn:rN});n={rootBucket:l,hamtDepth:1,lastBucket:l}}await nN(r.Links,n.lastBucket,n.rootBucket);const i=await n.rootBucket._findNewBucketAndPos(e);let o=q3(i.pos);const a=sN(i);a.length>n.hamtDepth&&(n.lastBucket=a[n.hamtDepth],o=q3(n.lastBucket._posAtParent));const c=r.Links.find(l=>{if(l.Name==null)return!1;const d=l.Name.substring(0,2),f=l.Name.substring(2);return!(d!==o||f&&f!==e)});if(!c)return null;if(c.Name!=null&&c.Name.substring(2)===e)return c.Hash;n.hamtDepth++;const u=await t.get(c.Hash,s);return r=Ke(u),Pw(r,e,t,n,s)};function Zl(r,e,t,n){const s=r.length,i=e+s;return t>=i||n<e?new Uint8Array(0):(n>=e&&n<i&&(r=r.subarray(0,n-e)),t>=e&&t<i&&(r=r.subarray(t-e)),r)}const o2=(r,e,t)=>{if(e||(e=0),e<0)throw E(new Error("Offset must be greater than or equal to 0"),"ERR_INVALID_PARAMS");if(e>r)throw E(new Error("Offset must be less than the file size"),"ERR_INVALID_PARAMS");if(!t&&t!==0&&(t=r-e),t<0)throw E(new Error("Length must be greater than or equal to 0"),"ERR_INVALID_PARAMS");return e+t>r&&(t=r-e),{offset:e,length:t}};async function kw(r,e,t,n,s,i,o,a){if(e instanceof Uint8Array){t.push(Zl(e,n,s,i));return}if(e.Data==null)throw E(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");let c;try{c=Ce.unmarshal(e.Data)}catch(l){throw E(l,"ERR_NOT_UNIXFS")}if(c.data!=null){const l=c.data,d=Zl(l,n,s,i);t.push(d),n+=d.byteLength}const u=[];for(let l=0;l<e.Links.length;l++){const d=e.Links[l],f=n,g=f+c.blockSizes[l];if((s>=f&&s<g||i>=f&&i<=g||s<f&&i>g)&&u.push({link:d,blockStart:n}),n=g,n>i)break}await ne(u,l=>_t(l,d=>async()=>{const f=await r.get(d.link.Hash,{signal:a.signal});return{...d,block:f}}),l=>pd(l,{ordered:!0}),async l=>{for await(const{link:d,block:f,blockStart:g}of l){let h;switch(d.Hash.code){case Ne:h=Ke(f);break;case Cw:h=f;break;default:t.end(E(new Error(`Unsupported codec: ${d.Hash.code}`),"ERR_NOT_UNIXFS"));return}o.add(async()=>{await kw(r,h,t,g,s,i,o,a)})}})}const H3=(r,e,t,n,s,i,o)=>{async function*a(c={}){const u=t.fileSize();if(u===void 0)throw new Error("File was a directory");const{offset:l,length:d}=o2(u,c.offset,c.length);if(d===0)return;const f=new lt({concurrency:1}),g=dr();f.add(async()=>{await kw(o,e,g,0,l,l+d,f,c)}),f.on("error",p=>{g.end(p)});let h=0;for await(const p of g)p!=null&&(h+=p.byteLength,h===d&&g.end(),yield p)}return a},iN=(r,e,t,n,s,i,o)=>{async function*a(c={}){const u=c.offset||0,l=c.length||e.Links.length,d=e.Links.slice(u,l);for(const f of d){const g=await s(f.Hash,f.Name||"",`${n}/${f.Name||""}`,[],i+1,o,c);g.entry&&(yield g.entry)}}return a},oN=(r,e,t,n,s,i,o)=>{function a(c={}){return Ow(e,n,s,i,o,c)}return a};async function*Ow(r,e,t,n,s,i){const o=r.Links;for(const a of o){const c=a.Name!=null?a.Name.substring(2):null;if(c)yield(await t(a.Hash,c,`${e}/${c}`,[],n+1,s,i)).entry;else{const u=await s.get(a.Hash);r=Ke(u);for await(const l of Ow(r,e,t,n,s,i))yield l}}}const aN=(r,e)=>{const t=r.Links.find(n=>n.Name===e);return t&&t.Hash},cN={raw:H3,file:H3,directory:iN,"hamt-sharded-directory":oN,metadata:(r,e,t,n,s,i,o)=>()=>[],symlink:(r,e,t,n,s,i,o)=>()=>[]},lN=async(r,e,t,n,s,i,o,a)=>{const c=await o.get(r,a),u=Ke(c);let l,d;if(e||(e=r.toString()),u.Data==null)throw E(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");try{l=Ce.unmarshal(u.Data)}catch(f){throw E(f,"ERR_NOT_UNIXFS")}if(t||(t=e),n.length){let f;if(l&&l.type==="hamt-sharded-directory"?f=await Pw(u,n[0],o):f=aN(u,n[0]),!f)throw E(new Error("file does not exist"),"ERR_NOT_FOUND");const g=n.shift(),h=`${t}/${g}`;d={cid:f,toResolve:n,name:g||"",path:h}}return{entry:{type:l.isDirectory()?"directory":"file",name:e,path:t,cid:r,content:cN[l.type](r,u,l,t,s,i,o),unixfs:l,depth:i,node:u,size:l.fileSize()},next:d}},uN=r=>{async function*e(t={}){const{offset:n,length:s}=o2(r.length,t.offset,t.length);yield Zl(r,0,n,n+s)}return e},dN=async(r,e,t,n,s,i,o,a)=>{if(n.length)throw E(new Error(`No link named ${t} found in raw node ${r}`),"ERR_NOT_FOUND");const c=await o.get(r,a);return{entry:{type:"raw",name:e,path:t,cid:r,content:uN(c),depth:i,size:c.length,node:c}}},hN=async(r,e,t,n,s,i,o,a)=>{const c=await o.get(r),u=O0(c);let l=u,d=t;for(;n.length;){const f=n[0];if(f in l){n.shift(),d=`${d}/${f}`;const g=et.asCID(l[f]);if(g)return{entry:{type:"object",name:e,path:t,cid:r,node:c,depth:i,size:c.length,content:async function*(){yield u}},next:{cid:g,name:f,path:d,toResolve:n}};l=l[f]}else throw E(new Error(`No property named ${f} found in cbor node ${r}`),"ERR_NO_PROP")}return{entry:{type:"object",name:e,path:t,cid:r,node:c,depth:i,size:c.length,content:async function*(){yield u}}}},fN=r=>{async function*e(t={}){const{offset:n,length:s}=o2(r.length,t.offset,t.length);yield Zl(r,0,n,n+s)}return e},pN=async(r,e,t,n,s,i,o,a)=>{if(n.length)throw E(new Error(`No link named ${t} found in raw node ${r}`),"ERR_NOT_FOUND");const c=await Sw(r.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:r,content:fN(c.digest),depth:i,size:c.digest.length,node:c.digest}}},gN={[Ne]:lN,[Cw]:dN,[k0]:hN,[tN.code]:pN};function Nw(r,e,t,n,s,i,o){const a=gN[r.code];if(!a)throw E(new Error(`No resolver for code ${r.code}`),"ERR_NO_RESOLVER");return a(r,e,t,n,Nw,s,i,o)}const yN=(r="")=>(r.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean),wN=r=>{if(r instanceof Uint8Array)return{cid:et.decode(r),toResolve:[]};const e=et.asCID(r);if(e)return{cid:e,toResolve:[]};if(typeof r=="string"){r.indexOf("/ipfs/")===0&&(r=r.substring(6));const t=yN(r);return{cid:et.parse(t[0]),toResolve:t.slice(1)}}throw E(new Error(`Unknown path type ${r}`),"ERR_BAD_PATH")};async function*xw(r,e,t={}){let{cid:n,toResolve:s}=wN(r),i=n.toString(),o=i;const a=s.length;for(;;){const c=await Nw(n,i,o,s,a,e,t);if(!c.entry&&!c.next)throw E(new Error(`Could not resolve ${r}`),"ERR_NOT_FOUND");if(c.entry&&(yield c.entry),!c.next)return;s=c.next.toResolve,n=c.next.cid,i=c.next.name,o=c.next.path}}async function Nn(r,e,t={}){const n=await tr(xw(r,e,t));if(!n)throw E(new Error(`Could not resolve ${r}`),"ERR_NOT_FOUND");return n}async function*$w(r,e,t={}){const n=await Nn(r,e,t);if(!n)return;if(yield n,n.type==="directory")for await(const i of s(n,t))yield i;async function*s(i,o){for await(const a of i.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*s(a,o))}}function mN({repo:r,preload:e}){async function*t(n,s={}){if(n=q0(n),s.preload!==!1){const o=n.split("/");e(V.parse(o[0]))}const i=await Nn(n,r.blocks,s);if(i.type==="directory")throw new Error("this dag node is a directory");if(!i.content)throw new Error("this dag node has no content");yield*i.content(s)}return x(t)}M("ustar\0","binary");M("ustar ","binary");M(" \0","binary");var bN={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,SIGUNUSED:31,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:64,O_EXCL:128,UV_FS_O_FILEMAP:0,O_NOCTTY:256,O_TRUNC:512,O_APPEND:1024,O_DIRECTORY:65536,O_NOATIME:262144,O_NOFOLLOW:131072,O_SYNC:1052672,O_DSYNC:4096,O_DIRECT:16384,O_NONBLOCK:2048,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:269488447,SSL_OP_ALL:2147485780,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6};const EN="0000000000000000000",_N="7777777777777777777",vN="0".charCodeAt(0),SN=M("ustar\0","binary"),RN=M("00","binary"),IN=parseInt("7777",8),AN=257,CN=263,TN=function(r){switch(r){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},DN=function(r){let e=256;for(let t=0;t<148;t++)e+=r[t];for(let t=156;t<512;t++)e+=r[t];return e},qn=function(r,e){const t=r.toString(8);return t.length>e?M(_N.slice(0,e)+" "):M(EN.slice(0,e-t.length)+t+" ")},eh=function(r){const e=M(r).byteLength;let t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${r}`};function PN(r){let e="";r.name!=null&&(e+=eh(" path="+r.name+`
`)),r.linkname!=null&&(e+=eh(" linkpath="+r.linkname+`
`));const t=r.pax;if(t!=null)for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e+=eh(" "+n+"="+t[n]+`
`));return M(e)}function a1(r){const e=new Uint8Array(512);let t=r.name,n="";if(r.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),M(t).byteLength!==t.length)return null;for(;M(t).byteLength>100;){const s=t.indexOf("/");if(s===-1)return null;n+=n!==""?"/"+t.slice(0,s):t.slice(0,s),t=t.slice(s+1)}return M(t).byteLength>100||M(n).byteLength>155||r.linkname!=null&&M(r.linkname).byteLength>100?null:(e.set(M(t),0),e.set(qn(r.mode&IN,6),100),e.set(qn(r.uid,6),108),e.set(qn(r.gid,6),116),e.set(qn(r.size,11),124),e.set(qn(r.mtime.getTime()/1e3|0,11),136),e[156]=vN+TN(r.type),r.linkname!=null&&e.set(M(r.linkname),157),e.set(SN,AN),e.set(RN,CN),r.uname!=null&&e.set(M(r.uname),265),r.gname!=null&&e.set(M(r.gname),297),e.set(qn(r.devmajor??0,6),329),e.set(qn(r.devminor??0,6),337),n!=null&&e.set(M(n),345),e.set(qn(DN(e),6),148),e)}const{S_IFMT:kN,S_IFBLK:ON,S_IFCHR:NN,S_IFDIR:xN,S_IFIFO:$N,S_IFLNK:LN}=bN,MN=parseInt("755",8),UN=parseInt("644",8),Lw=new Uint8Array(1024);function BN(r=0){switch(r&kN){case ON:return"block-device";case NN:return"character-device";case xN:return"directory";case $N:return"fifo";case LN:return"symlink";default:return"file"}}function c1(r){return r&=511,r!==0?Lw.subarray(0,512-r):new Uint8Array(0)}function th(r){if(r.pax==null){const e=a1(r);if(e!=null)return e}return zN(r)}function zN(r){const e=PN(r),t={name:"PaxHeader",mode:r.mode,uid:r.uid,gid:r.gid,size:e.length,mtime:r.mtime,type:"pax-header",linkname:r.linkname,uname:r.uname,gname:r.gname,devmajor:r.devmajor,devminor:r.devminor};return new Pt(a1(t)??new Uint8Array(0),e,c1(e.length),a1({...t,size:r.size,type:r.type})??new Uint8Array(0)).subarray()}function G3(){return async function*(r){for await(let{header:e,body:t}of r){const n={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??BN(e.mode),mode:e.mode??(e.type==="directory"?MN:UN),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=M(t)),t instanceof Uint8Array||jd(t)){n.size=t.length,yield th(n),yield jd(t)?t.subarray():t,yield c1(n.size);continue}if(n.type==="symlink"&&n.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");n.linkname=q(await df(t)),yield th(n);continue}if(yield th(n),n.type!=="file"&&n.type!=="contiguous-file")continue;let s=0;for await(const i of t??[])s+=i.length,yield jd(i)?i.subarray():i;if(s!==n.size)throw new Error(`size mismatch, wrote ${s} of ${n.size} bytes`);yield c1(n.size)}yield Lw}}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const FN=4,W3=0,Y3=1,VN=2;function uo(r){let e=r.length;for(;--e>=0;)r[e]=0}const jN=0,Mw=1,KN=2,qN=3,HN=258,a2=29,Xa=256,Oa=Xa+1+a2,Li=30,c2=19,Uw=2*Oa+1,Ks=15,rh=16,GN=7,l2=256,Bw=16,zw=17,Fw=18,l1=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),ol=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),WN=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Vw=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),YN=512,gn=new Array((Oa+2)*2);uo(gn);const ga=new Array(Li*2);uo(ga);const Na=new Array(YN);uo(Na);const xa=new Array(HN-qN+1);uo(xa);const u2=new Array(a2);uo(u2);const eu=new Array(Li);uo(eu);function nh(r,e,t,n,s){this.static_tree=r,this.extra_bits=e,this.extra_base=t,this.elems=n,this.max_length=s,this.has_stree=r&&r.length}let jw,Kw,qw;function sh(r,e){this.dyn_tree=r,this.max_code=0,this.stat_desc=e}const Hw=r=>r<256?Na[r]:Na[256+(r>>>7)],$a=(r,e)=>{r.pending_buf[r.pending++]=e&255,r.pending_buf[r.pending++]=e>>>8&255},zt=(r,e,t)=>{r.bi_valid>rh-t?(r.bi_buf|=e<<r.bi_valid&65535,$a(r,r.bi_buf),r.bi_buf=e>>rh-r.bi_valid,r.bi_valid+=t-rh):(r.bi_buf|=e<<r.bi_valid&65535,r.bi_valid+=t)},zr=(r,e,t)=>{zt(r,t[e*2],t[e*2+1])},Gw=(r,e)=>{let t=0;do t|=r&1,r>>>=1,t<<=1;while(--e>0);return t>>>1},QN=r=>{r.bi_valid===16?($a(r,r.bi_buf),r.bi_buf=0,r.bi_valid=0):r.bi_valid>=8&&(r.pending_buf[r.pending++]=r.bi_buf&255,r.bi_buf>>=8,r.bi_valid-=8)},JN=(r,e)=>{const t=e.dyn_tree,n=e.max_code,s=e.stat_desc.static_tree,i=e.stat_desc.has_stree,o=e.stat_desc.extra_bits,a=e.stat_desc.extra_base,c=e.stat_desc.max_length;let u,l,d,f,g,h,p=0;for(f=0;f<=Ks;f++)r.bl_count[f]=0;for(t[r.heap[r.heap_max]*2+1]=0,u=r.heap_max+1;u<Uw;u++)l=r.heap[u],f=t[t[l*2+1]*2+1]+1,f>c&&(f=c,p++),t[l*2+1]=f,!(l>n)&&(r.bl_count[f]++,g=0,l>=a&&(g=o[l-a]),h=t[l*2],r.opt_len+=h*(f+g),i&&(r.static_len+=h*(s[l*2+1]+g)));if(p!==0){do{for(f=c-1;r.bl_count[f]===0;)f--;r.bl_count[f]--,r.bl_count[f+1]+=2,r.bl_count[c]--,p-=2}while(p>0);for(f=c;f!==0;f--)for(l=r.bl_count[f];l!==0;)d=r.heap[--u],!(d>n)&&(t[d*2+1]!==f&&(r.opt_len+=(f-t[d*2+1])*t[d*2],t[d*2+1]=f),l--)}},Ww=(r,e,t)=>{const n=new Array(Ks+1);let s=0,i,o;for(i=1;i<=Ks;i++)s=s+t[i-1]<<1,n[i]=s;for(o=0;o<=e;o++){let a=r[o*2+1];a!==0&&(r[o*2]=Gw(n[a]++,a))}},XN=()=>{let r,e,t,n,s;const i=new Array(Ks+1);for(t=0,n=0;n<a2-1;n++)for(u2[n]=t,r=0;r<1<<l1[n];r++)xa[t++]=n;for(xa[t-1]=n,s=0,n=0;n<16;n++)for(eu[n]=s,r=0;r<1<<ol[n];r++)Na[s++]=n;for(s>>=7;n<Li;n++)for(eu[n]=s<<7,r=0;r<1<<ol[n]-7;r++)Na[256+s++]=n;for(e=0;e<=Ks;e++)i[e]=0;for(r=0;r<=143;)gn[r*2+1]=8,r++,i[8]++;for(;r<=255;)gn[r*2+1]=9,r++,i[9]++;for(;r<=279;)gn[r*2+1]=7,r++,i[7]++;for(;r<=287;)gn[r*2+1]=8,r++,i[8]++;for(Ww(gn,Oa+1,i),r=0;r<Li;r++)ga[r*2+1]=5,ga[r*2]=Gw(r,5);jw=new nh(gn,l1,Xa+1,Oa,Ks),Kw=new nh(ga,ol,0,Li,Ks),qw=new nh(new Array(0),WN,0,c2,GN)},Yw=r=>{let e;for(e=0;e<Oa;e++)r.dyn_ltree[e*2]=0;for(e=0;e<Li;e++)r.dyn_dtree[e*2]=0;for(e=0;e<c2;e++)r.bl_tree[e*2]=0;r.dyn_ltree[l2*2]=1,r.opt_len=r.static_len=0,r.sym_next=r.matches=0},Qw=r=>{r.bi_valid>8?$a(r,r.bi_buf):r.bi_valid>0&&(r.pending_buf[r.pending++]=r.bi_buf),r.bi_buf=0,r.bi_valid=0},Q3=(r,e,t,n)=>{const s=e*2,i=t*2;return r[s]<r[i]||r[s]===r[i]&&n[e]<=n[t]},ih=(r,e,t)=>{const n=r.heap[t];let s=t<<1;for(;s<=r.heap_len&&(s<r.heap_len&&Q3(e,r.heap[s+1],r.heap[s],r.depth)&&s++,!Q3(e,n,r.heap[s],r.depth));)r.heap[t]=r.heap[s],t=s,s<<=1;r.heap[t]=n},J3=(r,e,t)=>{let n,s,i=0,o,a;if(r.sym_next!==0)do n=r.pending_buf[r.sym_buf+i++]&255,n+=(r.pending_buf[r.sym_buf+i++]&255)<<8,s=r.pending_buf[r.sym_buf+i++],n===0?zr(r,s,e):(o=xa[s],zr(r,o+Xa+1,e),a=l1[o],a!==0&&(s-=u2[o],zt(r,s,a)),n--,o=Hw(n),zr(r,o,t),a=ol[o],a!==0&&(n-=eu[o],zt(r,n,a)));while(i<r.sym_next);zr(r,l2,e)},u1=(r,e)=>{const t=e.dyn_tree,n=e.stat_desc.static_tree,s=e.stat_desc.has_stree,i=e.stat_desc.elems;let o,a,c=-1,u;for(r.heap_len=0,r.heap_max=Uw,o=0;o<i;o++)t[o*2]!==0?(r.heap[++r.heap_len]=c=o,r.depth[o]=0):t[o*2+1]=0;for(;r.heap_len<2;)u=r.heap[++r.heap_len]=c<2?++c:0,t[u*2]=1,r.depth[u]=0,r.opt_len--,s&&(r.static_len-=n[u*2+1]);for(e.max_code=c,o=r.heap_len>>1;o>=1;o--)ih(r,t,o);u=i;do o=r.heap[1],r.heap[1]=r.heap[r.heap_len--],ih(r,t,1),a=r.heap[1],r.heap[--r.heap_max]=o,r.heap[--r.heap_max]=a,t[u*2]=t[o*2]+t[a*2],r.depth[u]=(r.depth[o]>=r.depth[a]?r.depth[o]:r.depth[a])+1,t[o*2+1]=t[a*2+1]=u,r.heap[1]=u++,ih(r,t,1);while(r.heap_len>=2);r.heap[--r.heap_max]=r.heap[1],JN(r,e),Ww(t,c,r.bl_count)},X3=(r,e,t)=>{let n,s=-1,i,o=e[0*2+1],a=0,c=7,u=4;for(o===0&&(c=138,u=3),e[(t+1)*2+1]=65535,n=0;n<=t;n++)i=o,o=e[(n+1)*2+1],!(++a<c&&i===o)&&(a<u?r.bl_tree[i*2]+=a:i!==0?(i!==s&&r.bl_tree[i*2]++,r.bl_tree[Bw*2]++):a<=10?r.bl_tree[zw*2]++:r.bl_tree[Fw*2]++,a=0,s=i,o===0?(c=138,u=3):i===o?(c=6,u=3):(c=7,u=4))},Z3=(r,e,t)=>{let n,s=-1,i,o=e[0*2+1],a=0,c=7,u=4;for(o===0&&(c=138,u=3),n=0;n<=t;n++)if(i=o,o=e[(n+1)*2+1],!(++a<c&&i===o)){if(a<u)do zr(r,i,r.bl_tree);while(--a!==0);else i!==0?(i!==s&&(zr(r,i,r.bl_tree),a--),zr(r,Bw,r.bl_tree),zt(r,a-3,2)):a<=10?(zr(r,zw,r.bl_tree),zt(r,a-3,3)):(zr(r,Fw,r.bl_tree),zt(r,a-11,7));a=0,s=i,o===0?(c=138,u=3):i===o?(c=6,u=3):(c=7,u=4)}},ZN=r=>{let e;for(X3(r,r.dyn_ltree,r.l_desc.max_code),X3(r,r.dyn_dtree,r.d_desc.max_code),u1(r,r.bl_desc),e=c2-1;e>=3&&r.bl_tree[Vw[e]*2+1]===0;e--);return r.opt_len+=3*(e+1)+5+5+4,e},ex=(r,e,t,n)=>{let s;for(zt(r,e-257,5),zt(r,t-1,5),zt(r,n-4,4),s=0;s<n;s++)zt(r,r.bl_tree[Vw[s]*2+1],3);Z3(r,r.dyn_ltree,e-1),Z3(r,r.dyn_dtree,t-1)},tx=r=>{let e=4093624447,t;for(t=0;t<=31;t++,e>>>=1)if(e&1&&r.dyn_ltree[t*2]!==0)return W3;if(r.dyn_ltree[9*2]!==0||r.dyn_ltree[10*2]!==0||r.dyn_ltree[13*2]!==0)return Y3;for(t=32;t<Xa;t++)if(r.dyn_ltree[t*2]!==0)return Y3;return W3};let eg=!1;const rx=r=>{eg||(XN(),eg=!0),r.l_desc=new sh(r.dyn_ltree,jw),r.d_desc=new sh(r.dyn_dtree,Kw),r.bl_desc=new sh(r.bl_tree,qw),r.bi_buf=0,r.bi_valid=0,Yw(r)},Jw=(r,e,t,n)=>{zt(r,(jN<<1)+(n?1:0),3),Qw(r),$a(r,t),$a(r,~t),t&&r.pending_buf.set(r.window.subarray(e,e+t),r.pending),r.pending+=t},nx=r=>{zt(r,Mw<<1,3),zr(r,l2,gn),QN(r)},sx=(r,e,t,n)=>{let s,i,o=0;r.level>0?(r.strm.data_type===VN&&(r.strm.data_type=tx(r)),u1(r,r.l_desc),u1(r,r.d_desc),o=ZN(r),s=r.opt_len+3+7>>>3,i=r.static_len+3+7>>>3,i<=s&&(s=i)):s=i=t+5,t+4<=s&&e!==-1?Jw(r,e,t,n):r.strategy===FN||i===s?(zt(r,(Mw<<1)+(n?1:0),3),J3(r,gn,ga)):(zt(r,(KN<<1)+(n?1:0),3),ex(r,r.l_desc.max_code+1,r.d_desc.max_code+1,o+1),J3(r,r.dyn_ltree,r.dyn_dtree)),Yw(r),n&&Qw(r)},ix=(r,e,t)=>(r.pending_buf[r.sym_buf+r.sym_next++]=e,r.pending_buf[r.sym_buf+r.sym_next++]=e>>8,r.pending_buf[r.sym_buf+r.sym_next++]=t,e===0?r.dyn_ltree[t*2]++:(r.matches++,e--,r.dyn_ltree[(xa[t]+Xa+1)*2]++,r.dyn_dtree[Hw(e)*2]++),r.sym_next===r.sym_end);var ox=rx,ax=Jw,cx=sx,lx=ix,ux=nx,dx={_tr_init:ox,_tr_stored_block:ax,_tr_flush_block:cx,_tr_tally:lx,_tr_align:ux};const hx=(r,e,t,n)=>{let s=r&65535|0,i=r>>>16&65535|0,o=0;for(;t!==0;){o=t>2e3?2e3:t,t-=o;do s=s+e[n++]|0,i=i+s|0;while(--o);s%=65521,i%=65521}return s|i<<16|0};var La=hx;const fx=()=>{let r,e=[];for(var t=0;t<256;t++){r=t;for(var n=0;n<8;n++)r=r&1?3988292384^r>>>1:r>>>1;e[t]=r}return e},px=new Uint32Array(fx()),gx=(r,e,t,n)=>{const s=px,i=n+t;r^=-1;for(let o=n;o<i;o++)r=r>>>8^s[(r^e[o])&255];return r^-1};var ct=gx,ei={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ai={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:yx,_tr_stored_block:d1,_tr_flush_block:wx,_tr_tally:vs,_tr_align:mx}=dx,{Z_NO_FLUSH:Ss,Z_PARTIAL_FLUSH:bx,Z_FULL_FLUSH:Ex,Z_FINISH:ar,Z_BLOCK:tg,Z_OK:wt,Z_STREAM_END:rg,Z_STREAM_ERROR:Kr,Z_DATA_ERROR:_x,Z_BUF_ERROR:oh,Z_DEFAULT_COMPRESSION:vx,Z_FILTERED:Sx,Z_HUFFMAN_ONLY:_c,Z_RLE:Rx,Z_FIXED:Ix,Z_DEFAULT_STRATEGY:Ax,Z_UNKNOWN:Cx,Z_DEFLATED:md}=ai,Tx=9,Dx=15,Px=8,kx=29,Ox=256,h1=Ox+1+kx,Nx=30,xx=19,$x=2*h1+1,Lx=15,se=3,gs=258,qr=gs+se+1,Mx=32,Qi=42,d2=57,f1=69,p1=73,g1=91,y1=103,qs=113,ra=666,$t=1,ho=2,ti=3,fo=4,Ux=3,Hs=(r,e)=>(r.msg=ei[e],e),ng=r=>r*2-(r>4?9:0),fs=r=>{let e=r.length;for(;--e>=0;)r[e]=0},Bx=r=>{let e,t,n,s=r.w_size;e=r.hash_size,n=e;do t=r.head[--n],r.head[n]=t>=s?t-s:0;while(--e);e=s,n=e;do t=r.prev[--n],r.prev[n]=t>=s?t-s:0;while(--e)};let zx=(r,e,t)=>(e<<r.hash_shift^t)&r.hash_mask,Rs=zx;const Kt=r=>{const e=r.state;let t=e.pending;t>r.avail_out&&(t=r.avail_out),t!==0&&(r.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+t),r.next_out),r.next_out+=t,e.pending_out+=t,r.total_out+=t,r.avail_out-=t,e.pending-=t,e.pending===0&&(e.pending_out=0))},Wt=(r,e)=>{wx(r,r.block_start>=0?r.block_start:-1,r.strstart-r.block_start,e),r.block_start=r.strstart,Kt(r.strm)},he=(r,e)=>{r.pending_buf[r.pending++]=e},xo=(r,e)=>{r.pending_buf[r.pending++]=e>>>8&255,r.pending_buf[r.pending++]=e&255},w1=(r,e,t,n)=>{let s=r.avail_in;return s>n&&(s=n),s===0?0:(r.avail_in-=s,e.set(r.input.subarray(r.next_in,r.next_in+s),t),r.state.wrap===1?r.adler=La(r.adler,e,s,t):r.state.wrap===2&&(r.adler=ct(r.adler,e,s,t)),r.next_in+=s,r.total_in+=s,s)},Xw=(r,e)=>{let t=r.max_chain_length,n=r.strstart,s,i,o=r.prev_length,a=r.nice_match;const c=r.strstart>r.w_size-qr?r.strstart-(r.w_size-qr):0,u=r.window,l=r.w_mask,d=r.prev,f=r.strstart+gs;let g=u[n+o-1],h=u[n+o];r.prev_length>=r.good_match&&(t>>=2),a>r.lookahead&&(a=r.lookahead);do if(s=e,!(u[s+o]!==h||u[s+o-1]!==g||u[s]!==u[n]||u[++s]!==u[n+1])){n+=2,s++;do;while(u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&n<f);if(i=gs-(f-n),n=f-gs,i>o){if(r.match_start=e,o=i,i>=a)break;g=u[n+o-1],h=u[n+o]}}while((e=d[e&l])>c&&--t!==0);return o<=r.lookahead?o:r.lookahead},Ji=r=>{const e=r.w_size;let t,n,s;do{if(n=r.window_size-r.lookahead-r.strstart,r.strstart>=e+(e-qr)&&(r.window.set(r.window.subarray(e,e+e-n),0),r.match_start-=e,r.strstart-=e,r.block_start-=e,r.insert>r.strstart&&(r.insert=r.strstart),Bx(r),n+=e),r.strm.avail_in===0)break;if(t=w1(r.strm,r.window,r.strstart+r.lookahead,n),r.lookahead+=t,r.lookahead+r.insert>=se)for(s=r.strstart-r.insert,r.ins_h=r.window[s],r.ins_h=Rs(r,r.ins_h,r.window[s+1]);r.insert&&(r.ins_h=Rs(r,r.ins_h,r.window[s+se-1]),r.prev[s&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=s,s++,r.insert--,!(r.lookahead+r.insert<se)););}while(r.lookahead<qr&&r.strm.avail_in!==0)},Zw=(r,e)=>{let t=r.pending_buf_size-5>r.w_size?r.w_size:r.pending_buf_size-5,n,s,i,o=0,a=r.strm.avail_in;do{if(n=65535,i=r.bi_valid+42>>3,r.strm.avail_out<i||(i=r.strm.avail_out-i,s=r.strstart-r.block_start,n>s+r.strm.avail_in&&(n=s+r.strm.avail_in),n>i&&(n=i),n<t&&(n===0&&e!==ar||e===Ss||n!==s+r.strm.avail_in)))break;o=e===ar&&n===s+r.strm.avail_in?1:0,d1(r,0,0,o),r.pending_buf[r.pending-4]=n,r.pending_buf[r.pending-3]=n>>8,r.pending_buf[r.pending-2]=~n,r.pending_buf[r.pending-1]=~n>>8,Kt(r.strm),s&&(s>n&&(s=n),r.strm.output.set(r.window.subarray(r.block_start,r.block_start+s),r.strm.next_out),r.strm.next_out+=s,r.strm.avail_out-=s,r.strm.total_out+=s,r.block_start+=s,n-=s),n&&(w1(r.strm,r.strm.output,r.strm.next_out,n),r.strm.next_out+=n,r.strm.avail_out-=n,r.strm.total_out+=n)}while(o===0);return a-=r.strm.avail_in,a&&(a>=r.w_size?(r.matches=2,r.window.set(r.strm.input.subarray(r.strm.next_in-r.w_size,r.strm.next_in),0),r.strstart=r.w_size,r.insert=r.strstart):(r.window_size-r.strstart<=a&&(r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,r.insert>r.strstart&&(r.insert=r.strstart)),r.window.set(r.strm.input.subarray(r.strm.next_in-a,r.strm.next_in),r.strstart),r.strstart+=a,r.insert+=a>r.w_size-r.insert?r.w_size-r.insert:a),r.block_start=r.strstart),r.high_water<r.strstart&&(r.high_water=r.strstart),o?fo:e!==Ss&&e!==ar&&r.strm.avail_in===0&&r.strstart===r.block_start?ho:(i=r.window_size-r.strstart,r.strm.avail_in>i&&r.block_start>=r.w_size&&(r.block_start-=r.w_size,r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,i+=r.w_size,r.insert>r.strstart&&(r.insert=r.strstart)),i>r.strm.avail_in&&(i=r.strm.avail_in),i&&(w1(r.strm,r.window,r.strstart,i),r.strstart+=i,r.insert+=i>r.w_size-r.insert?r.w_size-r.insert:i),r.high_water<r.strstart&&(r.high_water=r.strstart),i=r.bi_valid+42>>3,i=r.pending_buf_size-i>65535?65535:r.pending_buf_size-i,t=i>r.w_size?r.w_size:i,s=r.strstart-r.block_start,(s>=t||(s||e===ar)&&e!==Ss&&r.strm.avail_in===0&&s<=i)&&(n=s>i?i:s,o=e===ar&&r.strm.avail_in===0&&n===s?1:0,d1(r,r.block_start,n,o),r.block_start+=n,Kt(r.strm)),o?ti:$t)},ah=(r,e)=>{let t,n;for(;;){if(r.lookahead<qr){if(Ji(r),r.lookahead<qr&&e===Ss)return $t;if(r.lookahead===0)break}if(t=0,r.lookahead>=se&&(r.ins_h=Rs(r,r.ins_h,r.window[r.strstart+se-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),t!==0&&r.strstart-t<=r.w_size-qr&&(r.match_length=Xw(r,t)),r.match_length>=se)if(n=vs(r,r.strstart-r.match_start,r.match_length-se),r.lookahead-=r.match_length,r.match_length<=r.max_lazy_match&&r.lookahead>=se){r.match_length--;do r.strstart++,r.ins_h=Rs(r,r.ins_h,r.window[r.strstart+se-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart;while(--r.match_length!==0);r.strstart++}else r.strstart+=r.match_length,r.match_length=0,r.ins_h=r.window[r.strstart],r.ins_h=Rs(r,r.ins_h,r.window[r.strstart+1]);else n=vs(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++;if(n&&(Wt(r,!1),r.strm.avail_out===0))return $t}return r.insert=r.strstart<se-1?r.strstart:se-1,e===ar?(Wt(r,!0),r.strm.avail_out===0?ti:fo):r.sym_next&&(Wt(r,!1),r.strm.avail_out===0)?$t:ho},pi=(r,e)=>{let t,n,s;for(;;){if(r.lookahead<qr){if(Ji(r),r.lookahead<qr&&e===Ss)return $t;if(r.lookahead===0)break}if(t=0,r.lookahead>=se&&(r.ins_h=Rs(r,r.ins_h,r.window[r.strstart+se-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),r.prev_length=r.match_length,r.prev_match=r.match_start,r.match_length=se-1,t!==0&&r.prev_length<r.max_lazy_match&&r.strstart-t<=r.w_size-qr&&(r.match_length=Xw(r,t),r.match_length<=5&&(r.strategy===Sx||r.match_length===se&&r.strstart-r.match_start>4096)&&(r.match_length=se-1)),r.prev_length>=se&&r.match_length<=r.prev_length){s=r.strstart+r.lookahead-se,n=vs(r,r.strstart-1-r.prev_match,r.prev_length-se),r.lookahead-=r.prev_length-1,r.prev_length-=2;do++r.strstart<=s&&(r.ins_h=Rs(r,r.ins_h,r.window[r.strstart+se-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart);while(--r.prev_length!==0);if(r.match_available=0,r.match_length=se-1,r.strstart++,n&&(Wt(r,!1),r.strm.avail_out===0))return $t}else if(r.match_available){if(n=vs(r,0,r.window[r.strstart-1]),n&&Wt(r,!1),r.strstart++,r.lookahead--,r.strm.avail_out===0)return $t}else r.match_available=1,r.strstart++,r.lookahead--}return r.match_available&&(n=vs(r,0,r.window[r.strstart-1]),r.match_available=0),r.insert=r.strstart<se-1?r.strstart:se-1,e===ar?(Wt(r,!0),r.strm.avail_out===0?ti:fo):r.sym_next&&(Wt(r,!1),r.strm.avail_out===0)?$t:ho},Fx=(r,e)=>{let t,n,s,i;const o=r.window;for(;;){if(r.lookahead<=gs){if(Ji(r),r.lookahead<=gs&&e===Ss)return $t;if(r.lookahead===0)break}if(r.match_length=0,r.lookahead>=se&&r.strstart>0&&(s=r.strstart-1,n=o[s],n===o[++s]&&n===o[++s]&&n===o[++s])){i=r.strstart+gs;do;while(n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&s<i);r.match_length=gs-(i-s),r.match_length>r.lookahead&&(r.match_length=r.lookahead)}if(r.match_length>=se?(t=vs(r,1,r.match_length-se),r.lookahead-=r.match_length,r.strstart+=r.match_length,r.match_length=0):(t=vs(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++),t&&(Wt(r,!1),r.strm.avail_out===0))return $t}return r.insert=0,e===ar?(Wt(r,!0),r.strm.avail_out===0?ti:fo):r.sym_next&&(Wt(r,!1),r.strm.avail_out===0)?$t:ho},Vx=(r,e)=>{let t;for(;;){if(r.lookahead===0&&(Ji(r),r.lookahead===0)){if(e===Ss)return $t;break}if(r.match_length=0,t=vs(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++,t&&(Wt(r,!1),r.strm.avail_out===0))return $t}return r.insert=0,e===ar?(Wt(r,!0),r.strm.avail_out===0?ti:fo):r.sym_next&&(Wt(r,!1),r.strm.avail_out===0)?$t:ho};function Pr(r,e,t,n,s){this.good_length=r,this.max_lazy=e,this.nice_length=t,this.max_chain=n,this.func=s}const na=[new Pr(0,0,0,0,Zw),new Pr(4,4,8,4,ah),new Pr(4,5,16,8,ah),new Pr(4,6,32,32,ah),new Pr(4,4,16,16,pi),new Pr(8,16,32,32,pi),new Pr(8,16,128,128,pi),new Pr(8,32,128,256,pi),new Pr(32,128,258,1024,pi),new Pr(32,258,258,4096,pi)],jx=r=>{r.window_size=2*r.w_size,fs(r.head),r.max_lazy_match=na[r.level].max_lazy,r.good_match=na[r.level].good_length,r.nice_match=na[r.level].nice_length,r.max_chain_length=na[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=se-1,r.match_available=0,r.ins_h=0};function Kx(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=md,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array($x*2),this.dyn_dtree=new Uint16Array((2*Nx+1)*2),this.bl_tree=new Uint16Array((2*xx+1)*2),fs(this.dyn_ltree),fs(this.dyn_dtree),fs(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(Lx+1),this.heap=new Uint16Array(2*h1+1),fs(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*h1+1),fs(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Za=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.status!==Qi&&e.status!==d2&&e.status!==f1&&e.status!==p1&&e.status!==g1&&e.status!==y1&&e.status!==qs&&e.status!==ra?1:0},em=r=>{if(Za(r))return Hs(r,Kr);r.total_in=r.total_out=0,r.data_type=Cx;const e=r.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?d2:e.wrap?Qi:qs,r.adler=e.wrap===2?0:1,e.last_flush=-2,yx(e),wt},tm=r=>{const e=em(r);return e===wt&&jx(r.state),e},qx=(r,e)=>Za(r)||r.state.wrap!==2?Kr:(r.state.gzhead=e,wt),rm=(r,e,t,n,s,i)=>{if(!r)return Kr;let o=1;if(e===vx&&(e=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),s<1||s>Tx||t!==md||n<8||n>15||e<0||e>9||i<0||i>Ix||n===8&&o!==1)return Hs(r,Kr);n===8&&(n=9);const a=new Kx;return r.state=a,a.strm=r,a.status=Qi,a.wrap=o,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+se-1)/se),a.window=new Uint8Array(a.w_size*2),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=a.lit_bufsize*4,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=(a.lit_bufsize-1)*3,a.level=e,a.strategy=i,a.method=t,tm(r)},Hx=(r,e)=>rm(r,e,md,Dx,Px,Ax),Gx=(r,e)=>{if(Za(r)||e>tg||e<0)return r?Hs(r,Kr):Kr;const t=r.state;if(!r.output||r.avail_in!==0&&!r.input||t.status===ra&&e!==ar)return Hs(r,r.avail_out===0?oh:Kr);const n=t.last_flush;if(t.last_flush=e,t.pending!==0){if(Kt(r),r.avail_out===0)return t.last_flush=-1,wt}else if(r.avail_in===0&&ng(e)<=ng(n)&&e!==ar)return Hs(r,oh);if(t.status===ra&&r.avail_in!==0)return Hs(r,oh);if(t.status===Qi&&t.wrap===0&&(t.status=qs),t.status===Qi){let s=md+(t.w_bits-8<<4)<<8,i=-1;if(t.strategy>=_c||t.level<2?i=0:t.level<6?i=1:t.level===6?i=2:i=3,s|=i<<6,t.strstart!==0&&(s|=Mx),s+=31-s%31,xo(t,s),t.strstart!==0&&(xo(t,r.adler>>>16),xo(t,r.adler&65535)),r.adler=1,t.status=qs,Kt(r),t.pending!==0)return t.last_flush=-1,wt}if(t.status===d2){if(r.adler=0,he(t,31),he(t,139),he(t,8),t.gzhead)he(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),he(t,t.gzhead.time&255),he(t,t.gzhead.time>>8&255),he(t,t.gzhead.time>>16&255),he(t,t.gzhead.time>>24&255),he(t,t.level===9?2:t.strategy>=_c||t.level<2?4:0),he(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(he(t,t.gzhead.extra.length&255),he(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(r.adler=ct(r.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=f1;else if(he(t,0),he(t,0),he(t,0),he(t,0),he(t,0),he(t,t.level===9?2:t.strategy>=_c||t.level<2?4:0),he(t,Ux),t.status=qs,Kt(r),t.pending!==0)return t.last_flush=-1,wt}if(t.status===f1){if(t.gzhead.extra){let s=t.pending,i=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+i>t.pending_buf_size;){let a=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+a),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex+=a,Kt(r),t.pending!==0)return t.last_flush=-1,wt;s=0,i-=a}let o=new Uint8Array(t.gzhead.extra);t.pending_buf.set(o.subarray(t.gzindex,t.gzindex+i),t.pending),t.pending+=i,t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=p1}if(t.status===p1){if(t.gzhead.name){let s=t.pending,i;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),Kt(r),t.pending!==0)return t.last_flush=-1,wt;s=0}t.gzindex<t.gzhead.name.length?i=t.gzhead.name.charCodeAt(t.gzindex++)&255:i=0,he(t,i)}while(i!==0);t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=g1}if(t.status===g1){if(t.gzhead.comment){let s=t.pending,i;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s)),Kt(r),t.pending!==0)return t.last_flush=-1,wt;s=0}t.gzindex<t.gzhead.comment.length?i=t.gzhead.comment.charCodeAt(t.gzindex++)&255:i=0,he(t,i)}while(i!==0);t.gzhead.hcrc&&t.pending>s&&(r.adler=ct(r.adler,t.pending_buf,t.pending-s,s))}t.status=y1}if(t.status===y1){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(Kt(r),t.pending!==0))return t.last_flush=-1,wt;he(t,r.adler&255),he(t,r.adler>>8&255),r.adler=0}if(t.status=qs,Kt(r),t.pending!==0)return t.last_flush=-1,wt}if(r.avail_in!==0||t.lookahead!==0||e!==Ss&&t.status!==ra){let s=t.level===0?Zw(t,e):t.strategy===_c?Vx(t,e):t.strategy===Rx?Fx(t,e):na[t.level].func(t,e);if((s===ti||s===fo)&&(t.status=ra),s===$t||s===ti)return r.avail_out===0&&(t.last_flush=-1),wt;if(s===ho&&(e===bx?mx(t):e!==tg&&(d1(t,0,0,!1),e===Ex&&(fs(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),Kt(r),r.avail_out===0))return t.last_flush=-1,wt}return e!==ar?wt:t.wrap<=0?rg:(t.wrap===2?(he(t,r.adler&255),he(t,r.adler>>8&255),he(t,r.adler>>16&255),he(t,r.adler>>24&255),he(t,r.total_in&255),he(t,r.total_in>>8&255),he(t,r.total_in>>16&255),he(t,r.total_in>>24&255)):(xo(t,r.adler>>>16),xo(t,r.adler&65535)),Kt(r),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?wt:rg)},Wx=r=>{if(Za(r))return Kr;const e=r.state.status;return r.state=null,e===qs?Hs(r,_x):wt},Yx=(r,e)=>{let t=e.length;if(Za(r))return Kr;const n=r.state,s=n.wrap;if(s===2||s===1&&n.status!==Qi||n.lookahead)return Kr;if(s===1&&(r.adler=La(r.adler,e,t,0)),n.wrap=0,t>=n.w_size){s===0&&(fs(n.head),n.strstart=0,n.block_start=0,n.insert=0);let c=new Uint8Array(n.w_size);c.set(e.subarray(t-n.w_size,t),0),e=c,t=n.w_size}const i=r.avail_in,o=r.next_in,a=r.input;for(r.avail_in=t,r.next_in=0,r.input=e,Ji(n);n.lookahead>=se;){let c=n.strstart,u=n.lookahead-(se-1);do n.ins_h=Rs(n,n.ins_h,n.window[c+se-1]),n.prev[c&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=c,c++;while(--u);n.strstart=c,n.lookahead=se-1,Ji(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=se-1,n.match_available=0,r.next_in=o,r.input=a,r.avail_in=i,n.wrap=s,wt};var Qx=Hx,Jx=rm,Xx=tm,Zx=em,e$=qx,t$=Gx,r$=Wx,n$=Yx,s$="pako deflate (from Nodeca project)",ya={deflateInit:Qx,deflateInit2:Jx,deflateReset:Xx,deflateResetKeep:Zx,deflateSetHeader:e$,deflate:t$,deflateEnd:r$,deflateSetDictionary:n$,deflateInfo:s$};const i$=(r,e)=>Object.prototype.hasOwnProperty.call(r,e);var o$=function(r){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const t=e.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const n in t)i$(t,n)&&(r[n]=t[n])}}return r},a$=r=>{let e=0;for(let n=0,s=r.length;n<s;n++)e+=r[n].length;const t=new Uint8Array(e);for(let n=0,s=0,i=r.length;n<i;n++){let o=r[n];t.set(o,s),s+=o.length}return t},bd={assign:o$,flattenChunks:a$};let nm=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{nm=!1}const Ma=new Uint8Array(256);for(let r=0;r<256;r++)Ma[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;Ma[254]=Ma[254]=1;var c$=r=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(r);let e,t,n,s,i,o=r.length,a=0;for(s=0;s<o;s++)t=r.charCodeAt(s),(t&64512)===55296&&s+1<o&&(n=r.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),a+=t<128?1:t<2048?2:t<65536?3:4;for(e=new Uint8Array(a),i=0,s=0;i<a;s++)t=r.charCodeAt(s),(t&64512)===55296&&s+1<o&&(n=r.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),t<128?e[i++]=t:t<2048?(e[i++]=192|t>>>6,e[i++]=128|t&63):t<65536?(e[i++]=224|t>>>12,e[i++]=128|t>>>6&63,e[i++]=128|t&63):(e[i++]=240|t>>>18,e[i++]=128|t>>>12&63,e[i++]=128|t>>>6&63,e[i++]=128|t&63);return e};const l$=(r,e)=>{if(e<65534&&r.subarray&&nm)return String.fromCharCode.apply(null,r.length===e?r:r.subarray(0,e));let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(r[n]);return t};var u$=(r,e)=>{const t=e||r.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(r.subarray(0,e));let n,s;const i=new Array(t*2);for(s=0,n=0;n<t;){let o=r[n++];if(o<128){i[s++]=o;continue}let a=Ma[o];if(a>4){i[s++]=65533,n+=a-1;continue}for(o&=a===2?31:a===3?15:7;a>1&&n<t;)o=o<<6|r[n++]&63,a--;if(a>1){i[s++]=65533;continue}o<65536?i[s++]=o:(o-=65536,i[s++]=55296|o>>10&1023,i[s++]=56320|o&1023)}return l$(i,s)},d$=(r,e)=>{e=e||r.length,e>r.length&&(e=r.length);let t=e-1;for(;t>=0&&(r[t]&192)===128;)t--;return t<0||t===0?e:t+Ma[r[t]]>e?t:e},Ua={string2buf:c$,buf2string:u$,utf8border:d$};function h$(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var sm=h$;const im=Object.prototype.toString,{Z_NO_FLUSH:f$,Z_SYNC_FLUSH:p$,Z_FULL_FLUSH:g$,Z_FINISH:y$,Z_OK:tu,Z_STREAM_END:w$,Z_DEFAULT_COMPRESSION:m$,Z_DEFAULT_STRATEGY:b$,Z_DEFLATED:E$}=ai;function ec(r){this.options=bd.assign({level:m$,method:E$,chunkSize:16384,windowBits:15,memLevel:8,strategy:b$},r||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new sm,this.strm.avail_out=0;let t=ya.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(t!==tu)throw new Error(ei[t]);if(e.header&&ya.deflateSetHeader(this.strm,e.header),e.dictionary){let n;if(typeof e.dictionary=="string"?n=Ua.string2buf(e.dictionary):im.call(e.dictionary)==="[object ArrayBuffer]"?n=new Uint8Array(e.dictionary):n=e.dictionary,t=ya.deflateSetDictionary(this.strm,n),t!==tu)throw new Error(ei[t]);this._dict_set=!0}}ec.prototype.push=function(r,e){const t=this.strm,n=this.options.chunkSize;let s,i;if(this.ended)return!1;for(e===~~e?i=e:i=e===!0?y$:f$,typeof r=="string"?t.input=Ua.string2buf(r):im.call(r)==="[object ArrayBuffer]"?t.input=new Uint8Array(r):t.input=r,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),(i===p$||i===g$)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(s=ya.deflate(t,i),s===w$)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),s=ya.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===tu;if(t.avail_out===0){this.onData(t.output);continue}if(i>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0};ec.prototype.onData=function(r){this.chunks.push(r)};ec.prototype.onEnd=function(r){r===tu&&(this.result=bd.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};function h2(r,e){const t=new ec(e);if(t.push(r,!0),t.err)throw t.msg||ei[t.err];return t.result}function _$(r,e){return e=e||{},e.raw=!0,h2(r,e)}function v$(r,e){return e=e||{},e.gzip=!0,h2(r,e)}var S$=ec,R$=h2,I$=_$,A$=v$,C$=ai,T$={Deflate:S$,deflate:R$,deflateRaw:I$,gzip:A$,constants:C$};const vc=16209,D$=16191;var P$=function(e,t){let n,s,i,o,a,c,u,l,d,f,g,h,p,w,y,_,b,m,S,R,v,A,C,P;const $=e.state;n=e.next_in,C=e.input,s=n+(e.avail_in-5),i=e.next_out,P=e.output,o=i-(t-e.avail_out),a=i+(e.avail_out-257),c=$.dmax,u=$.wsize,l=$.whave,d=$.wnext,f=$.window,g=$.hold,h=$.bits,p=$.lencode,w=$.distcode,y=(1<<$.lenbits)-1,_=(1<<$.distbits)-1;e:do{h<15&&(g+=C[n++]<<h,h+=8,g+=C[n++]<<h,h+=8),b=p[g&y];t:for(;;){if(m=b>>>24,g>>>=m,h-=m,m=b>>>16&255,m===0)P[i++]=b&65535;else if(m&16){S=b&65535,m&=15,m&&(h<m&&(g+=C[n++]<<h,h+=8),S+=g&(1<<m)-1,g>>>=m,h-=m),h<15&&(g+=C[n++]<<h,h+=8,g+=C[n++]<<h,h+=8),b=w[g&_];r:for(;;){if(m=b>>>24,g>>>=m,h-=m,m=b>>>16&255,m&16){if(R=b&65535,m&=15,h<m&&(g+=C[n++]<<h,h+=8,h<m&&(g+=C[n++]<<h,h+=8)),R+=g&(1<<m)-1,R>c){e.msg="invalid distance too far back",$.mode=vc;break e}if(g>>>=m,h-=m,m=i-o,R>m){if(m=R-m,m>l&&$.sane){e.msg="invalid distance too far back",$.mode=vc;break e}if(v=0,A=f,d===0){if(v+=u-m,m<S){S-=m;do P[i++]=f[v++];while(--m);v=i-R,A=P}}else if(d<m){if(v+=u+d-m,m-=d,m<S){S-=m;do P[i++]=f[v++];while(--m);if(v=0,d<S){m=d,S-=m;do P[i++]=f[v++];while(--m);v=i-R,A=P}}}else if(v+=d-m,m<S){S-=m;do P[i++]=f[v++];while(--m);v=i-R,A=P}for(;S>2;)P[i++]=A[v++],P[i++]=A[v++],P[i++]=A[v++],S-=3;S&&(P[i++]=A[v++],S>1&&(P[i++]=A[v++]))}else{v=i-R;do P[i++]=P[v++],P[i++]=P[v++],P[i++]=P[v++],S-=3;while(S>2);S&&(P[i++]=P[v++],S>1&&(P[i++]=P[v++]))}}else if(m&64){e.msg="invalid distance code",$.mode=vc;break e}else{b=w[(b&65535)+(g&(1<<m)-1)];continue r}break}}else if(m&64)if(m&32){$.mode=D$;break e}else{e.msg="invalid literal/length code",$.mode=vc;break e}else{b=p[(b&65535)+(g&(1<<m)-1)];continue t}break}}while(n<s&&i<a);S=h>>3,n-=S,h-=S<<3,g&=(1<<h)-1,e.next_in=n,e.next_out=i,e.avail_in=n<s?5+(s-n):5-(n-s),e.avail_out=i<a?257+(a-i):257-(i-a),$.hold=g,$.bits=h};const gi=15,sg=852,ig=592,og=0,ch=1,ag=2,k$=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),O$=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),N$=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),x$=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),$$=(r,e,t,n,s,i,o,a)=>{const c=a.bits;let u=0,l=0,d=0,f=0,g=0,h=0,p=0,w=0,y=0,_=0,b,m,S,R,v,A=null,C;const P=new Uint16Array(gi+1),$=new Uint16Array(gi+1);let F=null,W,Q,z;for(u=0;u<=gi;u++)P[u]=0;for(l=0;l<n;l++)P[e[t+l]]++;for(g=c,f=gi;f>=1&&P[f]===0;f--);if(g>f&&(g=f),f===0)return s[i++]=1<<24|64<<16|0,s[i++]=1<<24|64<<16|0,a.bits=1,0;for(d=1;d<f&&P[d]===0;d++);for(g<d&&(g=d),w=1,u=1;u<=gi;u++)if(w<<=1,w-=P[u],w<0)return-1;if(w>0&&(r===og||f!==1))return-1;for($[1]=0,u=1;u<gi;u++)$[u+1]=$[u]+P[u];for(l=0;l<n;l++)e[t+l]!==0&&(o[$[e[t+l]]++]=l);if(r===og?(A=F=o,C=20):r===ch?(A=k$,F=O$,C=257):(A=N$,F=x$,C=0),_=0,l=0,u=d,v=i,h=g,p=0,S=-1,y=1<<g,R=y-1,r===ch&&y>sg||r===ag&&y>ig)return 1;for(;;){W=u-p,o[l]+1<C?(Q=0,z=o[l]):o[l]>=C?(Q=F[o[l]-C],z=A[o[l]-C]):(Q=32+64,z=0),b=1<<u-p,m=1<<h,d=m;do m-=b,s[v+(_>>p)+m]=W<<24|Q<<16|z|0;while(m!==0);for(b=1<<u-1;_&b;)b>>=1;if(b!==0?(_&=b-1,_+=b):_=0,l++,--P[u]===0){if(u===f)break;u=e[t+o[l]]}if(u>g&&(_&R)!==S){for(p===0&&(p=g),v+=d,h=u-p,w=1<<h;h+p<f&&(w-=P[h+p],!(w<=0));)h++,w<<=1;if(y+=1<<h,r===ch&&y>sg||r===ag&&y>ig)return 1;S=_&R,s[S]=g<<24|h<<16|v-i|0}}return _!==0&&(s[v+_]=u-p<<24|64<<16|0),a.bits=g,0};var wa=$$;const L$=0,om=1,am=2,{Z_FINISH:cg,Z_BLOCK:M$,Z_TREES:Sc,Z_OK:ri,Z_STREAM_END:U$,Z_NEED_DICT:B$,Z_STREAM_ERROR:hr,Z_DATA_ERROR:cm,Z_MEM_ERROR:lm,Z_BUF_ERROR:z$,Z_DEFLATED:lg}=ai,Ed=16180,ug=16181,dg=16182,hg=16183,fg=16184,pg=16185,gg=16186,yg=16187,wg=16188,mg=16189,ru=16190,on=16191,lh=16192,bg=16193,uh=16194,Eg=16195,_g=16196,vg=16197,Sg=16198,Rc=16199,Ic=16200,Rg=16201,Ig=16202,Ag=16203,Cg=16204,Tg=16205,dh=16206,Dg=16207,Pg=16208,Te=16209,um=16210,dm=16211,F$=852,V$=592,j$=15,K$=j$,kg=r=>(r>>>24&255)+(r>>>8&65280)+((r&65280)<<8)+((r&255)<<24);function q$(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const ci=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.mode<Ed||e.mode>dm?1:0},hm=r=>{if(ci(r))return hr;const e=r.state;return r.total_in=r.total_out=e.total=0,r.msg="",e.wrap&&(r.adler=e.wrap&1),e.mode=Ed,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(F$),e.distcode=e.distdyn=new Int32Array(V$),e.sane=1,e.back=-1,ri},fm=r=>{if(ci(r))return hr;const e=r.state;return e.wsize=0,e.whave=0,e.wnext=0,hm(r)},pm=(r,e)=>{let t;if(ci(r))return hr;const n=r.state;return e<0?(t=0,e=-e):(t=(e>>4)+5,e<48&&(e&=15)),e&&(e<8||e>15)?hr:(n.window!==null&&n.wbits!==e&&(n.window=null),n.wrap=t,n.wbits=e,fm(r))},gm=(r,e)=>{if(!r)return hr;const t=new q$;r.state=t,t.strm=r,t.window=null,t.mode=Ed;const n=pm(r,e);return n!==ri&&(r.state=null),n},H$=r=>gm(r,K$);let Og=!0,hh,fh;const G$=r=>{if(Og){hh=new Int32Array(512),fh=new Int32Array(32);let e=0;for(;e<144;)r.lens[e++]=8;for(;e<256;)r.lens[e++]=9;for(;e<280;)r.lens[e++]=7;for(;e<288;)r.lens[e++]=8;for(wa(om,r.lens,0,288,hh,0,r.work,{bits:9}),e=0;e<32;)r.lens[e++]=5;wa(am,r.lens,0,32,fh,0,r.work,{bits:5}),Og=!1}r.lencode=hh,r.lenbits=9,r.distcode=fh,r.distbits=5},ym=(r,e,t,n)=>{let s;const i=r.state;return i.window===null&&(i.wsize=1<<i.wbits,i.wnext=0,i.whave=0,i.window=new Uint8Array(i.wsize)),n>=i.wsize?(i.window.set(e.subarray(t-i.wsize,t),0),i.wnext=0,i.whave=i.wsize):(s=i.wsize-i.wnext,s>n&&(s=n),i.window.set(e.subarray(t-n,t-n+s),i.wnext),n-=s,n?(i.window.set(e.subarray(t-n,t),0),i.wnext=n,i.whave=i.wsize):(i.wnext+=s,i.wnext===i.wsize&&(i.wnext=0),i.whave<i.wsize&&(i.whave+=s))),0},W$=(r,e)=>{let t,n,s,i,o,a,c,u,l,d,f,g,h,p,w=0,y,_,b,m,S,R,v,A;const C=new Uint8Array(4);let P,$;const F=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(ci(r)||!r.output||!r.input&&r.avail_in!==0)return hr;t=r.state,t.mode===on&&(t.mode=lh),o=r.next_out,s=r.output,c=r.avail_out,i=r.next_in,n=r.input,a=r.avail_in,u=t.hold,l=t.bits,d=a,f=c,A=ri;e:for(;;)switch(t.mode){case Ed:if(t.wrap===0){t.mode=lh;break}for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.wrap&2&&u===35615){t.wbits===0&&(t.wbits=15),t.check=0,C[0]=u&255,C[1]=u>>>8&255,t.check=ct(t.check,C,2,0),u=0,l=0,t.mode=ug;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((u&255)<<8)+(u>>8))%31){r.msg="incorrect header check",t.mode=Te;break}if((u&15)!==lg){r.msg="unknown compression method",t.mode=Te;break}if(u>>>=4,l-=4,v=(u&15)+8,t.wbits===0&&(t.wbits=v),v>15||v>t.wbits){r.msg="invalid window size",t.mode=Te;break}t.dmax=1<<t.wbits,t.flags=0,r.adler=t.check=1,t.mode=u&512?mg:on,u=0,l=0;break;case ug:for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.flags=u,(t.flags&255)!==lg){r.msg="unknown compression method",t.mode=Te;break}if(t.flags&57344){r.msg="unknown header flags set",t.mode=Te;break}t.head&&(t.head.text=u>>8&1),t.flags&512&&t.wrap&4&&(C[0]=u&255,C[1]=u>>>8&255,t.check=ct(t.check,C,2,0)),u=0,l=0,t.mode=dg;case dg:for(;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.head&&(t.head.time=u),t.flags&512&&t.wrap&4&&(C[0]=u&255,C[1]=u>>>8&255,C[2]=u>>>16&255,C[3]=u>>>24&255,t.check=ct(t.check,C,4,0)),u=0,l=0,t.mode=hg;case hg:for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.head&&(t.head.xflags=u&255,t.head.os=u>>8),t.flags&512&&t.wrap&4&&(C[0]=u&255,C[1]=u>>>8&255,t.check=ct(t.check,C,2,0)),u=0,l=0,t.mode=fg;case fg:if(t.flags&1024){for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.length=u,t.head&&(t.head.extra_len=u),t.flags&512&&t.wrap&4&&(C[0]=u&255,C[1]=u>>>8&255,t.check=ct(t.check,C,2,0)),u=0,l=0}else t.head&&(t.head.extra=null);t.mode=pg;case pg:if(t.flags&1024&&(g=t.length,g>a&&(g=a),g&&(t.head&&(v=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(n.subarray(i,i+g),v)),t.flags&512&&t.wrap&4&&(t.check=ct(t.check,n,g,i)),a-=g,i+=g,t.length-=g),t.length))break e;t.length=0,t.mode=gg;case gg:if(t.flags&2048){if(a===0)break e;g=0;do v=n[i+g++],t.head&&v&&t.length<65536&&(t.head.name+=String.fromCharCode(v));while(v&&g<a);if(t.flags&512&&t.wrap&4&&(t.check=ct(t.check,n,g,i)),a-=g,i+=g,v)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=yg;case yg:if(t.flags&4096){if(a===0)break e;g=0;do v=n[i+g++],t.head&&v&&t.length<65536&&(t.head.comment+=String.fromCharCode(v));while(v&&g<a);if(t.flags&512&&t.wrap&4&&(t.check=ct(t.check,n,g,i)),a-=g,i+=g,v)break e}else t.head&&(t.head.comment=null);t.mode=wg;case wg:if(t.flags&512){for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.wrap&4&&u!==(t.check&65535)){r.msg="header crc mismatch",t.mode=Te;break}u=0,l=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),r.adler=t.check=0,t.mode=on;break;case mg:for(;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}r.adler=t.check=kg(u),u=0,l=0,t.mode=ru;case ru:if(t.havedict===0)return r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=u,t.bits=l,B$;r.adler=t.check=1,t.mode=on;case on:if(e===M$||e===Sc)break e;case lh:if(t.last){u>>>=l&7,l-=l&7,t.mode=dh;break}for(;l<3;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}switch(t.last=u&1,u>>>=1,l-=1,u&3){case 0:t.mode=bg;break;case 1:if(G$(t),t.mode=Rc,e===Sc){u>>>=2,l-=2;break e}break;case 2:t.mode=_g;break;case 3:r.msg="invalid block type",t.mode=Te}u>>>=2,l-=2;break;case bg:for(u>>>=l&7,l-=l&7;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if((u&65535)!==(u>>>16^65535)){r.msg="invalid stored block lengths",t.mode=Te;break}if(t.length=u&65535,u=0,l=0,t.mode=uh,e===Sc)break e;case uh:t.mode=Eg;case Eg:if(g=t.length,g){if(g>a&&(g=a),g>c&&(g=c),g===0)break e;s.set(n.subarray(i,i+g),o),a-=g,i+=g,c-=g,o+=g,t.length-=g;break}t.mode=on;break;case _g:for(;l<14;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.nlen=(u&31)+257,u>>>=5,l-=5,t.ndist=(u&31)+1,u>>>=5,l-=5,t.ncode=(u&15)+4,u>>>=4,l-=4,t.nlen>286||t.ndist>30){r.msg="too many length or distance symbols",t.mode=Te;break}t.have=0,t.mode=vg;case vg:for(;t.have<t.ncode;){for(;l<3;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.lens[F[t.have++]]=u&7,u>>>=3,l-=3}for(;t.have<19;)t.lens[F[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,P={bits:t.lenbits},A=wa(L$,t.lens,0,19,t.lencode,0,t.work,P),t.lenbits=P.bits,A){r.msg="invalid code lengths set",t.mode=Te;break}t.have=0,t.mode=Sg;case Sg:for(;t.have<t.nlen+t.ndist;){for(;w=t.lencode[u&(1<<t.lenbits)-1],y=w>>>24,_=w>>>16&255,b=w&65535,!(y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(b<16)u>>>=y,l-=y,t.lens[t.have++]=b;else{if(b===16){for($=y+2;l<$;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(u>>>=y,l-=y,t.have===0){r.msg="invalid bit length repeat",t.mode=Te;break}v=t.lens[t.have-1],g=3+(u&3),u>>>=2,l-=2}else if(b===17){for($=y+3;l<$;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=y,l-=y,v=0,g=3+(u&7),u>>>=3,l-=3}else{for($=y+7;l<$;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=y,l-=y,v=0,g=11+(u&127),u>>>=7,l-=7}if(t.have+g>t.nlen+t.ndist){r.msg="invalid bit length repeat",t.mode=Te;break}for(;g--;)t.lens[t.have++]=v}}if(t.mode===Te)break;if(t.lens[256]===0){r.msg="invalid code -- missing end-of-block",t.mode=Te;break}if(t.lenbits=9,P={bits:t.lenbits},A=wa(om,t.lens,0,t.nlen,t.lencode,0,t.work,P),t.lenbits=P.bits,A){r.msg="invalid literal/lengths set",t.mode=Te;break}if(t.distbits=6,t.distcode=t.distdyn,P={bits:t.distbits},A=wa(am,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,P),t.distbits=P.bits,A){r.msg="invalid distances set",t.mode=Te;break}if(t.mode=Rc,e===Sc)break e;case Rc:t.mode=Ic;case Ic:if(a>=6&&c>=258){r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=u,t.bits=l,P$(r,f),o=r.next_out,s=r.output,c=r.avail_out,i=r.next_in,n=r.input,a=r.avail_in,u=t.hold,l=t.bits,t.mode===on&&(t.back=-1);break}for(t.back=0;w=t.lencode[u&(1<<t.lenbits)-1],y=w>>>24,_=w>>>16&255,b=w&65535,!(y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(_&&!(_&240)){for(m=y,S=_,R=b;w=t.lencode[R+((u&(1<<m+S)-1)>>m)],y=w>>>24,_=w>>>16&255,b=w&65535,!(m+y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=m,l-=m,t.back+=m}if(u>>>=y,l-=y,t.back+=y,t.length=b,_===0){t.mode=Tg;break}if(_&32){t.back=-1,t.mode=on;break}if(_&64){r.msg="invalid literal/length code",t.mode=Te;break}t.extra=_&15,t.mode=Rg;case Rg:if(t.extra){for($=t.extra;l<$;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.length+=u&(1<<t.extra)-1,u>>>=t.extra,l-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=Ig;case Ig:for(;w=t.distcode[u&(1<<t.distbits)-1],y=w>>>24,_=w>>>16&255,b=w&65535,!(y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(!(_&240)){for(m=y,S=_,R=b;w=t.distcode[R+((u&(1<<m+S)-1)>>m)],y=w>>>24,_=w>>>16&255,b=w&65535,!(m+y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=m,l-=m,t.back+=m}if(u>>>=y,l-=y,t.back+=y,_&64){r.msg="invalid distance code",t.mode=Te;break}t.offset=b,t.extra=_&15,t.mode=Ag;case Ag:if(t.extra){for($=t.extra;l<$;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.offset+=u&(1<<t.extra)-1,u>>>=t.extra,l-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){r.msg="invalid distance too far back",t.mode=Te;break}t.mode=Cg;case Cg:if(c===0)break e;if(g=f-c,t.offset>g){if(g=t.offset-g,g>t.whave&&t.sane){r.msg="invalid distance too far back",t.mode=Te;break}g>t.wnext?(g-=t.wnext,h=t.wsize-g):h=t.wnext-g,g>t.length&&(g=t.length),p=t.window}else p=s,h=o-t.offset,g=t.length;g>c&&(g=c),c-=g,t.length-=g;do s[o++]=p[h++];while(--g);t.length===0&&(t.mode=Ic);break;case Tg:if(c===0)break e;s[o++]=t.length,c--,t.mode=Ic;break;case dh:if(t.wrap){for(;l<32;){if(a===0)break e;a--,u|=n[i++]<<l,l+=8}if(f-=c,r.total_out+=f,t.total+=f,t.wrap&4&&f&&(r.adler=t.check=t.flags?ct(t.check,s,f,o-f):La(t.check,s,f,o-f)),f=c,t.wrap&4&&(t.flags?u:kg(u))!==t.check){r.msg="incorrect data check",t.mode=Te;break}u=0,l=0}t.mode=Dg;case Dg:if(t.wrap&&t.flags){for(;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.wrap&4&&u!==(t.total&4294967295)){r.msg="incorrect length check",t.mode=Te;break}u=0,l=0}t.mode=Pg;case Pg:A=U$;break e;case Te:A=cm;break e;case um:return lm;case dm:default:return hr}return r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=u,t.bits=l,(t.wsize||f!==r.avail_out&&t.mode<Te&&(t.mode<dh||e!==cg))&&ym(r,r.output,r.next_out,f-r.avail_out),d-=r.avail_in,f-=r.avail_out,r.total_in+=d,r.total_out+=f,t.total+=f,t.wrap&4&&f&&(r.adler=t.check=t.flags?ct(t.check,s,f,r.next_out-f):La(t.check,s,f,r.next_out-f)),r.data_type=t.bits+(t.last?64:0)+(t.mode===on?128:0)+(t.mode===Rc||t.mode===uh?256:0),(d===0&&f===0||e===cg)&&A===ri&&(A=z$),A},Y$=r=>{if(ci(r))return hr;let e=r.state;return e.window&&(e.window=null),r.state=null,ri},Q$=(r,e)=>{if(ci(r))return hr;const t=r.state;return t.wrap&2?(t.head=e,e.done=!1,ri):hr},J$=(r,e)=>{const t=e.length;let n,s,i;return ci(r)||(n=r.state,n.wrap!==0&&n.mode!==ru)?hr:n.mode===ru&&(s=1,s=La(s,e,t,0),s!==n.check)?cm:(i=ym(r,e,t,t),i?(n.mode=um,lm):(n.havedict=1,ri))};var X$=fm,Z$=pm,eL=hm,tL=H$,rL=gm,nL=W$,sL=Y$,iL=Q$,oL=J$,aL="pako inflate (from Nodeca project)",yn={inflateReset:X$,inflateReset2:Z$,inflateResetKeep:eL,inflateInit:tL,inflateInit2:rL,inflate:nL,inflateEnd:sL,inflateGetHeader:iL,inflateSetDictionary:oL,inflateInfo:aL};function cL(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var lL=cL;const wm=Object.prototype.toString,{Z_NO_FLUSH:uL,Z_FINISH:dL,Z_OK:Ba,Z_STREAM_END:ph,Z_NEED_DICT:gh,Z_STREAM_ERROR:hL,Z_DATA_ERROR:Ng,Z_MEM_ERROR:fL}=ai;function tc(r){this.options=bd.assign({chunkSize:1024*64,windowBits:15,to:""},r||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),e.windowBits>=0&&e.windowBits<16&&!(r&&r.windowBits)&&(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(e.windowBits&15||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new sm,this.strm.avail_out=0;let t=yn.inflateInit2(this.strm,e.windowBits);if(t!==Ba)throw new Error(ei[t]);if(this.header=new lL,yn.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=Ua.string2buf(e.dictionary):wm.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(t=yn.inflateSetDictionary(this.strm,e.dictionary),t!==Ba)))throw new Error(ei[t])}tc.prototype.push=function(r,e){const t=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let i,o,a;if(this.ended)return!1;for(e===~~e?o=e:o=e===!0?dL:uL,wm.call(r)==="[object ArrayBuffer]"?t.input=new Uint8Array(r):t.input=r,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),i=yn.inflate(t,o),i===gh&&s&&(i=yn.inflateSetDictionary(t,s),i===Ba?i=yn.inflate(t,o):i===Ng&&(i=gh));t.avail_in>0&&i===ph&&t.state.wrap>0&&r[t.next_in]!==0;)yn.inflateReset(t),i=yn.inflate(t,o);switch(i){case hL:case Ng:case gh:case fL:return this.onEnd(i),this.ended=!0,!1}if(a=t.avail_out,t.next_out&&(t.avail_out===0||i===ph))if(this.options.to==="string"){let c=Ua.utf8border(t.output,t.next_out),u=t.next_out-c,l=Ua.buf2string(t.output,c);t.next_out=u,t.avail_out=n-u,u&&t.output.set(t.output.subarray(c,c+u),0),this.onData(l)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(i===Ba&&a===0)){if(i===ph)return i=yn.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};tc.prototype.onData=function(r){this.chunks.push(r)};tc.prototype.onEnd=function(r){r===Ba&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=bd.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};function f2(r,e){const t=new tc(e);if(t.push(r),t.err)throw t.msg||ei[t.err];return t.result}function pL(r,e){return e=e||{},e.raw=!0,f2(r,e)}var gL=tc,yL=f2,wL=pL,mL=f2,bL=ai,EL={Inflate:gL,inflate:yL,inflateRaw:wL,ungzip:mL,constants:bL};const{Deflate:_L,deflate:vL,deflateRaw:SL,gzip:RL}=T$,{Inflate:IL,inflate:AL,inflateRaw:CL,ungzip:TL}=EL;var DL=_L,PL=vL,kL=SL,OL=RL,NL=IL,xL=AL,$L=CL,LL=TL,ML=ai,xg={Deflate:DL,deflate:PL,deflateRaw:kL,gzip:OL,Inflate:NL,inflate:xL,inflateRaw:$L,ungzip:LL,constants:ML};const $g=6;function UL({repo:r,preload:e}){async function*t(n,s={}){if(s.compressionLevel!=null&&(s.compressionLevel<-1||s.compressionLevel>9))throw E(new Error("Compression level must be between -1 and 9"),"ERR_INVALID_PARAMS");if(s.preload!==!1){let a;try{a=q0(n).split("/")}catch(c){throw E(c,"ERR_INVALID_PATH")}e(V.parse(a[0]))}const i=V.asCID(n)||n,o=await Nn(i,r.blocks,s);if(o.type==="file"||o.type==="raw"){const a=[];!s.compress||s.archive===!0?a.push([{header:{name:o.path,mode:o.type==="file"&&o.unixfs.mode,mtime:o.type==="file"&&o.unixfs.mtime?new Date(o.unixfs.mtime.secs*1e3):void 0,size:o.size,type:"file"},body:o.content()}],G3()):a.push(o.content),s.compress&&a.push(async function*(c){const u=await df(c);yield xg.gzip(u,{level:s.compressionLevel||$g})}),yield*ne(...a);return}if(o.type==="directory"){const a=[$w(i,r.blocks,s),async function*(c){for await(const u of c){const l={header:{name:u.path,size:u.size}};if(u.type==="file")l.header.type="file",l.header.mode=u.unixfs.mode!=null?u.unixfs.mode:void 0,l.header.mtime=u.unixfs.mtime?new Date(u.unixfs.mtime.secs*1e3):void 0,l.body=u.content();else if(u.type==="raw")l.header.type="file",l.body=u.content();else if(u.type==="directory")l.header.type="directory",l.header.mode=u.unixfs.mode!=null?u.unixfs.mode:void 0,l.header.mtime=u.unixfs.mtime?new Date(u.unixfs.mtime.secs*1e3):void 0;else throw E(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");yield l}},G3()];if(s.compress){if(!s.archive)throw E(new Error("file is not regular"),"ERR_INVALID_PATH");s.compress&&a.push(async function*(c){const u=await df(c);yield xg.gzip(u,{level:s.compressionLevel||$g})})}yield*ne(...a);return}throw E(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS")}return x(t)}function BL({repo:r,preload:e}){async function*t(n,s={}){const i=q0(n),o=i.split("/");s.preload!==!1&&e(V.parse(o[0]));const a=V.asCID(i)||i,c=await Nn(a,r.blocks,s);if(c.type==="file"){yield l3(c);return}if(c.type==="directory"){for await(const u of c.content())yield l3(u);return}throw E(new Error(`Unknown UnixFS type ${c.type}`),"ERR_UNKNOWN_UNIXFS_TYPE")}return x(t)}class zL{constructor({preload:e,repo:t,hashers:n,options:s}){const i=gO({preload:e,repo:t,options:s,hashers:n});this.addAll=i,this.add=KD({addAll:i}),this.cat=mN({repo:t,preload:e}),this.get=UL({repo:t,preload:e}),this.ls=BL({repo:t,preload:e})}}const nu="0.17.0",FL="e8b7b66bfa98c2a1c0d0bfc19f698d7d00b6c888",VL="^0.157.0";function jL({repo:r}){async function e(t={}){const n=await r.version.get();return{version:nu,commit:FL,repo:`${n}`,"ipfs-core":nu,"interface-ipfs-core":VL}}return x(e)}const KL=O("ipfs:components:id");function qL({peerId:r,network:e}){async function t(n={}){const s=e.try();if(!s){if(n.peerId)throw new qa;if(r.publicKey==null)throw E(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");return{id:r,publicKey:q(r.publicKey,"base64pad"),addresses:[],agentVersion:`js-ipfs/${nu}`,protocolVersion:"9000",protocols:[]}}const{libp2p:i}=s,o=n.peerId?n.peerId:r,a=await HL(o,i,n),c=q(a.metadata.get("AgentVersion")||new Uint8Array),u=q(a.metadata.get("ProtocolVersion")||new Uint8Array),l=a.id.toString(),d=a.publicKey?q(a.publicKey,"base64pad"):"";return{id:o,publicKey:d,addresses:(a.addresses||[]).map(f=>{const g=f.toString();return g.endsWith(`/p2p/${l}`)?g:`${g}/p2p/${l}`}).sort().map(f=>X(f)),agentVersion:c,protocolVersion:u,protocols:(a.protocols||[]).sort()}}return x(t)}async function HL(r,e,t){let n=await e.peerStore.get(r);n||(n=await GL(r,e,t));let s=r.publicKey?r.publicKey:await e.peerStore.keyBook.get(r);if(s==null)try{s=await e.getPublicKey(r,t)}catch(i){KL.error("Could not load public key for",r.toString(),i)}return{...n,publicKey:s,metadata:n.metadata||new Map,addresses:n.addresses.map(i=>i.multiaddr)}}async function GL(r,e,t){if(e.dht==null)throw E(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");for await(const s of e.dht.findPeer(r,t))if(s.name==="FINAL_PEER")break;const n=await e.peerStore.get(r);if(!n)throw E(new Error("Could not find peer"),"ERR_NOT_FOUND");return n}var Ue=WL;function WL(r,e,t){var n,s;if(Array.isArray(e)&&(n=e.slice(0)),typeof e=="string"&&(n=e.split(".")),typeof e=="symbol"&&(n=[e]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");if(s=n.pop(),!s)return!1;Lg(s);for(var i;i=n.shift();)if(Lg(i),typeof r[i]>"u"&&(r[i]={}),r=r[i],!r||typeof r!="object")return!1;return r[s]=t,!0}function Lg(r){if(r=="__proto__"||r=="constructor"||r=="prototype")throw new Error("setting of prototype values not supported")}const su={server:{description:"Recommended for nodes with public IPv4 address (servers, VPSes, etc.), disables host and content discovery and UPnP in local networks.",transform:r=>(Ue(r,"Discovery.MDNS.Enabled",!1),Ue(r,"Discovery.webRTCStar.Enabled",!1),r.Swarm={...r.Swarm||{},DisableNatPortMap:!0},r)},"local-discovery":{description:"Sets default values to fields affected by `server` profile, enables discovery and UPnP in local networks.",transform:r=>(Ue(r,"Discovery.MDNS.Enabled",!0),Ue(r,"Discovery.webRTCStar.Enabled",!0),Ue(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!1}),r)},test:{description:"Reduces external interference, useful for running ipfs in test environments. Note that with these settings node won't be able to talk to the rest of the network without manual bootstrap.",transform:r=>{const e=$i();return Ue(r,"Addresses.API",e.Addresses.API?"/ip4/127.0.0.1/tcp/0":""),Ue(r,"Addresses.Gateway",e.Addresses.Gateway?"/ip4/127.0.0.1/tcp/0":""),Ue(r,"Addresses.Swarm",e.Addresses.Swarm.length?["/ip4/127.0.0.1/tcp/0"]:[]),Ue(r,"Addresses.Delegates",[]),Ue(r,"Bootstrap",[]),Ue(r,"Discovery.MDNS.Enabled",!1),Ue(r,"Discovery.webRTCStar.Enabled",!1),Ue(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!0}),r}},"default-networking":{description:"Restores default network settings. Inverse profile of the `test` profile.",transform:r=>{const e=$i();return Ue(r,"Addresses.API",e.Addresses.API),Ue(r,"Addresses.Gateway",e.Addresses.Gateway),Ue(r,"Addresses.Swarm",e.Addresses.Swarm),Ue(r,"Addresses.Delegates",e.Addresses.Delegates),Ue(r,"Bootstrap",e.Bootstrap),Ue(r,"Discovery.MDNS.Enabled",e.Discovery.MDNS.Enabled),Ue(r,"Discovery.webRTCStar.Enabled",e.Discovery.webRTCStar.Enabled),Ue(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!1}),r}},lowpower:{description:"Reduces daemon overhead on the system. May affect node functionality,performance of content discovery and data fetching may be degraded. Recommended for low power systems.",transform:r=>{const e=r.Swarm||{},t=e.ConnMgr||{};return t.LowWater=20,t.HighWater=40,e.ConnMgr=t,r.Swarm=e,r}},"default-power":{description:'Inverse of "lowpower" profile.',transform:r=>{const e=$i();return r.Swarm=e.Swarm,r}}},YL=O("ipfs:core:config");function QL({repo:r}){return{getAll:x(e),get:x(t),set:x(n),replace:x(s),profiles:{apply:x(i),list:x(JL)}};async function e(o={}){return r.config.getAll(o)}async function t(o,a){return o?r.config.get(o,a):Promise.reject(new Error("key argument is required"))}async function n(o,a,c){return r.config.set(o,a,c)}async function s(o,a){return r.config.replace(o,a)}async function i(o,a={dryRun:!1}){const{dryRun:c}=a,u=su[o];if(!u)throw new Error(`No profile with name '${o}' exists`);try{const l=await r.config.getAll(a);let d=JSON.parse(JSON.stringify(l));return d=u.transform(d),c||await r.config.replace(d,a),delete l.Identity.PrivKey,delete d.Identity.PrivKey,{original:l,updated:d}}catch(l){throw YL(l),new Error(`Could not apply profile '${o}' to config: ${l.message}`)}}}async function JL(r){return Object.keys(su).map(e=>({name:e,description:su[e].description}))}function Ac({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*XL(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=V.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*m1(n,s))}else{const t=V.asCID(e);t?yield[r.join("/"),t]:yield*m1(e,r)}}function*m1(r,e){if(!(r==null||r instanceof Uint8Array))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield*XL(s,n)}}function*ZL(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!V.asCID(n)&&(yield*b1(n,s))}else yield*b1(e,r)}function*b1(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!V.asCID(n)&&(yield*ZL(s,n))}}function eM(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=V.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}let tM=class{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:Ac(),bytes:Ac(),value:Ac(),asBlock:Ac()})}links(){return m1(this.value,[])}tree(){return b1(this.value,[])}get(e="/"){return eM(this.value,e.split("/").filter(Boolean))}};function rM({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n&&n.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new tM({cid:e,bytes:r,value:s})}var nM=mm,Mg=128,sM=127,iM=~sM,oM=Math.pow(2,31);function mm(r,e,t){e=e||[],t=t||0;for(var n=t;r>=oM;)e[t++]=r&255|Mg,r/=128;for(;r&iM;)e[t++]=r&255|Mg,r>>>=7;return e[t]=r|0,mm.bytes=t-n+1,e}var aM=E1,cM=128,Ug=127;function E1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw E1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Ug)<<s:(o&Ug)*Math.pow(2,s),s+=7}while(o>=cM);return E1.bytes=i-n,t}var lM=Math.pow(2,7),uM=Math.pow(2,14),dM=Math.pow(2,21),hM=Math.pow(2,28),fM=Math.pow(2,35),pM=Math.pow(2,42),gM=Math.pow(2,49),yM=Math.pow(2,56),wM=Math.pow(2,63),mM=function(r){return r<lM?1:r<uM?2:r<dM?3:r<hM?4:r<fM?5:r<pM?6:r<gM?7:r<yM?8:r<wM?9:10},bM={encode:nM,decode:aM,encodingLength:mM},iu=bM;const _1=(r,e=0)=>[iu.decode(r,e),iu.decode.bytes],ou=(r,e,t=0)=>(iu.encode(r,e,t),e),au=r=>iu.encodingLength(r),EM=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},p2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},_M=(r,e)=>{const t=e.byteLength,n=au(r),s=n+au(t),i=new Uint8Array(s+t);return ou(r,i,0),ou(t,i,n),i.set(e,s),new g2(r,t,e,i)},v1=r=>{const e=p2(r),[t,n]=_1(e),[s,i]=_1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new g2(t,s,o,e)},vM=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&EM(r.bytes,t.bytes)}};let g2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function SM(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var RM=SM,IM=RM;let AM=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},CM=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return bm(this,e)}},TM=class{constructor(e){this.decoders=e}or(e){return bm(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const bm=(r,e)=>new TM({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let DM=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new AM(e,t,n),this.decoder=new CM(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Em=({name:r,prefix:e,encode:t,decode:n})=>new DM(r,e,t,n),_m=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=IM(t,e);return Em({prefix:r,name:e,encode:n,decode:i=>p2(s(i))})},PM=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},kM=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},xn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Em({prefix:e,name:r,encode(s){return kM(s,n,t)},decode(s){return PM(s,n,t,r)}}),is=_m({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});_m({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const al=xn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});xn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});xn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});xn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});xn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});xn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});xn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});xn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});xn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Bg=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return NM(t,S1(r),e||is.encoder);default:return xM(t,S1(r),e||al.encoder)}},zg=new WeakMap,S1=r=>{const e=zg.get(r);if(e==null){const t=new Map;return zg.set(r,t),t}return e};let Be=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==$o)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==$M)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Be.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=_M(e,t);return Be.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Be.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&vM(e.multihash,n.multihash)}toString(e){return Bg(this,e)}toJSON(){return{"/":Bg(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Be)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Be(n,s,i,o||Fg(n,s,i.bytes))}else if(t[LM]===!0){const{version:n,multihash:s,code:i}=t,o=v1(s);return Be.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==$o)throw new Error(`Version 0 CID must use dag-pb (code: ${$o}) block encoding`);return new Be(e,t,n,n.bytes)}case 1:{const s=Fg(e,t,n.bytes);return new Be(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Be.create(0,$o,e)}static createV1(e,t){return Be.create(1,e,t)}static decode(e){const[t,n]=Be.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Be.inspectBytes(e),n=t.size-t.multihashSize,s=p2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new g2(t.multihashCode,t.digestSize,i,s);return[t.version===0?Be.createV0(o):Be.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=_1(e.subarray(t));return t+=f,d};let s=n(),i=$o;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=OM(e,t),i=Be.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return S1(i).set(n,e),i}};const OM=(r,e)=>{switch(r[0]){case"Q":{const t=e||is;return[is.prefix,t.decode(`${is.prefix}${r}`)]}case is.prefix:{const t=e||is;return[is.prefix,t.decode(r)]}case al.prefix:{const t=e||al;return[al.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},NM=(r,e,t)=>{const{prefix:n}=t;if(n!==is.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},xM=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},$o=112,$M=18,Fg=(r,e,t)=>{const n=au(r),s=n+au(e),i=new Uint8Array(s+t.byteLength);return ou(r,i,0),ou(e,i,n),i.set(t,s),i},LM=Symbol.for("@ipld/js-cid/CID"),vm=42;function MM(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=Be.asCID(r);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new ue(K.tag,vm),new ue(K.bytes,t)]}function UM(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function BM(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const zM={float64:!0,typeEncoders:{Object:MM,undefined:UM,number:BM}};function FM(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return Be.decode(r.subarray(1))}const Sm={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Sm.tags[vm]=FM;const VM=r=>Xs(r,zM),jM=r=>Ir(r,Sm);function Rm(r){const e=VM({version:1,roots:r}),t=ze.encode(e.length),n=new Uint8Array(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function KM(r){return{async setRoots(e){const t=Rm(e);await r.write(t)},async writeBlock(e){const{cid:t,bytes:n}=e;await r.write(new Uint8Array(ze.encode(t.bytes.length+n.length))),await r.write(t.bytes),n.length&&await r.write(n)},async close(){await r.end()}}}function Cc(){}function qM(){const r=[];let e=null,t=Cc,n=!1,s=null,i=Cc;const o=()=>(e||(e=new Promise(u=>{t=()=>{e=null,t=Cc,u()}})),e),a={write(u){r.push(u);const l=o();return i(),l},async end(){n=!0;const u=o();i(),await u}},c={async next(){const u=r.shift();return u?(r.length===0&&t(),{done:!1,value:u}):n?(t(),{done:!0,value:void 0}):(s||(s=new Promise(l=>{i=()=>(s=null,i=Cc,l(c.next()))})),s)}};return{writer:a,iterator:c}}const ys={Null:r=>r===null,Int:r=>Number.isInteger(r),Float:r=>typeof r=="number"&&Number.isFinite(r),String:r=>typeof r=="string",Bool:r=>typeof r=="boolean",Bytes:r=>r instanceof Uint8Array,Link:r=>!ys.Null(r)&&typeof r=="object"&&r.asCID===r,List:r=>Array.isArray(r),Map:r=>!ys.Null(r)&&typeof r=="object"&&r.asCID!==r&&!ys.List(r)&&!ys.Bytes(r)},Ai={Int:ys.Int,"CarHeader > version":r=>Ai.Int(r),"CarHeader > roots (anon) > valueType (anon)":ys.Link,"CarHeader > roots (anon)":r=>ys.List(r)&&Array.prototype.every.call(r,Ai["CarHeader > roots (anon) > valueType (anon)"]),"CarHeader > roots":r=>Ai["CarHeader > roots (anon)"](r),CarHeader:r=>{const e=r&&Object.keys(r);return ys.Map(r)&&["version"].every(t=>e.includes(t))&&Object.entries(r).every(([t,n])=>Ai["CarHeader > "+t]&&Ai["CarHeader > "+t](n))}},HM=Ai.CarHeader,yh={SHA2_256:18,LENGTH:32,DAG_PB:112},Vg=16+8+8+8;async function cu(r){const e=await r.upTo(8);if(!e.length)throw new Error("Unexpected end of data");const t=ze.decode(e);return r.seek(ze.decode.bytes),t}async function GM(r){const e=await r.exactly(Vg),t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=0;const s={version:2,characteristics:[t.getBigUint64(n,!0),t.getBigUint64(n+=8,!0)],dataOffset:Number(t.getBigUint64(n+=8,!0)),dataSize:Number(t.getBigUint64(n+=8,!0)),indexOffset:Number(t.getBigUint64(n+=8,!0))};return r.seek(Vg),s}async function y2(r,e){const t=await cu(r);if(t===0)throw new Error("Invalid CAR header (zero length)");const n=await r.exactly(t);r.seek(t);const s=jM(n);if(!HM(s))throw new Error("Invalid CAR header format");if(s.version!==1&&s.version!==2||e!==void 0&&s.version!==e)throw new Error(`Invalid CAR version: ${s.version}${e!==void 0?` (expected ${e})`:""}`);const i=Array.isArray(s.roots);if(s.version===1&&!i||s.version===2&&i)throw new Error("Invalid CAR header format");if(s.version===1)return s;const o=await GM(r);r.seek(o.dataOffset-r.pos);const a=await y2(r,1);return Object.assign(a,o)}async function WM(r){const e=await r.upTo(8);ze.decode(e);const t=ze.decode.bytes,n=ze.decode(e.subarray(ze.decode.bytes)),s=ze.decode.bytes,i=t+s+n,o=await r.exactly(i);return r.seek(i),o}async function YM(r){const e=await r.exactly(2);if(e[0]===yh.SHA2_256&&e[1]===yh.LENGTH){const o=await r.exactly(34);r.seek(34);const a=v1(o);return Be.create(0,yh.DAG_PB,a)}const t=await cu(r);if(t!==1)throw new Error(`Unexpected CID version (${t})`);const n=await cu(r),s=await WM(r),i=v1(s);return Be.create(t,n,i)}async function Im(r){const e=r.pos;let t=await cu(r);if(t===0)throw new Error("Invalid CAR section (zero length)");t+=r.pos-e;const n=await YM(r),s=t-Number(r.pos-e);return{cid:n,length:t,blockLength:s}}async function QM(r){const{cid:e,blockLength:t}=await Im(r),n=await r.exactly(t);return r.seek(t),{bytes:n,cid:e}}async function JM(r){const e=r.pos,{cid:t,length:n,blockLength:s}=await Im(r),i={cid:t,length:n,blockLength:s,offset:e,blockOffset:r.pos};return r.seek(i.blockLength),i}function XM(r){const e=(async()=>{const t=await y2(r);if(t.version===2){const n=r.pos-t.dataOffset;r=tU(r,t.dataSize-n)}return t})();return{header:()=>e,async*blocks(){for(await e;(await r.upTo(8)).length>0;)yield await QM(r)},async*blocksIndex(){for(await e;(await r.upTo(8)).length>0;)yield await JM(r)}}}function Am(r){let e=0;return{async upTo(t){return r.subarray(e,e+Math.min(t,r.length-e))},async exactly(t){if(t>r.length-e)throw new Error("Unexpected end of data");return r.subarray(e,e+t)},seek(t){e+=t},get pos(){return e}}}function ZM(r){let e=0,t=0,n=0,s=new Uint8Array(0);const i=async o=>{t=s.length-n;const a=[s.subarray(n)];for(;t<o;){const u=await r();if(u==null)break;t<0?u.length>t&&a.push(u.subarray(-t)):a.push(u),t+=u.length}s=new Uint8Array(a.reduce((u,l)=>u+l.length,0));let c=0;for(const u of a)s.set(u,c),c+=u.length;n=0};return{async upTo(o){return s.length-n<o&&await i(o),s.subarray(n,n+Math.min(s.length-n,o))},async exactly(o){if(s.length-n<o&&await i(o),s.length-n<o)throw new Error("Unexpected end of data");return s.subarray(n,n+o)},seek(o){e+=o,n+=o},get pos(){return e}}}function eU(r){const e=r[Symbol.asyncIterator]();async function t(){const n=await e.next();return n.done?null:n.value}return ZM(t)}function tU(r,e){let t=0;return{async upTo(n){let s=await r.upTo(n);return s.length+t>e&&(s=s.subarray(0,e-t)),s},async exactly(n){const s=await r.exactly(n);if(s.length+t>e)throw new Error("Unexpected end of data");return s},seek(n){t+=n,r.seek(n)},get pos(){return r.pos}}}class lu{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array)||!e.cid)throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const t=Be.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:t,bytes:e.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}static create(e){e=rU(e);const{encoder:t,iterator:n}=Kg(),s=new lu(e,t),i=new jg(n);return{writer:s,out:i}}static createAppender(){const{encoder:e,iterator:t}=Kg();e.setRoots=()=>Promise.resolve();const n=new lu([],e),s=new jg(t);return{writer:n,out:s}}static async updateRootsInBytes(e,t){const n=Am(e);await y2(n);const s=Rm(t);if(Number(n.pos)!==s.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${s.length} bytes)`);return e.set(s,0),e}}class jg{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function Kg(){const r=qM(),{writer:e,iterator:t}=r;return{encoder:KM(e),iterator:t}}function rU(r){if(r===void 0)return[];if(!Array.isArray(r)){const t=Be.asCID(r);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}const e=[];for(const t of r){const n=Be.asCID(t);if(!n)throw new TypeError("roots must be a single CID or an array of CIDs");e.push(n)}return e}const Cm=async({cid:r,load:e,seen:t})=>{t=t||new Set;const n=r.toString(Ht);if(t.has(n))return;const s=await e(r);if(t.add(n),s!==null)for(const[,i]of s.links())await Cm({cid:i,load:e,seen:t})},Tm=O("ipfs:components:dag:import"),nU=[U0,l8];function sU({repo:r,preload:e,codecs:t}){async function*n(s,i={}){i.preload!==!1&&e(s);const o=V.asCID(s);if(!o)throw new Error(`Unexpected error converting CID type: ${s}`);Tm(`Exporting ${o} as car`);const{writer:a,out:c}=await lu.create([o]);let u=null;(async()=>{try{const l=iU(r,a,{signal:i.signal,timeout:i.timeout},t);await Cm({cid:o,load:l})}catch(l){u=l}finally{a.close()}})();for await(const l of c){if(u)break;yield l}if(u)throw u}return x(n)}function iU(r,e,t,n){return async s=>{const i=await n.getCodec(s.code);if(!i)throw new Error(`Can't decode links in block with codec 0x${s.code.toString(16)} to form complete DAG`);const o=await r.blocks.get(s,t);return Tm(`Adding block ${s} to car`),await e.put({cid:s,bytes:o}),nU.includes(s.code)?null:rM({bytes:o,cid:s,codec:i})}}async function fr(r){for await(const e of r)return e}function oU({codecs:r,repo:e,preload:t}){return x(async function(i,o={}){if(o.preload!==!1&&t(i),o.path){const d=o.localResolve?await fr(Ca(i,o.path,r,e,o)):await tr(Ca(i,o.path,r,e,o));if(!d)throw E(new Error("Not found"),"ERR_NOT_FOUND");return d}const a=await r.getCodec(i.code),c=await e.blocks.get(i,o);return{value:a.decode(c),remainderPath:""}})}class aU{constructor(e,t,n){this._version=e,this._roots=t,this._iterable=n,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class uu extends aU{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(e){const{version:t,roots:n,iterator:s}=await cU(e);return new uu(t,n,s)}static async fromIterable(e){const{version:t,roots:n,iterator:s}=await lU(e);return new uu(t,n,s)}}async function cU(r){if(!(r instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return Dm(Am(r))}async function lU(r){if(!r||typeof r[Symbol.asyncIterator]!="function")throw new TypeError("fromIterable() requires an async iterable");return Dm(eU(r))}async function Dm(r){const e=XM(r),{version:t,roots:n}=await e.header();return{version:t,roots:n,iterator:e.blocks()}}const Pm=O("ipfs:components:dag:import");function uU({repo:r}){async function*e(t,n={}){const s=await r.gcLock.readLock();try{const i={signal:n.signal,timeout:n.timeout},o=Ya(t),{value:a,done:c}=await o.peek();if(c)return;a&&o.push(a);let u;a instanceof Uint8Array?u=[o]:u=o;for await(const l of u){const d=await dU(r,i,l);if(n.pinRoots!==!1)for(const f of d){let g="";try{await r.blocks.has(f)?(Pm(`Pinning root ${f}`),await r.pins.pinRecursively(f)):g="blockstore: block not found"}catch(h){g=h.message}yield{root:{cid:f,pinErrorMsg:g}}}}}finally{s()}}return x(e)}async function dU(r,e,t){const n=await uu.fromIterable(t),s=await n.getRoots();return await Et(r.blocks.putMany(_t(n,({cid:i,bytes:o})=>(Pm(`Import block ${i}`),{key:i,value:o})),{signal:e.signal})),s}function hU({repo:r,codecs:e,hashers:t,preload:n}){async function s(i,o={}){const a=o.pin?await r.gcLock.readLock():null;try{const c=await e.getCodec(o.storeCodec||"dag-cbor");if(!c)throw new Error(`Unknown storeCodec ${o.storeCodec}, please configure additional BlockCodecs for this IPFS instance`);if(o.inputCodec){if(!(i instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");const h=await e.getCodec(o.inputCodec);if(!h)throw new Error(`Unknown inputCodec ${o.inputCodec}, please configure additional BlockCodecs for this IPFS instance`);i=h.decode(i)}const u=o.version!=null?o.version:1,l=await t.getHasher(o.hashAlg||"sha2-256");if(!l)throw new Error(`Unknown hash algorithm ${o.hashAlg}, please configure additional MultihashHashers for this IPFS instance`);const d=c.encode(i),f=await l.digest(d),g=V.create(u,c.code,f);return await r.blocks.put(g,d,{signal:o.signal}),o.pin&&await r.pins.pinRecursively(g),o.preload!==!1&&n(g),g}finally{a&&a()}}return x(s)}function fU({repo:r,codecs:e,preload:t}){async function n(s,i={}){const{cid:o}=Ha(s);return i.preload!==!1&&t(o),dd(r,e,s,i)}return x(n)}class pU{constructor({repo:e,codecs:t,hashers:n,preload:s}){this.export=sU({repo:e,preload:s,codecs:t}),this.get=oU({codecs:t,repo:e,preload:s}),this.import=uU({repo:e}),this.resolve=fU({repo:e,codecs:t,preload:s}),this.put=hU({repo:e,codecs:t,hashers:n,preload:s})}}function gU(r){if(!Array.isArray(r))throw new TypeError(`Expected an array, got ${typeof r}`);r=[...r];for(let e=r.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[r[e],r[t]]=[r[t],r[e]]}return r}const yU=O("ipfs:preload"),wU=lt.default?lt.default:lt,mU=new wU({concurrency:4});function bU(r,e={}){return yU(r),mU.add(async()=>{const n=(await Vr.post(r,{signal:e.signal})).body.getReader();try{for(;;){const{done:s}=await n.read();if(s)return}}finally{n.releaseLock()}})}const Lo=O("ipfs:preload");function EU(r={}){if(r.enabled=Boolean(r.enabled),r.addresses=r.addresses||[],r.cache=r.cache||1e3,!r.enabled||!r.addresses.length)return Lo("preload disabled"),Object.assign(()=>{},{start:()=>{},stop:()=>{}});let e=!0,t=[];const n=r.addresses.map(o=>y6(o)),s=Ga(r.cache),i=async o=>{try{if(e)throw new Error(`preload ${o} but preloader is not started`);const a=o.toString();if(s.has(a))return;s.set(a,!0);const c=gU(n);let u=!1;const l=Date.now();for(const d of c){if(e)throw new Error(`preload aborted for ${a}`);let f;try{f=new AbortController,t=t.concat(f),await bU(`${d}/api/v0/refs?r=true&arg=${encodeURIComponent(a)}`,{signal:f.signal}),u=!0}catch(g){g.type!=="aborted"&&Lo.error(g)}finally{t=t.filter(g=>g!==f)}if(u)break}Lo(`${u?"":"un"}successfully preloaded ${a} in ${Date.now()-l}ms`)}catch(a){Lo.error(a)}};return i.start=()=>{e=!1},i.stop=()=>{e=!0,Lo(`aborting ${t.length} pending preload request(s)`),t.forEach(o=>o.abort()),t=[]},i}const Tc=O("ipfs:mfs-preload");function _U({preload:r,files:e,options:t={}}){if(t.interval=t.interval||30*1e3,!t.enabled){Tc("MFS preload disabled");const o=async()=>{};return{start:o,stop:o}}let n="",s;const i=async()=>{try{const o=await e.stat("/"),a=o.cid.toString();n!==a&&(Tc(`preloading updated MFS root ${n} -> ${o.cid}`),await r(o.cid),n=a)}catch(o){Tc.error("failed to preload MFS root",o)}finally{s=setTimeout(i,t.interval)}};return{async start(){const o=await e.stat("/");n=o.cid.toString(),Tc(`monitoring MFS root ${o.cid}`),s=setTimeout(i,t.interval)},stop(){clearTimeout(s)}}}class vU extends Error{constructor(e){super(e),this.name="TimeoutError"}}class SU extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const qg=r=>globalThis.DOMException===void 0?new SU(r):new DOMException(r),Hg=r=>{const e=r.reason===void 0?qg("This operation was aborted."):r.reason;return e instanceof Error?e:qg(e)};function RU(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o;const a=new Promise((c,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(t===Number.POSITIVE_INFINITY){c(r);return}if(e.signal){const{signal:l}=e;l.aborted&&u(Hg(l)),l.addEventListener("abort",()=>{u(Hg(l))})}o=i.setTimeout.call(void 0,()=>{if(n){try{c(n())}catch(l){u(l)}return}if(typeof r.cancel=="function"&&r.cancel(),s===!1)c();else if(s instanceof Error)u(s);else{const l=s??`Promise timed out after ${t} milliseconds`;u(new vU(l))}},t),(async()=>{try{c(await r)}catch(l){u(l)}finally{i.clearTimeout.call(void 0,o)}})()});return a.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},a}const Gg="lock:worker:request-read",Wg="lock:worker:release-read",Yg="lock:master:grant-read",Qg="lock:worker:request-write",Jg="lock:worker:release-write",Xg="lock:master:grant-write",Is={},ni=r=>{r.addEventListener("message",e=>{ni.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{ni.dispatchEvent("message",r,e)})};ni.addEventListener=(r,e)=>{Is[r]==null&&(Is[r]=[]),Is[r].push(e)};ni.removeEventListener=(r,e)=>{Is[r]!=null&&(Is[r]=Is[r].filter(t=>t===e))};ni.dispatchEvent=function(r,e,t){Is[r]!=null&&Is[r].forEach(n=>n(e,t))};const Zg=(r,e,t,n,s)=>(i,o)=>{if(o.data.type!==t)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>(i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{const u=l=>{if(l==null||l.data==null)return;const d={type:l.data.type,name:l.data.name,identifier:l.data.identifier};d.type===n&&d.identifier===a.identifier&&(i.removeEventListener("message",u),c())};i.addEventListener("message",u)}))}}))},ey=(r,e,t,n)=>async()=>{const s=g6();return globalThis.postMessage({type:e,identifier:s,name:r}),await new Promise(i=>{const o=a=>{if(a==null||a.data==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:n,identifier:s,name:r})}))};globalThis.addEventListener("message",o)})},IU={singleProcess:!1},AU=r=>{if(r=Object.assign({},IU,r),Boolean(globalThis.document)||r.singleProcess){const t=new EventTarget;return ni.addEventListener("message",Zg(t,"requestReadLock",Gg,Wg,Yg)),ni.addEventListener("message",Zg(t,"requestWriteLock",Qg,Jg,Xg)),t}return{isWorker:!0,readLock:t=>ey(t,Gg,Yg,Wg),writeLock:t=>ey(t,Qg,Xg,Jg)}},Ls={};let ps;async function wh(r,e){let t;const n=new Promise(s=>{t=s});return r.add(async()=>await RU((async()=>await new Promise(s=>{t(()=>{s()})}))(),{milliseconds:e.timeout})),await n}const CU=(r,e)=>{if(ps.isWorker===!0)return{readLock:ps.readLock(r,e),writeLock:ps.writeLock(r,e)};const t=new lt({concurrency:1});let n;return{async readLock(){if(n!=null)return await wh(n,e);n=new lt({concurrency:e.concurrency,autoStart:!1});const s=n,i=wh(n,e);return t.add(async()=>(s.start(),await s.onIdle().then(()=>{n===s&&(n=null)}))),await i},async writeLock(){return n=null,await wh(t,e)}}},TU={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function w2(r){const e=Object.assign({},TU,r);return ps==null&&(ps=AU(e),ps.isWorker!==!0&&(ps.addEventListener("requestReadLock",t=>{Ls[t.data.name]!=null&&Ls[t.data.name].readLock().then(async n=>await t.data.handler().finally(()=>n()))}),ps.addEventListener("requestWriteLock",async t=>{Ls[t.data.name]!=null&&Ls[t.data.name].writeLock().then(async n=>await t.data.handler().finally(()=>n()))}))),Ls[e.name]==null&&(Ls[e.name]=CU(e.name,e)),Ls[e.name]}let Dc;function m2(r=!1){if(Dc)return Dc;const e=w2({singleProcess:r});return Dc={readLock:t=>async(...n)=>{const s=await e.readLock();try{return await t.apply(null,n)}finally{s()}},writeLock:t=>async(...n)=>{const s=await e.writeLock();try{return await t.apply(null,n)}finally{s()}}},Dc}const ty=O("ipfs:mfs:utils:with-mfs-root");async function b2(r,e){if(e&&e.signal&&e.signal.aborted)throw E(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await r.repo.datastore.open();let t;try{const n=await r.repo.datastore.get(Bf);t=V.decode(n)}catch(n){if(n.code!=="ERR_NOT_FOUND")throw n;ty("Creating new MFS root");const s=Re({Data:new Ce({type:"directory"}).marshal(),Links:[]}),i=await Hi.digest(s);if(t=V.createV0(i),await r.repo.blocks.put(t,s),e&&e.signal&&e.signal.aborted)throw E(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await r.repo.datastore.put(Bf,t.bytes)}return ty(`Loaded MFS root /ipfs/${t}`),t}function E2(r=""){return(r.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean)}const mh="ipfs",Ft=async(r,e,t)=>{const n=await b2(r,t);let s={entryType:"file"},i="";if(V.asCID(e)?i=`/ipfs/${e}`:i=e.toString(),i=i.trim(),i=i.replace(/(\/\/+)/g,"/"),i.endsWith("/")&&i.length>1&&(i=i.substring(0,i.length-1)),!i)throw E(new Error("paths must not be empty"),"ERR_NO_PATH");if(i.substring(0,1)!=="/")throw E(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");i.substring(i.length-1)==="/"&&(i=i.substring(0,i.length-1));const o=E2(i);if(o[0]===mh){let c;o.length===2?c=`/${o.join("/")}`:c=`/${o.slice(0,o.length-1).join("/")}`,s={type:"ipfs",depth:o.length-2,entryType:"file",mfsPath:`/${o.join("/")}`,mfsDirectory:c,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}else{const c=`/${mh}/${n}${o.length?"/"+o.join("/"):""}`,u=`/${mh}/${n}/${o.slice(0,o.length-1).join("/")}`;s={type:"mfs",depth:o.length,entryType:"file",mfsDirectory:u,mfsPath:c,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}const a=s.type==="mfs"?s.mfsPath:s.path;try{const c=await Nn(a,r.repo.blocks,t);s.cid=c.cid,s.mfsPath=`/ipfs/${c.path}`,s.entryType=c.type,s.content=c.content,(s.entryType==="file"||s.entryType==="directory")&&(c.type==="file"||c.type==="directory")&&(s.unixfs=c.unixfs)}catch(c){if(c.code!=="ERR_NOT_FOUND")throw c}return s.exists=Boolean(s.cid),s},DU=Le.bind({ignoreUndefined:!0}),PU=O("ipfs:mfs:stat"),kU={withLocal:!1};function _d(r){async function e(t,n={}){n=DU(kU,n),PU(`Fetching stats for ${t}`);const{type:s,cid:i,mfsPath:o}=await Ft(r,t,n),a=s==="ipfs"&&i?i:o;let c;try{c=await Nn(a,r.repo.blocks)}catch(u){throw u.code==="ERR_NOT_FOUND"?E(new Error(`${t} does not exist`),"ERR_NOT_FOUND"):u}if(!ry[c.type])throw new Error(`Cannot stat codec ${c.cid.code}`);return ry[c.type](c)}return x(e)}const ry={raw:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1}),file:r=>{const e={cid:r.cid,type:"file",size:r.unixfs.fileSize(),cumulativeSize:Re(r.node).length+(r.node.Links||[]).reduce((t,n)=>t+(n.Tsize||0),0),blocks:r.unixfs.blockSizes.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:r.unixfs.mode};return r.unixfs.mtime&&(e.mtime=r.unixfs.mtime),e},directory:r=>{const e={cid:r.cid,type:"directory",size:0,cumulativeSize:Re(r.node).length+(r.node.Links||[]).reduce((t,n)=>t+(n.Tsize||0),0),blocks:r.node.Links.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:r.unixfs.mode};return r.unixfs.mtime&&(e.mtime=r.unixfs.mtime),e},object:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,type:"file",blocks:0,local:void 0,sizeLocal:void 0,withLocality:!1}),identity:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1})},OU=O("ipfs:mfs:utils:to-trail");async function rc(r,e){OU(`Creating trail for path ${e}`);const t=[];for await(const n of xw(e,r.repo.blocks))t.push({name:n.name,cid:n.cid,size:n.size,type:n.type});return t}const km=async(r,e,t)=>{t.codec||(t.codec=ks),t.hasher||(t.hasher=Hi),t.cidVersion===void 0&&(t.cidVersion=1),t.codec===ks&&t.hasher!==Hi&&(t.cidVersion=1);const n=await t.hasher.digest(r),s=V.create(t.cidVersion,t.codec.code,n);return t.onlyHash||await e.put(s,r,{signal:t.signal}),s},Om=gd.code,Nm=8;async function xm(r){return(await gd.encode(r)).subarray(0,8).reverse()}class NU{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}}class $m extends NU{constructor(e,t){super(e,t),this._bucket=yd({hashFn:xm,bits:Nm})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){yield*Lm(this._bucket,e,this,this.options)}}async function*Lm(r,e,t,n){const s=r._children,i=[];let o=0;for(let g=0;g<s.length;g++){const h=s.get(g);if(!h)continue;const p=g.toString(16).toUpperCase().padStart(2,"0");if(h instanceof Ct){let w;for await(const y of await Lm(h,e,null,n))w=y;if(!w)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:p,Tsize:w.size,Hash:w.cid}),o+=w.size}else if(typeof h.value.flush=="function"){const w=h.value;let y;for await(const b of w.flush(e))y=b,yield y;const _=p+h.key;i.push({Name:_,Tsize:y.size,Hash:y.cid}),o+=y.size}else{const w=h.value;if(!w.cid)continue;const y=p+h.key,_=w.size;i.push({Name:y,Tsize:_,Hash:w.cid}),o+=_}}const a=Uint8Array.from(s.bitField().reverse()),u={Data:new Ce({type:"hamt-sharded-directory",data:a,fanout:r.tableSize(),hashType:Om,mtime:t&&t.mtime,mode:t&&t.mode}).marshal(),Links:i},l=Re(Wr(u)),d=await km(l,e,n),f=l.length+o;yield{cid:d,node:u,size:f}}const sa=O("ipfs:mfs:core:utils:hamt-utils"),vd=async(r,e,t,n)=>{if(!n.parent.Data)throw new Error("Could not update HAMT directory because parent had no data");const s=Uint8Array.from(t._children.bitField().reverse()),i=Ce.unmarshal(n.parent.Data),o=new Ce({type:"hamt-sharded-directory",data:s,fanout:t.tableSize(),hashType:Om,mode:i.mode,mtime:i.mtime}),a=await r.hashers.getHasher(n.hashAlg),c={Data:o.marshal(),Links:e.sort((f,g)=>(f.Name||"").localeCompare(g.Name||""))},u=Re(c),l=await a.digest(u),d=V.create(n.cidVersion,Ne,l);return n.flush&&await r.repo.blocks.put(d,u),{node:c,cid:d,size:e.reduce((f,g)=>f+(g.Tsize||0),u.length)}},Mm=async(r,e,t,n,s)=>{const i=new Ct({hash:t._options.hash,bits:t._options.bits},n,s);return n._putObjectAt(s,i),await Sd(r,e,i,t),i},Um=async r=>{const e=yd({hashFn:xm,bits:Nm});return await Promise.all(r.map(async t=>{const n=t.Name||"";if(n.length===2){const s=parseInt(n,16),i=new Ct({hash:e._options.hash,bits:e._options.bits},e,s);return e._putObjectAt(s,i),Promise.resolve()}return e.put(n.substring(2),{size:t.Tsize,cid:t.Hash})})),e},Sd=async(r,e,t,n)=>{await Promise.all(e.map(async s=>{const i=s.Name||"";if(i.length===2){sa("Populating sub bucket",i);const o=parseInt(i,16),a=await r.repo.blocks.get(s.Hash),c=Ke(a),u=new Ct({hash:n._options.hash,bits:n._options.bits},t,o);return t._putObjectAt(o,u),await Sd(r,c.Links,u,n),Promise.resolve()}return n.put(i.substring(2),{size:s.Tsize,cid:s.Hash})}))},Mi=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),xU=async(r,e,t)=>{const n=await Um(t.Links),s=await n._findNewBucketAndPos(e),i=[{bucket:s.bucket,prefix:Mi(s.pos)}];let o=s.bucket;for(;o!==n;)i.push({bucket:o,prefix:Mi(o._posAtParent)}),o=o._parent;i.reverse(),i[0].node=t;for(let a=0;a<i.length;a++){const c=i[a];if(!c.node)throw new Error("Could not generate HAMT path");const u=c.node.Links.filter(g=>(g.Name||"").substring(0,2)===c.prefix).pop();if(!u){sa(`Link ${c.prefix}${e} will be added`);continue}if(u.Name===`${c.prefix}${e}`){sa(`Link ${c.prefix}${e} will be replaced`);continue}sa(`Found subshard ${c.prefix}`);const l=await r.repo.blocks.get(u.Hash),d=Ke(l);if(!i[a+1]){sa(`Loaded new subshard ${c.prefix}`),await Mm(r,d.Links,n,c.bucket,parseInt(c.prefix,16));const g=await n._findNewBucketAndPos(e);i.push({bucket:g.bucket,prefix:Mi(g.pos),node:d});continue}const f=i[a+1];await Sd(r,d.Links,f.bucket,n),f.node=d}return await n.put(e,!0),i.reverse(),{rootBucket:n,path:i}},$U=async(r,e,t={})=>{const n=new $m({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let i=0;i<e.length;i++)await n._bucket.put(e[i].name,{size:e[i].size,cid:e[i].cid});const s=await tr(n.flush(r.repo.blocks));if(!s)throw new Error("Flushing shard yielded no result");return s},Fr=O("ipfs:mfs:core:utils:add-link");async function po(r,e){let t=e.parent;if(e.parentCid){const s=V.asCID(e.parentCid);if(s===null)throw E(new Error("Invalid CID passed to addLink"),"EINVALIDPARENTCID");if(s.code!==Ne)throw E(new Error("Unsupported codec. Only DAG-PB is supported"),"EINVALIDPARENTCID");Fr(`Loading parent node ${s}`);const i=await r.repo.blocks.get(s);t=Ke(i)}if(!t)throw E(new Error("No parent node or CID passed to addLink"),"EINVALIDPARENT");if(!e.cid)throw E(new Error("No child cid passed to addLink"),"EINVALIDCHILDCID");if(!e.name)throw E(new Error("No child name passed to addLink"),"EINVALIDCHILDNAME");if(!e.size&&e.size!==0)throw E(new Error("No child size passed to addLink"),"EINVALIDCHILDSIZE");if(!t.Data)throw E(new Error("Parent node with no data passed to addLink"),"ERR_INVALID_PARENT");const n=Ce.unmarshal(t.Data);return n.type==="hamt-sharded-directory"?(Fr("Adding link to sharded directory"),UU(r,{...e,parent:t})):t.Links.length>=e.shardSplitThreshold?(Fr("Converting directory to sharded directory"),LU(r,{...e,parent:t,mtime:n.mtime,mode:n.mode})):(Fr(`Adding ${e.name} (${e.cid}) to regular directory`),MU(r,{...e,parent:t}))}const LU=async(r,e)=>{const t=await $U(r,e.parent.Links.map(n=>({name:n.Name||"",size:n.Tsize||0,cid:n.Hash})).concat({name:e.name,size:e.size,cid:e.cid}),e);return Fr(`Converted directory to sharded directory ${t.cid}`),t},MU=async(r,e)=>{const t=e.parent.Links.filter(u=>u.Name!==e.name);if(t.push({Name:e.name,Tsize:e.size,Hash:e.cid}),!e.parent.Data)throw E(new Error("Parent node with no data passed to addToDirectory"),"ERR_INVALID_PARENT");const n=Ce.unmarshal(e.parent.Data);let s;if(n.mtime){const u=Date.now(),l=Math.floor(u/1e3);n.mtime={secs:l,nsecs:(u-l*1e3)*1e3},s=n.marshal()}else s=e.parent.Data;e.parent=Wr({Data:s,Links:t});const i=await r.hashers.getHasher(e.hashAlg),o=Re(e.parent),a=await i.digest(o),c=V.create(e.cidVersion,Ne,a);return e.flush&&await r.repo.blocks.put(c,o),{node:e.parent,cid:c,size:o.length}},UU=async(r,e)=>{const{shard:t,path:n}=await BU(r,e),s=await tr(t.flush(r.repo.blocks));if(!s)throw new Error("No result from flushing shard");const i=await r.repo.blocks.get(s.cid),o=Ke(i),a=e.parent.Links.filter(u=>(u.Name||"").substring(0,2)!==n[0].prefix),c=o.Links.find(u=>(u.Name||"").substring(0,2)===n[0].prefix);if(!c)throw new Error(`No link found with prefix ${n[0].prefix}`);return a.push(c),vd(r,a,n[0].bucket,e)},BU=async(r,e)=>{const t={name:e.name,cid:e.cid,size:e.size};if(!e.parent.Data)throw E(new Error("Parent node with no data passed to addFileToShardedDirectory"),"ERR_INVALID_PARENT");const n=await Um(e.parent.Links),s=Ce.unmarshal(e.parent.Data),i=new $m({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mode:s.mode},e);i._bucket=n,s.mtime&&(i.mtime={secs:Math.round(Date.now()/1e3)});const o=await n._findNewBucketAndPos(t.name),a=zU(o);a[0].node=e.parent;let c=0;for(;c<a.length;){const u=a[c];c++;const l=u.node;if(!l)throw new Error("Segment had no node");const d=l.Links.find(p=>(p.Name||"").substring(0,2)===u.prefix);if(!d){Fr(`Link ${u.prefix}${t.name} will be added`),c=a.length;break}if(d.Name===`${u.prefix}${t.name}`){Fr(`Link ${u.prefix}${t.name} will be replaced`),c=a.length;break}if((d.Name||"").length>2){Fr(`Link ${d.Name} ${d.Hash} will be replaced with a subshard`),c=a.length;break}Fr(`Found subshard ${u.prefix}`);const f=await r.repo.blocks.get(d.Hash),g=Ke(f);if(!a[c]){Fr(`Loaded new subshard ${u.prefix}`),await Mm(r,g.Links,n,u.bucket,parseInt(u.prefix,16));const p=await n._findNewBucketAndPos(t.name);a.push({bucket:p.bucket,prefix:Mi(p.pos),node:g});break}const h=a[c];await Sd(r,g.Links,h.bucket,n),h.node=g}return await i._bucket.put(t.name,{size:t.size,cid:t.cid}),{shard:i,path:a}},zU=r=>{const e=[{bucket:r.bucket,prefix:Mi(r.pos)}];let t=r.bucket._parent,n=r.bucket._posAtParent;for(;t;)e.push({bucket:t,prefix:Mi(n)}),n=t._posAtParent,t=t._parent;return e.reverse(),e},ny=O("ipfs:mfs:utils:update-tree"),FU={shardSplitThreshold:1e3};async function li(r,e,t){t=Object.assign({},FU,t),ny("Trail",e),e=e.slice().reverse();let n=0,s;for await(const o of r.repo.blocks.getMany(e.map(a=>a.cid))){const a=Ke(o),c=e[n].cid,u=e[n].name;if(n++,!s){s={cid:c,name:u,size:o.length};continue}const l=await po(r,{parent:a,name:s.name,cid:s.cid,size:s.size,flush:t.flush,shardSplitThreshold:t.shardSplitThreshold,hashAlg:t.hashAlg,cidVersion:t.cidVersion});s={cid:l.cid,name:u,size:l.size}}const{cid:i}=s;return ny(`Final CID ${i}`),i}const VU=O("ipfs:mfs:utils:update-mfs-root");async function ui(r,e,t){if(t&&t.signal&&t.signal.aborted)throw E(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});return VU(`New MFS root will be ${e}`),await r.repo.datastore.put(Bf,e.bytes),e}async function jU(r,e,t){const n=new Ce({type:e,mode:t.mode,mtime:t.mtime}),s=await r.hashers.getHasher(t.hashAlg),i={Data:n.marshal(),Links:[]},o=Re(i),a=await s.digest(o),c=V.create(t.cidVersion,Ne,a);return t.flush&&await r.repo.blocks.put(c,o),{cid:c,node:i}}const KU=Le.bind({ignoreUndefined:!0}),Bm=O("ipfs:mfs:mkdir"),qU={parents:!1,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3,flush:!0};function du(r){async function e(t,n={}){const s=KU(qU,n);if(!t)throw new Error("no path given to Mkdir");if(t=t.trim(),t==="/"){if(s.parents)return;throw E(new Error("cannot create directory '/': Already exists"),"ERR_INVALID_PATH")}if(t.substring(0,1)!=="/")throw E(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");Bm(`Creating ${t}`);const i=E2(t);if(i[0]==="ipfs")throw E(new Error("path cannot have the prefix 'ipfs'"),"ERR_INVALID_PATH");const o=await b2(r,s);let a;const c=[],u=await jU(r,"directory",s);for(let d=0;d<=i.length;d++){const f=i.slice(0,d),g=`/ipfs/${o}/${f.join("/")}`;try{if(a=await Nn(g,r.repo.blocks),a.type!=="file"&&a.type!=="directory")throw E(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(d===i.length){if(s.parents)return;throw E(new Error("file already exists"),"ERR_ALREADY_EXISTS")}c.push({name:a.name,cid:a.cid})}catch(h){if(h.code==="ERR_NOT_FOUND"){if(d<i.length&&!s.parents)throw E(new Error(`Intermediate directory path ${g} does not exist, use the -p flag to create it`),"ERR_NOT_FOUND");await HU(r,f[f.length-1],u,c[c.length-1],c,s)}else throw h}}const l=await li(r,c,s);await ui(r,l,s)}return x(e)}const HU=async(r,e,t,n,s,i)=>{Bm(`Adding empty dir called ${e} to ${n.cid}`);const o=await po(r,{parent:n.node,parentCid:n.cid,size:0,cid:t.cid,name:e,hashAlg:i.hashAlg,cidVersion:i.cidVersion,flush:i.flush,shardSplitThreshold:i.shardSplitThreshold});s[s.length-1].cid=o.cid,s.push({name:e,cid:t.cid})},GU=Le.bind({ignoreUndefined:!0}),Pc=O("ipfs:mfs:cp"),WU={parents:!1,flush:!0,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3};function _2(r){async function e(t,n,s={}){const i=GU(WU,s);Array.isArray(t)||(t=[t]);const o=await Promise.all(t.map(f=>Ft(r,f,i)));let a=await Ft(r,n,i);if(!o.length||!a)throw E(new Error("Please supply at least one source"),"ERR_INVALID_PARAMS");const c=o.find(f=>!f.exists);if(c)throw E(new Error(`${c.path} does not exist`),"ERR_INVALID_PARAMS");const u=sy(a);if(a.exists){if(Pc("Destination exists"),o.length===1&&!u)throw E(new Error("directory already has entry by that name"),"ERR_ALREADY_EXISTS")}else if(Pc("Destination does not exist"),o.length>1){if(!i.parents)throw E(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await du(r)(a.path,i),a=await Ft(r,a.path,i)}else if(a.parts.length>1){const f=`/${a.parts.slice(0,-1).join("/")}`;try{await _d(r)(f,i)}catch(g){if(g.code!=="ERR_NOT_FOUND")throw g;if(!i.parents)throw E(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await du(r)(f,i),a=await Ft(r,a.path,i)}}const l=sy(a)?a.mfsPath:a.mfsDirectory,d=await rc(r,l);if(o.length===1){const f=o.pop();if(!f)throw E(new Error("could not find source"),"ERR_INVALID_PARAMS");const g=u?f.name:a.name;return Pc(`Only one source, copying to destination ${u?"directory":"file"} ${g}`),YU(r,f,g,d,i)}return Pc("Multiple sources, wrapping in a directory"),QU(r,o,a,d,i)}return x(e)}const sy=r=>r.unixfs&&r.unixfs.type&&r.unixfs.type.includes("directory"),YU=async(r,e,t,n,s)=>{let i=n.pop();if(!i)throw E(new Error("destination had no parent"),"ERR_INVALID_PARAMS");i=await zm(r,e,t,i,s),n.push(i);const o=await li(r,n,s);await ui(r,o,s)},QU=async(r,e,t,n,s)=>{for(let o=0;o<e.length;o++){const a=e[o];t=await zm(r,a,a.name,t,s)}n[n.length-1]=t;const i=await li(r,n,s);await ui(r,i,s)},zm=async(r,e,t,n,s)=>{const i=await r.repo.blocks.get(e.cid),{node:o,cid:a,size:c}=await po(r,{parentCid:n.cid,size:i.length,cid:e.cid,name:t,hashAlg:s.hashAlg,cidVersion:s.cidVersion,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold});return n.node=o,n.cid=a,n.size=c,n},ws=O("ipfs:mfs:core:utils:remove-link");async function JU(r,e){let t=e.parent;if(e.parentCid){const s=V.asCID(e.parentCid);if(s===null)throw E(new Error("Invalid CID passed to removeLink"),"EINVALIDPARENTCID");ws(`Loading parent node ${s}`);const i=await r.repo.blocks.get(s);t=Ke(i)}if(!t)throw E(new Error("No parent node or CID passed to removeLink"),"EINVALIDPARENT");if(!e.name)throw E(new Error("No child name passed to removeLink"),"EINVALIDCHILDNAME");if(!t.Data)throw E(new Error("Parent node had no data"),"ERR_INVALID_NODE");return Ce.unmarshal(t.Data).type==="hamt-sharded-directory"?(ws(`Removing ${e.name} from sharded directory`),ZU(r,{...e,parent:t})):(ws(`Removing link ${e.name} regular directory`),XU(r,{...e,parent:t}))}const XU=async(r,e)=>{e.parent.Links=e.parent.Links.filter(o=>o.Name!==e.name);const t=await Re(e.parent),s=await(await r.hashers.getHasher(e.hashAlg)).digest(t),i=V.create(e.cidVersion,Ne,s);return await r.repo.blocks.put(i,t),ws(`Updated regular directory ${i}`),{node:e.parent,cid:i}},ZU=async(r,e)=>{const{rootBucket:t,path:n}=await xU(r,e.name,e.parent);await t.del(e.name);const{node:s}=await Fm(r,n,e.name,e);return vd(r,s.Links,t,e)},Fm=async(r,e,t,n)=>{const s=e.pop();if(!s)throw E(new Error("Could not find parent"),"EINVALIDPARENT");const{bucket:i,prefix:o,node:a}=s;if(!a)throw E(new Error("Could not find parent"),"EINVALIDPARENT");const c=a.Links.find(g=>(g.Name||"").substring(0,2)===o);if(!c)throw E(new Error(`No link found with prefix ${o} for file ${t}`),"ERR_NOT_FOUND");if(c.Name===`${o}${t}`){ws(`Removing existing link ${c.Name}`);const g=a.Links.filter(h=>h.Name!==c.Name);return await i.del(t),vd(r,g,i,n)}ws(`Descending into sub-shard ${c.Name} for ${o}${t}`);const u=await Fm(r,e,t,n);let l=u.cid,d=u.size,f=o;if(u.node.Links.length===1){ws(`Removing subshard for ${o}`);const g=u.node.Links[0];f=`${o}${(g.Name||"").substring(2)}`,l=g.Hash,d=g.Tsize||0}return ws(`Updating shard ${o} with name ${f}`),eB(r,i,a,o,f,d,l,n)},eB=(r,e,t,n,s,i,o,a)=>{const c=t.Links.filter(u=>u.Name!==n);return c.push({Name:s,Tsize:i,Hash:o}),vd(r,c,e,a)},tB=Le.bind({ignoreUndefined:!0}),rB={recursive:!1,cidVersion:0,hashAlg:"sha2-256",flush:!0,shardSplitThreshold:1e3};function v2(r){async function e(t,n={}){const s=tB(rB,n);Array.isArray(t)||(t=[t]);const i=await Promise.all(t.map(o=>Ft(r,o,s)));if(!i.length)throw E(new Error("Please supply at least one path to remove"),"ERR_INVALID_PARAMS");i.forEach(o=>{if(o.path==="/")throw E(new Error("Cannot delete root"),"ERR_INVALID_PARAMS")});for(const o of i)await nB(r,o.path,s)}return x(e)}const nB=async(r,e,t)=>{const n=await Ft(r,e,t),s=await rc(r,n.mfsPath),i=s[s.length-1];s.pop();const o=s[s.length-1];if(!o)throw E(new Error(`${e} does not exist`),"ERR_NOT_FOUND");if(i.type==="directory"&&!t.recursive)throw E(new Error(`${e} is a directory, use -r to remove directories`),"ERR_WAS_DIR");const{cid:a}=await JU(r,{parentCid:o.cid,name:i.name,hashAlg:t.hashAlg,cidVersion:t.cidVersion,flush:t.flush,shardSplitThreshold:t.shardSplitThreshold});o.cid=a;const c=await li(r,s,t);await ui(r,c,t)},sB=Le.bind({ignoreUndefined:!0}),iB=O("ipfs:mfs:touch"),iy={flush:!0,shardSplitThreshold:1e3,hashAlg:"sha2-256",cidVersion:0,recursive:!1};function oB(r,e,t){let n=0;return(r.includes("x")||r.includes("X")&&(t||e&1||e&8||e&64))&&(n+=1),r.includes("w")&&(n+=2),r.includes("r")&&(n+=4),n}function aB(r,e){let t=0;return r.includes("u")&&(t+=e<<6),r.includes("g")&&(t+=e<<3),r.includes("o")&&(t+=e),t}function cB(r,e,t){return e.includes("t")&&(t+=parseInt("1000",8)),e.includes("s")&&(r.includes("u")&&(t+=parseInt("4000",8)),r.includes("g")&&(t+=parseInt("2000",8))),t}function lB(r,e,t){e||(e=0);const n=r.match(/^(u?g?o?a?)(-?\+?=?)?(r?w?x?X?s?t?)$/);if(!n)throw new Error(`Invalid file mode: ${r}`);let[,s,i,o]=n;(s==="a"||!s)&&(s="ugo");let a=oB(o,e,t);return a=aB(s,a),a=cB(s,o,a),i==="="?(s.includes("u")&&(e=e&parseInt("7077",8),e=e|a),s.includes("g")&&(e=e&parseInt("7707",8),e=e|a),s.includes("o")&&(e=e&parseInt("7770",8),e=e|a),e):i==="+"?a|e:i==="-"?a^e:e}function oy(r,e){if(r instanceof String||typeof r=="string"){const t=`${r}`;t.match(/^\d+$/g)?r=parseInt(t,8):r=0+t.split(",").reduce((n,s)=>lB(s,n,e.isDirectory()),e.mode||0)}return r}function uB(r){async function e(t,n,s={}){const i=sB(iy,s);iB(`Fetching stats for ${t}`);const{cid:o,mfsDirectory:a,name:c}=await Ft(r,t,i);if(o.code!==Ne)throw E(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(i.recursive){const A=await ne(async function*(){for await(const C of $w(o,r.repo.blocks)){if(C.type!=="file"&&C.type!=="directory")throw E(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");C.unixfs.mode=oy(n,C.unixfs);const P=Wr({Data:C.unixfs.marshal(),Links:C.node.Links});yield{path:C.path,content:P}}},C=>s2(C,r.repo.blocks,{...i,pin:!1,dagBuilder:async function*(P,$,F){for await(const W of P)yield async function(){const Q=W.content,z=Re(Q),ge=await km(z,$,F);if(!Q.Data)throw E(new Error(`${ge} had no data`),"ERR_INVALID_NODE");const Ie=Ce.unmarshal(Q.Data);return{cid:ge,size:z.length,path:W.path,unixfs:Ie}}}}),C=>tr(C));if(!A)throw E(new Error(`Could not chmod ${t}`),"ERR_COULD_NOT_CHMOD");await v2(r)(t,i),await _2(r)(`/ipfs/${A.cid}`,t,i);return}const u=await r.repo.blocks.get(o),l=Ke(u);if(!l.Data)throw E(new Error(`${o} had no data`),"ERR_INVALID_NODE");const d=Ce.unmarshal(l.Data);d.mode=oy(n,d);const f=Re({Data:d.marshal(),Links:l.Links}),g=i.hashAlg||iy.hashAlg,p=await(await r.hashers.getHasher(g)).digest(f),w=V.create(i.cidVersion,Ne,p);i.flush&&await r.repo.blocks.put(w,f);const y=await rc(r,a),_=y[y.length-1],b=V.decode(_.cid.bytes),m=await r.repo.blocks.get(b),S=Ke(m),R=await po(r,{parent:S,name:c,cid:w,size:f.length,flush:i.flush,hashAlg:g,cidVersion:o.version,shardSplitThreshold:1/0});_.cid=R.cid;const v=await li(r,y,i);await ui(r,v,i)}return x(e)}const dB=Le.bind({ignoreUndefined:!0}),hB={};function fB(r){async function e(t,n={}){n=dB(hB,n);const{cid:s}=await _d(r)(t,n);return s}return x(e)}const pB=Le.bind({ignoreUndefined:!0}),gB={parents:!1,flush:!0,cidVersion:0,hashAlg:"sha2-256",shardSplitThreshold:1e3};function yB(r){async function e(t,n,s={}){const i=pB(gB,s);await _2(r)(t,n,i),await v2(r)(t,{...i,recursive:!0})}return x(e)}const wB=Le.bind({ignoreUndefined:!0}),mB=O("ipfs:mfs:touch"),ay={flush:!0,shardSplitThreshold:1e3,cidVersion:0,hashAlg:"sha2-256"};function bB(r){async function e(t,n={}){const s=wB(ay,n);s.mtime=s.mtime||new Date,mB(`Touching ${t} mtime: ${s.mtime}`);const{cid:i,mfsDirectory:o,name:a,exists:c}=await Ft(r,t,s),u=n.hashAlg||ay.hashAlg,l=await r.hashers.getHasher(u);let d,f,g=s.cidVersion;if(c){if(i.code!==Ne)throw E(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");g=i.version;const S=await r.repo.blocks.get(i),R=Ke(S);if(!R.Data)throw E(new Error(`${t} had no data`),"ERR_INVALID_NODE");const v=Ce.unmarshal(R.Data);v.mtime=s.mtime,d=Re({Data:v.marshal(),Links:R.Links});const A=await l.digest(d);f=V.create(s.cidVersion,Ne,A),s.flush&&await r.repo.blocks.put(f,d)}else{const S=new Ce({type:"file",mtime:s.mtime});d=Re({Data:S.marshal(),Links:[]});const R=await l.digest(d);f=V.create(s.cidVersion,Ne,R),s.flush&&await r.repo.blocks.put(f,d)}const h=await rc(r,o),p=h[h.length-1],w=p.cid,y=await r.repo.blocks.get(w),_=Ke(y),b=await po(r,{parent:_,name:a,cid:f,size:d.length,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:g});p.cid=b.cid;const m=await li(r,h,s);await ui(r,m,s)}return x(e)}const EB=Le.bind({ignoreUndefined:!0}),_B={offset:0,length:1/0};function vB(r){function e(t,n={}){return n=EB(_B,n),{[Symbol.asyncIterator]:async function*(){const i=await Ft(r,t,n),o=await Nn(i.mfsPath,r.repo.blocks);if(o.type!=="file")throw E(new Error(`${t} was not a file`),"ERR_NOT_FILE");if(!o.content)throw E(new Error(`Could not load content stream from ${t}`),"ERR_NO_CONTENT");for await(const a of o.content({offset:n.offset,length:n.length}))yield a}}}return x(e)}const Mo=O("ipfs:mfs:utils:to-async-iterator");function SB(r){if(!r)throw E(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");if((typeof r=="string"||r instanceof String)&&(Mo("Content was a string"),r=M(r.toString())),r.length)return Mo("Content was array-like"),{[Symbol.asyncIterator]:function*(){yield r}};if(r[Symbol.asyncIterator])return Mo("Content was an async iterator"),r;if(r[Symbol.iterator])return Mo("Content was an iterator"),r;if(Vd.Blob&&r instanceof Vd.Blob){Mo("Content was an HTML5 Blob");let e=0;const t={next:()=>e>r.size?{done:!0}:new Promise((n,s)=>{const i=r.slice(e,zf);e+=zf;const o=new Vd.FileReader,a=c=>{if(o.removeEventListener("loadend",a,!1),c.error)return s(c.error);n({done:!1,value:new Uint8Array(o.result)})};o.addEventListener("loadend",a),o.readAsArrayBuffer(i)})};return{[Symbol.asyncIterator]:()=>t}}throw E(new Error(`Don't know how to convert ${r} into an async iterator`),"ERR_INVALID_PARAMS")}const RB=Le.bind({ignoreUndefined:!0}),$r=O("ipfs:mfs:write"),IB={offset:0,length:1/0,create:!1,truncate:!1,rawLeaves:!1,reduceSingleLeafToSelf:!1,cidVersion:0,hashAlg:"sha2-256",parents:!1,progress:(r,e)=>{},strategy:"trickle",flush:!0,leafType:"raw",shardSplitThreshold:1e3};function AB(r){async function e(t,n,s={}){const i=RB(IB,s);let o,a,c;if($r("Reading source, destination and parent"),await m2().readLock(async()=>{o=await SB(n),a=await Ft(r,t,i),c=await Ft(r,a.mfsDirectory,i)})(),$r("Read source, destination and parent"),!i.parents&&!c.exists)throw E(new Error("directory does not exist"),"ERR_NO_EXIST");if(o==null)throw E(new Error("could not create source"),"ERR_NO_SOURCE");if(a==null)throw E(new Error("could not create destination"),"ERR_NO_DESTINATION");if(!i.create&&!a.exists)throw E(new Error("file does not exist"),"ERR_NO_EXIST");if(a.entryType!=="file")throw E(new Error("not a file"),"ERR_NOT_A_FILE");return CB(r,t,o,a,i)}return x(e)}const CB=async(r,e,t,n,s)=>{const i=await TB(r,t,n,s);await m2().writeLock(async()=>{const o=E2(e),a=o.pop();if(a==null)throw E(new Error("source does not exist"),"ERR_NO_EXIST");let c=!1;try{await _d(r)(`/${o.join("/")}`,s),c=!0}catch(w){if(w.code!=="ERR_NOT_FOUND")throw w}c||await du(r)(`/${o.join("/")}`,s);const u=await Ft(r,e,s),l=await rc(r,u.mfsDirectory),d=l[l.length-1];if(!d)throw E(new Error("directory does not exist"),"ERR_NO_EXIST");if(!d.type||!d.type.includes("directory"))throw E(new Error(`cannot write to ${d.name}: Not a directory`),"ERR_NOT_A_DIRECTORY");const f=await r.repo.blocks.get(d.cid),g=Ke(f),h=await po(r,{parent:g,name:a,cid:i.cid,size:i.size,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:s.cidVersion});d.cid=h.cid;const p=await li(r,l,s);await ui(r,p,s)})()},TB=async(r,e,t,n)=>{t.exists?$r(`Overwriting file ${t.cid} offset ${n.offset} length ${n.length}`):$r(`Writing file offset ${n.offset} length ${n.length}`);const s=[];if(n.offset>0)if(t.unixfs){if($r(`Writing first ${n.offset} bytes of original file`),s.push(()=>t.content({offset:0,length:n.offset})),t.unixfs.fileSize()<n.offset){const l=n.offset-t.unixfs.fileSize();$r(`Writing zeros for extra ${l} bytes`),s.push(cy(l))}}else $r(`Writing zeros for first ${n.offset} bytes`),s.push(cy(n.offset));s.push(Vm(e,n.length));const i=PB(DB(s),l=>{if(t.unixfs&&!n.truncate){const d=t.unixfs.fileSize();if(d>l)return $r(`Writing last ${d-l} of ${d} bytes from original file starting at offset ${l}`),t.content({offset:l});$r("Not writing last bytes from original file")}return{[Symbol.asyncIterator]:async function*(){}}});let o;n.mode!==void 0&&n.mode!==null?o=Ni(n.mode):t&&t.unixfs&&(o=t.unixfs.mode);let a;n.mtime!=null?a=Aa(n.mtime):t&&t.unixfs&&(a=t.unixfs.mtime);const c=await r.hashers.getHasher(n.hashAlg),u=await tr(s2([{content:i,mode:o,mtime:a}],r.repo.blocks,{progress:n.progress,hasher:c,cidVersion:n.cidVersion,strategy:n.strategy,rawLeaves:n.rawLeaves,reduceSingleLeafToSelf:n.reduceSingleLeafToSelf,leafType:n.leafType}));if(!u)throw E(new Error(`cannot write to ${parent.name}`),"ERR_COULD_NOT_WRITE");return $r(`Wrote ${u.cid}`),{cid:u.cid,size:u.size}},Vm=(r,e)=>async function*(){let n=0;for await(const s of r){if(n+=s.length,n>e){yield s.subarray(0,e-n);return}yield s}},cy=(r,e=zf)=>{const t=new Uint8Array(e);async function*n(){for(;;)yield t}return Vm(n(),r)},DB=async function*(r){for(let e=0;e<r.length;e++)yield*r[e]()},PB=async function*(r,e){let t=0;for await(const n of r)t+=n.length,yield n;for await(const n of e(t))t+=n.length,yield n},ly=r=>{const e={cid:r.cid,name:r.name,type:r.type==="directory"?"directory":"file",size:r.size};return(r.type==="file"||r.type==="directory")&&(e.mode=r.unixfs.mode,e.mtime=r.unixfs.mtime),e};function kB(r){async function*e(t,n={}){const s=await Ft(r,t,n),i=await Nn(s.mfsPath,r.repo.blocks);if(i.type==="directory"){yield*_t(i.content(n),ly);return}yield ly(i)}return x(e)}const OB={stat:_d},NB={chmod:uB,cp:_2,flush:fB,mkdir:du,mv:yB,rm:v2,touch:bB},uy={write:AB,read:vB,ls:kB},dy=({options:r,mfs:e,operations:t,lock:n})=>{Object.keys(t).forEach(s=>{e[s]=n(t[s](r))})},xB={repoOwner:!0,repo:null};function $B(r){const{repoOwner:e}=Object.assign({},xB||{},r),t=m2(e),n=o=>t.readLock(o),s=o=>t.writeLock(o),i={};return dy({options:r,mfs:i,operations:OB,lock:n}),dy({options:r,mfs:i,operations:NB,lock:s}),Object.keys(uy).forEach(o=>{i[o]=uy[o](r)}),i}function LB({repo:r,preload:e,hashers:t,options:n}){const s=$B({repo:r,repoOwner:n.repoOwner!==!1,hashers:t}),i=o=>(...c)=>{const u=c.filter(l=>$A(l)||V0(l));if(u.length){const l=c[c.length-1];l&&l.preload!==!1&&u.forEach(d=>e(d))}return o(...c)};return{...s,chmod:s.chmod,cp:i(s.cp),mkdir:s.mkdir,stat:i(s.stat),rm:s.rm,read:i(s.read),touch:s.touch,write:s.write,mv:i(s.mv),flush:s.flush,ls:i(async function*(...o){for await(const a of s.ls(...o))yield{...a,size:a.size||0}})}}function MB({keychain:r}){return x((t,n)=>r.exportKey(t,n))}const hy="Ed25519",fy=2048;function UB({keychain:r}){return x((t,n={type:hy,size:fy})=>r.createKey(t,n.type||hy,n.size||fy))}function BB({keychain:r}){return x((t,n,s)=>r.importKey(t,n,s))}function zB({keychain:r}){return x(t=>r.findKeyByName(t))}function FB({keychain:r}){return x(()=>r.listKeys())}function VB({keychain:r}){return x(async(t,n)=>{const s=await r.renameKey(t,n);return{was:t,now:s.name,id:s.id,overwrite:!1}})}function jB({keychain:r}){return x(t=>r.removeKey(t))}class KB{constructor({keychain:e}){this.gen=UB({keychain:e}),this.list=FB({keychain:e}),this.rm=jB({keychain:e}),this.rename=VB({keychain:e}),this.export=MB({keychain:e}),this.import=BB({keychain:e}),this.info=zB({keychain:e})}}function di({repo:r,preload:e}){async function t(n,s={}){s.preload!==!1&&e(n);const i=await r.blocks.get(n,s);return Ke(i)}return x(t)}function qB({repo:r,preload:e}){const t=di({repo:r,preload:e});async function n(s,i={}){return(await t(s,i)).Data||new Uint8Array(0)}return x(n)}function R1(r,e=[]){for(const t in r){const n=r[t];if(t==="/"&&Object.keys(r).length===1)try{e.push({Name:"",Tsize:0,Hash:V.parse(n)});continue}catch{}const s=V.asCID(n);if(s){e.push({Name:"",Tsize:0,Hash:s});continue}Array.isArray(n)&&R1(n,e),n&&typeof n=="object"&&R1(n,e)}return e}function HB({repo:r,codecs:e}){async function t(n,s={}){const i=await e.getCodec(n.code),o=await r.blocks.get(n,s),a=i.decode(o);switch(n.code){case U0:return[];case Ne:return a.Links;case k0:case V6:return R1(a);default:throw new Error(`Cannot resolve links from codec ${n.code}`)}}return x(t)}function GB({repo:r,preload:e}){async function t(n={}){let s;if(n.template)if(n.template==="unixfs-dir")s=new Ce({type:"directory"}).marshal();else throw new Error("unknown template");const i=Re({Data:s,Links:[]}),o=await Hi.digest(i),a=V.createV0(o);return await r.blocks.put(a,i,{signal:n.signal}),n.preload!==!1&&e(a),a}return x(t)}function nc({repo:r,preload:e}){async function t(n,s={}){const i=await r.gcLock.readLock();try{const o=Re(n),a=await Hi.digest(o),c=V.createV1(Ne,a);return await r.blocks.put(c,o,{signal:s.signal}),s.preload!==!1&&e(c),s.pin&&await r.pins.pinRecursively(c,{signal:s.signal}),c}finally{i()}}return x(t)}function WB({repo:r,preload:e}){const t=di({repo:r,preload:e});async function n(s,i={}){const o=await t(s,i),c=Re(o).length,u=o.Links.reduce((l,d)=>l+(d.Tsize||0),0);return{Hash:s,NumLinks:o.Links.length,BlockSize:c,LinksSize:c-(o.Data||[]).length,DataSize:(o.Data||[]).length,CumulativeSize:c+u}}return x(n)}function YB({repo:r,preload:e}){const t=di({repo:r,preload:e}),n=nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a);return n({...c,Links:c.Links.concat([o])},a)}return x(s)}function QB({repo:r,preload:e}){const t=di({repo:r,preload:e}),n=nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a),u=Jt([c.Data||[],o]);return n({...c,Data:u},a)}return x(s)}function JB({repo:r,preload:e}){const t=di({repo:r,preload:e}),n=nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a),u=(typeof o=="string"?o:o.Name)||"";return c.Links=c.Links.filter(l=>l.Name!==u),n(c,a)}return x(s)}function XB({repo:r,preload:e}){const t=di({repo:r,preload:e}),n=nc({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a);return n({...c,Data:o},a)}return x(s)}class ZB{constructor({repo:e,preload:t}){this.addLink=YB({repo:e,preload:t}),this.appendData=QB({repo:e,preload:t}),this.rmLink=JB({repo:e,preload:t}),this.setData=XB({repo:e,preload:t})}}class ez{constructor({repo:e,codecs:t,preload:n}){this.data=qB({repo:e,preload:n}),this.get=di({repo:e,preload:n}),this.links=HB({repo:e,codecs:t}),this.new=GB({repo:e,preload:n}),this.put=nc({repo:e,preload:n}),this.stat=WB({repo:e,preload:n}),this.patch=new ZB({repo:e,preload:n})}}const tz=O("ipfs:repo:gc");function rz({repo:r,hashers:e}){async function*t(n={}){const s=Date.now();let i;try{i=await b2({repo:r,hashers:e},n),await r.pins.pinRecursively(i),yield*r.gc()}finally{i&&await r.pins.unpin(i)}tz(`Complete (${Date.now()-s}ms)`)}return x(t)}function jm({repo:r}){async function e(t={}){const n=await r.stat();return{numObjects:BigInt(n.numObjects.toString()),repoSize:BigInt(n.repoSize.toString()),repoPath:n.repoPath,version:`${n.version}`,storageMax:BigInt(n.storageMax.toString())}}return x(e)}const cl=12;function nz({repo:r}){async function e(t={}){try{await r._checkInitialized(t)}catch(n){if([/Key not found in database \[\/version\]/,/ENOENT/,/repo is not initialized yet/].some(i=>i.test(n.message)))return cl;throw n}return r.version.get()}return x(e)}class sz{constructor({repo:e,hashers:t}){this.gc=rz({repo:e,hashers:t}),this.stat=jm({repo:e}),this.version=nz({repo:e}),this.setApiAddr=n=>e.apiAddr.set(n)}}function py(r,e){let t;if(r.metrics?e.peer?t=r.metrics.forPeer(e.peer):e.proto?t=r.metrics.forProtocol(e.proto):t=r.metrics.getGlobal():t=void 0,!t)return{totalIn:BigInt(0),totalOut:BigInt(0),rateIn:0,rateOut:0};const n=t.getMovingAverages(),s=t.getSnapshot();return{totalIn:s.dataReceived,totalOut:s.dataSent,rateIn:n.dataReceived[6e4].movingAverage/60,rateOut:n.dataSent[6e4].movingAverage/60}}function iz({network:r}){return x(async function*(t={}){const{libp2p:n}=await r.use(t);if(!t.poll){yield py(n,t);return}const s=t.interval||1e3;let i=-1;try{if(i=typeof s=="string"?ee(s)||-1:s,!i||i<0)throw new Error("invalid duration")}catch(a){throw E(a,"ERR_INVALID_POLL_INTERVAL")}let o;try{for(;;)yield py(n,t),await new Promise(a=>{o=setTimeout(a,i)})}finally{clearTimeout(o)}})}class oz{constructor({repo:e,network:t}){this.repo=jm({repo:e}),this.bw=iz({network:t}),this.bitswap=q8({network:t})}}var S2=az;function az(r,e,t){if(!r)return t;var n,s;if(Array.isArray(e)&&(n=e.slice(0)),typeof e=="string"&&(n=e.split(".")),typeof e=="symbol"&&(n=[e]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");for(;n.length;)if(s=n.shift(),!r||(r=r[s],r===void 0))return t;return r}var cz=Km,gy=128,lz=127,uz=~lz,dz=Math.pow(2,31);function Km(r,e,t){e=e||[],t=t||0;for(var n=t;r>=dz;)e[t++]=r&255|gy,r/=128;for(;r&uz;)e[t++]=r&255|gy,r>>>=7;return e[t]=r|0,Km.bytes=t-n+1,e}var hz=I1,fz=128,yy=127;function I1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw I1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&yy)<<s:(o&yy)*Math.pow(2,s),s+=7}while(o>=fz);return I1.bytes=i-n,t}var pz=Math.pow(2,7),gz=Math.pow(2,14),yz=Math.pow(2,21),wz=Math.pow(2,28),mz=Math.pow(2,35),bz=Math.pow(2,42),Ez=Math.pow(2,49),_z=Math.pow(2,56),vz=Math.pow(2,63),Sz=function(r){return r<pz?1:r<gz?2:r<yz?3:r<wz?4:r<mz?5:r<bz?6:r<Ez?7:r<_z?8:r<vz?9:10},Rz={encode:cz,decode:hz,encodingLength:Sz},hu=Rz;const A1=(r,e=0)=>[hu.decode(r,e),hu.decode.bytes],fu=(r,e,t=0)=>(hu.encode(r,e,t),e),pu=r=>hu.encodingLength(r),Iz=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},R2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},C1=(r,e)=>{const t=e.byteLength,n=pu(r),s=n+pu(t),i=new Uint8Array(s+t);return fu(r,i,0),fu(t,i,n),i.set(e,s),new A2(r,t,e,i)},I2=r=>{const e=R2(r),[t,n]=A1(e),[s,i]=A1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new A2(t,s,o,e)},Az=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Iz(r.bytes,t.bytes)}};let A2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function Cz(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Tz=Cz,Dz=Tz;let Pz=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},kz=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return qm(this,e)}},Oz=class{constructor(e){this.decoders=e}or(e){return qm(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const qm=(r,e)=>new Oz({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Nz=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Pz(e,t,n),this.decoder=new kz(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Hm=({name:r,prefix:e,encode:t,decode:n})=>new Nz(r,e,t,n),Gm=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Dz(t,e);return Hm({prefix:r,name:e,encode:n,decode:i=>R2(s(i))})},xz=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},$z=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},$n=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Hm({prefix:e,name:r,encode(s){return $z(s,n,t)},decode(s){return xz(s,n,t,r)}}),os=Gm({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Gm({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Hr=$n({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});$n({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});$n({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});$n({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});$n({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});$n({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});$n({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});$n({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});$n({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Lz=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Uz(t,T1(r),e||os.encoder);default:return Bz(t,T1(r),e||Hr.encoder)}},wy=new WeakMap,T1=r=>{const e=wy.get(r);if(e==null){const t=new Map;return wy.set(r,t),t}return e};let xe=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Uo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==zz)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return xe.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=C1(e,t);return xe.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return xe.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Az(e.multihash,n.multihash)}toString(e){return Lz(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof xe)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new xe(n,s,i,o||my(n,s,i.bytes))}else if(t[Fz]===!0){const{version:n,multihash:s,code:i}=t,o=I2(s);return xe.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Uo)throw new Error(`Version 0 CID must use dag-pb (code: ${Uo}) block encoding`);return new xe(e,t,n,n.bytes)}case 1:{const s=my(e,t,n.bytes);return new xe(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return xe.create(0,Uo,e)}static createV1(e,t){return xe.create(1,e,t)}static decode(e){const[t,n]=xe.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=xe.inspectBytes(e),n=t.size-t.multihashSize,s=R2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new A2(t.multihashCode,t.digestSize,i,s);return[t.version===0?xe.createV0(o):xe.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=A1(e.subarray(t));return t+=f,d};let s=n(),i=Uo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Mz(e,t),i=xe.decode(s);return T1(i).set(n,e),i}};const Mz=(r,e)=>{switch(r[0]){case"Q":{const t=e||os;return[os.prefix,t.decode(`${os.prefix}${r}`)]}case os.prefix:{const t=e||os;return[os.prefix,t.decode(r)]}case Hr.prefix:{const t=e||Hr;return[Hr.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Uz=(r,e,t)=>{const{prefix:n}=t;if(n!==os.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Bz=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Uo=112,zz=18,my=(r,e,t)=>{const n=pu(r),s=n+pu(e),i=new Uint8Array(s+t.byteLength);return fu(r,i,0),fu(e,i,n),i.set(t,s),i},Fz=Symbol.for("@ipld/js-cid/CID");async function Xi(r){let e=0;for await(const t of r)e++;return e}const Vz=85,jz=Xt("ipfs:repo:migrator:migration-8");function Wm(r){return r.child?Wm(r.child):r}function Kz(r){try{const e=Hr.decode(`b${r.toString().toLowerCase().slice(1)}`),t=xe.decode(e).multihash.bytes,n=Hr.encode(t).slice(1).toUpperCase();return new J(`/${n}`,!1)}catch{return r}}function qz(r){try{const e=Hr.decode(`b${r.toString().toLowerCase().slice(1)}`),t=I2(e),n=Hr.encode(xe.createV1(Vz,t).bytes).slice(1);return new J(`/${n.toUpperCase()}`,!1)}catch{return r}}async function by(r,e,t){const n=r.blocks;await n.open();const s=Wm(n),i=await Xi(s.queryKeys({filters:[o=>t(o).toString()!==o.toString()]}));try{let o=0;for await(const a of s.query({})){const c=t(a.key);c.toString()!==a.key.toString()&&(o+=1,jz(`Migrating Block from ${a.key} to ${c}`,await s.has(a.key)),await s.delete(a.key),await s.put(c,a.value),e(o/i*100,`Migrated Block from ${a.key} to ${c}`))}}finally{await n.close()}}const Hz={version:8,description:"Transforms key names into base32 encoding and converts Block store to use bare multihashes encoded as base32",migrate:(r,e=()=>{})=>by(r,e,Kz),revert:(r,e=()=>{})=>by(r,e,qz)},Ey=j.Reader,Gz=j.Writer;j.util;const kc=j.roots.default||(j.roots.default={}),Wz=kc.ipfs=(()=>{const r={};return r.pin=function(){const e={};return e.Set=function(){function t(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}return t.prototype.version=0,t.prototype.fanout=0,t.prototype.seed=0,t.encode=function(s,i){return i||(i=Gz.create()),s.version!=null&&Object.hasOwnProperty.call(s,"version")&&i.uint32(8).uint32(s.version),s.fanout!=null&&Object.hasOwnProperty.call(s,"fanout")&&i.uint32(16).uint32(s.fanout),s.seed!=null&&Object.hasOwnProperty.call(s,"seed")&&i.uint32(29).fixed32(s.seed),i},t.decode=function(s,i){s instanceof Ey||(s=Ey.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new kc.ipfs.pin.Set;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:a.version=s.uint32();break;case 2:a.fanout=s.uint32();break;case 3:a.seed=s.fixed32();break;default:s.skipType(c&7);break}}return a},t.fromObject=function(s){if(s instanceof kc.ipfs.pin.Set)return s;var i=new kc.ipfs.pin.Set;return s.version!=null&&(i.version=s.version>>>0),s.fanout!=null&&(i.fanout=s.fanout>>>0),s.seed!=null&&(i.seed=s.seed>>>0),i},t.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(o.version=0,o.fanout=0,o.seed=0),s.version!=null&&s.hasOwnProperty("version")&&(o.version=s.version),s.fanout!=null&&s.hasOwnProperty("fanout")&&(o.fanout=s.fanout),s.seed!=null&&s.hasOwnProperty("seed")&&(o.seed=s.seed),o},t.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},t}(),e}(),r})();var gu={},Yz={get exports(){return gu},set exports(r){gu=r}};(function(r,e){Object.defineProperty(e,"__esModule",{value:!0}),t.BASE=2166136261;function t(n,s=t.BASE){const i=n.length;for(let o=0;o<i;o++)s^=n.charCodeAt(o),s+=(s<<1)+(s<<4)+(s<<7)+(s<<8)+(s<<24);return s>>>0}e.default=t,r.exports=t})(Yz,gu);const Qz=E0(gu),ll=new J("/local/pins"),bh=256,Jz=8192,Ym=xe.parse("QmdfTbBqBPQ7VNxZEYEj14VmRuZBkqFbiwReogJgS1zR1n"),Ci={direct:"direct",recursive:"recursive"};function _y(r){return new J(`/${Hr.encode(r.multihash.bytes).toUpperCase().substring(1)}`)}const Qm=({name:r,code:e,encode:t})=>new Xz(r,e,t);let Xz=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?C1(this.code,t):t.then(n=>C1(this.code,n))}else throw Error("Unknown type, must be binary type")}};const Jm=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),C2=Qm({name:"sha2-256",code:18,encode:Jm("SHA-256")});Qm({name:"sha2-512",code:19,encode:Jm("SHA-512")});const D1=Wz.pin.Set;function Zz(r){const e=r.Data;if(!e)throw new Error("No data present");const t=ze.decode(e),n=ze.decode.bytes;if(n<=0)throw new Error("Invalid Set header length");if(n+t>e.length)throw new Error("Impossibly large set header length");const s=e.slice(n,t+n),i=D1.toObject(D1.decode(s),{defaults:!1,arrays:!0,longs:Number,objects:!1});if(i.version!==1)throw new Error(`Unsupported Set version: ${i.version}`);if(i.fanout>r.Links.length)throw new Error("Impossibly large fanout");return{header:i,data:e.slice(t+n)}}function eF(r,e){const t=new Uint8Array(4);new DataView(t.buffer).setUint32(0,r,!0);const s=M(e.toString()),i=Jt([t,s],t.byteLength+s.byteLength);return Qz(q(i))}async function*Xm(r,e){const t=Zz(e);let n=0;for(const s of e.Links){if(n<t.header.fanout){const i=s.Hash;if(!Ym.equals(i)){const o=await r.get(i),a=Ke(o);yield*Xm(r,a)}}else yield s.Hash;n++}}async function*Oc(r,e,t){const n=e.Links.find(o=>o.Name===t);if(!n)throw new Error("No link found with name "+t);const s=await r.get(n.Hash),i=Ke(s);yield*Xm(r,i)}function tF(r,e){return t(e,0);async function t(n,s){const i=D1.encode({version:1,fanout:bh,seed:s}).finish(),o=ze.encode(i.length),a=Jt([o,i]),c=[];for(let l=0;l<bh;l++)c.push({Name:"",Tsize:1,Hash:Ym});if(n.length<=Jz){const l=n.map(g=>({link:{Name:"",Tsize:1,Hash:g.key},data:g.data||new Uint8Array})).sort((g,h)=>ff(g.link.Hash.bytes,h.link.Hash.bytes)),d=c.concat(l.map(g=>g.link));return{Data:Jt([a,...l.map(g=>g.data)]),Links:d}}else{const l=n.reduce((f,g)=>{const h=eF(s,g.key)%bh;return f[h]=h in f?f[h].concat([g]):[g],f},[]);let d=0;for(const f of l){const g=await t(f,s+1);await u(g,d),d++}return{Data:a,Links:c}}async function u(l,d){const f=Re(l),g=await C2.digest(f),h=xe.createV0(g);await r.put(h,f);const p=l.Links.reduce((w,y)=>w+(y.Tsize||0),0)+f.length;c[d]={Name:"",Tsize:p,Hash:h}}}}async function vy(r,e,t){const n=await tF(r,t.map(c=>({key:c}))),s=Re(n),i=await C2.digest(s),o=xe.createV0(i);await r.put(o,s);const a=n.Links.reduce((c,u)=>c+u.Tsize,0)+s.length;return{Name:e,Tsize:a,Hash:o}}async function rF(r,e,t,n){if(!await e.has(ll))return;const s=await e.get(ll),i=xe.decode(s),o=await r.get(i),a=Ke(o);let c=0;const u=await Xi(Oc(r,a,Ci.recursive))+await Xi(Oc(r,a,Ci.direct));for await(const l of Oc(r,a,Ci.recursive)){c++;const d={depth:1/0};l.version!==0&&(d.version=l.version),l.code!==Ne&&(d.codec=l.code),await t.put(_y(l),Xs(d)),n(c/u*100,`Migrated recursive pin ${l}`)}for await(const l of Oc(r,a,Ci.direct)){c++;const d={depth:0};l.version!==0&&(d.version=l.version),l.code!==Ne&&(d.codec=l.code),await t.put(_y(l),Xs(d)),n(c/u*100,`Migrated direct pin ${l}`)}await r.delete(i),await e.delete(ll)}async function nF(r,e,t,n){const s=[],i=[];let o=0;const a=await Xi(t.queryKeys({}));for await(const{key:f,value:g}of t.query({})){o++;const h=Ir(g),p=xe.create(h.version||0,h.codec||Ne,I2(Hr.decode("b"+f.toString().toLowerCase().split("/").pop())));h.depth===0?(n(o/a*100,`Reverted direct pin ${p}`),i.push(p)):(n(o/a*100,`Reverted recursive pin ${p}`),s.push(p))}n(100,"Updating pin root");const c={Links:[await vy(r,Ci.direct,i),await vy(r,Ci.recursive,s)]},u=Re(c),l=await C2.digest(u),d=xe.createV0(l);await r.put(d,u),await e.put(ll,d.bytes)}async function Sy(r,e,t){const n=r.blocks,s=r.datastore,i=r.pins;await n.open(),await s.open(),await i.open();try{await t(n,s,i,e)}finally{await i.close(),await s.close(),await n.close()}}const sF={version:9,description:"Migrates pins to datastore",migrate:(r,e=()=>{})=>Sy(r,e,rF),revert:(r,e=()=>{})=>Sy(r,e,nF)},iF=new J("/config"),T2=new J("/version");function Rd(r){let e=r;for(;e.db||e.child;)if(e=e.db||e.child,e.type==="level-js"||e.constructor.name==="Level")return e}async function oF(r,e,t){const n=await e(r);if(n)return n;const s=Rd(t);return s?new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{i(Boolean(a.result))}}):!1}async function aF(r,e,t,n){if(await t(r))return e(r);const s=Rd(n);if(!s)throw Yr();return new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{if(a.result)return i(a.result);o(Yr())}})}function Nc(r){const e=r.get.bind(r),t=r.has.bind(r);return r.get=n=>aF(n,e,t,r),r.has=n=>oF(n,t,r),r}function Zm(r){return{...r,root:Nc(r.root),datastore:Nc(r.datastore),pins:Nc(r.pins),keys:Nc(r.keys)}}async function cF(r,e,t=()=>{}){const n=Rd(e);if(!n){t(`${r} did not need an upgrade`);return}t(`Upgrading ${r}`),await t7(n,(i,o)=>[{type:"del",key:i},{type:"put",key:M(i),value:o}])}async function lF(r,e,t=()=>{}){const n=Rd(e);if(!n){t(`${r} did not need a downgrade`);return}t(`Downgrading ${r}`),await t7(n,(i,o)=>[{type:"del",key:i},{type:"put",key:q(i),value:o}])}function e7(r){return r.child?e7(r.child):r}async function Ry(r,e,t){const n=Object.entries(r).map(([o,a])=>({key:o,backend:e7(a)})).filter(({key:o,backend:a})=>a.constructor.name==="LevelDatastore").map(({key:o,backend:a})=>({name:o,store:a}));e(0,`Migrating ${n.length} dbs`);let s=0;const i=o=>{e(Math.round(s/n.length*100),o)};for(const{name:o,store:a}of n){await a.open();try{await t(o,a,i)}finally{s++,await a.close()}}e(100,`Migrated ${n.length} dbs`)}const uF={version:10,description:"Migrates datastore-level keys to binary",migrate:(r,e=()=>{})=>Ry(r,e,cF),revert:(r,e=()=>{})=>Ry(r,e,lF)};function t7(r,e){function t(n,s){const i=r.store("readwrite"),o=i.transaction;let a=0,c;o.onabort=()=>s(c||o.error||new Error("aborted by user")),o.oncomplete=()=>s();function u(){const l=n[a++],d=l.key;let f;try{f=l.type==="del"?i.delete(d):i.put(l.value,d)}catch(g){c=g,o.abort();return}a<n.length&&(f.onsuccess=u)}u()}return new Promise((n,s)=>{const i=r.iterator(),o=c=>c;i._deserializeKey=i._deserializeValue=o,a();function a(){const c=(u,l,d)=>{if(u||l===void 0){const f=g=>{if(g){s(g);return}n()};i.end(f);return}t(e(l,d),a)};i.next(c)}})}const ms=new J("/local/filesroot");async function dF(r,e=()=>{}){if(e(100,"Migrating MFS root to repo datastore"),await r.root.open(),await r.datastore.open(),await r.root.has(ms)){const t=await r.root.get(ms);await r.datastore.put(ms,t),await r.root.delete(ms)}await r.datastore.close(),await r.root.close(),e(100,"Stored MFS root in repo datastore")}async function hF(r,e=()=>{}){if(e(100,"Migrating MFS root to repo root datastore"),await r.root.open(),await r.datastore.open(),await r.datastore.has(ms)){const t=await r.datastore.get(ms);await r.root.put(ms,t),await r.datastore.delete(ms)}await r.datastore.close(),await r.root.close(),e(100,"Stored MFS root in repo root datastore")}const fF={version:11,description:"Store mfs root in the datastore",migrate:dF,revert:hF},Iy=j.Reader,pF=j.Writer,gF=j.util,xc=j.roots.default||(j.roots.default={}),r7=xc.Protocols=(()=>{function r(e){if(this.protocols=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.protocols=gF.emptyArray,r.encode=function(t,n){if(n||(n=pF.create()),t.protocols!=null&&t.protocols.length)for(var s=0;s<t.protocols.length;++s)n.uint32(10).string(t.protocols[s]);return n},r.decode=function(t,n){t instanceof Iy||(t=Iy.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new xc.Protocols;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.protocols&&i.protocols.length||(i.protocols=[]),i.protocols.push(t.string());break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof xc.Protocols)return t;var n=new xc.Protocols;if(t.protocols){if(!Array.isArray(t.protocols))throw TypeError(".Protocols.protocols: array expected");n.protocols=[];for(var s=0;s<t.protocols.length;++s)n.protocols[s]=String(t.protocols[s])}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.protocols=[]),t.protocols&&t.protocols.length){s.protocols=[];for(var i=0;i<t.protocols.length;++i)s.protocols[i]=t.protocols[i]}return s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})(),yi=j.Reader,Eh=j.Writer,De=j.util,it=j.roots.default||(j.roots.default={}),n7=it.Addresses=(()=>{function r(e){if(this.addrs=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.addrs=De.emptyArray,r.prototype.certifiedRecord=null,r.encode=function(t,n){if(n||(n=Eh.create()),t.addrs!=null&&t.addrs.length)for(var s=0;s<t.addrs.length;++s)it.Addresses.Address.encode(t.addrs[s],n.uint32(10).fork()).ldelim();return t.certifiedRecord!=null&&Object.hasOwnProperty.call(t,"certifiedRecord")&&it.Addresses.CertifiedRecord.encode(t.certifiedRecord,n.uint32(18).fork()).ldelim(),n},r.decode=function(t,n){t instanceof yi||(t=yi.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new it.Addresses;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.addrs&&i.addrs.length||(i.addrs=[]),i.addrs.push(it.Addresses.Address.decode(t,t.uint32()));break;case 2:i.certifiedRecord=it.Addresses.CertifiedRecord.decode(t,t.uint32());break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof it.Addresses)return t;var n=new it.Addresses;if(t.addrs){if(!Array.isArray(t.addrs))throw TypeError(".Addresses.addrs: array expected");n.addrs=[];for(var s=0;s<t.addrs.length;++s){if(typeof t.addrs[s]!="object")throw TypeError(".Addresses.addrs: object expected");n.addrs[s]=it.Addresses.Address.fromObject(t.addrs[s])}}if(t.certifiedRecord!=null){if(typeof t.certifiedRecord!="object")throw TypeError(".Addresses.certifiedRecord: object expected");n.certifiedRecord=it.Addresses.CertifiedRecord.fromObject(t.certifiedRecord)}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.addrs=[]),n.defaults&&(s.certifiedRecord=null),t.addrs&&t.addrs.length){s.addrs=[];for(var i=0;i<t.addrs.length;++i)s.addrs[i]=it.Addresses.Address.toObject(t.addrs[i],n)}return t.certifiedRecord!=null&&t.hasOwnProperty("certifiedRecord")&&(s.certifiedRecord=it.Addresses.CertifiedRecord.toObject(t.certifiedRecord,n)),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.Address=function(){function e(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}e.prototype.multiaddr=De.newBuffer([]),e.prototype.isCertified=null;let t;return Object.defineProperty(e.prototype,"_isCertified",{get:De.oneOfGetter(t=["isCertified"]),set:De.oneOfSetter(t)}),e.encode=function(s,i){return i||(i=Eh.create()),s.multiaddr!=null&&Object.hasOwnProperty.call(s,"multiaddr")&&i.uint32(10).bytes(s.multiaddr),s.isCertified!=null&&Object.hasOwnProperty.call(s,"isCertified")&&i.uint32(16).bool(s.isCertified),i},e.decode=function(s,i){s instanceof yi||(s=yi.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new it.Addresses.Address;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:a.multiaddr=s.bytes();break;case 2:a.isCertified=s.bool();break;default:s.skipType(c&7);break}}return a},e.fromObject=function(s){if(s instanceof it.Addresses.Address)return s;var i=new it.Addresses.Address;return s.multiaddr!=null&&(typeof s.multiaddr=="string"?De.base64.decode(s.multiaddr,i.multiaddr=De.newBuffer(De.base64.length(s.multiaddr)),0):s.multiaddr.length&&(i.multiaddr=s.multiaddr)),s.isCertified!=null&&(i.isCertified=Boolean(s.isCertified)),i},e.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(i.bytes===String?o.multiaddr="":(o.multiaddr=[],i.bytes!==Array&&(o.multiaddr=De.newBuffer(o.multiaddr)))),s.multiaddr!=null&&s.hasOwnProperty("multiaddr")&&(o.multiaddr=i.bytes===String?De.base64.encode(s.multiaddr,0,s.multiaddr.length):i.bytes===Array?Array.prototype.slice.call(s.multiaddr):s.multiaddr),s.isCertified!=null&&s.hasOwnProperty("isCertified")&&(o.isCertified=s.isCertified,i.oneofs&&(o._isCertified="isCertified")),o},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e}(),r.CertifiedRecord=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.seq=De.Long?De.Long.fromBits(0,0,!0):0,e.prototype.raw=De.newBuffer([]),e.encode=function(n,s){return s||(s=Eh.create()),n.seq!=null&&Object.hasOwnProperty.call(n,"seq")&&s.uint32(8).uint64(n.seq),n.raw!=null&&Object.hasOwnProperty.call(n,"raw")&&s.uint32(18).bytes(n.raw),s},e.decode=function(n,s){n instanceof yi||(n=yi.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new it.Addresses.CertifiedRecord;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.seq=n.uint64();break;case 2:o.raw=n.bytes();break;default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof it.Addresses.CertifiedRecord)return n;var s=new it.Addresses.CertifiedRecord;return n.seq!=null&&(De.Long?(s.seq=De.Long.fromValue(n.seq)).unsigned=!0:typeof n.seq=="string"?s.seq=parseInt(n.seq,10):typeof n.seq=="number"?s.seq=n.seq:typeof n.seq=="object"&&(s.seq=new De.LongBits(n.seq.low>>>0,n.seq.high>>>0).toNumber(!0))),n.raw!=null&&(typeof n.raw=="string"?De.base64.decode(n.raw,s.raw=De.newBuffer(De.base64.length(n.raw)),0):n.raw.length&&(s.raw=n.raw)),s},e.toObject=function(n,s){s||(s={});var i={};if(s.defaults){if(De.Long){var o=new De.Long(0,0,!0);i.seq=s.longs===String?o.toString():s.longs===Number?o.toNumber():o}else i.seq=s.longs===String?"0":0;s.bytes===String?i.raw="":(i.raw=[],s.bytes!==Array&&(i.raw=De.newBuffer(i.raw)))}return n.seq!=null&&n.hasOwnProperty("seq")&&(typeof n.seq=="number"?i.seq=s.longs===String?String(n.seq):n.seq:i.seq=s.longs===String?De.Long.prototype.toString.call(n.seq):s.longs===Number?new De.LongBits(n.seq.low>>>0,n.seq.high>>>0).toNumber(!0):n.seq),n.raw!=null&&n.hasOwnProperty("raw")&&(i.raw=s.bytes===String?De.base64.encode(n.raw,0,n.raw.length):s.bytes===Array?Array.prototype.slice.call(n.raw):n.raw),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e}(),r})(),Zi=j.Reader,D2=j.Writer,ye=j.util,Xe=j.roots.default||(j.roots.default={}),s7=Xe.Peer=(()=>{function r(t){if(this.addresses=[],this.protocols=[],this.metadata=[],t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}r.prototype.addresses=ye.emptyArray,r.prototype.protocols=ye.emptyArray,r.prototype.metadata=ye.emptyArray,r.prototype.pubKey=null,r.prototype.peerRecordEnvelope=null;let e;return Object.defineProperty(r.prototype,"_pubKey",{get:ye.oneOfGetter(e=["pubKey"]),set:ye.oneOfSetter(e)}),Object.defineProperty(r.prototype,"_peerRecordEnvelope",{get:ye.oneOfGetter(e=["peerRecordEnvelope"]),set:ye.oneOfSetter(e)}),r.encode=function(n,s){if(s||(s=D2.create()),n.addresses!=null&&n.addresses.length)for(var i=0;i<n.addresses.length;++i)Xe.Address.encode(n.addresses[i],s.uint32(10).fork()).ldelim();if(n.protocols!=null&&n.protocols.length)for(var i=0;i<n.protocols.length;++i)s.uint32(18).string(n.protocols[i]);if(n.metadata!=null&&n.metadata.length)for(var i=0;i<n.metadata.length;++i)Xe.Metadata.encode(n.metadata[i],s.uint32(26).fork()).ldelim();return n.pubKey!=null&&Object.hasOwnProperty.call(n,"pubKey")&&s.uint32(34).bytes(n.pubKey),n.peerRecordEnvelope!=null&&Object.hasOwnProperty.call(n,"peerRecordEnvelope")&&s.uint32(42).bytes(n.peerRecordEnvelope),s},r.decode=function(n,s){n instanceof Zi||(n=Zi.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new Xe.Peer;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.addresses&&o.addresses.length||(o.addresses=[]),o.addresses.push(Xe.Address.decode(n,n.uint32()));break;case 2:o.protocols&&o.protocols.length||(o.protocols=[]),o.protocols.push(n.string());break;case 3:o.metadata&&o.metadata.length||(o.metadata=[]),o.metadata.push(Xe.Metadata.decode(n,n.uint32()));break;case 4:o.pubKey=n.bytes();break;case 5:o.peerRecordEnvelope=n.bytes();break;default:n.skipType(a&7);break}}return o},r.fromObject=function(n){if(n instanceof Xe.Peer)return n;var s=new Xe.Peer;if(n.addresses){if(!Array.isArray(n.addresses))throw TypeError(".Peer.addresses: array expected");s.addresses=[];for(var i=0;i<n.addresses.length;++i){if(typeof n.addresses[i]!="object")throw TypeError(".Peer.addresses: object expected");s.addresses[i]=Xe.Address.fromObject(n.addresses[i])}}if(n.protocols){if(!Array.isArray(n.protocols))throw TypeError(".Peer.protocols: array expected");s.protocols=[];for(var i=0;i<n.protocols.length;++i)s.protocols[i]=String(n.protocols[i])}if(n.metadata){if(!Array.isArray(n.metadata))throw TypeError(".Peer.metadata: array expected");s.metadata=[];for(var i=0;i<n.metadata.length;++i){if(typeof n.metadata[i]!="object")throw TypeError(".Peer.metadata: object expected");s.metadata[i]=Xe.Metadata.fromObject(n.metadata[i])}}return n.pubKey!=null&&(typeof n.pubKey=="string"?ye.base64.decode(n.pubKey,s.pubKey=ye.newBuffer(ye.base64.length(n.pubKey)),0):n.pubKey.length&&(s.pubKey=n.pubKey)),n.peerRecordEnvelope!=null&&(typeof n.peerRecordEnvelope=="string"?ye.base64.decode(n.peerRecordEnvelope,s.peerRecordEnvelope=ye.newBuffer(ye.base64.length(n.peerRecordEnvelope)),0):n.peerRecordEnvelope.length&&(s.peerRecordEnvelope=n.peerRecordEnvelope)),s},r.toObject=function(n,s){s||(s={});var i={};if((s.arrays||s.defaults)&&(i.addresses=[],i.protocols=[],i.metadata=[]),n.addresses&&n.addresses.length){i.addresses=[];for(var o=0;o<n.addresses.length;++o)i.addresses[o]=Xe.Address.toObject(n.addresses[o],s)}if(n.protocols&&n.protocols.length){i.protocols=[];for(var o=0;o<n.protocols.length;++o)i.protocols[o]=n.protocols[o]}if(n.metadata&&n.metadata.length){i.metadata=[];for(var o=0;o<n.metadata.length;++o)i.metadata[o]=Xe.Metadata.toObject(n.metadata[o],s)}return n.pubKey!=null&&n.hasOwnProperty("pubKey")&&(i.pubKey=s.bytes===String?ye.base64.encode(n.pubKey,0,n.pubKey.length):s.bytes===Array?Array.prototype.slice.call(n.pubKey):n.pubKey,s.oneofs&&(i._pubKey="pubKey")),n.peerRecordEnvelope!=null&&n.hasOwnProperty("peerRecordEnvelope")&&(i.peerRecordEnvelope=s.bytes===String?ye.base64.encode(n.peerRecordEnvelope,0,n.peerRecordEnvelope.length):s.bytes===Array?Array.prototype.slice.call(n.peerRecordEnvelope):n.peerRecordEnvelope,s.oneofs&&(i._peerRecordEnvelope="peerRecordEnvelope")),i},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();Xe.Address=(()=>{function r(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}r.prototype.multiaddr=ye.newBuffer([]),r.prototype.isCertified=null;let e;return Object.defineProperty(r.prototype,"_isCertified",{get:ye.oneOfGetter(e=["isCertified"]),set:ye.oneOfSetter(e)}),r.encode=function(n,s){return s||(s=D2.create()),n.multiaddr!=null&&Object.hasOwnProperty.call(n,"multiaddr")&&s.uint32(10).bytes(n.multiaddr),n.isCertified!=null&&Object.hasOwnProperty.call(n,"isCertified")&&s.uint32(16).bool(n.isCertified),s},r.decode=function(n,s){n instanceof Zi||(n=Zi.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new Xe.Address;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.multiaddr=n.bytes();break;case 2:o.isCertified=n.bool();break;default:n.skipType(a&7);break}}return o},r.fromObject=function(n){if(n instanceof Xe.Address)return n;var s=new Xe.Address;return n.multiaddr!=null&&(typeof n.multiaddr=="string"?ye.base64.decode(n.multiaddr,s.multiaddr=ye.newBuffer(ye.base64.length(n.multiaddr)),0):n.multiaddr.length&&(s.multiaddr=n.multiaddr)),n.isCertified!=null&&(s.isCertified=Boolean(n.isCertified)),s},r.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.multiaddr="":(i.multiaddr=[],s.bytes!==Array&&(i.multiaddr=ye.newBuffer(i.multiaddr)))),n.multiaddr!=null&&n.hasOwnProperty("multiaddr")&&(i.multiaddr=s.bytes===String?ye.base64.encode(n.multiaddr,0,n.multiaddr.length):s.bytes===Array?Array.prototype.slice.call(n.multiaddr):n.multiaddr),n.isCertified!=null&&n.hasOwnProperty("isCertified")&&(i.isCertified=n.isCertified,s.oneofs&&(i._isCertified="isCertified")),i},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();Xe.Metadata=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.key="",r.prototype.value=ye.newBuffer([]),r.encode=function(t,n){return n||(n=D2.create()),t.key!=null&&Object.hasOwnProperty.call(t,"key")&&n.uint32(10).string(t.key),t.value!=null&&Object.hasOwnProperty.call(t,"value")&&n.uint32(18).bytes(t.value),n},r.decode=function(t,n){t instanceof Zi||(t=Zi.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Xe.Metadata;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.key=t.string();break;case 2:i.value=t.bytes();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof Xe.Metadata)return t;var n=new Xe.Metadata;return t.key!=null&&(n.key=String(t.key)),t.value!=null&&(typeof t.value=="string"?ye.base64.decode(t.value,n.value=ye.newBuffer(ye.base64.length(t.value)),0):t.value.length&&(n.value=t.value)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(s.key="",n.bytes===String?s.value="":(s.value=[],n.bytes!==Array&&(s.value=ye.newBuffer(s.value)))),t.key!=null&&t.hasOwnProperty("key")&&(s.key=t.key),t.value!=null&&t.hasOwnProperty("value")&&(s.value=n.bytes===String?ye.base64.encode(t.value,0,t.value.length):n.bytes===Array?Array.prototype.slice.call(t.value):t.value),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})();const Ay=j.Reader,yF=j.Writer,Pe=j.util,$c=j.roots.default||(j.roots.default={}),wF=$c.Envelope=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.publicKey=Pe.newBuffer([]),r.prototype.payloadType=Pe.newBuffer([]),r.prototype.payload=Pe.newBuffer([]),r.prototype.signature=Pe.newBuffer([]),r.encode=function(t,n){return n||(n=yF.create()),t.publicKey!=null&&Object.hasOwnProperty.call(t,"publicKey")&&n.uint32(10).bytes(t.publicKey),t.payloadType!=null&&Object.hasOwnProperty.call(t,"payloadType")&&n.uint32(18).bytes(t.payloadType),t.payload!=null&&Object.hasOwnProperty.call(t,"payload")&&n.uint32(26).bytes(t.payload),t.signature!=null&&Object.hasOwnProperty.call(t,"signature")&&n.uint32(42).bytes(t.signature),n},r.decode=function(t,n){t instanceof Ay||(t=Ay.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new $c.Envelope;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.publicKey=t.bytes();break;case 2:i.payloadType=t.bytes();break;case 3:i.payload=t.bytes();break;case 5:i.signature=t.bytes();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof $c.Envelope)return t;var n=new $c.Envelope;return t.publicKey!=null&&(typeof t.publicKey=="string"?Pe.base64.decode(t.publicKey,n.publicKey=Pe.newBuffer(Pe.base64.length(t.publicKey)),0):t.publicKey.length&&(n.publicKey=t.publicKey)),t.payloadType!=null&&(typeof t.payloadType=="string"?Pe.base64.decode(t.payloadType,n.payloadType=Pe.newBuffer(Pe.base64.length(t.payloadType)),0):t.payloadType.length&&(n.payloadType=t.payloadType)),t.payload!=null&&(typeof t.payload=="string"?Pe.base64.decode(t.payload,n.payload=Pe.newBuffer(Pe.base64.length(t.payload)),0):t.payload.length&&(n.payload=t.payload)),t.signature!=null&&(typeof t.signature=="string"?Pe.base64.decode(t.signature,n.signature=Pe.newBuffer(Pe.base64.length(t.signature)),0):t.signature.length&&(n.signature=t.signature)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(n.bytes===String?s.publicKey="":(s.publicKey=[],n.bytes!==Array&&(s.publicKey=Pe.newBuffer(s.publicKey))),n.bytes===String?s.payloadType="":(s.payloadType=[],n.bytes!==Array&&(s.payloadType=Pe.newBuffer(s.payloadType))),n.bytes===String?s.payload="":(s.payload=[],n.bytes!==Array&&(s.payload=Pe.newBuffer(s.payload))),n.bytes===String?s.signature="":(s.signature=[],n.bytes!==Array&&(s.signature=Pe.newBuffer(s.signature)))),t.publicKey!=null&&t.hasOwnProperty("publicKey")&&(s.publicKey=n.bytes===String?Pe.base64.encode(t.publicKey,0,t.publicKey.length):n.bytes===Array?Array.prototype.slice.call(t.publicKey):t.publicKey),t.payloadType!=null&&t.hasOwnProperty("payloadType")&&(s.payloadType=n.bytes===String?Pe.base64.encode(t.payloadType,0,t.payloadType.length):n.bytes===Array?Array.prototype.slice.call(t.payloadType):t.payloadType),t.payload!=null&&t.hasOwnProperty("payload")&&(s.payload=n.bytes===String?Pe.base64.encode(t.payload,0,t.payload.length):n.bytes===Array?Array.prototype.slice.call(t.payload):t.payload),t.signature!=null&&t.hasOwnProperty("signature")&&(s.signature=n.bytes===String?Pe.base64.encode(t.signature,0,t.signature.length):n.bytes===Array?Array.prototype.slice.call(t.signature):t.signature),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r})(),Lc=j.Reader,Cy=j.Writer,Me=j.util,yr=j.roots.default||(j.roots.default={}),mF=yr.PeerRecord=(()=>{function r(e){if(this.addresses=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.peerId=Me.newBuffer([]),r.prototype.seq=Me.Long?Me.Long.fromBits(0,0,!0):0,r.prototype.addresses=Me.emptyArray,r.encode=function(t,n){if(n||(n=Cy.create()),t.peerId!=null&&Object.hasOwnProperty.call(t,"peerId")&&n.uint32(10).bytes(t.peerId),t.seq!=null&&Object.hasOwnProperty.call(t,"seq")&&n.uint32(16).uint64(t.seq),t.addresses!=null&&t.addresses.length)for(var s=0;s<t.addresses.length;++s)yr.PeerRecord.AddressInfo.encode(t.addresses[s],n.uint32(26).fork()).ldelim();return n},r.decode=function(t,n){t instanceof Lc||(t=Lc.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new yr.PeerRecord;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.peerId=t.bytes();break;case 2:i.seq=t.uint64();break;case 3:i.addresses&&i.addresses.length||(i.addresses=[]),i.addresses.push(yr.PeerRecord.AddressInfo.decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof yr.PeerRecord)return t;var n=new yr.PeerRecord;if(t.peerId!=null&&(typeof t.peerId=="string"?Me.base64.decode(t.peerId,n.peerId=Me.newBuffer(Me.base64.length(t.peerId)),0):t.peerId.length&&(n.peerId=t.peerId)),t.seq!=null&&(Me.Long?(n.seq=Me.Long.fromValue(t.seq)).unsigned=!0:typeof t.seq=="string"?n.seq=parseInt(t.seq,10):typeof t.seq=="number"?n.seq=t.seq:typeof t.seq=="object"&&(n.seq=new Me.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0))),t.addresses){if(!Array.isArray(t.addresses))throw TypeError(".PeerRecord.addresses: array expected");n.addresses=[];for(var s=0;s<t.addresses.length;++s){if(typeof t.addresses[s]!="object")throw TypeError(".PeerRecord.addresses: object expected");n.addresses[s]=yr.PeerRecord.AddressInfo.fromObject(t.addresses[s])}}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.addresses=[]),n.defaults)if(n.bytes===String?s.peerId="":(s.peerId=[],n.bytes!==Array&&(s.peerId=Me.newBuffer(s.peerId))),Me.Long){var i=new Me.Long(0,0,!0);s.seq=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.seq=n.longs===String?"0":0;if(t.peerId!=null&&t.hasOwnProperty("peerId")&&(s.peerId=n.bytes===String?Me.base64.encode(t.peerId,0,t.peerId.length):n.bytes===Array?Array.prototype.slice.call(t.peerId):t.peerId),t.seq!=null&&t.hasOwnProperty("seq")&&(typeof t.seq=="number"?s.seq=n.longs===String?String(t.seq):t.seq:s.seq=n.longs===String?Me.Long.prototype.toString.call(t.seq):n.longs===Number?new Me.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0):t.seq),t.addresses&&t.addresses.length){s.addresses=[];for(var o=0;o<t.addresses.length;++o)s.addresses[o]=yr.PeerRecord.AddressInfo.toObject(t.addresses[o],n)}return s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.AddressInfo=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.multiaddr=Me.newBuffer([]),e.encode=function(n,s){return s||(s=Cy.create()),n.multiaddr!=null&&Object.hasOwnProperty.call(n,"multiaddr")&&s.uint32(10).bytes(n.multiaddr),s},e.decode=function(n,s){n instanceof Lc||(n=Lc.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new yr.PeerRecord.AddressInfo;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.multiaddr=n.bytes();break;default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof yr.PeerRecord.AddressInfo)return n;var s=new yr.PeerRecord.AddressInfo;return n.multiaddr!=null&&(typeof n.multiaddr=="string"?Me.base64.decode(n.multiaddr,s.multiaddr=Me.newBuffer(Me.base64.length(n.multiaddr)),0):n.multiaddr.length&&(s.multiaddr=n.multiaddr)),s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.multiaddr="":(i.multiaddr=[],s.bytes!==Array&&(i.multiaddr=Me.newBuffer(i.multiaddr)))),n.multiaddr!=null&&n.hasOwnProperty("multiaddr")&&(i.multiaddr=s.bytes===String?Me.base64.encode(n.multiaddr,0,n.multiaddr.length):s.bytes===Array?Array.prototype.slice.call(n.multiaddr):n.multiaddr),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e}(),r})();j.util.Long=void 0;j.configure();async function bF(r,e=()=>{}){e(0,"Storing each peerstore key under a single datastore key"),await r.datastore.open();const t={},n=[];for await(const{key:s,value:i}of r.datastore.query({prefix:"/peers"})){n.push(s);const o=s.toString(),[,a,c,u,l]=o.split("/");if(a==="peers"&&["protos","addrs","metadata","keys"].includes(c)&&u)if(t[u]=t[u]||{addresses:[],protocols:[],metadata:[]},c==="protos"){const d=r7.decode(i);t[u].protocols=d.protocols.sort()}else if(c==="addrs"){const d=n7.decode(i);t[u].addresses=d.addrs.sort((f,g)=>X(f.multiaddr).toString().localeCompare(X(g.multiaddr).toString())),d.certifiedRecord&&d.certifiedRecord.raw&&(t[u].peerRecordEnvelope=d.certifiedRecord.raw)}else c==="metadata"?t[u].metadata.push({key:l,value:i}):c==="keys"&&(t[u].pubKey=i)}e(33,"Read peer data from store");for(const s of n)await r.datastore.delete(s);e(66,"Removed existing peer data from store");for(const s of Object.keys(t)){const i=t[s];i.metadata=i.metadata.sort((a,c)=>a.key.localeCompare(c.key));const o=s7.encode(i).finish();await r.datastore.put(new J(`/peers/${s}`),o)}await r.datastore.close(),e(100,"Stored each peerstore key under a single datastore key")}async function EF(r,e=()=>{}){e(0,"Storing each peerstore key under a multiple datastore keys"),await r.datastore.open();const t={},n=[];for await(const{key:s,value:i}of r.datastore.query({prefix:"/peers"})){n.push(s);const o=s.toString(),[,,a]=o.split("/");t[a]=s7.decode(i)}e(33,"Read peer data from store");for(const s of n)await r.datastore.delete(s);e(66,"Removed existing peer data from store");for(const[s,i]of Object.entries(t)){if(i.protocols&&i.protocols.length>0&&await r.datastore.put(new J(`/peers/protos/${s}`),r7.encode({protocols:i.protocols}).finish()),i.addresses&&i.addresses.length>0){const o=i.peerRecordEnvelope;let a;if(o){const c=wF.decode(o),u=mF.decode(c.payload);a={raw:o,seq:u.seq}}await r.datastore.put(new J(`/peers/addrs/${s}`),n7.encode({addrs:i.addresses,certifiedRecord:a}).finish())}if(i.metadata&&i.metadata.length>0)for(const{key:o,value:a}of i.metadata)await r.datastore.put(new J(`/peers/metadata/${s}/${o}`),a);i.pubKey&&await r.datastore.put(new J(`/peers/keys/${s}`),i.pubKey)}await r.datastore.close(),e(100,"Stored each peerstore key under multiple datastore keys")}const _F={version:12,description:"Store each peerstore peer under a single datastore key",migrate:bF,revert:EF},Ms={description:"Empty migration.",migrate:()=>{},revert:()=>{},empty:!0},P2=[Object.assign({version:1},Ms),Object.assign({version:2},Ms),Object.assign({version:3},Ms),Object.assign({version:4},Ms),Object.assign({version:5},Ms),Object.assign({version:6},Ms),Object.assign({version:7},Ms),Hz,sF,uF,fF,_F];class Id extends Error{constructor(e){super(e),this.name="NonReversibleMigrationError",this.code=Id.code,this.message=e}}Id.code="ERR_NON_REVERSIBLE_MIGRATION";class sc extends Error{constructor(e){super(e),this.name="NotInitializedRepoError",this.code=sc.code,this.message=e}}sc.code="ERR_NOT_INITIALIZED_REPO";class Ad extends Error{constructor(e){super(e),this.name="RequiredParameterError",this.code=Ad.code,this.message=e}}Ad.code="ERR_REQUIRED_PARAMETER";class Cd extends Error{constructor(e){super(e),this.name="InvalidValueError",this.code=Cd.code,this.message=e}}Cd.code="ERR_INVALID_VALUE";class go extends Error{constructor(e){super(e),this.name="MissingRepoOptionsError",this.code=go.code,this.message=e}}go.code="ERR_MISSING_REPO_OPTIONS";const vF=Object.freeze(Object.defineProperty({__proto__:null,InvalidValueError:Cd,MissingRepoOptionsError:go,NonReversibleMigrationError:Id,NotInitializedRepoError:sc,RequiredParameterError:Ad},Symbol.toStringTag,{value:"Module"})),_h=Xt("ipfs:repo:migrator:repo:init");async function SF(r){if(!r)throw new go("Please pass repo options when trying to open a repo");const e=r.root;try{await e.open();const t=await e.has(T2),n=await e.has(iF);return!t||!n?(_h(`Version entry present: ${t}`),_h(`Config entry present: ${n}`),!1):!0}catch(t){return _h("While checking if repo is initialized error was thrown: "+t.message),!1}finally{if(e!==void 0)try{await e.close()}catch{}}}async function i7(r){if(!await SF(r))throw new sc("Repo is not initialized!");const e=r.root;await e.open();try{return parseInt(q(await e.get(T2)))}finally{await e.close()}}async function yu(r,e){if(!e)throw new go("Please pass repo options when trying to open a repo");const t=e.root;await t.open(),await t.put(T2,M(String(r))),await t.close()}const Ar=Xt("ipfs:repo:migrator");function RF(r){return r=r||P2,!Array.isArray(r)||r.length===0?0:r[r.length-1].version}async function IF(r,e,t,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??P2;if(!r)throw new cr.RequiredParameterError("Path argument is required!");if(!t)throw new cr.RequiredParameterError("repoOptions argument is required!");if(!n)throw new cr.RequiredParameterError("toVersion argument is required!");if(!Number.isInteger(n)||n<=0)throw new cr.InvalidValueError("Version has to be positive integer!");e=Zm(e);const u=await i7(e);if(u===n){Ar("Nothing to migrate.");return}if(u>n)throw new cr.InvalidValueError(`Current repo's version (${u}) is higher then toVersion (${n}), you probably wanted to revert it?`);o7(c,u,n);let l;!a&&!i&&(l=await t.repoLock.lock(r));try{for(const d of c){if(n!==void 0&&d.version>n)break;if(!(d.version<=u)){Ar(`Migrating version ${d.version}`);try{if(!a){let f=()=>{};o&&(f=(g,h)=>o(d.version,g.toFixed(2),h)),await d.migrate(e,f)}}catch(f){const g=d.version-1;throw Ar(`An exception was raised during execution of migration. Setting the repo's version to last successfully migrated version: ${g}`),await yu(g,e),new Error(`During migration to version ${d.version} exception was raised: ${f.stack||f.message||f}`)}Ar(`Migrating to version ${d.version} finished`)}}a||await yu(n||RF(c),e),Ar("Repo successfully migrated",n!==void 0?`to version ${n}!`:"to latest version!")}finally{!a&&!i&&l&&await l.close()}}async function AF(r,e,t,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??P2;if(!r)throw new cr.RequiredParameterError("Path argument is required!");if(!t)throw new cr.RequiredParameterError("repoOptions argument is required!");if(!n)throw new cr.RequiredParameterError("When reverting migrations, you have to specify to which version to revert!");if(!Number.isInteger(n)||n<=0)throw new cr.InvalidValueError("Version has to be positive integer!");e=Zm(e);const u=await i7(e);if(u===n){Ar("Nothing to revert.");return}if(u<n)throw new cr.InvalidValueError(`Current repo's version (${u}) is lower then toVersion (${n}), you probably wanted to migrate it?`);o7(c,n,u,!0);let l;!a&&!i&&(l=await t.repoLock.lock(r)),Ar(`Reverting from version ${u} to ${n}`);try{const d=c.slice().reverse();for(const f of d){if(f.version<=n)break;if(!(f.version>u)){Ar(`Reverting migration version ${f.version}`);try{if(!a){let g=()=>{};o&&(g=(h,p)=>o(f.version,h.toFixed(2),p)),await f.revert(e,g)}}catch(g){const h=f.version;throw Ar(`An exception was raised during execution of migration. Setting the repo's version to last successfully reverted version: ${h}`),await yu(h,e),g.message=`During reversion to version ${f.version} exception was raised: ${g.message}`,g}Ar(`Reverting to version ${f.version} finished`)}}a||await yu(n,e),Ar(`All migrations successfully reverted to version ${n}!`)}finally{!a&&!i&&l&&await l.close()}}function o7(r,e,t,n=!1){let s=0;for(const i of r){if(i.version>t)break;if(i.version>e){if(n&&!i.revert)throw new cr.NonReversibleMigrationError(`It is not possible to revert to version ${e} because migration version ${i.version} is not reversible. Cancelling reversion.`);s++}}if(s!==t-e)throw new cr.InvalidValueError(`The ipfs-repo-migrations package does not have all migration to migrate from version ${e} to ${t}`)}const cr=vF;var za={},CF={get exports(){return za},set exports(r){za=r}};/*!
 * bytes
 * Copyright(c) 2012-2014 TJ Holowaychuk
 * Copyright(c) 2015 Jed Watson
 * MIT Licensed
 */CF.exports=kF;za.format=a7;za.parse=c7;var TF=/\B(?=(\d{3})+(?!\d))/g,DF=/(?:\.0*|(\.[^0]+)0+)$/,Qn={b:1,kb:1<<10,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)},PF=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i;function kF(r,e){return typeof r=="string"?c7(r):typeof r=="number"?a7(r,e):null}function a7(r,e){if(!Number.isFinite(r))return null;var t=Math.abs(r),n=e&&e.thousandsSeparator||"",s=e&&e.unitSeparator||"",i=e&&e.decimalPlaces!==void 0?e.decimalPlaces:2,o=Boolean(e&&e.fixedDecimals),a=e&&e.unit||"";(!a||!Qn[a.toLowerCase()])&&(t>=Qn.pb?a="PB":t>=Qn.tb?a="TB":t>=Qn.gb?a="GB":t>=Qn.mb?a="MB":t>=Qn.kb?a="KB":a="B");var c=r/Qn[a.toLowerCase()],u=c.toFixed(i);return o||(u=u.replace(DF,"$1")),n&&(u=u.split(".").map(function(l,d){return d===0?l.replace(TF,n):l}).join(".")),u+s+a}function c7(r){if(typeof r=="number"&&!isNaN(r))return r;if(typeof r!="string")return null;var e=PF.exec(r),t,n="b";return e?(t=parseFloat(e[1]),n=e[4].toLowerCase()):(t=parseInt(r,10),n="b"),isNaN(t)?null:Math.floor(Qn[n]*t)}class Td extends Error{constructor(e){super(e),this.name="LockExistsError",this.code=Td.code}}Td.code="ERR_LOCK_EXISTS";class Ns extends Error{constructor(e){super(e),this.name="NotFoundError",this.code=Ns.code}}Ns.code="ERR_NOT_FOUND";class Dd extends Error{constructor(e){super(e),this.name="InvalidRepoVersionError",this.code=Dd.code}}Dd.code="ERR_INVALID_REPO_VERSION";const ia="ERR_REPO_NOT_INITIALIZED",OF="ERR_REPO_ALREADY_OPEN",NF="ERR_REPO_ALREADY_CLOSED";async function l7(r,e,t){const n=await e(r);if(n)return n;const s=d7(t);return s?new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{i(Boolean(a.result))}}):!1}async function u7(r,e,t,n){if(await t(r))return e(r);const s=d7(n);if(!s)throw new Ns;return new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{if(a.result)return i(a.result);o(new Ns)}})}function d7(r){let e=r;for(;e.db||e.child;)if(e=e.db||e.child,e.type==="level-js"||e.constructor.name==="Level")return e}const xF=Xt("ipfs:repo:version"),vh=new J("version");function $F(r){return{async exists(){return l7(vh,r.has.bind(r),r)},async get(){const e=await u7(vh,r.get.bind(r),r.has.bind(r),r);return parseInt(q(e),10)},set(e){return r.put(vh,M(String(e)))},async check(e){const t=await this.get();return xF("comparing version: %s and %s",t,e),t===e||(t===6&&e===7||e===6&&t===7)}}}const LF=lt.default?lt.default:lt,Sh=new J("config");function MF(r){const e=new LF({concurrency:1}),t={async getAll(i={}){const o=await u7(Sh,r.get.bind(r),r.has.bind(r),r);return JSON.parse(q(o))},async get(i,o={}){if(i==null)throw new Ns(`Key ${i} does not exist in config`);const a=await this.getAll(o),c=S2(a,i);if(c===void 0)throw new Ns(`Key ${i} does not exist in config`);return c},set(i,o,a={}){if(typeof i!="string"&&!(i instanceof String))throw E(new Error("Invalid key type: "+typeof i),"ERR_INVALID_KEY");if(o===void 0||o instanceof Uint8Array)throw E(new Error("Invalid value type: "+typeof o),"ERR_INVALID_VALUE");return e.add(()=>n({key:i,value:o},a.signal))},replace(i,o={}){if(!i||i instanceof Uint8Array)throw E(new Error("Invalid value type: "+typeof i),"ERR_INVALID_VALUE");return e.add(()=>n({key:void 0,value:i},o.signal))},async exists(){return l7(Sh,r.has.bind(r),r)}};return t;async function n(i,o){if(o&&o.aborted)return;const a=i.key,c=i.value;if(a){const u=await t.getAll();return typeof u=="object"&&u!==null&&Ue(u,a,c),s(u)}return s(c)}function s(i){const o=M(JSON.stringify(i,null,2));return r.put(Sh,o)}}function Rh(r){if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}function UF(r,e={}){if(!Rh(r)&&!Array.isArray(r))throw new TypeError("Expected a plain object or array");const{deep:t,compare:n}=e,s=[],i=[],o=c=>{const u=s.indexOf(c);if(u!==-1)return i[u];const l=[];return s.push(c),i.push(l),l.push(...c.map(d=>Array.isArray(d)?o(d):Rh(d)?a(d):d)),l},a=c=>{const u=s.indexOf(c);if(u!==-1)return i[u];const l={},d=Object.keys(c).sort(n);s.push(c),i.push(l);for(const f of d){const g=c[f];let h;t&&Array.isArray(g)?h=o(g):h=t&&Rh(g)?a(g):g,Object.defineProperty(l,f,{...Object.getOwnPropertyDescriptor(c,f),value:h})}return l};return Array.isArray(r)?t?o(r):r.slice():a(r)}const Ih=new J("datastore_spec");function BF(r){return{exists(){return r.has(Ih)},async get(){const e=await r.get(Ih);return JSON.parse(q(e))},async set(e){return r.put(Ih,M(JSON.stringify(UF(e,{deep:!0}))))}}}const Ah=new J("api");function zF(r){return{async get(){const e=await r.get(Ah);return e&&e.toString()},set(e){return r.put(Ah,M(e.toString()))},delete(){return r.delete(Ah)}}}var FF=h7,Ty=128,VF=127,jF=~VF,KF=Math.pow(2,31);function h7(r,e,t){e=e||[],t=t||0;for(var n=t;r>=KF;)e[t++]=r&255|Ty,r/=128;for(;r&jF;)e[t++]=r&255|Ty,r>>>=7;return e[t]=r|0,h7.bytes=t-n+1,e}var qF=P1,HF=128,Dy=127;function P1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw P1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Dy)<<s:(o&Dy)*Math.pow(2,s),s+=7}while(o>=HF);return P1.bytes=i-n,t}var GF=Math.pow(2,7),WF=Math.pow(2,14),YF=Math.pow(2,21),QF=Math.pow(2,28),JF=Math.pow(2,35),XF=Math.pow(2,42),ZF=Math.pow(2,49),eV=Math.pow(2,56),tV=Math.pow(2,63),rV=function(r){return r<GF?1:r<WF?2:r<YF?3:r<QF?4:r<JF?5:r<XF?6:r<ZF?7:r<eV?8:r<tV?9:10},nV={encode:FF,decode:qF,encodingLength:rV},wu=nV;const k1=(r,e=0)=>[wu.decode(r,e),wu.decode.bytes],mu=(r,e,t=0)=>(wu.encode(r,e,t),e),bu=r=>wu.encodingLength(r),sV=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Pd=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},f7=(r,e)=>{const t=e.byteLength,n=bu(r),s=n+bu(t),i=new Uint8Array(s+t);return mu(r,i,0),mu(t,i,n),i.set(e,s),new k2(r,t,e,i)},p7=r=>{const e=Pd(r),[t,n]=k1(e),[s,i]=k1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new k2(t,s,o,e)},iV=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&sV(r.bytes,t.bytes)}};let k2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function oV(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var aV=oV,cV=aV;let lV=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},uV=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return g7(this,e)}},dV=class{constructor(e){this.decoders=e}or(e){return g7(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const g7=(r,e)=>new dV({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let hV=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new lV(e,t,n),this.decoder=new uV(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const y7=({name:r,prefix:e,encode:t,decode:n})=>new hV(r,e,t,n),w7=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=cV(t,e);return y7({prefix:r,name:e,encode:n,decode:i=>Pd(s(i))})},fV=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},pV=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Ln=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>y7({prefix:e,name:r,encode(s){return pV(s,n,t)},decode(s){return fV(s,n,t,r)}}),as=w7({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});w7({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const As=Ln({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Ln({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Ln({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Ln({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Ln({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Ln({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Ln({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Ln({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Ln({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const gV=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return wV(t,O1(r),e||as.encoder);default:return mV(t,O1(r),e||As.encoder)}},Py=new WeakMap,O1=r=>{const e=Py.get(r);if(e==null){const t=new Map;return Py.set(r,t),t}return e};let Ae=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Bo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==bV)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ae.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=f7(e,t);return Ae.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ae.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&iV(e.multihash,n.multihash)}toString(e){return gV(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ae)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Ae(n,s,i,o||ky(n,s,i.bytes))}else if(t[EV]===!0){const{version:n,multihash:s,code:i}=t,o=p7(s);return Ae.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Bo)throw new Error(`Version 0 CID must use dag-pb (code: ${Bo}) block encoding`);return new Ae(e,t,n,n.bytes)}case 1:{const s=ky(e,t,n.bytes);return new Ae(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Ae.create(0,Bo,e)}static createV1(e,t){return Ae.create(1,e,t)}static decode(e){const[t,n]=Ae.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ae.inspectBytes(e),n=t.size-t.multihashSize,s=Pd(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new k2(t.multihashCode,t.digestSize,i,s);return[t.version===0?Ae.createV0(o):Ae.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=k1(e.subarray(t));return t+=f,d};let s=n(),i=Bo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=yV(e,t),i=Ae.decode(s);return O1(i).set(n,e),i}};const yV=(r,e)=>{switch(r[0]){case"Q":{const t=e||as;return[as.prefix,t.decode(`${as.prefix}${r}`)]}case as.prefix:{const t=e||as;return[as.prefix,t.decode(r)]}case As.prefix:{const t=e||As;return[As.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},wV=(r,e,t)=>{const{prefix:n}=t;if(n!==as.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},mV=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Bo=112,bV=18,ky=(r,e,t)=>{const n=bu(r),s=n+bu(e),i=new Uint8Array(s+t.byteLength);return mu(r,i,0),mu(e,i,n),i.set(t,s),i},EV=Symbol.for("@ipld/js-cid/CID"),m7=0,_V="identity",b7=Pd,vV=r=>f7(m7,b7(r)),SV={code:m7,name:_V,encode:b7,digest:vV};function RV(r){return{open(){return r.open()},close(){return r.close()},query(e,t){return r.query(e,t)},queryKeys(e,t){return r.queryKeys(e,t)},async get(e,t){const n=Hn(e);return n.isIdentity?Promise.resolve(n.digest):r.get(e,t)},async*getMany(e,t){for await(const n of e)yield this.get(n,t)},async put(e,t,n){const{isIdentity:s}=Hn(e);s||await r.put(e,t,n)},async*putMany(e,t){const n=dr({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)(async()=>{try{await Et(r.putMany(async function*(){for await(const{key:i,value:o}of e)Hn(i).isIdentity||(yield{key:i,value:o}),n.push({key:i,value:o})}())),n.end()}catch(i){n.end(i)}}),yield*n},has(e,t){const{isIdentity:n}=Hn(e);return n?Promise.resolve(!0):r.has(e,t)},delete(e,t){const{isIdentity:n}=Hn(e);return n?Promise.resolve():r.delete(e,t)},deleteMany(e,t){return r.deleteMany(Ze(e,n=>!Hn(n).isIdentity),t)},batch(){const e=r.batch();return{put(t,n){const{isIdentity:s}=Hn(t);s||e.put(t,n)},delete(t){const{isIdentity:n}=Hn(t);n||e.delete(t)},commit:t=>e.commit(t)}}}}function Hn(r){const e=Ae.asCID(r);if(e==null)throw E(new Error("Not a valid cid"),"ERR_INVALID_CID");return e.multihash.code!==SV.code?{isIdentity:!1}:{isIdentity:!0,digest:e.multihash.digest}}const E7=Xt("ipfs:repo:lock:memory"),_7="repo.lock",oa={};async function IV(r){const e=r+"/"+_7;if(E7("locking %s",e),oa[e]===!0)throw new Td(`Lock already being held for file: ${e}`);return oa[e]=!0,{async close(){oa[e]&&delete oa[e]}}}async function AV(r){const e=r+"/"+_7;return E7(`checking lock: ${e}`),Boolean(oa[e])}const v7={lock:IV,locked:AV},CV={autoMigrate:!0,onMigrationProgress:()=>{},repoOwner:!0,repoLock:v7},S7={Spec:{type:"mount",mounts:[{mountpoint:"/blocks",type:"measure",prefix:"flatfs.datastore",child:{type:"flatfs",path:"blocks",sync:!0,shardFunc:"/repo/flatfs/shard/v1/next-to-last/2"}},{mountpoint:"/",type:"measure",prefix:"leveldb.datastore",child:{type:"levelds",path:"datastore",compression:"none"}}]}};function Mc({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*TV(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=Ae.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*N1(n,s))}else{const t=Ae.asCID(e);t?yield[r.join("/"),t]:yield*N1(e,r)}}function*N1(r,e){if(!(r==null||r instanceof Uint8Array))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield*TV(s,n)}}function*DV(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!Ae.asCID(n)&&(yield*x1(n,s))}else yield*x1(e,r)}function*x1(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!Ae.asCID(n)&&(yield*DV(s,n))}}function PV(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=Ae.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}class kV{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:Mc(),bytes:Mc(),value:Mc(),asBlock:Mc()})}links(){return N1(this.value,[])}tree(){return x1(this.value,[])}get(e="/"){return PV(this.value,e.split("/").filter(Boolean))}}function R7({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n&&n.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new kV({cid:e,bytes:r,value:s})}function Uc(r){const e=Ae.asCID(r);if(e==null)throw E(new Error("Not a valid cid"),"ERR_INVALID_CID");const t=As.encode(e.multihash.bytes);return new J("/"+t.slice(1).toUpperCase(),!1)}function Oy(r){return p7(As.decode(`b${r.toString().toLowerCase().substring(1)}`))}const OV=Xt("ipfs:repo:utils:walk-dag");async function*Eu(r,e,t,n){try{const s=await e.get(r,n),i=await t(r.code),o=R7({bytes:s,cid:r,codec:i});for(const[,a]of o.links())yield a,yield*Eu(a,e,t,n)}catch(s){throw OV("Could not walk DAG for CID",r.toString(),s),s}}class NV extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,n]of e)this.onEviction(t,n.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const n=t.get(e);return this._getItemValue(e,n)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield e)}for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:n=this.maxAge}={}){const s=typeof n=="number"&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;this.cache.has(e)?this.cache.set(e,{value:t,expiry:s}):this._set(e,{value:t,expiry:s})}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],n=t.length-e;n<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(n>0&&this._emitEvictions(t.slice(0,n)),this.oldCache=new Map(t.slice(n)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,i]=n;this._deleteIfExpired(s,i)===!1&&(yield[s,i.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,i]=n;this.cache.has(s)||this._deleteIfExpired(s,i)===!1&&(yield[s,i.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[n,s]of this.entriesAscending())e.call(t,s,n,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}const xV=2048;function $V(r){const e=`Invalid type '${r}', must be one of {direct, indirect, recursive, all}`;return E(new Error(e),"ERR_INVALID_PIN_TYPE")}class LV{constructor({pinstore:e,blockstore:t,loadCodec:n}){this.pinstore=e,this.blockstore=t,this.loadCodec=n,this.log=Xt("ipfs:repo:pin"),this.directPins=new Set,this.recursivePins=new Set}async pinDirectly(e,t={}){await this.blockstore.get(e,t);const n={depth:0};return e.version!==0&&(n.version=e.version),e.code!==Ne&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),this.pinstore.put(Uc(e),Xs(n))}unpin(e,t){return this.pinstore.delete(Uc(e),t)}async pinRecursively(e,t={}){await this.fetchCompleteDag(e,t);const n={depth:1/0};e.version!==0&&(n.version=e.version),e.code!==Ne&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),await this.pinstore.put(Uc(e),Xs(n))}async*directKeys(e){for await(const t of this.pinstore.query({filters:[n=>Ir(n.value).depth===0]})){const n=Ir(t.value),s=n.version||0,i=n.codec!=null?n.codec:Ne,o=Oy(t.key);yield{cid:Ae.create(s,i,o),metadata:n.metadata}}}async*recursiveKeys(e){for await(const t of this.pinstore.query({filters:[n=>Ir(n.value).depth===1/0]})){const n=Ir(t.value),s=n.version||0,i=n.codec!=null?n.codec:Ne,o=Oy(t.key);yield{cid:Ae.create(s,i,o),metadata:n.metadata}}}async*indirectKeys(e){for await(const{cid:t}of this.recursiveKeys())for await(const n of Eu(t,this.blockstore,this.loadCodec,e)){const s=[fe.recursive];(await this.isPinnedWithType(n,s)).pinned||(yield n)}}async isPinnedWithType(e,t,n){Array.isArray(t)||(t=[t]);const s=t.includes(fe.all),i=t.includes(fe.direct),o=t.includes(fe.recursive),a=t.includes(fe.indirect);if(o||i||s){const l=await fr(this.pinstore.query({prefix:Uc(e).toString(),filters:[d=>{if(s)return!0;const f=Ir(d.value);return t.includes(f.depth===0?fe.direct:fe.recursive)}],limit:1}));if(l){const d=Ir(l.value);return{cid:e,pinned:!0,reason:d.depth===0?fe.direct:fe.recursive,metadata:d.metadata}}}const c=this;async function*u(l,d){for await(const{cid:f}of d)for await(const g of Eu(f,c.blockstore,c.loadCodec))if(g.equals(l)){yield f;return}}if(s||a){const l=await fr(u(e,this.recursiveKeys()));if(l)return{cid:e,pinned:!0,reason:fe.indirect,parent:l}}return{cid:e,pinned:!1}}async fetchCompleteDag(e,t={}){const n=new NV({maxSize:t.cidCacheMaxSize??xV}),s=async(i,o)=>{if(n.has(i.toString()))return;n.set(i.toString(),!0);const a=await this.blockstore.get(i,o),c=await this.loadCodec(i.code),u=R7({bytes:a,cid:i,codec:c});await Promise.all([...u.links()].map(([,l])=>s(l,o)))};await s(e,t)}static checkPinType(e){if(typeof e!="string"||!Object.keys(fe).includes(e))throw $V(e);return!0}}function MV(r,e){return{open(){return e.open()},close(){return e.close()},query(t,n){return e.query(t,n)},queryKeys(t,n){return e.queryKeys(t,n)},async get(t,n){return e.get(t,n)},async*getMany(t,n){yield*e.getMany(t,n)},async put(t,n,s){await e.put(t,n,s)},async*putMany(t,n){yield*e.putMany(t,n)},has(t,n){return e.has(t,n)},async delete(t,n){return await Ny(t,r),e.delete(t,n)},deleteMany(t,n){return e.deleteMany(_t(t,async s=>(await Ny(s,r),s)),n)},batch(){return e.batch()}}}async function Ny(r,e){const{pinned:t,reason:n}=await e.isPinnedWithType(r,fe.all);if(t)throw E(new Error(`pinned: ${n}`),"ERR_BLOCK_PINNED")}const Fa=Xt("ipfs:repo:gc"),UV=Yr().code,BV=256,zV=new J("/local/filesroot");function FV({gcLock:r,pins:e,blockstore:t,root:n,loadCodec:s}){async function*i(){const o=Date.now();Fa("Creating set of marked blocks");const a=await r.writeLock();try{const c=await VV({pins:e,blockstore:t,root:n,loadCodec:s}),u=t.queryKeys({});yield*jV({blockstore:t},c,u),Fa(`Complete (${Date.now()-o}ms)`)}finally{a()}}return i}async function VV({pins:r,blockstore:e,loadCodec:t,root:n}){const s=async function*(){let a;try{a=await n.get(zV)}catch(u){if(u.code===UV){Fa("No blocks in MFS");return}throw u}const c=Ae.decode(a);yield c,yield*Eu(c,e,t)}(),i=qt(_t(r.recursiveKeys(),({cid:a})=>a),r.indirectKeys(),_t(r.directKeys(),({cid:a})=>a),s),o=new Set;for await(const a of qt(i,s))o.add(As.encode(a.multihash.bytes));return o}async function*jV({blockstore:r},e,t){let n=0,s=0;yield*ne(Q0(_t(t,async o=>async function(){n++;try{const c=As.encode(o.multihash.bytes);if(e.has(c))return null;try{await r.delete(o),s++}catch(u){return{err:new Error(`Could not delete block with CID ${o}: ${u.message}`)}}return{cid:o}}catch(c){const u=`Could delete block with CID ${o}`;return Fa(u,c),{err:new Error(u+`: ${c.message}`)}}}),BV),o=>Ze(o,Boolean)),Fa(`Marked set has ${e.size} unique blocks. Blockstore has ${n} blocks. Deleted ${s} blocks.`)}const Lt=Xt("ipfs:repo"),KV=Number.MAX_SAFE_INTEGER,qV="repoAutoMigrate";class HV{constructor(e,t,n,s){if(typeof e!="string")throw new Error("missing repo path");if(typeof t!="function")throw new Error("missing codec loader");this.options=Le(CV,s),this.closed=!0,this.path=e,this.root=n.root,this.datastore=n.datastore,this.keys=n.keys;const i=n.blocks,o=n.pins;this.pins=new LV({pinstore:o,blockstore:i,loadCodec:t});const a=MV(this.pins,i);this.blocks=RV(a),this.version=$F(this.root),this.config=MF(this.root),this.spec=BF(this.root),this.apiAddr=zF(this.root),this.gcLock=w2({name:e,singleProcess:this.options.repoOwner!==!1}),this.gc=FV({gcLock:this.gcLock,pins:this.pins,blockstore:this.blocks,root:this.root,loadCodec:t})}async init(e){Lt("initializing at: %s",this.path),await this._openRoot(),await this.config.replace(WV(e)),await this.spec.set(YV(e)),await this.version.set(cl)}async isInitialized(){if(!this.closed)return!0;try{return await this._openRoot(),await this._checkInitialized(),await this.root.close(),!0}catch{return!1}}async open(){if(!this.closed)throw E(new Error("repo is already open"),OF);Lt("opening at: %s",this.path);try{if(await this._openRoot(),await this._checkInitialized(),this._lockfile=await this._openLock(),Lt("acquired repo.lock"),!await this.version.check(cl))if(await this._isAutoMigrationEnabled())await this._migrate(cl,{root:this.root,datastore:this.datastore,pins:this.pins.pinstore,blocks:this.pins.blockstore,keys:this.keys});else throw new Dd("Incompatible repo versions. Automatic migrations disabled. Please migrate the repo manually.");Lt("creating datastore"),await this.datastore.open(),Lt("creating blocks"),await this.blocks.open(),Lt("creating keystore"),await this.keys.open(),Lt("creating pins"),await this.pins.pinstore.open(),this.closed=!1,Lt("all opened")}catch(e){if(this._lockfile)try{await this._closeLock(),this._lockfile=null}catch(t){Lt("error removing lock",t)}throw e}}async _openRoot(){try{await this.root.open()}catch(e){if(e.message!=="Already open")throw e}}async _openLock(){const e=await this.options.repoLock.lock(this.path);if(typeof e.close!="function")throw E(new Error("Locks must have a close method"),"ERR_NO_CLOSE_FUNCTION");return e}_closeLock(){return this._lockfile&&this._lockfile.close()}async _checkInitialized(){Lt("init check");let e;try{[e]=await Promise.all([this.config.exists(),this.spec.exists(),this.version.exists()])}catch(t){throw t.code==="ERR_NOT_FOUND"?E(new Error("repo is not initialized yet"),ia,{path:this.path}):t}if(!e)throw E(new Error("repo is not initialized yet"),ia,{path:this.path})}async close(){if(this.closed)throw E(new Error("repo is already closed"),NF);Lt("closing at: %s",this.path);try{await this.apiAddr.delete()}catch(e){if(e.code!==ia&&!e.message.startsWith("ENOENT"))throw e}await Promise.all([this.root,this.blocks,this.keys,this.datastore,this.pins.pinstore].map(e=>e&&e.close())),Lt("unlocking"),this.closed=!0,await this._closeLock()}exists(){return this.version.exists()}async stat(){if(this.datastore&&this.keys){const[e,t,n,s,i]=await Promise.all([this._storageMaxStat(),this._blockStat(),this.version.get(),xy(this.datastore),xy(this.keys)]),o=t.size+s+i;return{repoPath:this.path,storageMax:e,version:n,numObjects:t.count,repoSize:o}}throw E(new Error("repo is not initialized yet"),ia,{path:this.path})}async _isAutoMigrationEnabled(){if(this.options.autoMigrate!==void 0)return this.options.autoMigrate;let e;try{e=await this.config.get(qV)}catch(t){if(t.code===Ns.code)e=!0;else throw t}return e}async _migrate(e,t){return await this.version.get()>e?(Lt(`reverting to version ${e}`),AF(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress})):(Lt(`migrating to version ${e}`),IF(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress}))}async _storageMaxStat(){try{const e=await this.config.get("Datastore.StorageMax");return BigInt(za(e))}catch{return BigInt(KV)}}async _blockStat(){let e=BigInt(0),t=BigInt(0);if(this.blocks)for await(const{key:n,value:s}of this.blocks.query({}))e+=BigInt(1),t+=BigInt(s.byteLength),t+=BigInt(n.bytes.byteLength);return{count:e,size:t}}}async function xy(r){let e=BigInt(0);for await(const t of r.query({}))e+=BigInt(t.value.byteLength),e+=BigInt(t.key.uint8Array().byteLength);return e}function GV(r,e,t,n){return new HV(r,e,t,n)}function WV(r){return r.Datastore=Object.assign({},S7,S2(r,"datastore")),r}function YV(r){const e={...S7.Spec,...S2(r,"Datastore.Spec")};return{type:e.type,mounts:e.mounts.map(t=>({mountpoint:t.mountpoint,type:t.child.type,path:t.child.path,shardFunc:t.child.shardFunc}))}}async function*Va(r,e){yield*(await Dn(r)).sort(e)}class zo extends fd{constructor(e,t={}){super(),this.db=typeof e=="string"?new Y9(e,{...t,keyEncoding:"utf8",valueEncoding:"view"}):e,this.opts={createIfMissing:!0,compression:!1,...t}}async open(){try{await this.db.open(this.opts)}catch(e){throw D8(e)}}async put(e,t){try{await this.db.put(e.toString(),t)}catch(n){throw Ff(n)}}async get(e){let t;try{t=await this.db.get(e.toString())}catch(n){throw n.notFound?Yr(n):Ff(n)}return t}async has(e){try{await this.db.get(e.toString())}catch(t){if(t.notFound)return!1;throw t}return!0}async delete(e){try{await this.db.del(e.toString())}catch(t){throw P8(t)}}close(){return this.db&&this.db.close()}batch(){const e=[];return{put:(t,n)=>{e.push({type:"put",key:t.toString(),value:n})},delete:t=>{e.push({type:"del",key:t.toString()})},commit:()=>this.db.batch(e)}}query(e){let t=this._query({values:!0,prefix:e.prefix});Array.isArray(e.filters)&&(t=e.filters.reduce((i,o)=>Ze(i,o),t)),Array.isArray(e.orders)&&(t=e.orders.reduce((i,o)=>Va(i,o),t));const{offset:n,limit:s}=e;if(n){let i=0;t=Ze(t,()=>i++>=n)}return s&&(t=Ta(t,s)),t}queryKeys(e){let t=_t(this._query({values:!1,prefix:e.prefix}),({key:i})=>i);Array.isArray(e.filters)&&(t=e.filters.reduce((i,o)=>Ze(i,o),t)),Array.isArray(e.orders)&&(t=e.orders.reduce((i,o)=>Va(i,o),t));const{offset:n,limit:s}=e;if(n){let i=0;t=Ze(t,()=>i++>=n)}return s&&(t=Ta(t,s)),t}_query(e){const t={keys:!0,keyEncoding:"buffer",values:e.values};if(e.prefix!=null){const s=e.prefix.toString();t.gte=s,t.lt=s+"ÿ"}const n=this.db.iterator(t);if(n[Symbol.asyncIterator])return QV(n);if(n.next!=null&&n.end!=null)return JV(n);throw new Error("Level returned incompatible iterator")}}async function*QV(r){for await(const[e,t]of r)yield{key:new J(e,!1),value:t};await r.close()}function JV(r){return{[Symbol.asyncIterator](){return{next:()=>new Promise((e,t)=>{r.next((n,s,i)=>{if(n)return t(n);if(s==null)return r.end(o=>{if(o)return t(o);e({done:!0,value:void 0})});e({done:!1,value:{key:new J(s,!1),value:i}})})}),return:()=>new Promise((e,t)=>{r.end(n=>{if(n)return t(n);e({done:!0,value:void 0})})})}}}}var XV=I7,$y=128,ZV=127,ej=~ZV,tj=Math.pow(2,31);function I7(r,e,t){e=e||[],t=t||0;for(var n=t;r>=tj;)e[t++]=r&255|$y,r/=128;for(;r&ej;)e[t++]=r&255|$y,r>>>=7;return e[t]=r|0,I7.bytes=t-n+1,e}var rj=$1,nj=128,Ly=127;function $1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw $1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Ly)<<s:(o&Ly)*Math.pow(2,s),s+=7}while(o>=nj);return $1.bytes=i-n,t}var sj=Math.pow(2,7),ij=Math.pow(2,14),oj=Math.pow(2,21),aj=Math.pow(2,28),cj=Math.pow(2,35),lj=Math.pow(2,42),uj=Math.pow(2,49),dj=Math.pow(2,56),hj=Math.pow(2,63),fj=function(r){return r<sj?1:r<ij?2:r<oj?3:r<aj?4:r<cj?5:r<lj?6:r<uj?7:r<dj?8:r<hj?9:10},pj={encode:XV,decode:rj,encodingLength:fj},_u=pj;const L1=(r,e=0)=>[_u.decode(r,e),_u.decode.bytes],vu=(r,e,t=0)=>(_u.encode(r,e,t),e),Su=r=>_u.encodingLength(r),gj=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},O2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},yj=(r,e)=>{const t=e.byteLength,n=Su(r),s=n+Su(t),i=new Uint8Array(s+t);return vu(r,i,0),vu(t,i,n),i.set(e,s),new N2(r,t,e,i)},A7=r=>{const e=O2(r),[t,n]=L1(e),[s,i]=L1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new N2(t,s,o,e)},wj=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&gj(r.bytes,t.bytes)}};let N2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function mj(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var bj=mj,Ej=bj;let _j=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},vj=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return C7(this,e)}},Sj=class{constructor(e){this.decoders=e}or(e){return C7(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const C7=(r,e)=>new Sj({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Rj=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new _j(e,t,n),this.decoder=new vj(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const T7=({name:r,prefix:e,encode:t,decode:n})=>new Rj(r,e,t,n),D7=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Ej(t,e);return T7({prefix:r,name:e,encode:n,decode:i=>O2(s(i))})},Ij=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Aj=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Mn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>T7({prefix:e,name:r,encode(s){return Aj(s,n,t)},decode(s){return Ij(s,n,t,r)}}),Ur=D7({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});D7({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const _n=Mn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Mn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});const Cj=Mn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Mn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Mn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Mn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Mn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Mn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Mn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Tj=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Pj(t,M1(r),e||Ur.encoder);default:return kj(t,M1(r),e||_n.encoder)}},My=new WeakMap,M1=r=>{const e=My.get(r);if(e==null){const t=new Map;return My.set(r,t),t}return e};let gt=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Fo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Oj)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return gt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=yj(e,t);return gt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return gt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&wj(e.multihash,n.multihash)}toString(e){return Tj(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof gt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new gt(n,s,i,o||Uy(n,s,i.bytes))}else if(t[Nj]===!0){const{version:n,multihash:s,code:i}=t,o=A7(s);return gt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Fo)throw new Error(`Version 0 CID must use dag-pb (code: ${Fo}) block encoding`);return new gt(e,t,n,n.bytes)}case 1:{const s=Uy(e,t,n.bytes);return new gt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return gt.create(0,Fo,e)}static createV1(e,t){return gt.create(1,e,t)}static decode(e){const[t,n]=gt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=gt.inspectBytes(e),n=t.size-t.multihashSize,s=O2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new N2(t.multihashCode,t.digestSize,i,s);return[t.version===0?gt.createV0(o):gt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=L1(e.subarray(t));return t+=f,d};let s=n(),i=Fo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Dj(e,t),i=gt.decode(s);return M1(i).set(n,e),i}};const Dj=(r,e)=>{switch(r[0]){case"Q":{const t=e||Ur;return[Ur.prefix,t.decode(`${Ur.prefix}${r}`)]}case Ur.prefix:{const t=e||Ur;return[Ur.prefix,t.decode(r)]}case _n.prefix:{const t=e||_n;return[_n.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Pj=(r,e,t)=>{const{prefix:n}=t;if(n!==Ur.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},kj=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Fo=112,Oj=18,Uy=(r,e,t)=>{const n=Su(r),s=n+Su(e),i=new Uint8Array(s+t.byteLength);return vu(r,i,0),vu(e,i,n),i.set(t,s),i},Nj=Symbol.for("@ipld/js-cid/CID"),xj=85,$j=async r=>{for await(const e of r);};var By=$j;const Lj=async function*(r,e){for await(const t of r)await e(t)&&(yield t)};var wi=Lj;const Mj=async function*(r,e){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}};var zy=Mj;const Uj=async r=>{const e=[];for await(const t of r)e.push(t);return e};var Bj=Uj;const Fy=(r,e)=>async function*(){yield*(await Bj(r)).sort(e)}();class x2{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await By(this.putMany(e,n)),e=[],await By(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null&&(n=wi(n,s=>s.key.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>wi(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Fy(s,i),n)),e.offset!=null){let s=0;n=wi(n,()=>s++>=(e.offset||0))}return e.limit!=null&&(n=zy(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null&&(n=wi(n,s=>s.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>wi(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Fy(s,i),n)),e.offset!=null){let s=0;n=wi(n,()=>s++>=e.offset)}return e.limit!=null&&(n=zy(n,e.limit)),n}}function mi(r){const e=gt.asCID(r);if(!e)throw E(new Error("Not a valid cid"),"ERR_INVALID_CID");return new J("/"+_n.encode(e.multihash.bytes).slice(1).toUpperCase(),!1)}function Cs(r){return gt.createV1(xj,A7(_n.decode("b"+r.toString().slice(1).toLowerCase())))}function $2(r){const e=r.substring(0,1);if(e==="/")return $2(r.substring(1));let t;e.toLowerCase()==="b"?t=i=>_n.decode(i.toLowerCase()).subarray(2):e.toLowerCase()==="c"?t=i=>Cj.decode(i.toLowerCase()).subarray(2):e==="z"?t=i=>Ur.decode(i).subarray(2):e==="Q"?t=i=>Ur.decode("z"+i):t=i=>_n.decode("b"+i.toLowerCase()).subarray(2);let n;for(let i=1;i<r.length;i++)try{n=t(r.substring(0,i))}catch(o){if(o.message!=="Unexpected end of data")throw o}let s="/C";return n&&(s=`/${_n.encode(n).slice(1,-1).toUpperCase()||"C"}`),s}function zj(r){return{...r,prefix:r.prefix?$2(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e({key:Cs(t.key),value:t.value})):void 0,orders:r.orders?r.orders.map(e=>(t,n)=>e({key:Cs(t.key),value:t.value},{key:Cs(n.key),value:n.value})):void 0}}function Fj(r){return{...r,prefix:r.prefix?$2(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e(Cs(t))):void 0,orders:r.orders?r.orders.map(e=>(t,n)=>e(Cs(t),Cs(n))):void 0}}class Vj extends x2{constructor(e){super(),this.child=e}open(){return this.child.open()}close(){return this.child.close()}async*query(e,t){for await(const{key:n,value:s}of this.child.query(zj(e),t))yield{key:Cs(n),value:s}}async*queryKeys(e,t){for await(const n of this.child.queryKeys(Fj(e),t))yield Cs(n)}async get(e,t){return this.child.get(mi(e),t)}async*getMany(e,t){for await(const n of e)yield this.get(n,t)}async put(e,t,n){await this.child.put(mi(e),t,n)}async*putMany(e,t){const n=dr({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)(async()=>{try{const i=this.child;await Et(this.child.putMany(async function*(){for await(const o of e){const a=mi(o.key);await i.has(a,t)||(yield{key:a,value:o.value}),n.push(o)}}())),n.end()}catch(i){n.end(i)}}),yield*n}has(e,t){return this.child.has(mi(e),t)}delete(e,t){return this.child.delete(mi(e),t)}deleteMany(e,t){const n=dr({objectMode:!0});return Et(this.child.deleteMany(async function*(){for await(const s of e)yield mi(s),n.push(s);n.end()}(),t)).catch(s=>{n.end(s)}),n}}function jj(r,e,t){const n=t.path||"ipfs";return GV(n,s=>e.getCodec(s),{root:new zo(n,{prefix:"",version:2}),blocks:new Vj(new zo(`${n}/blocks`,{prefix:"",version:2})),datastore:new zo(`${n}/datastore`,{prefix:"",version:2}),keys:new zo(`${n}/keys`,{prefix:"",version:2}),pins:new zo(`${n}/pins`,{prefix:"",version:2})},{autoMigrate:t.autoMigrate,onMigrationProgress:t.onMigrationProgress||r,repoLock:v7})}const Kj={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var Ru;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.publicKey!=null&&t.publicKey.byteLength>0)&&(n.uint32(10),n.bytes(t.publicKey)),(s.writeDefaults===!0||t.payloadType!=null&&t.payloadType.byteLength>0)&&(n.uint32(18),n.bytes(t.payloadType)),(s.writeDefaults===!0||t.payload!=null&&t.payload.byteLength>0)&&(n.uint32(26),n.bytes(t.payload)),(s.writeDefaults===!0||t.signature!=null&&t.signature.byteLength>0)&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.publicKey=t.bytes();break;case 2:s.payloadType=t.bytes();break;case 3:s.payload=t.bytes();break;case 5:s.signature=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(Ru||(Ru={}));class Yt{constructor(e){const{peerId:t,payloadType:n,payload:s,signature:i}=e;this.peerId=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=Ru.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return Dt(this.marshal(),e.marshal())}async validate(e){const t=P7(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return await Ki(this.peerId.publicKey).verify(t.subarray(),this.signature)}}Yt.createFromProtobuf=async r=>{const e=Ru.decode(r),t=await Sn(e.publicKey);return new Yt({peerId:t,payloadType:e.payloadType,payload:e.payload,signature:e.signature})};Yt.seal=async(r,e)=>{if(e.privateKey==null)throw new Error("Missing private key");const t=r.domain,n=r.codec,s=r.marshal(),i=P7(t,n,s),a=await(await oi(e.privateKey)).sign(i.subarray());return new Yt({peerId:e,payloadType:n,payload:s,signature:a})};Yt.openAndCertify=async(r,e)=>{const t=await Yt.createFromProtobuf(r);if(!await t.validate(e))throw E(new Error("envelope signature is not valid for the given domain"),Kj.ERR_SIGNATURE_NOT_VALID);return t};const P7=(r,e,t)=>{const n=M(r),s=Kd.encode(n.byteLength),i=Kd.encode(e.length),o=Kd.encode(t.length);return new Pt(s,n,i,e,o,t)};function qj(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}var Iu;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),(o.writeDefaults===!0||s.multiaddr!=null&&s.multiaddr.byteLength>0)&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={multiaddr:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.multiaddr=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),t.encode=s=>rt(s,t.codec()),t.decode=s=>nt(s,t.codec())})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.peerId!=null&&t.peerId.byteLength>0)&&(n.uint32(10),n.bytes(t.peerId)),(s.writeDefaults===!0||t.seq!==0n)&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n,{writeDefaults:!0});s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.peerId=t.bytes();break;case 2:s.seq=t.uint64();break;case 3:s.addresses.push(r.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(Iu||(Iu={}));const Hj="libp2p-peer-record",Gj=Uint8Array.from([3,1]);class Vt{constructor(e){this.domain=Vt.DOMAIN,this.codec=Vt.CODEC;const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Iu.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof Vt)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!qj(this.multiaddrs,e.multiaddrs))}}Vt.createFromProtobuf=r=>{const e=Iu.decode(r),t=Xr(e.peerId),n=(e.addresses??[]).map(i=>X(i.multiaddr)),s=e.seq;return new Vt({peerId:t,multiaddrs:n,seqNumber:s})};Vt.DOMAIN=Hj;Vt.CODEC=Gj;const U1=Symbol.for("@libp2p/topology");function Wj(r){return r!=null&&Boolean(r[U1])}const Vy=()=>{};class Yj{constructor(e){this.min=e.min??0,this.max=e.max??1/0,this.peers=new Set,this.onConnect=e.onConnect??Vy,this.onDisconnect=e.onDisconnect??Vy}get[Symbol.toStringTag](){return U1.toString()}get[U1](){return!0}async setRegistrar(e){this.registrar=e}disconnect(e){this.onDisconnect(e)}}function L2(r){return new Yj(r)}class Qj{constructor(e,t,n){this.gossip=e,this.msgs=new Map,this.history=[],this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(!n)return null;const s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{const i=this.msgs.get(s.msgIdStr);if(i&&i.validated&&e.has(s.topic)){let o=t.get(s.topic);o||(o=[],t.set(s.topic,o)),o.push(s.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(!t)return null;const{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{this.msgs.delete(t.msgIdStr)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}}var B1={},Jj={get exports(){return B1},set exports(r){B1=r}},Au={},Xj={get exports(){return Au},set exports(r){Au=r}},Ch={},Th={},Dh,jy;function Zj(){if(jy)return Dh;jy=1,Dh=e;var r=hi();function e(i,o){this.lo=i>>>0,this.hi=o>>>0}var t=e.zero=new e(0,0);t.toNumber=function(){return 0},t.zzEncode=t.zzDecode=function(){return this},t.length=function(){return 1};var n=e.zeroHash="\0\0\0\0\0\0\0\0";e.fromNumber=function(o){if(o===0)return t;var a=o<0;a&&(o=-o);var c=o>>>0,u=(o-c)/4294967296>>>0;return a&&(u=~u>>>0,c=~c>>>0,++c>4294967295&&(c=0,++u>4294967295&&(u=0))),new e(c,u)},e.from=function(o){if(typeof o=="number")return e.fromNumber(o);if(r.isString(o))if(r.Long)o=r.Long.fromString(o);else return e.fromNumber(parseInt(o,10));return o.low||o.high?new e(o.low>>>0,o.high>>>0):t},e.prototype.toNumber=function(o){if(!o&&this.hi>>>31){var a=~this.lo+1>>>0,c=~this.hi>>>0;return a||(c=c+1>>>0),-(a+c*4294967296)}return this.lo+this.hi*4294967296},e.prototype.toLong=function(o){return r.Long?new r.Long(this.lo|0,this.hi|0,Boolean(o)):{low:this.lo|0,high:this.hi|0,unsigned:Boolean(o)}};var s=String.prototype.charCodeAt;return e.fromHash=function(o){return o===n?t:new e((s.call(o,0)|s.call(o,1)<<8|s.call(o,2)<<16|s.call(o,3)<<24)>>>0,(s.call(o,4)|s.call(o,5)<<8|s.call(o,6)<<16|s.call(o,7)<<24)>>>0)},e.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},e.prototype.zzEncode=function(){var o=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^o)>>>0,this.lo=(this.lo<<1^o)>>>0,this},e.prototype.zzDecode=function(){var o=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^o)>>>0,this.hi=(this.hi>>>1^o)>>>0,this},e.prototype.length=function(){var o=this.lo,a=(this.lo>>>28|this.hi<<4)>>>0,c=this.hi>>>24;return c===0?a===0?o<16384?o<128?1:2:o<2097152?3:4:a<16384?a<128?5:6:a<2097152?7:8:c<128?9:10},Dh}var Ky;function hi(){return Ky||(Ky=1,function(r){var e=r;e.asPromise=Q9,e.base64=J9,e.EventEmitter=X9,e.float=Z9,e.inquire=eE,e.utf8=tE,e.pool=rE,e.LongBits=Zj(),e.isNode=Boolean(typeof or<"u"&&or&&or.process&&or.process.versions&&or.process.versions.node),e.global=e.isNode&&or||typeof window<"u"&&window||typeof self<"u"&&self||or,e.emptyArray=Object.freeze?Object.freeze([]):[],e.emptyObject=Object.freeze?Object.freeze({}):{},e.isInteger=Number.isInteger||function(i){return typeof i=="number"&&isFinite(i)&&Math.floor(i)===i},e.isString=function(i){return typeof i=="string"||i instanceof String},e.isObject=function(i){return i&&typeof i=="object"},e.isset=e.isSet=function(i,o){var a=i[o];return a!=null&&i.hasOwnProperty(o)?typeof a!="object"||(Array.isArray(a)?a.length:Object.keys(a).length)>0:!1},e.Buffer=function(){try{var s=e.inquire("buffer").Buffer;return s.prototype.utf8Write?s:null}catch{return null}}(),e._Buffer_from=null,e._Buffer_allocUnsafe=null,e.newBuffer=function(i){return typeof i=="number"?e.Buffer?e._Buffer_allocUnsafe(i):new e.Array(i):e.Buffer?e._Buffer_from(i):typeof Uint8Array>"u"?i:new Uint8Array(i)},e.Array=typeof Uint8Array<"u"?Uint8Array:Array,e.Long=e.global.dcodeIO&&e.global.dcodeIO.Long||e.global.Long||e.inquire("long"),e.key2Re=/^true|false|0|1$/,e.key32Re=/^-?(?:0|[1-9][0-9]*)$/,e.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,e.longToHash=function(i){return i?e.LongBits.from(i).toHash():e.LongBits.zeroHash},e.longFromHash=function(i,o){var a=e.LongBits.fromHash(i);return e.Long?e.Long.fromBits(a.lo,a.hi,o):a.toNumber(Boolean(o))};function t(s,i,o){for(var a=Object.keys(i),c=0;c<a.length;++c)(s[a[c]]===void 0||!o)&&(s[a[c]]=i[a[c]]);return s}e.merge=t,e.lcFirst=function(i){return i.charAt(0).toLowerCase()+i.substring(1)};function n(s){function i(o,a){if(!(this instanceof i))return new i(o,a);Object.defineProperty(this,"message",{get:function(){return o}}),Error.captureStackTrace?Error.captureStackTrace(this,i):Object.defineProperty(this,"stack",{value:new Error().stack||""}),a&&t(this,a)}return(i.prototype=Object.create(Error.prototype)).constructor=i,Object.defineProperty(i.prototype,"name",{get:function(){return s}}),i.prototype.toString=function(){return this.name+": "+this.message},i}e.newError=n,e.ProtocolError=n("ProtocolError"),e.oneOfGetter=function(i){for(var o={},a=0;a<i.length;++a)o[i[a]]=1;return function(){for(var c=Object.keys(this),u=c.length-1;u>-1;--u)if(o[c[u]]===1&&this[c[u]]!==void 0&&this[c[u]]!==null)return c[u]}},e.oneOfSetter=function(i){return function(o){for(var a=0;a<i.length;++a)i[a]!==o&&delete this[i[a]]}},e.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},e._configure=function(){var s=e.Buffer;if(!s){e._Buffer_from=e._Buffer_allocUnsafe=null;return}e._Buffer_from=s.from!==Uint8Array.from&&s.from||function(o,a){return new s(o,a)},e._Buffer_allocUnsafe=s.allocUnsafe||function(o){return new s(o)}}}(Th)),Th}var Ph,qy;function k7(){if(qy)return Ph;qy=1,Ph=c;var r=hi(),e,t=r.LongBits,n=r.base64,s=r.utf8;function i(w,y,_){this.fn=w,this.len=y,this.next=void 0,this.val=_}function o(){}function a(w){this.head=w.head,this.tail=w.tail,this.len=w.len,this.next=w.states}function c(){this.len=0,this.head=new i(o,0,0),this.tail=this.head,this.states=null}var u=function(){return r.Buffer?function(){return(c.create=function(){return new e})()}:function(){return new c}};c.create=u(),c.alloc=function(y){return new r.Array(y)},r.Array!==Array&&(c.alloc=r.pool(c.alloc,r.Array.prototype.subarray)),c.prototype._push=function(y,_,b){return this.tail=this.tail.next=new i(y,_,b),this.len+=_,this};function l(w,y,_){y[_]=w&255}function d(w,y,_){for(;w>127;)y[_++]=w&127|128,w>>>=7;y[_]=w}function f(w,y){this.len=w,this.next=void 0,this.val=y}f.prototype=Object.create(i.prototype),f.prototype.fn=d,c.prototype.uint32=function(y){return this.len+=(this.tail=this.tail.next=new f((y=y>>>0)<128?1:y<16384?2:y<2097152?3:y<268435456?4:5,y)).len,this},c.prototype.int32=function(y){return y<0?this._push(g,10,t.fromNumber(y)):this.uint32(y)},c.prototype.sint32=function(y){return this.uint32((y<<1^y>>31)>>>0)};function g(w,y,_){for(;w.hi;)y[_++]=w.lo&127|128,w.lo=(w.lo>>>7|w.hi<<25)>>>0,w.hi>>>=7;for(;w.lo>127;)y[_++]=w.lo&127|128,w.lo=w.lo>>>7;y[_++]=w.lo}c.prototype.uint64=function(y){var _=t.from(y);return this._push(g,_.length(),_)},c.prototype.int64=c.prototype.uint64,c.prototype.sint64=function(y){var _=t.from(y).zzEncode();return this._push(g,_.length(),_)},c.prototype.bool=function(y){return this._push(l,1,y?1:0)};function h(w,y,_){y[_]=w&255,y[_+1]=w>>>8&255,y[_+2]=w>>>16&255,y[_+3]=w>>>24}c.prototype.fixed32=function(y){return this._push(h,4,y>>>0)},c.prototype.sfixed32=c.prototype.fixed32,c.prototype.fixed64=function(y){var _=t.from(y);return this._push(h,4,_.lo)._push(h,4,_.hi)},c.prototype.sfixed64=c.prototype.fixed64,c.prototype.float=function(y){return this._push(r.float.writeFloatLE,4,y)},c.prototype.double=function(y){return this._push(r.float.writeDoubleLE,8,y)};var p=r.Array.prototype.set?function(y,_,b){_.set(y,b)}:function(y,_,b){for(var m=0;m<y.length;++m)_[b+m]=y[m]};return c.prototype.bytes=function(y){var _=y.length>>>0;if(!_)return this._push(l,1,0);if(r.isString(y)){var b=c.alloc(_=n.length(y));n.decode(y,b,0),y=b}return this.uint32(_)._push(p,_,y)},c.prototype.string=function(y){var _=s.length(y);return _?this.uint32(_)._push(s.write,_,y):this._push(l,1,0)},c.prototype.fork=function(){return this.states=new a(this),this.head=this.tail=new i(o,0,0),this.len=0,this},c.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new i(o,0,0),this.len=0),this},c.prototype.ldelim=function(){var y=this.head,_=this.tail,b=this.len;return this.reset().uint32(b),b&&(this.tail.next=y.next,this.tail=_,this.len+=b),this},c.prototype.finish=function(){for(var y=this.head.next,_=this.constructor.alloc(this.len),b=0;y;)y.fn(y.val,_,b),b+=y.len,y=y.next;return _},c._configure=function(w){e=w,c.create=u(),e._configure()},Ph}var kh,Hy;function eK(){if(Hy)return kh;Hy=1,kh=t;var r=k7();(t.prototype=Object.create(r.prototype)).constructor=t;var e=hi();function t(){r.call(this)}t._configure=function(){t.alloc=e._Buffer_allocUnsafe,t.writeBytesBuffer=e.Buffer&&e.Buffer.prototype instanceof Uint8Array&&e.Buffer.prototype.set.name==="set"?function(i,o,a){o.set(i,a)}:function(i,o,a){if(i.copy)i.copy(o,a,0,i.length);else for(var c=0;c<i.length;)o[a++]=i[c++]}},t.prototype.bytes=function(i){e.isString(i)&&(i=e._Buffer_from(i,"base64"));var o=i.length>>>0;return this.uint32(o),o&&this._push(t.writeBytesBuffer,o,i),this};function n(s,i,o){s.length<40?e.utf8.write(s,i,o):i.utf8Write?i.utf8Write(s,o):i.write(s,o)}return t.prototype.string=function(i){var o=e.Buffer.byteLength(i);return this.uint32(o),o&&this._push(n,o,i),this},t._configure(),kh}var Oh,Gy;function O7(){if(Gy)return Oh;Gy=1,Oh=i;var r=hi(),e,t=r.LongBits,n=r.utf8;function s(d,f){return RangeError("index out of range: "+d.pos+" + "+(f||1)+" > "+d.len)}function i(d){this.buf=d,this.pos=0,this.len=d.length}var o=typeof Uint8Array<"u"?function(f){if(f instanceof Uint8Array||Array.isArray(f))return new i(f);throw Error("illegal buffer")}:function(f){if(Array.isArray(f))return new i(f);throw Error("illegal buffer")},a=function(){return r.Buffer?function(g){return(i.create=function(p){return r.Buffer.isBuffer(p)?new e(p):o(p)})(g)}:o};i.create=a(),i.prototype._slice=r.Array.prototype.subarray||r.Array.prototype.slice,i.prototype.uint32=function(){var f=4294967295;return function(){if(f=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(f=(f|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return f;if((this.pos+=5)>this.len)throw this.pos=this.len,s(this,10);return f}}(),i.prototype.int32=function(){return this.uint32()|0},i.prototype.sint32=function(){var f=this.uint32();return f>>>1^-(f&1)|0};function c(){var d=new t(0,0),f=0;if(this.len-this.pos>4){for(;f<4;++f)if(d.lo=(d.lo|(this.buf[this.pos]&127)<<f*7)>>>0,this.buf[this.pos++]<128)return d;if(d.lo=(d.lo|(this.buf[this.pos]&127)<<28)>>>0,d.hi=(d.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return d;f=0}else{for(;f<3;++f){if(this.pos>=this.len)throw s(this);if(d.lo=(d.lo|(this.buf[this.pos]&127)<<f*7)>>>0,this.buf[this.pos++]<128)return d}return d.lo=(d.lo|(this.buf[this.pos++]&127)<<f*7)>>>0,d}if(this.len-this.pos>4){for(;f<5;++f)if(d.hi=(d.hi|(this.buf[this.pos]&127)<<f*7+3)>>>0,this.buf[this.pos++]<128)return d}else for(;f<5;++f){if(this.pos>=this.len)throw s(this);if(d.hi=(d.hi|(this.buf[this.pos]&127)<<f*7+3)>>>0,this.buf[this.pos++]<128)return d}throw Error("invalid varint encoding")}i.prototype.bool=function(){return this.uint32()!==0};function u(d,f){return(d[f-4]|d[f-3]<<8|d[f-2]<<16|d[f-1]<<24)>>>0}i.prototype.fixed32=function(){if(this.pos+4>this.len)throw s(this,4);return u(this.buf,this.pos+=4)},i.prototype.sfixed32=function(){if(this.pos+4>this.len)throw s(this,4);return u(this.buf,this.pos+=4)|0};function l(){if(this.pos+8>this.len)throw s(this,8);return new t(u(this.buf,this.pos+=4),u(this.buf,this.pos+=4))}return i.prototype.float=function(){if(this.pos+4>this.len)throw s(this,4);var f=r.float.readFloatLE(this.buf,this.pos);return this.pos+=4,f},i.prototype.double=function(){if(this.pos+8>this.len)throw s(this,4);var f=r.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,f},i.prototype.bytes=function(){var f=this.uint32(),g=this.pos,h=this.pos+f;if(h>this.len)throw s(this,f);return this.pos+=f,Array.isArray(this.buf)?this.buf.slice(g,h):g===h?new this.buf.constructor(0):this._slice.call(this.buf,g,h)},i.prototype.string=function(){var f=this.bytes();return n.read(f,0,f.length)},i.prototype.skip=function(f){if(typeof f=="number"){if(this.pos+f>this.len)throw s(this,f);this.pos+=f}else do if(this.pos>=this.len)throw s(this);while(this.buf[this.pos++]&128);return this},i.prototype.skipType=function(d){switch(d){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(d=this.uint32()&7)!==4;)this.skipType(d);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+d+" at offset "+this.pos)}return this},i._configure=function(d){e=d,i.create=a(),e._configure();var f=r.Long?"toLong":"toNumber";r.merge(i.prototype,{int64:function(){return c.call(this)[f](!1)},uint64:function(){return c.call(this)[f](!0)},sint64:function(){return c.call(this).zzDecode()[f](!1)},fixed64:function(){return l.call(this)[f](!0)},sfixed64:function(){return l.call(this)[f](!1)}})},Oh}var Nh,Wy;function tK(){if(Wy)return Nh;Wy=1,Nh=t;var r=O7();(t.prototype=Object.create(r.prototype)).constructor=t;var e=hi();function t(n){r.call(this,n)}return t._configure=function(){e.Buffer&&(t.prototype._slice=e.Buffer.prototype.slice)},t.prototype.string=function(){var s=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+s,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+s,this.len))},t._configure(),Nh}var xh={},$h,Yy;function rK(){if(Yy)return $h;Yy=1,$h=e;var r=hi();(e.prototype=Object.create(r.EventEmitter.prototype)).constructor=e;function e(t,n,s){if(typeof t!="function")throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(n),this.responseDelimited=Boolean(s)}return e.prototype.rpcCall=function t(n,s,i,o,a){if(!o)throw TypeError("request must be specified");var c=this;if(!a)return r.asPromise(t,c,n,s,i,o);if(!c.rpcImpl){setTimeout(function(){a(Error("already ended"))},0);return}try{return c.rpcImpl(n,s[c.requestDelimited?"encodeDelimited":"encode"](o).finish(),function(l,d){if(l)return c.emit("error",l,n),a(l);if(d===null){c.end(!0);return}if(!(d instanceof i))try{d=i[c.responseDelimited?"decodeDelimited":"decode"](d)}catch(f){return c.emit("error",f,n),a(f)}return c.emit("data",d,n),a(null,d)})}catch(u){c.emit("error",u,n),setTimeout(function(){a(u)},0);return}},e.prototype.end=function(n){return this.rpcImpl&&(n||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},$h}var Qy;function nK(){return Qy||(Qy=1,function(r){var e=r;e.Service=rK()}(xh)),xh}var Lh,Jy;function sK(){return Jy||(Jy=1,Lh={}),Lh}var Xy;function iK(){return Xy||(Xy=1,function(r){var e=r;e.build="minimal",e.Writer=k7(),e.BufferWriter=eK(),e.Reader=O7(),e.BufferReader=tK(),e.util=hi(),e.rpc=nK(),e.roots=sK(),e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()}(Ch)),Ch}var Zy;function oK(){return Zy||(Zy=1,function(r){r.exports=iK()}(Xj)),Au}(function(r){(function(e,t){typeof nE=="function"&&r&&r.exports&&(r.exports=t(oK()))})(or,function(e){var t=e.Reader,n=e.Writer,s=e.util,i=e.roots.default||(e.roots.default={});return i.RPC=function(){function o(c){if(this.subscriptions=[],this.messages=[],c)for(var u=Object.keys(c),l=0;l<u.length;++l)c[u[l]]!=null&&(this[u[l]]=c[u[l]])}o.prototype.subscriptions=s.emptyArray,o.prototype.messages=s.emptyArray,o.prototype.control=null;var a;return Object.defineProperty(o.prototype,"_control",{get:s.oneOfGetter(a=["control"]),set:s.oneOfSetter(a)}),o.encode=function(u,l){if(l||(l=n.create()),u.subscriptions!=null&&u.subscriptions.length)for(var d=0;d<u.subscriptions.length;++d)i.RPC.SubOpts.encode(u.subscriptions[d],l.uint32(10).fork()).ldelim();if(u.messages!=null&&u.messages.length)for(var d=0;d<u.messages.length;++d)i.RPC.Message.encode(u.messages[d],l.uint32(18).fork()).ldelim();return u.control!=null&&Object.hasOwnProperty.call(u,"control")&&i.RPC.ControlMessage.encode(u.control,l.uint32(26).fork()).ldelim(),l},o.decode=function(u,l){u instanceof t||(u=t.create(u));for(var d=l===void 0?u.len:u.pos+l,f=new i.RPC;u.pos<d;){var g=u.uint32();switch(g>>>3){case 1:f.subscriptions&&f.subscriptions.length||(f.subscriptions=[]),f.subscriptions.push(i.RPC.SubOpts.decode(u,u.uint32()));break;case 2:f.messages&&f.messages.length||(f.messages=[]),f.messages.push(i.RPC.Message.decode(u,u.uint32()));break;case 3:f.control=i.RPC.ControlMessage.decode(u,u.uint32());break;default:u.skipType(g&7);break}}return f},o.fromObject=function(u){if(u instanceof i.RPC)return u;var l=new i.RPC;if(u.subscriptions){if(!Array.isArray(u.subscriptions))throw TypeError(".RPC.subscriptions: array expected");l.subscriptions=[];for(var d=0;d<u.subscriptions.length;++d){if(typeof u.subscriptions[d]!="object")throw TypeError(".RPC.subscriptions: object expected");l.subscriptions[d]=i.RPC.SubOpts.fromObject(u.subscriptions[d])}}if(u.messages){if(!Array.isArray(u.messages))throw TypeError(".RPC.messages: array expected");l.messages=[];for(var d=0;d<u.messages.length;++d){if(typeof u.messages[d]!="object")throw TypeError(".RPC.messages: object expected");l.messages[d]=i.RPC.Message.fromObject(u.messages[d])}}if(u.control!=null){if(typeof u.control!="object")throw TypeError(".RPC.control: object expected");l.control=i.RPC.ControlMessage.fromObject(u.control)}return l},o.toObject=function(u,l){l||(l={});var d={};if((l.arrays||l.defaults)&&(d.subscriptions=[],d.messages=[]),u.subscriptions&&u.subscriptions.length){d.subscriptions=[];for(var f=0;f<u.subscriptions.length;++f)d.subscriptions[f]=i.RPC.SubOpts.toObject(u.subscriptions[f],l)}if(u.messages&&u.messages.length){d.messages=[];for(var f=0;f<u.messages.length;++f)d.messages[f]=i.RPC.Message.toObject(u.messages[f],l)}return u.control!=null&&u.hasOwnProperty("control")&&(d.control=i.RPC.ControlMessage.toObject(u.control,l),l.oneofs&&(d._control="control")),d},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o.SubOpts=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.subscribe=null,c.prototype.topic=null;var u;return Object.defineProperty(c.prototype,"_subscribe",{get:s.oneOfGetter(u=["subscribe"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_topic",{get:s.oneOfGetter(u=["topic"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.subscribe!=null&&Object.hasOwnProperty.call(d,"subscribe")&&f.uint32(8).bool(d.subscribe),d.topic!=null&&Object.hasOwnProperty.call(d,"topic")&&f.uint32(18).string(d.topic),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.SubOpts;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.subscribe=d.bool();break;case 2:h.topic=d.string();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.SubOpts)return d;var f=new i.RPC.SubOpts;return d.subscribe!=null&&(f.subscribe=Boolean(d.subscribe)),d.topic!=null&&(f.topic=String(d.topic)),f},c.toObject=function(d,f){f||(f={});var g={};return d.subscribe!=null&&d.hasOwnProperty("subscribe")&&(g.subscribe=d.subscribe,f.oneofs&&(g._subscribe="subscribe")),d.topic!=null&&d.hasOwnProperty("topic")&&(g.topic=d.topic,f.oneofs&&(g._topic="topic")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.Message=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.from=null,c.prototype.data=null,c.prototype.seqno=null,c.prototype.topic="",c.prototype.signature=null,c.prototype.key=null;var u;return Object.defineProperty(c.prototype,"_from",{get:s.oneOfGetter(u=["from"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_data",{get:s.oneOfGetter(u=["data"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_seqno",{get:s.oneOfGetter(u=["seqno"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_signature",{get:s.oneOfGetter(u=["signature"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_key",{get:s.oneOfGetter(u=["key"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.from!=null&&Object.hasOwnProperty.call(d,"from")&&f.uint32(10).bytes(d.from),d.data!=null&&Object.hasOwnProperty.call(d,"data")&&f.uint32(18).bytes(d.data),d.seqno!=null&&Object.hasOwnProperty.call(d,"seqno")&&f.uint32(26).bytes(d.seqno),f.uint32(34).string(d.topic),d.signature!=null&&Object.hasOwnProperty.call(d,"signature")&&f.uint32(42).bytes(d.signature),d.key!=null&&Object.hasOwnProperty.call(d,"key")&&f.uint32(50).bytes(d.key),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.Message;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.from=d.bytes();break;case 2:h.data=d.bytes();break;case 3:h.seqno=d.bytes();break;case 4:h.topic=d.string();break;case 5:h.signature=d.bytes();break;case 6:h.key=d.bytes();break;default:d.skipType(p&7);break}}if(!h.hasOwnProperty("topic"))throw s.ProtocolError("missing required 'topic'",{instance:h});return h},c.fromObject=function(d){if(d instanceof i.RPC.Message)return d;var f=new i.RPC.Message;return d.from!=null&&(typeof d.from=="string"?s.base64.decode(d.from,f.from=s.newBuffer(s.base64.length(d.from)),0):d.from.length&&(f.from=d.from)),d.data!=null&&(typeof d.data=="string"?s.base64.decode(d.data,f.data=s.newBuffer(s.base64.length(d.data)),0):d.data.length&&(f.data=d.data)),d.seqno!=null&&(typeof d.seqno=="string"?s.base64.decode(d.seqno,f.seqno=s.newBuffer(s.base64.length(d.seqno)),0):d.seqno.length&&(f.seqno=d.seqno)),d.topic!=null&&(f.topic=String(d.topic)),d.signature!=null&&(typeof d.signature=="string"?s.base64.decode(d.signature,f.signature=s.newBuffer(s.base64.length(d.signature)),0):d.signature.length&&(f.signature=d.signature)),d.key!=null&&(typeof d.key=="string"?s.base64.decode(d.key,f.key=s.newBuffer(s.base64.length(d.key)),0):d.key.length&&(f.key=d.key)),f},c.toObject=function(d,f){f||(f={});var g={};return f.defaults&&(g.topic=""),d.from!=null&&d.hasOwnProperty("from")&&(g.from=f.bytes===String?s.base64.encode(d.from,0,d.from.length):f.bytes===Array?Array.prototype.slice.call(d.from):d.from,f.oneofs&&(g._from="from")),d.data!=null&&d.hasOwnProperty("data")&&(g.data=f.bytes===String?s.base64.encode(d.data,0,d.data.length):f.bytes===Array?Array.prototype.slice.call(d.data):d.data,f.oneofs&&(g._data="data")),d.seqno!=null&&d.hasOwnProperty("seqno")&&(g.seqno=f.bytes===String?s.base64.encode(d.seqno,0,d.seqno.length):f.bytes===Array?Array.prototype.slice.call(d.seqno):d.seqno,f.oneofs&&(g._seqno="seqno")),d.topic!=null&&d.hasOwnProperty("topic")&&(g.topic=d.topic),d.signature!=null&&d.hasOwnProperty("signature")&&(g.signature=f.bytes===String?s.base64.encode(d.signature,0,d.signature.length):f.bytes===Array?Array.prototype.slice.call(d.signature):d.signature,f.oneofs&&(g._signature="signature")),d.key!=null&&d.hasOwnProperty("key")&&(g.key=f.bytes===String?s.base64.encode(d.key,0,d.key.length):f.bytes===Array?Array.prototype.slice.call(d.key):d.key,f.oneofs&&(g._key="key")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlMessage=function(){function c(u){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],u)for(var l=Object.keys(u),d=0;d<l.length;++d)u[l[d]]!=null&&(this[l[d]]=u[l[d]])}return c.prototype.ihave=s.emptyArray,c.prototype.iwant=s.emptyArray,c.prototype.graft=s.emptyArray,c.prototype.prune=s.emptyArray,c.encode=function(l,d){if(d||(d=n.create()),l.ihave!=null&&l.ihave.length)for(var f=0;f<l.ihave.length;++f)i.RPC.ControlIHave.encode(l.ihave[f],d.uint32(10).fork()).ldelim();if(l.iwant!=null&&l.iwant.length)for(var f=0;f<l.iwant.length;++f)i.RPC.ControlIWant.encode(l.iwant[f],d.uint32(18).fork()).ldelim();if(l.graft!=null&&l.graft.length)for(var f=0;f<l.graft.length;++f)i.RPC.ControlGraft.encode(l.graft[f],d.uint32(26).fork()).ldelim();if(l.prune!=null&&l.prune.length)for(var f=0;f<l.prune.length;++f)i.RPC.ControlPrune.encode(l.prune[f],d.uint32(34).fork()).ldelim();return d},c.decode=function(l,d){l instanceof t||(l=t.create(l));for(var f=d===void 0?l.len:l.pos+d,g=new i.RPC.ControlMessage;l.pos<f;){var h=l.uint32();switch(h>>>3){case 1:g.ihave&&g.ihave.length||(g.ihave=[]),g.ihave.push(i.RPC.ControlIHave.decode(l,l.uint32()));break;case 2:g.iwant&&g.iwant.length||(g.iwant=[]),g.iwant.push(i.RPC.ControlIWant.decode(l,l.uint32()));break;case 3:g.graft&&g.graft.length||(g.graft=[]),g.graft.push(i.RPC.ControlGraft.decode(l,l.uint32()));break;case 4:g.prune&&g.prune.length||(g.prune=[]),g.prune.push(i.RPC.ControlPrune.decode(l,l.uint32()));break;default:l.skipType(h&7);break}}return g},c.fromObject=function(l){if(l instanceof i.RPC.ControlMessage)return l;var d=new i.RPC.ControlMessage;if(l.ihave){if(!Array.isArray(l.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");d.ihave=[];for(var f=0;f<l.ihave.length;++f){if(typeof l.ihave[f]!="object")throw TypeError(".RPC.ControlMessage.ihave: object expected");d.ihave[f]=i.RPC.ControlIHave.fromObject(l.ihave[f])}}if(l.iwant){if(!Array.isArray(l.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");d.iwant=[];for(var f=0;f<l.iwant.length;++f){if(typeof l.iwant[f]!="object")throw TypeError(".RPC.ControlMessage.iwant: object expected");d.iwant[f]=i.RPC.ControlIWant.fromObject(l.iwant[f])}}if(l.graft){if(!Array.isArray(l.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");d.graft=[];for(var f=0;f<l.graft.length;++f){if(typeof l.graft[f]!="object")throw TypeError(".RPC.ControlMessage.graft: object expected");d.graft[f]=i.RPC.ControlGraft.fromObject(l.graft[f])}}if(l.prune){if(!Array.isArray(l.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");d.prune=[];for(var f=0;f<l.prune.length;++f){if(typeof l.prune[f]!="object")throw TypeError(".RPC.ControlMessage.prune: object expected");d.prune[f]=i.RPC.ControlPrune.fromObject(l.prune[f])}}return d},c.toObject=function(l,d){d||(d={});var f={};if((d.arrays||d.defaults)&&(f.ihave=[],f.iwant=[],f.graft=[],f.prune=[]),l.ihave&&l.ihave.length){f.ihave=[];for(var g=0;g<l.ihave.length;++g)f.ihave[g]=i.RPC.ControlIHave.toObject(l.ihave[g],d)}if(l.iwant&&l.iwant.length){f.iwant=[];for(var g=0;g<l.iwant.length;++g)f.iwant[g]=i.RPC.ControlIWant.toObject(l.iwant[g],d)}if(l.graft&&l.graft.length){f.graft=[];for(var g=0;g<l.graft.length;++g)f.graft[g]=i.RPC.ControlGraft.toObject(l.graft[g],d)}if(l.prune&&l.prune.length){f.prune=[];for(var g=0;g<l.prune.length;++g)f.prune[g]=i.RPC.ControlPrune.toObject(l.prune[g],d)}return f},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlIHave=function(){function c(l){if(this.messageIDs=[],l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.topicID=null,c.prototype.messageIDs=s.emptyArray;var u;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(u=["topicID"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){if(f||(f=n.create()),d.topicID!=null&&Object.hasOwnProperty.call(d,"topicID")&&f.uint32(10).string(d.topicID),d.messageIDs!=null&&d.messageIDs.length)for(var g=0;g<d.messageIDs.length;++g)f.uint32(18).bytes(d.messageIDs[g]);return f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.ControlIHave;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.topicID=d.string();break;case 2:h.messageIDs&&h.messageIDs.length||(h.messageIDs=[]),h.messageIDs.push(d.bytes());break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.ControlIHave)return d;var f=new i.RPC.ControlIHave;if(d.topicID!=null&&(f.topicID=String(d.topicID)),d.messageIDs){if(!Array.isArray(d.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");f.messageIDs=[];for(var g=0;g<d.messageIDs.length;++g)typeof d.messageIDs[g]=="string"?s.base64.decode(d.messageIDs[g],f.messageIDs[g]=s.newBuffer(s.base64.length(d.messageIDs[g])),0):d.messageIDs[g].length&&(f.messageIDs[g]=d.messageIDs[g])}return f},c.toObject=function(d,f){f||(f={});var g={};if((f.arrays||f.defaults)&&(g.messageIDs=[]),d.topicID!=null&&d.hasOwnProperty("topicID")&&(g.topicID=d.topicID,f.oneofs&&(g._topicID="topicID")),d.messageIDs&&d.messageIDs.length){g.messageIDs=[];for(var h=0;h<d.messageIDs.length;++h)g.messageIDs[h]=f.bytes===String?s.base64.encode(d.messageIDs[h],0,d.messageIDs[h].length):f.bytes===Array?Array.prototype.slice.call(d.messageIDs[h]):d.messageIDs[h]}return g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlIWant=function(){function c(u){if(this.messageIDs=[],u)for(var l=Object.keys(u),d=0;d<l.length;++d)u[l[d]]!=null&&(this[l[d]]=u[l[d]])}return c.prototype.messageIDs=s.emptyArray,c.encode=function(l,d){if(d||(d=n.create()),l.messageIDs!=null&&l.messageIDs.length)for(var f=0;f<l.messageIDs.length;++f)d.uint32(10).bytes(l.messageIDs[f]);return d},c.decode=function(l,d){l instanceof t||(l=t.create(l));for(var f=d===void 0?l.len:l.pos+d,g=new i.RPC.ControlIWant;l.pos<f;){var h=l.uint32();switch(h>>>3){case 1:g.messageIDs&&g.messageIDs.length||(g.messageIDs=[]),g.messageIDs.push(l.bytes());break;default:l.skipType(h&7);break}}return g},c.fromObject=function(l){if(l instanceof i.RPC.ControlIWant)return l;var d=new i.RPC.ControlIWant;if(l.messageIDs){if(!Array.isArray(l.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");d.messageIDs=[];for(var f=0;f<l.messageIDs.length;++f)typeof l.messageIDs[f]=="string"?s.base64.decode(l.messageIDs[f],d.messageIDs[f]=s.newBuffer(s.base64.length(l.messageIDs[f])),0):l.messageIDs[f].length&&(d.messageIDs[f]=l.messageIDs[f])}return d},c.toObject=function(l,d){d||(d={});var f={};if((d.arrays||d.defaults)&&(f.messageIDs=[]),l.messageIDs&&l.messageIDs.length){f.messageIDs=[];for(var g=0;g<l.messageIDs.length;++g)f.messageIDs[g]=d.bytes===String?s.base64.encode(l.messageIDs[g],0,l.messageIDs[g].length):d.bytes===Array?Array.prototype.slice.call(l.messageIDs[g]):l.messageIDs[g]}return f},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlGraft=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.topicID=null;var u;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(u=["topicID"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.topicID!=null&&Object.hasOwnProperty.call(d,"topicID")&&f.uint32(10).string(d.topicID),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.ControlGraft;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.topicID=d.string();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.ControlGraft)return d;var f=new i.RPC.ControlGraft;return d.topicID!=null&&(f.topicID=String(d.topicID)),f},c.toObject=function(d,f){f||(f={});var g={};return d.topicID!=null&&d.hasOwnProperty("topicID")&&(g.topicID=d.topicID,f.oneofs&&(g._topicID="topicID")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlPrune=function(){function c(l){if(this.peers=[],l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.topicID=null,c.prototype.peers=s.emptyArray,c.prototype.backoff=null;var u;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(u=["topicID"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_backoff",{get:s.oneOfGetter(u=["backoff"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){if(f||(f=n.create()),d.topicID!=null&&Object.hasOwnProperty.call(d,"topicID")&&f.uint32(10).string(d.topicID),d.peers!=null&&d.peers.length)for(var g=0;g<d.peers.length;++g)i.RPC.PeerInfo.encode(d.peers[g],f.uint32(18).fork()).ldelim();return d.backoff!=null&&Object.hasOwnProperty.call(d,"backoff")&&f.uint32(24).uint64(d.backoff),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.ControlPrune;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.topicID=d.string();break;case 2:h.peers&&h.peers.length||(h.peers=[]),h.peers.push(i.RPC.PeerInfo.decode(d,d.uint32()));break;case 3:h.backoff=d.uint64();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.ControlPrune)return d;var f=new i.RPC.ControlPrune;if(d.topicID!=null&&(f.topicID=String(d.topicID)),d.peers){if(!Array.isArray(d.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");f.peers=[];for(var g=0;g<d.peers.length;++g){if(typeof d.peers[g]!="object")throw TypeError(".RPC.ControlPrune.peers: object expected");f.peers[g]=i.RPC.PeerInfo.fromObject(d.peers[g])}}return d.backoff!=null&&(s.Long?(f.backoff=s.Long.fromValue(d.backoff)).unsigned=!0:typeof d.backoff=="string"?f.backoff=parseInt(d.backoff,10):typeof d.backoff=="number"?f.backoff=d.backoff:typeof d.backoff=="object"&&(f.backoff=new s.LongBits(d.backoff.low>>>0,d.backoff.high>>>0).toNumber(!0))),f},c.toObject=function(d,f){f||(f={});var g={};if((f.arrays||f.defaults)&&(g.peers=[]),d.topicID!=null&&d.hasOwnProperty("topicID")&&(g.topicID=d.topicID,f.oneofs&&(g._topicID="topicID")),d.peers&&d.peers.length){g.peers=[];for(var h=0;h<d.peers.length;++h)g.peers[h]=i.RPC.PeerInfo.toObject(d.peers[h],f)}return d.backoff!=null&&d.hasOwnProperty("backoff")&&(typeof d.backoff=="number"?g.backoff=f.longs===String?String(d.backoff):d.backoff:g.backoff=f.longs===String?s.Long.prototype.toString.call(d.backoff):f.longs===Number?new s.LongBits(d.backoff.low>>>0,d.backoff.high>>>0).toNumber(!0):d.backoff,f.oneofs&&(g._backoff="backoff")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.PeerInfo=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.peerID=null,c.prototype.signedPeerRecord=null;var u;return Object.defineProperty(c.prototype,"_peerID",{get:s.oneOfGetter(u=["peerID"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_signedPeerRecord",{get:s.oneOfGetter(u=["signedPeerRecord"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.peerID!=null&&Object.hasOwnProperty.call(d,"peerID")&&f.uint32(10).bytes(d.peerID),d.signedPeerRecord!=null&&Object.hasOwnProperty.call(d,"signedPeerRecord")&&f.uint32(18).bytes(d.signedPeerRecord),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.PeerInfo;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.peerID=d.bytes();break;case 2:h.signedPeerRecord=d.bytes();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.PeerInfo)return d;var f=new i.RPC.PeerInfo;return d.peerID!=null&&(typeof d.peerID=="string"?s.base64.decode(d.peerID,f.peerID=s.newBuffer(s.base64.length(d.peerID)),0):d.peerID.length&&(f.peerID=d.peerID)),d.signedPeerRecord!=null&&(typeof d.signedPeerRecord=="string"?s.base64.decode(d.signedPeerRecord,f.signedPeerRecord=s.newBuffer(s.base64.length(d.signedPeerRecord)),0):d.signedPeerRecord.length&&(f.signedPeerRecord=d.signedPeerRecord)),f},c.toObject=function(d,f){f||(f={});var g={};return d.peerID!=null&&d.hasOwnProperty("peerID")&&(g.peerID=f.bytes===String?s.base64.encode(d.peerID,0,d.peerID.length):f.bytes===Array?Array.prototype.slice.call(d.peerID):d.peerID,f.oneofs&&(g._peerID="peerID")),d.signedPeerRecord!=null&&d.hasOwnProperty("signedPeerRecord")&&(g.signedPeerRecord=f.bytes===String?s.base64.encode(d.signedPeerRecord,0,d.signedPeerRecord.length):f.bytes===Array?Array.prototype.slice.call(d.signedPeerRecord):d.signedPeerRecord,f.oneofs&&(g._signedPeerRecord="signedPeerRecord")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o}(),i})})(Jj);const aK=B1,{RPC:Cu}=aK,ic=1e3,M2=60*ic,e5="/floodsub/1.0.0",t5="/meshsub/1.0.0",N7="/meshsub/1.1.0",cK=6,lK=4,uK=12,dK=4,hK=2,fK=5,pK=3,gK=6,yK=.25,wK=3,r5=100,mK=ic,bK=M2,EK=16,_K=M2,vK=15,SK=300,RK=ic,IK=60,AK=2,CK=10*ic,bi=5e3,TK=10,DK=3*ic,PK=2*M2,kK=120*1e3,OK="ERR_TOPIC_VALIDATOR_REJECT",NK="ERR_TOPIC_VALIDATOR_IGNORE",xK=0,$K=128,LK=1e3,MK=1e3;function an(r=[],e){return{subscriptions:[],messages:r,control:e?{graft:e.graft||[],prune:e.prune||[],ihave:e.ihave||[],iwant:e.iwant||[]}:void 0}}function cn(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function U2(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function x7(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?U2(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function $7(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const n5=$7("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Mh=$7("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=x7(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),L7={utf8:n5,"utf-8":n5,hex:yl.base16,latin1:Mh,ascii:Mh,binary:Mh,...yl};function B2(r,e="utf8"){const t=L7[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}function UK(r){return B2(r,"base64")}const Tu="StrictSign",z2="StrictNoSign";var s5;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(s5||(s5={}));var eo;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(eo||(eo={}));var bn;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(bn||(bn={}));var Tr;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Tr||(Tr={}));var Mt;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(Mt||(Mt={}));var Er;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(Er||(Er={}));function i5(r){switch(r){case bn.Ignore:return Tr.Ignore;case bn.Reject:return Tr.Reject}}async function BK(r,e){switch(r){case Tu:{if(!e)throw Error("Must provide PeerId");if(e.privateKey==null)throw Error("Cannot sign message, no private key present");if(e.publicKey==null)throw Error("Cannot sign message, no public key present");const t=await oi(e.privateKey);return{type:eo.Signing,author:e,key:e.publicKey,privateKey:t}}case z2:return{type:eo.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}const Ee="ERR_INVALID_PEER_SCORE_PARAMS",zK={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},FK={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function VK(r={}){return{...zK,...r,topics:r.topics?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=jK(n),e),{}):{}}}function jK(r={}){return{...FK,...r}}function KK(r){for(const[e,t]of Object.entries(r.topics))try{qK(t)}catch(n){throw E(new Error(`invalid score parameters for topic ${e}: ${n.message}`),Ee)}if(r.topicScoreCap<0)throw E(new Error("invalid topic score cap; must be positive (or 0 for no cap)"),Ee);if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw E(new Error("missing application specific score function"),Ee);if(r.IPColocationFactorWeight>0)throw E(new Error("invalid IPColocationFactorWeight; must be negative (or 0 to disable)"),Ee);if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw E(new Error("invalid IPColocationFactorThreshold; must be at least 1"),Ee);if(r.behaviourPenaltyWeight>0)throw E(new Error("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)"),Ee);if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw E(new Error("invalid BehaviourPenaltyDecay; must be between 0 and 1"),Ee);if(r.decayInterval<1e3)throw E(new Error("invalid DecayInterval; must be at least 1s"),Ee);if(r.decayToZero<=0||r.decayToZero>=1)throw E(new Error("invalid DecayToZero; must be between 0 and 1"),Ee)}function qK(r){if(r.topicWeight<0)throw E(new Error("invalid topic weight; must be >= 0"),Ee);if(r.timeInMeshQuantum===0)throw E(new Error("invalid TimeInMeshQuantum; must be non zero"),Ee);if(r.timeInMeshWeight<0)throw E(new Error("invalid TimeInMeshWeight; must be positive (or 0 to disable)"),Ee);if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw E(new Error("invalid TimeInMeshQuantum; must be positive"),Ee);if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw E(new Error("invalid TimeInMeshCap; must be positive"),Ee);if(r.firstMessageDeliveriesWeight<0)throw E(new Error("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)"),Ee);if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw E(new Error("invalid FirstMessageDeliveriesDecay; must be between 0 and 1"),Ee);if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw E(new Error("invalid FirstMessageDeliveriesCap; must be positive"),Ee);if(r.meshMessageDeliveriesWeight>0)throw E(new Error("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)"),Ee);if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw E(new Error("invalid MeshMessageDeliveriesDecay; must be between 0 and 1"),Ee);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw E(new Error("invalid MeshMessageDeliveriesCap; must be positive"),Ee);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw E(new Error("invalid MeshMessageDeliveriesThreshold; must be positive"),Ee);if(r.meshMessageDeliveriesWindow<0)throw E(new Error("invalid MeshMessageDeliveriesWindow; must be non-negative"),Ee);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw E(new Error("invalid MeshMessageDeliveriesActivation; must be at least 1s"),Ee);if(r.meshFailurePenaltyWeight>0)throw E(new Error("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)"),Ee);if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw E(new Error("invalid MeshFailurePenaltyDecay; must be between 0 and 1"),Ee);if(r.invalidMessageDeliveriesWeight>0)throw E(new Error("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)"),Ee);if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw E(new Error("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1"),Ee)}const HK={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function GK(r={}){return{...HK,...r}}function WK(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let u=0;if(a.inMesh){let g=a.meshTime/c.timeInMeshQuantum;g>c.timeInMeshCap&&(g=c.timeInMeshCap),u+=g*c.timeInMeshWeight}let l=a.firstMessageDeliveries;if(l>c.firstMessageDeliveriesCap&&(l=c.firstMessageDeliveriesCap),u+=l*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const g=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,h=g*g;u+=h*c.meshMessageDeliveriesWeight}const d=a.meshFailurePenalty;u+=d*c.meshFailurePenaltyWeight;const f=a.invalidMessageDeliveries*a.invalidMessageDeliveries;u+=f*c.invalidMessageDeliveriesWeight,s+=u*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);const i=t.appSpecificScore(r);if(s+=i*t.appSpecificWeight,e.ips.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a?a.size:0;if(c>t.IPColocationFactorThreshold){const u=c-t.IPColocationFactorThreshold,l=u*u;s+=l*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;s+=a*t.behaviourPenaltyWeight}return s}function Ve(r,t){var t=t||{};this._head=0,this._tail=0,this._capacity=t.capacity,this._capacityMask=3,this._list=new Array(4),Array.isArray(r)&&this._fromArray(r)}Ve.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};Ve.prototype.get=function(e){return this.peekAt(e)};Ve.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};Ve.prototype.peekFront=function(){return this.peek()};Ve.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(Ve.prototype,"length",{get:function(){return this.size()}});Ve.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ve.prototype.unshift=function(e){if(e===void 0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ve.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};Ve.prototype.push=function(e){if(e===void 0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ve.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};Ve.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var i=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};Ve.prototype.remove=function(e,t){var n=e,s,i=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=o)return s=this.toArray(),this.clear(),s;n+t>o&&(t=o-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;i>0;)this._list[n=n-1+a&this._capacityMask]=void 0,i--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;i>0;)this._list[n=n+1+a&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};Ve.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var i,o,a,c=arguments.length,u=this._list.length,l=2;if(!s||n<s/2){for(o=new Array(n),i=0;i<n;i++)o[i]=this._list[this._head+i&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+u&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+u&this._capacityMask);c>l;)this.unshift(arguments[--c]);for(i=n;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(n+t));var d=o.length;for(i=0;i<d;i++)o[i]=this._list[this._head+n+t+i&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+u&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-d+u&this._capacityMask);l<c;)this.push(arguments[l++]);for(i=0;i<d;i++)this.push(o[i])}return a}else return this.remove(n,t)}};Ve.prototype.clear=function(){this._head=0,this._tail=0};Ve.prototype.isEmpty=function(){return this._head===this._tail};Ve.prototype.toArray=function(){return this._copyArray(!1)};Ve.prototype._fromArray=function(e){for(var t=0;t<e.length;t++)this.push(e[t])};Ve.prototype._copyArray=function(e){var t=[],n=this._list,s=n.length,i;if(e||this._head>this._tail){for(i=this._head;i<s;i++)t.push(n[i]);for(i=0;i<this._tail;i++)t.push(n[i])}else for(i=this._head;i<this._tail;i++)t.push(n[i]);return t};Ve.prototype._growArray=function(){this._head&&(this._list=this._copyArray(!0),this._head=0),this._tail=this._list.length,this._list.length<<=1,this._capacityMask=this._capacityMask<<1|1};Ve.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};var YK=Ve,Ut;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(Ut||(Ut={}));class QK{constructor(){this.records=new Map,this.queue=new YK}ensureRecord(e){let t=this.records.get(e);if(t)return t;t={status:Ut.unknown,firstSeen:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+kK};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}function Gt(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}function kt(r){return r!=null&&typeof r.init=="function"}class M7{constructor(e={}){this.started=!1,e.peerId!=null&&this.setPeerId(e.peerId),e.addressManager!=null&&this.setAddressManager(e.addressManager),e.peerStore!=null&&this.setPeerStore(e.peerStore),e.upgrader!=null&&this.setUpgrader(e.upgrader),e.metrics!=null&&this.setMetrics(e.metrics),e.registrar!=null&&this.setRegistrar(e.registrar),e.connectionManager!=null&&this.setConnectionManager(e.connectionManager),e.transportManager!=null&&this.setTransportManager(e.transportManager),e.connectionGater!=null&&this.setConnectionGater(e.connectionGater),e.contentRouting!=null&&this.setContentRouting(e.contentRouting),e.peerRouting!=null&&this.setPeerRouting(e.peerRouting),e.datastore!=null&&this.setDatastore(e.datastore),e.connectionProtector!=null&&this.setConnectionProtector(e.connectionProtector),e.dht!=null&&this.setDHT(e.dht),e.pubsub!=null&&this.setPubSub(e.pubsub),e.dialer!=null&&this.setDialer(e.dialer)}isStarted(){return this.started}async beforeStart(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.beforeStart!=null&&await e.beforeStart()}))}async start(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{await e.start()})),this.started=!0}async afterStart(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async beforeStop(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.beforeStop!=null&&await e.beforeStop()}))}async stop(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{await e.stop()})),this.started=!1}async afterStop(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.afterStop!=null&&await e.afterStop()}))}setPeerId(e){return this.peerId=e,e}getPeerId(){if(this.peerId==null)throw E(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this.peerId}setMetrics(e){return this.metrics=e,kt(e)&&e.init(this),e}getMetrics(){return this.metrics}setAddressManager(e){return this.addressManager=e,kt(e)&&e.init(this),e}getAddressManager(){if(this.addressManager==null)throw E(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this.addressManager}setPeerStore(e){return this.peerStore=e,kt(e)&&e.init(this),e}getPeerStore(){if(this.peerStore==null)throw E(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this.peerStore}setUpgrader(e){return this.upgrader=e,kt(e)&&e.init(this),e}getUpgrader(){if(this.upgrader==null)throw E(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this.upgrader}setRegistrar(e){return this.registrar=e,kt(e)&&e.init(this),e}getRegistrar(){if(this.registrar==null)throw E(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this.registrar}setConnectionManager(e){return this.connectionManager=e,kt(e)&&e.init(this),e}getConnectionManager(){if(this.connectionManager==null)throw E(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this.connectionManager}setTransportManager(e){return this.transportManager=e,kt(e)&&e.init(this),e}getTransportManager(){if(this.transportManager==null)throw E(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this.transportManager}setConnectionGater(e){return this.connectionGater=e,kt(e)&&e.init(this),e}getConnectionGater(){if(this.connectionGater==null)throw E(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this.connectionGater}setContentRouting(e){return this.contentRouting=e,kt(e)&&e.init(this),e}getContentRouting(){if(this.contentRouting==null)throw E(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this.contentRouting}setPeerRouting(e){return this.peerRouting=e,kt(e)&&e.init(this),e}getPeerRouting(){if(this.peerRouting==null)throw E(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this.peerRouting}setDatastore(e){return this.datastore=e,kt(e)&&e.init(this),e}getDatastore(){if(this.datastore==null)throw E(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this.datastore}setConnectionProtector(e){return this.connectionProtector=e,kt(e)&&e.init(this),e}getConnectionProtector(){return this.connectionProtector}setDHT(e){return this.dht=e,kt(e)&&e.init(this),e}getDHT(){if(this.dht==null)throw E(new Error("dht not set"),"ERR_SERVICE_MISSING");return this.dht}setPubSub(e){return this.pubsub=e,kt(e)&&e.init(this),e}getPubSub(){if(this.pubsub==null)throw E(new Error("pubsub not set"),"ERR_SERVICE_MISSING");return this.pubsub}setDialer(e){return this.dialer=e,kt(e)&&e.init(this),e}getDialer(){if(this.dialer==null)throw E(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this.dialer}}const Ei=O("libp2p:gossipsub:score");class JK{constructor(e,t,n){this.params=e,this.metrics=t,this.peerStats=new Map,this.peerIPs=new Map,this.scoreCache=new Map,this.deliveryRecords=new QK,this.components=new M7,KK(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=n.computeScore??WK}init(e){this.components=e}get size(){return this.peerStats.size}start(){if(this._backgroundInterval){Ei("Peer score already running");return}this._backgroundInterval=setInterval(()=>this.background(),this.params.decayInterval),Ei("started")}stop(){if(!this._backgroundInterval){Ei("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),Ei("stopped")}background(){this.refreshScores(),this.updateIPs(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPs(s,n.ips),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(!t)return 0;const n=Date.now(),s=this.scoreCache.get(e);if(s&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(e,{score:i,cacheUntil:o}),i}addPenalty(e,t,n){const s=this.peerStats.get(e);s&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},ips:[],behaviourPenalty:0};this.peerStats.set(e,t);const n=this.getIPs(e);this.setIPs(e,n,t.ips),t.ips=n}removePeer(e){const t=this.peerStats.get(e);if(t){if(this.score(e)>0){this.removeIPs(e,t.ips),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);s&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);if(s){const i=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const s=this.deliveryRecords.ensureRecord(t),i=Date.now();if(s.status!==Ut.unknown){Ei("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-s.firstSeen,Ut[s.status]);return}s.status=Ut.valid,s.validated=i,s.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case Tr.Error:this.markInvalidMessageDelivery(e,n);return;case Tr.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status!==Ut.unknown){Ei("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeen,Ut[i.status]);return}if(s===Tr.Ignore){i.status=Ut.ignored,i.peers.clear();return}i.status=Ut.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),i.peers.clear()}duplicateMessage(e,t,n){const s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case Ut.unknown:s.peers.add(e);break;case Ut.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case Ut.invalid:this.markInvalidMessageDelivery(e,n);break;case Ut.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);s&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);if(s){let i=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const s=this.peerStats.get(e);if(s){const i=n!==void 0?Date.now():0,o=this.getPtopicStats(s,t);if(o&&o.inMesh){const a=this.params.topics[t];if(n!==void 0){const u=i-n,l=u>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,u,l),l)return}const c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}getIPs(e){return this.components.getConnectionManager().getConnections(re(e)).map(t=>t.remoteAddr.toOptions().host)}setIPs(e,t,n){e:for(const s of t){for(const o of n)if(s===o)continue e;let i=this.peerIPs.get(s);i||(i=new Set,this.peerIPs.set(s,i)),i.add(e)}e:for(const s of n){for(const o of t)if(s===o)continue e;const i=this.peerIPs.get(s);i&&(i.delete(e),i.size||this.peerIPs.delete(s))}}removeIPs(e,t){t.forEach(n=>{const s=this.peerIPs.get(n);s&&(s.delete(e),s.size||this.peerIPs.delete(n))})}updateIPs(){this.peerStats.forEach((e,t)=>{const n=this.getIPs(t);this.setIPs(t,n,e.ips),e.ips=n})}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}class XK{constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.promises=new Map,this.requestMsByMsg=new Map,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),s=t[n],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o||(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size||this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e){this.trackMessage(e);const t=this.promises.get(e);t&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(t.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case Tr.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;for(const[t,n]of this.requestMsByMsg.entries())if(n<e)this.requestMsByMsg.delete(t);else break}trackMessage(e){if(this.metrics){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}class Uh{constructor(e){this.entries=new Map,this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs})}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var o5;(function(r){r.forward="forward",r.publish="publish"})(o5||(o5={}));var cs;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(cs||(cs={}));var Ti;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Unsub="unsubscribed",r.Excess="excess"})(Ti||(Ti={}));var ma;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(ma||(ma={}));var ba;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(ba||(ba={}));var Di;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(Di||(Di={}));function ZK(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEvents:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_total",help:"Number of times we include peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),meshPeerChurnEvents:r.gauge({name:"gossipsub_peer_churn_events_total",help:"Number of times we remove peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),asyncValidationResult:r.gauge({name:"gossipsub_async_validation_result_total",help:"Message validation result for each topic",labelNames:["topic","acceptance"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeers:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),msgPublishPeersByGroup:r.gauge({name:"gossipsub_msg_publish_peers_by_group",help:"Total count of peers (by group) that we publish a msg to",labelNames:["topic","peerGroup"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedStatus:r.gauge({name:"gossipsub_msg_received_status_total",help:"Tracks distribution of recv msgs by duplicate, invalid, valid",labelNames:["topic","status"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["topic","error"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,1*t.maxMeshMessageDeliveriesWindowSec,2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores",labelNames:["topic","p"]}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,1*t.behaviourPenaltyThreshold,2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,1*t.gossipPromiseExpireSec,2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,i){const o=this.toTopic(n);this.meshPeerInclusionEvents.inc({topic:o,reason:s},i)},onRemoveFromMesh(n,s,i){const o=this.toTopic(n);this.meshPeerChurnEvents.inc({topic:o,reason:s},i)},onReportValidationMcacheHit(n){this.asyncValidationMcacheHit.inc({hit:n?"hit":"miss"})},onReportValidation(n,s){const i=this.toTopic(n);this.asyncValidationResult.inc({topic:i,acceptance:s})},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,i){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(n,s){for(const[i,o]of n){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){const i=this.toTopic(n);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(n,s,i,o){const a=this.toTopic(n);this.msgPublishCount.inc({topic:a},1),this.msgPublishBytes.inc({topic:a},i*o),this.msgPublishPeers.inc({topic:a},i),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"direct"},s.direct),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"floodsub"},s.floodsub),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"mesh"},s.mesh),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"fanout"},s.fanout)},onMsgRecvPreValidation(n){const s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvResult(n,s){const i=this.toTopic(n);this.msgReceivedStatus.inc({topic:i,status:s})},onMsgRecvInvalid(n,s){const i=this.toTopic(n),o=s.reason===Tr.Error?s.error:s.reason;this.msgReceivedInvalid.inc({topic:i,error:o},1)},onDuplicateMsgDelivery(n,s,i){if(this.duplicateMsgDeliveryDelay.observe(s/1e3),i){const o=this.toTopic(n);this.duplicateMsgLateDelivery.inc({topic:o},1)}},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages&&this.rpcRecvMessage.inc(n.messages.length),n.control&&(this.rpcRecvControl.inc(1),n.control.ihave&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages&&this.rpcSentMessage.inc(n.messages.length),n.control){const i=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),(i>0||o>0||a>0||c>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let i=0,o=0,a=0,c=0;for(const u of n)u>=s.graylistThreshold&&i++,u>=s.publishThreshold&&o++,u>=s.gossipThreshold&&a++,u>=0&&c++;this.peersByScoreThreshold.set({threshold:Di.graylist},i),this.peersByScoreThreshold.set({threshold:Di.publish},o),this.peersByScoreThreshold.set({threshold:Di.gossip},a),this.peersByScoreThreshold.set({threshold:Di.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[s,i]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){const i=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let u=i.get(c);u||(u=new Set,i.set(c,u)),o.forEach(l=>u?.add(l))});for(const[o,a]of i){const c=[];a.forEach(u=>{c.push(s.get(u)??0)}),this.scorePerMesh.set({topic:o},c)}}}}function U7(r,e){e||(e=r.reduce((s,i)=>s+i.length,0));const t=x7(e);let n=0;for(const s of r)t.set(s,n),n+=s.length;return U2(t)}function eq(r,e="utf8"){const t=L7[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?U2(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}function tq(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}const B7=eq("libp2p-pubsub:");async function rq(r,e,t,n){switch(r.type){case eo.Signing:{const s={from:r.author.toBytes(),data:n,seqno:id(8),topic:e,signature:void 0,key:void 0},i=U7([B7,Cu.Message.encode(s).finish()]);s.signature=await r.privateKey.sign(i),s.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${B2(s.seqno,"base16")}`),topic:e,signature:s.signature,key:s.key};return{raw:s,msg:o}}case eo.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}}}}async function nq(r,e){switch(r){case z2:return e.signature!=null?{valid:!1,error:Mt.SignaturePresent}:e.seqno!=null?{valid:!1,error:Mt.SeqnoPresent}:e.key!=null?{valid:!1,error:Mt.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case Tu:{if(e.seqno==null)return{valid:!1,error:Mt.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:Mt.InvalidSeqno};if(e.signature==null)return{valid:!1,error:Mt.InvalidSignature};if(e.from==null)return{valid:!1,error:Mt.InvalidPeerId};let t;try{t=Xr(e.from)}catch{return{valid:!1,error:Mt.InvalidPeerId}}let n;if(e.key){if(n=Ki(e.key),t.publicKey!==void 0&&!tq(n.bytes,t.publicKey))return{valid:!1,error:Mt.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:Mt.InvalidPeerId};n=Ki(t.publicKey)}const s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},i=U7([B7,Cu.Message.encode(s).finish()]);return await n.verify(i,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${B2(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key??_0(n)}}:{valid:!1,error:Mt.InvalidSignature}}}}function z7(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function sq(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?z7(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function F7(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const a5=F7("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Bh=F7("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=sq(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),iq={utf8:a5,"utf-8":a5,hex:yl.base16,latin1:Bh,ascii:Bh,binary:Bh,...yl};function oq(r,e="utf8"){const t=iq[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?z7(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}const aq=(r,e)=>{const t=oq(e.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n};function cq(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return aq(r.from.toBytes(),r.sequenceNumber)}async function lq(r){return await sE.encode(r.data)}function uq(r,e,t,n,s){let i=0;const o=new Map;if(Object.entries(e.topics).forEach(([f,g])=>{const h=s.get(f)??"unknown",p=t.topics[f];if(p===void 0)return;let w=o.get(h);w||(w={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(h,w));let y=0,_=0,b=0,m=0,S=0;if(g.inMesh){const C=Math.max(g.meshTime/p.timeInMeshQuantum,p.timeInMeshCap);y+=C*p.timeInMeshWeight}let R=g.firstMessageDeliveries;if(R>p.firstMessageDeliveriesCap&&(R=p.firstMessageDeliveriesCap),_+=R*p.firstMessageDeliveriesWeight,g.meshMessageDeliveriesActive&&g.meshMessageDeliveries<p.meshMessageDeliveriesThreshold){const C=p.meshMessageDeliveriesThreshold-g.meshMessageDeliveries,P=C*C;b+=P*p.meshMessageDeliveriesWeight}const v=g.meshFailurePenalty;m+=v*p.meshFailurePenaltyWeight;const A=g.invalidMessageDeliveries*g.invalidMessageDeliveries;S+=A*p.invalidMessageDeliveriesWeight,i+=(y+_+b+m+S)*p.topicWeight,w.p1w+=y,w.p2w+=_,w.p3w+=b,w.p3bw+=m,w.p4w+=S}),t.topicScoreCap>0&&i>t.topicScoreCap){i=t.topicScoreCap;const f=t.topicScoreCap/i;for(const g of o.values())g.p1w*=f,g.p2w*=f,g.p3w*=f,g.p3bw*=f,g.p4w*=f}let a=0,c=0,u=0;const l=t.appSpecificScore(r);a+=l*t.appSpecificWeight,e.ips.forEach(f=>{if(t.IPColocationFactorWhitelist.has(f))return;const g=n.get(f),h=g?g.size:0;if(h>t.IPColocationFactorThreshold){const p=h-t.IPColocationFactorThreshold,w=p*p;c+=w*t.IPColocationFactorWeight}});const d=e.behaviourPenalty*e.behaviourPenalty;return u+=d*t.behaviourPenaltyWeight,i+=a+c+u,{byTopic:o,p5w:a,p6w:c,p7w:u,score:i}}function dq(r,e,t,n,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a){const c=uq(o,a,t,n,s);for(const[u,l]of c.byTopic){let d=i.byTopic.get(u);d||(d={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(u,d)),d.p1w.push(l.p1w),d.p2w.push(l.p2w),d.p3w.push(l.p3w),d.p3bw.push(l.p3bw),d.p4w.push(l.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}function z1(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function hq(r,e){return z1(r,e,()=>!0)}class fq{constructor(e,t,n){this.rawStream=e,this.pushable=dr({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,ne(Ps(this.pushable,this.closeController.signal,{returnOnAbort:!0}),Dr(),this.rawStream).catch(t)}get protocol(){return this.rawStream.stat.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}close(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}}class pq{constructor(e){this.rawStream=e,this.closeController=new AbortController,this.source=Ps(ne(this.rawStream,Gr()),this.closeController.signal,{returnOnAbort:!0})}close(){this.closeController.abort(),this.rawStream.close()}}var jt;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(jt||(jt={}));class V7 extends st{constructor(e={}){super(),this.multicodecs=[N7,t5],this.peers=new Set,this.streamsInbound=new Map,this.streamsOutbound=new Map,this.outboundInflightQueue=dr({objectMode:!0}),this.direct=new Set,this.floodsubPeers=new Set,this.acceptFromWhitelist=new Map,this.topics=new Map,this.subscriptions=new Set,this.mesh=new Map,this.fanout=new Map,this.fanoutLastpub=new Map,this.gossip=new Map,this.control=new Map,this.peerhave=new Map,this.iasked=new Map,this.backoff=new Map,this.outbound=new Map,this.topicValidators=new Map,this.heartbeatTicks=0,this.components=new M7,this.directPeerInitial=null,this.status={code:jt.stopped},this.heartbeatTimer=null,this.runHeartbeat=()=>{const n=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(s=>{this.log("Error running heartbeat",s)}).finally(()=>{if(n?.(),this.status.code===jt.started){clearTimeout(this.status.heartbeatTimeout);let s=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;s<this.opts.heartbeatInterval*.25&&(s+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,s)}})};const t={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:cK,Dlo:lK,Dhi:uK,Dscore:dK,Dout:hK,Dlazy:gK,heartbeatInterval:mK,fanoutTTL:bK,mcacheLength:fK,mcacheGossip:pK,seenTTL:PK,gossipsubIWantFollowupMs:DK,prunePeers:EK,pruneBackoff:_K,graftFloodThreshold:CK,opportunisticGraftPeers:AK,opportunisticGraftTicks:IK,directConnectTicks:SK,...e,scoreParams:VK(e.scoreParams),scoreThresholds:GK(e.scoreThresholds)};if(this.globalSignaturePolicy=t.globalSignaturePolicy??Tu,t.fallbackToFloodsub&&this.multicodecs.push(e5),this.log=O(t.debugName??"libp2p:gossipsub"),this.opts=t,this.direct=new Set(t.directPeers.map(n=>n.id.toString())),this.seenCache=new Uh({validityMs:t.seenTTL}),this.publishedMessageIds=new Uh({validityMs:t.seenTTL}),e.msgIdFn)this.msgIdFn=e.msgIdFn;else switch(this.globalSignaturePolicy){case Tu:this.msgIdFn=cq;break;case z2:this.msgIdFn=lq;break}if(e.fastMsgIdFn&&(this.fastMsgIdFn=e.fastMsgIdFn,this.fastMsgIdCache=new Uh({validityMs:t.seenTTL})),this.msgIdToStrFn=e.msgIdToStrFn??UK,this.mcache=e.messageCache||new Qj(t.mcacheGossip,t.mcacheLength,this.msgIdToStrFn),e.dataTransform&&(this.dataTransform=e.dataTransform),e.metricsRegister){if(!e.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const n=Math.max(...Object.values(t.scoreParams.topics).map(i=>i.meshMessageDeliveriesWindow),MK),s=ZK(e.metricsRegister,e.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:t.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:n/1e3});s.mcacheSize.addCollect(()=>this.onScrapeMetrics(s));for(const i of this.multicodecs)s.protocolsEnabled.set({protocol:i},1);this.metrics=s}else this.metrics=null;this.gossipTracer=new XK(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new JK(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:t.heartbeatInterval}),this.maxInboundStreams=e.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams}getPeers(){return[...this.peers.keys()].map(e=>re(e))}isStarted(){return this.status.code===jt.started}async init(e){this.components=e,this.score.init(e)}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await BK(this.globalSignaturePolicy,this.components.getPeerId()),this.outboundInflightQueue=dr({objectMode:!0}),ne(this.outboundInflightQueue,async i=>{for await(const{peerId:o,connection:a}of i)await this.createOutboundStream(o,a)}).catch(i=>this.log.error("outbound inflight queue error",i)),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.getPeerStore().addressBook.add(i.id,i.addrs)}));const e=this.components.getRegistrar();await Promise.all(this.multicodecs.map(i=>e.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams})));const t=L2({onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)}),n=await Promise.all(this.multicodecs.map(i=>e.register(i,t))),s=setTimeout(this.runHeartbeat,r5);this.status={code:jt.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+r5},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>await this.connect(i)))}).catch(i=>{this.log(i)})},RK),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==jt.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:jt.stopped};const t=this.components.getRegistrar();e.forEach(n=>t.unregister(n)),this.outboundInflightQueue.end();for(const n of this.streamsOutbound.values())n.close();this.streamsOutbound.clear();for(const n of this.streamsInbound.values())n.close();this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const n=t.remotePeer;this.addPeer(n,t.stat.direction),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.isStarted()&&(this.addPeer(e,t.stat.direction),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{const s=new fq(await t.newStream(this.multicodecs),o=>this.log.error("outbound pipe error",o),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);const i=s.protocol;i===e5&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}async createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close()),this.log("create inbound stream %s",n);const i=new pq(t);this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch(o=>this.log(o))}addPeer(e,t){const n=e.toString();this.peers.has(n)||(this.log("new peer %p",e),this.peers.add(n),this.score.addPeer(n),this.outbound.has(n)||this.outbound.set(n,t==="outbound"))}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close(),s?.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const i of this.topics.values())i.delete(t);for(const[i,o]of this.mesh)o.delete(t)===!0&&this.metrics?.onRemoveFromMesh(i,Ti.Dc,1);for(const i of this.fanout.values())i.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===jt.started}getMeshPeers(e){const t=this.mesh.get(e);return t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t?Array.from(t):[]).map(n=>re(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await ne(t,async n=>{for await(const s of n)try{const i=s.subarray(),o=Cu.decode(i);this.metrics?.onRpcRecv(o,i.length),this.opts.awaitRpcHandler?await this.handleReceivedRpc(e,o):this.handleReceivedRpc(e,o).catch(a=>this.log(a))}catch(i){this.log(i)}})}catch(n){this.log.error(n),this.onPeerDisconnected(e)}}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}if(this.log("rpc from %p",e),t.subscriptions&&t.subscriptions.length>0&&(t.subscriptions.forEach(n=>{this.handleReceivedSubscription(e,n)}),this.dispatchEvent(new Z("subscription-change",{detail:{peerId:e,subscriptions:t.subscriptions.filter(n=>n.topic!==null).map(n=>({topic:n.topic??"",subscribe:Boolean(n.subscribe)}))}}))),t.messages)for(const n of t.messages){const s=this.handleReceivedMessage(e,n).catch(i=>this.log(i));this.opts.awaitRpcMessageHandler&&await s}t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t){if(t.topic==null)return;this.log("subscription update from %p topic %s",e,t.topic);let n=this.topics.get(t.topic);n==null&&(n=new Set,this.topics.set(t.topic,n)),t.subscribe?n.add(e.toString()):n.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const n=await this.validateReceivedMessage(e,t);switch(this.metrics?.onMsgRecvResult(t.topic,n.code),n.code){case Er.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case Er.invalid:if(n.msgIdStr){const s=n.msgIdStr;this.score.rejectMessage(e.toString(),s,t.topic,n.reason),this.gossipTracer.rejectMessage(s,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case Er.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.getPeerId().equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new Z("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new Z("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString())}}async validateReceivedMessage(e,t){const n=this.fastMsgIdFn?.(t),s=n?this.fastMsgIdCache?.get(n):void 0;if(s)return{code:Er.duplicate,msgIdStr:s};const i=await nq(this.globalSignaturePolicy,t);if(!i.valid)return{code:Er.invalid,reason:Tr.Error,error:i.error};const o=i.message;try{this.dataTransform&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(d){return this.log("Invalid message, transform failed",d),{code:Er.invalid,reason:Tr.Error,error:Mt.TransformFailed}}const a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),u={msgId:a,msgIdStr:c};if(n&&this.fastMsgIdCache?.put(n,c),this.seenCache.has(c))return{code:Er.duplicate,msgIdStr:c};this.seenCache.put(c);const l=this.topicValidators.get(t.topic);if(l!=null){let d;try{d=await l(o.topic,o,e)}catch(f){const g=f.code;g===NK&&(d=bn.Ignore),g===OK?d=bn.Reject:d=bn.Ignore}if(d!==bn.Accept)return{code:Er.invalid,reason:i5(d),msgIdStr:c}}return{code:Er.valid,messageId:u,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n})),messages:[]})}async handleControlMessage(e,t){if(t===void 0)return;const n=t.ihave?this.handleIHave(e,t.ihave):[],s=t.iwant?this.handleIWant(e,t.iwant):[],i=t.graft?await this.handleGraft(e,t.graft):[];t.prune&&await this.handlePrune(e,t.prune),!(!n.length&&!s.length&&!i.length)&&this.sendRpc(e,an(s,{iwant:n,prune:i}))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n&&n.messagesAccepted<$K&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const s=this.score.score(e);return s>=xK?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+LK}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:ba.LowScore}),[];const s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>TK)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:ba.MaxIhave}),[];const i=this.iasked.get(e)??0;if(i>=bi)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:ba.MaxIasked}),[];const o=new Map;if(t.forEach(({topicID:u,messageIDs:l})=>{if(!u||!l||!this.mesh.has(u))return;let d=0;l.forEach(f=>{const g=this.msgIdToStrFn(f);this.seenCache.has(g)||(o.set(g,f),d++)}),this.metrics?.onIhaveRcv(u,l.length,d)}),!o.size)return[];let a=o.size;a+i>bi&&(a=bi-i),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return cn(c),c=c.slice(0,a),this.iasked.set(e,i+a),this.gossipTracer.addPromise(e,c),[{messageIDs:c}]}handleIWant(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];const s=new Map,i=new Map;let o=0;return t.forEach(({messageIDs:a})=>{a&&a.forEach(c=>{const u=this.msgIdToStrFn(c),l=this.mcache.getWithIWantCount(u,e);if(l==null){o++;return}if(i.set(l.msg.topic,1+(i.get(l.msg.topic)??0)),l.count>wK){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(u,l.msg)})}),this.metrics?.onIwantRcv(i,o),s.size?(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}async handleGraft(e,t){const n=[],s=this.score.score(e),i=Date.now();let o=this.opts.doPX;return t.forEach(({topicID:a})=>{if(!a)return;const c=this.mesh.get(a);if(!c){o=!1;return}if(c.has(e))return;if(this.direct.has(e)){this.log("GRAFT: ignoring request from direct peer %s",e),n.push(a),o=!1;return}const u=this.backoff.get(a)?.get(e);if(typeof u=="number"&&i<u){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,ma.GraftBackoff),o=!1;const l=u+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<l&&this.score.addPenalty(e,1,ma.GraftBackoff),this.addBackoff(e,a),n.push(a);return}if(s<0){this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,a),n.push(a),o=!1,this.addBackoff(e,a);return}if(c.size>=this.opts.Dhi&&!this.outbound.get(e)){n.push(a),this.addBackoff(e,a);return}this.log("GRAFT: Add mesh link from %s in %s",e,a),this.score.graft(e,a),c.add(e),this.metrics?.onAddToMesh(a,cs.Subscribed,1)}),n.length?await Promise.all(n.map(a=>this.makePrune(e,a,o))):[]}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:s,backoff:i,peers:o}of t){if(s==null)continue;const a=this.mesh.get(s);if(!a)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,Ti.Unsub,1)),typeof i=="number"&&i>0?this.doAddBackoff(e,s,i*1e3):this.addBackoff(e,s),o&&o.length){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s);continue}await this.pxConnect(o)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s||(s=new Map,this.backoff.set(t,s));const i=Date.now()+n;(s.get(e)??0)<i&&s.set(e,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,ma.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%vK!==0)return;const e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,i)=>{s<e&&t.delete(i)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){const e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>await this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(cn(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map(async n=>{if(!n.peerID)return;const s=Xr(n.peerID).toString();if(!this.peers.has(s)){if(!n.signedPeerRecord){t.push(s);return}try{const i=await Yt.openAndCertify(n.signedPeerRecord,"libp2p-peer-record"),o=i.peerId;if(!i.peerId.equals(s)){this.log("bogus peer record obtained through px: peer ID %p doesn't match expected peer %p",o,s);return}if(!await this.components.getPeerStore().addressBook.consumePeerRecord(i)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(s)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length&&await Promise.all(t.map(async n=>await this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);const t=re(e),n=await this.components.getConnectionManager().openConnection(t);for(const s of this.multicodecs)for(const i of this.components.getRegistrar().getTopologies(s))i.onConnect(t,n)}subscribe(e){if(this.status.code!==jt.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==jt.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e).catch(n=>{this.log(n)})}join(e){if(this.status.code!==jt.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,n=this.fanout.get(e);if(n&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),n.forEach(s=>{!this.direct.has(s)&&this.score.score(s)>=0&&t.add(s)}),this.metrics?.onAddToMesh(e,cs.Fanout,t.size)),t.size<this.opts.D){const s=t.size;this.getRandomGossipPeers(e,this.opts.D,o=>!t.has(o)&&!this.direct.has(o)&&this.score.score(o)>=0).forEach(o=>{t.add(o)}),this.metrics?.onAddToMesh(e,cs.Random,t.size-s)}this.mesh.set(e,t),t.forEach(s=>{this.log("JOIN: Add mesh link to %s in %s",s,e),this.sendGraft(s,e)})}async leave(e){if(this.status.code!==jt.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t&&(await Promise.all(Array.from(t).map(async n=>(this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)))),this.mesh.delete(e))}selectPeersToForward(e,t,n){const s=new Set,i=this.topics.get(e);i&&(this.direct.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&s.add(a)}),this.floodsubPeers.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));const o=this.mesh.get(e);return o&&o.size>0&&o.forEach(a=>{t!==a&&!n?.has(a)&&s.add(a)}),s}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s)if(this.opts.floodPublish)s.forEach(i=>{this.direct.has(i)?(t.add(i),n.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});else{this.direct.forEach(o=>{s.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{s.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});const i=this.mesh.get(e);if(i&&i.size>0)i.forEach(o=>{t.add(o),n.mesh++});else{const o=this.fanout.get(e);if(o&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{const a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n&&this.score.deliverMessage(n,e,t.topic);const i=this.selectPeersToForward(t.topic,n,s),o=an([t]);i.forEach(a=>{this.sendRpc(a,o)}),this.metrics?.onForwardMsg(t.topic,i.size)}async publish(e,t){const n=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:s,msg:i}=await rq(this.publishConfig,e,t,n),o=await this.msgIdFn(i),a=this.msgIdToStrFn(o);if(this.seenCache.has(a))throw Error("PublishError.Duplicate");const{tosend:c,tosendCount:u}=this.selectPeersToPublish(e),l=this.opts.emitSelf===!0&&this.subscriptions.has(e);if(c.size===0&&!this.opts.allowPublishToZeroPeers&&!l)throw Error("PublishError.InsufficientPeers");this.seenCache.put(a),this.mcache.put({msgId:o,msgIdStr:a},s,!0),this.publishedMessageIds.put(a);const d=an([s]);for(const f of c)this.sendRpc(f,d)||c.delete(f);return this.metrics?.onPublishMsg(e,u,c.size,s.data!=null?s.data.length:0),l&&(c.add(this.components.getPeerId().toString()),super.dispatchEvent(new Z("gossipsub:message",{detail:{propagationSource:this.components.getPeerId(),msgId:a,msg:i}})),super.dispatchEvent(new Z("message",{detail:i}))),{recipients:Array.from(c.values()).map(f=>re(f))}}reportMessageValidationResult(e,t,n){if(n===bn.Accept){const s=this.mcache.validate(e);if(this.metrics?.onReportValidationMcacheHit(s!==null),s!=null){const{message:i,originatingPeers:o}=s;this.score.deliverMessage(t.toString(),e,i.topic),this.forwardMessage(e,s.message,t.toString(),o),this.metrics?.onReportValidation(i.topic,n)}}else{const s=this.mcache.remove(e);if(this.metrics?.onReportValidationMcacheHit(s!==null),s){const i=i5(n),{message:o,originatingPeers:a}=s;this.score.rejectMessage(t.toString(),e,o.topic,i);for(const c of a)this.score.rejectMessage(c,e,o.topic,i);this.metrics?.onReportValidation(o.topic,n)}}}sendGraft(e,t){const s=an([],{graft:[{topicID:t}]});this.sendRpc(e,s)}async sendPrune(e,t){const n=[await this.makePrune(e,t,this.opts.doPX)],s=an([],{prune:n});this.sendRpc(e,s)}sendRpc(e,t){const n=this.streamsOutbound.get(e);if(!n)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const s=this.control.get(e);s&&(this.piggybackControl(e,t,s),this.control.delete(e));const i=this.gossip.get(e);i&&(this.piggybackGossip(e,t,i),this.gossip.delete(e));const o=Cu.encode(t).finish();try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s&&this.control.set(e,s),i&&this.gossip.set(e,i),!1}return this.metrics?.onRpcSent(t,o.length),!0}piggybackControl(e,t,n){const s=(n.graft||[]).filter(({topicID:o})=>(o&&this.mesh.get(o)||new Set).has(e)),i=(n.prune||[]).filter(({topicID:o})=>!(o&&this.mesh.get(o)||new Set).has(e));!s.length&&!i.length||(t.control?(t.control.graft=t.control.graft&&t.control.graft.concat(s),t.control.prune=t.control.prune&&t.control.prune.concat(i)):t.control={graft:s,prune:i,ihave:[],iwant:[]})}piggybackGossip(e,t,n){t.control||(t.control={ihave:[],iwant:[],graft:[],prune:[]}),t.control.ihave=n}async sendGraftPrune(e,t,n){const s=this.opts.doPX;for(const[i,o]of e){const a=o.map(d=>({topicID:d}));let c=[];const u=t.get(i);u&&(c=await Promise.all(u.map(async d=>await this.makePrune(i,d,s&&!(n.get(i)??!1)))),t.delete(i));const l=an([],{graft:a,prune:c});this.sendRpc(i,l)}for(const[i,o]of t){const a=await Promise.all(o.map(async u=>await this.makePrune(i,u,s&&!(n.get(i)??!1)))),c=an([],{prune:a});this.sendRpc(i,c)}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(!n.length||(cn(n),n.length>bi&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),!t.size))return;let s=this.opts.Dlazy;const i=yK*t.size;let o=t;i>s&&(s=i),s>o.size?s=o.size:o=cn(Array.from(o)).slice(0,s),o.forEach(a=>{let c=n;n.length>bi&&(c=cn(c.slice()).slice(0,bi)),this.pushGossip(a,{topicID:e,messageIDs:c})})}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,an([],{ihave:t}));for(const[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,an([],{graft:t.graft,prune:t.prune}))}pushGossip(e,t){this.log("Add gossip to %s",e);const n=this.gossip.get(e)||[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n){if(this.score.prune(e,t),this.streamsOutbound.get(e).protocol===t5)return{topicID:t,peers:[]};const s=this.opts.pruneBackoff/1e3;if(!n)return{topicID:t,peers:[],backoff:s};const i=this.getRandomGossipPeers(t,this.opts.prunePeers,a=>a!==e&&this.score.score(a)>=0),o=await Promise.all(Array.from(i).map(async a=>{const c=re(a);return{peerID:c.toBytes(),signedPeerRecord:await this.components.getPeerStore().addressBook.getRawEnvelope(c)}}));return{topicID:t,peers:o,backoff:s}}async heartbeat(){const{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:i,fanoutTTL:o}=this.opts;this.heartbeatTicks++;const a=new Map,c=h=>{let p=a.get(h);return p===void 0&&(p=this.score.score(h),a.set(h,p)),p},u=new Map,l=new Map,d=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const f=new Map;this.mesh.forEach((h,p)=>{const w=this.topics.get(p),y=new Set,_=new Set;if(f.set(p,_),w){const S=cn(Array.from(w)),R=this.backoff.get(p);for(const v of S){const A=this.streamsOutbound.get(v);if(A&&this.multicodecs.includes(A.protocol)&&!h.has(v)&&!this.direct.has(v)){const C=c(v);(!R||!R.has(v))&&C>=0&&y.add(v),C>=this.opts.scoreThresholds.gossipThreshold&&_.add(v)}}}const b=(S,R)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",S,p),this.addBackoff(S,p),h.delete(S),c(S)>=this.opts.scoreThresholds.gossipThreshold&&_.add(S),this.metrics?.onRemoveFromMesh(p,R,1);const v=l.get(S);v?v.push(p):l.set(S,[p])},m=(S,R)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",S,p),this.score.graft(S,p),h.add(S),_.delete(S),this.metrics?.onAddToMesh(p,R,1);const v=u.get(S);v?v.push(p):u.set(S,[p])};if(h.forEach(S=>{const R=c(S);R<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",S,R,p),b(S,Ti.BadScore),d.set(S,!0))}),h.size<t){const S=e-h.size;hq(y,S).forEach(v=>{m(v,cs.NotEnough)})}if(h.size>n){let S=Array.from(h);S.sort((v,A)=>c(A)-c(v)),S=S.slice(0,s).concat(cn(S.slice(s)));let R=0;if(S.slice(0,e).forEach(v=>{this.outbound.get(v)&&R++}),R<i){const v=C=>{const P=S[C];for(let $=C;$>0;$--)S[$]=S[$-1];S[0]=P};if(R>0){let C=R;for(let P=1;P<e&&C>0;P++)this.outbound.get(S[P])&&(v(P),C--)}let A=e-R;for(let C=e;C<S.length&&A>0;C++)this.outbound.get(S[C])&&(v(C),A--)}S.slice(e).forEach(v=>{b(v,Ti.Excess)})}if(h.size>=t){let S=0;if(h.forEach(R=>{this.outbound.get(R)&&S++}),S<i){const R=i-S;z1(y,R,A=>this.outbound.get(A)===!0).forEach(A=>{m(A,cs.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&h.size>1){const S=Array.from(h).sort((A,C)=>c(A)-c(C)),R=Math.floor(h.size/2),v=c(S[R]);if(v<this.opts.scoreThresholds.opportunisticGraftThreshold){const A=this.opts.opportunisticGraftPeers,C=z1(y,A,P=>c(P)>v);for(const P of C)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",P,p),m(P,cs.Opportunistic)}}});const g=Date.now();this.fanoutLastpub.forEach((h,p)=>{h+o<g&&(this.fanout.delete(p),this.fanoutLastpub.delete(p))}),this.fanout.forEach((h,p)=>{const w=this.topics.get(p);h.forEach(m=>{(!w.has(m)||c(m)<this.opts.scoreThresholds.publishThreshold)&&h.delete(m)});const y=this.topics.get(p),_=[],b=new Set;if(f.set(p,b),y){const m=cn(Array.from(y));for(const S of m){const R=this.streamsOutbound.get(S);if(R&&this.multicodecs.includes(R.protocol)&&!h.has(S)&&!this.direct.has(S)){const v=c(S);v>=this.opts.scoreThresholds.publishThreshold&&_.push(S),v>=this.opts.scoreThresholds.gossipThreshold&&b.add(S)}}}if(h.size<e){const m=e-h.size;_.slice(0,m).forEach(S=>{h.add(S),b?.delete(S)})}}),this.emitGossip(f),await this.sendGraftPrune(u,l,d),this.flush(),this.mcache.shift(),this.dispatchEvent(new Z("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){const s=this.topics.get(e);if(!s)return new Set;let i=[];return s.forEach(o=>{const a=this.streamsOutbound.get(o);a&&this.multicodecs.includes(a.protocol)&&n(o)&&i.push(o)}),i=cn(i),t>0&&i.length>t&&(i=i.slice(0,t)),new Set(i)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;for(const o of this.backoff.values())t+=o.size;e.cacheSize.set({cache:"backoff"},t);for(const[o,a]of this.topics)e.topicPeersCount.set({topicStr:o},a.size);for(const[o,a]of this.mesh)e.meshPeerCounts.set({topicStr:o},a.size);const n=[],s=new Map;e.behaviourPenalty.reset();for(const o of this.peers.keys()){const a=this.score.score(o);n.push(a),s.set(o,a),e.behaviourPenalty.observe(this.score.peerStats.get(o)?.behaviourPenalty??0)}e.registerScores(n,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,s);const i=dq(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(i)}}V7.multicodec=N7;const gq=()=>({gossipsub:r=>{const e=new V7({allowPublishToZeroPeers:!0,fallbackToFloodsub:!0,emitSelf:!0,maxInboundStreams:64,maxOutboundStreams:128});return e.init({getPeerId(){return r.peerId},getPeerStore(){return r.peerStore},getRegistrar(){return r.registrar},getConnectionManager(){return r.connectionManager}}),e}});var yq=j7,c5=128,wq=127,mq=~wq,bq=Math.pow(2,31);function j7(r,e,t){e=e||[],t=t||0;for(var n=t;r>=bq;)e[t++]=r&255|c5,r/=128;for(;r&mq;)e[t++]=r&255|c5,r>>>=7;return e[t]=r|0,j7.bytes=t-n+1,e}var Eq=F1,_q=128,l5=127;function F1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw F1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&l5)<<s:(o&l5)*Math.pow(2,s),s+=7}while(o>=_q);return F1.bytes=i-n,t}var vq=Math.pow(2,7),Sq=Math.pow(2,14),Rq=Math.pow(2,21),Iq=Math.pow(2,28),Aq=Math.pow(2,35),Cq=Math.pow(2,42),Tq=Math.pow(2,49),Dq=Math.pow(2,56),Pq=Math.pow(2,63),kq=function(r){return r<vq?1:r<Sq?2:r<Rq?3:r<Iq?4:r<Aq?5:r<Cq?6:r<Tq?7:r<Dq?8:r<Pq?9:10},Oq={encode:yq,decode:Eq,encodingLength:kq},Du=Oq;const V1=(r,e=0)=>[Du.decode(r,e),Du.decode.bytes],Pu=(r,e,t=0)=>(Du.encode(r,e,t),e),ku=r=>Du.encodingLength(r),Nq=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},F2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},xq=(r,e)=>{const t=e.byteLength,n=ku(r),s=n+ku(t),i=new Uint8Array(s+t);return Pu(r,i,0),Pu(t,i,n),i.set(e,s),new V2(r,t,e,i)},$q=r=>{const e=F2(r),[t,n]=V1(e),[s,i]=V1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new V2(t,s,o,e)},Lq=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Nq(r.bytes,t.bytes)}};let V2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function Mq(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Uq=Mq,Bq=Uq;let zq=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Fq=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return K7(this,e)}},Vq=class{constructor(e){this.decoders=e}or(e){return K7(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const K7=(r,e)=>new Vq({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let jq=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new zq(e,t,n),this.decoder=new Fq(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const q7=({name:r,prefix:e,encode:t,decode:n})=>new jq(r,e,t,n),H7=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Bq(t,e);return q7({prefix:r,name:e,encode:n,decode:i=>F2(s(i))})},Kq=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},qq=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Un=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>q7({prefix:e,name:r,encode(s){return qq(s,n,t)},decode(s){return Kq(s,n,t,r)}}),ls=H7({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});H7({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const ul=Un({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Un({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Un({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Un({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Un({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Un({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Un({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Un({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Un({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Hq=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Wq(t,j1(r),e||ls.encoder);default:return Yq(t,j1(r),e||ul.encoder)}},u5=new WeakMap,j1=r=>{const e=u5.get(r);if(e==null){const t=new Map;return u5.set(r,t),t}return e};let It=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Vo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Qq)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return It.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=xq(e,t);return It.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return It.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Lq(e.multihash,n.multihash)}toString(e){return Hq(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof It)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new It(n,s,i,o||d5(n,s,i.bytes))}else if(t[Jq]===!0){const{version:n,multihash:s,code:i}=t,o=$q(s);return It.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Vo)throw new Error(`Version 0 CID must use dag-pb (code: ${Vo}) block encoding`);return new It(e,t,n,n.bytes)}case 1:{const s=d5(e,t,n.bytes);return new It(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return It.create(0,Vo,e)}static createV1(e,t){return It.create(1,e,t)}static decode(e){const[t,n]=It.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=It.inspectBytes(e),n=t.size-t.multihashSize,s=F2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new V2(t.multihashCode,t.digestSize,i,s);return[t.version===0?It.createV0(o):It.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=V1(e.subarray(t));return t+=f,d};let s=n(),i=Vo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Gq(e,t),i=It.decode(s);return j1(i).set(n,e),i}};const Gq=(r,e)=>{switch(r[0]){case"Q":{const t=e||ls;return[ls.prefix,t.decode(`${ls.prefix}${r}`)]}case ls.prefix:{const t=e||ls;return[ls.prefix,t.decode(r)]}case ul.prefix:{const t=e||ul;return[ul.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Wq=(r,e,t)=>{const{prefix:n}=t;if(n!==ls.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Yq=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Vo=112,Qq=18,d5=(r,e,t)=>{const n=ku(r),s=n+ku(e),i=new Uint8Array(s+t.byteLength);return Pu(r,i,0),Pu(e,i,n),i.set(t,s),i},Jq=Symbol.for("@ipld/js-cid/CID"),Us=O("libp2p-delegated-peer-routing"),h5=3e4,Xq=4;var f5;(function(r){r[r.SENDING_QUERY=0]="SENDING_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADDING_PEER=6]="ADDING_PEER",r[r.DIALING_PEER=7]="DIALING_PEER"})(f5||(f5={}));var p5;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(p5||(p5={}));class Zq{constructor(e){if(e==null)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new lt({concurrency:Xq});const{protocol:t,host:n,port:s}=e.getEndpointConfig();Us(`enabled DelegatedPeerRouting via ${t}://${n}:${s}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async findPeer(e,t={}){Us("findPeer starts: %p",e),t.timeout=t.timeout??h5,t.signal=js([this.abortController.signal].concat(t.signal!=null?[t.signal]:[]));const n=Bt(),s=Bt();this.httpQueue.add(async()=>(n.resolve(),await s.promise));try{await n.promise;for await(const i of this.client.dht.findPeer(e,t))if(i.name==="FINAL_PEER")return{id:i.peer.id,multiaddrs:i.peer.multiaddrs,protocols:[]}}catch(i){throw Us.error("findPeer errored: %o",i),i}finally{s.resolve(),Us("findPeer finished: %p",e)}throw E(new Error("Not found"),"ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){let n;const s=It.asCID(e);s!=null?n=s:n=Xr(e),Us("getClosestPeers starts: %s",n),t.timeout=t.timeout??h5,t.signal=js([this.abortController.signal].concat(t.signal!=null?[t.signal]:[]));const i=Bt(),o=Bt();this.httpQueue.add(async()=>(i.resolve(),await o.promise));try{await i.promise;for await(const a of this.client.dht.query(n,t))a.name==="PEER_RESPONSE"&&(yield*a.closer.map(c=>({id:c.id,multiaddrs:c.multiaddrs,protocols:[]})))}catch(a){throw Us.error("getClosestPeers errored:",a),a}finally{o.resolve(),Us("getClosestPeers finished: %b",e)}}}function eH(r){return()=>new Zq(r)}const kr=O("libp2p:delegated-content-routing"),Bc=3e4,tH=4,rH=2;var g5;(function(r){r[r.SENDING_QUERY=0]="SENDING_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADDING_PEER=6]="ADDING_PEER",r[r.DIALING_PEER=7]="DIALING_PEER"})(g5||(g5={}));var y5;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(y5||(y5={}));class nH{constructor(e){if(e==null)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new lt({concurrency:tH}),this.httpQueueRefs=new lt({concurrency:rH});const{protocol:t,host:n,port:s}=e.getEndpointConfig();kr(`enabled DelegatedContentRouting via ${t}://${n}:${s}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.httpQueueRefs.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async*findProviders(e,t={}){kr("findProviders starts: %c",e),t.timeout=t.timeout??Bc,t.signal=js([this.abortController.signal].concat(t.signal!=null?[t.signal]:[]));const n=Bt(),s=Bt();this.httpQueue.add(async()=>(n.resolve(),await s.promise));try{await n.promise;for await(const i of this.client.dht.findProvs(e,t))i.name==="PROVIDER"&&(yield*i.providers.map(o=>({id:o.id,protocols:[],multiaddrs:o.multiaddrs})))}catch(i){throw kr.error("findProviders errored:",i),i}finally{s.resolve(),kr("findProviders finished: %c",e)}}async provide(e,t={}){kr("provide starts: %c",e),t.timeout=t.timeout??Bc,t.signal=js([this.abortController.signal].concat(t.signal!=null?[t.signal]:[])),await this.httpQueueRefs.add(async()=>{await this.client.block.stat(e,t),await Et(this.client.dht.provide(e,t))}),kr("provide finished: %c",e)}async put(e,t,n={}){kr("put value start: %b",e),n.timeout=n.timeout??Bc,n.signal=js([this.abortController.signal].concat(n.signal!=null?[n.signal]:[])),await this.httpQueue.add(async()=>{await Et(this.client.dht.put(e,t,n))}),kr("put value finished: %b",e)}async get(e,t={}){return kr("get value start: %b",e),t.timeout=t.timeout??Bc,t.signal=js([this.abortController.signal].concat(t.signal!=null?[t.signal]:[])),await this.httpQueue.add(async()=>{for await(const n of this.client.dht.get(e,t))if(n.name==="VALUE")return kr("get value finished: %b",e),n.value;throw E(new Error("Not found"),"ERR_NOT_FOUND")})}}function sH(r){return()=>new nH(r)}const iH=r=>Promise.reject(new Error(`No base found for "${r}"`));class G7{constructor(e){this._basesByName={},this._basesByPrefix={},this._loadBase=e.loadBase||iH;for(const t of e.bases)this.addBase(t)}addBase(e){if(this._basesByName[e.name]||this._basesByPrefix[e.prefix])throw new Error(`Codec already exists for codec "${e.name}"`);this._basesByName[e.name]=e,this._basesByPrefix[e.prefix]=e}removeBase(e){delete this._basesByName[e.name],delete this._basesByPrefix[e.prefix]}async getBase(e){if(this._basesByName[e])return this._basesByName[e];if(this._basesByPrefix[e])return this._basesByPrefix[e];const t=await this._loadBase(e);return this._basesByName[t.name]==null&&this._basesByPrefix[t.prefix]==null&&this.addBase(t),t}listBases(){return Object.values(this._basesByName)}}const oH=r=>Promise.reject(new Error(`No codec found for "${r}"`));class W7{constructor(e){this._codecsByName={},this._codecsByCode={},this._loadCodec=e.loadCodec||oH;for(const t of e.codecs)this.addCodec(t)}addCodec(e){if(this._codecsByName[e.name]||this._codecsByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._codecsByName[e.name]=e,this._codecsByCode[e.code]=e}removeCodec(e){delete this._codecsByName[e.name],delete this._codecsByCode[e.code]}async getCodec(e){const t=typeof e=="string"?this._codecsByName:this._codecsByCode;if(t[e])return t[e];const n=await this._loadCodec(e);return t[e]==null&&this.addCodec(n),n}listCodecs(){return Object.values(this._codecsByName)}}const aH=r=>Promise.reject(new Error(`No hasher found for "${r}"`));class Y7{constructor(e){this._hashersByName={},this._hashersByCode={},this._loadHasher=e.loadHasher||aH;for(const t of e.hashers)this.addHasher(t)}addHasher(e){if(this._hashersByName[e.name]||this._hashersByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._hashersByName[e.name]=e,this._hashersByCode[e.code]=e}removeHasher(e){delete this._hashersByName[e.name],delete this._hashersByCode[e.code]}async getHasher(e){const t=typeof e=="string"?this._hashersByName:this._hashersByCode;if(t[e])return t[e];const n=await this._loadHasher(e);return t[e]==null&&this.addHasher(n),n}listHashers(){return Object.values(this._hashersByName)}}const cH=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},yo=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},lH=r=>new TextEncoder().encode(r),uH=r=>new TextDecoder().decode(r);var dH=Q7,w5=128,hH=127,fH=~hH,pH=Math.pow(2,31);function Q7(r,e,t){e=e||[],t=t||0;for(var n=t;r>=pH;)e[t++]=r&255|w5,r/=128;for(;r&fH;)e[t++]=r&255|w5,r>>>=7;return e[t]=r|0,Q7.bytes=t-n+1,e}var gH=K1,yH=128,m5=127;function K1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw K1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&m5)<<s:(o&m5)*Math.pow(2,s),s+=7}while(o>=yH);return K1.bytes=i-n,t}var wH=Math.pow(2,7),mH=Math.pow(2,14),bH=Math.pow(2,21),EH=Math.pow(2,28),_H=Math.pow(2,35),vH=Math.pow(2,42),SH=Math.pow(2,49),RH=Math.pow(2,56),IH=Math.pow(2,63),AH=function(r){return r<wH?1:r<mH?2:r<bH?3:r<EH?4:r<_H?5:r<vH?6:r<SH?7:r<RH?8:r<IH?9:10},CH={encode:dH,decode:gH,encodingLength:AH},Ou=CH;const q1=(r,e=0)=>[Ou.decode(r,e),Ou.decode.bytes],Nu=(r,e,t=0)=>(Ou.encode(r,e,t),e),xu=r=>Ou.encodingLength(r),$u=(r,e)=>{const t=e.byteLength,n=xu(r),s=n+xu(t),i=new Uint8Array(s+t);return Nu(r,i,0),Nu(t,i,n),i.set(e,s),new j2(r,t,e,i)},TH=r=>{const e=yo(r),[t,n]=q1(e),[s,i]=q1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new j2(t,s,o,e)},DH=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&cH(r.bytes,t.bytes)}};let j2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const J7=0,PH="identity",X7=yo,kH=r=>$u(J7,X7(r)),H1={code:J7,name:PH,encode:X7,digest:kH},OH=Object.freeze(Object.defineProperty({__proto__:null,identity:H1},Symbol.toStringTag,{value:"Module"}));function NH(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var xH=NH,$H=xH;let LH=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},MH=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Z7(this,e)}},UH=class{constructor(e){this.decoders=e}or(e){return Z7(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Z7=(r,e)=>new UH({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let BH=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new LH(e,t,n),this.decoder=new MH(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const kd=({name:r,prefix:e,encode:t,decode:n})=>new BH(r,e,t,n),oc=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=$H(t,e);return kd({prefix:r,name:e,encode:n,decode:i=>yo(s(i))})},zH=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},FH=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},St=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>kd({prefix:e,name:r,encode(s){return FH(s,n,t)},decode(s){return zH(s,n,t,r)}}),VH=kd({prefix:"\0",name:"identity",encode:r=>uH(r),decode:r=>lH(r)}),jH=Object.freeze(Object.defineProperty({__proto__:null,identity:VH},Symbol.toStringTag,{value:"Module"})),KH=St({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),qH=Object.freeze(Object.defineProperty({__proto__:null,base2:KH},Symbol.toStringTag,{value:"Module"})),HH=St({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),GH=Object.freeze(Object.defineProperty({__proto__:null,base8:HH},Symbol.toStringTag,{value:"Module"})),WH=oc({prefix:"9",name:"base10",alphabet:"0123456789"}),YH=Object.freeze(Object.defineProperty({__proto__:null,base10:WH},Symbol.toStringTag,{value:"Module"})),QH=St({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),JH=St({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),XH=Object.freeze(Object.defineProperty({__proto__:null,base16:QH,base16upper:JH},Symbol.toStringTag,{value:"Module"})),Ea=St({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ZH=St({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),eG=St({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),tG=St({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),rG=St({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),nG=St({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),sG=St({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),iG=St({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),oG=St({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),aG=Object.freeze(Object.defineProperty({__proto__:null,base32:Ea,base32hex:rG,base32hexpad:sG,base32hexpadupper:iG,base32hexupper:nG,base32pad:eG,base32padupper:tG,base32upper:ZH,base32z:oG},Symbol.toStringTag,{value:"Module"})),cG=oc({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),lG=oc({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),uG=Object.freeze(Object.defineProperty({__proto__:null,base36:cG,base36upper:lG},Symbol.toStringTag,{value:"Module"})),wn=oc({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),dG=oc({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),hG=Object.freeze(Object.defineProperty({__proto__:null,base58btc:wn,base58flickr:dG},Symbol.toStringTag,{value:"Module"})),fG=St({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),pG=St({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Od=St({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),gG=St({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),yG=Object.freeze(Object.defineProperty({__proto__:null,base64:fG,base64pad:pG,base64url:Od,base64urlpad:gG},Symbol.toStringTag,{value:"Module"})),eb=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),wG=eb.reduce((r,e,t)=>(r[t]=e,r),[]),mG=eb.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function bG(r){return r.reduce((e,t)=>(e+=wG[t],e),"")}function EG(r){const e=[];for(const t of r){const n=mG[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const _G=kd({prefix:"🚀",name:"base256emoji",encode:bG,decode:EG}),vG=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:_G},Symbol.toStringTag,{value:"Module"})),tb=({name:r,code:e,encode:t})=>new SG(r,e,t);let SG=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?$u(this.code,t):t.then(n=>$u(this.code,n))}else throw Error("Unknown type, must be binary type")}};const rb=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),RG=tb({name:"sha2-256",code:18,encode:rb("SHA-256")}),IG=tb({name:"sha2-512",code:19,encode:rb("SHA-512")}),AG=Object.freeze(Object.defineProperty({__proto__:null,sha256:RG,sha512:IG},Symbol.toStringTag,{value:"Module"})),CG="raw",TG=85,DG=r=>yo(r),PG=r=>yo(r),kG=Object.freeze(Object.defineProperty({__proto__:null,code:TG,decode:PG,encode:DG,name:CG},Symbol.toStringTag,{value:"Module"})),OG=new TextEncoder,NG=new TextDecoder,xG="json",$G=512,LG=r=>OG.encode(JSON.stringify(r)),MG=r=>JSON.parse(NG.decode(r)),UG=Object.freeze(Object.defineProperty({__proto__:null,code:$G,decode:MG,encode:LG,name:xG},Symbol.toStringTag,{value:"Module"})),BG=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return FG(t,G1(r),e||wn.encoder);default:return VG(t,G1(r),e||Ea.encoder)}},b5=new WeakMap,G1=r=>{const e=b5.get(r);if(e==null){const t=new Map;return b5.set(r,t),t}return e};let H=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==jo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==jG)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return H.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=$u(e,t);return H.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return H.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&DH(e.multihash,n.multihash)}toString(e){return BG(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof H)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new H(n,s,i,o||E5(n,s,i.bytes))}else if(t[KG]===!0){const{version:n,multihash:s,code:i}=t,o=TH(s);return H.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==jo)throw new Error(`Version 0 CID must use dag-pb (code: ${jo}) block encoding`);return new H(e,t,n,n.bytes)}case 1:{const s=E5(e,t,n.bytes);return new H(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return H.create(0,jo,e)}static createV1(e,t){return H.create(1,e,t)}static decode(e){const[t,n]=H.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=H.inspectBytes(e),n=t.size-t.multihashSize,s=yo(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new j2(t.multihashCode,t.digestSize,i,s);return[t.version===0?H.createV0(o):H.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=q1(e.subarray(t));return t+=f,d};let s=n(),i=jo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=zG(e,t),i=H.decode(s);return G1(i).set(n,e),i}};const zG=(r,e)=>{switch(r[0]){case"Q":{const t=e||wn;return[wn.prefix,t.decode(`${wn.prefix}${r}`)]}case wn.prefix:{const t=e||wn;return[wn.prefix,t.decode(r)]}case Ea.prefix:{const t=e||Ea;return[Ea.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},FG=(r,e,t)=>{const{prefix:n}=t;if(n!==wn.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},VG=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},jo=112,jG=18,E5=(r,e,t)=>{const n=xu(r),s=n+xu(e),i=new Uint8Array(s+t.byteLength);return Nu(r,i,0),Nu(e,i,n),i.set(t,s),i},KG=Symbol.for("@ipld/js-cid/CID"),qG={...jH,...qH,...GH,...YH,...XH,...aG,...uG,...hG,...yG,...vG},HG={...AG,...OH},GG={raw:kG,json:UG};function _5(r){try{r=y6(X(r))}catch{}return r=r.toString(),r}const WG=()=>{},v5=O("ipfs-http-client:lib:error-handler"),YG=Le.bind({ignoreUndefined:!0}),QG=Ds.isBrowser||Ds.isWebWorker?location.protocol:"http",JG=Ds.isBrowser||Ds.isWebWorker?location.hostname:"localhost",XG=Ds.isBrowser||Ds.isWebWorker?location.port:"5001",ZG=(r={})=>{let e,t={},n;if(typeof r=="string"||wl(r))e=new URL(_5(r));else if(r instanceof URL)e=r;else if(typeof r.url=="string"||wl(r.url))e=new URL(_5(r.url)),t=r;else if(r.url instanceof URL)e=r.url,t=r;else{t=r||{};const s=(t.protocol||QG).replace(":",""),i=(t.host||JG).split(":")[0],o=t.port||XG;e=new URL(`${s}://${i}:${o}`)}if(t.apiPath?e.pathname=t.apiPath:(e.pathname==="/"||e.pathname===void 0)&&(e.pathname="api/v0"),Ds.isNode){const s=WG();n=t.agent||new s({keepAlive:!0,maxSockets:6})}return{...t,host:e.host,protocol:e.protocol.replace(":",""),port:Number(e.port),apiPath:e.pathname,url:e,agent:n}},eW=async r=>{let e;try{if((r.headers.get("Content-Type")||"").startsWith("application/json")){const n=await r.json();v5(n),e=n.Message||n.message}else e=await r.text()}catch(n){v5("Failed to parse error response",n),e=n.message}let t=new Vr.HTTPError(r);throw e&&(e.includes("deadline has elapsed")&&(t=new Vr.TimeoutError),e&&e.includes("context deadline exceeded")&&(t=new Vr.TimeoutError)),e&&e.includes("request timed out")&&(t=new Vr.TimeoutError),e&&(t.message=e),t},tW=/[A-Z\u00C0-\u00D6\u00D8-\u00DE]/g,S5=r=>r.replace(tW,function(e){return"-"+e.toLowerCase()}),rW=r=>typeof r=="string"?ee(r):r;class K2 extends Vr{constructor(e={}){const t=ZG(e);super({timeout:rW(t.timeout||0)||void 0,headers:t.headers,base:`${t.url}`,handleError:eW,transformSearchParams:s=>{const i=new URLSearchParams;for(const[o,a]of s)a!=="undefined"&&a!=="null"&&o!=="signal"&&i.append(S5(o),a),o==="timeout"&&!isNaN(a)&&i.append(S5(o),a);return i},agent:t.agent}),delete this.get,delete this.put,delete this.delete,delete this.options;const n=this.fetch;this.fetch=(s,i={})=>(typeof s=="string"&&!s.startsWith("/")&&(s=`${t.url}/${s}`),n.call(this,s,YG(i,{method:"POST"})))}}Vr.HTTPError;const k=r=>e=>r(new K2(e),e);function nb(r){if(r!=null)return typeof r=="string"?r:r.toString(8).padStart(4,"0")}function sb(r){if(r==null)return;let e;if(r.secs!=null&&(e={secs:r.secs,nsecs:r.nsecs}),r.Seconds!=null&&(e={secs:r.Seconds,nsecs:r.FractionalNanoseconds}),Array.isArray(r)&&(e={secs:r[0],nsecs:r[1]}),r instanceof Date){const t=r.getTime(),n=Math.floor(t/1e3);e={secs:n,nsecs:(t-n*1e3)*1e3}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(e!=null&&e.nsecs!=null&&(e.nsecs<0||e.nsecs>999999999))throw E(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}function N({arg:r,searchParams:e,hashAlg:t,mtime:n,mode:s,...i}={}){e&&(i={...i,...e}),t&&(i.hash=t),n!=null&&(n=sb(n),i.mtime=n.secs,i.mtimeNsecs=n.nsecs),s!=null&&(i.mode=nb(s)),i.timeout&&!isNaN(i.timeout)&&(i.timeout=`${i.timeout}ms`),r==null?r=[]:Array.isArray(r)||(r=[r]);const o=new URLSearchParams(i);return r.forEach(a=>o.append("arg",a)),o}const nW=k(r=>{async function e(t={}){return((await(await r.post("bitswap/wantlist",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Keys||[]).map(s=>H.parse(s["/"]))}return e}),sW=k(r=>{async function e(t,n={}){return((await(await r.post("bitswap/wantlist",{signal:n.signal,searchParams:N({...n,peer:t.toString()}),headers:n.headers})).json()).Keys||[]).map(i=>H.parse(i["/"]))}return e}),ib=k(r=>{async function e(t={}){const n=await r.post("bitswap/stat",{searchParams:N(t),signal:t.signal,headers:t.headers});return iW(await n.json())}return e});function iW(r){return{provideBufLen:r.ProvideBufLen,wantlist:(r.Wantlist||[]).map(e=>H.parse(e["/"])),peers:(r.Peers||[]).map(e=>re(e)),blocksReceived:BigInt(r.BlocksReceived),dataReceived:BigInt(r.DataReceived),blocksSent:BigInt(r.BlocksSent),dataSent:BigInt(r.DataSent),dupBlksReceived:BigInt(r.DupBlksReceived),dupDataReceived:BigInt(r.DupDataReceived)}}const oW=k(r=>{async function e(t,n={}){return(await r.post("bitswap/unwant",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers})).json()}return e});function aW(r){return{wantlist:nW(r),wantlistForPeer:sW(r),unwant:oW(r),stat:ib(r)}}const ob=k(r=>{async function e(t,n={}){const s=await r.post("block/get",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers});return new Uint8Array(await s.arrayBuffer())}return e});async function cW(r){if(Os(r))return new Blob([r]);if(typeof r=="string"||r instanceof String)return new Blob([r.toString()]);if(Da(r))return r;if(Pa(r)&&(r=Wi(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const e=Ya(r),{value:t,done:n}=await e.peek();if(n)return R5(e);if(e.push(t),Number.isInteger(t))return new Blob([Uint8Array.from(await Dn(e))]);if(Os(t)||typeof t=="string"||t instanceof String)return R5(e)}throw E(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT")}async function R5(r){const e=[];for await(const t of r)e.push(t);return new Blob(e)}function lW(r){return Ew(r,cW)}function uW(r){if(r!=null)return typeof r=="string"?r:r.toString(8).padStart(4,"0")}async function Zr(r,e,t={}){const n=[],s=new FormData;let i=0,o=0;for await(const{content:a,path:c,mode:u,mtime:l}of lW(r)){let d="";const f=a?"file":"dir";i>0&&(d=`-${i}`);let g=f+d;const h=[];if(u!=null&&h.push(`mode=${uW(u)}`),l!=null){const{secs:p,nsecs:w}=l;h.push(`mtime=${p}`),w!=null&&h.push(`mtime-nsecs=${w}`)}if(h.length&&(g=`${g}?${h.join("&")}`),a){s.set(g,a,c!=null?encodeURIComponent(c):void 0);const p=o+a.size;n.push({name:c,start:o,end:p}),o=p}else if(c!=null)s.set(g,new File([""],encodeURIComponent(c),{type:"application/x-directory"}));else throw new Error("path or content or both must be set");i++}return{total:o,parts:n,headers:t,body:s}}function dW(r){return r.filter(Boolean)}function en(...r){return Jr(dW(r))}const hW=k(r=>{async function e(t,n={}){const s=new AbortController,i=en(s.signal,n.signal);let o;try{o=await(await r.post("block/put",{signal:i,searchParams:N(n),...await Zr([t],s,n.headers)})).json()}catch(a){if(n.format==="dag-pb")return e(t,{...n,format:"protobuf"});if(n.format==="dag-cbor")return e(t,{...n,format:"cbor"});throw a}return H.parse(o.Key)}return e}),fW=k(r=>{async function*e(t,n={}){Array.isArray(t)||(t=[t]);const s=await r.post("block/rm",{signal:n.signal,searchParams:N({arg:t.map(i=>i.toString()),"stream-channels":!0,...n}),headers:n.headers});for await(const i of s.ndjson())yield pW(i)}return e});function pW(r){const e={cid:H.parse(r.Hash)};return r.Error&&(e.error=new Error(r.Error)),e}const gW=k(r=>{async function e(t,n={}){const i=await(await r.post("block/stat",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers})).json();return{cid:H.parse(i.Key),size:i.Size}}return e});function yW(r){return{get:ob(r),put:hW(r),rm:fW(r),stat:gW(r)}}const wW=k(r=>{async function e(t,n={}){const s=await r.post("bootstrap/add",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Peers:i}=await s.json();return{Peers:i.map(o=>X(o))}}return e}),mW=k(r=>{async function e(t={}){const n=await r.post("bootstrap/rm",{signal:t.signal,searchParams:N({...t,all:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>X(i))}}return e}),bW=k(r=>{async function e(t={}){const n=await r.post("bootstrap/list",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>X(i))}}return e}),EW=k(r=>{async function e(t={}){const n=await r.post("bootstrap/add",{signal:t.signal,searchParams:N({...t,default:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>X(i))}}return e}),_W=k(r=>{async function e(t,n={}){const s=await r.post("bootstrap/rm",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Peers:i}=await s.json();return{Peers:i.map(o=>X(o))}}return e});function vW(r){return{add:wW(r),clear:mW(r),list:bW(r),reset:EW(r),rm:_W(r)}}const SW=k(r=>{async function e(t,n={}){const i=await(await r.post("config/profile/apply",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return{original:i.OldCfg,updated:i.NewCfg}}return e});function ut(r){if(r==null)return r;const e=/^[A-Z]+$/,t={};return Object.keys(r).reduce((n,s)=>(e.test(s)?n[s.toLowerCase()]=r[s]:e.test(s[0])?n[s[0].toLowerCase()+s.slice(1)]=r[s]:n[s]=r[s],n),t)}const RW=k(r=>{async function e(t={}){return(await(await r.post("config/profile/list",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).map(i=>ut(i))}return e});function IW(r){return{apply:SW(r),list:RW(r)}}const AW=k(r=>async(t,n={})=>{if(!t)throw new Error("key argument is required");return(await(await r.post("config",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json()).Value}),CW=k(r=>async(t={})=>await(await r.post("config/show",{signal:t.signal,searchParams:N({...t}),headers:t.headers})).json()),TW=k(r=>async(t,n={})=>{const s=new AbortController,i=en(s.signal,n.signal);await(await r.post("config/replace",{signal:i,searchParams:N(n),...await Zr([M(JSON.stringify(t))],s,n.headers)})).text()}),DW=k(r=>async(t,n,s={})=>{if(typeof t!="string")throw new Error("Invalid key type");const i={...s,...PW(t,n)};await(await r.post("config",{signal:s.signal,searchParams:N(i),headers:s.headers})).text()}),PW=(r,e)=>{switch(typeof e){case"boolean":return{arg:[r,e.toString()],bool:!0};case"string":return{arg:[r,e]};default:return{arg:[r,JSON.stringify(e)],json:!0}}};function kW(r){return{getAll:CW(r),get:AW(r),set:DW(r),replace:TW(r),profiles:IW(r)}}const OW=k(r=>{async function*e(t,n={}){yield*(await r.post("dag/export",{signal:n.signal,searchParams:N({arg:t.toString()}),headers:n.headers})).iterator()}return e});async function*I5(r,e,t,n,s){const i=async u=>{const l=await t.getCodec(u.code),d=await n(u,s);return l.decode(d)},o=e.split("/").filter(Boolean);let a=await i(r),c=r;for(;o.length;){const u=o.shift();if(!u)throw E(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(Object.prototype.hasOwnProperty.call(a,u))a=a[u],yield{value:a,remainderPath:o.join("/")};else throw E(new Error(`no link named "${u}" under ${c}`),"ERR_NO_LINK");const l=H.asCID(a);l&&(c=l,a=await i(a))}yield{value:a,remainderPath:""}}const NW=(r,e)=>k((n,s)=>{const i=ob(s);return async(a,c={})=>{if(c.path){const g=c.localResolve?await fr(I5(a,c.path,r,i,c)):await tr(I5(a,c.path,r,i,c));if(!g)throw E(new Error("Not found"),"ERR_NOT_FOUND");return g}const u=await r.getCodec(a.code),l=await i(a,c);return{value:u.decode(l),remainderPath:""}}})(e),xW=k(r=>{async function*e(t,n={}){const s=new AbortController,i=en(s.signal,n.signal),{headers:o,body:a}=await Zr(t,s,n.headers),c=await r.post("dag/import",{signal:i,headers:o,body:a,searchParams:N({"pin-roots":n.pinRoots})});for await(const{Root:u}of c.ndjson())if(u!==void 0){const{Cid:{"/":l},PinErrorMsg:d}=u;yield{root:{cid:H.parse(l),pinErrorMsg:d}}}}return e}),ab=(r,e)=>k(n=>async(i,o={})=>{const a={storeCodec:"dag-cbor",hashAlg:"sha2-256",...o};let c;if(a.inputCodec){if(!(i instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");c=i}else c=(await r.getCodec(a.storeCodec)).encode(i),a.inputCodec=a.storeCodec;const u=new AbortController,l=en(u.signal,a.signal),f=await(await n.post("dag/put",{timeout:a.timeout,signal:l,searchParams:N(a),...await Zr([c],u,a.headers)})).json();return H.parse(f.Cid["/"])})(e),$W=k(r=>async(t,n={})=>{const i=await(await r.post("dag/resolve",{signal:n.signal,searchParams:N({arg:`${t}${n.path?`/${n.path}`.replace(/\/[/]+/g,"/"):""}`,...n}),headers:n.headers})).json();return{cid:H.parse(i.Cid["/"]),remainderPath:i.RemPath}});function LW(r,e){return{export:OW(e),get:NW(r,e),import:xW(e),put:ab(r,e),resolve:$W(e)}}const MW=0,UW=1,BW=2,zW=3,FW=4,VW=5,jW=6,KW=7,wo=r=>{if(r.Type===MW)return{name:"SENDING_QUERY",type:r.Type};if(r.Type===UW)return{from:re(r.ID),name:"PEER_RESPONSE",type:r.Type,messageType:0,messageName:"PUT_VALUE",closer:(r.Responses||[]).map(({ID:e,Addrs:t})=>({id:re(e),multiaddrs:t.map(n=>X(n)),protocols:[]})),providers:(r.Responses||[]).map(({ID:e,Addrs:t})=>({id:re(e),multiaddrs:t.map(n=>X(n)),protocols:[]}))};if(r.Type===BW){let e={id:r.ID??re(r.ID),multiaddrs:[],protocols:[]};return r.Responses&&r.Responses.length&&(e={id:re(r.Responses[0].ID),multiaddrs:r.Responses[0].Addrs.map(t=>X(t)),protocols:[]}),{name:"FINAL_PEER",type:r.Type,peer:e}}if(r.Type===zW)return{name:"QUERY_ERROR",type:r.Type,error:new Error(r.Extra)};if(r.Type===FW)return{name:"PROVIDER",type:r.Type,providers:r.Responses.map(({ID:e,Addrs:t})=>({id:re(e),multiaddrs:t.map(n=>X(n)),protocols:[]}))};if(r.Type===VW)return{name:"VALUE",type:r.Type,value:M(r.Extra,"base64pad")};if(r.Type===jW){const e=r.Responses.map(({ID:t})=>re(t));if(!e.length)throw new Error("No peer found");return{name:"ADDING_PEER",type:r.Type,peer:e[0]}}if(r.Type===KW)return{name:"DIALING_PEER",type:r.Type,peer:re(r.ID)};throw new Error("Unknown DHT event type")},qW=k(r=>{async function*e(t,n={}){const s=await r.post("dht/findpeer",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers});for await(const i of s.ndjson())yield wo(i)}return e}),HW=k(r=>{async function*e(t,n={}){const s=await r.post("dht/findprovs",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield wo(i)}return e}),GW=k(r=>{async function*e(t,n={}){const s=await r.post("dht/get",{signal:n.signal,searchParams:N({arg:t instanceof Uint8Array?q(t):t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield wo(i)}return e}),WW=k(r=>{async function*e(t,n={recursive:!1}){const s=Array.isArray(t)?t:[t],i=await r.post("dht/provide",{signal:n.signal,searchParams:N({arg:s.map(o=>o.toString()),...n}),headers:n.headers});for await(const o of i.ndjson())yield wo(o)}return e}),YW=k(r=>{async function*e(t,n,s={}){const i=new AbortController,o=en(i.signal,s.signal),a=await r.post("dht/put",{signal:o,searchParams:N({arg:t instanceof Uint8Array?q(t):t.toString(),...s}),...await Zr([n],i,s.headers)});for await(const c of a.ndjson())yield wo(c)}return e}),QW=k(r=>{async function*e(t,n={}){const s=await r.post("dht/query",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield wo(i)}return e});function JW(r){return{findPeer:qW(r),findProvs:HW(r),get:GW(r),provide:WW(r),put:YW(r),query:QW(r)}}const XW=k(r=>{async function e(t={}){return(await r.post("diag/cmds",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()}return e}),ZW=k(r=>{async function e(t={}){return(await r.post("diag/net",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()}return e}),eY=k(r=>{async function e(t={}){return(await r.post("diag/sys",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()}return e});function tY(r){return{cmds:XW(r),net:ZW(r),sys:eY(r)}}const rY=k(r=>{async function e(t,n,s={}){await(await r.post("files/chmod",{signal:s.signal,searchParams:N({arg:t,mode:n,...s}),headers:s.headers})).text()}return e}),nY=k(r=>{async function e(t,n,s={}){const i=Array.isArray(t)?t:[t];await(await r.post("files/cp",{signal:s.signal,searchParams:N({arg:i.concat(n).map(a=>H.asCID(a)?`/ipfs/${a}`:a),...s}),headers:s.headers})).text()}return e}),sY=k(r=>{async function e(t,n={}){if(!t||typeof t!="string")throw new Error("ipfs.files.flush requires a path");const i=await(await r.post("files/flush",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return H.parse(i.Cid)}return e});function W1(r){const e=ut(r);return Object.prototype.hasOwnProperty.call(e,"mode")&&(e.mode=parseInt(e.mode,8)),Object.prototype.hasOwnProperty.call(e,"mtime")&&(e.mtime={secs:e.mtime,nsecs:e.mtimeNsecs||0},delete e.mtimeNsecs),e}const iY=k(r=>{async function*e(t,n={}){if(!t)throw new Error("ipfs.files.ls requires a path");const s=await r.post("files/ls",{signal:n.signal,searchParams:N({arg:H.asCID(t)?`/ipfs/${t}`:t,long:!0,...n,stream:!0}),headers:n.headers});for await(const i of s.ndjson())if("Entries"in i)for(const o of i.Entries||[])yield A5(W1(o));else yield A5(W1(i))}return e});function A5(r){return r.hash&&(r.cid=H.parse(r.hash)),delete r.hash,r.type=r.type===1?"directory":"file",r}const oY=k(r=>{async function e(t,n={}){await(await r.post("files/mkdir",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).text()}return e}),aY=k(r=>{async function e(t,n,s={}){Array.isArray(t)||(t=[t]),await(await r.post("files/mv",{signal:s.signal,searchParams:N({arg:t.concat(n),...s}),headers:s.headers})).text()}return e}),cY=k(r=>{async function*e(t,n={}){const s=await r.post("files/read",{signal:n.signal,searchParams:N({arg:t,count:n.length,...n}),headers:n.headers});yield*DE(s.body)}return e}),lY=k(r=>{async function e(t,n={}){const s=await r.post("files/rm",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),i=await s.text();if(i!==""){const o=new Vr.HTTPError(s);throw o.message=i,o}}return e}),cb=k(r=>{async function e(t,n={}){const i=await(await r.post("files/stat",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return i.WithLocality=i.WithLocality||!1,uY(W1(i))}return e});function uY(r){return r.cid=H.parse(r.hash),delete r.hash,r}const dY=k(r=>{async function e(t,n={}){await(await r.post("files/touch",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).text()}return e}),hY=k(r=>{async function e(t,n,s={}){const i=new AbortController,o=en(i.signal,s.signal);await(await r.post("files/write",{signal:o,searchParams:N({arg:t,streamChannels:!0,count:s.length,...s}),...await Zr([{content:n,path:"arg",mode:nb(s.mode),mtime:sb(s.mtime)}],i,s.headers)})).text()}return e});function fY(r){return{chmod:rY(r),cp:nY(r),flush:sY(r),ls:iY(r),mkdir:oY(r),mv:aY(r),read:cY(r),rm:lY(r),stat:cb(r),touch:dY(r),write:hY(r)}}const pY=k(r=>async(t,n,s={})=>{throw E(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),gY=k(r=>{async function e(t,n={type:"Ed25519"}){const i=await(await r.post("key/gen",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return ut(i)}return e}),yY=k(r=>{async function e(t,n,s,i={}){const a=await(await r.post("key/import",{signal:i.signal,searchParams:N({arg:t,pem:n,password:s,...i}),headers:i.headers})).json();return ut(a)}return e}),wY=k(r=>async(t,n={})=>{throw E(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),mY=k(r=>{async function e(t={}){return((await(await r.post("key/list",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Keys||[]).map(i=>ut(i))}return e}),bY=k(r=>{async function e(t,n,s={}){const i=await r.post("key/rename",{signal:s.signal,searchParams:N({arg:[t,n],...s}),headers:s.headers});return ut(await i.json())}return e}),EY=k(r=>{async function e(t,n={}){const i=await(await r.post("key/rm",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json();return ut(i.Keys[0])}return e});function _Y(r){return{export:pY(r),gen:gY(r),import:yY(r),info:wY(r),list:mY(r),rename:bY(r),rm:EY(r)}}const vY=k(r=>{async function e(t,n,s={}){const i=await r.post("log/level",{signal:s.signal,searchParams:N({arg:[t,n],...s}),headers:s.headers});return ut(await i.json())}return e}),SY=k(r=>{async function e(t={}){return(await(await r.post("log/ls",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Strings}return e}),RY=k(r=>{async function*e(t={}){yield*(await r.post("log/tail",{signal:t.signal,searchParams:N(t),headers:t.headers})).ndjson()}return e});function IY(r){return{level:vY(r),ls:SY(r),tail:RY(r)}}const AY=k(r=>{async function e(t,n={}){const s=await r.post("name/publish",{signal:n.signal,searchParams:N({arg:`${t}`,...n}),headers:n.headers});return ut(await s.json())}return e}),CY=k(r=>{async function*e(t,n={}){const s=await r.post("name/resolve",{signal:n.signal,searchParams:N({arg:t,stream:!0,...n}),headers:n.headers});for await(const i of s.ndjson())yield i.Path}return e}),TY=k(r=>{async function e(t,n={}){const s=await r.post("name/pubsub/cancel",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers});return ut(await s.json())}return e}),DY=k(r=>{async function e(t={}){const n=await r.post("name/pubsub/state",{signal:t.signal,searchParams:N(t),headers:t.headers});return ut(await n.json())}return e}),PY=k(r=>{async function e(t={}){return(await(await r.post("name/pubsub/subs",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Strings||[]}return e});function kY(r){return{cancel:TY(r),state:DY(r),subs:PY(r)}}function OY(r){return{publish:AY(r),resolve:CY(r),pubsub:kY(r)}}const NY=k(r=>{async function e(t,n={}){const i=await(await r.post("object/data",{signal:n.signal,searchParams:N({arg:`${t instanceof Uint8Array?H.decode(t):t}`,...n}),headers:n.headers})).arrayBuffer();return new Uint8Array(i,0,i.byteLength)}return e}),xY=k(r=>{async function e(t,n={}){const i=await(await r.post("object/get",{signal:n.signal,searchParams:N({arg:`${t instanceof Uint8Array?H.decode(t):t}`,dataEncoding:"base64",...n}),headers:n.headers})).json();return{Data:M(i.Data,"base64pad"),Links:(i.Links||[]).map(o=>({Name:o.Name,Hash:H.parse(o.Hash),Tsize:o.Size}))}}return e}),$Y=k(r=>{async function e(t,n={}){return((await(await r.post("object/links",{signal:n.signal,searchParams:N({arg:`${t instanceof Uint8Array?H.decode(t):t}`,...n}),headers:n.headers})).json()).Links||[]).map(o=>({Name:o.Name,Tsize:o.Size,Hash:H.parse(o.Hash)}))}return e}),LY=k(r=>{async function e(t={}){const n=await r.post("object/new",{signal:t.signal,searchParams:N({arg:t.template,...t}),headers:t.headers}),{Hash:s}=await n.json();return H.parse(s)}return e}),MY=(r,e)=>k(n=>{const s=ab(r,e);async function i(o,a={}){return s(o,{...a,storeCodec:"dag-pb",hashAlg:"sha2-256",version:1})}return i})(e),UY=k(r=>{async function e(t,n={}){const i=await(await r.post("object/stat",{signal:n.signal,searchParams:N({arg:`${t}`,...n}),headers:n.headers})).json();return{...i,Hash:H.parse(i.Hash)}}return e}),BY=k(r=>{async function e(t,n,s={}){const i=await r.post("object/patch/add-link",{signal:s.signal,searchParams:N({arg:[`${t}`,n.Name||n.name||"",(n.Hash||n.cid||"").toString()||null],...s}),headers:s.headers}),{Hash:o}=await i.json();return H.parse(o)}return e}),zY=k(r=>{async function e(t,n,s={}){const i=new AbortController,o=en(i.signal,s.signal),a=await r.post("object/patch/append-data",{signal:o,searchParams:N({arg:`${t}`,...s}),...await Zr([n],i,s.headers)}),{Hash:c}=await a.json();return H.parse(c)}return e}),FY=k(r=>{async function e(t,n,s={}){const i=await r.post("object/patch/rm-link",{signal:s.signal,searchParams:N({arg:[`${t}`,n.Name||n.name||null],...s}),headers:s.headers}),{Hash:o}=await i.json();return H.parse(o)}return e}),VY=k(r=>{async function e(t,n,s={}){const i=new AbortController,o=en(i.signal,s.signal),a=await r.post("object/patch/set-data",{signal:o,searchParams:N({arg:[`${t}`],...s}),...await Zr([n],i,s.headers)}),{Hash:c}=await a.json();return H.parse(c)}return e});function jY(r){return{addLink:BY(r),appendData:zY(r),rmLink:FY(r),setData:VY(r)}}function KY(r,e){return{data:NY(e),get:xY(e),links:$Y(e),new:LY(e),put:MY(r,e),stat:UY(e),patch:jY(e)}}const lb=k(r=>{async function*e(t,n={}){for await(const{path:s,recursive:i,metadata:o}of Wa(t)){const a=await r.post("pin/add",{signal:n.signal,searchParams:N({...n,arg:s,recursive:i,metadata:o?JSON.stringify(o):void 0,stream:!0}),headers:n.headers});for await(const c of a.ndjson()){if(c.Pins){for(const u of c.Pins)yield H.parse(u);continue}yield H.parse(c)}}}return e});function qY(r){const e=lb(r);return k(()=>{async function t(n,s={}){return tr(e([{path:n,...s}],s))}return t})(r)}function C5(r,e,t){const n={type:r,cid:H.parse(e)};return t&&(n.metadata=t),n}const HY=k(r=>{async function*e(t={}){let n=[];t.paths&&(n=Array.isArray(t.paths)?t.paths:[t.paths]);const s=await r.post("pin/ls",{signal:t.signal,searchParams:N({...t,arg:n.map(i=>`${i}`),stream:!0}),headers:t.headers});for await(const i of s.ndjson()){if(i.Keys){for(const o of Object.keys(i.Keys))yield C5(i.Keys[o].Type,o,i.Keys[o].Metadata);return}yield C5(i.Type,i.Cid,i.Metadata)}}return e}),ub=k(r=>{async function*e(t,n={}){for await(const{path:s,recursive:i}of Wa(t)){const o=new URLSearchParams(n.searchParams);o.append("arg",`${s}`),i!=null&&o.set("recursive",String(i));const a=await r.post("pin/rm",{signal:n.signal,headers:n.headers,searchParams:N({...n,arg:`${s}`,recursive:i})});for await(const c of a.ndjson()){if(c.Pins){yield*c.Pins.map(u=>H.parse(u));continue}yield H.parse(c)}}}return e}),GY=r=>{const e=ub(r);return k(()=>{async function t(n,s={}){return tr(e([{path:n,...s}],s))}return t})(r)},db=({Name:r,Status:e,Cid:t})=>({cid:H.parse(t),name:r,status:e}),hb=r=>{if(typeof r=="string"&&r!=="")return r;throw new TypeError("service name must be passed")},fb=r=>{if(H.asCID(r))return r.toString();throw new TypeError(`CID instance expected instead of ${typeof r}`)},q2=({service:r,cid:e,name:t,status:n,all:s})=>{const i=N({service:hb(r),name:t,force:s?!0:void 0});if(e)for(const o of e)i.append("cid",fb(o));if(n)for(const o of n)i.append("status",o);return i},WY=({cid:r,service:e,background:t,name:n,origins:s})=>{const i=N({arg:fb(r),service:hb(e),name:n,background:t?!0:void 0});if(s)for(const o of s)i.append("origin",o.toString());return i};function YY(r){async function e(t,{timeout:n,signal:s,headers:i,...o}){const a=await r.post("pin/remote/add",{timeout:n,signal:s,headers:i,searchParams:WY({cid:t,...o})});return db(await a.json())}return e}function QY(r){async function*e({timeout:t,signal:n,headers:s,...i}){const o=await r.post("pin/remote/ls",{timeout:t,signal:n,headers:s,searchParams:q2(i)});for await(const a of o.ndjson())yield db(a)}return e}function JY(r){async function e({timeout:t,signal:n,headers:s,...i}){await r.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:q2({...i,all:!1})})}return e}function XY(r){async function e({timeout:t,signal:n,headers:s,...i}){await r.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:q2({...i,all:!0})})}return e}function ZY(r){const e=String(r);if(e==="undefined")throw Error("endpoint is required");return e[e.length-1]==="/"?e.slice(0,-1):e}function eQ(r){return{service:r.Service,endpoint:new URL(r.ApiEndpoint),...r.Stat&&{stat:tQ(r.Stat)}}}function tQ(r){switch(r.Status){case"valid":{const{Pinning:e,Pinned:t,Queued:n,Failed:s}=r.PinCount;return{status:"valid",pinCount:{queued:n,pinning:e,pinned:t,failed:s}}}case"invalid":return{status:"invalid"};default:return{status:r.Status}}}function rQ(r){async function e(t,n){const{endpoint:s,key:i,headers:o,timeout:a,signal:c}=n;await r.post("pin/remote/service/add",{timeout:a,signal:c,searchParams:N({arg:[t,ZY(s),i]}),headers:o})}return e}function nQ(r){async function e(t={}){const{stat:n,headers:s,timeout:i,signal:o}=t,a=await r.post("pin/remote/service/ls",{timeout:i,signal:o,headers:s,searchParams:n===!0?N({stat:n}):void 0}),{RemoteServices:c}=await a.json();return c.map(eQ)}return e}function sQ(r){async function e(t,n={}){await r.post("pin/remote/service/rm",{signal:n.signal,headers:n.headers,searchParams:N({arg:t})})}return e}function iQ(r){const e=new K2(r);return{add:rQ(e),ls:nQ(e),rm:sQ(e)}}function oQ(r){const e=new K2(r);return{add:YY(e),ls:QY(e),rm:JY(e),rmAll:XY(e),service:iQ(r)}}function aQ(r){return{addAll:lb(r),add:qY(r),ls:HY(r),rmAll:ub(r),rm:GY(r),remote:oQ(r)}}const cQ=r=>Array.isArray(r)?r.map(Y1):r,Y1=r=>q(aa(r)),aa=r=>Od.decode(r),lQ=r=>BigInt(`0x${q(Od.decode(r),"base16")}`),H2=r=>Od.encode(M(r)),uQ=k(r=>{async function e(t={}){const{Strings:n}=await(await r.post("pubsub/ls",{signal:t.signal,searchParams:N(t),headers:t.headers})).json();return cQ(n)||[]}return e}),dQ=k(r=>{async function e(t,n={}){const s=await r.post("pubsub/peers",{signal:n.signal,searchParams:N({arg:H2(t),...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),hQ=k(r=>{async function e(t,n,s={}){const i=N({arg:H2(t),...s}),o=new AbortController,a=en(o.signal,s.signal);await(await r.post("pubsub/pub",{signal:a,searchParams:i,...await Zr([n],o,s.headers)})).text()}return e}),fQ=O("ipfs-http-client:pubsub:subscribe"),pQ=(r,e)=>k(t=>{async function n(s,i,o={}){o.signal=e.subscribe(s,i,o.signal);let a,c;const u=new Promise((d,f)=>{a=d,c=f}),l=setTimeout(()=>a(),1e3);return t.post("pubsub/sub",{signal:o.signal,searchParams:N({arg:H2(s),...o}),headers:o.headers}).catch(d=>{e.unsubscribe(s,i),c(d)}).then(d=>{clearTimeout(l),d&&(gQ(d,{onMessage:f=>{if(i){if(typeof i=="function"){i(f);return}typeof i.handleEvent=="function"&&i.handleEvent(f)}},onEnd:()=>e.unsubscribe(s,i),onError:o.onError}),a())}),u}return n})(r);async function gQ(r,{onMessage:e,onEnd:t,onError:n}){n=n||fQ;try{for await(const s of r.ndjson())try{if(!s.from)continue;s.from!=null&&s.seqno!=null?e({type:"signed",from:re(s.from),data:aa(s.data),sequenceNumber:lQ(s.seqno),topic:Y1(s.topicIDs[0]),key:aa(s.key??"u"),signature:aa(s.signature??"u")}):e({type:"unsigned",data:aa(s.data),topic:Y1(s.topicIDs[0])})}catch(i){i.message=`Failed to parse pubsub message: ${i.message}`,n(i,!1,s)}}catch(s){yQ(s)||n(s,!0)}finally{t()}}const yQ=r=>{switch(r.type){case"aborted":return!0;case"abort":return!0;default:return r.name==="AbortError"}},wQ=(r,e)=>{async function t(n,s){e.unsubscribe(n,s)}return t};class mQ{constructor(){this._subs=new Map}subscribe(e,t,n){const s=this._subs.get(e)||[];if(s.find(o=>o.handler===t))throw new Error(`Already subscribed to ${e} with this handler`);const i=new AbortController;return this._subs.set(e,[{handler:t,controller:i}].concat(s)),n&&n.addEventListener("abort",()=>this.unsubscribe(e,t)),i.signal}unsubscribe(e,t){const n=this._subs.get(e)||[];let s;t?(this._subs.set(e,n.filter(i=>i.handler!==t)),s=n.filter(i=>i.handler===t)):(this._subs.set(e,[]),s=n),(this._subs.get(e)||[]).length||this._subs.delete(e),s.forEach(i=>i.controller.abort())}}function bQ(r){const e=new mQ;return{ls:uQ(r),peers:dQ(r),publish:hQ(r),subscribe:pQ(r,e),unsubscribe:wQ(r,e)}}const EQ=k(r=>{async function*e(t={}){yield*(await r.post("refs/local",{signal:t.signal,transform:ut,searchParams:N(t),headers:t.headers})).ndjson()}return e}),_Q=k((r,e)=>Object.assign(async function*(n,s={}){const i=Array.isArray(n)?n:[n];yield*(await r.post("refs",{signal:s.signal,searchParams:N({arg:i.map(a=>`${a instanceof Uint8Array?H.decode(a):a}`),...s}),headers:s.headers,transform:ut})).ndjson()},{local:EQ(e)})),vQ=k(r=>{async function*e(t={}){yield*(await r.post("repo/gc",{signal:t.signal,searchParams:N(t),headers:t.headers,transform:s=>({err:s.Error?new Error(s.Error):null,cid:(s.Key||{})["/"]?H.parse(s.Key["/"]):null})})).ndjson()}return e}),pb=k(r=>{async function e(t={}){const s=await(await r.post("repo/stat",{signal:t.signal,searchParams:N(t),headers:t.headers})).json();return{numObjects:BigInt(s.NumObjects),repoSize:BigInt(s.RepoSize),repoPath:s.RepoPath,version:s.Version,storageMax:BigInt(s.StorageMax)}}return e}),SQ=k(r=>{async function e(t={}){return(await(await r.post("repo/version",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()).Version}return e});function RQ(r){return{gc:vQ(r),stat:pb(r),version:SQ(r)}}const IQ=k(r=>{async function*e(t={}){yield*(await r.post("stats/bw",{signal:t.signal,searchParams:N(t),headers:t.headers,transform:s=>({totalIn:BigInt(s.TotalIn),totalOut:BigInt(s.TotalOut),rateIn:parseFloat(s.RateIn),rateOut:parseFloat(s.RateOut)})})).ndjson()}return e});function AQ(r){return{bitswap:ib(r),repo:pb(r),bw:IQ(r)}}const CQ=k(r=>{async function e(t={}){const n=await r.post("swarm/addrs",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Addrs:s}=await n.json();return Object.keys(s).map(i=>({id:re(i),addrs:(s[i]||[]).map(o=>X(o))}))}return e}),TQ=k(r=>{async function e(t,n={}){const s=await r.post("swarm/connect",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),DQ=k(r=>{async function e(t,n={}){const s=await r.post("swarm/disconnect",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),PQ=k(r=>{async function e(t={}){const n=await r.post("swarm/addrs/local",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Strings:s}=await n.json();return(s||[]).map(i=>X(i))}return e}),kQ=k(r=>{async function e(t={}){const n=await r.post("swarm/peers",{signal:t.signal,searchParams:N(t),headers:t.headers}),{Peers:s}=await n.json();return(s||[]).map(i=>({addr:X(i.Addr),peer:re(i.Peer),muxer:i.Muxer,latency:i.Latency,streams:i.Streams,direction:i.Direction==null?void 0:i.Direction===0?"inbound":"outbound"}))}return e});function OQ(r){return{addrs:CQ(r),connect:TQ(r),disconnect:DQ(r),localAddrs:PQ(r),peers:kQ(r)}}const gb=k(r=>{async function*e(t,n={}){const s=new AbortController,i=en(s.signal,n.signal),{headers:o,body:a,total:c,parts:u}=await Zr(t,s,n.headers),[l,d]=typeof n.progress=="function"?NQ(c,u,n.progress):[void 0,void 0],f=await r.post("add",{searchParams:N({"stream-channels":!0,...n,progress:Boolean(l)}),onUploadProgress:d,signal:i,headers:o,body:a});for await(let g of f.ndjson())g=ut(g),g.hash!==void 0?yield $Q(g):l&&l(g.bytes||0,g.name)}return e}),NQ=(r,e,t)=>e?[void 0,xQ(r,e,t)]:[t,void 0],xQ=(r,e,t)=>{let n=0;const s=e.length;return({loaded:i,total:o})=>{const a=Math.floor(i/o*r);for(;n<s;){const{start:c,end:u,name:l}=e[n];if(a<u){t(a-c,l);break}else t(u-c,l),n+=1}}};function $Q({name:r,hash:e,size:t,mode:n,mtime:s,mtimeNsecs:i}){const o={path:r,cid:H.parse(e),size:parseInt(t)};return n!=null&&(o.mode=parseInt(n,8)),s!=null&&(o.mtime={secs:s,nsecs:i||0}),o}function LQ(r){const e=gb(r);return k(()=>{async function t(n,s={}){return await tr(e(Y8(n),s))}return t})(r)}const MQ=k(r=>{async function*e(t,n={}){yield*(await r.post("cat",{signal:n.signal,searchParams:N({arg:t.toString(),...n}),headers:n.headers})).iterator()}return e}),UQ=k(r=>async(t={})=>(await r.post("commands",{signal:t.signal,searchParams:N(t),headers:t.headers})).json()),BQ=k(r=>async(t,n={})=>(await(await r.post("dns",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers})).json()).Path),zQ=k(r=>()=>{const e=new URL(r.opts.base||"");return{host:e.hostname,port:e.port,protocol:e.protocol,pathname:e.pathname,"api-path":e.pathname}}),FQ=k(r=>{async function*e(t,n={}){const s={arg:`${t instanceof Uint8Array?H.decode(t):t}`,...n};s.compressionLevel&&(s["compression-level"]=s.compressionLevel,delete s.compressionLevel),yield*(await r.post("get",{signal:n.signal,searchParams:N(s),headers:n.headers})).iterator()}return e}),yb=k(r=>{async function e(t={}){const s=await(await r.post("id",{signal:t.signal,searchParams:N({arg:t.peerId?t.peerId.toString():void 0,...t}),headers:t.headers})).json(),i={...ut(s)};return i.id=re(i.id),i.addresses&&(i.addresses=i.addresses.map(o=>X(o))),i}return e}),VQ=r=>{const e=yb(r);async function t(n={}){const s=await e(n);return Boolean(s&&s.addresses&&s.addresses.length)}return t},jQ=k((r,e)=>{async function*t(n,s={}){const i=`${n instanceof Uint8Array?H.decode(n):n}`;async function o(c){let u=c.Hash;if(u.includes("/")){const d=u.startsWith("/ipfs/")?u:`/ipfs/${u}`;u=(await cb(e)(d)).cid}else u=H.parse(u);const l={name:c.Name,path:i+(c.Name?`/${c.Name}`:""),size:c.Size,cid:u,type:KQ(c)};return c.Mode&&(l.mode=parseInt(c.Mode,8)),c.Mtime!==void 0&&c.Mtime!==null&&(l.mtime={secs:c.Mtime},c.MtimeNsecs!==void 0&&c.MtimeNsecs!==null&&(l.mtime.nsecs=c.MtimeNsecs)),l}const a=await r.post("ls",{signal:s.signal,searchParams:N({arg:i,...s}),headers:s.headers});for await(let c of a.ndjson()){if(c=c.Objects,!c)throw new Error("expected .Objects in results");if(c=c[0],!c)throw new Error("expected one array in results.Objects");const u=c.Links;if(!Array.isArray(u))throw new Error("expected one array in results.Objects[0].Links");if(!u.length){yield o(c);return}yield*u.map(o)}}return t});function KQ(r){switch(r.Type){case 1:case 5:return"dir";case 2:return"file";default:return"file"}}const qQ=k(r=>{async function e(t={}){const n=await r.post("dns",{signal:t.signal,searchParams:N(t),headers:t.headers});return ut(await n.json())}return e}),HQ=k(r=>{async function*e(t,n={}){yield*(await r.post("ping",{signal:n.signal,searchParams:N({arg:`${t}`,...n}),headers:n.headers,transform:ut})).ndjson()}return e}),GQ=k(r=>{async function e(t,n={}){const s=await r.post("resolve",{signal:n.signal,searchParams:N({arg:t,...n}),headers:n.headers}),{Path:i}=await s.json();return i}return e}),WQ=k(r=>async(t={})=>{throw E(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),YQ=k(r=>{async function e(t={}){await(await r.post("shutdown",{signal:t.signal,searchParams:N(t),headers:t.headers})).text()}return e}),QQ=k(r=>{async function e(t={}){const n=await r.post("version",{signal:t.signal,searchParams:N(t),headers:t.headers});return{...ut(await n.json()),"ipfs-http-client":"1.0.0"}}return e}),JQ=Vr,XQ=(r,e)=>({path:decodeURIComponent(new URL(r).pathname.split("/").pop()||""),content:ZQ(r,e)});async function*ZQ(r,e){yield*(await new JQ().get(r,e)).iterator()}var eJ=XQ;function tJ(r={}){const e={name:H1.name,code:H1.code,encode:u=>u,decode:u=>u},t=Object.values(qG);(r.ipld&&r.ipld.bases?r.ipld.bases:[]).forEach(u=>t.push(u));const n=new G7({bases:t,loadBase:r.ipld&&r.ipld.loadBase}),s=Object.values(GG);[ks,$6,q6,e8,e].concat(r.ipld&&r.ipld.codecs||[]).forEach(u=>s.push(u));const i=new W7({codecs:s,loadCodec:r.ipld&&r.ipld.loadCodec}),o=Object.values(HG);(r.ipld&&r.ipld.hashers?r.ipld.hashers:[]).forEach(u=>o.push(u));const a=new Y7({hashers:o,loadHasher:r.ipld&&r.ipld.loadHasher});return{add:LQ(r),addAll:gb(r),bitswap:aW(r),block:yW(r),bootstrap:vW(r),cat:MQ(r),commands:UQ(r),config:kW(r),dag:LW(i,r),dht:JW(r),diag:tY(r),dns:BQ(r),files:fY(r),get:FQ(r),getEndpointConfig:zQ(r),id:yb(r),isOnline:VQ(r),key:_Y(r),log:IY(r),ls:jQ(r),mount:qQ(r),name:OY(r),object:KY(i,r),pin:aQ(r),ping:HQ(r),pubsub:bQ(r),refs:_Q(r),repo:RQ(r),resolve:GQ(r),start:WQ(r),stats:AQ(r),stop:YQ(r),swarm:OQ(r),version:QQ(r),bases:n,codecs:i,hashers:a}}function rJ(){const r=_E();return{transports:[r.transport],peerDiscovery:[r.discovery],connectionManager:{maxParallelDials:150,maxDialsPerPeer:4,dialTimeout:1e4,autoDial:!0},nat:{enabled:!1},metrics:{enabled:!0}}}var pe;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.DHT_DISABLED="DHT is not available",r.PUBSUB_DISABLED="PubSub is not available",r.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",r.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",r.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",r.NOT_FOUND="Not found"})(pe||(pe={}));var D;(function(r){r.DHT_DISABLED="ERR_DHT_DISABLED",r.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",r.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",r.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",r.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",r.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",r.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",r.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",r.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",r.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",r.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",r.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",r.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",r.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",r.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",r.ERR_DIALED_SELF="ERR_DIALED_SELF",r.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",r.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",r.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",r.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",r.ERR_INVALID_KEY="ERR_INVALID_KEY",r.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_PEER="ERR_INVALID_PEER",r.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",r.ERR_NOT_FOUND="ERR_NOT_FOUND",r.ERR_TIMEOUT="ERR_TIMEOUT",r.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",r.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",r.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",r.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",r.ERR_FIND_SELF="ERR_FIND_SELF",r.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",r.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",r.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",r.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",r.ERR_INVALID_CMS="ERR_INVALID_CMS",r.ERR_MISSING_KEYS="ERR_MISSING_KEYS",r.ERR_NO_KEY="ERR_NO_KEY",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",r.ERR_INVALID_RECORD="ERR_INVALID_RECORD",r.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",r.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED"})(D||(D={}));async function*Q1(r,e){yield*_t(r,async t=>(await e.addressBook.add(t.id,t.multiaddrs),t))}function wb(r){const e=new Set;return Ze(r,t=>e.has(t.id.toString())?!1:(e.add(t.id.toString()),!0))}async function*mb(r,e=1){let t=0;for await(const n of r)t++,yield n;if(t<e)throw E(new Error("not found"),"NOT_FOUND")}const Ui=new Map,nJ=()=>`${Date.now()}:${Math.floor(Math.random()*1e6)}`;async function sJ(r,e,t){for(;Ui.get(t);){try{await r()}catch(n){setTimeout(()=>{throw n},1);break}if(!Ui.get(t))break;await new Promise(n=>{const s=setTimeout(n,e);Ui.set(t,s)})}}function iJ(r,e,t){t=t||e;const n=nJ(),s=setTimeout(()=>{sJ(r,e,n)},t);return Ui.set(n,s),n}function oJ(r){const e=Ui.get(r);e&&(clearTimeout(e),Ui.delete(r))}var Lu={setDelayedInterval:iJ,clearDelayedInterval:oJ};const T5=O("libp2p:peer-routing");class aJ{constructor(e,t){this.components=e,this.routers=t.routers,this.refreshManagerInit=t.refreshManager??{},this.started=!1,this._findClosestPeersTask=this._findClosestPeersTask.bind(this)}isStarted(){return this.started}async start(){this.started||this.routers.length===0||this.timeoutId!=null||this.refreshManagerInit.enabled===!1||(this.timeoutId=Lu.setDelayedInterval(this._findClosestPeersTask,this.refreshManagerInit.interval,this.refreshManagerInit.bootDelay),this.started=!0)}async _findClosestPeersTask(){if(this.abortController==null)try{this.abortController=new $e.TimeoutController(this.refreshManagerInit.timeout??1e4);try{Se.setMaxListeners?.(1/0,this.abortController.signal)}catch{}await Et(this.getClosestPeers(this.components.peerId.toBytes(),{signal:this.abortController.signal}))}catch(e){T5.error(e)}finally{this.abortController?.clear(),this.abortController=void 0}}async stop(){Lu.clearDelayedInterval(this.timeoutId),this.abortController?.abort(),this.started=!1}async findPeer(e,t){if(this.routers.length===0)throw E(new Error("No peer routers available"),D.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw E(new Error("Should not try to find self"),D.ERR_FIND_SELF);const n=await ne(qt(...this.routers.map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(i){T5.error(i)}}())),s=>Ze(s,Boolean),s=>Q1(s,this.components.peerStore),async s=>await fr(s));if(n!=null)return n;throw E(new Error(pe.NOT_FOUND),D.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(this.routers.length===0)throw E(new Error("No peer routers available"),D.ERR_NO_ROUTERS_AVAILABLE);yield*ne(qt(...this.routers.map(n=>n.getClosestPeers(e,t))),n=>Q1(n,this.components.peerStore),n=>wb(n),n=>mb(n))}}class cJ{constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw E(new Error("No content this.routers available"),D.ERR_NO_ROUTERS_AVAILABLE);yield*ne(qt(...this.routers.map(n=>n.findProviders(e,t))),n=>Q1(n,this.components.peerStore),n=>wb(n),n=>mb(n))}async provide(e,t={}){if(this.routers.length===0)throw E(new Error("No content routers available"),D.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>await n.provide(e,t)))}async put(e,t,n){if(!this.isStarted())throw E(new Error(pe.NOT_STARTED_YET),D.DHT_NOT_STARTED);const s=this.components.dht;s!=null&&await Et(s.put(e,t,n))}async get(e,t){if(!this.isStarted())throw E(new Error(pe.NOT_STARTED_YET),D.DHT_NOT_STARTED);const n=this.components.dht;if(n!=null){for await(const s of n.get(e,t))if(s.name==="VALUE")return s.value}throw E(new Error(pe.NOT_FOUND),D.ERR_NOT_FOUND)}async*getMany(e,t,n){if(!this.isStarted())throw E(new Error(pe.NOT_STARTED_YET),D.DHT_NOT_STARTED);if(t==null||t===0)return;let s=0;const i=this.components.dht;if(i!=null){for await(const o of i.get(e,n))if(o.name==="VALUE"&&(yield{from:o.from,val:o.value},s++,s===t))break}if(s===0)throw E(new Error(pe.NOT_FOUND),D.ERR_NOT_FOUND)}}function lJ(r){const e=r.getPeerId();if(e==null)throw E(new Error(`${r.toString()} does not have a valid peer type`),D.ERR_INVALID_MULTIADDR);try{return re(e)}catch{throw E(new Error(`${r.toString()} is not a valid peer type`),D.ERR_INVALID_MULTIADDR)}}function ca(r){if(Ys(r))return{id:r,multiaddrs:[],protocols:[]};typeof r=="string"&&(r=X(r));let e;return wl(r)&&(e=r,r=lJ(r)),{id:r,multiaddrs:e!=null?[e]:[],protocols:[]}}const uJ=r=>r;class dJ extends st{constructor(e,t){super();const{listen:n=[],announce:s=[]}=t;this.components=e,this.listen=new Set(n.map(i=>i.toString())),this.announce=new Set(s.map(i=>i.toString())),this.observed=new Set,this.announceFilter=t.announceFilter??uJ}getListenAddrs(){return Array.from(this.listen).map(e=>X(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>X(e))}getObservedAddrs(){return Array.from(this.observed).map(e=>X(e))}confirmObservedAddr(e){}removeObservedAddr(e){}addObservedAddr(e){let t=X(e);const n=t.getPeerId();n!=null&&re(n).equals(this.components.peerId)&&(t=t.decapsulate(X(`/p2p/${this.components.peerId.toString()}`)));const s=t.toString();this.observed.has(s)||(this.observed.add(s),this.dispatchEvent(new Z("change:addresses")))}getAddresses(){let e=this.getAnnounceAddrs().map(n=>n.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(n=>n.toString())),e=e.concat(this.getObservedAddrs().map(n=>n.toString()));const t=new Set(e);return this.announceFilter(Array.from(t).map(n=>X(n))).map(n=>n.getPeerId()===this.components.peerId.toString()?n:n.encapsulate(`/p2p/${this.components.peerId.toString()}`))}}const D5=O("libp2p:connection-manager:latency-monitor:visibility-change-emitter");class hJ extends st{constructor(){super(),this.hidden="hidden",this.visibilityChange="visibilityChange",globalThis.document!=null&&(this._initializeVisibilityVarNames(),this._addVisibilityChangeListener())}_initializeVisibilityVarNames(){let e="hidden",t="visibilitychange";typeof globalThis.document.hidden<"u"?(e="hidden",t="visibilitychange"):typeof globalThis.document.mozHidden<"u"?(e="mozHidden",t="mozvisibilitychange"):typeof globalThis.document.msHidden<"u"?(e="msHidden",t="msvisibilitychange"):typeof globalThis.document.webkitHidden<"u"&&(e="webkitHidden",t="webkitvisibilitychange"),this.hidden=e,this.visibilityChange=t}_addVisibilityChangeListener(){typeof globalThis.document.addEventListener>"u"||typeof document[this.hidden]>"u"?D5("Checking page visibility requires a browser that supports the Page Visibility API."):globalThis.document.addEventListener(this.visibilityChange,this._handleVisibilityChange.bind(this),!1)}isVisible(){if(!(this.hidden===void 0||document[this.hidden]===void 0))return document[this.hidden]==null}_handleVisibilityChange(){const e=globalThis.document[this.hidden]===!1;D5(e?"Page Visible":"Page Hidden"),this.dispatchEvent(new Z("visibilityChange",{detail:e}))}}const ln=O("libp2p:connection-manager:latency-monitor");class fJ extends st{constructor(e={}){super();const{latencyCheckIntervalMs:t,dataEmitIntervalMs:n,asyncTestFn:s,latencyRandomPercentage:i}=e;this.latencyCheckIntervalMs=t??500,this.latencyRandomPercentage=i??10,this.latencyCheckMultiply=2*(this.latencyRandomPercentage/100)*this.latencyCheckIntervalMs,this.latencyCheckSubtract=this.latencyCheckMultiply/2,this.dataEmitIntervalMs=n===null||n===0?void 0:n??5*1e3,ln("latencyCheckIntervalMs: %s dataEmitIntervalMs: %s",this.latencyCheckIntervalMs,this.dataEmitIntervalMs),this.dataEmitIntervalMs!=null?ln("Expecting ~%s events per summary",this.latencyCheckIntervalMs/this.dataEmitIntervalMs):ln("Not emitting summaries"),this.asyncTestFn=s,globalThis.process?.hrtime!=null?(ln("Using process.hrtime for timing"),this.now=globalThis.process.hrtime,this.getDeltaMS=o=>{const a=this.now(o);return a[0]*1e3+a[1]/1e6}):typeof window<"u"&&window.performance?.now!=null?(ln("Using performance.now for timing"),this.now=window.performance.now.bind(window.performance),this.getDeltaMS=o=>Math.round(this.now()-o)):(ln("Using Date.now for timing"),this.now=Date.now,this.getDeltaMS=o=>this.now()-o),this.latencyData=this.initLatencyData()}start(){pJ()&&(this.visibilityChangeEmitter=new hJ,this.visibilityChangeEmitter.addEventListener("visibilityChange",e=>{const{detail:t}=e;t?this._startTimers():(this._emitSummary(),this._stopTimers())})),this.visibilityChangeEmitter?.isVisible()===!0&&this._startTimers()}stop(){this._stopTimers()}_startTimers(){this.checkLatencyID==null&&(this.checkLatency(),this.dataEmitIntervalMs!=null&&(this.emitIntervalID=setInterval(()=>this._emitSummary(),this.dataEmitIntervalMs),typeof this.emitIntervalID.unref=="function"&&this.emitIntervalID.unref()))}_stopTimers(){this.checkLatencyID!=null&&(clearTimeout(this.checkLatencyID),this.checkLatencyID=void 0),this.emitIntervalID!=null&&(clearInterval(this.emitIntervalID),this.emitIntervalID=void 0)}_emitSummary(){const e=this.getSummary();e.events>0&&this.dispatchEvent(new Z("data",{detail:e}))}getSummary(){const e={events:this.latencyData.events,minMs:this.latencyData.minMs,maxMs:this.latencyData.maxMs,avgMs:this.latencyData.events>0?this.latencyData.totalMs/this.latencyData.events:Number.POSITIVE_INFINITY,lengthMs:this.getDeltaMS(this.latencyData.startTime)};return this.latencyData=this.initLatencyData(),ln.trace("Summary: %O",e),e}checkLatency(){const e=Math.random()*this.latencyCheckMultiply-this.latencyCheckSubtract,t={deltaOffset:Math.ceil(this.latencyCheckIntervalMs+e),startTime:this.now()},n=()=>{if(this.checkLatencyID==null)return;const s=this.getDeltaMS(t.startTime)-t.deltaOffset;this.checkLatency(),this.latencyData.events++,this.latencyData.minMs=Math.min(this.latencyData.minMs,s),this.latencyData.maxMs=Math.max(this.latencyData.maxMs,s),this.latencyData.totalMs+=s,ln.trace("MS: %s Data: %O",s,this.latencyData)};ln.trace("localData: %O",t),this.checkLatencyID=setTimeout(()=>{this.asyncTestFn!=null?(t.deltaOffset=0,t.startTime=this.now(),this.asyncTestFn(n)):(t.deltaOffset-=1,n())},t.deltaOffset),typeof this.checkLatencyID.unref=="function"&&this.checkLatencyID.unref()}initLatencyData(){return{startTime:this.now(),minMs:Number.POSITIVE_INFINITY,maxMs:Number.NEGATIVE_INFINITY,events:0,totalMs:0}}}function pJ(){return typeof globalThis.window<"u"}const bb="OPEN",P5="CLOSING",zh="CLOSED";function Mu(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}class gJ{constructor(e){if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return Mu(this.map.entries(),e=>[re(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,re(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return Mu(this.map.keys(),e=>re(e))}values(){return this.map.values()}get size(){return this.map.size}}class Ts{constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Mu(this.set.entries(),e=>{const t=re(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=re(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Mu(this.set.values(),e=>re(e))}intersection(e){const t=new Ts;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new Ts;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new Ts;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}const yJ="keep-alive";var Nd=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=typeof e>"u"?1:e}get msDuration(){return this.duration*1e3}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=typeof e>"u"?0:e}get msBlockDuration(){return this.blockDuration*1e3}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=typeof e>"u"?!1:Boolean(e)}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=typeof e>"u"?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(typeof e>"u"&&(e="rlflx"),typeof e!="string")throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}},wJ=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){const e=Date.now();Object.keys(this._keys).forEach(t=>{this._keys[t]<=e&&delete this._keys[t]}),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,t*1e3)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){const t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();const n=Date.now();return t>=n?t-n:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach(t=>{delete this._keys[t]})}};const mJ=wJ;var bJ=mJ,pr=class{constructor(e,t,n,s){this.remainingPoints=typeof e>"u"?0:e,this.msBeforeNext=typeof t>"u"?0:t,this.consumedPoints=typeof n>"u"?0:n,this.isFirstInDuration=typeof s>"u"?!1:s}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=Boolean(e)}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}};const Fh=Nd,EJ=bJ,k5=pr;var ac=class extends Fh{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed||e.inmemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration||e.inmemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new EJ}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,n,s,i,o={}){const a=this._getRateLimiterRes(n,s,i);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&a.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(n,a.msBeforeNext),a.consumedPoints>this.points?t(a):e(a);if(a.consumedPoints>this.points){let c=Promise.resolve();this.blockDuration>0&&a.consumedPoints<=this.points+s&&(a.msBeforeNext=this.msBlockDuration,c=this._block(n,a.consumedPoints,this.msBlockDuration,o)),this.inMemoryBlockOnConsumed>0&&a.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(n,this.inMemoryBlockDuration),a.msBeforeNext=this.msInMemoryBlockDuration),c.then(()=>{t(a)}).catch(u=>{t(u)})}else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,c,a)}else e(a)}_handleError(e,t,n,s,i,o=!1,a={}){this.insuranceLimiter instanceof Fh?this.insuranceLimiter[t](i,o,a).then(c=>{n(c)}).catch(c=>{s(c)}):s(e)}get _inmemoryBlockedKeys(){return this._inMemoryBlockedKeys}getInmemoryBlockMsBeforeExpire(e){return this.getInMemoryBlockMsBeforeExpire(e)}get inmemoryBlockOnConsumed(){return this.inMemoryBlockOnConsumed}set inmemoryBlockOnConsumed(e){this.inMemoryBlockOnConsumed=e}get inmemoryBlockDuration(){return this.inMemoryBlockDuration}set inmemoryBlockDuration(e){this.inMemoryBlockDuration=e}get msInmemoryBlockDuration(){return this.inMemoryBlockDuration*1e3}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&this.inMemoryBlockOnConsumed===0)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return this._inMemoryBlockDuration*1e3}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(typeof e<"u"&&!(e instanceof Fh))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,n={}){const s=t*1e3;return this._block(this.getKey(e),this.points+1,s,n)}set(e,t,n,s={}){const i=(n>=0?n:this.duration)*1e3;return this._block(this.getKey(e),t,i,s)}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=this.getKey(e),a=this.getInMemoryBlockMsBeforeExpire(o);if(a>0)return i(new k5(0,a));this._upsert(o,t,this._getKeySecDuration(n)*1e3,!1,n).then(c=>{this._afterConsume(s,i,o,t,c)}).catch(c=>{this._handleError(c,"consume",s,i,e,t,n)})})}penalty(e,t=1,n={}){const s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,t,a))}).catch(a=>{this._handleError(a,"penalty",i,o,e,t,n)})})}reward(e,t=1,n={}){const s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,-t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,-t,a))}).catch(a=>{this._handleError(a,"reward",i,o,e,t,n)})})}get(e,t={}){const n=this.getKey(e);return new Promise((s,i)=>{this._get(n,t).then(o=>{s(o===null||typeof o>"u"?null:this._getRateLimiterRes(n,0,o))}).catch(o=>{this._handleError(o,"get",s,i,e,t)})})}delete(e,t={}){const n=this.getKey(e);return new Promise((s,i)=>{this._delete(n,t).then(o=>{this._inMemoryBlockedKeys.delete(n),s(o)}).catch(o=>{this._handleError(o,"delete",s,i,e,t)})})}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,n){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,n,s={}){return new Promise((i,o)=>{this._upsert(e,t,n,!0,s).then(()=>{i(new k5(0,n>0?n:-1,t))}).catch(a=>{this._handleError(a,"block",i,o,this.parseKey(e),n/1e3,s)})})}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,n,s=!1,i={}){throw new Error("You have to implement the method '_upsert'!")}};const _J=ac,vJ=pr,O5="redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ";let SJ=class extends _J{constructor(e){super(e),e.redis?this.client=e.redis:this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,typeof this.client.defineCommand=="function"&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:O5})}_isRedisReady(){return this._rejectIfRedisNotReady?!(this.client.status&&this.client.status!=="ready"||typeof this.client.isReady=="function"&&!this.client.isReady()):!0}_getRateLimiterRes(e,t,n){let[s,i]=n;Array.isArray(s)&&([,s]=s,[,i]=i);const o=new vJ;return o.consumedPoints=parseInt(s),o.isFirstInDuration=o.consumedPoints===t,o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.msBeforeNext=i,o}_upsert(e,t,n,s=!1){return new Promise((i,o)=>{if(!this._isRedisReady())return o(new Error("Redis connection is not ready"));const a=Math.floor(n/1e3),c=this.client.multi();if(s)a>0?c.set(e,t,"EX",a):c.set(e,t),c.pttl(e).exec((u,l)=>u?o(u):i(l));else if(a>0){const u=function(l,d){return l?o(l):i(d)};typeof this.client.rlflxIncr=="function"?this.client.rlflxIncr(e,t,a,u):this.client.eval(O5,1,e,t,a,u)}else c.incrby(e,t).pttl(e).exec((u,l)=>u?o(u):i(l))})}_get(e){return new Promise((t,n)=>{if(!this._isRedisReady())return n(new Error("Redis connection is not ready"));this.client.multi().get(e).pttl(e).exec((s,i)=>{if(s)n(s);else{const[o]=i;if(o===null)return t(null);t(i)}})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{s?n(s):t(i>0)})})}};var RJ=SJ;const IJ=ac,AJ=pr;function N5(r){try{const e=r.client?r.client:r,{version:t}=e.topology.s.options.metadata.driver,n=t.split(".").map(s=>parseInt(s));return{major:n[0],feature:n[1],patch:n[2]}}catch{return{major:0,feature:0,patch:0}}}let Eb=class extends IJ{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,typeof this.client.then=="function"?this.client.then(t=>{this.client=t,this._initCollection(),this._driverVersion=N5(this.client)}):(this._initCollection(),this._driverVersion=N5(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?Eb.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){const t=(typeof this.client.db=="function"?this.client.db(this.dbName):this.client).collection(this.tableName);t.createIndex({expire:-1},{expireAfterSeconds:0}),t.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=t}_getRateLimiterRes(e,t,n){const s=new AJ;let i;return typeof n.value>"u"?i=n:i=n.value,s.isFirstInDuration=i.points===t,s.consumedPoints=i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire!==null?Math.max(new Date(i.expire).getTime()-Date.now(),0):-1,s}_upsert(e,t,n,s=!1,i={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const o=i.attrs||{};let a,c;s?(a={key:e},a=Object.assign(a,o),c={$set:{key:e,points:t,expire:n>0?new Date(Date.now()+n):null}},c.$set=Object.assign(c.$set,o)):(a={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},a=Object.assign(a,o),c={$setOnInsert:{key:e,expire:n>0?new Date(Date.now()+n):null},$inc:{points:t}},c.$setOnInsert=Object.assign(c.$setOnInsert,o));const u={upsert:!0};return this._driverVersion.major>=4||this._driverVersion.major===3&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?u.returnDocument="after":u.returnOriginal=!1,new Promise((l,d)=>{this._collection.findOneAndUpdate(a,c,u).then(f=>{l(f)}).catch(f=>{if(f&&f.code===11e3){const g=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},o),h={$set:Object.assign({key:e,points:t,expire:n>0?new Date(Date.now()+n):null},o)};this._collection.findOneAndUpdate(g,h,u).then(p=>{l(p)}).catch(p=>{p&&p.code===11e3?this._upsert(e,t,n,s).then(w=>l(w)).catch(w=>d(w)):d(p)})}else d(f)})})}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},s=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},n);return this._collection.findOne(s)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},s=Object.assign({key:e},n);return this._collection.deleteOne(s).then(i=>i.deletedCount>0)}};var CJ=Eb;const TJ=ac,DJ=pr;let PJ=class extends TJ{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createDbAndTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{this._getConnection().then(n=>{n.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],()=>{this._releaseConnection(n),t()})}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise((e,t)=>{this.client.getConnection((n,s)=>{if(n)return t(n);e(s)})});case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise((e,t)=>{this._getConnection().then(n=>{n.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,s=>{if(s)return this._releaseConnection(n),t(s);n.query(this._getCreateTableStmt(),i=>{if(i)return this._releaseConnection(n),t(i);this._releaseConnection(n),e()})})}).catch(n=>{t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(typeof e>"u")if(this.client.constructor.name==="Connection")e="connection";else if(this.client.constructor.name==="Pool")e="pool";else if(this.client.constructor.name==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:Boolean(e)}_getRateLimiterRes(e,t,n){const s=new DJ,[i]=n;return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_upsertTransaction(e,t,n,s,i){return new Promise((o,a)=>{e.query("BEGIN",c=>{if(c)return e.rollback(),a(c);const u=Date.now(),l=s>0?u+s:null;let d,f;i?(d=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = ?, 
            expire = ?;`,f=[this.dbName,this.tableName,t,n,l,n,l]):(d=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = IF(expire <= ?, ?, points + (?)), 
            expire = IF(expire <= ?, ?, expire);`,f=[this.dbName,this.tableName,t,n,l,u,n,n,u,l]),e.query(d,f,g=>{if(g)return e.rollback(),a(g);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],(h,p)=>{if(h)return e.rollback(),a(h);e.query("COMMIT",w=>{if(w)return e.rollback(),a(w);o(p)})})})})})}_upsert(e,t,n,s=!1){return this.tableCreated?new Promise((i,o)=>{this._getConnection().then(a=>{this._upsertTransaction(a,e,t,n,s).then(c=>{i(c),this._releaseConnection(a)}).catch(c=>{o(c),this._releaseConnection(a)})}).catch(a=>{o(a)})}):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],(i,o)=>{i?n(i):o.length===0?t(null):t(o),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],(i,o)=>{i?n(i):t(o.affectedRows>0),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}};var kJ=PJ;const OJ=ac,NJ=pr;let xJ=class extends OJ{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?typeof t=="function"&&t():this._createTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{const n={name:"rlflx-clear-expired",text:`DELETE FROM ${this.tableName} WHERE expire < $1`,values:[e]};this._query(n).then(()=>{t()}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master);default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);case"typeorm":return!0;default:return!0}}_createTable(){return new Promise((e,t)=>{this._query({text:this._getCreateTableStmt()}).then(()=>{e()}).catch(n=>{n.code==="23505"?e():t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this.tableName} ( 
      key varchar(255) PRIMARY KEY,
      points integer NOT NULL DEFAULT 0,
      expire bigint
    );`}get clientType(){return this._clientType}set clientType(e){const t=this.client.constructor.name;if(typeof e>"u")if(t==="Client")e="client";else if(t==="Pool"||t==="BoundPool")e="pool";else if(t==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:Boolean(e)}_getRateLimiterRes(e,t,n){const s=new NJ,i=n.rows[0];return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_query(e){const n={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise((s,i)=>{this._getConnection().then(o=>{o.query(n).then(a=>{s(a),this._releaseConnection(o)}).catch(a=>{i(a),this._releaseConnection(o)})}).catch(o=>{i(o)})})}_upsert(e,t,n,s=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));const i=n>0?Date.now()+n:null,o=s?" $3 ":` CASE
             WHEN ${this.tableName}.expire <= $4 THEN $3
             ELSE ${this.tableName}.expire
            END `;return this._query({name:s?"rlflx-upsert-force":"rlflx-upsert",text:`
            INSERT INTO ${this.tableName} VALUES ($1, $2, $3)
              ON CONFLICT(key) DO UPDATE SET
                points = CASE
                          WHEN (${this.tableName}.expire <= $4 OR 1=${s?1:0}) THEN $2
                          ELSE ${this.tableName}.points + ($2)
                         END,
                expire = ${o}
            RETURNING points, expire;`,values:[e,t,i,Date.now()]})}_get(e){return this.tableCreated?new Promise((t,n)=>{this._query({name:"rlflx-get",text:`
            SELECT points, expire FROM ${this.tableName} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then(s=>{s.rowCount===0&&(s=null),t(s)}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this.tableName} WHERE key = $1`,values:[e]}).then(t=>t.rowCount>0):Promise.reject(Error("Table is not created yet"))}};var $J=xJ,LJ=class{constructor(e,t,n=null){this.value=e,this.expiresAt=t,this.timeoutId=n}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){!(e instanceof Date)&&Number.isInteger(e)&&(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}};const MJ=LJ,Vh=pr;var UJ=class{constructor(){this._storage={}}incrby(e,t,n){if(this._storage[e]){const s=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return s!==0?(this._storage[e].value=this._storage[e].value+t,new Vh(0,s,this._storage[e].value,!1)):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new MJ(t,s>0?new Date(Date.now()+s):null),s>0&&(this._storage[e].timeoutId=setTimeout(()=>{delete this._storage[e]},s),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new Vh(0,s===0?-1:s,this._storage[e].value,!0)}get(e){if(this._storage[e]){const t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return new Vh(0,t,this._storage[e].value,!1)}return null}delete(e){return this._storage[e]?(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0):!1}};const BJ=Nd,zJ=UJ,x5=pr;let FJ=class extends BJ{constructor(e={}){super(e),this._memoryStorage=new zJ}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=this.getKey(e),a=this._getKeySecDuration(n);let c=this._memoryStorage.incrby(o,t,a);if(c.remainingPoints=Math.max(this.points-c.consumedPoints,0),c.consumedPoints>this.points)this.blockDuration>0&&c.consumedPoints<=this.points+t&&(c=this._memoryStorage.set(o,c.consumedPoints,this.blockDuration)),i(c);else if(this.execEvenly&&c.msBeforeNext>0&&!c.isFirstInDuration){let u=Math.ceil(c.msBeforeNext/(c.remainingPoints+2));u<this.execEvenlyMinDelayMs&&(u=c.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(s,u,c)}else s(c)})}penalty(e,t=1,n={}){const s=this.getKey(e);return new Promise(i=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}reward(e,t=1,n={}){const s=this.getKey(e);return new Promise(i=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,-t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}block(e,t){const n=t*1e3,s=this.points+1;return this._memoryStorage.set(this.getKey(e),s,t),Promise.resolve(new x5(0,n===0?-1:n,s))}set(e,t,n){const s=(n>=0?n:this.duration)*1e3;return this._memoryStorage.set(this.getKey(e),t,n),Promise.resolve(new x5(0,s===0?-1:s,t))}get(e){const t=this._memoryStorage.get(this.getKey(e));return t!==null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};var _b=FJ;const $5=oE,VJ=iE(),jJ=Nd,vb=_b,KJ=pr,lr="rate_limiter_flexible";let Bi=null;const L5=function(r,e,t,n){let s;n===null||n===!0||n===!1?s=n:s={remainingPoints:n.remainingPoints,msBeforeNext:n.msBeforeNext,consumedPoints:n.consumedPoints,isFirstInDuration:n.isFirstInDuration},r.send({channel:lr,keyPrefix:e.keyPrefix,promiseId:e.promiseId,type:t,data:s})},Sb=function(r){setTimeout(()=>{this._initiated?Oi.send(r):typeof this._promises[r.promiseId]<"u"&&Sb.call(this,r)},30)},_i=function(r,e,t,n,s){const i={channel:lr,keyPrefix:this.keyPrefix,func:r,promiseId:e,data:{key:t,arg:n,opts:s}};this._initiated?Oi.send(i):Sb.call(this,i)},Rb=function(r,e){if(!e||e.channel!==lr||typeof this._rateLimiters[e.keyPrefix]>"u")return!1;let t;switch(e.func){case"consume":t=this._rateLimiters[e.keyPrefix].consume(e.data.key,e.data.arg,e.data.opts);break;case"penalty":t=this._rateLimiters[e.keyPrefix].penalty(e.data.key,e.data.arg,e.data.opts);break;case"reward":t=this._rateLimiters[e.keyPrefix].reward(e.data.key,e.data.arg,e.data.opts);break;case"block":t=this._rateLimiters[e.keyPrefix].block(e.data.key,e.data.arg,e.data.opts);break;case"get":t=this._rateLimiters[e.keyPrefix].get(e.data.key,e.data.opts);break;case"delete":t=this._rateLimiters[e.keyPrefix].delete(e.data.key,e.data.opts);break;default:return!1}t&&t.then(n=>{L5(r,e,"resolve",n)}).catch(n=>{L5(r,e,"reject",n)})},qJ=function(r){if(!r||r.channel!==lr||r.keyPrefix!==this.keyPrefix)return!1;if(this._promises[r.promiseId]){clearTimeout(this._promises[r.promiseId].timeoutId);let e;switch(r.data===null||r.data===!0||r.data===!1?e=r.data:e=new KJ(r.data.remainingPoints,r.data.msBeforeNext,r.data.consumedPoints,r.data.isFirstInDuration),r.type){case"resolve":this._promises[r.promiseId].resolve(e);break;case"reject":this._promises[r.promiseId].reject(e);break;default:throw new Error(`RateLimiterCluster: no such message type '${r.type}'`)}delete this._promises[r.promiseId]}},HJ=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},vi=function(r,e){const t=Oi.hrtime();let n=t[0].toString()+t[1].toString();return typeof this._promises[n]<"u"&&(n+=VJ.randomBytes(12).toString("base64")),this._promises[n]={resolve:r,reject:e,timeoutId:setTimeout(()=>{delete this._promises[n],e(new Error("RateLimiterCluster timeout: no answer from master in time"))},this.timeoutMs)},n};let GJ=class{constructor(){if(Bi)return Bi;this._rateLimiters={},$5.setMaxListeners(0),$5.on("message",(e,t)=>{t&&t.channel===lr&&t.type==="init"?(typeof this._rateLimiters[t.opts.keyPrefix]>"u"&&(this._rateLimiters[t.opts.keyPrefix]=new vb(t.opts)),e.send({channel:lr,type:"init",keyPrefix:t.opts.keyPrefix})):Rb.call(this,e,t)}),Bi=this}},WJ=class{constructor(e){if(Bi)return Bi;this._rateLimiters={},e.launchBus((t,n)=>{n.on("process:msg",s=>{const i=s.raw;if(i&&i.channel===lr&&i.type==="init")typeof this._rateLimiters[i.opts.keyPrefix]>"u"&&(this._rateLimiters[i.opts.keyPrefix]=new vb(i.opts)),e.sendDataToProcessId(s.process.pm_id,{data:{},topic:lr,channel:lr,type:"init",keyPrefix:i.opts.keyPrefix},(o,a)=>{o&&console.log(o,a)});else{const o={send:a=>{const c=a;c.topic=lr,typeof c.data>"u"&&(c.data={}),e.sendDataToProcessId(s.process.pm_id,c,(u,l)=>{u&&console.log(u,l)})}};Rb.call(this,o,i)}})}),Bi=this}};class YJ extends jJ{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=typeof e>"u"?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),Oi.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,Oi.on("message",t=>{t&&t.channel===lr&&t.type==="init"&&t.keyPrefix===this.keyPrefix?this._initiated=!0:qJ.call(this,t)}),Oi.send({channel:lr,type:"init",opts:HJ.call(this)}),this._promises={}}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=vi.call(this,s,i);_i.call(this,"consume",o,e,t,n)})}penalty(e,t=1,n={}){return new Promise((s,i)=>{const o=vi.call(this,s,i);_i.call(this,"penalty",o,e,t,n)})}reward(e,t=1,n={}){return new Promise((s,i)=>{const o=vi.call(this,s,i);_i.call(this,"reward",o,e,t,n)})}block(e,t,n={}){return new Promise((s,i)=>{const o=vi.call(this,s,i);_i.call(this,"block",o,e,t,n)})}get(e,t={}){return new Promise((n,s)=>{const i=vi.call(this,n,s);_i.call(this,"get",i,e,t)})}delete(e,t={}){return new Promise((n,s)=>{const i=vi.call(this,n,s);_i.call(this,"delete",i,e,t)})}}var QJ={RateLimiterClusterMaster:GJ,RateLimiterClusterMasterPM2:WJ,RateLimiterCluster:YJ};const JJ=ac,XJ=pr;let ZJ=class extends JJ{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,n){const s=new XJ;return s.consumedPoints=parseInt(n.consumedPoints),s.isFirstInDuration=n.consumedPoints===t,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=n.msBeforeNext,s}_upsert(e,t,n,s=!1,i={}){return new Promise((o,a)=>{const c=Date.now(),u=Math.floor(n/1e3);s?this.client.set(e,t,u,l=>{l?a(l):this.client.set(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const d={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(d)})}):this.client.incr(e,t,(l,d)=>{l||d===!1?this.client.add(e,t,u,(f,g)=>{if(f||!g)if(typeof i.attemptNumber>"u"||i.attemptNumber<3){const h=Object.assign({},i);h.attemptNumber=h.attemptNumber?h.attemptNumber+1:1,this._upsert(e,t,n,s,h).then(p=>o(p)).catch(p=>a(p))}else a(new Error("Can not add key"));else this.client.add(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const h={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(h)})}):this.client.get(`${e}_expire`,(f,g)=>{if(f)a(f);else{const h=g===!1?0:g,p={consumedPoints:d,msBeforeNext:h>=0?Math.max(h-c,0):-1};o(p)}})})})}_get(e){return new Promise((t,n)=>{const s=Date.now();this.client.get(e,(i,o)=>{o?this.client.get(`${e}_expire`,(a,c)=>{if(a)n(a);else{const u=c===!1?0:c,l={consumedPoints:o,msBeforeNext:u>=0?Math.max(u-s,0):-1};t(l)}}):t(null)})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{s?n(s):i===!1?t(i):this.client.del(`${e}_expire`,o=>{o?n(o):t(i)})})})}};var eX=ZJ;const M5=pr;var tX=class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(typeof e>"u")throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=typeof e>"u"?!1:e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new M5(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new M5(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.rejectBlack()),typeof n>"u"?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch(()=>{}),n)}block(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch(()=>{}),n)}penalty(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch(()=>{}),n)}reward(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch(()=>{}),n)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),typeof t>"u"||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}};const rX=Nd;var nX=class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach(t=>{if(!(t instanceof rX))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")}),this._limiters=e}consume(e,t=1){return new Promise((n,s)=>{const i=[];this._limiters.forEach(o=>{i.push(o.consume(e,t).catch(a=>({rejected:!0,rej:a})))}),Promise.all(i).then(o=>{const a={};let c=!1;o.forEach(u=>{u.rejected===!0&&(c=!0)});for(let u=0;u<o.length;u++)c&&o[u].rejected===!0?a[this._limiters[u].keyPrefix]=o[u].rej:c||(a[this._limiters[u].keyPrefix]=o[u]);c?s(a):n(a)})})}},sX=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}};const U5=sX,Ib=4294967295,J1="limiter";var iX=class{constructor(e,t={maxQueueSize:Ib}){this._queueLimiters={KEY_DEFAULT:new B5(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=J1){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=J1){return this._queueLimiters[t]||(this._queueLimiters[t]=new B5(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}};class B5{constructor(e,t={maxQueueSize:Ib,key:J1}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then(e=>e!==null?e.remainingPoints:this._limiterFlexible.points)}removeTokens(e){const t=this;return new Promise((n,s)=>{if(e>t._limiterFlexible.points){s(new U5(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`));return}t._queue.length>0?t._queueRequest.call(t,n,s,e):t._limiterFlexible.consume(t._key,e).then(i=>{n(i.remainingPoints)}).catch(i=>{i instanceof Error?s(i):(t._queueRequest.call(t,n,s,e),t._waitTimeout===null&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),i.msBeforeNext)))})})}_queueRequest(e,t,n){const s=this;s._queue.length<s._maxQueueSize?s._queue.push({resolve:e,reject:t,tokens:n}):t(new U5(`Number of requests reached it's maximum ${s._maxQueueSize}`))}_processFIFO(){const e=this;if(e._waitTimeout!==null&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),e._queue.length===0)return;const t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then(n=>{t.resolve(n.remainingPoints),e._processFIFO.call(e)}).catch(n=>{n instanceof Error?(t.reject(n),e._processFIFO.call(e)):(e._queue.unshift(t),e._waitTimeout===null&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),n.msBeforeNext)))})}}const jh=pr;var oX=class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return new jh(e.remainingPoints,Math.min(e.msBeforeNext,t.msBeforeNext),e.consumedPoints,e.isFirstInDuration)}consume(e,t=1,n={}){return this._rateLimiter.consume(e,t,n).catch(s=>s instanceof jh?this._burstLimiter.consume(e,t,n).then(i=>Promise.resolve(this._combineRes(s,i))).catch(i=>i instanceof jh?Promise.reject(this._combineRes(s,i)):Promise.reject(i)):Promise.reject(s))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then(([t,n])=>this._combineRes(t,n))}get points(){return this._rateLimiter.points}};const aX=RJ,cX=CJ,lX=kJ,uX=$J,{RateLimiterClusterMaster:dX,RateLimiterClusterMasterPM2:hX,RateLimiterCluster:fX}=QJ,pX=_b,gX=eX,yX=tX,wX=nX,mX=iX,bX=oX,EX=pr;var Ab={RateLimiterRedis:aX,RateLimiterMongo:cX,RateLimiterMySQL:lX,RateLimiterPostgres:uX,RateLimiterMemory:pX,RateLimiterMemcache:gX,RateLimiterClusterMaster:dX,RateLimiterClusterMasterPM2:hX,RateLimiterCluster:fX,RLWrapperBlackAndWhite:yX,RateLimiterUnion:wX,RateLimiterQueue:mX,BurstyRateLimiter:bX,RateLimiterRes:EX};const qe=O("libp2p:connection-manager"),_X={maxConnections:1/0,minConnections:0,maxData:1/0,maxSentData:1/0,maxReceivedData:1/0,maxEventLoopDelay:1/0,pollInterval:2e3,autoDialInterval:1e4,movingAverageInterval:6e4,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},Kh="libp2p",qh="connection-manager",vX=6e4;class SX extends st{constructor(e,t){if(super(),this.opts=Le.call({ignoreUndefined:!0},_X,t),this.opts.maxConnections<this.opts.minConnections)throw E(new Error("Connection Manager maxConnections must be greater than minConnections"),D.ERR_INVALID_PARAMETERS);qe("options: %o",this.opts),this.components=e,this.connections=new Map,this.started=!1,this._checkMetrics=this._checkMetrics.bind(this),this.latencyMonitor=new fJ({latencyCheckIntervalMs:t.pollInterval,dataEmitIntervalMs:t.pollInterval});try{Se.setMaxListeners?.(1/0,this)}catch{}this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.startupReconnectTimeout=t.startupReconnectTimeout??vX,this.dialTimeout=t.dialTimeout??3e4,this.allow=(t.allow??[]).map(n=>X(n)),this.deny=(t.deny??[]).map(n=>X(n)),this.inboundConnectionRateLimiter=new Ab.RateLimiterMemory({points:this.opts.inboundConnectionThreshold,duration:1}),this.incomingPendingConnections=0}isStarted(){return this.started}async start(){this.components.metrics!=null&&(this.timer=this.timer??Gi(this._checkMetrics,this.opts.pollInterval)),this.components.metrics?.updateComponentMetric({system:Kh,component:qh,metric:"connections",label:"direction",value:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)n.stat.direction==="inbound"?e.inbound++:e.outbound++;return e}}),this.components.metrics?.updateComponentMetric({system:Kh,component:qh,metric:"protocol-streams-total",label:"protocol",value:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.stat.direction} ${s.stat.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.components.metrics?.updateComponentMetric({system:Kh,component:qh,metric:"protocol-streams-per-connection-90th-percentile",label:"protocol",value:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const a=`${o.stat.direction} ${o.stat.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.latencyMonitor.start(),this._onLatencyMeasure=this._onLatencyMeasure.bind(this),this.latencyMonitor.addEventListener("data",this._onLatencyMeasure),this.started=!0,qe("started")}async afterStart(){this.components.upgrader.addEventListener("connection",this.onConnect),this.components.upgrader.addEventListener("connectionEnd",this.onDisconnect),Promise.resolve().then(async()=>{const e=[];for(const t of await this.components.peerStore.all())(await this.components.peerStore.getTags(t.id)).filter(i=>i.name===yJ).length>0&&e.push(t.id);this.connectOnStartupController?.clear(),this.connectOnStartupController=new $e.TimeoutController(this.startupReconnectTimeout);try{Se.setMaxListeners?.(1/0,this.connectOnStartupController.signal)}catch{}await Promise.all(e.map(async t=>{await this.openConnection(t,{signal:this.connectOnStartupController?.signal}).catch(n=>{qe.error(n)})}))}).catch(e=>{qe.error(e)}).finally(()=>{this.connectOnStartupController?.clear()})}async beforeStop(){this.connectOnStartupController?.abort(),this.components.upgrader.removeEventListener("connection",this.onConnect),this.components.upgrader.removeEventListener("connectionEnd",this.onDisconnect)}async stop(){this.timer?.clear(),this.latencyMonitor.removeEventListener("data",this._onLatencyMeasure),this.latencyMonitor.stop(),this.started=!1,await this._close(),qe("stopped")}async _close(){const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(s){qe.error(s)}})());qe("closing %d connections",e.length),await Promise.all(e),this.connections.clear()}async _checkMetrics(){const e=this.components.metrics;if(e!=null)try{const t=e.getGlobal().getMovingAverages(),n=t.dataReceived[this.opts.movingAverageInterval].movingAverage;await this._checkMaxLimit("maxReceivedData",n);const s=t.dataSent[this.opts.movingAverageInterval].movingAverage;await this._checkMaxLimit("maxSentData",s);const i=n+s;await this._checkMaxLimit("maxData",i),qe.trace("metrics update",i)}finally{this.timer=Gi(this._checkMetrics,this.opts.pollInterval)}}onConnect(e){this._onConnect(e).catch(t=>{qe.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}const n=t.remotePeer,s=n.toString(),i=this.connections.get(s);i!=null?i.push(t):this.connections.set(s,[t]),n.publicKey!=null&&await this.components.peerStore.keyBook.set(n,n.publicKey);const o=this.getConnections().length,a=o-this.opts.maxConnections;await this._checkMaxLimit("maxConnections",o,a),this.dispatchEvent(new Z("peer:connect",{detail:t}))}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer.toString();let s=this.connections.get(n);s!=null&&s.length>1?(s=s.filter(i=>i.id!==t.id),this.connections.set(n,s)):s!=null&&(this.connections.delete(n),this.dispatchEvent(new Z("peer:disconnect",{detail:t})),this.components.metrics?.onPeerDisconnected(t.remotePeer))}getConnections(e){if(e!=null)return this.connections.get(e.toString())??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}async openConnection(e,t={}){qe("dial to %p",e);const n=this.getConnections(e);if(n.length>0)return qe("had an existing connection to %p",e),n[0];let s;if(t?.signal==null){s=new $e.TimeoutController(this.dialTimeout),t.signal=s.signal;try{Se.setMaxListeners?.(1/0,s.signal)}catch{}}try{const i=await this.components.dialer.dial(e,t);let o=this.connections.get(e.toString());o==null&&(o=[],this.connections.set(e.toString(),o));let a=!1;for(const c of o)c.id===i.id&&(a=!0);return a||o.push(i),i}finally{s?.clear()}}async closeConnections(e){const t=this.connections.get(e.toString())??[];await Promise.all(t.map(async n=>await n.close()))}getAll(e){if(!Ys(e))throw E(new Error("peerId must be an instance of peer-id"),D.ERR_INVALID_PARAMETERS);const t=e.toString(),n=this.connections.get(t);return n!=null?n.filter(s=>s.stat.status===bb):[]}_onLatencyMeasure(e){const{detail:t}=e;this._checkMaxLimit("maxEventLoopDelay",t.avgMs,1).catch(n=>{qe.error(n)})}async _checkMaxLimit(e,t,n=1){const s=this.opts[e];qe.trace("checking limit of %s. current value: %d of %d",e,t,s),t>s&&(qe("%s: limit exceeded: %p, %d/%d, pruning %d connection(s)",this.components.peerId,e,t,s,n),await this._pruneConnections(n))}async _pruneConnections(e){const t=this.getConnections(),n=new gJ;for(const o of t){const a=o.remotePeer;if(n.has(a))continue;const c=await this.components.peerStore.getTags(a);n.set(a,c.reduce((u,l)=>u+l.value,0))}const s=t.sort((o,a)=>{const c=n.get(o.remotePeer)??0,u=n.get(a.remotePeer)??0;return c>u?1:c<u?-1:0}),i=[];for(const o of s)if(qe("too many connections open - closing a connection to %p",o.remotePeer),i.push(o),i.length===e)break;await Promise.all(i.map(async o=>{try{await o.close()}catch(a){qe.error(a)}this.onDisconnect(new Z("connectionEnd",{detail:o}))}))}async acceptIncomingConnection(e){if(this.deny.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return qe("connection from %s refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.opts.maxIncomingPendingConnections)return qe("connection from %s refused - incomingPendingConnections exceeded by peer %s",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return qe("connection from %s refused - inboundConnectionThreshold exceeded by host %s",s,e.remoteAddr),!1}}return this.getConnections().length<this.opts.maxConnections?(this.incomingPendingConnections++,!0):(qe("connection from %s refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}}const Gn=O("libp2p:connection-manager:auto-dialler"),RX={enabled:!0,minConnections:0,autoDialInterval:1e4};class IX{constructor(e,t){this.components=e,this.options=Le.call({ignoreUndefined:!0},RX,t),this.running=!1,this._autoDial=this._autoDial.bind(this),Gn("options: %j",this.options)}isStarted(){return this.running}async start(){if(!this.options.enabled){Gn("not enabled");return}this.running=!0,this._autoDial().catch(e=>{Gn.error("could start autodial",e)}),Gn("started")}async stop(){if(!this.options.enabled){Gn("not enabled");return}this.running=!1,this.autoDialTimeout!=null&&this.autoDialTimeout.clear(),Gn("stopped")}async _autoDial(){this.autoDialTimeout!=null&&this.autoDialTimeout.clear();const e=this.options.minConnections;if(this.components.connectionManager.getConnections().length>=e){this.autoDialTimeout=Gi(this._autoDial,this.options.autoDialInterval);return}const t=await this.components.peerStore.all(),n=await ne(t.sort(()=>Math.random()>.5?1:-1),s=>Ze(s,i=>!i.id.equals(this.components.peerId)),s=>Va(s,(i,o)=>o.protocols.length>i.protocols.length||o.id.publicKey!=null&&i.id.publicKey==null?1:-1),async s=>await Dn(s));for(let s=0;this.running&&s<n.length&&this.components.connectionManager.getConnections().length<e;s++){if(!this.running)return;const i=n[s];if(this.components.connectionManager.getConnections(i.id).length===0){Gn("connecting to a peerStore stored peer %p",i.id);try{await this.components.connectionManager.openConnection(i.id)}catch(o){Gn.error("could not connect to peerStore stored peer",o)}}}this.running&&(this.autoDialTimeout=Gi(this._autoDial,this.options.autoDialInterval))}}var te;(function(r){(function(s){s.SUCCESS="SUCCESS",s.HOP_SRC_ADDR_TOO_LONG="HOP_SRC_ADDR_TOO_LONG",s.HOP_DST_ADDR_TOO_LONG="HOP_DST_ADDR_TOO_LONG",s.HOP_SRC_MULTIADDR_INVALID="HOP_SRC_MULTIADDR_INVALID",s.HOP_DST_MULTIADDR_INVALID="HOP_DST_MULTIADDR_INVALID",s.HOP_NO_CONN_TO_DST="HOP_NO_CONN_TO_DST",s.HOP_CANT_DIAL_DST="HOP_CANT_DIAL_DST",s.HOP_CANT_OPEN_DST_STREAM="HOP_CANT_OPEN_DST_STREAM",s.HOP_CANT_SPEAK_RELAY="HOP_CANT_SPEAK_RELAY",s.HOP_CANT_RELAY_TO_SELF="HOP_CANT_RELAY_TO_SELF",s.STOP_SRC_ADDR_TOO_LONG="STOP_SRC_ADDR_TOO_LONG",s.STOP_DST_ADDR_TOO_LONG="STOP_DST_ADDR_TOO_LONG",s.STOP_SRC_MULTIADDR_INVALID="STOP_SRC_MULTIADDR_INVALID",s.STOP_DST_MULTIADDR_INVALID="STOP_DST_MULTIADDR_INVALID",s.STOP_RELAY_REFUSED="STOP_RELAY_REFUSED",s.MALFORMED_MESSAGE="MALFORMED_MESSAGE"})(r.Status||(r.Status={}));let e;(function(s){s[s.SUCCESS=100]="SUCCESS",s[s.HOP_SRC_ADDR_TOO_LONG=220]="HOP_SRC_ADDR_TOO_LONG",s[s.HOP_DST_ADDR_TOO_LONG=221]="HOP_DST_ADDR_TOO_LONG",s[s.HOP_SRC_MULTIADDR_INVALID=250]="HOP_SRC_MULTIADDR_INVALID",s[s.HOP_DST_MULTIADDR_INVALID=251]="HOP_DST_MULTIADDR_INVALID",s[s.HOP_NO_CONN_TO_DST=260]="HOP_NO_CONN_TO_DST",s[s.HOP_CANT_DIAL_DST=261]="HOP_CANT_DIAL_DST",s[s.HOP_CANT_OPEN_DST_STREAM=262]="HOP_CANT_OPEN_DST_STREAM",s[s.HOP_CANT_SPEAK_RELAY=270]="HOP_CANT_SPEAK_RELAY",s[s.HOP_CANT_RELAY_TO_SELF=280]="HOP_CANT_RELAY_TO_SELF",s[s.STOP_SRC_ADDR_TOO_LONG=320]="STOP_SRC_ADDR_TOO_LONG",s[s.STOP_DST_ADDR_TOO_LONG=321]="STOP_DST_ADDR_TOO_LONG",s[s.STOP_SRC_MULTIADDR_INVALID=350]="STOP_SRC_MULTIADDR_INVALID",s[s.STOP_DST_MULTIADDR_INVALID=351]="STOP_DST_MULTIADDR_INVALID",s[s.STOP_RELAY_REFUSED=390]="STOP_RELAY_REFUSED",s[s.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE"})(e||(e={})),function(s){s.codec=()=>ji(e)}(r.Status||(r.Status={})),function(s){s.HOP="HOP",s.STOP="STOP",s.STATUS="STATUS",s.CAN_HOP="CAN_HOP"}(r.Type||(r.Type={}));let t;(function(s){s[s.HOP=1]="HOP",s[s.STOP=2]="STOP",s[s.STATUS=3]="STATUS",s[s.CAN_HOP=4]="CAN_HOP"})(t||(t={})),function(s){s.codec=()=>ji(t)}(r.Type||(r.Type={})),function(s){let i;s.codec=()=>(i==null&&(i=tt((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),(c.writeDefaults===!0||o.id!=null&&o.id.byteLength>0)&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const u of o.addrs)a.uint32(18),a.bytes(u);c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={id:new Uint8Array(0),addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const l=o.uint32();switch(l>>>3){case 1:c.id=o.bytes();break;case 2:c.addrs.push(o.bytes());break;default:o.skipType(l&7);break}}return c})),i),s.encode=o=>rt(o,s.codec()),s.decode=o=>nt(o,s.codec())}(r.Peer||(r.Peer={}));let n;r.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.Type.codec().encode(s.type,i)),s.srcPeer!=null&&(i.uint32(18),r.Peer.codec().encode(s.srcPeer,i,{writeDefaults:!1})),s.dstPeer!=null&&(i.uint32(26),r.Peer.codec().encode(s.dstPeer,i,{writeDefaults:!1})),s.code!=null&&(i.uint32(32),r.Status.codec().encode(s.code,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(s);break;case 2:o.srcPeer=r.Peer.codec().decode(s,s.uint32());break;case 3:o.dstPeer=r.Peer.codec().decode(s,s.uint32());break;case 4:o.code=r.Status.codec().decode(s);break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>rt(s,r.codec()),r.decode=s=>nt(s,r.codec())})(te||(te={}));const AX=O("libp2p:stream:converter");function z5(r,e={}){const{stream:t,remoteAddr:n}=r,{sink:s,source:i}=t,o=async function*(){for await(const u of i)yield*u}(),a={async sink(u){e.signal!=null&&(u=Ps(u,e.signal));try{await s(u),await c()}catch(l){l.type!=="aborted"&&AX(l)}},source:e.signal!=null?Ps(o,e.signal):o,remoteAddr:n,timeline:{open:Date.now(),close:void 0},async close(){await s(async function*(){yield new Uint8Array(0)}()),await c()}};async function c(){return a.timeline.close==null&&(a.timeline.close=Date.now()),await Promise.resolve()}return a}const to="/libp2p/circuit/relay/0.1.0";function CX(r){const e=new Map;async function t(i){const o=i.toString().split("/p2p-circuit").find(f=>f!==""),a=X(o),c=a.getPeerId();if(c==null)throw new Error("Could not determine relay peer from multiaddr");const u=re(c);await r.peerStore.addressBook.add(u,[a]);const l=await r.connectionManager.openConnection(u),d=l.remoteAddr.encapsulate("/p2p-circuit");e.set(l.remotePeer.toString(),d),s.dispatchEvent(new Z("listening"))}function n(){const i=[];for(const o of e.values())i.push(o);return i}const s=Object.assign(new st,{close:async()=>await Promise.resolve(),listen:t,getAddrs:n});return r.connectionManager.addEventListener("peer:disconnect",i=>{const{detail:o}=i;e.delete(o.remotePeer.toString())&&s.dispatchEvent(new Z("close"))}),s}function F5(r,e){r.write({type:te.Type.STATUS,code:e})}function Cb(r,e){try{r.dstPeer?.addrs!=null&&r.dstPeer.addrs.forEach(t=>X(t))}catch(t){throw F5(e,r.type===te.Type.HOP?te.Status.HOP_DST_MULTIADDR_INVALID:te.Status.STOP_DST_MULTIADDR_INVALID),t}try{r.srcPeer?.addrs!=null&&r.srcPeer.addrs.forEach(t=>X(t))}catch(t){throw F5(e,r.type===te.Type.HOP?te.Status.HOP_SRC_MULTIADDR_INVALID:te.Status.STOP_SRC_MULTIADDR_INVALID),t}}const Ko=O("libp2p:circuit:stream-handler");class xd{constructor(e){const{stream:t,maxLength:n=4096}=e;this.stream=t,this.shake=S0(this.stream),this.decoder=Gr.fromReader(this.shake.reader,{maxDataLength:n})}async read(){const e=await this.decoder.next();if(e.value!=null){const t=te.decode(e.value);return Ko("read message type",t.type),t}Ko("read received no value, closing stream"),this.close()}write(e){Ko("write message type %s",e.type),this.shake.write(Dr.single(te.encode(e)))}rest(){return this.shake.rest(),this.shake.stream}end(e){this.write(e),this.close()}close(){Ko("closing the stream"),this.rest().sink([]).catch(e=>{Ko.error(e)})}}const _a=O("libp2p:circuit:stop");function TX(r){const{connection:e,request:t,streamHandler:n}=r;try{Cb(t,n)}catch(s){_a.error("invalid stop request via peer %p %o",e.remotePeer,s);return}return _a("stop request is valid"),n.write({type:te.Type.STATUS,code:te.Status.SUCCESS}),n.rest()}async function DX(r){const{connection:e,request:t,signal:n}=r,s=await e.newStream(to,{signal:n});_a("starting stop request to %p",e.remotePeer);const i=new xd({stream:s});i.write(t);const o=await i.read();if(o==null){i.close();return}if(o.code===te.Status.SUCCESS)return _a("stop request to %p was successful",e.remotePeer),i.rest();_a("stop request failed with code %d",o.code),i.close()}const ir=O("libp2p:circuit:hop");async function PX(r){const{connection:e,request:t,streamHandler:n,circuit:s,connectionManager:i}=r;if(!s.hopEnabled())return ir("HOP request received but we are not acting as a relay"),n.end({type:te.Type.STATUS,code:te.Status.HOP_CANT_SPEAK_RELAY});try{Cb(t,n)}catch(d){ir.error("invalid hop request via peer %p %o",e.remotePeer,d);return}if(t.dstPeer==null){ir("HOP request received but we do not receive a dstPeer");return}const o=Xr(t.dstPeer.id),a=i.getConnections(o);if(a.length===0&&!s.hopActive())return ir("HOP request received but we are not connected to the destination peer"),n.end({type:te.Type.STATUS,code:te.Status.HOP_NO_CONN_TO_DST});if(a.length===0)return ir("did not have connection to remote peer"),n.end({type:te.Type.STATUS,code:te.Status.HOP_NO_CONN_TO_DST});const c={type:te.Type.STOP,dstPeer:t.dstPeer,srcPeer:t.srcPeer};let u;try{ir("performing STOP request");const d=await DX({connection:a[0],request:c});if(d==null)throw new Error("Could not stop");u=d}catch(d){ir.error(d);return}ir("hop request from %p is valid",e.remotePeer),n.write({type:te.Type.STATUS,code:te.Status.SUCCESS});const l=n.rest();return ir("creating related connections"),await ne(l,u,l)}async function kX(r){const{connection:e,request:t,signal:n}=r,s=await e.newStream(to,{signal:n}),i=new xd({stream:s});i.write(t);const o=await i.read();if(o==null)throw E(new Error("HOP request had no response"),D.ERR_HOP_REQUEST_FAILED);if(o.code===te.Status.SUCCESS)return ir("hop request was successful"),i.rest();throw ir("hop request failed with code %d, closing stream",o.code),i.close(),E(new Error(`HOP request failed with code "${o.code??"unknown"}"`),D.ERR_HOP_REQUEST_FAILED)}async function OX(r){const{connection:e,signal:t}=r,n=await e.newStream(to,{signal:t}),s=new xd({stream:n});s.write({type:te.Type.CAN_HOP});const i=await s.read();return await s.close(),!(i==null||i.code!==te.Status.SUCCESS)}function NX(r){const{connection:e,streamHandler:t,circuit:n}=r,s=n.hopEnabled();ir("can hop (%s) request from %p",s,e.remotePeer),t.end({type:te.Type.STATUS,code:s?te.Status.SUCCESS:te.Status.HOP_CANT_SPEAK_RELAY})}const nr=O("libp2p:circuit");class xX{constructor(e,t){this._init=t,this.components=e,this._started=!1}isStarted(){return this._started}async start(){this._started||(this._started=!0,await this.components.registrar.handle(to,e=>{this._onProtocol(e).catch(t=>{nr.error(t)})}).catch(e=>{nr.error(e)}))}async stop(){await this.components.registrar.unhandle(to)}hopEnabled(){return!0}hopActive(){return!0}get[vE](){return!0}get[Symbol.toStringTag](){return"libp2p/circuit-relay-v1"}async _onProtocol(e){const{connection:t,stream:n}=e,s=new $e.TimeoutController(this._init.hop.timeout);try{Se.setMaxListeners?.(1/0,s.signal)}catch{}try{const i=jr(n,s.signal),o=new xd({stream:{...n,...i}}),a=await o.read();if(a==null){nr("request was invalid, could not read from stream"),o.write({type:te.Type.STATUS,code:te.Status.MALFORMED_MESSAGE}),o.close();return}let c;switch(a.type){case te.Type.CAN_HOP:{nr("received CAN_HOP request from %p",t.remotePeer),await NX({circuit:this,connection:t,streamHandler:o});break}case te.Type.HOP:{nr("received HOP request from %p",t.remotePeer),await PX({connection:t,request:a,streamHandler:o,circuit:this,connectionManager:this.components.connectionManager});break}case te.Type.STOP:{nr("received STOP request from %p",t.remotePeer),c=await TX({connection:t,request:a,streamHandler:o});break}default:{nr("Request of type %s not supported",a.type),o.write({type:te.Type.STATUS,code:te.Status.MALFORMED_MESSAGE}),o.close();return}}if(c!=null){const u=t.remoteAddr.encapsulate("/p2p-circuit").encapsulate(X(a.dstPeer?.addrs[0])),l=X(a.srcPeer?.addrs[0]),d=z5({stream:c,remoteAddr:u,localAddr:l}),f=a.type===te.Type.HOP?"relay":"inbound";nr("new %s connection %s",f,d.remoteAddr);const g=await this.components.upgrader.upgradeInbound(d);nr("%s connection %s upgraded",f,d.remoteAddr),this.handler!=null&&this.handler(g)}}finally{s.clear()}}async dial(e,t={}){const n=e.toString().split("/p2p-circuit"),s=X(n[0]),i=X(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const g="Circuit relay dial failed as addresses did not have peer id";throw nr.error(g),E(new Error(g),D.ERR_RELAYED_DIAL)}const c=re(o),u=re(a);let l=!1,f=this.components.connectionManager.getConnections(c)[0];f==null&&(await this.components.peerStore.addressBook.add(c,[s]),f=await this.components.connectionManager.openConnection(c,t),l=!0);try{const g=await kX({...t,connection:f,request:{type:te.Type.HOP,srcPeer:{id:this.components.peerId.toBytes(),addrs:this.components.addressManager.getAddresses().map(w=>w.bytes)},dstPeer:{id:u.toBytes(),addrs:[X(i).bytes]}}}),h=s.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),p=z5({stream:g,remoteAddr:e,localAddr:h});return nr("new outbound connection %s",p.remoteAddr),await this.components.upgrader.upgradeOutbound(p)}catch(g){throw nr.error("Circuit relay dial failed",g),l&&await f.close(),g}}createListener(e){return this.handler=e.handler,CX({connectionManager:this.components.connectionManager,peerStore:this.components.peerStore})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>SE.matches(t))}}var $X=Tb,V5=128,LX=127,MX=~LX,UX=Math.pow(2,31);function Tb(r,e,t){e=e||[],t=t||0;for(var n=t;r>=UX;)e[t++]=r&255|V5,r/=128;for(;r&MX;)e[t++]=r&255|V5,r>>>=7;return e[t]=r|0,Tb.bytes=t-n+1,e}var BX=X1,zX=128,j5=127;function X1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw X1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&j5)<<s:(o&j5)*Math.pow(2,s),s+=7}while(o>=zX);return X1.bytes=i-n,t}var FX=Math.pow(2,7),VX=Math.pow(2,14),jX=Math.pow(2,21),KX=Math.pow(2,28),qX=Math.pow(2,35),HX=Math.pow(2,42),GX=Math.pow(2,49),WX=Math.pow(2,56),YX=Math.pow(2,63),QX=function(r){return r<FX?1:r<VX?2:r<jX?3:r<KX?4:r<qX?5:r<HX?6:r<GX?7:r<WX?8:r<YX?9:10},JX={encode:$X,decode:BX,encodingLength:QX},Uu=JX;const Z1=(r,e=0)=>[Uu.decode(r,e),Uu.decode.bytes],Bu=(r,e,t=0)=>(Uu.encode(r,e,t),e),zu=r=>Uu.encodingLength(r),XX=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},G2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},e0=(r,e)=>{const t=e.byteLength,n=zu(r),s=n+zu(t),i=new Uint8Array(s+t);return Bu(r,i,0),Bu(t,i,n),i.set(e,s),new W2(r,t,e,i)},ZX=r=>{const e=G2(r),[t,n]=Z1(e),[s,i]=Z1(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new W2(t,s,o,e)},eZ=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&XX(r.bytes,t.bytes)}};let W2=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function tZ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var rZ=tZ,nZ=rZ;let sZ=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},iZ=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Db(this,e)}},oZ=class{constructor(e){this.decoders=e}or(e){return Db(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Db=(r,e)=>new oZ({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let aZ=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new sZ(e,t,n),this.decoder=new iZ(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Pb=({name:r,prefix:e,encode:t,decode:n})=>new aZ(r,e,t,n),kb=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=nZ(t,e);return Pb({prefix:r,name:e,encode:n,decode:i=>G2(s(i))})},cZ=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},lZ=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Bn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Pb({prefix:e,name:r,encode(s){return lZ(s,n,t)},decode(s){return cZ(s,n,t,r)}}),us=kb({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});kb({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const dl=Bn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Bn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Bn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Bn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Bn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Bn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Bn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Bn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Bn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const uZ=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return hZ(t,t0(r),e||us.encoder);default:return fZ(t,t0(r),e||dl.encoder)}},K5=new WeakMap,t0=r=>{const e=K5.get(r);if(e==null){const t=new Map;return K5.set(r,t),t}return e};let At=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==qo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==pZ)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return At.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=e0(e,t);return At.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return At.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&eZ(e.multihash,n.multihash)}toString(e){return uZ(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof At)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new At(n,s,i,o||q5(n,s,i.bytes))}else if(t[gZ]===!0){const{version:n,multihash:s,code:i}=t,o=ZX(s);return At.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==qo)throw new Error(`Version 0 CID must use dag-pb (code: ${qo}) block encoding`);return new At(e,t,n,n.bytes)}case 1:{const s=q5(e,t,n.bytes);return new At(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return At.create(0,qo,e)}static createV1(e,t){return At.create(1,e,t)}static decode(e){const[t,n]=At.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=At.inspectBytes(e),n=t.size-t.multihashSize,s=G2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new W2(t.multihashCode,t.digestSize,i,s);return[t.version===0?At.createV0(o):At.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Z1(e.subarray(t));return t+=f,d};let s=n(),i=qo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=dZ(e,t),i=At.decode(s);return t0(i).set(n,e),i}};const dZ=(r,e)=>{switch(r[0]){case"Q":{const t=e||us;return[us.prefix,t.decode(`${us.prefix}${r}`)]}case us.prefix:{const t=e||us;return[us.prefix,t.decode(r)]}case dl.prefix:{const t=e||dl;return[dl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},hZ=(r,e,t)=>{const{prefix:n}=t;if(n!==us.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},fZ=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},qo=112,pZ=18,q5=(r,e,t)=>{const n=zu(r),s=n+zu(e),i=new Uint8Array(s+t.byteLength);return Bu(r,i,0),Bu(e,i,n),i.set(t,s),i},gZ=Symbol.for("@ipld/js-cid/CID"),Ob=({name:r,code:e,encode:t})=>new yZ(r,e,t);let yZ=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?e0(this.code,t):t.then(n=>e0(this.code,n))}else throw Error("Unknown type, must be binary type")}};const Nb=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),wZ=Ob({name:"sha2-256",code:18,encode:Nb("SHA-256")});Ob({name:"sha2-512",code:19,encode:Nb("SHA-512")});async function xb(r){const e=new TextEncoder().encode(r),t=await wZ.digest(e);return At.createV0(t)}const $b=60*1e3,mZ=15*$b,bZ=30*$b,EZ=290,H5="hop_relay",G5="true",Lb="/libp2p/relay";var hl={},Mb;(function(){var r,e,t,n,s,i,o,a;a=function(c){var u,l,d,f;return u=(c&255<<24)>>>24,l=(c&255<<16)>>>16,d=(c&255<<8)>>>8,f=c&255,[u,l,d,f].join(".")},o=function(c){var u,l,d,f,g,h;for(u=[],d=f=0;f<=3&&c.length!==0;d=++f){if(d>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}h=e(c),g=h[0],l=h[1],c=c.substring(l),u.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var u,l,d,f,g;for(f=0,u=10,l="9",d=0,c.length>1&&c[d]==="0"&&(c[d+1]==="x"||c[d+1]==="X"?(d+=2,u=16):"0"<=c[d+1]&&c[d+1]<="9"&&(d++,u=8,l="7")),g=d;d<c.length;){if("0"<=c[d]&&c[d]<=l)f=f*u+(t(c[d])-n)>>>0;else if(u===16)if("a"<=c[d]&&c[d]<="f")f=f*u+(10+t(c[d])-i)>>>0;else if("A"<=c[d]&&c[d]<="F")f=f*u+(10+t(c[d])-s)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");d++}if(d===g)throw new Error("empty octet");return[f,d]},r=function(){function c(u,l){var d,f,g;if(typeof u!="string")throw new Error("Missing `net' parameter");if(l||(g=u.split("/",2),u=g[0],l=g[1]),l||(l=32),typeof l=="string"&&l.indexOf(".")>-1){try{this.maskLong=o(l)}catch{throw new Error("Invalid mask: "+l)}for(d=f=32;f>=0;d=--f)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(l||l===0)this.bitmask=parseInt(l,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(u)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+l);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new c(u)),u instanceof c?this.contains(u.base)&&this.contains(u.broadcast||u.last):(o(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(u){return u==null&&(u=1),new c(a(this.netLong+this.size*u),this.mask)},c.prototype.forEach=function(u){var l,d,f;for(f=o(this.first),d=o(this.last),l=0;f<=d;)u(a(f),f,l),l++,f++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),hl.ip2long=o,hl.long2ip=a,Mb=hl.Netmask=r}).call(or);const W5="[a-fA-F\\d:]",bs=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${W5})|(?<=${W5})(?=\\s|$))`:"",vr="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",He="[a-fA-F\\d]{1,4}",$d=`
(?:
(?:${He}:){7}(?:${He}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${He}:){6}(?:${vr}|:${He}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${He}:){5}(?::${vr}|(?::${He}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${He}:){4}(?:(?::${He}){0,1}:${vr}|(?::${He}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${He}:){3}(?:(?::${He}){0,2}:${vr}|(?::${He}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${He}:){2}(?:(?::${He}){0,3}:${vr}|(?::${He}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${He}:){1}(?:(?::${He}){0,4}:${vr}|(?::${He}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${He}){0,5}:${vr}|(?::${He}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),_Z=new RegExp(`(?:^${vr}$)|(?:^${$d}$)`),vZ=new RegExp(`^${vr}$`),SZ=new RegExp(`^${$d}$`),Y2=r=>r&&r.exact?_Z:new RegExp(`(?:${bs(r)}${vr}${bs(r)})|(?:${bs(r)}${$d}${bs(r)})`,"g");Y2.v4=r=>r&&r.exact?vZ:new RegExp(`${bs(r)}${vr}${bs(r)}`,"g");Y2.v6=r=>r&&r.exact?SZ:new RegExp(`${bs(r)}${$d}${bs(r)}`,"g");var Fu={},RZ={get exports(){return Fu},set exports(r){Fu=r}};(function(r){(function(e){const t="(0?\\d+|0x[a-f0-9]+)",n={fourOctet:new RegExp(`^${t}\\.${t}\\.${t}\\.${t}$`,"i"),threeOctet:new RegExp(`^${t}\\.${t}\\.${t}$`,"i"),twoOctet:new RegExp(`^${t}\\.${t}$`,"i"),longValue:new RegExp(`^${t}$`,"i")},s=new RegExp("^0[0-7]+$","i"),i=new RegExp("^0x[a-f0-9]+$","i"),o="%[0-9a-z]{1,}",a="(?:[0-9a-f]+::?)+",c={zoneIndex:new RegExp(o,"i"),native:new RegExp(`^(::)?(${a})?([0-9a-f]+)?(::)?(${o})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${t}\\.${t}\\.${t}\\.${t}(${o})?)$`,"i"),transitional:new RegExp(`^((?:${a})|(?:::)(?:${a})?)${t}\\.${t}\\.${t}\\.${t}(${o})?$`,"i")};function u(h,p){if(h.indexOf("::")!==h.lastIndexOf("::"))return null;let w=0,y=-1,_=(h.match(c.zoneIndex)||[])[0],b,m;for(_&&(_=_.substring(1),h=h.replace(/%.+$/,""));(y=h.indexOf(":",y+1))>=0;)w++;if(h.substr(0,2)==="::"&&w--,h.substr(-2,2)==="::"&&w--,w>p)return null;for(m=p-w,b=":";m--;)b+="0:";return h=h.replace("::",b),h[0]===":"&&(h=h.slice(1)),h[h.length-1]===":"&&(h=h.slice(0,-1)),p=function(){const S=h.split(":"),R=[];for(let v=0;v<S.length;v++)R.push(parseInt(S[v],16));return R}(),{parts:p,zoneId:_}}function l(h,p,w,y){if(h.length!==p.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let _=0,b;for(;y>0;){if(b=w-y,b<0&&(b=0),h[_]>>b!==p[_]>>b)return!1;y-=w,_+=1}return!0}function d(h){if(i.test(h))return parseInt(h,16);if(h[0]==="0"&&!isNaN(parseInt(h[1],10))){if(s.test(h))return parseInt(h,8);throw new Error(`ipaddr: cannot parse ${h} as octal`)}return parseInt(h,10)}function f(h,p){for(;h.length<p;)h=`0${h}`;return h}const g={};g.IPv4=function(){function h(p){if(p.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let w,y;for(w=0;w<p.length;w++)if(y=p[w],!(0<=y&&y<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=p}return h.prototype.SpecialRanges={unspecified:[[new h([0,0,0,0]),8]],broadcast:[[new h([255,255,255,255]),32]],multicast:[[new h([224,0,0,0]),4]],linkLocal:[[new h([169,254,0,0]),16]],loopback:[[new h([127,0,0,0]),8]],carrierGradeNat:[[new h([100,64,0,0]),10]],private:[[new h([10,0,0,0]),8],[new h([172,16,0,0]),12],[new h([192,168,0,0]),16]],reserved:[[new h([192,0,0,0]),24],[new h([192,0,2,0]),24],[new h([192,88,99,0]),24],[new h([198,51,100,0]),24],[new h([203,0,113,0]),24],[new h([240,0,0,0]),4]]},h.prototype.kind=function(){return"ipv4"},h.prototype.match=function(p,w){let y;if(w===void 0&&(y=p,p=y[0],w=y[1]),p.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return l(this.octets,p.octets,8,w)},h.prototype.prefixLengthFromSubnetMask=function(){let p=0,w=!1;const y={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0};let _,b,m;for(_=3;_>=0;_-=1)if(b=this.octets[_],b in y){if(m=y[b],w&&m!==0)return null;m!==8&&(w=!0),p+=m}else return null;return 32-p},h.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},h.prototype.toByteArray=function(){return this.octets.slice(0)},h.prototype.toIPv4MappedAddress=function(){return g.IPv6.parse(`::ffff:${this.toString()}`)},h.prototype.toNormalizedString=function(){return this.toString()},h.prototype.toString=function(){return this.octets.join(".")},h}(),g.IPv4.broadcastAddressFromCIDR=function(h){try{const p=this.parseCIDR(h),w=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[];let b=0;for(;b<4;)_.push(parseInt(w[b],10)|parseInt(y[b],10)^255),b++;return new this(_)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.isIPv4=function(h){return this.parser(h)!==null},g.IPv4.isValid=function(h){try{return new this(this.parser(h)),!0}catch{return!1}},g.IPv4.isValidFourPartDecimal=function(h){return!!(g.IPv4.isValid(h)&&h.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},g.IPv4.networkAddressFromCIDR=function(h){let p,w,y,_,b;try{for(p=this.parseCIDR(h),y=p[0].toByteArray(),b=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[],w=0;w<4;)_.push(parseInt(y[w],10)&parseInt(b[w],10)),w++;return new this(_)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.parse=function(h){const p=this.parser(h);if(p===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(p)},g.IPv4.parseCIDR=function(h){let p;if(p=h.match(/^(.+)\/(\d+)$/)){const w=parseInt(p[2]);if(w>=0&&w<=32){const y=[this.parse(p[1]),w];return Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},g.IPv4.parser=function(h){let p,w,y;if(p=h.match(n.fourOctet))return function(){const _=p.slice(1,6),b=[];for(let m=0;m<_.length;m++)w=_[m],b.push(d(w));return b}();if(p=h.match(n.longValue)){if(y=d(p[1]),y>4294967295||y<0)throw new Error("ipaddr: address outside defined range");return function(){const _=[];let b;for(b=0;b<=24;b+=8)_.push(y>>b&255);return _}().reverse()}else return(p=h.match(n.twoOctet))?function(){const _=p.slice(1,4),b=[];if(y=d(_[1]),y>16777215||y<0)throw new Error("ipaddr: address outside defined range");return b.push(d(_[0])),b.push(y>>16&255),b.push(y>>8&255),b.push(y&255),b}():(p=h.match(n.threeOctet))?function(){const _=p.slice(1,5),b=[];if(y=d(_[2]),y>65535||y<0)throw new Error("ipaddr: address outside defined range");return b.push(d(_[0])),b.push(d(_[1])),b.push(y>>8&255),b.push(y&255),b}():null},g.IPv4.subnetMaskFromPrefixLength=function(h){if(h=parseInt(h),h<0||h>32)throw new Error("ipaddr: invalid IPv4 prefix length");const p=[0,0,0,0];let w=0;const y=Math.floor(h/8);for(;w<y;)p[w]=255,w++;return y<4&&(p[y]=Math.pow(2,h%8)-1<<8-h%8),new this(p)},g.IPv6=function(){function h(p,w){let y,_;if(p.length===16)for(this.parts=[],y=0;y<=14;y+=2)this.parts.push(p[y]<<8|p[y+1]);else if(p.length===8)this.parts=p;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(y=0;y<this.parts.length;y++)if(_=this.parts[y],!(0<=_&&_<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");w&&(this.zoneId=w)}return h.prototype.SpecialRanges={unspecified:[new h([0,0,0,0,0,0,0,0]),128],linkLocal:[new h([65152,0,0,0,0,0,0,0]),10],multicast:[new h([65280,0,0,0,0,0,0,0]),8],loopback:[new h([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new h([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new h([0,0,0,0,0,65535,0,0]),96],rfc6145:[new h([0,0,0,0,65535,0,0,0]),96],rfc6052:[new h([100,65435,0,0,0,0,0,0]),96],"6to4":[new h([8194,0,0,0,0,0,0,0]),16],teredo:[new h([8193,0,0,0,0,0,0,0]),32],reserved:[[new h([8193,3512,0,0,0,0,0,0]),32]]},h.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},h.prototype.kind=function(){return"ipv6"},h.prototype.match=function(p,w){let y;if(w===void 0&&(y=p,p=y[0],w=y[1]),p.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return l(this.parts,p.parts,16,w)},h.prototype.prefixLengthFromSubnetMask=function(){let p=0,w=!1;const y={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0};let _,b;for(let m=7;m>=0;m-=1)if(_=this.parts[m],_ in y){if(b=y[_],w&&b!==0)return null;b!==16&&(w=!0),p+=b}else return null;return 128-p},h.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},h.prototype.toByteArray=function(){let p;const w=[],y=this.parts;for(let _=0;_<y.length;_++)p=y[_],w.push(p>>8),w.push(p&255);return w},h.prototype.toFixedLengthString=function(){const p=function(){const y=[];for(let _=0;_<this.parts.length;_++)y.push(f(this.parts[_].toString(16),4));return y}.call(this).join(":");let w="";return this.zoneId&&(w=`%${this.zoneId}`),p+w},h.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");const p=this.parts.slice(-2),w=p[0],y=p[1];return new g.IPv4([w>>8,w&255,y>>8,y&255])},h.prototype.toNormalizedString=function(){const p=function(){const y=[];for(let _=0;_<this.parts.length;_++)y.push(this.parts[_].toString(16));return y}.call(this).join(":");let w="";return this.zoneId&&(w=`%${this.zoneId}`),p+w},h.prototype.toRFC5952String=function(){const p=/((^|:)(0(:|$)){2,})/g,w=this.toNormalizedString();let y=0,_=-1,b;for(;b=p.exec(w);)b[0].length>_&&(y=b.index,_=b[0].length);return _<0?w:`${w.substring(0,y)}::${w.substring(y+_)}`},h.prototype.toString=function(){return this.toNormalizedString().replace(/((^|:)(0(:|$))+)/,"::")},h}(),g.IPv6.broadcastAddressFromCIDR=function(h){try{const p=this.parseCIDR(h),w=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[];let b=0;for(;b<16;)_.push(parseInt(w[b],10)|parseInt(y[b],10)^255),b++;return new this(_)}catch(p){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${p})`)}},g.IPv6.isIPv6=function(h){return this.parser(h)!==null},g.IPv6.isValid=function(h){if(typeof h=="string"&&h.indexOf(":")===-1)return!1;try{const p=this.parser(h);return new this(p.parts,p.zoneId),!0}catch{return!1}},g.IPv6.networkAddressFromCIDR=function(h){let p,w,y,_,b;try{for(p=this.parseCIDR(h),y=p[0].toByteArray(),b=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),_=[],w=0;w<16;)_.push(parseInt(y[w],10)&parseInt(b[w],10)),w++;return new this(_)}catch(m){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${m})`)}},g.IPv6.parse=function(h){const p=this.parser(h);if(p.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(p.parts,p.zoneId)},g.IPv6.parseCIDR=function(h){let p,w,y;if((w=h.match(/^(.+)\/(\d+)$/))&&(p=parseInt(w[2]),p>=0&&p<=128))return y=[this.parse(w[1]),p],Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},g.IPv6.parser=function(h){let p,w,y,_,b,m;if(y=h.match(c.deprecatedTransitional))return this.parser(`::ffff:${y[1]}`);if(c.native.test(h))return u(h,8);if((y=h.match(c.transitional))&&(m=y[6]||"",p=u(y[1].slice(0,-1)+m,6),p.parts)){for(b=[parseInt(y[2]),parseInt(y[3]),parseInt(y[4]),parseInt(y[5])],w=0;w<b.length;w++)if(_=b[w],!(0<=_&&_<=255))return null;return p.parts.push(b[0]<<8|b[1]),p.parts.push(b[2]<<8|b[3]),{parts:p.parts,zoneId:p.zoneId}}return null},g.IPv6.subnetMaskFromPrefixLength=function(h){if(h=parseInt(h),h<0||h>128)throw new Error("ipaddr: invalid IPv6 prefix length");const p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let w=0;const y=Math.floor(h/8);for(;w<y;)p[w]=255,w++;return y<16&&(p[y]=Math.pow(2,h%8)-1<<8-h%8),new this(p)},g.fromByteArray=function(h){const p=h.length;if(p===4)return new g.IPv4(h);if(p===16)return new g.IPv6(h);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},g.isValid=function(h){return g.IPv6.isValid(h)||g.IPv4.isValid(h)},g.parse=function(h){if(g.IPv6.isValid(h))return g.IPv6.parse(h);if(g.IPv4.isValid(h))return g.IPv4.parse(h);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},g.parseCIDR=function(h){try{return g.IPv6.parseCIDR(h)}catch{try{return g.IPv4.parseCIDR(h)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},g.process=function(h){const p=this.parse(h);return p.kind()==="ipv6"&&p.isIPv4MappedAddress()?p.toIPv4Address():p},g.subnetMatch=function(h,p,w){let y,_,b,m;w==null&&(w="unicast");for(_ in p)if(Object.prototype.hasOwnProperty.call(p,_)){for(b=p[_],b[0]&&!(b[0]instanceof Array)&&(b=[b]),y=0;y<b.length;y++)if(m=b[y],h.kind()===m[0].kind()&&h.match.apply(h,m))return _}return w},r.exports?r.exports=g:e.ipaddr=g})(or)})(RZ);const IZ=Fu,{isValid:AZ,parse:CZ}=IZ,TZ=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],DZ=TZ.map(r=>new Mb(r));function PZ(r){for(let e of DZ)if(e.contains(r))return!0;return!1}function Y5(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}const kZ=r=>{if(AZ(r)){const e=CZ(r);if(e.kind()==="ipv4")return PZ(e.toNormalizedString());if(e.kind()==="ipv6")return Y5(r)}else if(aE(r)&&Y2.v6().test(r))return Y5(r)};function Q5(r){const{address:e}=r.nodeAddress();return Boolean(kZ(e))}function Q2(r,e){const t=Q5(r.multiaddr),n=Q5(e.multiaddr);return t&&!n?1:!t&&n||r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}const Ho=O("libp2p:auto-relay"),OZ=()=>{};class NZ{constructor(e,t){this.components=e,this.addressSorter=t.addressSorter??Q2,this.maxListeners=t.maxListeners??1,this.listenRelays=new Set,this.onError=t.onError??OZ,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this),this.components.peerStore.addEventListener("change:protocols",n=>{this._onProtocolChange(n).catch(s=>{Ho.error(s)})}),this.components.connectionManager.addEventListener("peer:disconnect",this._onPeerDisconnected)}async _onProtocolChange(e){const{peerId:t,protocols:n}=e.detail,s=t.toString();if(n.find(o=>o===to)==null){this.listenRelays.has(s)&&await this._removeListenRelay(s);return}if(!this.listenRelays.has(s))try{const o=this.components.connectionManager.getConnections(t);if(o.length===0)return;const a=o[0];if(a.remoteAddr.protoCodes().includes(EZ)){Ho(`relayed connection to ${s} will not be used to hop on`);return}await OX({connection:a})&&(await this.components.peerStore.metadataBook.setValue(t,H5,M(G5)),await this._addListenRelay(a,s))}catch(o){this.onError(o)}}_onPeerDisconnected(e){const s=e.detail.remotePeer.toString();this.listenRelays.has(s)&&this._removeListenRelay(s).catch(i=>{Ho.error(i)})}async _addListenRelay(e,t){try{if(this.listenRelays.size>=this.maxListeners)return;const n=await ne(await this.components.peerStore.addressBook.get(e.remotePeer),i=>Va(i,this.addressSorter),async i=>await Dn(i));(await Promise.all(n.map(async i=>{try{let o=i.multiaddr;return o.getPeerId()==null&&(o=o.encapsulate(`/p2p/${e.remotePeer.toString()}`)),o=o.encapsulate("/p2p-circuit"),await this.components.transportManager.listen([o]),!0}catch(o){Ho.error("error listening on circuit address",o),this.onError(o)}return!1}))).includes(!0)&&this.listenRelays.add(t)}catch(n){this.onError(n),this.listenRelays.delete(t)}}async _removeListenRelay(e){this.listenRelays.delete(e)&&await this._listenOnAvailableHopRelays([e])}async _listenOnAvailableHopRelays(e=[]){if(this.listenRelays.size>=this.maxListeners)return;const t=[],n=await this.components.peerStore.all();for(const{id:s,metadata:i}of n){const o=s.toString();if(this.listenRelays.has(o)||e.includes(o))continue;const a=i.get(H5);if(a==null||q(a)!==G5)continue;const c=this.components.connectionManager.getConnections(s);if(c.length===0){t.push(s);continue}if(await this._addListenRelay(c[0],o),this.listenRelays.size>=this.maxListeners)return}for(const s of t)if(await this._tryToListenOnRelay(s),this.listenRelays.size>=this.maxListeners)return;try{const s=await xb(Lb);for await(const i of this.components.contentRouting.findProviders(s)){if(i.multiaddrs.length===0)continue;const o=i.id;if(!o.equals(this.components.peerId)&&(await this.components.peerStore.addressBook.add(o,i.multiaddrs),await this._tryToListenOnRelay(o),this.listenRelays.size>=this.maxListeners))return}}catch(s){this.onError(s)}}async _tryToListenOnRelay(e){try{const t=await this.components.connectionManager.openConnection(e);await this._addListenRelay(t,e.toString())}catch(t){Ho.error("Could not use %p as relay",e,t),this.onError(t,`could not connect and listen on known hop relay ${e.toString()}`)}}}const J5=O("libp2p:relay");class xZ{constructor(e,t){this.components=e,this.autoRelay=t.autoRelay?.enabled!==!1?new NZ(e,{addressSorter:t.addressSorter,...t.autoRelay}):void 0,this.started=!1,this.init=t,this._advertiseService=this._advertiseService.bind(this)}isStarted(){return this.started}async start(){this.init.hop.enabled!==!1&&this.init.advertise.enabled!==!1&&(this.timeout=Lu.setDelayedInterval(this._advertiseService,this.init.advertise.ttl,this.init.advertise.bootDelay)),this.started=!0}async stop(){this.timeout!=null&&Lu.clearDelayedInterval(this.timeout),this.started=!1}async _advertiseService(){try{const e=await xb(Lb);await this.components.contentRouting.provide(e)}catch(e){e.code===D.ERR_NO_ROUTERS_AVAILABLE?(J5.error("a content router, such as a DHT, must be provided in order to advertise the relay service",e),await this.stop()):J5.error(e)}}}function $Z(r){return r>=55296&&r<=56319}function LZ(r){return r>=56320&&r<=57343}var MZ=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var s=t.length,i=0,o,a,c=0;c<s;c+=1){if(o=t.charCodeAt(c),a=t[c],$Z(o)&&LZ(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t};function UZ(r){return r>=55296&&r<=56319}function BZ(r){return r>=56320&&r<=57343}var zZ=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,s=null,i=null,o=0;o<t;o++)s=e.charCodeAt(o),BZ(s)?i!=null&&UZ(i)?n+=1:n+=3:s<=127?n+=1:s>=128&&s<=2047?n+=2:s>=2048&&s<=65535&&(n+=3),i=s;return n},FZ=MZ,VZ=zZ,jZ=FZ.bind(null,VZ),KZ=jZ,qZ=/[\/\?<>\\:\*\|"]/g,HZ=/[\x00-\x1f\x80-\x9f]/g,GZ=/^\.+$/,WZ=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,YZ=/[\. ]+$/;function X5(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(qZ,e).replace(HZ,e).replace(GZ,e).replace(WZ,e).replace(YZ,e);return KZ(t,255)}var QZ=function(r,e){var t=e&&e.replacement||"",n=X5(r,t);return t===""?n:X5(n,"")},ro=Ot,B=ro.asn1,mo=ro.pkcs7asn1=ro.pkcs7asn1||{};ro.pkcs7=ro.pkcs7||{};ro.pkcs7.asn1=mo;var Ub={name:"ContentInfo",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"ContentInfo.ContentType",tagClass:B.Class.UNIVERSAL,type:B.Type.OID,constructed:!1,capture:"contentType"},{name:"ContentInfo.content",tagClass:B.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,captureAsn1:"content"}]};mo.contentInfoValidator=Ub;var Bb={name:"EncryptedContentInfo",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentType",tagClass:B.Class.UNIVERSAL,type:B.Type.OID,constructed:!1,capture:"contentType"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentEncryptionAlgorithm.algorithm",tagClass:B.Class.UNIVERSAL,type:B.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm.parameter",tagClass:B.Class.UNIVERSAL,captureAsn1:"encParameter"}]},{name:"EncryptedContentInfo.encryptedContent",tagClass:B.Class.CONTEXT_SPECIFIC,type:0,capture:"encryptedContent",captureAsn1:"encryptedContentAsn1"}]};mo.envelopedDataValidator={name:"EnvelopedData",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"EnvelopedData.Version",tagClass:B.Class.UNIVERSAL,type:B.Type.INTEGER,constructed:!1,capture:"version"},{name:"EnvelopedData.RecipientInfos",tagClass:B.Class.UNIVERSAL,type:B.Type.SET,constructed:!0,captureAsn1:"recipientInfos"}].concat(Bb)};mo.encryptedDataValidator={name:"EncryptedData",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedData.Version",tagClass:B.Class.UNIVERSAL,type:B.Type.INTEGER,constructed:!1,capture:"version"}].concat(Bb)};var JZ={name:"SignerInfo",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.version",tagClass:B.Class.UNIVERSAL,type:B.Type.INTEGER,constructed:!1},{name:"SignerInfo.issuerAndSerialNumber",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.issuerAndSerialNumber.issuer",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,captureAsn1:"issuer"},{name:"SignerInfo.issuerAndSerialNumber.serialNumber",tagClass:B.Class.UNIVERSAL,type:B.Type.INTEGER,constructed:!1,capture:"serial"}]},{name:"SignerInfo.digestAlgorithm",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.digestAlgorithm.algorithm",tagClass:B.Class.UNIVERSAL,type:B.Type.OID,constructed:!1,capture:"digestAlgorithm"},{name:"SignerInfo.digestAlgorithm.parameter",tagClass:B.Class.UNIVERSAL,constructed:!1,captureAsn1:"digestParameter",optional:!0}]},{name:"SignerInfo.authenticatedAttributes",tagClass:B.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"authenticatedAttributes"},{name:"SignerInfo.digestEncryptionAlgorithm",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,capture:"signatureAlgorithm"},{name:"SignerInfo.encryptedDigest",tagClass:B.Class.UNIVERSAL,type:B.Type.OCTETSTRING,constructed:!1,capture:"signature"},{name:"SignerInfo.unauthenticatedAttributes",tagClass:B.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0,capture:"unauthenticatedAttributes"}]};mo.signedDataValidator={name:"SignedData",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"SignedData.Version",tagClass:B.Class.UNIVERSAL,type:B.Type.INTEGER,constructed:!1,capture:"version"},{name:"SignedData.DigestAlgorithms",tagClass:B.Class.UNIVERSAL,type:B.Type.SET,constructed:!0,captureAsn1:"digestAlgorithms"},Ub,{name:"SignedData.Certificates",tagClass:B.Class.CONTEXT_SPECIFIC,type:0,optional:!0,captureAsn1:"certificates"},{name:"SignedData.CertificateRevocationLists",tagClass:B.Class.CONTEXT_SPECIFIC,type:1,optional:!0,captureAsn1:"crls"},{name:"SignedData.SignerInfos",tagClass:B.Class.UNIVERSAL,type:B.Type.SET,capture:"signerInfos",optional:!0,value:[JZ]}]};mo.recipientInfoValidator={name:"RecipientInfo",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.version",tagClass:B.Class.UNIVERSAL,type:B.Type.INTEGER,constructed:!1,capture:"version"},{name:"RecipientInfo.issuerAndSerial",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.issuerAndSerial.issuer",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,captureAsn1:"issuer"},{name:"RecipientInfo.issuerAndSerial.serialNumber",tagClass:B.Class.UNIVERSAL,type:B.Type.INTEGER,constructed:!1,capture:"serial"}]},{name:"RecipientInfo.keyEncryptionAlgorithm",tagClass:B.Class.UNIVERSAL,type:B.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.keyEncryptionAlgorithm.algorithm",tagClass:B.Class.UNIVERSAL,type:B.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"RecipientInfo.keyEncryptionAlgorithm.parameter",tagClass:B.Class.UNIVERSAL,constructed:!1,captureAsn1:"encParameter",optional:!0}]},{name:"RecipientInfo.encryptedKey",tagClass:B.Class.UNIVERSAL,type:B.Type.OCTETSTRING,constructed:!1,capture:"encKey"}]};var Qs=Ot;Qs.mgf=Qs.mgf||{};var XZ=Qs.mgf.mgf1=Qs.mgf1=Qs.mgf1||{};XZ.create=function(r){var e={generate:function(t,n){for(var s=new Qs.util.ByteBuffer,i=Math.ceil(n/r.digestLength),o=0;o<i;o++){var a=new Qs.util.ByteBuffer;a.putInt32(o),r.start(),r.update(t+a.getBytes()),s.putBuffer(r.digest())}return s.truncate(s.length()-n),s.getBytes()}};return e};var Vu=Ot;Vu.mgf=Vu.mgf||{};Vu.mgf.mgf1=Vu.mgf1;var Vs=Ot,ZZ=Vs.pss=Vs.pss||{};ZZ.create=function(r){arguments.length===3&&(r={md:arguments[0],mgf:arguments[1],saltLength:arguments[2]});var e=r.md,t=r.mgf,n=e.digestLength,s=r.salt||null;typeof s=="string"&&(s=Vs.util.createBuffer(s));var i;if("saltLength"in r)i=r.saltLength;else if(s!==null)i=s.length();else throw new Error("Salt length not specified or specific salt not given.");if(s!==null&&s.length()!==i)throw new Error("Given salt length does not match length of given salt.");var o=r.prng||Vs.random,a={};return a.encode=function(c,u){var l,d=u-1,f=Math.ceil(d/8),g=c.digest().getBytes();if(f<n+i+2)throw new Error("Message is too long to encrypt.");var h;s===null?h=o.getBytesSync(i):h=s.bytes();var p=new Vs.util.ByteBuffer;p.fillWithByte(0,8),p.putBytes(g),p.putBytes(h),e.start(),e.update(p.getBytes());var w=e.digest().getBytes(),y=new Vs.util.ByteBuffer;y.fillWithByte(0,f-i-n-2),y.putByte(1),y.putBytes(h);var _=y.getBytes(),b=f-n-1,m=t.generate(w,b),S="";for(l=0;l<b;l++)S+=String.fromCharCode(_.charCodeAt(l)^m.charCodeAt(l));var R=65280>>8*f-d&255;return S=String.fromCharCode(S.charCodeAt(0)&~R)+S.substr(1),S+w+String.fromCharCode(188)},a.verify=function(c,u,l){var d,f=l-1,g=Math.ceil(f/8);if(u=u.substr(-g),g<n+i+2)throw new Error("Inconsistent parameters to PSS signature verification.");if(u.charCodeAt(g-1)!==188)throw new Error("Encoded message does not end in 0xBC.");var h=g-n-1,p=u.substr(0,h),w=u.substr(h,n),y=65280>>8*g-f&255;if(p.charCodeAt(0)&y)throw new Error("Bits beyond keysize not zero as expected.");var _=t.generate(w,h),b="";for(d=0;d<h;d++)b+=String.fromCharCode(p.charCodeAt(d)^_.charCodeAt(d));b=String.fromCharCode(b.charCodeAt(0)&~y)+b.substr(1);var m=g-n-i-2;for(d=0;d<m;d++)if(b.charCodeAt(d)!==0)throw new Error("Leftmost octets not zero as expected");if(b.charCodeAt(m)!==1)throw new Error("Inconsistent PSS signature, 0x01 marker not found");var S=b.substr(-i),R=new Vs.util.ByteBuffer;R.fillWithByte(0,8),R.putBytes(c),R.putBytes(S),e.start(),e.update(R.getBytes());var v=e.digest().getBytes();return w===v},a};var G=Ot,I=G.asn1,L=G.pki=G.pki||{},ae=L.oids,Fe={};Fe.CN=ae.commonName;Fe.commonName="CN";Fe.C=ae.countryName;Fe.countryName="C";Fe.L=ae.localityName;Fe.localityName="L";Fe.ST=ae.stateOrProvinceName;Fe.stateOrProvinceName="ST";Fe.O=ae.organizationName;Fe.organizationName="O";Fe.OU=ae.organizationalUnitName;Fe.organizationalUnitName="OU";Fe.E=ae.emailAddress;Fe.emailAddress="E";var zb=G.pki.rsa.publicKeyValidator,eee={name:"Certificate",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,captureAsn1:"tbsCertificate",value:[{name:"Certificate.TBSCertificate.version",tagClass:I.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.version.integer",tagClass:I.Class.UNIVERSAL,type:I.Type.INTEGER,constructed:!1,capture:"certVersion"}]},{name:"Certificate.TBSCertificate.serialNumber",tagClass:I.Class.UNIVERSAL,type:I.Type.INTEGER,constructed:!1,capture:"certSerialNumber"},{name:"Certificate.TBSCertificate.signature",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.signature.algorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.OID,constructed:!1,capture:"certinfoSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:I.Class.UNIVERSAL,optional:!0,captureAsn1:"certinfoSignatureParams"}]},{name:"Certificate.TBSCertificate.issuer",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,captureAsn1:"certIssuer"},{name:"Certificate.TBSCertificate.validity",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.validity.notBefore (utc)",tagClass:I.Class.UNIVERSAL,type:I.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity1UTCTime"},{name:"Certificate.TBSCertificate.validity.notBefore (generalized)",tagClass:I.Class.UNIVERSAL,type:I.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity2GeneralizedTime"},{name:"Certificate.TBSCertificate.validity.notAfter (utc)",tagClass:I.Class.UNIVERSAL,type:I.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity3UTCTime"},{name:"Certificate.TBSCertificate.validity.notAfter (generalized)",tagClass:I.Class.UNIVERSAL,type:I.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity4GeneralizedTime"}]},{name:"Certificate.TBSCertificate.subject",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,captureAsn1:"certSubject"},zb,{name:"Certificate.TBSCertificate.issuerUniqueID",tagClass:I.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.issuerUniqueID.id",tagClass:I.Class.UNIVERSAL,type:I.Type.BITSTRING,constructed:!1,captureBitStringValue:"certIssuerUniqueId"}]},{name:"Certificate.TBSCertificate.subjectUniqueID",tagClass:I.Class.CONTEXT_SPECIFIC,type:2,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.subjectUniqueID.id",tagClass:I.Class.UNIVERSAL,type:I.Type.BITSTRING,constructed:!1,captureBitStringValue:"certSubjectUniqueId"}]},{name:"Certificate.TBSCertificate.extensions",tagClass:I.Class.CONTEXT_SPECIFIC,type:3,constructed:!0,captureAsn1:"certExtensions",optional:!0}]},{name:"Certificate.signatureAlgorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.signatureAlgorithm.algorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.OID,constructed:!1,capture:"certSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:I.Class.UNIVERSAL,optional:!0,captureAsn1:"certSignatureParams"}]},{name:"Certificate.signatureValue",tagClass:I.Class.UNIVERSAL,type:I.Type.BITSTRING,constructed:!1,captureBitStringValue:"certSignature"}]},tee={name:"rsapss",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.hashAlgorithm",tagClass:I.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier",tagClass:I.Class.UNIVERSAL,type:I.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier.algorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.OID,constructed:!1,capture:"hashOid"}]}]},{name:"rsapss.maskGenAlgorithm",tagClass:I.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier",tagClass:I.Class.UNIVERSAL,type:I.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.algorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.OID,constructed:!1,capture:"maskGenOid"},{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params.algorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.OID,constructed:!1,capture:"maskGenHashOid"}]}]}]},{name:"rsapss.saltLength",tagClass:I.Class.CONTEXT_SPECIFIC,type:2,optional:!0,value:[{name:"rsapss.saltLength.saltLength",tagClass:I.Class.UNIVERSAL,type:I.Class.INTEGER,constructed:!1,capture:"saltLength"}]},{name:"rsapss.trailerField",tagClass:I.Class.CONTEXT_SPECIFIC,type:3,optional:!0,value:[{name:"rsapss.trailer.trailer",tagClass:I.Class.UNIVERSAL,type:I.Class.INTEGER,constructed:!1,capture:"trailer"}]}]},ree={name:"CertificationRequestInfo",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfo",value:[{name:"CertificationRequestInfo.integer",tagClass:I.Class.UNIVERSAL,type:I.Type.INTEGER,constructed:!1,capture:"certificationRequestInfoVersion"},{name:"CertificationRequestInfo.subject",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfoSubject"},zb,{name:"CertificationRequestInfo.attributes",tagClass:I.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"certificationRequestInfoAttributes",value:[{name:"CertificationRequestInfo.attributes",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequestInfo.attributes.type",tagClass:I.Class.UNIVERSAL,type:I.Type.OID,constructed:!1},{name:"CertificationRequestInfo.attributes.value",tagClass:I.Class.UNIVERSAL,type:I.Type.SET,constructed:!0}]}]}]},nee={name:"CertificationRequest",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,captureAsn1:"csr",value:[ree,{name:"CertificationRequest.signatureAlgorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequest.signatureAlgorithm.algorithm",tagClass:I.Class.UNIVERSAL,type:I.Type.OID,constructed:!1,capture:"csrSignatureOid"},{name:"CertificationRequest.signatureAlgorithm.parameters",tagClass:I.Class.UNIVERSAL,optional:!0,captureAsn1:"csrSignatureParams"}]},{name:"CertificationRequest.signature",tagClass:I.Class.UNIVERSAL,type:I.Type.BITSTRING,constructed:!1,captureBitStringValue:"csrSignature"}]};L.RDNAttributesAsArray=function(r,e){for(var t=[],n,s,i,o=0;o<r.value.length;++o){n=r.value[o];for(var a=0;a<n.value.length;++a)i={},s=n.value[a],i.type=I.derToOid(s.value[0].value),i.value=s.value[1].value,i.valueTagClass=s.value[1].type,i.type in ae&&(i.name=ae[i.type],i.name in Fe&&(i.shortName=Fe[i.name])),e&&(e.update(i.type),e.update(i.value)),t.push(i)}return t};L.CRIAttributesAsArray=function(r){for(var e=[],t=0;t<r.length;++t)for(var n=r[t],s=I.derToOid(n.value[0].value),i=n.value[1].value,o=0;o<i.length;++o){var a={};if(a.type=s,a.value=i[o].value,a.valueTagClass=i[o].type,a.type in ae&&(a.name=ae[a.type],a.name in Fe&&(a.shortName=Fe[a.name])),a.type===ae.extensionRequest){a.extensions=[];for(var c=0;c<a.value.length;++c)a.extensions.push(L.certificateExtensionFromAsn1(a.value[c]))}e.push(a)}return e};function xs(r,e){typeof e=="string"&&(e={shortName:e});for(var t=null,n,s=0;t===null&&s<r.attributes.length;++s)n=r.attributes[s],(e.type&&e.type===n.type||e.name&&e.name===n.name||e.shortName&&e.shortName===n.shortName)&&(t=n);return t}var ju=function(r,e,t){var n={};if(r!==ae["RSASSA-PSS"])return n;t&&(n={hash:{algorithmOid:ae.sha1},mgf:{algorithmOid:ae.mgf1,hash:{algorithmOid:ae.sha1}},saltLength:20});var s={},i=[];if(!I.validate(e,tee,s,i)){var o=new Error("Cannot read RSASSA-PSS parameter block.");throw o.errors=i,o}return s.hashOid!==void 0&&(n.hash=n.hash||{},n.hash.algorithmOid=I.derToOid(s.hashOid)),s.maskGenOid!==void 0&&(n.mgf=n.mgf||{},n.mgf.algorithmOid=I.derToOid(s.maskGenOid),n.mgf.hash=n.mgf.hash||{},n.mgf.hash.algorithmOid=I.derToOid(s.maskGenHashOid)),s.saltLength!==void 0&&(n.saltLength=s.saltLength.charCodeAt(0)),n},Ld=function(r){switch(ae[r.signatureOid]){case"sha1WithRSAEncryption":case"sha1WithRSASignature":return G.md.sha1.create();case"md5WithRSAEncryption":return G.md.md5.create();case"sha256WithRSAEncryption":return G.md.sha256.create();case"sha384WithRSAEncryption":return G.md.sha384.create();case"sha512WithRSAEncryption":return G.md.sha512.create();case"RSASSA-PSS":return G.md.sha256.create();default:var e=new Error("Could not compute "+r.type+" digest. Unknown signature OID.");throw e.signatureOid=r.signatureOid,e}},Fb=function(r){var e=r.certificate,t;switch(e.signatureOid){case ae.sha1WithRSAEncryption:case ae.sha1WithRSASignature:break;case ae["RSASSA-PSS"]:var n,s;if(n=ae[e.signatureParameters.mgf.hash.algorithmOid],n===void 0||G.md[n]===void 0){var i=new Error("Unsupported MGF hash function.");throw i.oid=e.signatureParameters.mgf.hash.algorithmOid,i.name=n,i}if(s=ae[e.signatureParameters.mgf.algorithmOid],s===void 0||G.mgf[s]===void 0){var i=new Error("Unsupported MGF function.");throw i.oid=e.signatureParameters.mgf.algorithmOid,i.name=s,i}if(s=G.mgf[s].create(G.md[n].create()),n=ae[e.signatureParameters.hash.algorithmOid],n===void 0||G.md[n]===void 0){var i=new Error("Unsupported RSASSA-PSS hash function.");throw i.oid=e.signatureParameters.hash.algorithmOid,i.name=n,i}t=G.pss.create(G.md[n].create(),s,e.signatureParameters.saltLength);break}return e.publicKey.verify(r.md.digest().getBytes(),r.signature,t)};L.certificateFromPem=function(r,e,t){var n=G.pem.decode(r)[0];if(n.type!=="CERTIFICATE"&&n.type!=="X509 CERTIFICATE"&&n.type!=="TRUSTED CERTIFICATE"){var s=new Error('Could not convert certificate from PEM; PEM header type is not "CERTIFICATE", "X509 CERTIFICATE", or "TRUSTED CERTIFICATE".');throw s.headerType=n.type,s}if(n.procType&&n.procType.type==="ENCRYPTED")throw new Error("Could not convert certificate from PEM; PEM is encrypted.");var i=I.fromDer(n.body,t);return L.certificateFromAsn1(i,e)};L.certificateToPem=function(r,e){var t={type:"CERTIFICATE",body:I.toDer(L.certificateToAsn1(r)).getBytes()};return G.pem.encode(t,{maxline:e})};L.publicKeyFromPem=function(r){var e=G.pem.decode(r)[0];if(e.type!=="PUBLIC KEY"&&e.type!=="RSA PUBLIC KEY"){var t=new Error('Could not convert public key from PEM; PEM header type is not "PUBLIC KEY" or "RSA PUBLIC KEY".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert public key from PEM; PEM is encrypted.");var n=I.fromDer(e.body);return L.publicKeyFromAsn1(n)};L.publicKeyToPem=function(r,e){var t={type:"PUBLIC KEY",body:I.toDer(L.publicKeyToAsn1(r)).getBytes()};return G.pem.encode(t,{maxline:e})};L.publicKeyToRSAPublicKeyPem=function(r,e){var t={type:"RSA PUBLIC KEY",body:I.toDer(L.publicKeyToRSAPublicKey(r)).getBytes()};return G.pem.encode(t,{maxline:e})};L.getPublicKeyFingerprint=function(r,e){e=e||{};var t=e.md||G.md.sha1.create(),n=e.type||"RSAPublicKey",s;switch(n){case"RSAPublicKey":s=I.toDer(L.publicKeyToRSAPublicKey(r)).getBytes();break;case"SubjectPublicKeyInfo":s=I.toDer(L.publicKeyToAsn1(r)).getBytes();break;default:throw new Error('Unknown fingerprint type "'+e.type+'".')}t.start(),t.update(s);var i=t.digest();if(e.encoding==="hex"){var o=i.toHex();return e.delimiter?o.match(/.{2}/g).join(e.delimiter):o}else{if(e.encoding==="binary")return i.getBytes();if(e.encoding)throw new Error('Unknown encoding "'+e.encoding+'".')}return i};L.certificationRequestFromPem=function(r,e,t){var n=G.pem.decode(r)[0];if(n.type!=="CERTIFICATE REQUEST"){var s=new Error('Could not convert certification request from PEM; PEM header type is not "CERTIFICATE REQUEST".');throw s.headerType=n.type,s}if(n.procType&&n.procType.type==="ENCRYPTED")throw new Error("Could not convert certification request from PEM; PEM is encrypted.");var i=I.fromDer(n.body,t);return L.certificationRequestFromAsn1(i,e)};L.certificationRequestToPem=function(r,e){var t={type:"CERTIFICATE REQUEST",body:I.toDer(L.certificationRequestToAsn1(r)).getBytes()};return G.pem.encode(t,{maxline:e})};L.createCertificate=function(){var r={};return r.version=2,r.serialNumber="00",r.signatureOid=null,r.signature=null,r.siginfo={},r.siginfo.algorithmOid=null,r.validity={},r.validity.notBefore=new Date,r.validity.notAfter=new Date,r.issuer={},r.issuer.getField=function(e){return xs(r.issuer,e)},r.issuer.addField=function(e){ur([e]),r.issuer.attributes.push(e)},r.issuer.attributes=[],r.issuer.hash=null,r.subject={},r.subject.getField=function(e){return xs(r.subject,e)},r.subject.addField=function(e){ur([e]),r.subject.attributes.push(e)},r.subject.attributes=[],r.subject.hash=null,r.extensions=[],r.publicKey=null,r.md=null,r.setSubject=function(e,t){ur(e),r.subject.attributes=e,delete r.subject.uniqueId,t&&(r.subject.uniqueId=t),r.subject.hash=null},r.setIssuer=function(e,t){ur(e),r.issuer.attributes=e,delete r.issuer.uniqueId,t&&(r.issuer.uniqueId=t),r.issuer.hash=null},r.setExtensions=function(e){for(var t=0;t<e.length;++t)Vb(e[t],{cert:r});r.extensions=e},r.getExtension=function(e){typeof e=="string"&&(e={name:e});for(var t=null,n,s=0;t===null&&s<r.extensions.length;++s)n=r.extensions[s],(e.id&&n.id===e.id||e.name&&n.name===e.name)&&(t=n);return t},r.sign=function(e,t){r.md=t||G.md.sha1.create();var n=ae[r.md.algorithm+"WithRSAEncryption"];if(!n){var s=new Error("Could not compute certificate digest. Unknown message digest algorithm OID.");throw s.algorithm=r.md.algorithm,s}r.signatureOid=r.siginfo.algorithmOid=n,r.tbsCertificate=L.getTBSCertificate(r);var i=I.toDer(r.tbsCertificate);r.md.update(i.getBytes()),r.signature=e.sign(r.md)},r.verify=function(e){var t=!1;if(!r.issued(e)){var n=e.issuer,s=r.subject,i=new Error("The parent certificate did not issue the given child certificate; the child certificate's issuer does not match the parent's subject.");throw i.expectedIssuer=s.attributes,i.actualIssuer=n.attributes,i}var o=e.md;if(o===null){o=Ld({signatureOid:e.signatureOid,type:"certificate"});var a=e.tbsCertificate||L.getTBSCertificate(e),c=I.toDer(a);o.update(c.getBytes())}return o!==null&&(t=Fb({certificate:r,md:o,signature:e.signature})),t},r.isIssuer=function(e){var t=!1,n=r.issuer,s=e.subject;if(n.hash&&s.hash)t=n.hash===s.hash;else if(n.attributes.length===s.attributes.length){t=!0;for(var i,o,a=0;t&&a<n.attributes.length;++a)i=n.attributes[a],o=s.attributes[a],(i.type!==o.type||i.value!==o.value)&&(t=!1)}return t},r.issued=function(e){return e.isIssuer(r)},r.generateSubjectKeyIdentifier=function(){return L.getPublicKeyFingerprint(r.publicKey,{type:"RSAPublicKey"})},r.verifySubjectKeyIdentifier=function(){for(var e=ae.subjectKeyIdentifier,t=0;t<r.extensions.length;++t){var n=r.extensions[t];if(n.id===e){var s=r.generateSubjectKeyIdentifier().getBytes();return G.util.hexToBytes(n.subjectKeyIdentifier)===s}}return!1},r};L.certificateFromAsn1=function(r,e){var t={},n=[];if(!I.validate(r,eee,t,n)){var s=new Error("Cannot read X.509 certificate. ASN.1 object is not an X509v3 Certificate.");throw s.errors=n,s}var i=I.derToOid(t.publicKeyOid);if(i!==L.oids.rsaEncryption)throw new Error("Cannot read public key. OID is not RSA.");var o=L.createCertificate();o.version=t.certVersion?t.certVersion.charCodeAt(0):0;var a=G.util.createBuffer(t.certSerialNumber);o.serialNumber=a.toHex(),o.signatureOid=G.asn1.derToOid(t.certSignatureOid),o.signatureParameters=ju(o.signatureOid,t.certSignatureParams,!0),o.siginfo.algorithmOid=G.asn1.derToOid(t.certinfoSignatureOid),o.siginfo.parameters=ju(o.siginfo.algorithmOid,t.certinfoSignatureParams,!1),o.signature=t.certSignature;var c=[];if(t.certValidity1UTCTime!==void 0&&c.push(I.utcTimeToDate(t.certValidity1UTCTime)),t.certValidity2GeneralizedTime!==void 0&&c.push(I.generalizedTimeToDate(t.certValidity2GeneralizedTime)),t.certValidity3UTCTime!==void 0&&c.push(I.utcTimeToDate(t.certValidity3UTCTime)),t.certValidity4GeneralizedTime!==void 0&&c.push(I.generalizedTimeToDate(t.certValidity4GeneralizedTime)),c.length>2)throw new Error("Cannot read notBefore/notAfter validity times; more than two times were provided in the certificate.");if(c.length<2)throw new Error("Cannot read notBefore/notAfter validity times; they were not provided as either UTCTime or GeneralizedTime.");if(o.validity.notBefore=c[0],o.validity.notAfter=c[1],o.tbsCertificate=t.tbsCertificate,e){o.md=Ld({signatureOid:o.signatureOid,type:"certificate"});var u=I.toDer(o.tbsCertificate);o.md.update(u.getBytes())}var l=G.md.sha1.create(),d=I.toDer(t.certIssuer);l.update(d.getBytes()),o.issuer.getField=function(h){return xs(o.issuer,h)},o.issuer.addField=function(h){ur([h]),o.issuer.attributes.push(h)},o.issuer.attributes=L.RDNAttributesAsArray(t.certIssuer),t.certIssuerUniqueId&&(o.issuer.uniqueId=t.certIssuerUniqueId),o.issuer.hash=l.digest().toHex();var f=G.md.sha1.create(),g=I.toDer(t.certSubject);return f.update(g.getBytes()),o.subject.getField=function(h){return xs(o.subject,h)},o.subject.addField=function(h){ur([h]),o.subject.attributes.push(h)},o.subject.attributes=L.RDNAttributesAsArray(t.certSubject),t.certSubjectUniqueId&&(o.subject.uniqueId=t.certSubjectUniqueId),o.subject.hash=f.digest().toHex(),t.certExtensions?o.extensions=L.certificateExtensionsFromAsn1(t.certExtensions):o.extensions=[],o.publicKey=L.publicKeyFromAsn1(t.subjectPublicKeyInfo),o};L.certificateExtensionsFromAsn1=function(r){for(var e=[],t=0;t<r.value.length;++t)for(var n=r.value[t],s=0;s<n.value.length;++s)e.push(L.certificateExtensionFromAsn1(n.value[s]));return e};L.certificateExtensionFromAsn1=function(r){var e={};if(e.id=I.derToOid(r.value[0].value),e.critical=!1,r.value[1].type===I.Type.BOOLEAN?(e.critical=r.value[1].value.charCodeAt(0)!==0,e.value=r.value[2].value):e.value=r.value[1].value,e.id in ae){if(e.name=ae[e.id],e.name==="keyUsage"){var t=I.fromDer(e.value),n=0,s=0;t.value.length>1&&(n=t.value.charCodeAt(1),s=t.value.length>2?t.value.charCodeAt(2):0),e.digitalSignature=(n&128)===128,e.nonRepudiation=(n&64)===64,e.keyEncipherment=(n&32)===32,e.dataEncipherment=(n&16)===16,e.keyAgreement=(n&8)===8,e.keyCertSign=(n&4)===4,e.cRLSign=(n&2)===2,e.encipherOnly=(n&1)===1,e.decipherOnly=(s&128)===128}else if(e.name==="basicConstraints"){var t=I.fromDer(e.value);t.value.length>0&&t.value[0].type===I.Type.BOOLEAN?e.cA=t.value[0].value.charCodeAt(0)!==0:e.cA=!1;var i=null;t.value.length>0&&t.value[0].type===I.Type.INTEGER?i=t.value[0].value:t.value.length>1&&(i=t.value[1].value),i!==null&&(e.pathLenConstraint=I.derToInteger(i))}else if(e.name==="extKeyUsage")for(var t=I.fromDer(e.value),o=0;o<t.value.length;++o){var a=I.derToOid(t.value[o].value);a in ae?e[ae[a]]=!0:e[a]=!0}else if(e.name==="nsCertType"){var t=I.fromDer(e.value),n=0;t.value.length>1&&(n=t.value.charCodeAt(1)),e.client=(n&128)===128,e.server=(n&64)===64,e.email=(n&32)===32,e.objsign=(n&16)===16,e.reserved=(n&8)===8,e.sslCA=(n&4)===4,e.emailCA=(n&2)===2,e.objCA=(n&1)===1}else if(e.name==="subjectAltName"||e.name==="issuerAltName"){e.altNames=[];for(var c,t=I.fromDer(e.value),u=0;u<t.value.length;++u){c=t.value[u];var l={type:c.type,value:c.value};switch(e.altNames.push(l),c.type){case 1:case 2:case 6:break;case 7:l.ip=G.util.bytesToIP(c.value);break;case 8:l.oid=I.derToOid(c.value);break}}}else if(e.name==="subjectKeyIdentifier"){var t=I.fromDer(e.value);e.subjectKeyIdentifier=G.util.bytesToHex(t.value)}}return e};L.certificationRequestFromAsn1=function(r,e){var t={},n=[];if(!I.validate(r,nee,t,n)){var s=new Error("Cannot read PKCS#10 certificate request. ASN.1 object is not a PKCS#10 CertificationRequest.");throw s.errors=n,s}var i=I.derToOid(t.publicKeyOid);if(i!==L.oids.rsaEncryption)throw new Error("Cannot read public key. OID is not RSA.");var o=L.createCertificationRequest();if(o.version=t.csrVersion?t.csrVersion.charCodeAt(0):0,o.signatureOid=G.asn1.derToOid(t.csrSignatureOid),o.signatureParameters=ju(o.signatureOid,t.csrSignatureParams,!0),o.siginfo.algorithmOid=G.asn1.derToOid(t.csrSignatureOid),o.siginfo.parameters=ju(o.siginfo.algorithmOid,t.csrSignatureParams,!1),o.signature=t.csrSignature,o.certificationRequestInfo=t.certificationRequestInfo,e){o.md=Ld({signatureOid:o.signatureOid,type:"certification request"});var a=I.toDer(o.certificationRequestInfo);o.md.update(a.getBytes())}var c=G.md.sha1.create();return o.subject.getField=function(u){return xs(o.subject,u)},o.subject.addField=function(u){ur([u]),o.subject.attributes.push(u)},o.subject.attributes=L.RDNAttributesAsArray(t.certificationRequestInfoSubject,c),o.subject.hash=c.digest().toHex(),o.publicKey=L.publicKeyFromAsn1(t.subjectPublicKeyInfo),o.getAttribute=function(u){return xs(o,u)},o.addAttribute=function(u){ur([u]),o.attributes.push(u)},o.attributes=L.CRIAttributesAsArray(t.certificationRequestInfoAttributes||[]),o};L.createCertificationRequest=function(){var r={};return r.version=0,r.signatureOid=null,r.signature=null,r.siginfo={},r.siginfo.algorithmOid=null,r.subject={},r.subject.getField=function(e){return xs(r.subject,e)},r.subject.addField=function(e){ur([e]),r.subject.attributes.push(e)},r.subject.attributes=[],r.subject.hash=null,r.publicKey=null,r.attributes=[],r.getAttribute=function(e){return xs(r,e)},r.addAttribute=function(e){ur([e]),r.attributes.push(e)},r.md=null,r.setSubject=function(e){ur(e),r.subject.attributes=e,r.subject.hash=null},r.setAttributes=function(e){ur(e),r.attributes=e},r.sign=function(e,t){r.md=t||G.md.sha1.create();var n=ae[r.md.algorithm+"WithRSAEncryption"];if(!n){var s=new Error("Could not compute certification request digest. Unknown message digest algorithm OID.");throw s.algorithm=r.md.algorithm,s}r.signatureOid=r.siginfo.algorithmOid=n,r.certificationRequestInfo=L.getCertificationRequestInfo(r);var i=I.toDer(r.certificationRequestInfo);r.md.update(i.getBytes()),r.signature=e.sign(r.md)},r.verify=function(){var e=!1,t=r.md;if(t===null){t=Ld({signatureOid:r.signatureOid,type:"certification request"});var n=r.certificationRequestInfo||L.getCertificationRequestInfo(r),s=I.toDer(n);t.update(s.getBytes())}return t!==null&&(e=Fb({certificate:r,md:t,signature:r.signature})),e},r};function no(r){for(var e=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]),t,n,s=r.attributes,i=0;i<s.length;++i){t=s[i];var o=t.value,a=I.Type.PRINTABLESTRING;"valueTagClass"in t&&(a=t.valueTagClass,a===I.Type.UTF8&&(o=G.util.encodeUtf8(o))),n=I.create(I.Class.UNIVERSAL,I.Type.SET,!0,[I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(t.type).getBytes()),I.create(I.Class.UNIVERSAL,a,!1,o)])]),e.value.push(n)}return e}function ur(r){for(var e,t=0;t<r.length;++t){if(e=r[t],typeof e.name>"u"&&(e.type&&e.type in L.oids?e.name=L.oids[e.type]:e.shortName&&e.shortName in Fe&&(e.name=L.oids[Fe[e.shortName]])),typeof e.type>"u")if(e.name&&e.name in L.oids)e.type=L.oids[e.name];else{var n=new Error("Attribute type not specified.");throw n.attribute=e,n}if(typeof e.shortName>"u"&&e.name&&e.name in Fe&&(e.shortName=Fe[e.name]),e.type===ae.extensionRequest&&(e.valueConstructed=!0,e.valueTagClass=I.Type.SEQUENCE,!e.value&&e.extensions)){e.value=[];for(var s=0;s<e.extensions.length;++s)e.value.push(L.certificateExtensionToAsn1(Vb(e.extensions[s])))}if(typeof e.value>"u"){var n=new Error("Attribute value not specified.");throw n.attribute=e,n}}}function Vb(r,e){if(e=e||{},typeof r.name>"u"&&r.id&&r.id in L.oids&&(r.name=L.oids[r.id]),typeof r.id>"u")if(r.name&&r.name in L.oids)r.id=L.oids[r.name];else{var t=new Error("Extension ID not specified.");throw t.extension=r,t}if(typeof r.value<"u")return r;if(r.name==="keyUsage"){var n=0,s=0,i=0;r.digitalSignature&&(s|=128,n=7),r.nonRepudiation&&(s|=64,n=6),r.keyEncipherment&&(s|=32,n=5),r.dataEncipherment&&(s|=16,n=4),r.keyAgreement&&(s|=8,n=3),r.keyCertSign&&(s|=4,n=2),r.cRLSign&&(s|=2,n=1),r.encipherOnly&&(s|=1,n=0),r.decipherOnly&&(i|=128,n=7);var o=String.fromCharCode(n);i!==0?o+=String.fromCharCode(s)+String.fromCharCode(i):s!==0&&(o+=String.fromCharCode(s)),r.value=I.create(I.Class.UNIVERSAL,I.Type.BITSTRING,!1,o)}else if(r.name==="basicConstraints")r.value=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]),r.cA&&r.value.value.push(I.create(I.Class.UNIVERSAL,I.Type.BOOLEAN,!1,String.fromCharCode(255))),"pathLenConstraint"in r&&r.value.value.push(I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(r.pathLenConstraint).getBytes()));else if(r.name==="extKeyUsage"){r.value=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]);var a=r.value.value;for(var c in r)r[c]===!0&&(c in ae?a.push(I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(ae[c]).getBytes())):c.indexOf(".")!==-1&&a.push(I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(c).getBytes())))}else if(r.name==="nsCertType"){var n=0,s=0;r.client&&(s|=128,n=7),r.server&&(s|=64,n=6),r.email&&(s|=32,n=5),r.objsign&&(s|=16,n=4),r.reserved&&(s|=8,n=3),r.sslCA&&(s|=4,n=2),r.emailCA&&(s|=2,n=1),r.objCA&&(s|=1,n=0);var o=String.fromCharCode(n);s!==0&&(o+=String.fromCharCode(s)),r.value=I.create(I.Class.UNIVERSAL,I.Type.BITSTRING,!1,o)}else if(r.name==="subjectAltName"||r.name==="issuerAltName"){r.value=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]);for(var u,l=0;l<r.altNames.length;++l){u=r.altNames[l];var o=u.value;if(u.type===7&&u.ip){if(o=G.util.bytesFromIP(u.ip),o===null){var t=new Error('Extension "ip" value is not a valid IPv4 or IPv6 address.');throw t.extension=r,t}}else u.type===8&&(u.oid?o=I.oidToDer(I.oidToDer(u.oid)):o=I.oidToDer(o));r.value.value.push(I.create(I.Class.CONTEXT_SPECIFIC,u.type,!1,o))}}else if(r.name==="nsComment"&&e.cert){if(!/^[\x00-\x7F]*$/.test(r.comment)||r.comment.length<1||r.comment.length>128)throw new Error('Invalid "nsComment" content.');r.value=I.create(I.Class.UNIVERSAL,I.Type.IA5STRING,!1,r.comment)}else if(r.name==="subjectKeyIdentifier"&&e.cert){var d=e.cert.generateSubjectKeyIdentifier();r.subjectKeyIdentifier=d.toHex(),r.value=I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,d.getBytes())}else if(r.name==="authorityKeyIdentifier"&&e.cert){r.value=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]);var a=r.value.value;if(r.keyIdentifier){var f=r.keyIdentifier===!0?e.cert.generateSubjectKeyIdentifier().getBytes():r.keyIdentifier;a.push(I.create(I.Class.CONTEXT_SPECIFIC,0,!1,f))}if(r.authorityCertIssuer){var g=[I.create(I.Class.CONTEXT_SPECIFIC,4,!0,[no(r.authorityCertIssuer===!0?e.cert.issuer:r.authorityCertIssuer)])];a.push(I.create(I.Class.CONTEXT_SPECIFIC,1,!0,g))}if(r.serialNumber){var h=G.util.hexToBytes(r.serialNumber===!0?e.cert.serialNumber:r.serialNumber);a.push(I.create(I.Class.CONTEXT_SPECIFIC,2,!1,h))}}else if(r.name==="cRLDistributionPoints"){r.value=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]);for(var a=r.value.value,p=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]),w=I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[]),u,l=0;l<r.altNames.length;++l){u=r.altNames[l];var o=u.value;if(u.type===7&&u.ip){if(o=G.util.bytesFromIP(u.ip),o===null){var t=new Error('Extension "ip" value is not a valid IPv4 or IPv6 address.');throw t.extension=r,t}}else u.type===8&&(u.oid?o=I.oidToDer(I.oidToDer(u.oid)):o=I.oidToDer(o));w.value.push(I.create(I.Class.CONTEXT_SPECIFIC,u.type,!1,o))}p.value.push(I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[w])),a.push(p)}if(typeof r.value>"u"){var t=new Error("Extension value not specified.");throw t.extension=r,t}return r}function J2(r,e){switch(r){case ae["RSASSA-PSS"]:var t=[];return e.hash.algorithmOid!==void 0&&t.push(I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(e.hash.algorithmOid).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.NULL,!1,"")])])),e.mgf.algorithmOid!==void 0&&t.push(I.create(I.Class.CONTEXT_SPECIFIC,1,!0,[I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(e.mgf.algorithmOid).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(e.mgf.hash.algorithmOid).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.NULL,!1,"")])])])),e.saltLength!==void 0&&t.push(I.create(I.Class.CONTEXT_SPECIFIC,2,!0,[I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(e.saltLength).getBytes())])),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,t);default:return I.create(I.Class.UNIVERSAL,I.Type.NULL,!1,"")}}function see(r){var e=I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[]);if(r.attributes.length===0)return e;for(var t=r.attributes,n=0;n<t.length;++n){var s=t[n],i=s.value,o=I.Type.UTF8;"valueTagClass"in s&&(o=s.valueTagClass),o===I.Type.UTF8&&(i=G.util.encodeUtf8(i));var a=!1;"valueConstructed"in s&&(a=s.valueConstructed);var c=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(s.type).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SET,!0,[I.create(I.Class.UNIVERSAL,o,a,i)])]);e.value.push(c)}return e}var iee=new Date("1950-01-01T00:00:00Z"),oee=new Date("2050-01-01T00:00:00Z");function Z5(r){return r>=iee&&r<oee?I.create(I.Class.UNIVERSAL,I.Type.UTCTIME,!1,I.dateToUtcTime(r)):I.create(I.Class.UNIVERSAL,I.Type.GENERALIZEDTIME,!1,I.dateToGeneralizedTime(r))}L.getTBSCertificate=function(r){var e=Z5(r.validity.notBefore),t=Z5(r.validity.notAfter),n=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(r.version).getBytes())]),I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,G.util.hexToBytes(r.serialNumber)),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.siginfo.algorithmOid).getBytes()),J2(r.siginfo.algorithmOid,r.siginfo.parameters)]),no(r.issuer),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[e,t]),no(r.subject),L.publicKeyToAsn1(r.publicKey)]);return r.issuer.uniqueId&&n.value.push(I.create(I.Class.CONTEXT_SPECIFIC,1,!0,[I.create(I.Class.UNIVERSAL,I.Type.BITSTRING,!1,String.fromCharCode(0)+r.issuer.uniqueId)])),r.subject.uniqueId&&n.value.push(I.create(I.Class.CONTEXT_SPECIFIC,2,!0,[I.create(I.Class.UNIVERSAL,I.Type.BITSTRING,!1,String.fromCharCode(0)+r.subject.uniqueId)])),r.extensions.length>0&&n.value.push(L.certificateExtensionsToAsn1(r.extensions)),n};L.getCertificationRequestInfo=function(r){var e=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(r.version).getBytes()),no(r.subject),L.publicKeyToAsn1(r.publicKey),see(r)]);return e};L.distinguishedNameToAsn1=function(r){return no(r)};L.certificateToAsn1=function(r){var e=r.tbsCertificate||L.getTBSCertificate(r);return I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[e,I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.signatureOid).getBytes()),J2(r.signatureOid,r.signatureParameters)]),I.create(I.Class.UNIVERSAL,I.Type.BITSTRING,!1,String.fromCharCode(0)+r.signature)])};L.certificateExtensionsToAsn1=function(r){var e=I.create(I.Class.CONTEXT_SPECIFIC,3,!0,[]),t=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]);e.value.push(t);for(var n=0;n<r.length;++n)t.value.push(L.certificateExtensionToAsn1(r[n]));return e};L.certificateExtensionToAsn1=function(r){var e=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[]);e.value.push(I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.id).getBytes())),r.critical&&e.value.push(I.create(I.Class.UNIVERSAL,I.Type.BOOLEAN,!1,String.fromCharCode(255)));var t=r.value;return typeof r.value!="string"&&(t=I.toDer(t).getBytes()),e.value.push(I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,t)),e};L.certificationRequestToAsn1=function(r){var e=r.certificationRequestInfo||L.getCertificationRequestInfo(r);return I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[e,I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.signatureOid).getBytes()),J2(r.signatureOid,r.signatureParameters)]),I.create(I.Class.UNIVERSAL,I.Type.BITSTRING,!1,String.fromCharCode(0)+r.signature)])};L.createCaStore=function(r){var e={certs:{}};e.getIssuer=function(o){var a=t(o.issuer);return a},e.addCertificate=function(o){if(typeof o=="string"&&(o=G.pki.certificateFromPem(o)),n(o.subject),!e.hasCertificate(o))if(o.subject.hash in e.certs){var a=e.certs[o.subject.hash];G.util.isArray(a)||(a=[a]),a.push(o),e.certs[o.subject.hash]=a}else e.certs[o.subject.hash]=o},e.hasCertificate=function(o){typeof o=="string"&&(o=G.pki.certificateFromPem(o));var a=t(o.subject);if(!a)return!1;G.util.isArray(a)||(a=[a]);for(var c=I.toDer(L.certificateToAsn1(o)).getBytes(),u=0;u<a.length;++u){var l=I.toDer(L.certificateToAsn1(a[u])).getBytes();if(c===l)return!0}return!1},e.listAllCertificates=function(){var o=[];for(var a in e.certs)if(e.certs.hasOwnProperty(a)){var c=e.certs[a];if(!G.util.isArray(c))o.push(c);else for(var u=0;u<c.length;++u)o.push(c[u])}return o},e.removeCertificate=function(o){var a;if(typeof o=="string"&&(o=G.pki.certificateFromPem(o)),n(o.subject),!e.hasCertificate(o))return null;var c=t(o.subject);if(!G.util.isArray(c))return a=e.certs[o.subject.hash],delete e.certs[o.subject.hash],a;for(var u=I.toDer(L.certificateToAsn1(o)).getBytes(),l=0;l<c.length;++l){var d=I.toDer(L.certificateToAsn1(c[l])).getBytes();u===d&&(a=c[l],c.splice(l,1))}return c.length===0&&delete e.certs[o.subject.hash],a};function t(o){return n(o),e.certs[o.hash]||null}function n(o){if(!o.hash){var a=G.md.sha1.create();o.attributes=L.RDNAttributesAsArray(no(o),a),o.hash=a.digest().toHex()}}if(r)for(var s=0;s<r.length;++s){var i=r[s];e.addCertificate(i)}return e};L.certificateError={bad_certificate:"forge.pki.BadCertificate",unsupported_certificate:"forge.pki.UnsupportedCertificate",certificate_revoked:"forge.pki.CertificateRevoked",certificate_expired:"forge.pki.CertificateExpired",certificate_unknown:"forge.pki.CertificateUnknown",unknown_ca:"forge.pki.UnknownCertificateAuthority"};L.verifyCertificateChain=function(r,e,t){typeof t=="function"&&(t={verify:t}),t=t||{},e=e.slice(0);var n=e.slice(0),s=t.validityCheckDate;typeof s>"u"&&(s=new Date);var i=!0,o=null,a=0;do{var c=e.shift(),u=null,l=!1;if(s&&(s<c.validity.notBefore||s>c.validity.notAfter)&&(o={message:"Certificate is not valid yet or has expired.",error:L.certificateError.certificate_expired,notBefore:c.validity.notBefore,notAfter:c.validity.notAfter,now:s}),o===null){if(u=e[0]||r.getIssuer(c),u===null&&c.isIssuer(c)&&(l=!0,u=c),u){var d=u;G.util.isArray(d)||(d=[d]);for(var f=!1;!f&&d.length>0;){u=d.shift();try{f=u.verify(c)}catch{}}f||(o={message:"Certificate signature is invalid.",error:L.certificateError.bad_certificate})}o===null&&(!u||l)&&!r.hasCertificate(c)&&(o={message:"Certificate is not trusted.",error:L.certificateError.unknown_ca})}if(o===null&&u&&!c.isIssuer(u)&&(o={message:"Certificate issuer is invalid.",error:L.certificateError.bad_certificate}),o===null)for(var g={keyUsage:!0,basicConstraints:!0},h=0;o===null&&h<c.extensions.length;++h){var p=c.extensions[h];p.critical&&!(p.name in g)&&(o={message:"Certificate has an unsupported critical extension.",error:L.certificateError.unsupported_certificate})}if(o===null&&(!i||e.length===0&&(!u||l))){var w=c.getExtension("basicConstraints"),y=c.getExtension("keyUsage");if(y!==null&&(!y.keyCertSign||w===null)&&(o={message:"Certificate keyUsage or basicConstraints conflict or indicate that the certificate is not a CA. If the certificate is the only one in the chain or isn't the first then the certificate must be a valid CA.",error:L.certificateError.bad_certificate}),o===null&&w!==null&&!w.cA&&(o={message:"Certificate basicConstraints indicates the certificate is not a CA.",error:L.certificateError.bad_certificate}),o===null&&y!==null&&"pathLenConstraint"in w){var _=a-1;_>w.pathLenConstraint&&(o={message:"Certificate basicConstraints pathLenConstraint violated.",error:L.certificateError.bad_certificate})}}var b=o===null?!0:o.error,m=t.verify?t.verify(b,a,n):b;if(m===!0)o=null;else throw b===!0&&(o={message:"The application rejected the certificate.",error:L.certificateError.bad_certificate}),(m||m===0)&&(typeof m=="object"&&!G.util.isArray(m)?(m.message&&(o.message=m.message),m.error&&(o.error=m.error)):typeof m=="string"&&(o.error=m)),o;i=!1,++a}while(e.length>0);return!0};var U=Ot,T=U.asn1,xt=U.pkcs7=U.pkcs7||{};xt.messageFromPem=function(r){var e=U.pem.decode(r)[0];if(e.type!=="PKCS7"){var t=new Error('Could not convert PKCS#7 message from PEM; PEM header type is not "PKCS#7".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert PKCS#7 message from PEM; PEM is encrypted.");var n=T.fromDer(e.body);return xt.messageFromAsn1(n)};xt.messageToPem=function(r,e){var t={type:"PKCS7",body:T.toDer(r.toAsn1()).getBytes()};return U.pem.encode(t,{maxline:e})};xt.messageFromAsn1=function(r){var e={},t=[];if(!T.validate(r,xt.asn1.contentInfoValidator,e,t)){var n=new Error("Cannot read PKCS#7 message. ASN.1 object is not an PKCS#7 ContentInfo.");throw n.errors=t,n}var s=T.derToOid(e.contentType),i;switch(s){case U.pki.oids.envelopedData:i=xt.createEnvelopedData();break;case U.pki.oids.encryptedData:i=xt.createEncryptedData();break;case U.pki.oids.signedData:i=xt.createSignedData();break;default:throw new Error("Cannot read PKCS#7 message. ContentType with OID "+s+" is not (yet) supported.")}return i.fromAsn1(e.content.value[0]),i};xt.createSignedData=function(){var r=null;return r={type:U.pki.oids.signedData,version:1,certificates:[],crls:[],signers:[],digestAlgorithmIdentifiers:[],contentInfo:null,signerInfos:[],fromAsn1:function(n){if(X2(r,n,xt.asn1.signedDataValidator),r.certificates=[],r.crls=[],r.digestAlgorithmIdentifiers=[],r.contentInfo=null,r.signerInfos=[],r.rawCapture.certificates)for(var s=r.rawCapture.certificates.value,i=0;i<s.length;++i)r.certificates.push(U.pki.certificateFromAsn1(s[i]))},toAsn1:function(){r.contentInfo||r.sign();for(var n=[],s=0;s<r.certificates.length;++s)n.push(U.pki.certificateToAsn1(r.certificates[s]));var i=[],o=T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SET,!0,r.digestAlgorithmIdentifiers),r.contentInfo])]);return n.length>0&&o.value[0].value.push(T.create(T.Class.CONTEXT_SPECIFIC,0,!0,n)),i.length>0&&o.value[0].value.push(T.create(T.Class.CONTEXT_SPECIFIC,1,!0,i)),o.value[0].value.push(T.create(T.Class.UNIVERSAL,T.Type.SET,!0,r.signerInfos)),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.type).getBytes()),o])},addSigner:function(n){var s=n.issuer,i=n.serialNumber;if(n.certificate){var o=n.certificate;typeof o=="string"&&(o=U.pki.certificateFromPem(o)),s=o.issuer.attributes,i=o.serialNumber}var a=n.key;if(!a)throw new Error("Could not add PKCS#7 signer; no private key specified.");typeof a=="string"&&(a=U.pki.privateKeyFromPem(a));var c=n.digestAlgorithm||U.pki.oids.sha1;switch(c){case U.pki.oids.sha1:case U.pki.oids.sha256:case U.pki.oids.sha384:case U.pki.oids.sha512:case U.pki.oids.md5:break;default:throw new Error("Could not add PKCS#7 signer; unknown message digest algorithm: "+c)}var u=n.authenticatedAttributes||[];if(u.length>0){for(var l=!1,d=!1,f=0;f<u.length;++f){var g=u[f];if(!l&&g.type===U.pki.oids.contentType){if(l=!0,d)break;continue}if(!d&&g.type===U.pki.oids.messageDigest){if(d=!0,l)break;continue}}if(!l||!d)throw new Error("Invalid signer.authenticatedAttributes. If signer.authenticatedAttributes is specified, then it must contain at least two attributes, PKCS #9 content-type and PKCS #9 message-digest.")}r.signers.push({key:a,version:1,issuer:s,serialNumber:i,digestAlgorithm:c,signatureAlgorithm:U.pki.oids.rsaEncryption,signature:null,authenticatedAttributes:u,unauthenticatedAttributes:[]})},sign:function(n){if(n=n||{},(typeof r.content!="object"||r.contentInfo===null)&&(r.contentInfo=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(U.pki.oids.data).getBytes())]),"content"in r)){var s;r.content instanceof U.util.ByteBuffer?s=r.content.bytes():typeof r.content=="string"&&(s=U.util.encodeUtf8(r.content)),n.detached?r.detachedContent=T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,s):r.contentInfo.value.push(T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,s)]))}if(r.signers.length!==0){var i=e();t(i)}},verify:function(){throw new Error("PKCS#7 signature verification not yet implemented.")},addCertificate:function(n){typeof n=="string"&&(n=U.pki.certificateFromPem(n)),r.certificates.push(n)},addCertificateRevokationList:function(n){throw new Error("PKCS#7 CRL support not yet implemented.")}},r;function e(){for(var n={},s=0;s<r.signers.length;++s){var i=r.signers[s],o=i.digestAlgorithm;o in n||(n[o]=U.md[U.pki.oids[o]].create()),i.authenticatedAttributes.length===0?i.md=n[o]:i.md=U.md[U.pki.oids[o]].create()}r.digestAlgorithmIdentifiers=[];for(var o in n)r.digestAlgorithmIdentifiers.push(T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(o).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")]));return n}function t(n){var s;if(r.detachedContent?s=r.detachedContent:(s=r.contentInfo.value[1],s=s.value[0]),!s)throw new Error("Could not sign PKCS#7 message; there is no content to sign.");var i=T.derToOid(r.contentInfo.value[0].value),o=T.toDer(s);o.getByte(),T.getBerValueLength(o),o=o.getBytes();for(var a in n)n[a].start().update(o);for(var c=new Date,u=0;u<r.signers.length;++u){var l=r.signers[u];if(l.authenticatedAttributes.length===0){if(i!==U.pki.oids.data)throw new Error("Invalid signer; authenticatedAttributes must be present when the ContentInfo content type is not PKCS#7 Data.")}else{l.authenticatedAttributesAsn1=T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[]);for(var d=T.create(T.Class.UNIVERSAL,T.Type.SET,!0,[]),f=0;f<l.authenticatedAttributes.length;++f){var g=l.authenticatedAttributes[f];g.type===U.pki.oids.messageDigest?g.value=n[l.digestAlgorithm].digest():g.type===U.pki.oids.signingTime&&(g.value||(g.value=c)),d.value.push(r0(g)),l.authenticatedAttributesAsn1.value.push(r0(g))}o=T.toDer(d).getBytes(),l.md.start().update(o)}l.signature=l.key.sign(l.md,"RSASSA-PKCS1-V1_5")}r.signerInfos=hee(r.signers)}};xt.createEncryptedData=function(){var r=null;return r={type:U.pki.oids.encryptedData,version:0,encryptedContent:{algorithm:U.pki.oids["aes256-CBC"]},fromAsn1:function(e){X2(r,e,xt.asn1.encryptedDataValidator)},decrypt:function(e){e!==void 0&&(r.encryptedContent.key=e),jb(r)}},r};xt.createEnvelopedData=function(){var r=null;return r={type:U.pki.oids.envelopedData,version:0,recipients:[],encryptedContent:{algorithm:U.pki.oids["aes256-CBC"]},fromAsn1:function(e){var t=X2(r,e,xt.asn1.envelopedDataValidator);r.recipients=lee(t.recipientInfos.value)},toAsn1:function(){return T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.type).getBytes()),T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SET,!0,uee(r.recipients)),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,fee(r.encryptedContent))])])])},findRecipient:function(e){for(var t=e.issuer.attributes,n=0;n<r.recipients.length;++n){var s=r.recipients[n],i=s.issuer;if(s.serialNumber===e.serialNumber&&i.length===t.length){for(var o=!0,a=0;a<t.length;++a)if(i[a].type!==t[a].type||i[a].value!==t[a].value){o=!1;break}if(o)return s}}return null},decrypt:function(e,t){if(r.encryptedContent.key===void 0&&e!==void 0&&t!==void 0)switch(e.encryptedContent.algorithm){case U.pki.oids.rsaEncryption:case U.pki.oids.desCBC:var n=t.decrypt(e.encryptedContent.content);r.encryptedContent.key=U.util.createBuffer(n);break;default:throw new Error("Unsupported asymmetric cipher, OID "+e.encryptedContent.algorithm)}jb(r)},addRecipient:function(e){r.recipients.push({version:0,issuer:e.issuer.attributes,serialNumber:e.serialNumber,encryptedContent:{algorithm:U.pki.oids.rsaEncryption,key:e.publicKey}})},encrypt:function(e,t){if(r.encryptedContent.content===void 0){t=t||r.encryptedContent.algorithm,e=e||r.encryptedContent.key;var n,s,i;switch(t){case U.pki.oids["aes128-CBC"]:n=16,s=16,i=U.aes.createEncryptionCipher;break;case U.pki.oids["aes192-CBC"]:n=24,s=16,i=U.aes.createEncryptionCipher;break;case U.pki.oids["aes256-CBC"]:n=32,s=16,i=U.aes.createEncryptionCipher;break;case U.pki.oids["des-EDE3-CBC"]:n=24,s=8,i=U.des.createEncryptionCipher;break;default:throw new Error("Unsupported symmetric cipher, OID "+t)}if(e===void 0)e=U.util.createBuffer(U.random.getBytes(n));else if(e.length()!=n)throw new Error("Symmetric key has wrong length; got "+e.length()+" bytes, expected "+n+".");r.encryptedContent.algorithm=t,r.encryptedContent.key=e,r.encryptedContent.parameter=U.util.createBuffer(U.random.getBytes(s));var o=i(e);if(o.start(r.encryptedContent.parameter.copy()),o.update(r.content),!o.finish())throw new Error("Symmetric encryption failed.");r.encryptedContent.content=o.output}for(var a=0;a<r.recipients.length;++a){var c=r.recipients[a];if(c.encryptedContent.content===void 0)switch(c.encryptedContent.algorithm){case U.pki.oids.rsaEncryption:c.encryptedContent.content=c.encryptedContent.key.encrypt(r.encryptedContent.key.data);break;default:throw new Error("Unsupported asymmetric cipher, OID "+c.encryptedContent.algorithm)}}}},r};function aee(r){var e={},t=[];if(!T.validate(r,xt.asn1.recipientInfoValidator,e,t)){var n=new Error("Cannot read PKCS#7 RecipientInfo. ASN.1 object is not an PKCS#7 RecipientInfo.");throw n.errors=t,n}return{version:e.version.charCodeAt(0),issuer:U.pki.RDNAttributesAsArray(e.issuer),serialNumber:U.util.createBuffer(e.serial).toHex(),encryptedContent:{algorithm:T.derToOid(e.encAlgorithm),parameter:e.encParameter?e.encParameter.value:void 0,content:e.encKey}}}function cee(r){return T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[U.pki.distinguishedNameToAsn1({attributes:r.issuer}),T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,U.util.hexToBytes(r.serialNumber))]),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.encryptedContent.algorithm).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")]),T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.encryptedContent.content)])}function lee(r){for(var e=[],t=0;t<r.length;++t)e.push(aee(r[t]));return e}function uee(r){for(var e=[],t=0;t<r.length;++t)e.push(cee(r[t]));return e}function dee(r){var e=T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,T.integerToDer(r.version).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[U.pki.distinguishedNameToAsn1({attributes:r.issuer}),T.create(T.Class.UNIVERSAL,T.Type.INTEGER,!1,U.util.hexToBytes(r.serialNumber))]),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.digestAlgorithm).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")])]);if(r.authenticatedAttributesAsn1&&e.value.push(r.authenticatedAttributesAsn1),e.value.push(T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.signatureAlgorithm).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.NULL,!1,"")])),e.value.push(T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.signature)),r.unauthenticatedAttributes.length>0){for(var t=T.create(T.Class.CONTEXT_SPECIFIC,1,!0,[]),n=0;n<r.unauthenticatedAttributes.length;++n){var s=r.unauthenticatedAttributes[n];t.values.push(r0(s))}e.value.push(t)}return e}function hee(r){for(var e=[],t=0;t<r.length;++t)e.push(dee(r[t]));return e}function r0(r){var e;if(r.type===U.pki.oids.contentType)e=T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.value).getBytes());else if(r.type===U.pki.oids.messageDigest)e=T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.value.bytes());else if(r.type===U.pki.oids.signingTime){var t=new Date("1950-01-01T00:00:00Z"),n=new Date("2050-01-01T00:00:00Z"),s=r.value;if(typeof s=="string"){var i=Date.parse(s);isNaN(i)?s.length===13?s=T.utcTimeToDate(s):s=T.generalizedTimeToDate(s):s=new Date(i)}s>=t&&s<n?e=T.create(T.Class.UNIVERSAL,T.Type.UTCTIME,!1,T.dateToUtcTime(s)):e=T.create(T.Class.UNIVERSAL,T.Type.GENERALIZEDTIME,!1,T.dateToGeneralizedTime(s))}return T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.type).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SET,!0,[e])])}function fee(r){return[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(U.pki.oids.data).getBytes()),T.create(T.Class.UNIVERSAL,T.Type.SEQUENCE,!0,[T.create(T.Class.UNIVERSAL,T.Type.OID,!1,T.oidToDer(r.algorithm).getBytes()),r.parameter?T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.parameter.getBytes()):void 0]),T.create(T.Class.CONTEXT_SPECIFIC,0,!0,[T.create(T.Class.UNIVERSAL,T.Type.OCTETSTRING,!1,r.content.getBytes())])]}function X2(r,e,t){var n={},s=[];if(!T.validate(e,t,n,s)){var i=new Error("Cannot read PKCS#7 message. ASN.1 object is not a supported PKCS#7 message.");throw i.errors=i,i}var o=T.derToOid(n.contentType);if(o!==U.pki.oids.data)throw new Error("Unsupported PKCS#7 message. Only wrapped ContentType Data supported.");if(n.encryptedContent){var a="";if(U.util.isArray(n.encryptedContent))for(var c=0;c<n.encryptedContent.length;++c){if(n.encryptedContent[c].type!==T.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting encrypted content constructed of only OCTET STRING objects.");a+=n.encryptedContent[c].value}else a=n.encryptedContent;r.encryptedContent={algorithm:T.derToOid(n.encAlgorithm),parameter:U.util.createBuffer(n.encParameter.value),content:U.util.createBuffer(a)}}if(n.content){var a="";if(U.util.isArray(n.content))for(var c=0;c<n.content.length;++c){if(n.content[c].type!==T.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting content constructed of only OCTET STRING objects.");a+=n.content[c].value}else a=n.content;r.content=U.util.createBuffer(a)}return r.version=n.version.charCodeAt(0),r.rawCapture=n,n}function jb(r){if(r.encryptedContent.key===void 0)throw new Error("Symmetric key not available.");if(r.content===void 0){var e;switch(r.encryptedContent.algorithm){case U.pki.oids["aes128-CBC"]:case U.pki.oids["aes192-CBC"]:case U.pki.oids["aes256-CBC"]:e=U.aes.createDecryptionCipher(r.encryptedContent.key);break;case U.pki.oids.desCBC:case U.pki.oids["des-EDE3-CBC"]:e=U.des.createDecryptionCipher(r.encryptedContent.key);break;default:throw new Error("Unsupported symmetric cipher, OID "+r.encryptedContent.algorithm)}if(e.start(r.encryptedContent.parameter),e.update(r.encryptedContent.content),!e.finish())throw new Error("Symmetric decryption failed.");r.content=e.output}}const e4=Ot.pki,pee=(r,e)=>{const t=e4.rsa.setPublicKey(e.n,e.e),n=e4.createCertificate();n.publicKey=t,n.serialNumber="01",n.validity.notBefore=new Date,n.validity.notAfter=new Date,n.validity.notAfter.setFullYear(n.validity.notBefore.getFullYear()+10);const s=[{name:"organizationName",value:"ipfs"},{shortName:"OU",value:"keystore"},{name:"commonName",value:r.id}];return n.setSubject(s),n.setIssuer(s),n.setExtensions([{name:"basicConstraints",cA:!0},{name:"keyUsage",keyCertSign:!0,digitalSignature:!0,nonRepudiation:!0,keyEncipherment:!0,dataEncipherment:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0,codeSigning:!0,emailProtection:!0,timeStamping:!0},{name:"nsCertType",client:!0,server:!0,email:!0,objsign:!0,sslCA:!0,emailCA:!0,objCA:!0}]),n.sign(e),n};async function gee(r,e){const t=r.map(e),s=(await Promise.all(t)).findIndex(i=>i);return r[s]}const yee=O("libp2p:keychain:cms"),Hh=new WeakMap;class wee{constructor(e,t){if(e==null)throw E(new Error("keychain is required"),D.ERR_KEYCHAIN_REQUIRED);this.keychain=e,Hh.set(this,{dek:t})}async encrypt(e,t){if(!(t instanceof Uint8Array))throw E(new Error("Plain data must be a Uint8Array"),D.ERR_INVALID_PARAMETERS);const n=await this.keychain.findKeyByName(e),s=await this.keychain.getPrivateKey(e),i=Hh.get(this);if(i==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const o=i.dek,a=Ot.pki.decryptRsaPrivateKey(s,o),c=await pee(n,a),u=Ot.pkcs7.createEnvelopedData();u.addRecipient(c),u.content=Ot.util.createBuffer(t),u.encrypt();const l=Ot.asn1.toDer(u.toAsn1()).getBytes();return M(l,"ascii")}async decrypt(e){if(!(e instanceof Uint8Array))throw E(new Error("CMS data is required"),D.ERR_INVALID_PARAMETERS);let t;try{const l=Ot.util.createBuffer(q(e,"ascii")),d=Ot.asn1.fromDer(l);t=Ot.pkcs7.messageFromAsn1(d)}catch(l){throw yee.error(l),E(new Error("Invalid CMS"),D.ERR_INVALID_CMS)}const n=t.recipients.filter(l=>l.issuer.find(d=>d.shortName==="O"&&d.value==="ipfs")).filter(l=>l.issuer.find(d=>d.shortName==="CN")).map(l=>({recipient:l,keyId:l.issuer.find(d=>d.shortName==="CN").value})),s=await gee(n,async l=>{try{if(await this.keychain.findKeyById(l.keyId)!=null)return!0}catch{return!1}return!1});if(s==null){const l=n.map(d=>d.keyId);throw E(new Error(`Decryption needs one of the key(s): ${l.join(", ")}`),D.ERR_MISSING_KEYS,{missingKeys:l})}const i=await this.keychain.findKeyById(s.keyId);if(i==null)throw E(new Error("No key available to decrypto"),D.ERR_NO_KEY);const o=await this.keychain.getPrivateKey(i.name),a=Hh.get(this);if(a==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const c=a.dek,u=Ot.pki.decryptRsaPrivateKey(o,c);return t.decrypt(s.recipient,u),M(t.content.getBytes(),"ascii")}}const zc=O("libp2p:keychain"),mee="/pkcs8/",Kb="/info/",Wn=new WeakMap,Bs={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},Gh={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function un(r){return r==null||typeof r!="string"?!1:r===QZ(r.trim())&&r.length>0}async function we(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Or(r){return new J(mee+r)}function dn(r){return new J(Kb+r)}class t4{constructor(e,t){if(this.components=e,this.init=Le(Gh,t),this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Bs.minKeyLength)throw new Error(`dek.keyLength must be least ${Bs.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Bs.minSaltLength)throw new Error(`dek.saltLength must be least ${Bs.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Bs.minIterationCount)throw new Error(`dek.iterationCount must be least ${Bs.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?_p(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Wn.set(this,{dek:n}),this.started=!1}isStarted(){return this.started}async start(){const e=dn("self");await this.components.datastore.has(e)||await this.importPeer("self",this.components.peerId),this.started=!0}stop(){this.started=!1}get cms(){const e=Wn.get(this);if(e==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const t=e.dek;return new wee(this,t)}static generateOptions(){const e=Object.assign({},Gh),t=Math.ceil(Bs.minSaltLength/3)*3;return e.dek.salt=q(id(t),"base64"),e}static get options(){return Gh}async createKey(e,t,n=2048){if(!un(e)||e==="self")throw await we(),E(new Error("Invalid key name"),D.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await we(),E(new Error("Invalid key type"),D.ERR_INVALID_KEY_TYPE);const s=Or(e);if(await this.components.datastore.has(s))throw await we(),E(new Error("Key name already exists"),D.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(n)||n<2048)throw await we(),E(new Error("Invalid RSA key size"),D.ERR_INVALID_KEY_SIZE);break}let o;try{const a=await v0(t,n),c=await a.id(),u=Wn.get(this);if(u==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const l=u.dek,d=await a.export(l);o={name:e,id:c};const f=this.components.datastore.batch();f.put(s,M(d)),f.put(dn(e),M(JSON.stringify(o))),await f.commit()}catch(a){throw await we(),a}return o}async listKeys(){const e={prefix:Kb},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(q(n.value)));return t}async findKeyById(e){try{return(await this.listKeys()).find(n=>n.id===e)}catch(t){throw await we(),t}}async findKeyByName(e){if(!un(e))throw await we(),E(new Error(`Invalid key name '${e}'`),D.ERR_INVALID_KEY_NAME);const t=dn(e);try{const n=await this.components.datastore.get(t);return JSON.parse(q(n))}catch(n){throw await we(),zc.error(n),E(new Error(`Key '${e}' does not exist.`),D.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!un(e)||e==="self")throw await we(),E(new Error(`Invalid key name '${e}'`),D.ERR_INVALID_KEY_NAME);const t=Or(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(dn(e)),await s.commit(),n}async renameKey(e,t){if(!un(e)||e==="self")throw await we(),E(new Error(`Invalid old key name '${e}'`),D.ERR_OLD_KEY_NAME_INVALID);if(!un(t)||t==="self")throw await we(),E(new Error(`Invalid new key name '${t}'`),D.ERR_NEW_KEY_NAME_INVALID);const n=Or(e),s=Or(t),i=dn(e),o=dn(t);if(await this.components.datastore.has(s))throw await we(),E(new Error(`Key '${t}' already exists`),D.ERR_KEY_ALREADY_EXISTS);try{const c=await this.components.datastore.get(n),u=await this.components.datastore.get(i),l=JSON.parse(q(u));l.name=t;const d=this.components.datastore.batch();return d.put(s,c),d.put(o,M(JSON.stringify(l))),d.delete(n),d.delete(i),await d.commit(),l}catch(c){throw await we(),c}}async exportKey(e,t){if(!un(e))throw await we(),E(new Error(`Invalid key name '${e}'`),D.ERR_INVALID_KEY_NAME);if(t==null)throw await we(),E(new Error("Password is required"),D.ERR_PASSWORD_REQUIRED);const n=Or(e);try{const s=await this.components.datastore.get(n),i=q(s),o=Wn.get(this);if(o==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const a=o.dek;return await(await da(i,a)).export(t)}catch(s){throw await we(),s}}async importKey(e,t,n){if(!un(e)||e==="self")throw await we(),E(new Error(`Invalid key name '${e}'`),D.ERR_INVALID_KEY_NAME);if(t==null)throw await we(),E(new Error("PEM encoded key is required"),D.ERR_PEM_REQUIRED);const s=Or(e);if(await this.components.datastore.has(s))throw await we(),E(new Error(`Key '${e}' already exists`),D.ERR_KEY_ALREADY_EXISTS);let o;try{o=await da(t,n)}catch{throw await we(),E(new Error("Cannot read the key, most likely the password is wrong"),D.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();const l=Wn.get(this);if(l==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const d=l.dek;t=await o.export(d)}catch(l){throw await we(),l}const c={name:e,id:a},u=this.components.datastore.batch();return u.put(s,M(t)),u.put(dn(e),M(JSON.stringify(c))),await u.commit(),c}async importPeer(e,t){try{if(!un(e))throw E(new Error(`Invalid key name '${e}'`),D.ERR_INVALID_KEY_NAME);if(t==null)throw E(new Error("PeerId is required"),D.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw E(new Error("PeerId.privKey is required"),D.ERR_MISSING_PRIVATE_KEY);const n=await oi(t.privateKey),s=Or(e);if(await this.components.datastore.has(s))throw await we(),E(new Error(`Key '${e}' already exists`),D.ERR_KEY_ALREADY_EXISTS);const o=Wn.get(this);if(o==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const a=o.dek,c=await n.export(a),u={name:e,id:t.toString()},l=this.components.datastore.batch();return l.put(s,M(c)),l.put(dn(e),M(JSON.stringify(u))),await l.commit(),u}catch(n){throw await we(),n}}async getPrivateKey(e){if(!un(e))throw await we(),E(new Error(`Invalid key name '${e}'`),D.ERR_INVALID_KEY_NAME);try{const t=Or(e),n=await this.components.datastore.get(t);return q(n)}catch(t){throw await we(),zc.error(t),E(new Error(`Key '${e}' does not exist.`),D.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await we(),E(new Error(`Invalid old pass type '${typeof e}'`),D.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await we(),E(new Error(`Invalid new pass type '${typeof t}'`),D.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await we(),E(new Error(`Invalid pass length ${t.length}`),D.ERR_INVALID_PASS_LENGTH);zc("recreating keychain");const n=Wn.get(this);if(n==null)throw E(new Error("dek missing"),D.ERR_INVALID_PARAMETERS);const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?_p(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Wn.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(Or(a.name)),u=q(c),l=await da(u,s),d=i.toString(),f=await l.export(d),g=this.components.datastore.batch(),h={name:a.name,id:a.id};g.put(Or(a.name),M(f)),g.put(dn(a.name),M(JSON.stringify(h))),await g.commit()}zc("keychain reconstructed")}}async function*n0(r,e){for await(const t of r)await e(t),yield t}const qb=3e4,bee=3e4,Hb=100,Gb=4,Eee=25,_ee={computeThrottleMaxQueueSize:1e3,computeThrottleTimeout:2e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3],maxOldPeersRetention:50};class vee{constructor(e){if(typeof e!="number")throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");this.timespan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timespan)}push(e,t){if(this.previousTime!=null){const n=this.alpha(e,this.previousTime),s=t-this.movingAverage,i=n*s;this.movingAverage=n*t+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*s}else this.movingAverage=t;this.previousTime=e}}function r4(r){return new vee(r)}class Wh extends st{constructor(e){super(),this.enabled=e.enabled,this.queue=[],this.stats={dataReceived:0n,dataSent:0n},this.frequencyLastTime=Date.now(),this.frequencyAccumulators={},this.movingAverages={dataReceived:[],dataSent:[]},this.computeThrottleMaxQueueSize=e.computeThrottleMaxQueueSize,this.computeThrottleTimeout=e.computeThrottleTimeout,this._update=this._update.bind(this),this.movingAverageIntervals=e.movingAverageIntervals;for(let t=0;t<e.initialCounters.length;t++){const n=e.initialCounters[t];this.stats[n]=0n,this.movingAverages[n]=[];for(let s=0;s<this.movingAverageIntervals.length;s++){const i=this.movingAverageIntervals[s];(this.movingAverages[n][i]=r4(i)).push(this.frequencyLastTime,0)}}}start(){this.enabled&&this.queue.length>0&&this._resetComputeTimeout()}stop(){this.timeout!=null&&(this.timeout.clear(),this.timeout=null)}getSnapshot(){return Object.assign({},this.stats)}getMovingAverages(){return Object.assign({},this.movingAverages)}push(e,t){this.queue.push([e,t,Date.now()]),this._resetComputeTimeout()}_resetComputeTimeout(){this.timeout=Gi(this._update,this._nextTimeout())}_nextTimeout(){const e=this.queue.length/this.computeThrottleMaxQueueSize;return Math.max(this.computeThrottleTimeout*(1-e),0)}_update(){if(this.timeout=null,this.queue.length>0){let e=["",0,0];for(e of this.queue)this._applyOp(e);this.queue=[],e.length>2&&e[0]!==""&&this._updateFrequency(e[2]),this.dispatchEvent(new Z("update",{detail:this.stats}))}}_updateFrequency(e){const t=e-this.frequencyLastTime;this._updateFrequencyFor("dataReceived",t,e),this._updateFrequencyFor("dataSent",t,e),this.frequencyLastTime=e}_updateFrequencyFor(e,t,n){const s=this.frequencyAccumulators[e]??0;this.frequencyAccumulators[e]=0;const o=s/(t??1)*1e3;let a=this.movingAverages[e];a==null&&(a=this.movingAverages[e]=[]);const c=this.movingAverageIntervals;for(let u=0;u<c.length;u++){const l=c[u];let d=a[l];d==null&&(d=a[l]=r4(l)),d.push(n,o)}}_applyOp(e){const t=e[0],n=e[1];if(typeof n!="number")throw new Error("invalid increment number");let s;Object.prototype.hasOwnProperty.call(this.stats,t)?s=this.stats[t]:s=this.stats[t]=0n,this.stats[t]=s+BigInt(n),this.frequencyAccumulators[t]==null&&(this.frequencyAccumulators[t]=0),this.frequencyAccumulators[t]+=n}}const See=["dataReceived","dataSent"],Ree={in:"dataReceived",out:"dataSent"};class Iee{constructor(e){this.enabled=e.enabled,this.statsInit={...e,initialCounters:See},this.globalStats=new Wh(this.statsInit),this.peerStats=new Map,this.protocolStats=new Map,this.oldPeers=Ga(e.maxOldPeersRetention??_ee.maxOldPeersRetention),this.running=!1,this._onMessage=this._onMessage.bind(this),this.systems=new Map}isStarted(){return this.running}async start(){this.enabled&&(this.running=!0)}async stop(){if(this.running){this.running=!1,this.globalStats.stop();for(const e of this.peerStats.values())e.stop();for(const e of this.protocolStats.values())e.stop()}}getGlobal(){return this.globalStats}getPeers(){return Array.from(this.peerStats.keys())}getComponentMetrics(){return this.systems}updateComponentMetric(e){const{system:t="libp2p",component:n,metric:s,value:i,label:o,help:a}=e;this.systems.has(t)||this.systems.set(t,new Map);const c=this.systems.get(t);if(c==null)throw new Error("Unknown metric system");c.has(n)||c.set(n,new Map);const u=c.get(n);if(u==null)throw new Error("Unknown metric component");u.set(s,{label:o,help:a,calculate:typeof i!="function"?()=>i:i})}forPeer(e){const t=e.toString();return this.peerStats.get(t)??this.oldPeers.get(t)}getProtocols(){return Array.from(this.protocolStats.keys())}forProtocol(e){return this.protocolStats.get(e)}onPeerDisconnected(e){const t=e.toString(),n=this.peerStats.get(t);n!=null&&(n.stop(),this.peerStats.delete(t),this.oldPeers.set(t,n))}_onMessage(e){if(!this.running)return;const{remotePeer:t,protocol:n,direction:s,dataLength:i}=e,o=Ree[s];let a=this.forPeer(t);if(a==null){const c=new Wh(this.statsInit);this.peerStats.set(t.toString(),c),a=c}if(a.push(o,i),this.globalStats.push(o,i),n!=null){let c=this.forProtocol(n);if(c==null){const u=new Wh(this.statsInit);this.protocolStats.set(n,u),c=u}c.push(o,i)}}updatePlaceholder(e,t){if(!this.running)return;const n=e.toString(),s=this.peerStats.get(n)??this.oldPeers.get(n),i=t.toString(),o=this.peerStats.get(i)??this.oldPeers.get(i);let a=s;o!=null&&(a=Aee(o,a),this.oldPeers.remove(i)),this.peerStats.delete(e.toString()),this.peerStats.set(i,a),a.start()}trackStream(e){const{stream:t,remotePeer:n,protocol:s}=e;if(!this.running)return;const i=t.source;t.source=n0(i,a=>this._onMessage({remotePeer:n,protocol:s,direction:"in",dataLength:a.byteLength}));const o=t.sink;t.sink=async a=>await ne(a,c=>n0(c,u=>{this._onMessage({remotePeer:n,protocol:s,direction:"out",dataLength:u.byteLength})}),o)}}function Aee(r,e){return r.stop(),e.stop(),r.queue=[...r.queue,...e.queue],r}async function Yh(r){try{return{status:"fulfilled",value:await r,isFulfilled:!0,isRejected:!1}}catch(e){return{status:"rejected",reason:e,isFulfilled:!1,isRejected:!0}}}class Cee{constructor(e){zd(this,"value");zd(this,"next");this.value=e}}var Mr,Gs,Ws;class Tee{constructor(){lc(this,Mr,void 0);lc(this,Gs,void 0);lc(this,Ws,void 0);this.clear()}enqueue(e){const t=new Cee(e);Kn(this,Mr)?(Kn(this,Gs).next=t,nn(this,Gs,t)):(nn(this,Mr,t),nn(this,Gs,t)),Fd(this,Ws)._++}dequeue(){const e=Kn(this,Mr);if(e)return nn(this,Mr,Kn(this,Mr).next),Fd(this,Ws)._--,e.value}clear(){nn(this,Mr,void 0),nn(this,Gs,void 0),nn(this,Ws,0)}get size(){return Kn(this,Ws)}*[Symbol.iterator](){let e=Kn(this,Mr);for(;e;)yield e.value,e=e.next}}Mr=new WeakMap,Gs=new WeakMap,Ws=new WeakMap;function Dee(r){if(!((Number.isInteger(r)||r===Number.POSITIVE_INFINITY)&&r>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up");const e=new Tee;let t=0;const n=()=>{t--,e.size>0&&e.dequeue()()},s=async(a,c,u)=>{t++;const l=(async()=>a(...u))();c(l);try{await l}catch{}n()},i=(a,c,u)=>{e.enqueue(s.bind(void 0,a,c,u)),(async()=>(await Promise.resolve(),t<r&&e.size>0&&e.dequeue()()))()},o=(a,...c)=>new Promise(u=>{i(a,u,c)});return Object.defineProperties(o,{activeCount:{get:()=>t},pendingCount:{get:()=>e.size},clearQueue:{value:()=>{e.clear()}}}),o}async function Pee(r,e={}){const{concurrency:t=Number.POSITIVE_INFINITY}=e,n=Dee(t);return Promise.all(r.map(s=>s&&typeof s.then=="function"?Yh(s):Yh(typeof s=="function"?n(()=>s()):Promise.resolve(s))))}class kee extends Map{constructor(e){super();const{system:t,component:n,metric:s,metrics:i}=e;this.system=t??"libp2p",this.component=n,this.metric=s,this.metrics=i,this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metrics.updateComponentMetric({system:this.system,component:this.component,metric:this.metric,value:this.size})}}function si(r){const{system:e,component:t,metric:n,metrics:s}=r;let i;return s!=null?i=new kee({system:e,component:t,metric:n,metrics:s}):i=new Map,i}const zs=O("libp2p:transports");class Oee extends st{constructor(e,t={}){super(),this.components=e,this.started=!1,this.transports=new Map,this.listeners=si({component:"transport-manager",metric:"listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??zi.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw E(new Error("Transport must have a valid tag"),D.ERR_INVALID_KEY);if(this.transports.has(t))throw E(new Error("There is already a transport with this tag"),D.ERR_DUPLICATE_TRANSPORT);zs("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}async start(){const e=this.components.addressManager.getListenAddrs();await this.listen(e),this.started=!0}async stop(){const e=[];for(const[t,n]of this.listeners)for(zs("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),zs("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.transportForMultiaddr(e);if(n==null)throw E(new Error(`No transport available for address ${String(e)}`),D.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(s){throw s.code==null&&(s.code=D.ERR_TRANSPORT_DIAL_FAILED),s}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}transportForMultiaddr(e){for(const t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(e==null||e.length===0){zs("no addresses were provided for listening, this node is dial only");return}const t=[];for(const[n,s]of this.transports.entries()){const i=s.filter(e),o=[];for(const u of i){zs("creating listener for %s on %s",n,u);const l=s.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(n);d==null&&(d=[],this.listeners.set(n,d)),d.push(l),l.addEventListener("listening",()=>{this.dispatchEvent(new Z("listener:listening",{detail:l}))}),l.addEventListener("close",()=>{this.dispatchEvent(new Z("listener:close",{detail:l}))}),o.push(l.listen(u))}if(o.length===0){t.push(n);continue}if((await Pee(o)).find(u=>u.isFulfilled)==null&&this.faultTolerance!==zi.NO_FATAL)throw E(new Error(`Transport (${n}) could not listen on any available address`),D.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const n=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===zi.FATAL_ALL)throw E(new Error(n),D.ERR_NO_VALID_ADDRESSES);zs(`libp2p in dial mode only: ${n}`)}}async remove(e){zs("removing %s",e);for(const t of this.listeners.get(e)??[])await t.close();this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}var zi;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(zi||(zi={}));const Fi="/multistream/1.0.0",Nee=1024,xee=O("libp2p:mss"),Wb=M(`
`);function Z2(r){const e=new Pt(r,Wb);return Dr.single(e)}function la(r,e,t={}){const n=Z2(e);t.writeBytes===!0?r.push(n.subarray()):r.push(n)}function $ee(r,e,t={}){const n=new Pt;for(const s of e)n.append(Z2(s));t.writeBytes===!0?r.push(n.subarray()):r.push(n)}async function Lee(r,e){let t=1;const n={[Symbol.asyncIterator]:()=>n,next:async()=>await r.next(t)};let s=n;e?.signal!=null&&(s=Ps(n,e.signal));const o=await ne(s,Gr({onLength:a=>{t=a},maxDataLength:Nee}),async a=>await fr(a));if(o==null||o.length===0)throw E(new Error("no buffer returned"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==Wb[0])throw xee.error("Invalid mss message - missing newline - %s",o.subarray()),E(new Error("missing newline"),"ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}async function fl(r,e){const t=await Lee(r,e);return q(t.subarray())}const Go=O("libp2p:mss:select");async function Qh(r,e,t={}){e=Array.isArray(e)?[...e]:[e];const{reader:n,writer:s,rest:i,stream:o}=S0(r),a=e.shift();if(a==null)throw new Error("At least one protocol must be specified");Go('select: write ["%s", "%s"]',Fi,a);const c=M(Fi),u=M(a);$ee(s,[c,u],t);let l=await fl(n,t);if(Go('select: read "%s"',l),l===Fi&&(l=await fl(n,t),Go('select: read "%s"',l)),l===a)return i(),{stream:o,protocol:a};for(const d of e){Go('select: write "%s"',d),la(s,M(d),t);const f=await fl(n,t);if(Go('select: read "%s" for "%s"',f,d),f===d)return i(),{stream:o,protocol:d}}throw i(),E(new Error("protocol selection failed"),"ERR_UNSUPPORTED_PROTOCOL")}const Wo=O("libp2p:mss:handle");async function Jh(r,e,t){e=Array.isArray(e)?e:[e];const{writer:n,reader:s,rest:i,stream:o}=S0(r);for(;;){const a=await fl(s,t);if(Wo('read "%s"',a),a===Fi){Wo('respond with "%s" for "%s"',Fi,a),la(n,M(Fi),t);continue}if(e.includes(a))return la(n,M(a),t),Wo('respond with "%s" for "%s"',a,a),i(),{stream:o,protocol:a};if(a==="ls"){la(n,new Pt(...e.map(c=>Z2(M(c)))),t),Wo('respond with "%s" for %s',e,a);continue}la(n,M("na"),t),Wo('respond with "na" for "%s"',a)}}function Mee(r){if(Array.isArray(r)){for(var e=0,t=Array(r.length);e<r.length;e++)t[e]=r[e];return t}else return Array.from(r)}var n4=function(e){var t=void 0,n=void 0;function s(a){if(!(a instanceof Object))throw new Error('Target "'+a+'" is not an object');n=a}function i(a){Object.keys(a).forEach(function(c){var u=a[c];if(typeof u!="function")throw new Error('Trap "'+c+": "+u+'" is not a function');if(!Reflect[c])throw new Error('Trap "'+c+": "+u+'" is not a valid trap')}),t=a}s(function(){}),e&&s(e),i(Reflect);var o=new Proxy({},{get:function(c,u){return function(){for(var l=arguments.length,d=Array(l),f=0;f<l;f++)d[f]=arguments[f];return t[u].apply(null,[n].concat(Mee(d.slice(1))))}}});return{setTarget:s,setHandler:i,getTarget:function(){return n},getHandler:function(){return t},proxy:new Proxy(n,o)}};const Uee=Symbol.for("@libp2p/connection"),Bee=O("libp2p:connection");class zee{constructor(e){const{remoteAddr:t,remotePeer:n,newStream:s,close:i,getStreams:o,stat:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.stat={...a,status:bb},this._newStream=s,this._close=i,this._getStreams=o,this.tags=[],this._closing=!1}get[Symbol.toStringTag](){return"Connection"}get[Uee](){return!0}get streams(){return this._getStreams()}async newStream(e,t){if(this.stat.status===P5)throw E(new Error("the connection is being closed"),"ERR_CONNECTION_BEING_CLOSED");if(this.stat.status===zh)throw E(new Error("the connection is closed"),"ERR_CONNECTION_CLOSED");Array.isArray(e)||(e=[e]);const n=await this._newStream(e,t);return n.stat.direction="outbound",n}addStream(e){e.stat.direction="inbound"}removeStream(e){}async close(){if(!(this.stat.status===zh||this._closing)){this.stat.status=P5;try{this.streams.forEach(e=>e.close())}catch(e){Bee.error(e)}this._closing=!0,await this._close(),this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=zh}}}function Fee(r){return new zee(r)}const s4=O("libp2p:registrar"),Yb=32,Qb=64;class Vee{constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onProtocolChange=this._onProtocolChange.bind(this),this.components.connectionManager.addEventListener("peer:disconnect",this._onDisconnect),this.components.peerStore.addEventListener("change:protocols",this._onProtocolChange)}getProtocols(){return Array.from(new Set([...this.topologies.keys(),...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw E(new Error(`No handler registered for protocol ${e}`),D.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw E(new Error(`Handler already registered for protocol ${e}`),D.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const s=Le.bind({ignoreUndefined:!0})({maxInboundStreams:Yb,maxOutboundStreams:Qb},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.protoBook.add(this.components.peerId,[e])}async unhandle(e){const t=Array.isArray(e)?e:[e];t.forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.protoBook.remove(this.components.peerId,t)}async register(e,t){if(!Wj(t))throw s4.error("topology must be an instance of interfaces/topology"),E(new Error("topology must be an instance of interfaces/topology"),D.ERR_INVALID_PARAMETERS);const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),await t.setRegistrar(this),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then(n=>{for(const s of n){const i=this.topologies.get(s);if(i!=null)for(const o of i.values())o.onDisconnect(t.remotePeer)}}).catch(n=>{s4.error(n)})}_onProtocolChange(e){const{peerId:t,protocols:n,oldProtocols:s}=e.detail,i=s.filter(a=>!n.includes(a)),o=n.filter(a=>!s.includes(a));for(const a of i){const c=this.topologies.get(a);if(c!=null)for(const u of c.values())u.onDisconnect(t)}for(const a of o){const c=this.topologies.get(a);if(c!=null)for(const u of c.values()){const l=this.components.connectionManager.getConnections(t)[0];l!=null&&u.onConnect(t,l)}}}}const _e=O("libp2p:upgrader");function jee(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.code!==D.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return Yb}function Kee(r,e){try{const{options:t}=e.getHandler(r);return t.maxOutboundStreams}catch(t){if(t.code!==D.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return Qb}function i4(r,e,t){let n=0;return t.streams.forEach(s=>{s.stat.direction===e&&s.stat.protocol===r&&n++}),n}class qee extends st{constructor(e,t){super(),this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(n=>{this.connectionEncryption.set(n.protocol,n)}),this.muxers=new Map,t.muxers.forEach(n=>{this.muxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout}async upgradeInbound(e){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw E(new Error("connection denied"),D.ERR_CONNECTION_DENIED);let n,s,i,o,a,c,u;const l=this.components.metrics,d=new $e.TimeoutController(this.inboundUpgradeTimeout);try{Se.setMaxListeners?.(1/0,d.signal)}catch{}try{const f=jr(e,d.signal);if(e.source=f.source,e.sink=f.sink,await this.components.connectionGater.denyInboundConnection(e))throw E(new Error("The multiaddr connection is blocked by gater.acceptConnection"),D.ERR_CONNECTION_INTERCEPTED);if(l!=null){({setTarget:c,proxy:u}=n4());const p=`${(Math.random()*1e9).toString(36)}${Date.now()}`;c({toString:()=>p}),l.trackStream({stream:e,remotePeer:u})}_e("starting the inbound connection upgrade");let g=e;const h=this.components.connectionProtector;h!=null&&(_e("protecting the inbound connection"),g=await h.protect(e));try{if({conn:n,remotePeer:s,protocol:a}=await this._encryptInbound(g),await this.components.connectionGater.denyInboundEncryptedConnection(s,{...g,...n}))throw E(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),D.ERR_CONNECTION_INTERCEPTED);if(this.muxers.size>0){const p=await this._multiplexInbound({...g,...n},this.muxers);o=p.muxerFactory,i=p.stream}else i=n}catch(p){throw _e.error("Failed to upgrade inbound connection",p),p}if(await this.components.connectionGater.denyInboundUpgradedConnection(s,{...g,...n}))throw E(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),D.ERR_CONNECTION_INTERCEPTED);return l!=null&&(l.updatePlaceholder(u,s),c(s)),_e("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:a,direction:"inbound",maConn:e,upgradedConn:i,muxerFactory:o,remotePeer:s})}finally{this.components.connectionManager.afterUpgradeInbound(),d.clear()}}async upgradeOutbound(e,t){const n=e.remoteAddr.getPeerId();if(n==null)throw E(new Error("outbound connection must have a peer id"),D.ERR_INVALID_MULTIADDR);const s=re(n);if(await this.components.connectionGater.denyOutboundConnection(s,e))throw E(new Error("The multiaddr connection is blocked by connectionGater.denyOutboundConnection"),D.ERR_CONNECTION_INTERCEPTED);let i,o,a,c,u,l,d;const f=this.components.metrics;if(f!=null){({setTarget:l,proxy:d}=n4());const h=`${(Math.random()*1e9).toString(36)}${Date.now()}`;l({toB58String:()=>h}),f.trackStream({stream:e,remotePeer:d})}_e("Starting the outbound connection upgrade");let g=e;if(t?.skipProtection!==!0){const h=this.components.connectionProtector;h!=null&&(g=await h.protect(e))}try{if(i=g,t?.skipEncryption!==!0){if({conn:i,remotePeer:o,protocol:c}=await this._encryptOutbound(g,s),await this.components.connectionGater.denyOutboundEncryptedConnection(o,{...g,...i}))throw E(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),D.ERR_CONNECTION_INTERCEPTED)}else c="native",o=s;if(a=i,t?.muxerFactory!=null)u=t.muxerFactory;else if(this.muxers.size>0){const h=await this._multiplexOutbound({...g,...i},this.muxers);u=h.muxerFactory,a=h.stream}}catch(h){throw _e.error("Failed to upgrade outbound connection",h),await e.close(h),h}if(await this.components.connectionGater.denyOutboundUpgradedConnection(o,{...g,...i}))throw E(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),D.ERR_CONNECTION_INTERCEPTED);return f!=null&&(f.updatePlaceholder(d,o),l(o)),_e("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:u,remotePeer:o})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a}=e;let c,u,l;a!=null&&(c=a.createStreamMuxer({direction:n,onIncomingStream:g=>{l!=null&&Promise.resolve().then(async()=>{const h=this.components.registrar.getProtocols(),{stream:p,protocol:w}=await Jh(g,h);_e("%s: incoming stream opened on %s",n,w);const y=this.components.metrics;if(y?.trackStream({stream:p,remotePeer:o,protocol:w}),l==null)return;const _=jee(w,this.components.registrar);if(i4(w,"inbound",l)===_){g.abort(E(new Error(`Too many inbound protocol streams for protocol "${w}" - limit ${_}`),D.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS));return}g.source=p.source,g.sink=p.sink,g.stat.protocol=w,this.components.peerStore.protoBook.add(o,[w]).catch(m=>_e.error(m)),l.addStream(g),this._onStream({connection:l,stream:g,protocol:w})}).catch(h=>{_e.error(h),g.stat.timeline.close==null&&g.close()})},onStreamEnd:g=>{l?.removeStream(g.id)}}),u=async(g,h={})=>{if(c==null)throw E(new Error("Stream is not multiplexed"),D.ERR_MUXER_UNAVAILABLE);_e("%s: starting new stream on %s",n,g);const p=await c.newStream(),w=this.components.metrics;let y;try{if(h.signal==null){_e("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",g),y=new $e.TimeoutController(3e4),h.signal=y.signal;try{Se.setMaxListeners?.(1/0,y.signal)}catch{}}const{stream:_,protocol:b}=await Qh(p,g,h);w?.trackStream({stream:_,remotePeer:o,protocol:b});const m=Kee(b,this.components.registrar);if(i4(b,"outbound",l)===m){const R=E(new Error(`Too many outbound protocol streams for protocol "${b}" - limit ${m}`),D.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw p.abort(R),R}return this.components.peerStore.protoBook.add(o,[b]).catch(R=>_e.error(R)),p.source=_.source,p.sink=_.sink,p.stat.protocol=b,p}catch(_){throw _e.error("could not create new stream",_),p.stat.timeline.close==null&&p.close(),_.code!=null?_:E(_,D.ERR_UNSUPPORTED_PROTOCOL)}finally{y?.clear()}},ne(i,c,i).catch(_e.error));const d=s.timeline;s.timeline=new Proxy(d,{set:(...g)=>(l!=null&&g[1]==="close"&&g[2]!=null&&d.close==null&&(async()=>{try{l.stat.status==="OPEN"&&await l.close()}catch(h){_e.error(h)}finally{this.dispatchEvent(new Z("connectionEnd",{detail:l}))}})().catch(h=>{_e.error(h)}),Reflect.set(...g))}),s.timeline.upgraded=Date.now();const f=()=>{throw E(new Error("connection is not multiplexed"),D.ERR_CONNECTION_NOT_MULTIPLEXED)};return l=Fee({remoteAddr:s.remoteAddr,remotePeer:o,stat:{status:"OPEN",direction:n,timeline:s.timeline,multiplexer:c?.protocol,encryption:t},newStream:u??f,getStreams:()=>c!=null?c.streams:f(),close:async()=>{await s.close(),c?.close()}}),this.dispatchEvent(new Z("connection",{detail:l})),l}_onStream(e){const{connection:t,stream:n,protocol:s}=e,{handler:i}=this.components.registrar.getHandler(s);i({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());_e("handling inbound crypto protocol selection",t);try{const{stream:n,protocol:s}=await Jh(e,t,{writeBytes:!0}),i=this.connectionEncryption.get(s);if(i==null)throw new Error(`no crypto module found for ${s}`);return _e("encrypting inbound connection..."),{...await i.secureInbound(this.components.peerId,n),protocol:s}}catch(n){throw E(n,D.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());_e("selecting outbound crypto protocol",n);try{const{stream:s,protocol:i}=await Qh(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(i);if(o==null)throw new Error(`no crypto module found for ${i}`);return _e("encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,s,t),protocol:i}}catch(s){throw E(s,D.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());_e("outbound selecting muxer %s",n);try{const{stream:s,protocol:i}=await Qh(e,n,{writeBytes:!0});_e("%s selected as muxer protocol",i);const o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw _e.error("error multiplexing outbound stream",s),E(s,D.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());_e("inbound handling muxers %s",n);try{const{stream:s,protocol:i}=await Jh(e,n,{writeBytes:!0}),o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw _e.error("error multiplexing inbound stream",s),E(s,D.ERR_MUXER_UNAVAILABLE)}}}var Pi;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={listenAddrs:[],protocols:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 5:s.protocolVersion=t.string();break;case 6:s.agentVersion=t.string();break;case 1:s.publicKey=t.bytes();break;case 2:s.listenAddrs.push(t.bytes());break;case 4:s.observedAddr=t.bytes();break;case 3:s.protocols.push(t.string());break;case 8:s.signedPeerRecord=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(Pi||(Pi={}));const Jb="0.0.0",Hee="libp2p",Xb=`js-libp2p/${Jb}`,Gee="0.1.0",Wee="id",Yee="id/push",Qee="1.0.0",Jee="1.0.0",be=O("libp2p:identify"),o4=1024*8;class ep{constructor(e,t){this.components=e,this.started=!1,this.init=t,this.identifyProtocolStr=`/${t.protocolPrefix}/${Wee}/${Qee}`,this.identifyPushProtocolStr=`/${t.protocolPrefix}/${Yee}/${Jee}`,this.host={protocolVersion:`${t.protocolPrefix}/${Gee}`,...t.host},this.components.connectionManager.addEventListener("peer:connect",n=>{const s=n.detail;this.identify(s).catch(be.error)}),this.components.peerStore.addEventListener("change:multiaddrs",n=>{const{peerId:s}=n.detail;this.components.peerId.equals(s)&&this.pushToPeerStore().catch(i=>be.error(i))}),this.components.peerStore.addEventListener("change:protocols",n=>{const{peerId:s}=n.detail;this.components.peerId.equals(s)&&this.pushToPeerStore().catch(i=>be.error(i))})}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.metadataBook.setValue(this.components.peerId,"AgentVersion",M(this.host.agentVersion)),await this.components.peerStore.metadataBook.setValue(this.components.peerId,"ProtocolVersion",M(this.host.protocolVersion)),await this.components.registrar.handle(this.identifyProtocolStr,e=>{this._handleIdentify(e).catch(t=>{be.error(t)})},{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),await this.components.registrar.handle(this.identifyPushProtocolStr,e=>{this._handlePush(e).catch(t=>{be.error(t)})},{maxInboundStreams:this.init.maxPushIncomingStreams,maxOutboundStreams:this.init.maxPushOutgoingStreams}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.identifyProtocolStr),await this.components.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async push(e){const t=await this.components.peerStore.addressBook.getRawEnvelope(this.components.peerId),n=this.components.addressManager.getAddresses().map(o=>o.bytes),s=await this.components.peerStore.protoBook.get(this.components.peerId),i=e.map(async o=>{let a;const c=new $e.TimeoutController(this.init.timeout);try{Se.setMaxListeners?.(1/0,c.signal)}catch{}try{a=await o.newStream([this.identifyPushProtocolStr],{signal:c.signal}),await jr(a,c.signal).sink(ne([Pi.encode({listenAddrs:n,signedPeerRecord:t,protocols:s})],Dr()))}catch(u){be.error("could not push identify update to peer",u)}finally{a?.close(),c.clear()}});await Promise.all(i)}async pushToPeerStore(){if(!this.isStarted())return;const e=[];for(const t of this.components.connectionManager.getConnections()){const n=t.remotePeer;(await this.components.peerStore.get(n)).protocols.includes(this.identifyPushProtocolStr)&&e.push(t)}await this.push(e)}async _identify(e,t={}){let n,s=t.signal,i;if(s==null){n=new $e.TimeoutController(this.init.timeout),s=n.signal;try{Se.setMaxListeners?.(1/0,n.signal)}catch{}}try{i=await e.newStream([this.identifyProtocolStr],{signal:s});const o=jr(i,s),a=await ne([],o,Gr({maxDataLength:this.init.maxIdentifyMessageSize??o4}),async c=>await fr(c));if(a==null)throw E(new Error("No data could be retrieved"),D.ERR_CONNECTION_ENDED);try{return Pi.decode(a)}catch(c){throw E(c,D.ERR_INVALID_MESSAGE)}}finally{n?.clear(),i?.close()}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,listenAddrs:i,protocols:o,observedAddr:a,signedPeerRecord:c,agentVersion:u,protocolVersion:l}=n;if(s==null)throw E(new Error("public key was missing from identify message"),D.ERR_MISSING_PUBLIC_KEY);const d=await Sn(s);if(!e.remotePeer.equals(d))throw E(new Error("identified peer does not match the expected peer"),D.ERR_INVALID_PEER);if(this.components.peerId.equals(d))throw E(new Error("identified peer is our own peer id?"),D.ERR_INVALID_PEER);const f=ep.getCleanMultiaddr(a);if(c!=null){be("received signed peer record from %p",d);try{const g=await Yt.openAndCertify(c,Vt.DOMAIN);if(!g.peerId.equals(d))throw E(new Error("identified peer does not match the expected peer"),D.ERR_INVALID_PEER);if(await this.components.peerStore.addressBook.consumePeerRecord(g)){await this.components.peerStore.protoBook.set(d,o),u!=null&&await this.components.peerStore.metadataBook.setValue(d,"AgentVersion",M(u)),l!=null&&await this.components.peerStore.metadataBook.setValue(d,"ProtocolVersion",M(l)),be("identify completed for peer %p and protocols %o",d,o);return}}catch(g){be("received invalid envelope, discard it and fallback to listenAddrs is available",g)}}else be("no signed peer record received from %p",d);be("falling back to legacy addresses from %p",d);try{await this.components.peerStore.addressBook.set(d,i.map(g=>X(g)))}catch(g){be.error("received invalid addrs",g)}await this.components.peerStore.protoBook.set(d,o),u!=null&&await this.components.peerStore.metadataBook.setValue(d,"AgentVersion",M(u)),l!=null&&await this.components.peerStore.metadataBook.setValue(d,"ProtocolVersion",M(l)),be("identify completed for peer %p and protocols %o",d,o),be("received observed address of %s",f?.toString())}async _handleIdentify(e){const{connection:t,stream:n}=e,s=new $e.TimeoutController(this.init.timeout);try{Se.setMaxListeners?.(1/0,s.signal)}catch{}try{const i=this.components.peerId.publicKey??new Uint8Array(0),o=await this.components.peerStore.get(this.components.peerId),a=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(od("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const f=new Vt({peerId:this.components.peerId,multiaddrs:a}),g=await Yt.seal(f,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(g),c=g.marshal().subarray()}const u=Pi.encode({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:i,listenAddrs:a.map(f=>f.bytes),signedPeerRecord:c,observedAddr:t.remoteAddr.bytes,protocols:o.protocols}),l=jr(n,s.signal),d=ne([u],Dr());await l.sink(d)}catch(i){be.error("could not respond to identify request",i)}finally{n.close(),s.clear()}}async _handlePush(e){const{connection:t,stream:n}=e,s=new $e.TimeoutController(this.init.timeout);try{Se.setMaxListeners?.(1/0,s.signal)}catch{}let i;try{const a=jr(n,s.signal),c=await ne([],a,Gr({maxDataLength:this.init.maxIdentifyMessageSize??o4}),async u=>await fr(u));c!=null&&(i=Pi.decode(c))}catch(a){return be.error("received invalid message",a)}finally{n.close(),s.clear()}if(i==null)return be.error("received invalid message");const o=t.remotePeer;if(this.components.peerId.equals(o)){be("received push from ourselves?");return}if(be("received push from %p",o),i.signedPeerRecord!=null){be("received signedPeerRecord in push");try{const a=await Yt.openAndCertify(i.signedPeerRecord,Vt.DOMAIN);if(await this.components.peerStore.addressBook.consumePeerRecord(a)){be("consumed signedPeerRecord sent in push"),await this.components.peerStore.protoBook.set(o,i.protocols);return}else be("failed to consume signedPeerRecord sent in push")}catch(a){be("received invalid envelope, discard it and fallback to listenAddrs is available",a)}}else be("did not receive signedPeerRecord in push");try{await this.components.peerStore.addressBook.set(o,i.listenAddrs.map(a=>X(a)))}catch(a){be.error("received invalid addrs",a)}try{await this.components.peerStore.protoBook.set(o,i.protocols)}catch(a){be.error("received invalid protocols",a)}be("handled push from %p",o)}static getCleanMultiaddr(e){if(e!=null&&e.length>0)try{return X(e)}catch{}}}var Ku;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.identifier!=="")&&(n.uint32(10),n.string(t.identifier)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={identifier:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.identifier=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(Ku||(Ku={}));var Lr;(function(r){let e;(function(s){s.OK="OK",s.NOT_FOUND="NOT_FOUND",s.ERROR="ERROR"})(e=r.StatusCode||(r.StatusCode={}));let t;(function(s){s[s.OK=0]="OK",s[s.NOT_FOUND=1]="NOT_FOUND",s[s.ERROR=2]="ERROR"})(t||(t={})),function(s){s.codec=()=>ji(t)}(e=r.StatusCode||(r.StatusCode={}));let n;r.codec=()=>(n==null&&(n=tt((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),(o.writeDefaults===!0||s.status!=null&&t[s.status]!==0)&&(i.uint32(8),r.StatusCode.codec().encode(s.status,i)),(o.writeDefaults===!0||s.data!=null&&s.data.byteLength>0)&&(i.uint32(18),i.bytes(s.data)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={status:e.OK,data:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.status=r.StatusCode.codec().decode(s);break;case 2:o.data=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>rt(s,r.codec()),r.decode=s=>nt(s,r.codec())})(Lr||(Lr={}));const Xee="0.0.1",Zee="fetch",a4=O("libp2p:fetch");class ete{constructor(e,t){this.started=!1,this.components=e,this.protocol=`/${t.protocolPrefix??"libp2p"}/${Zee}/${Xee}`,this.lookupFunctions=new Map,this.handleMessage=this.handleMessage.bind(this),this.init=t}async start(){await this.components.registrar.handle(this.protocol,e=>{this.handleMessage(e).catch(t=>{a4.error(t)}).finally(()=>{e.stream.close()})},{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async fetch(e,t,n={}){a4("dialing %s to %p",this.protocol,e);const s=await this.components.connectionManager.openConnection(e,n);let i,o=n.signal,a;if(o==null){i=new $e.TimeoutController(this.init.timeout),o=i.signal;try{Se.setMaxListeners?.(1/0,i.signal)}catch{}}try{a=await s.newStream([this.protocol],{signal:o});const c=jr(a,o);return await ne([Ku.encode({identifier:t})],Dr(),c,Gr(),async function(l){const d=await fr(l);if(d==null)throw E(new Error("No data received"),D.ERR_INVALID_MESSAGE);const f=Lr.decode(d);switch(f.status){case Lr.StatusCode.OK:return f.data;case Lr.StatusCode.NOT_FOUND:return null;case Lr.StatusCode.ERROR:{const g=new TextDecoder().decode(f.data);throw E(new Error("Error in fetch protocol response: "+g),D.ERR_INVALID_PARAMETERS)}default:throw E(new Error("Unknown response status"),D.ERR_INVALID_MESSAGE)}})??null}finally{i?.clear(),a?.close()}}async handleMessage(e){const{stream:t}=e,n=this;await ne(t,Gr(),async function*(s){const i=await fr(s);if(i==null)throw E(new Error("No data received"),D.ERR_INVALID_MESSAGE);const o=Ku.decode(i);let a;const c=n._getLookupFunction(o.identifier);if(c!=null){const u=await c(o.identifier);u!=null?a={status:Lr.StatusCode.OK,data:u}:a={status:Lr.StatusCode.NOT_FOUND,data:new Uint8Array(0)}}else{const u=new TextEncoder().encode("No lookup function registered for key: "+o.identifier);a={status:Lr.StatusCode.ERROR,data:u}}yield Lr.encode(a)},Dr(),t)}_getLookupFunction(e){for(const t of this.lookupFunctions.keys())if(e.startsWith(t))return this.lookupFunctions.get(t)}registerLookupFunction(e,t){if(this.lookupFunctions.has(e))throw E(new Error("Fetch protocol handler for key prefix '"+e+"' already registered"),D.ERR_KEY_ALREADY_EXISTS);this.lookupFunctions.set(e,t)}unregisterLookupFunction(e,t){t!=null&&this.lookupFunctions.get(e)!==t||this.lookupFunctions.delete(e)}}const tte=32,rte="1.0.0",nte="ping",c4=O("libp2p:ping");class ste{constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix}/${nte}/${rte}`,this.init=t}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const{stream:t}=e;ne(t,t).catch(n=>{c4.error(n)})}async ping(e,t={}){c4("dialing %s to %p",this.protocol,e);const n=Date.now(),s=id(tte),i=await this.components.connectionManager.openConnection(e,t);let o,a=t.signal,c;if(a==null){o=new $e.TimeoutController(this.init.timeout),a=o.signal;try{Se.setMaxListeners?.(1/0,o.signal)}catch{}}try{c=await i.newStream([this.protocol],{signal:a});const u=jr(c,a),l=await ne([s],u,async f=>await fr(f)),d=Date.now();if(l==null||!Dt(s,l.subarray()))throw E(new Error("Received wrong ping ack"),D.ERR_WRONG_PING_ACK);return d-n}finally{o?.clear(),c?.close()}}}async function ite(){throw new Error("Not supported in browsers")}var tp={};const l4="[a-fA-F\\d:]",Es=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${l4})|(?<=${l4})(?=\\s|$))`:"",Sr="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Ge="[a-fA-F\\d]{1,4}",Md=`
(?:
(?:${Ge}:){7}(?:${Ge}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Ge}:){6}(?:${Sr}|:${Ge}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Ge}:){5}(?::${Sr}|(?::${Ge}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Ge}:){4}(?:(?::${Ge}){0,1}:${Sr}|(?::${Ge}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Ge}:){3}(?:(?::${Ge}){0,2}:${Sr}|(?::${Ge}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Ge}:){2}(?:(?::${Ge}){0,3}:${Sr}|(?::${Ge}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Ge}:){1}(?:(?::${Ge}){0,4}:${Sr}|(?::${Ge}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Ge}){0,5}:${Sr}|(?::${Ge}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),ote=new RegExp(`(?:^${Sr}$)|(?:^${Md}$)`),ate=new RegExp(`^${Sr}$`),cte=new RegExp(`^${Md}$`),rp=r=>r&&r.exact?ote:new RegExp(`(?:${Es(r)}${Sr}${Es(r)})|(?:${Es(r)}${Md}${Es(r)})`,"g");rp.v4=r=>r&&r.exact?ate:new RegExp(`${Es(r)}${Sr}${Es(r)}`,"g");rp.v6=r=>r&&r.exact?cte:new RegExp(`${Es(r)}${Md}${Es(r)}`,"g");var lte=rp;const u4="[a-fA-F\\d:]",_s=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${u4})|(?<=${u4})(?=\\s|$))`:"",Rr="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",We="[a-fA-F\\d]{1,4}",Ud=`
(?:
(?:${We}:){7}(?:${We}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${We}:){6}(?:${Rr}|:${We}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${We}:){5}(?::${Rr}|(?::${We}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${We}:){4}(?:(?::${We}){0,1}:${Rr}|(?::${We}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${We}:){3}(?:(?::${We}){0,2}:${Rr}|(?::${We}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${We}:){2}(?:(?::${We}){0,3}:${Rr}|(?::${We}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${We}:){1}(?:(?::${We}){0,4}:${Rr}|(?::${We}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${We}){0,5}:${Rr}|(?::${We}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),ute=new RegExp(`(?:^${Rr}$)|(?:^${Ud}$)`),dte=new RegExp(`^${Rr}$`),hte=new RegExp(`^${Ud}$`),np=r=>r&&r.exact?ute:new RegExp(`(?:${_s(r)}${Rr}${_s(r)})|(?:${_s(r)}${Ud}${_s(r)})`,"g");np.v4=r=>r&&r.exact?dte:new RegExp(`${_s(r)}${Rr}${_s(r)}`,"g");np.v6=r=>r&&r.exact?hte:new RegExp(`${_s(r)}${Ud}${_s(r)}`,"g");var fte=np;const sp=fte,Vi=r=>sp({exact:!0}).test(r);Vi.v4=r=>sp.v4({exact:!0}).test(r);Vi.v6=r=>sp.v6({exact:!0}).test(r);Vi.version=r=>Vi(r)?Vi.v4(r)?4:6:void 0;var pte=Vi,Zb=or&&or.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(tp,"__esModule",{value:!0});const gte=hl,yte=Zb(lte),wte=Zb(pte),d4=Fu,mte=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],bte=mte.map(r=>new gte.Netmask(r));function Ete(r){for(let e of bte)if(e.contains(r))return!0;return!1}function h4(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}tp.default=r=>{if((0,d4.isValid)(r)){const e=(0,d4.parse)(r);if(e.kind()==="ipv4")return Ete(e.toNormalizedString());if(e.kind()==="ipv6")return h4(r)}else if((0,wte.default)(r)&&yte.default.v6().test(r))return h4(r)};var ip=tp.default;function _te(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function vte(r){const{address:e}=r.nodeAddress();return _te(e)}const Xh=O("libp2p:nat"),Zh=7200;function Ste(r=1024,e=65535){return Math.floor(Math.random()*(e-r+1)+r)}class Rte{constructor(e,t){if(this.components=e,this.started=!1,this.enabled=t.enabled,this.externalAddress=t.externalAddress,this.localAddress=t.localAddress,this.description=t.description??`${Hee}@${Jb} ${this.components.peerId.toString()}`,this.ttl=t.ttl??Zh,this.keepAlive=t.keepAlive??!0,this.gateway=t.gateway,this.ttl<Zh)throw E(new Error(`NatManager ttl should be at least ${Zh} seconds`),D.ERR_INVALID_PARAMETERS)}isStarted(){return this.started}start(){}afterStart(){hf||!this.enabled||this.started||(this.started=!0,this._start().catch(e=>{Xh.error(e)}))}async _start(){const e=this.components.transportManager.getAddrs();for(const t of e){const{family:n,host:s,port:i,transport:o}=t.toOptions();if(!t.isThinWaistAddress()||o!=="tcp"||vte(t)||n!==4)continue;const a=await this._getClient(),c=this.externalAddress??await a.externalIp();if(ip(c))throw new Error(`${c} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`);const u=Ste();Xh(`opening uPnP connection from ${c}:${u} to ${s}:${i}`),await a.map({publicPort:u,localPort:i,localAddress:this.localAddress,protocol:o.toUpperCase()==="TCP"?"TCP":"UDP"}),this.components.addressManager.addObservedAddr(cE({family:4,address:c,port:u},o))}}async _getClient(){return this.client!=null?this.client:(this.client=await ite({description:this.description,ttl:this.ttl,keepAlive:this.keepAlive,gateway:this.gateway}),this.client)}async stop(){if(!(hf||this.client==null))try{await this.client.close(),this.client=void 0}catch(e){Xh.error(e)}}}const Ite=O("libp2p:peer-record-updater");class Ate{constructor(e){this.components=e,this.started=!1,this.update=this.update.bind(this)}isStarted(){return this.started}async start(){this.started=!0,this.components.transportManager.addEventListener("listener:listening",this.update),this.components.transportManager.addEventListener("listener:close",this.update),this.components.addressManager.addEventListener("change:addresses",this.update)}async stop(){this.started=!1,this.components.transportManager.removeEventListener("listener:listening",this.update),this.components.transportManager.removeEventListener("listener:close",this.update),this.components.addressManager.removeEventListener("change:addresses",this.update)}update(){Promise.resolve().then(async()=>{const e=new Vt({peerId:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(n=>n.decapsulateCode(od("p2p").code))}),t=await Yt.seal(e,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(t)}).catch(e=>{Ite.error("Could not update self peer record: %o",e)})}}class Cte{constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw E(new Error(pe.NOT_FOUND),D.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const ce={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS",ERR_NOT_FOUND:"ERR_NOT_FOUND"},me=O("libp2p:peer-store:address-book"),Fc="change:multiaddrs";async function Tte(){return!0}class Dte{constructor(e,t,n){this.dispatchEvent=e,this.store=t,this.addressFilter=n??Tte}async consumePeerRecord(e){me.trace("consumePeerRecord await write lock");const t=await this.store.lock.writeLock();me.trace("consumePeerRecord got write lock");let n,s,i;try{let o;try{o=Vt.createFromProtobuf(e.payload)}catch{return me.error("invalid peer record received"),!1}n=o.peerId;const a=o.multiaddrs;if(!n.equals(e.peerId))return me("signing key does not match PeerId in the PeerRecord"),!1;if(a==null||a.length===0)return!1;if(await this.store.has(n)&&(s=await this.store.load(n),s.peerRecordEnvelope!=null)){const u=await Yt.createFromProtobuf(s.peerRecordEnvelope),l=Vt.createFromProtobuf(u.payload);if(l.seqNumber>=o.seqNumber)return me("sequence number was lower or equal to existing sequence number - stored: %d received: %d",l.seqNumber,o.seqNumber),!1}const c=await ef(n,a,this.addressFilter,!0);i=await this.store.patchOrCreate(n,{addresses:c,peerRecordEnvelope:e.marshal().subarray()}),me("stored provided peer record for %p",o.peerId)}finally{me.trace("consumePeerRecord release write lock"),t()}return this.dispatchEvent(new Z(Fc,{detail:{peerId:n,multiaddrs:i.addresses.map(({multiaddr:o})=>o),oldMultiaddrs:s==null?[]:s.addresses.map(({multiaddr:o})=>o)}})),!0}async getRawEnvelope(e){me.trace("getRawEnvelope await read lock");const t=await this.store.lock.readLock();me.trace("getRawEnvelope got read lock");try{return(await this.store.load(e)).peerRecordEnvelope}catch(n){if(n.code!==ce.ERR_NOT_FOUND)throw n}finally{me.trace("getRawEnvelope release read lock"),t()}}async getPeerRecord(e){const t=await this.getRawEnvelope(e);if(t!=null)return await Yt.createFromProtobuf(t)}async get(e){e=bt(e),me.trace("get wait for read lock");const t=await this.store.lock.readLock();me.trace("get got read lock");try{return(await this.store.load(e)).addresses}catch(n){if(n.code!==ce.ERR_NOT_FOUND)throw n}finally{me.trace("get release read lock"),t()}return[]}async set(e,t){if(e=bt(e),!Array.isArray(t))throw me.error("multiaddrs must be an array of Multiaddrs"),E(new Error("multiaddrs must be an array of Multiaddrs"),ce.ERR_INVALID_PARAMETERS);me.trace("set await write lock");const n=await this.store.lock.writeLock();me.trace("set got write lock");let s=!1,i,o;try{const a=await ef(e,t,this.addressFilter);if(a.length===0)return;try{if(i=await this.store.load(e),s=!0,new Set([...a.map(({multiaddr:c})=>c.toString()),...i.addresses.map(({multiaddr:c})=>c.toString())]).size===i.addresses.length&&a.length===i.addresses.length)return}catch(c){if(c.code!==ce.ERR_NOT_FOUND)throw c}o=await this.store.patchOrCreate(e,{addresses:a}),me("set multiaddrs for %p",e)}finally{me.trace("set multiaddrs for %p",e),me("set release write lock"),n()}this.dispatchEvent(new Z(Fc,{detail:{peerId:e,multiaddrs:o.addresses.map(a=>a.multiaddr),oldMultiaddrs:i==null?[]:i.addresses.map(({multiaddr:a})=>a)}})),s||this.dispatchEvent(new Z("peer",{detail:{id:e,multiaddrs:o.addresses.map(a=>a.multiaddr),protocols:o.protocols}}))}async add(e,t){if(e=bt(e),!Array.isArray(t))throw me.error("multiaddrs must be an array of Multiaddrs"),E(new Error("multiaddrs must be an array of Multiaddrs"),ce.ERR_INVALID_PARAMETERS);me.trace("add await write lock");const n=await this.store.lock.writeLock();me.trace("add got write lock");let s,i,o;try{const a=await ef(e,t,this.addressFilter);if(a.length===0)return;try{if(i=await this.store.load(e),s=!0,new Set([...a.map(({multiaddr:c})=>c.toString()),...i.addresses.map(({multiaddr:c})=>c.toString())]).size===i.addresses.length)return}catch(c){if(c.code!==ce.ERR_NOT_FOUND)throw c}o=await this.store.mergeOrCreate(e,{addresses:a}),me("added multiaddrs for %p",e)}finally{me.trace("set release write lock"),n()}this.dispatchEvent(new Z(Fc,{detail:{peerId:e,multiaddrs:o.addresses.map(a=>a.multiaddr),oldMultiaddrs:i==null?[]:i.addresses.map(({multiaddr:a})=>a)}})),s===!0&&this.dispatchEvent(new Z("peer",{detail:{id:e,multiaddrs:o.addresses.map(a=>a.multiaddr),protocols:o.protocols}}))}async delete(e){e=bt(e),me.trace("delete await write lock");const t=await this.store.lock.writeLock();me.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{addresses:[]})}finally{me.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new Z(Fc,{detail:{peerId:e,multiaddrs:[],oldMultiaddrs:n==null?[]:n.addresses.map(({multiaddr:s})=>s)}}))}}async function ef(r,e,t,n=!1){return await ne(e,s=>n0(s,i=>{if(!wl(i))throw me.error("multiaddr must be an instance of Multiaddr"),E(new Error("multiaddr must be an instance of Multiaddr"),ce.ERR_INVALID_PARAMETERS)}),s=>Ze(s,async i=>await t(r,i)),s=>_t(s,i=>({multiaddr:i,isCertified:n})),async s=>await Dn(s))}const Nr=O("libp2p:peer-store:key-book"),f4="change:pubkey";class Pte{constructor(e,t){this.dispatchEvent=e,this.store=t}async set(e,t){if(e=bt(e),!(t instanceof Uint8Array))throw Nr.error("publicKey must be an instance of Uint8Array to store data"),E(new Error("publicKey must be an instance of PublicKey"),ce.ERR_INVALID_PARAMETERS);Nr.trace("set await write lock");const n=await this.store.lock.writeLock();Nr.trace("set got write lock");let s=!1,i;try{try{if(i=await this.store.load(e),i.pubKey!=null&&Dt(i.pubKey,t))return}catch(o){if(o.code!==ce.ERR_NOT_FOUND)throw o}await this.store.patchOrCreate(e,{pubKey:t}),s=!0}finally{Nr.trace("set release write lock"),n()}s&&this.dispatchEvent(new Z(f4,{detail:{peerId:e,publicKey:t,oldPublicKey:i?.pubKey}}))}async get(e){e=bt(e),Nr.trace("get await write lock");const t=await this.store.lock.readLock();Nr.trace("get got write lock");try{return(await this.store.load(e)).pubKey}catch(n){if(n.code!==ce.ERR_NOT_FOUND)throw n}finally{Nr("get release write lock"),t()}}async delete(e){e=bt(e),Nr.trace("delete await write lock");const t=await this.store.lock.writeLock();Nr.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{pubKey:void 0})}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s}finally{Nr.trace("delete release write lock"),t()}this.dispatchEvent(new Z(f4,{detail:{peerId:e,publicKey:void 0,oldPublicKey:n?.pubKey}}))}}const Ye=O("libp2p:peer-store:metadata-book"),Vc="change:metadata";class kte{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){e=bt(e),Ye.trace("get await read lock");const t=await this.store.lock.readLock();Ye.trace("get got read lock");try{return(await this.store.load(e)).metadata}catch(n){if(n.code!==ce.ERR_NOT_FOUND)throw n}finally{Ye.trace("get release read lock"),t()}return new Map}async getValue(e,t){e=bt(e),Ye.trace("getValue await read lock");const n=await this.store.lock.readLock();Ye.trace("getValue got read lock");try{return(await this.store.load(e)).metadata.get(t)}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s}finally{Ye.trace("getValue release write lock"),n()}}async set(e,t){if(e=bt(e),!(t instanceof Map))throw Ye.error("valid metadata must be provided to store data"),E(new Error("valid metadata must be provided"),ce.ERR_INVALID_PARAMETERS);Ye.trace("set await write lock");const n=await this.store.lock.writeLock();Ye.trace("set got write lock");let s;try{try{s=await this.store.load(e)}catch(i){if(i.code!==ce.ERR_NOT_FOUND)throw i}await this.store.mergeOrCreate(e,{metadata:t})}finally{Ye.trace("set release write lock"),n()}this.dispatchEvent(new Z(Vc,{detail:{peerId:e,metadata:t,oldMetadata:s==null?new Map:s.metadata}}))}async setValue(e,t,n){if(e=bt(e),typeof t!="string"||!(n instanceof Uint8Array))throw Ye.error("valid key and value must be provided to store data"),E(new Error("valid key and value must be provided"),ce.ERR_INVALID_PARAMETERS);Ye.trace("setValue await write lock");const s=await this.store.lock.writeLock();Ye.trace("setValue got write lock");let i,o;try{try{i=await this.store.load(e);const a=i.metadata.get(t);if(a!=null&&Dt(n,a))return}catch(a){if(a.code!==ce.ERR_NOT_FOUND)throw a}o=await this.store.mergeOrCreate(e,{metadata:new Map([[t,n]])})}finally{Ye.trace("setValue release write lock"),s()}this.dispatchEvent(new Z(Vc,{detail:{peerId:e,metadata:o.metadata,oldMetadata:i==null?new Map:i.metadata}}))}async delete(e){e=bt(e),Ye.trace("delete await write lock");const t=await this.store.lock.writeLock();Ye.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s}n!=null&&await this.store.patch(e,{metadata:new Map})}finally{Ye.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new Z(Vc,{detail:{peerId:e,metadata:new Map,oldMetadata:n.metadata}}))}async deleteValue(e,t){e=bt(e),Ye.trace("deleteValue await write lock");const n=await this.store.lock.writeLock();Ye.trace("deleteValue got write lock");let s,i;try{i=await this.store.load(e),s=i.metadata,s.delete(t),await this.store.patch(e,{metadata:s})}catch(o){if(o.code!==ce.ERR_NOT_FOUND)throw o}finally{Ye.trace("deleteValue release write lock"),n()}s!=null&&this.dispatchEvent(new Z(Vc,{detail:{peerId:e,metadata:s,oldMetadata:i==null?new Map:i.metadata}}))}}const Qe=O("libp2p:peer-store:proto-book"),jc="change:protocols";class Ote{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){Qe.trace("get wait for read lock");const t=await this.store.lock.readLock();Qe.trace("get got read lock");try{return(await this.store.load(e)).protocols}catch(n){if(n.code!==ce.ERR_NOT_FOUND)throw n}finally{Qe.trace("get release read lock"),t()}return[]}async set(e,t){if(e=bt(e),!Array.isArray(t))throw Qe.error("protocols must be provided to store data"),E(new Error("protocols must be provided"),ce.ERR_INVALID_PARAMETERS);Qe.trace("set await write lock");const n=await this.store.lock.writeLock();Qe.trace("set got write lock");let s,i;try{try{if(s=await this.store.load(e),new Set([...t]).size===s.protocols.length)return}catch(o){if(o.code!==ce.ERR_NOT_FOUND)throw o}i=await this.store.patchOrCreate(e,{protocols:t}),Qe("stored provided protocols for %p",e)}finally{Qe.trace("set release write lock"),n()}this.dispatchEvent(new Z(jc,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async add(e,t){if(e=bt(e),!Array.isArray(t))throw Qe.error("protocols must be provided to store data"),E(new Error("protocols must be provided"),ce.ERR_INVALID_PARAMETERS);Qe.trace("add await write lock");const n=await this.store.lock.writeLock();Qe.trace("add got write lock");let s,i;try{try{if(s=await this.store.load(e),new Set([...s.protocols,...t]).size===s.protocols.length)return}catch(o){if(o.code!==ce.ERR_NOT_FOUND)throw o}i=await this.store.mergeOrCreate(e,{protocols:t}),Qe("added provided protocols for %p",e)}finally{Qe.trace("add release write lock"),n()}this.dispatchEvent(new Z(jc,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async remove(e,t){if(e=bt(e),!Array.isArray(t))throw Qe.error("protocols must be provided to store data"),E(new Error("protocols must be provided"),ce.ERR_INVALID_PARAMETERS);Qe.trace("remove await write lock");const n=await this.store.lock.writeLock();Qe.trace("remove got write lock");let s,i;try{try{s=await this.store.load(e);const o=new Set(s.protocols);for(const a of t)o.delete(a);if(s.protocols.length===o.size)return;t=Array.from(o)}catch(o){if(o.code!==ce.ERR_NOT_FOUND)throw o}i=await this.store.patchOrCreate(e,{protocols:t})}finally{Qe.trace("remove release write lock"),n()}this.dispatchEvent(new Z(jc,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async delete(e){e=bt(e),Qe.trace("delete await write lock");const t=await this.store.lock.writeLock();Qe.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{protocols:[]})}finally{Qe.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new Z(jc,{detail:{peerId:e,protocols:[],oldProtocols:n.protocols}}))}}let Nte=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},xte=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return e9(this,e)}},$te=class{constructor(e){this.decoders=e}or(e){return e9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const e9=(r,e)=>new $te({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Lte=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Nte(e,t,n),this.decoder=new xte(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Mte=({name:r,prefix:e,encode:t,decode:n})=>new Lte(r,e,t,n),Ute=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Bte=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},zn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Mte({prefix:e,name:r,encode(s){return Bte(s,n,t)},decode(s){return Ute(s,n,t,r)}}),zte=zn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});zn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});zn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});zn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});zn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});zn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});zn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});zn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});zn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var qu;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),Hu.codec().encode(i,n,{writeDefaults:!0});if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.metadata!=null)for(const i of t.metadata)n.uint32(26),Gu.codec().encode(i,n,{writeDefaults:!0});t.pubKey!=null&&(n.uint32(34),n.bytes(t.pubKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={addresses:[],protocols:[],metadata:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.addresses.push(Hu.codec().decode(t,t.uint32()));break;case 2:s.protocols.push(t.string());break;case 3:s.metadata.push(Gu.codec().decode(t,t.uint32()));break;case 4:s.pubKey=t.bytes();break;case 5:s.peerRecordEnvelope=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(qu||(qu={}));var Hu;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.multiaddr!=null&&t.multiaddr.byteLength>0)&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={multiaddr:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.multiaddr=t.bytes();break;case 2:s.isCertified=t.bool();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(Hu||(Hu={}));var Gu;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.key!=="")&&(n.uint32(10),n.string(t.key)),(s.writeDefaults===!0||t.value!=null&&t.value.byteLength>0)&&(n.uint32(18),n.bytes(t.value)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={key:"",value:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.string();break;case 2:s.value=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(Gu||(Gu={}));const p4=O("libp2p:peer-store:store"),g4="/peers/";class Fte{constructor(e){this.components=e,this.lock=w2({name:"peer-store",singleProcess:!0})}_peerIdToDatastoreKey(e){if(e.type==null)throw p4.error("peerId must be an instance of peer-id to store data"),E(new Error("peerId must be an instance of peer-id"),ce.ERR_INVALID_PARAMETERS);const t=e.toCID().toString();return new J(`${g4}${t}`)}async has(e){return await this.components.datastore.has(this._peerIdToDatastoreKey(e))}async delete(e){await this.components.datastore.delete(this._peerIdToDatastoreKey(e))}async load(e){const t=await this.components.datastore.get(this._peerIdToDatastoreKey(e)),n=qu.decode(t),s=new Map;for(const i of n.metadata)s.set(i.key,i.value);return{...n,id:e,addresses:n.addresses.map(({multiaddr:i,isCertified:o})=>({multiaddr:X(i),isCertified:o??!1})),metadata:s,pubKey:n.pubKey??void 0,peerRecordEnvelope:n.peerRecordEnvelope??void 0}}async save(e){if(e.pubKey!=null&&e.id.publicKey!=null&&!Dt(e.pubKey,e.id.publicKey))throw p4.error("peer publicKey bytes do not match peer id publicKey bytes"),E(new Error("publicKey bytes do not match peer id publicKey bytes"),ce.ERR_INVALID_PARAMETERS);const t=new Set,n=e.addresses.filter(o=>t.has(o.multiaddr.toString())?!1:(t.add(o.multiaddr.toString()),!0)).sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({multiaddr:o,isCertified:a})=>({multiaddr:o.bytes,isCertified:a})),s=[];[...e.metadata.keys()].sort().forEach(o=>{const a=e.metadata.get(o);a!=null&&s.push({key:o,value:a})});const i=qu.encode({addresses:n,protocols:e.protocols.sort(),pubKey:e.pubKey,metadata:s,peerRecordEnvelope:e.peerRecordEnvelope});return await this.components.datastore.put(this._peerIdToDatastoreKey(e.id),i.subarray()),await this.load(e.id)}async patch(e,t){const n=await this.load(e);return await this._patch(e,t,n)}async patchOrCreate(e,t){let n;try{n=await this.load(e)}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._patch(e,t,n)}async _patch(e,t,n){return await this.save({...n,...t,id:e})}async merge(e,t){const n=await this.load(e);return await this._merge(e,t,n)}async mergeOrCreate(e,t){let n;try{n=await this.load(e)}catch(s){if(s.code!==ce.ERR_NOT_FOUND)throw s;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._merge(e,t,n)}async _merge(e,t,n){const s=new Map;return n.addresses.forEach(i=>{s.set(i.multiaddr.toString(),i.isCertified)}),(t.addresses??[]).forEach(i=>{const o=i.multiaddr.toString(),c=Boolean(s.get(o))||i.isCertified;s.set(o,c)}),await this.save({id:e,addresses:Array.from(s.entries()).map(([i,o])=>({multiaddr:X(i),isCertified:o})),protocols:Array.from(new Set([...n.protocols??[],...t.protocols??[]])),metadata:new Map([...n.metadata?.entries()??[],...t.metadata?.entries()??[]]),pubKey:t.pubKey??n?.pubKey,peerRecordEnvelope:t.peerRecordEnvelope??n?.peerRecordEnvelope})}async*all(){for await(const e of this.components.datastore.queryKeys({prefix:g4})){const t=e.toString().split("/")[2],n=zte.decode(t);yield this.load(Xr(n))}}}var ds;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.tags!=null)for(const i of t.tags)n.uint32(10),Wu.codec().encode(i,n,{writeDefaults:!0});s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={tags:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.tags.push(Wu.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(ds||(ds={}));var Wu;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.name!=="")&&(n.uint32(10),n.string(t.name)),t.value!=null&&(n.uint32(16),n.uint32(t.value)),t.expiry!=null&&(n.uint32(24),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={name:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.name=t.string();break;case 2:s.value=t.uint32();break;case 3:s.expiry=t.uint64();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(Wu||(Wu={}));const sr=O("libp2p:peer-store");class Vte extends st{constructor(e,t={}){super(),this.components=e,this.store=new Fte(e),this.addressBook=new Dte(this.dispatchEvent.bind(this),this.store,t.addressFilter),this.keyBook=new Pte(this.dispatchEvent.bind(this),this.store),this.metadataBook=new kte(this.dispatchEvent.bind(this),this.store),this.protoBook=new Ote(this.dispatchEvent.bind(this),this.store)}async forEach(e){sr.trace("getPeers await read lock");const t=await this.store.lock.readLock();sr.trace("getPeers got read lock");try{for await(const n of this.store.all())n.id.equals(this.components.peerId)||e(n)}finally{sr.trace("getPeers release read lock"),t()}}async all(){const e=[];return await this.forEach(t=>{e.push(t)}),e}async delete(e){sr.trace("delete await write lock");const t=await this.store.lock.writeLock();sr.trace("delete got write lock");try{await this.store.delete(e)}finally{sr.trace("delete release write lock"),t()}}async get(e){sr.trace("get await read lock");const t=await this.store.lock.readLock();sr.trace("get got read lock");try{return await this.store.load(e)}finally{sr.trace("get release read lock"),t()}}async has(e){sr.trace("has await read lock");const t=await this.store.lock.readLock();sr.trace("has got read lock");try{return await this.store.has(e)}finally{sr.trace("has release read lock"),t()}}async tagPeer(e,t,n={}){const s=n.value??0,i=Math.round(s),o=n.ttl??void 0;if(i!==s||i<0||i>100)throw E(new Error("Tag value must be between 0-100"),"ERR_TAG_VALUE_OUT_OF_BOUNDS");const a=await this.metadataBook.getValue(e,"tags");let c=[];a!=null&&(c=ds.decode(a).tags);for(const u of c)if(u.name===t)throw E(new Error("Peer already tagged"),"ERR_DUPLICATE_TAG");c.push({name:t,value:i,expiry:o==null?void 0:BigInt(Date.now()+o)}),await this.metadataBook.setValue(e,"tags",ds.encode({tags:c}).subarray())}async unTagPeer(e,t){const n=await this.metadataBook.getValue(e,"tags");let s=[];n!=null&&(s=ds.decode(n).tags),s=s.filter(i=>i.name!==t),await this.metadataBook.setValue(e,"tags",ds.encode({tags:s}).subarray())}async getTags(e){const t=await this.metadataBook.getValue(e,"tags");let n=[];t!=null&&(n=ds.decode(t).tags);const s=BigInt(Date.now()),i=n.filter(o=>o.expiry==null||o.expiry>s);return i.length!==n.length&&await this.metadataBook.setValue(e,"tags",ds.encode({tags:i}).subarray()),i.map(o=>({name:o.name,value:o.value??0}))}}class jte{constructor(e){this.dht=e}async provide(e){await Et(this.dht.provide(e))}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Et(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw E(new Error("Not found"),"ERR_NOT_FOUND")}}class Kte{constructor(e={}){this._started=!1,this._peerId=e.peerId,this._addressManager=e.addressManager,this._peerStore=e.peerStore,this._upgrader=e.upgrader,this._metrics=e.metrics,this._registrar=e.registrar,this._connectionManager=e.connectionManager,this._transportManager=e.transportManager,this._connectionGater=e.connectionGater,this._contentRouting=e.contentRouting,this._peerRouting=e.peerRouting,this._datastore=e.datastore,this._connectionProtector=e.connectionProtector,this._dht=e.dht,this._pubsub=e.pubsub,this._dialer=e.dialer}isStarted(){return this._started}async beforeStart(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.beforeStart!=null&&await e.beforeStart()}))}async start(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{await e.start()})),this._started=!0}async afterStart(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async beforeStop(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.beforeStop!=null&&await e.beforeStop()}))}async stop(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{await e.stop()})),this._started=!1}async afterStop(){await Promise.all(Object.values(this).filter(e=>Gt(e)).map(async e=>{e.afterStop!=null&&await e.afterStop()}))}get peerId(){if(this._peerId==null)throw E(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this._peerId}set peerId(e){this._peerId=e}get addressManager(){if(this._addressManager==null)throw E(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this._addressManager}set addressManager(e){this._addressManager=e}get peerStore(){if(this._peerStore==null)throw E(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this._peerStore}set peerStore(e){this._peerStore=e}get upgrader(){if(this._upgrader==null)throw E(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this._upgrader}set upgrader(e){this._upgrader=e}get registrar(){if(this._registrar==null)throw E(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this._registrar}set registrar(e){this._registrar=e}get connectionManager(){if(this._connectionManager==null)throw E(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this._connectionManager}set connectionManager(e){this._connectionManager=e}get transportManager(){if(this._transportManager==null)throw E(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this._transportManager}set transportManager(e){this._transportManager=e}get connectionGater(){if(this._connectionGater==null)throw E(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this._connectionGater}set connectionGater(e){this._connectionGater=e}get contentRouting(){if(this._contentRouting==null)throw E(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this._contentRouting}set contentRouting(e){this._contentRouting=e}get peerRouting(){if(this._peerRouting==null)throw E(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this._peerRouting}set peerRouting(e){this._peerRouting=e}get datastore(){if(this._datastore==null)throw E(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this._datastore}set datastore(e){this._datastore=e}get connectionProtector(){return this._connectionProtector}set connectionProtector(e){this._connectionProtector=e}get dialer(){if(this._dialer==null)throw E(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this._dialer}set dialer(e){this._dialer=e}get metrics(){return this._metrics}set metrics(e){this._metrics=e}get dht(){return this._dht}set dht(e){this._dht=e}get pubsub(){return this._pubsub}set pubsub(e){this._pubsub=e}}var so=1e3,io=so*60,oo=io*60,ii=oo*24,qte=ii*7,Hte=ii*365.25,Gte=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return Wte(r);if(t==="number"&&isFinite(r))return e.long?Qte(r):Yte(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Wte(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*Hte;case"weeks":case"week":case"w":return t*qte;case"days":case"day":case"d":return t*ii;case"hours":case"hour":case"hrs":case"hr":case"h":return t*oo;case"minutes":case"minute":case"mins":case"min":case"m":return t*io;case"seconds":case"second":case"secs":case"sec":case"s":return t*so;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Yte(r){var e=Math.abs(r);return e>=ii?Math.round(r/ii)+"d":e>=oo?Math.round(r/oo)+"h":e>=io?Math.round(r/io)+"m":e>=so?Math.round(r/so)+"s":r+"ms"}function Qte(r){var e=Math.abs(r);return e>=ii?Kc(r,e,ii,"day"):e>=oo?Kc(r,e,oo,"hour"):e>=io?Kc(r,e,io,"minute"):e>=so?Kc(r,e,so,"second"):r+" ms"}function Kc(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}var y4=t9,Jte=Gte,$s=t9.prototype,Xte=new Date%1e9;function Zte(){return(Math.random()*1e9>>>0)+Xte++}function t9(r){r=r||{},this.id=r.id||Zte(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var e,t,n=this.items.length;n--;)e=this.items[n],t=new Date(e.expires)-new Date,this._lookup[e.key]=e,t>0?this.expire(e.key,t):t<=0&&this.delete(e.key)}$s.has=function(r){return r in this._lookup};$s.get=function(r){if(!this.has(r))return null;var e=this._lookup[r];return e.refresh&&this.expire(r,e.refresh),this.items.splice(this.items.indexOf(e),1),this.items.push(e),e.value};$s.meta=function(r){if(!this.has(r))return null;var e=this._lookup[r];return"meta"in e?e.meta:null};$s.set=function(r,e,t){var n=this._lookup[r],s=this._lookup[r]={key:r,value:e};return this.lastModified=new Date,n?(clearTimeout(n.timeout),this.items.splice(this.items.indexOf(n),1,s)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(s),this.size++),t&&("ttl"in t&&this.expire(r,t.ttl),"meta"in t&&(s.meta=t.meta),t.refresh&&(s.refresh=t.ttl)),this};$s.delete=function(r){var e=this._lookup[r];return e?(this.lastModified=new Date,this.items.splice(this.items.indexOf(e),1),clearTimeout(e.timeout),delete this._lookup[r],this.size--,this):!1};$s.expire=function(r,e){var t=e||0,n=this._lookup[r];if(!n)return this;if(typeof t=="string"&&(t=Jte(e)),typeof t!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(n.timeout),n.timeout=setTimeout(this.delete.bind(this,n.key),t),n.expires=Number(new Date)+t,this};$s.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};$s.toJSON=function(){for(var r=new Array(this.items.length),e,t=r.length;t--;)e=this.items[t],r[t]={key:e.key,meta:e.meta,value:e.value,expires:e.expires,refresh:e.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}};function tf(r,e,t){return`${r}?name=${e}&type=${t}`}async function ere(r,e){return await(await RE(r,{headers:new IE({accept:"application/dns-json"}),signal:e})).json()}function Si(r,e){return`${e}_${r}`}const rf=Object.assign(Xt("dns-over-http-resolver"),{error:Xt("dns-over-http-resolver:error")});class tre{constructor(e={}){this._cache=new y4({max:e?.maxCache??100}),this._TXTcache=new y4({max:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??ere,this._abortControllers=[]}cancel(){this._abortControllers.forEach(e=>e.abort())}getServers(){return this._servers}_getShuffledServers(){const e=[...this._servers];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),s=e[t];e[t]=e[n],e[n]=s}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return await this.resolve4(e);case"AAAA":return await this.resolve6(e);case"TXT":return await this.resolveTxt(e);default:throw new Error(`${t} is not supported`)}}async resolve4(e){const t="A",n=this._cache.get(Si(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(tf(i,e,t),o.signal),c=a.Answer.map(l=>l.data),u=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(Si(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(s=!0),rf.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){const t="AAAA",n=this._cache.get(Si(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(tf(i,e,t),o.signal),c=a.Answer.map(l=>l.data),u=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(Si(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(s=!0),rf.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){const t="TXT",n=this._TXTcache.get(Si(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(tf(i,e,t),o.signal),c=a.Answer.map(l=>[l.data.replace(/['"]+/g,"")]),u=Math.min(...a.Answer.map(l=>l.TTL));return this._TXTcache.set(Si(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(s=!0),rf.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}}const{code:rre}=od("dnsaddr");async function nre(r,e={}){const t=new tre;e.signal!=null&&e.signal.addEventListener("abort",()=>{t.cancel()});const n=r.getPeerId(),[,s]=r.stringTuples().find(([a])=>a===rre)??[];if(s==null)throw new Error("No hostname found in multiaddr");let o=(await t.resolveTxt(`_dnsaddr.${s}`)).flat().map(a=>a.split("=")[1]);return n!=null&&(o=o.filter(a=>a.includes(n))),o}const sre={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{maxConnections:300,minConnections:50,autoDial:!0,autoDialInterval:1e4,maxParallelDials:Hb,maxDialsPerPeer:Gb,dialTimeout:qb,inboundUpgradeTimeout:bee,resolvers:{dnsaddr:nre},addressSorter:Q2},connectionGater:{},transportManager:{faultTolerance:zi.FATAL_ALL},metrics:{enabled:!1,computeThrottleMaxQueueSize:1e3,computeThrottleTimeout:2e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3],maxOldPeersRetention:50},peerRouting:{refreshManager:{enabled:!0,interval:6e5,bootDelay:1e4}},nat:{enabled:!0,ttl:7200,keepAlive:!0},relay:{enabled:!0,advertise:{bootDelay:mZ,enabled:!1,ttl:bZ},hop:{enabled:!1,active:!1,timeout:3e4},autoRelay:{enabled:!1,maxListeners:2}},identify:{protocolPrefix:"ipfs",host:{agentVersion:Xb},timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1},ping:{protocolPrefix:"ipfs",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4},fetch:{protocolPrefix:"libp2p",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4}};function ire(r){const e=Le(sre,r);if(e.transports==null||e.transports.length<1)throw E(new Error(pe.ERR_TRANSPORTS_REQUIRED),D.ERR_TRANSPORTS_REQUIRED);if(e.connectionEncryption==null||e.connectionEncryption.length===0)throw E(new Error(pe.CONN_ENCRYPTION_REQUIRED),D.CONN_ENCRYPTION_REQUIRED);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw E(new Error(pe.ERR_PROTECTOR_REQUIRED),D.ERR_PROTECTOR_REQUIRED);return e.identify.host.agentVersion===Xb&&(lE||uE?e.identify.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(hf||dE||hE||fE)&&(e.identify.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`)),e}var w4;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.id!=null&&t.id.byteLength>0)&&(n.uint32(10),n.bytes(t.id)),t.pubKey!=null&&(n.uint32(18),n.bytes(t.pubKey)),t.privKey!=null&&(n.uint32(26),n.bytes(t.privKey)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={id:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.id=t.bytes();break;case 2:s.pubKey=t.bytes();break;case 3:s.privKey=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(w4||(w4={}));const r9=async()=>{const r=await v0("Ed25519"),e=await n9(r);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)},ore=async r=>{const e=await v0("RSA",r?.bits??2048),t=await n9(e);if(t.type==="RSA")return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)};async function n9(r){return await Sn(_0(r.public),pE(r))}class are extends st{get[ad](){return!0}get[Symbol.toStringTag](){return"@libp2p/dummy-dht"}get wan(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}get lan(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}get(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}findProviders(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}findPeer(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}getClosestPeers(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}provide(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}put(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}async getMode(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}async setMode(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}async refreshRoutingTable(){throw E(new Error(pe.DHT_DISABLED),D.DHT_DISABLED)}}class cre extends st{constructor(){super(...arguments),this.topicValidators=new Map}isStarted(){return!1}start(){}stop(){}get globalSignaturePolicy(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}get multicodecs(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}getPeers(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}getTopics(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}subscribe(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}unsubscribe(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}getSubscribers(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}async publish(){throw E(new Error(pe.PUBSUB_DISABLED),D.ERR_PUBSUB_DISABLED)}}var lre=class{constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return this.buffer[this.btm]===void 0}};const m4=lre;var ure=class{constructor(e){this.hwm=e||16,this.head=new m4(this.hwm),this.tail=this.head}push(e){if(!this.head.push(e)){const t=this.head;this.head=t.next=new m4(2*this.head.buffer.length),this.head.push(e)}}shift(){const e=this.tail.shift();if(e===void 0&&this.tail.next){const t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return e}peek(){return this.tail.peek()}isEmpty(){return this.head.isEmpty()}};const dre=()=>{const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r};var hre=dre;const b4=ure,E4=hre;var fre=class{constructor(){this._buffer=new b4,this._waitingConsumers=new b4}push(e){const{promise:t,resolve:n}=E4();return this._buffer.push({chunk:e,resolve:n}),this._consume(),t}_consume(){for(;!this._waitingConsumers.isEmpty()&&!this._buffer.isEmpty();){const e=this._waitingConsumers.shift(),t=this._buffer.shift();e.resolve(t.chunk),t.resolve()}}shift(){const{promise:e,resolve:t}=E4();return this._waitingConsumers.push({resolve:t}),this._consume(),e}isEmpty(){return this._buffer.isEmpty()}};const _4=O("libp2p:dialer:dial-request");class pre{constructor(e){const{addrs:t,dialAction:n,dialer:s}=e;this.addrs=t,this.dialer=s,this.dialAction=n}async run(e={}){const t=this.dialer.getTokens(this.addrs.length);if(t.length<1)throw E(new Error("No dial tokens available"),D.ERR_NO_DIAL_TOKENS);const n=new fre;for(const a of t)n.push(a).catch(c=>{_4.error(c)});const s=this.addrs.map(()=>{const a=new AbortController;try{Se.setMaxListeners?.(1/0,a.signal)}catch{}return a});if(e.signal!=null)try{Se.setMaxListeners?.(1/0,e.signal)}catch{}let i=0,o=!1;try{return await Promise.any(this.addrs.map(async(a,c)=>{const u=await n.shift();if(o)throw this.dialer.releaseToken(t.splice(t.indexOf(u),1)[0]),E(new Error("dialAction already succeeded"),D.ERR_ALREADY_SUCCEEDED);const l=s[c];if(l==null)throw E(new Error("dialAction did not come with an AbortController"),D.ERR_INVALID_PARAMETERS);let d;try{const f=l.signal;d=await this.dialAction(a,{...e,signal:e.signal!=null?Jr([f,e.signal]):f}),s[c]=void 0}finally{i++,this.addrs.length-i>=t.length?n.push(u).catch(f=>{_4.error(f)}):this.dialer.releaseToken(t.splice(t.indexOf(u),1)[0])}if(d==null)throw E(new Error("dialAction led to empty object"),D.ERR_TRANSPORT_DIAL_FAILED);return o=!0,d}))}finally{s.forEach(a=>{a!==void 0&&a.abort()}),t.forEach(a=>this.dialer.releaseToken(a))}}}const wr=O("libp2p:dialer"),v4="dialler",gre="pending-dials",yre="pending-dial-targets";class wre{constructor(e,t={}){this.started=!1,this.addressSorter=t.addressSorter??Q2,this.maxAddrsToDial=t.maxAddrsToDial??Eee,this.timeout=t.dialTimeout??qb,this.maxDialsPerPeer=t.maxDialsPerPeer??Gb,this.tokens=[...new Array(t.maxParallelDials??Hb)].map((n,s)=>s),this.components=e,this.pendingDials=si({component:v4,metric:gre,metrics:t.metrics}),this.pendingDialTargets=si({component:v4,metric:yre,metrics:e.metrics});for(const[n,s]of Object.entries(t.resolvers??{}))gE.set(n,s)}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1;for(const e of this.pendingDials.values())try{e.controller.abort()}catch(t){wr.error(t)}this.pendingDials.clear();for(const e of this.pendingDialTargets.values())e.reject(new AE("Dialer was destroyed"));this.pendingDialTargets.clear()}async dial(e,t={}){const{id:n,multiaddrs:s}=ca(e);if(this.components.peerId.equals(n))throw E(new Error("Tried to dial self"),D.ERR_DIALED_SELF);if(wr("check multiaddrs %p",n),s!=null&&s.length>0&&(wr("storing multiaddrs %p",n,s),await this.components.peerStore.addressBook.add(n,s)),await this.components.connectionGater.denyDialPeer(n))throw E(new Error("The dial request is blocked by gater.allowDialPeer"),D.ERR_PEER_DIAL_INTERCEPTED);wr("creating dial target for %p",n);const i=await this._createCancellableDialTarget(n,t);if(i.addrs.length===0)throw E(new Error("The dial request has no valid addresses"),D.ERR_NO_VALID_ADDRESSES);const o=this.pendingDials.get(i.id)??this._createPendingDial(i,t);try{const a=await o.promise;return wr("dial succeeded to %s",i.id),a}catch(a){throw wr("dial failed to %s",i.id,a),o.controller.signal.aborted&&(a.code=D.ERR_TIMEOUT),wr.error(a),a}finally{o.destroy()}}async _createCancellableDialTarget(e,t){const n=`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`,s=new Promise((i,o)=>{this.pendingDialTargets.set(n,{resolve:i,reject:o})});try{return await Promise.race([this._createDialTarget(e,t),s])}finally{this.pendingDialTargets.delete(n)}}async _createDialTarget(e,t){const n=this._resolve.bind(this),s=await ne(await this.components.peerStore.addressBook.get(e),i=>Ze(i,async o=>!await this.components.connectionGater.denyDialMultiaddr(e,o.multiaddr)),i=>Va(i,this.addressSorter),async function*(o){for await(const a of o)yield*await n(a.multiaddr,t)},i=>Ze(i,o=>Boolean(this.components.transportManager.transportForMultiaddr(o))),i=>_t(i,o=>e.toString()===o.getPeerId()?o:o.encapsulate(`/p2p/${e.toString()}`)),async i=>await Dn(i));if(s.length>this.maxAddrsToDial)throw await this.components.peerStore.delete(e),E(new Error("dial with more addresses than allowed"),D.ERR_TOO_MANY_ADDRESSES);return{id:e.toString(),addrs:s}}_createPendingDial(e,t={}){const n=async(u,l={})=>{if(l.signal?.aborted===!0)throw E(new Error("already aborted"),D.ERR_ALREADY_ABORTED);return await this.components.transportManager.dial(u,l).catch(d=>{throw wr.error("dial to %s failed",u,d),d})},s=new pre({addrs:e.addrs,dialAction:n,dialer:this}),i=new $e.TimeoutController(this.timeout),o=[i.signal];t.signal!=null&&o.push(t.signal);const a=Jr(o);try{Se.setMaxListeners?.(1/0,a)}catch{}const c={dialRequest:s,controller:i,promise:s.run({...t,signal:a}),destroy:()=>{i.clear(),this.pendingDials.delete(e.id)}};return this.pendingDials.set(e.id,c),c}getTokens(e){const t=Math.min(e,this.maxDialsPerPeer,this.tokens.length),n=this.tokens.splice(0,t);return wr("%d tokens request, returning %d, %d remaining",e,t,this.tokens.length),n}releaseToken(e){this.tokens.includes(e)||(wr("token %d released",e),this.tokens.push(e))}async _resolve(e,t){if(!e.protoNames().includes("dnsaddr"))return[e];const s=await this._resolveRecord(e,t);return(await Promise.all(s.map(async a=>await this._resolve(a,t)))).flat().reduce((a,c)=>(a.find(u=>u.equals(c))==null&&a.push(c),a),[])}async _resolveRecord(e,t){try{return e=X(e.toString()),await e.resolve(t)}catch(n){return wr.error(`multiaddr ${e.toString()} could not be resolved`,n),[]}}}const hn=O("libp2p");class mre extends st{constructor(e){super(),this.started=!1,this.peerId=e.peerId;const t=this.components=new Kte({peerId:e.peerId,datastore:e.datastore??new QT,connectionGater:{denyDialPeer:async()=>await Promise.resolve(!1),denyDialMultiaddr:async()=>await Promise.resolve(!1),denyInboundConnection:async()=>await Promise.resolve(!1),denyOutboundConnection:async()=>await Promise.resolve(!1),denyInboundEncryptedConnection:async()=>await Promise.resolve(!1),denyOutboundEncryptedConnection:async()=>await Promise.resolve(!1),denyInboundUpgradedConnection:async()=>await Promise.resolve(!1),denyOutboundUpgradedConnection:async()=>await Promise.resolve(!1),filterMultiaddrForPeer:async()=>await Promise.resolve(!0),...e.connectionGater}});t.peerStore=new Vte(t,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore}),this.services=[t],e.metrics.enabled&&(this.metrics=this.components.metrics=new Iee(e.metrics)),this.peerStore=this.components.peerStore,this.peerStore.addEventListener("peer",o=>{const{detail:a}=o;this.dispatchEvent(new Z("peer:discovery",{detail:a}))}),e.connectionProtector!=null&&(this.components.connectionProtector=e.connectionProtector(t)),this.components.upgrader=new qee(this.components,{connectionEncryption:(e.connectionEncryption??[]).map(o=>this.configureComponent(o(this.components))),muxers:(e.streamMuxers??[]).map(o=>this.configureComponent(o(this.components))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.components.dialer=new wre(this.components,e.connectionManager),this.connectionManager=this.components.connectionManager=new SX(this.components,e.connectionManager),this.registrar=this.components.registrar=new Vee(this.components),this.components.transportManager=new Oee(this.components,e.transportManager),this.components.addressManager=new dJ(this.components,e.addresses),this.configureComponent(new Ate(this.components)),this.configureComponent(new IX(this.components,{enabled:e.connectionManager.autoDial,minConnections:e.connectionManager.minConnections,autoDialInterval:e.connectionManager.autoDialInterval}));const n=t4.generateOptions();this.keychain=this.configureComponent(new t4(this.components,{...n,...e.keychain})),this.services.push(new Rte(this.components,e.nat)),e.transports.forEach(o=>{this.components.transportManager.add(this.configureComponent(o(this.components)))}),this.identifyService=new ep(this.components,{...e.identify}),this.configureComponent(this.identifyService),e.dht!=null?this.dht=this.components.dht=e.dht(this.components):this.dht=new are,e.pubsub!=null?this.pubsub=this.components.pubsub=e.pubsub(this.components):this.pubsub=new cre;const s=(e.peerRouters??[]).map(o=>this.configureComponent(o(this.components)));e.dht!=null&&(s.push(this.configureComponent(new Cte(this.dht))),this.dht.addEventListener("peer",o=>{this.onDiscoveryPeer(o)})),this.peerRouting=this.components.peerRouting=this.configureComponent(new aJ(this.components,{...e.peerRouting,routers:s}));const i=(e.contentRouters??[]).map(o=>this.configureComponent(o(this.components)));e.dht!=null&&i.push(this.configureComponent(new jte(this.dht))),this.contentRouting=this.components.contentRouting=this.configureComponent(new cJ(this.components,{routers:i})),e.relay.enabled&&(this.components.transportManager.add(this.configureComponent(new xX(this.components,e.relay))),this.configureComponent(new xZ(this.components,{addressSorter:e.connectionManager.addressSorter,...e.relay}))),this.fetchService=this.configureComponent(new ete(this.components,{...e.fetch})),this.pingService=this.configureComponent(new ste(this.components,{...e.ping}));for(const o of e.peerDiscovery??[])this.configureComponent(o(this.components)).addEventListener("peer",c=>{this.onDiscoveryPeer(c)})}configureComponent(e){return Gt(e)&&this.services.push(e),e}async start(){if(!this.started){this.started=!0,hn("libp2p is starting");try{await Promise.all(this.services.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(this.services.map(e=>e.start())),await Promise.all(this.services.map(async e=>{e.afterStart!=null&&await e.afterStart()})),hn("libp2p has started")}catch(e){throw hn.error("An error occurred starting libp2p",e),await this.stop(),e}}}async stop(){this.started&&(hn("libp2p is stopping"),this.started=!1,await Promise.all(this.services.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(this.services.map(e=>e.stop())),await Promise.all(this.services.map(async e=>{e.afterStop!=null&&await e.afterStop()})),hn("libp2p has stopped"))}isStarted(){return this.started}getConnections(e){return this.components.connectionManager.getConnections(e)}getPeers(){const e=new Ts;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){const{id:n,multiaddrs:s}=ca(e);return await this.components.peerStore.addressBook.add(n,s),await this.components.connectionManager.openConnection(n,t)}async dialProtocol(e,t,n={}){if(t==null)throw E(new Error("no protocols were provided to open a stream"),D.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(t=Array.isArray(t)?t:[t],t.length===0)throw E(new Error("no protocols were provided to open a stream"),D.ERR_INVALID_PROTOCOLS_FOR_STREAM);return await(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}async hangUp(e){const{id:t}=ca(e);await this.components.connectionManager.closeConnections(t)}async getPublicKey(e,t={}){if(hn("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;const n=await this.peerStore.get(e);if(n.pubKey!=null)return n.pubKey;if(this.dht==null)throw E(new Error("Public key was not in the peer store and the DHT is not enabled"),D.ERR_NO_ROUTERS_AVAILABLE);const s=Jt([M("/pk/"),e.multihash.digest]);for await(const i of this.dht.get(s,t))if(i.name==="VALUE"){const o=Ki(i.value);return await this.peerStore.keyBook.set(e,i.value),o.bytes}throw E(new Error(`Node not responding with its public key: ${e.toString()}`),D.ERR_INVALID_RECORD)}async fetch(e,t,n={}){const{id:s,multiaddrs:i}=ca(e);return i!=null&&await this.components.peerStore.addressBook.add(s,i),await this.fetchService.fetch(s,t,n)}async ping(e,t={}){const{id:n,multiaddrs:s}=ca(e);return s.length>0&&await this.components.peerStore.addressBook.add(n,s),await this.pingService.ping(n,t)}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}onDiscoveryPeer(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){hn.error(new Error(D.ERR_DISCOVERED_SELF));return}t.multiaddrs.length>0&&this.components.peerStore.addressBook.add(t.id,t.multiaddrs).catch(n=>hn.error(n)),t.protocols.length>0&&this.components.peerStore.protoBook.set(t.id,t.protocols).catch(n=>hn.error(n)),this.dispatchEvent(new Z("peer:discovery",{detail:t}))}}async function bre(r){return r.peerId==null&&(r.peerId=await r9()),new mre(ire(r))}async function Ere(r){return await bre(r)}const _re=yE,{EventEmitter:vre}=Se;function S4(r,e){if(r===e)return!0;if(r.length!==e.length)return!1;for(let t=0,n=r.length;t<n;++t)if(r[t]!==e[t])return!1;return!0}function nf(){return{contacts:[],dontSplit:!1,left:null,right:null}}function Yo(r,e){if(!(e instanceof Uint8Array))throw new TypeError(r+" is not a Uint8Array")}class Yu extends vre{constructor(e={}){super(),this.localNodeId=e.localNodeId||_re(20),this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket||20,this.numberOfNodesToPing=e.numberOfNodesToPing||3,this.distance=e.distance||Yu.distance,this.arbiter=e.arbiter||Yu.arbiter,this.metadata=Object.assign({},e.metadata),Yo("option.localNodeId as parameter 1",this.localNodeId),this.root=nf()}static arbiter(e,t){return e.vectorClock>t.vectorClock?e:t}static distance(e,t){let n=0,s=0;const i=Math.min(e.length,t.length),o=Math.max(e.length,t.length);for(;s<i;++s)n=n*256+(e[s]^t[s]);for(;s<o;++s)n=n*256+255;return n}add(e){Yo("contact.id",(e||{}).id);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e.id,t++);const s=this._indexOf(n,e.id);return s>=0?(this._update(n,s,e),this):n.contacts.length<this.numberOfNodesPerKBucket?(n.contacts.push(e),this.emit("added",e),this):n.dontSplit?(this.emit("ping",n.contacts.slice(0,this.numberOfNodesToPing),e),this):(this._split(n,t),this.add(e))}closest(e,t=1/0){if(Yo("id",e),!Number.isInteger(t)&&t!==1/0||t<=0)throw new TypeError("n is not positive number");let n=[];for(let s=[this.root],i=0;s.length>0&&n.length<t;){const o=s.pop();if(o.contacts===null){const a=this._determineNode(o,e,i++);s.push(o.left===a?o.right:o.left),s.push(a)}else n=n.concat(o.contacts)}return n.map(s=>[this.distance(s.id,e),s]).sort((s,i)=>s[0]-i[0]).slice(0,t).map(s=>s[1])}count(){let e=0;for(const t=[this.root];t.length>0;){const n=t.pop();n.contacts===null?t.push(n.right,n.left):e+=n.contacts.length}return e}_determineNode(e,t,n){const s=n>>3,i=n%8;return t.length<=s&&i!==0?e.left:t[s]&1<<7-i?e.right:e.left}get(e){Yo("id",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);const s=this._indexOf(n,e);return s>=0?n.contacts[s]:null}_indexOf(e,t){for(let n=0;n<e.contacts.length;++n)if(S4(e.contacts[n].id,t))return n;return-1}remove(e){Yo("the id as parameter 1",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);const s=this._indexOf(n,e);if(s>=0){const i=n.contacts.splice(s,1)[0];this.emit("removed",i)}return this}_split(e,t){e.left=nf(),e.right=nf();for(const i of e.contacts)this._determineNode(e,i.id,t).contacts.push(i);e.contacts=null;const n=this._determineNode(e,this.localNodeId,t),s=e.left===n?e.right:e.left;s.dontSplit=!0}toArray(){let e=[];for(const t=[this.root];t.length>0;){const n=t.pop();n.contacts===null?t.push(n.right,n.left):e=e.concat(n.contacts)}return e}*toIterable(){for(const e=[this.root];e.length>0;){const t=e.pop();t.contacts===null?e.push(t.right,t.left):yield*t.contacts}}_update(e,t,n){if(!S4(e.contacts[t].id,n.id))throw new Error("wrong index for _update");const s=e.contacts[t],i=this.arbiter(s,n);i===s&&s!==n||(e.contacts.splice(t,1),e.contacts.push(i),this.emit("updated",s,i))}}var Sre=Yu;const Rre=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},op=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var Ire=s9,R4=128,Are=127,Cre=~Are,Tre=Math.pow(2,31);function s9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Tre;)e[t++]=r&255|R4,r/=128;for(;r&Cre;)e[t++]=r&255|R4,r>>>=7;return e[t]=r|0,s9.bytes=t-n+1,e}var Dre=s0,Pre=128,I4=127;function s0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw s0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&I4)<<s:(o&I4)*Math.pow(2,s),s+=7}while(o>=Pre);return s0.bytes=i-n,t}var kre=Math.pow(2,7),Ore=Math.pow(2,14),Nre=Math.pow(2,21),xre=Math.pow(2,28),$re=Math.pow(2,35),Lre=Math.pow(2,42),Mre=Math.pow(2,49),Ure=Math.pow(2,56),Bre=Math.pow(2,63),zre=function(r){return r<kre?1:r<Ore?2:r<Nre?3:r<xre?4:r<$re?5:r<Lre?6:r<Mre?7:r<Ure?8:r<Bre?9:10},Fre={encode:Ire,decode:Dre,encodingLength:zre},Qu=Fre;const i0=(r,e=0)=>[Qu.decode(r,e),Qu.decode.bytes],Ju=(r,e,t=0)=>(Qu.encode(r,e,t),e),Xu=r=>Qu.encodingLength(r),o0=(r,e)=>{const t=e.byteLength,n=Xu(r),s=n+Xu(t),i=new Uint8Array(s+t);return Ju(r,i,0),Ju(t,i,n),i.set(e,s),new ap(r,t,e,i)},Vre=r=>{const e=op(r),[t,n]=i0(e),[s,i]=i0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new ap(t,s,o,e)},jre=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Rre(r.bytes,t.bytes)}};let ap=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const i9=({name:r,code:e,encode:t})=>new Kre(r,e,t);let Kre=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?o0(this.code,t):t.then(n=>o0(this.code,n))}else throw Error("Unknown type, must be binary type")}};const o9=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),a9=i9({name:"sha2-256",code:18,encode:o9("SHA-256")});i9({name:"sha2-512",code:19,encode:o9("SHA-512")});const Bd=1e3,cp=60*Bd,lp=60*cp,qre=36*lp,Hre="/lan",Gre="/ipfs",Wre="/kad/1.0.0",Yre="/dht/record",c9="/dht/provider",Qre=256,Jre=24*lp,Xre=lp,a0=20,Zu=3,Zre=Number(5*cp),ene=Number(30*Bd),tne=Number(5*cp),rne=Number(30*Bd),nne=Number(30*Bd),sne=M("/pk/");function up(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();return t!==4&&t!==6||n==null?!1:!ip(n)})}}function dp(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();return t!==4&&t!==6||n==null?!1:ip(n)})}}async function ao(r){return(await a9.digest(r)).digest}async function En(r){return await ao(r.toBytes())}function ki(r){return new J(`${Yre}/${q(r,"base32")}`,!1)}function ine(r){return Jt([sne,r.toBytes()])}function one(r){return q(r.subarray(0,4))==="/pk/"}function ane(r){return Xr(r.subarray(4))}function A4(r,e){const t=new Date;return new Nt(r,e,t).serialize()}function cne(r,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>r(),e)}}const lne="kad-close",une=50,C4=20,dne=1e4,hne=10,sf="routing-table-size",fne="ping-queue-size",pne="ping-running";class gne{constructor(e,t){const{kBucketSize:n,pingTimeout:s,lan:i,pingConcurrency:o,protocol:a,tagName:c,tagValue:u}=t;this.components=e,this.log=O(`libp2p:kad-dht:${i?"lan":"wan"}:routing-table`),this.kBucketSize=n??C4,this.pingTimeout=s??dne,this.pingConcurrency=o??hne,this.lan=i,this.running=!1,this.protocol=a,this.tagName=c??lne,this.tagValue=u??une;const l=()=>{this.components.metrics?.updateComponentMetric({system:"libp2p",component:`kad-dht-${this.lan?"lan":"wan"}`,metric:fne,value:this.pingQueue.size}),this.components.metrics?.updateComponentMetric({system:"libp2p",component:`kad-dht-${this.lan?"lan":"wan"}`,metric:pne,value:this.pingQueue.pending})};this.pingQueue=new lt({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",l),this.pingQueue.addListener("next",l),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0;const e=new Sre({localNodeId:await En(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.on("ping",this._onPing),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new Ts;const n=cne(()=>{const s=new Ts(e.closest(e.localNodeId,C4).map(a=>a.peer)),i=s.difference(t),o=t.difference(s);Promise.resolve().then(async()=>{for(const a of i)await this.components.peerStore.tagPeer(a,this.tagName,{value:this.tagValue});for(const a of o)await this.components.peerStore.unTagPeer(a,this.tagName)}).catch(a=>{this.log.error("Could not update peer tags",a)}),t=s});e.on("added",()=>{n()}),e.on("removed",()=>{n()})}_onPing(e,t){this.pingQueue.add(async()=>{if(!this.running)return;let n=0;try{await Promise.all(e.map(async s=>{let i;try{i=new $e.TimeoutController(this.pingTimeout);const o={signal:i.signal};this.log("pinging old contact %p",s.peer),(await(await this.components.connectionManager.openConnection(s.peer,o)).newStream(this.protocol,o)).close(),n++}catch(o){this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",s.peer,o),this.log("evicting old contact after ping failed %p",s),this.kb.remove(s.id))}finally{i?.clear(),this.components.metrics?.updateComponentMetric({system:"libp2p",component:`kad-dht-${this.lan?"lan":"wan"}`,metric:sf,value:this.size})}})),this.running&&n<e.length&&this.kb!=null&&(this.log("adding new contact %p",t.peer),this.kb.add(t))}catch(s){this.log.error("could not process k-bucket ping event",s)}}).catch(n=>{this.log.error("could not process k-bucket ping event",n)})}get size(){return this.kb==null?0:this.kb.count()}async find(e){const t=await En(e),n=this.closestPeer(t);if(n!=null&&e.equals(n))return n}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return this.kb==null?[]:this.kb.closest(e,t).map(s=>s.peer)}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");const t=await En(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.components.metrics?.updateComponentMetric({system:"libp2p",component:`kad-dht-${this.lan?"lan":"wan"}`,metric:sf,value:this.size})}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");const t=await En(e);this.kb.remove(t),this.components.metrics?.updateComponentMetric({system:"libp2p",component:`kad-dht-${this.lan?"lan":"wan"}`,metric:sf,value:this.size})}}const yne=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],qc=15;class wne{constructor(e){const{peerRouting:t,routingTable:n,refreshInterval:s,refreshQueryTimeout:i,lan:o}=e;this.log=O(`libp2p:kad-dht:${o?"lan":"wan"}:routing-table:refresh`),this.peerRouting=t,this.routingTable=n,this.refreshInterval=s??tne,this.refreshQueryTimeout=i??rne,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(n.map(async(s,i)=>{try{if(await this._refreshCommonPrefixLength(i,s,e),this._numPeersForCpl(t)===0){const o=Math.min(2*(i+1),n.length-1);for(let a=i+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,s,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const i=new $e.TimeoutController(this.refreshQueryTimeout);try{const o=await Xi(this.peerRouting.getClosestPeers(s.toBytes(),{signal:i.signal}));this.log(`found ${o} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}finally{i.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>qc&&(e=qc);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");const t=id(2),n=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localNodeId,n,e);return Xr(s)}async _makePeerId(e,t,n){if(n>qc)throw new Error(`Cannot generate peer ID for common prefix length greater than ${qc}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,u=yne[c],l=new ArrayBuffer(34),d=new DataView(l,0,l.byteLength);return d.setUint8(0,a9.code),d.setUint8(1,32),d.setUint32(2,u,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(const{id:e}of this.routingTable.kb.toIterable()){const t=Ra(this.routingTable.kb.localNodeId,e);let n=0;for(const s of t)if(s===0)n++;else break;yield n}}}var T4;(function(r){let e;r.codec=()=>(e==null&&(e=tt((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 3:s.author=t.bytes();break;case 4:s.signature=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>rt(t,r.codec()),r.decode=t=>nt(t,r.codec())})(T4||(T4={}));var Js;(function(r){(function(s){s.PUT_VALUE="PUT_VALUE",s.GET_VALUE="GET_VALUE",s.ADD_PROVIDER="ADD_PROVIDER",s.GET_PROVIDERS="GET_PROVIDERS",s.FIND_NODE="FIND_NODE",s.PING="PING"})(r.MessageType||(r.MessageType={}));let e;(function(s){s[s.PUT_VALUE=0]="PUT_VALUE",s[s.GET_VALUE=1]="GET_VALUE",s[s.ADD_PROVIDER=2]="ADD_PROVIDER",s[s.GET_PROVIDERS=3]="GET_PROVIDERS",s[s.FIND_NODE=4]="FIND_NODE",s[s.PING=5]="PING"})(e||(e={})),function(s){s.codec=()=>ji(e)}(r.MessageType||(r.MessageType={})),function(s){s.NOT_CONNECTED="NOT_CONNECTED",s.CONNECTED="CONNECTED",s.CAN_CONNECT="CAN_CONNECT",s.CANNOT_CONNECT="CANNOT_CONNECT"}(r.ConnectionType||(r.ConnectionType={}));let t;(function(s){s[s.NOT_CONNECTED=0]="NOT_CONNECTED",s[s.CONNECTED=1]="CONNECTED",s[s.CAN_CONNECT=2]="CAN_CONNECT",s[s.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(t||(t={})),function(s){s.codec=()=>ji(t)}(r.ConnectionType||(r.ConnectionType={})),function(s){let i;s.codec=()=>(i==null&&(i=tt((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const u of o.addrs)a.uint32(18),a.bytes(u);else throw new Error('Protocol error: required field "addrs" was not found in object');o.connection!=null&&(a.uint32(24),r.ConnectionType.codec().encode(o.connection,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const l=o.uint32();switch(l>>>3){case 1:c.id=o.bytes();break;case 2:c.addrs.push(o.bytes());break;case 3:c.connection=r.ConnectionType.codec().decode(o);break;default:o.skipType(l&7);break}}return c})),i),s.encode=o=>rt(o,s.codec()),s.decode=o=>nt(o,s.codec())}(r.Peer||(r.Peer={}));let n;r.codec=()=>(n==null&&(n=tt((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.MessageType.codec().encode(s.type,i)),s.clusterLevelRaw!=null&&(i.uint32(80),i.int32(s.clusterLevelRaw)),s.key!=null&&(i.uint32(18),i.bytes(s.key)),s.record!=null&&(i.uint32(26),i.bytes(s.record)),s.closerPeers!=null)for(const a of s.closerPeers)i.uint32(66),r.Peer.codec().encode(a,i);else throw new Error('Protocol error: required field "closerPeers" was not found in object');if(s.providerPeers!=null)for(const a of s.providerPeers)i.uint32(74),r.Peer.codec().encode(a,i);else throw new Error('Protocol error: required field "providerPeers" was not found in object');o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={closerPeers:[],providerPeers:[]},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.type=r.MessageType.codec().decode(s);break;case 10:o.clusterLevelRaw=s.int32();break;case 2:o.key=s.bytes();break;case 3:o.record=s.bytes();break;case 8:o.closerPeers.push(r.Peer.codec().decode(s,s.uint32()));break;case 9:o.providerPeers.push(r.Peer.codec().decode(s,s.uint32()));break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>rt(s,r.codec()),r.decode=s=>nt(s,r.codec())})(Js||(Js={}));const Tt=Js.MessageType,mne=Js.ConnectionType,bne=Object.keys(Tt);let Qt=class{constructor(e,t,n){if(!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this.clusterLevelRaw=n,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){const e=this.clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this.clusterLevelRaw=e}serialize(){return Js.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map(D4),providerPeers:this.providerPeers.map(D4),record:this.record==null?void 0:this.record.serialize().subarray()})}static deserialize(e){const t=Js.decode(e),n=new Qt(t.type??Js.MessageType.PUT_VALUE,t.key??Uint8Array.from([]),t.clusterLevelRaw??0);return n.closerPeers=t.closerPeers.map(P4),n.providerPeers=t.providerPeers.map(P4),t.record?.length!=null&&(n.record=Nt.deserialize(t.record)),n}};function D4(r){return{id:r.id.toBytes(),addrs:(r.multiaddrs??[]).map(t=>t.bytes),connection:mne.CONNECTED}}function P4(r){if(r.id==null)throw new Error("Invalid peer in message");return{id:Xr(r.id),multiaddrs:(r.addrs??[]).map(e=>X(e)),protocols:[]}}function k4(r){return{...r,name:"SENDING_QUERY",type:0,messageName:r.type,messageType:bne.indexOf(r.type.toString())}}function c0(r){return{...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer!=null?r.closer:[],providers:r.providers!=null?r.providers:[]}}function Hc(r){return{...r,name:"FINAL_PEER",type:2}}function vn(r){return{...r,name:"QUERY_ERROR",type:3}}function O4(r){return{...r,name:"PROVIDER",type:4}}function l0(r){return{...r,name:"VALUE",type:5}}function N4(r){return{...r,name:"DIALING_PEER",type:7}}let Ene=class extends st{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=O(`libp2p:kad-dht:${s?"lan":"wan"}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(this.running){this.log("sending %s to %p",t.type,e),yield N4({peer:e}),yield k4({to:e,type:t.type});try{const i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),o=await this._writeReadMessage(i,t.serialize(),n);yield c0({from:e,messageType:o.type,closer:o.closerPeers,providers:o.providerPeers,record:o.record})}catch(s){yield vn({from:e,error:s})}finally{}}}async*sendMessage(e,t,n={}){if(this.running){this.log("sending %s to %p",t.type,e),yield N4({peer:e}),yield k4({to:e,type:t.type});try{const i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n);await this._writeMessage(i,t.serialize(),n),yield c0({from:e,messageType:t.type})}catch(s){yield vn({from:e,error:s})}finally{}}}async _writeMessage(e,t,n){n.signal!=null&&(e=jr(e,n.signal)),await ne([t],Dr(),e,Et)}async _writeReadMessage(e,t,n){n.signal!=null&&(e=jr(e,n.signal));const s=await ne([t],Dr(),e,Gr(),async o=>{const a=await fr(o);if(a!=null)return a;throw E(new Error("No message received"),"ERR_NO_MESSAGE_RECEIVED")}),i=Qt.deserialize(s);return i.closerPeers.forEach(o=>{this.dispatchEvent(new Z("peer",{detail:o}))}),i.providerPeers.forEach(o=>{this.dispatchEvent(new Z("peer",{detail:o}))}),i}};var _ne=l9,x4=128,vne=127,Sne=~vne,Rne=Math.pow(2,31);function l9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Rne;)e[t++]=r&255|x4,r/=128;for(;r&Sne;)e[t++]=r&255|x4,r>>>=7;return e[t]=r|0,l9.bytes=t-n+1,e}var Ine=u0,Ane=128,$4=127;function u0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw u0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&$4)<<s:(o&$4)*Math.pow(2,s),s+=7}while(o>=Ane);return u0.bytes=i-n,t}var Cne=Math.pow(2,7),Tne=Math.pow(2,14),Dne=Math.pow(2,21),Pne=Math.pow(2,28),kne=Math.pow(2,35),One=Math.pow(2,42),Nne=Math.pow(2,49),xne=Math.pow(2,56),$ne=Math.pow(2,63),Lne=function(r){return r<Cne?1:r<Tne?2:r<Dne?3:r<Pne?4:r<kne?5:r<One?6:r<Nne?7:r<xne?8:r<$ne?9:10},Mne={encode:_ne,decode:Ine,encodingLength:Lne},u9=Mne;const L4=(r,e,t=0)=>(u9.encode(r,e,t),e),M4=r=>u9.encodingLength(r),U4=(r,e)=>{const t=e.byteLength,n=M4(r),s=n+M4(t),i=new Uint8Array(s+t);return L4(r,i,0),L4(t,i,n),i.set(e,s),new Une(r,t,e,i)};let Une=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const d9=({name:r,code:e,encode:t})=>new Bne(r,e,t);let Bne=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?U4(this.code,t):t.then(n=>U4(this.code,n))}else throw Error("Unknown type, must be binary type")}};const h9=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),zne=d9({name:"sha2-256",code:18,encode:h9("SHA-256")});d9({name:"sha2-512",code:19,encode:h9("SHA-512")});function hp(r,e){const t=e.key,s=q(t).split("/");if(s.length<3)return;const i=r[s[1].toString()];if(i==null){const o="Invalid record keytype";throw E(new Error(o),"ERR_INVALID_RECORD_KEY_TYPE")}return i(t,e.value)}const Fne=async(r,e)=>{if(!(r instanceof Uint8Array))throw E(new Error('"key" must be a Uint8Array'),"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(r.byteLength<5)throw E(new Error("invalid public key record"),"ERR_INVALID_RECORD_KEY_TOO_SHORT");if(q(r.subarray(0,4))!=="/pk/")throw E(new Error("key was not prefixed with /pk/"),"ERR_INVALID_RECORD_KEY_BAD_PREFIX");const n=r.slice(4),s=await zne.digest(e);if(!Dt(n,s.bytes))throw E(new Error("public key does not match passed in key"),"ERR_INVALID_RECORD_HASH_MISMATCH")},Vne={pk:Fne};function jne(r,e,t){if(t.length===0){const o="No records given";throw E(new Error(o),"ERR_NO_RECORDS_RECEIVED")}const s=q(e).split("/");if(s.length<3){const o="Record key does not have a selector function";throw E(new Error(o),"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}const i=r[s[1].toString()];if(i==null){const o=`Unrecognized key prefix: ${s[1]}`;throw E(new Error(o),"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:i(e,t)}function Kne(r,e){return 0}const qne={pk:Kne};class Hne{constructor(e,t){const{validators:n,selectors:s,peerRouting:i,queryManager:o,routingTable:a,network:c,lan:u}=t;this.components=e,this.log=O(`libp2p:kad-dht:${u?"lan":"wan"}:content-fetching`),this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.routingTable=a,this.network=c}async putLocal(e,t){const n=ki(e);await this.components.datastore.put(n,t)}async getLocal(e){this.log("getLocal %b",e);const t=ki(e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const s=Nt.deserialize(n);return await hp(this.validators,s),s}async*sendCorrectionRecord(e,t,n,s={}){this.log("sendCorrection for %b",e);const i=await A4(e,n);for(const{value:o,from:a}of t){if(Dt(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const l=ki(e);this.log(`Storing corrected record for key ${l.toString()}`),await this.components.datastore.put(l,i.subarray())}catch(l){this.log.error("Failed error correcting self",l)}continue}let c=!1;const u=new Qt(Tt.PUT_VALUE,e,0);u.record=Nt.deserialize(i);for await(const l of this.network.sendRequest(a,u,s))l.name==="PEER_RESPONSE"&&l.record!=null&&Dt(l.record.value,Nt.deserialize(i).value)&&(c=!0),yield l;c||(yield vn({from:a,error:E(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")})),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const s=await A4(e,t),i=ki(e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray()),yield*ne(this.peerRouting.getClosestPeers(e,{signal:n.signal}),o=>_t(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],u=new Qt(Tt.PUT_VALUE,e,0);u.record=Nt.deserialize(s),this.log("send put to %p",a.peer.id);for await(const l of this.network.sendRequest(a.peer.id,u,n))c.push(l),l.name==="PEER_RESPONSE"&&(l.record!=null&&Dt(l.record.value,Nt.deserialize(s).value)||c.push(vn({from:a.peer.id,error:E(new Error("value not put correctly"),"ERR_PUT_VALUE_INVALID")})));return c}),o=>pd(o,{ordered:!1,concurrency:Zu}),async function*(o){for await(const a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;const s=n.map(a=>a.value);let i=0;try{i=jne(this.selectors,e,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw E(new Error("best value was not found"),"ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,o,t),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const a=await this.getLocal(e);yield l0({value:a.value,from:this.components.peerId})}catch(a){this.log("error getting local value for %b",e,a)}const n=await ao(e),s=this.routingTable.closestPeers(n);this.log("found %d peers in routing table",s.length);const i=this,o=async function*({peer:a,signal:c}){for await(const u of i.peerRouting.getValueOrPeers(a,e,{signal:c}))yield u,u.name==="PEER_RESPONSE"&&u.record!=null&&(yield l0({from:a,value:u.record.value}))};yield*this.queryManager.run(e,s,o,t)}}class Gne{constructor(e,t){const{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,lan:c}=t;this.components=e,this.log=O(`libp2p:kad-dht:${c?"lan":"wan"}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a}async*provide(e,t,n={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);const s=new Qt(Tt.ADD_PROVIDER,e.bytes,0);s.providerPeers=[{id:this.components.peerId,multiaddrs:t,protocols:[]}];let i=0;const o=a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[];this.log("putProvider %s to %p",e,a.peer.id);try{this.log("sending provider record for %s to %p",e,a.peer.id);for await(const u of this.network.sendMessage(a.peer.id,s,n))u.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,a.peer.id),i++),c.push(u)}catch(u){this.log.error("error sending provide record to peer %p",a.peer.id,u),c.push(vn({from:a.peer.id,error:u}))}return c};yield*ne(this.peerRouting.getClosestPeers(e.multihash.bytes,n),a=>_t(a,c=>o(c)),a=>pd(a,{ordered:!1,concurrency:Zu}),async function*(a){for await(const c of a)yield*c}),this.log("sent provider records to %d peers",i)}async*findProviders(e,t){const n=this.routingTable.kBucketSize,s=e.multihash.bytes,i=await ao(s),o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e);if(a.length>0){const l=[];for(const d of a.slice(0,n))l.push({id:d,multiaddrs:(await this.components.peerStore.addressBook.get(d)??[]).map(f=>f.multiaddr),protocols:[]});yield c0({from:this.components.peerId,messageType:Tt.GET_PROVIDERS,providers:l}),yield O4({from:this.components.peerId,providers:l})}if(a.length>=n)return;const c=async function*({peer:l,signal:d}){const f=new Qt(Tt.GET_PROVIDERS,s,0);yield*o.network.sendRequest(l,f,{signal:d})},u=new Set(a.map(l=>l.toString()));for await(const l of this.queryManager.run(s,this.routingTable.closestPeers(i),c,t))if(yield l,l.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",l.providers.length,e,l.closer.length);const d=[];for(const f of l.providers)u.has(f.id.toString())||(u.add(f.id.toString()),d.push(f));if(d.length>0&&(yield O4({from:l.from,providers:d})),u.size===n)return}}}class Wne{constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(s=>s.peerId.equals(e))!=null)return;const t=await En(e),n={peerId:e,distance:Ra(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((s,i)=>ff(s.distance,i.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(e.length===0)return!1;if(this.length===0)return!0;const t=await Promise.all(e.map(En)),n=this.peerDistances[this.peerDistances.length-1].distance;for(const s of t){const i=Ra(this.originDhtKey,s);if(ff(i,n)<0)return!0}return!1}}class Yne{constructor(e,t){const{routingTable:n,network:s,validators:i,queryManager:o,lan:a}=t;this.components=e,this.routingTable=n,this.network=s,this.validators=i,this.queryManager=o,this.log=O(`libp2p:kad-dht:${a?"lan":"wan"}:peer-routing`)}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.components.peerStore.get(n)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(t==null)try{t=await this.components.peerStore.get(e)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(s=>s.multiaddr),protocols:[]}}async*_getValueSingle(e,t,n={}){const s=new Qt(Tt.GET_VALUE,t,0);yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=ine(e);for await(const s of this._getValueSingle(e,n,t))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const i=await Sn(_0({bytes:s.record.value}));if(!i.equals(e))throw E(new Error("public key does not match id"),"ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(i.publicKey==null)throw E(new Error("public key missing"),"ERR_PUBLIC_KEY_MISSING");yield l0({from:e,value:i.publicKey})}throw E(new Error(`Node not responding with its public key: ${e.toString()}`),"ERR_INVALID_RECORD")}async*findPeer(e,t={}){this.log("findPeer %p",e);const n=await this.findPeerLocal(e);if(n!=null){this.log("found local"),yield Hc({from:this.components.peerId,peer:n});return}const s=await En(e),i=this.routingTable.closestPeers(s);if(i.find(l=>l.equals(e))!=null)try{const l=await this.components.peerStore.get(e);this.log("found in peerStore"),yield Hc({from:this.components.peerId,peer:{id:l.id,multiaddrs:l.addresses.map(d=>d.multiaddr),protocols:[]}});return}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}const a=this,c=async function*({peer:l,signal:d}){const f=new Qt(Tt.FIND_NODE,e.toBytes(),0);for await(const g of a.network.sendRequest(l,f,{signal:d}))if(yield g,g.name==="PEER_RESPONSE"){const h=g.closer.find(p=>p.id.equals(e));h!=null&&(yield Hc({from:g.from,peer:h}))}};let u=!1;for await(const l of this.queryManager.run(e.toBytes(),i,c,t))l.name==="FINAL_PEER"&&(u=!0),yield l;u||(yield vn({from:this.components.peerId,error:E(new Error("Not found"),"ERR_NOT_FOUND")}))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await ao(e),s=this.routingTable.closestPeers(n),i=this,o=new Wne(n,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>await o.add(c)));const a=async function*({peer:c,signal:u}){i.log("closerPeersSingle %s from %p",q(e,"base32"),c);const l=new Qt(Tt.FIND_NODE,e,0);yield*i.network.sendRequest(c,l,{signal:u})};for await(const c of this.queryManager.run(e,s,a,t))yield c,c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async u=>await o.add(u.id)));this.log("found %d peers close to %b",o.length,e);for(const c of o.peers)yield Hc({from:this.components.peerId,peer:{id:c,multiaddrs:(await this.components.peerStore.addressBook.get(c)??[]).map(u=>u.multiaddr),protocols:[]}})}async*getValueOrPeers(e,t,n={}){for await(const s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{const o="invalid record received, discarded";this.log(o),yield vn({from:s.from,error:E(new Error(o),"ERR_INVALID_RECORD")});continue}yield s}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw E(new Error("invalid record received"),"ERR_INVALID_RECORD");await hp(this.validators,new Nt(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=await ao(e),s=this.routingTable.closestPeers(n),i=[];for(const o of s)if(!o.equals(t))try{const a=await this.components.peerStore.addressBook.get(o),c=await this.components.peerStore.protoBook.get(o);i.push({id:o,multiaddrs:a.map(u=>u.multiaddr),protocols:c})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),i}}const fn=O("libp2p:kad-dht:providers");class Qne{constructor(e,t={}){const{cacheSize:n,cleanupInterval:s,provideValidity:i}=t;this.components=e,this.cleanupInterval=s??Xre,this.provideValidity=i??Jre,this.cache=Ga(n??Qre),this.syncQueue=new lt({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{fn.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){return await this.syncQueue.add(async()=>{const e=Date.now();let t=0,n=0;const s=new Map,i=this.components.datastore.batch(),o=this.components.datastore.query({prefix:c9});for await(const a of o)try{const{cid:c,peerId:u}=f9(a.key),l=p9(a.value).getTime(),d=Date.now(),f=d-l,g=f>this.provideValidity;if(fn("comparing: %d - %d = %d > %d %s",d,l,f,this.provideValidity,g?"(expired)":""),g){n++,i.delete(a.key);const h=s.get(c)??new Set;h.add(u),s.set(c,h)}t++}catch(c){fn.error(c.message)}s.size>0?(fn("deleting %d / %d entries",n,t),await i.commit()):fn("nothing to delete");for(const[a,c]of s){const u=va(a),l=this.cache.get(u);if(l!=null){for(const d of c)l.delete(d);l.size===0?this.cache.remove(u):this.cache.set(u,l)}}fn("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){const t=va(e);let n=this.cache.get(t);return n==null&&(n=await Xne(this.components.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){return await this.syncQueue.add(async()=>{fn("%p provides %s",t,e);const n=await this._getProvidersMap(e);fn("loaded %s provs",n.size);const s=new Date;n.set(t.toString(),s);const i=va(e);this.cache.set(i,n),await Jne(this.components.datastore,e,t,s)})}async getProviders(e){return await this.syncQueue.add(async()=>(fn("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(n=>re(n))))}}function va(r){const e=typeof r=="string"?r:q(r.multihash.bytes,"base32");return`${c9}/${e}`}async function Jne(r,e,t,n){const s=[va(e),"/",t.toString()].join(""),i=new J(s),o=Uint8Array.from(ze.encode(n.getTime()));return await r.put(i,o)}function f9(r){const e=r.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:e[3],peerId:e[4]}}async function Xne(r,e){const t=new Map,n=r.query({prefix:va(e)});for await(const s of n){const{peerId:i}=f9(s.key);t.set(i,p9(s.value))}return t}function p9(r){return new Date(ze.decode(r))}const Zne=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*ese(r){const{key:e,startingPeer:t,ourPeerId:n,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,cleanUp:u,queryFuncTimeout:l,log:d,peersSeen:f}=r,g=new lt({concurrency:o}),h=await ao(e);function p(w,y){if(w==null)return;f.add(w);const _=BigInt("0x"+q(Ra(y,h),"base16"));g.add(async()=>{let b;const m=[s];l!=null&&(b=new $e.TimeoutController(l),m.push(b.signal));const S=Jr(m);try{for await(const R of i({key:e,peer:w,signal:S,pathIndex:a,numPaths:c})){if(S.aborted)return;if(R.name==="PEER_RESPONSE")for(const v of R.closer){if(f.has(v.id)){d("already seen %p in query",v.id);continue}if(n.equals(v.id)){d("not querying ourselves");continue}const A=await En(v.id);if(BigInt("0x"+q(Ra(A,h),"base16"))>_){d("skipping %p as they are not closer to %b than %p",v.id,e,w);continue}d("querying closer peer %p",v.id),p(v.id,A)}g.emit("completed",R)}b?.clear()}catch(R){s.aborted?g.emit("error",R):g.emit("completed",vn({from:w,error:R}))}finally{b?.clear()}},{priority:Zne-_}).catch(b=>{d.error(b)})}p(t,await En(t)),yield*tse(g,s,u,d)}async function*tse(r,e,t,n){let s=Bt(),i=!0;const o=[],a=()=>{i&&(n("clean up queue, results %d, queue size %d, pending tasks %d",o.length,r.size,r.pending),i=!1,r.clear(),o.splice(0,o.length))};for(r.on("completed",c=>{o.push(c),s.resolve()}),r.on("error",c=>{n("queue error",c),a(),s.reject(c)}),r.on("idle",()=>{n("queue idle"),i=!1,s.resolve()}),e.addEventListener("abort",()=>{n("abort queue");const c=i;a(),c&&s.reject(E(new Error("Query aborted"),"ERR_QUERY_ABORTED"))}),t.addEventListener("cleanup",()=>{a(),s.resolve()});i;)for(await s.promise,s=Bt();o.length>0;){const c=o.shift();c!=null&&(yield c)}yield*o}const B4="running-queries";class rse{constructor(e,t){const{lan:n=!1,disjointPaths:s=a0,alpha:i=Zu}=t;this.components=e,this.disjointPaths=s??a0,this.controllers=new Set,this.running=!1,this.alpha=i??Zu,this.lan=n,this.queries=0}isStarted(){return this.running}async start(){this.running=!0}async stop(){this.running=!1;for(const e of this.controllers)e.abort();this.controllers.clear()}async*run(e,t,n,s={}){if(!this.running)throw new Error("QueryManager not started");let i;if(s.signal==null){i=new $e.TimeoutController(nne),s.signal=i.signal;try{Se.setMaxListeners!=null&&Se.setMaxListeners(1/0,i.signal)}catch{}}const o=new AbortController;this.controllers.add(o);const a=[o.signal];s.signal!=null&&a.push(s.signal);const c=Jr(a);try{Se.setMaxListeners!=null&&Se.setMaxListeners(1/0,c)}catch{}const u=O(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+q(e,"base58btc")),l=t.slice(0,Math.min(this.disjointPaths,t.length)),d=Date.now(),f=new st;try{if(u("query:start"),this.queries++,this.components.metrics?.updateComponentMetric({system:"libp2p",component:`kad-dht-${this.lan?"lan":"wan"}`,metric:B4,value:this.queries}),t.length===0){u.error("Running query with no peers");return}const g=new Ts,h=l.map((p,w)=>ese({key:e,startingPeer:p,ourPeerId:this.components.peerId,signal:c,query:n,pathIndex:w,numPaths:l.length,alpha:this.alpha,cleanUp:f,queryFuncTimeout:s.queryFuncTimeout,log:u,peersSeen:g}));for await(const p of qt(...h))yield p,p.name==="QUERY_ERROR"&&u("error",p.error)}catch(g){if(!(!this.running&&g.code==="ERR_QUERY_ABORTED"))throw g}finally{this.controllers.delete(o),i?.clear(),this.queries--,this.components.metrics?.updateComponentMetric({system:"libp2p",component:`kad-dht-${this.lan?"lan":"wan"}`,metric:B4,value:this.queries}),f.dispatchEvent(new Z("cleanup")),u("query:done in %dms",Date.now()-d)}}}function nse(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var sse=nse,ise=sse;let ose=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ase=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return g9(this,e)}},cse=class{constructor(e){this.decoders=e}or(e){return g9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const g9=(r,e)=>new cse({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let lse=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new ose(e,t,n),this.decoder=new ase(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const y9=({name:r,prefix:e,encode:t,decode:n})=>new lse(r,e,t,n),w9=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=ise(t,e);return y9({prefix:r,name:e,encode:n,decode:i=>op(s(i))})},use=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},dse=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Fn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>y9({prefix:e,name:r,encode(s){return dse(s,n,t)},decode(s){return use(s,n,t,r)}}),hs=w9({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});w9({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const pl=Fn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Fn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Fn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Fn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Fn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Fn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Fn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Fn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Fn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const hse=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return pse(t,d0(r),e||hs.encoder);default:return gse(t,d0(r),e||pl.encoder)}},z4=new WeakMap,d0=r=>{const e=z4.get(r);if(e==null){const t=new Map;return z4.set(r,t),t}return e};let yt=class{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Qo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==yse)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return yt.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=o0(e,t);return yt.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return yt.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&jre(e.multihash,n.multihash)}toString(e){return hse(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof yt)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new yt(n,s,i,o||F4(n,s,i.bytes))}else if(t[wse]===!0){const{version:n,multihash:s,code:i}=t,o=Vre(s);return yt.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Qo)throw new Error(`Version 0 CID must use dag-pb (code: ${Qo}) block encoding`);return new yt(e,t,n,n.bytes)}case 1:{const s=F4(e,t,n.bytes);return new yt(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return yt.create(0,Qo,e)}static createV1(e,t){return yt.create(1,e,t)}static decode(e){const[t,n]=yt.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=yt.inspectBytes(e),n=t.size-t.multihashSize,s=op(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new ap(t.multihashCode,t.digestSize,i,s);return[t.version===0?yt.createV0(o):yt.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=i0(e.subarray(t));return t+=f,d};let s=n(),i=Qo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=fse(e,t),i=yt.decode(s);return d0(i).set(n,e),i}};const fse=(r,e)=>{switch(r[0]){case"Q":{const t=e||hs;return[hs.prefix,t.decode(`${hs.prefix}${r}`)]}case hs.prefix:{const t=e||hs;return[hs.prefix,t.decode(r)]}case pl.prefix:{const t=e||pl;return[pl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},pse=(r,e,t)=>{const{prefix:n}=t;if(n!==hs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},gse=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Qo=112,yse=18,F4=(r,e,t)=>{const n=Xu(r),s=n+Xu(e),i=new Uint8Array(s+t.byteLength);return Ju(r,i,0),Ju(e,i,n),i.set(t,s),i},wse=Symbol.for("@ipld/js-cid/CID"),Jo=O("libp2p:kad-dht:rpc:handlers:add-provider");class mse{constructor(e){const{providers:t}=e;this.providers=t}async handle(e,t){if(Jo("start"),t.key==null||t.key.length===0)throw E(new Error("Missing key"),"ERR_MISSING_KEY");let n;try{n=yt.decode(t.key)}catch{throw E(new Error("Invalid CID"),"ERR_INVALID_CID")}(t.providerPeers==null||t.providerPeers.length===0)&&Jo.error("no providers found in message"),await Promise.all(t.providerPeers.map(async s=>{if(!s.id.equals(e)){Jo("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){Jo("no valid addresses for provider %p. Ignore",e);return}Jo("received provider %p for %s (addrs %s)",e,n,s.multiaddrs.map(i=>i.toString())),await this.providers.addProvider(n,s.id)}))}}const V4=O("libp2p:kad-dht:rpc:handlers:find-node");class bse{constructor(e,t){const{peerRouting:n,lan:s}=t;this.components=e,this.peerRouting=n,this.lan=Boolean(s)}async handle(e,t){V4("incoming request from %p for peers closer to %b",e,t.key);let n=[];Dt(this.components.peerId.toBytes(),t.key)?n=[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(i=>i.decapsulateCode(od("p2p").code)),protocols:[]}]:n=await this.peerRouting.getCloserPeersOffline(t.key,e),n=n.map(this.lan?dp:up).filter(({multiaddrs:i})=>i.length);const s=new Qt(t.type,new Uint8Array(0),t.clusterLevel);return n.length>0?s.closerPeers=n:V4("could not find any peers closer to %b than %p",t.key,e),s}}const j4=O("libp2p:kad-dht:rpc:handlers:get-providers");class Ese{constructor(e,t){const{peerRouting:n,providers:s,lan:i}=t;this.components=e,this.peerRouting=n,this.providers=s,this.lan=Boolean(i)}async handle(e,t){let n;try{n=yt.decode(t.key)}catch{throw E(new Error("Invalid CID"),"ERR_INVALID_CID")}j4("%p asking for providers for %s",e,n);const[s,i]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(s),a=await this._getPeers(i.map(({id:u})=>u)),c=new Qt(t.type,t.key,t.clusterLevel);return o.length>0&&(c.providerPeers=o),a.length>0&&(c.closerPeers=a),j4("got %s providers %s closerPeers",o.length,a.length),c}async _getAddresses(e){return(await this.components.peerStore.addressBook.get(e)).map(n=>n.multiaddr)}async _getPeers(e){const t=[],n=this.lan?dp:up;for(const s of e){const i=n({id:s,multiaddrs:await this._getAddresses(s),protocols:[]});i.multiaddrs.length>0&&t.push(i)}return t}}const Ri=O("libp2p:kad-dht:rpc:handlers:get-value");class _se{constructor(e,t){const{peerRouting:n}=t;this.components=e,this.peerRouting=n}async handle(e,t){const n=t.key;if(Ri("%p asked for key %b",e,n),n==null||n.length===0)throw E(new Error("Invalid key"),"ERR_INVALID_KEY");const s=new Qt(Tt.GET_VALUE,n,t.clusterLevel);if(one(n)){Ri("is public key");const a=ane(n);let c;try{const u=await this.components.peerStore.keyBook.get(a);if(u==null)throw E(new Error("No public key found in key book"),"ERR_NOT_FOUND");c=u}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u}if(c!=null)return Ri("returning found public key"),s.record=new Nt(n,c,new Date),s}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(t.key,e)]);return i!=null&&(Ri("had record for %b in local datastore",n),s.record=i),o.length>0&&(Ri("had %s closer peers in routing table",o.length),s.closerPeers=o),s}async _checkLocalDatastore(e){Ri("checkLocalDatastore looking for %b",e);const t=ki(e);let n;try{n=await this.components.datastore.get(t)}catch(i){if(i.code==="ERR_NOT_FOUND")return;throw i}const s=Nt.deserialize(n);if(s==null)throw E(new Error("Invalid record"),"ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>qre){await this.components.datastore.delete(t);return}return s}}const vse=O("libp2p:kad-dht:rpc:handlers:ping");class Sse{async handle(e,t){return vse("ping from %p",e),t}}class Rse{constructor(e,t){const{validators:n}=t;this.components=e,this.log=O("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=n}async handle(e,t){const n=t.key;this.log("%p asked us to store value for key %b",e,n);const s=t.record;if(s==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),E(new Error(i),"ERR_EMPTY_RECORD")}try{await hp(this.validators,s),s.timeReceived=new Date;const i=ki(s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}}class Ise{constructor(e,t){const{providers:n,peerRouting:s,validators:i,lan:o}=t;this.log=O("libp2p:kad-dht:rpc"),this.routingTable=t.routingTable,this.handlers={[Tt.GET_VALUE]:new _se(e,{peerRouting:s}),[Tt.PUT_VALUE]:new Rse(e,{validators:i}),[Tt.FIND_NODE]:new bse(e,{peerRouting:s,lan:o}),[Tt.ADD_PROVIDER]:new mse({providers:n}),[Tt.GET_PROVIDERS]:new Ese(e,{peerRouting:s,providers:n,lan:o}),[Tt.PING]:new Sse}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(s){this.log.error("Failed to update the kbucket store",s)}const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}return await n.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{const{stream:t,connection:n}=e,s=n.remotePeer;try{await this.routingTable.add(s)}catch(o){this.log.error(o)}const i=this;await ne(t,Gr(),async function*(o){for await(const a of o){const c=Qt.deserialize(a);i.log("incoming %s from %p",c.type,s);const u=await i.handleMessage(s,c);u!=null&&(yield u.serialize())}},Dr(),t)}).catch(t=>{this.log.error(t)})}}class Ase extends st{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=O(`libp2p:kad-dht:topology-listener:${s?"lan":"wan"}`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){if(this.running)return;this.running=!0;const e=L2({onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new Z("peer",{detail:t}))}});this.registrarId=await this.components.registrar.register(this.protocol,e)}stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class Cse{constructor(e,t){const{peerRouting:n,lan:s,count:i,interval:o,queryTimeout:a}=t;this.components=e,this.log=O(`libp2p:kad-dht:${s?"lan":"wan"}:query-self`),this.running=!1,this.peerRouting=n,this.count=i??a0,this.interval=o??Zre,this.queryTimeout=a??ene}isStarted(){return this.running}async start(){this.running||(this.running=!0,this._querySelf())}async stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}_querySelf(){Promise.resolve().then(async()=>{const e=new $e.TimeoutController(this.queryTimeout);try{this.controller=new AbortController;const t=Jr([this.controller.signal,e.signal]);try{Se.setMaxListeners!=null&&Se.setMaxListeners(1/0,t)}catch{}const n=await ne(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:t}),s=>Ta(s,this.count),async s=>await Xi(s));this.log("query ran successfully - found %d peers",n)}catch(t){this.log("query error",t)}finally{this.timeoutId=setTimeout(this._querySelf.bind(this),this.interval),e.clear()}}).catch(e=>{this.log("query error",e)})}}const Tse=32,Dse=64;let K4=class extends st{constructor(e,t){super();const{kBucketSize:n,clientMode:s,validators:i,selectors:o,querySelfInterval:a,lan:c,protocolPrefix:u,pingTimeout:l,pingConcurrency:d,maxInboundStreams:f,maxOutboundStreams:g}=t;this.running=!1,this.components=e,this.lan=Boolean(c),this.log=O(`libp2p:kad-dht:${c===!0?"lan":"wan"}`),this.protocol=`${u??Gre}${c===!0?Hre:""}${Wre}`,this.kBucketSize=n??20,this.clientMode=s??!0,this.maxInboundStreams=f??Tse,this.maxOutboundStreams=g??Dse,this.routingTable=new gne(e,{kBucketSize:n,lan:this.lan,pingTimeout:l,pingConcurrency:d,protocol:this.protocol}),this.providers=new Qne(e),this.validators={...Vne,...i},this.selectors={...qne,...o},this.network=new Ene(e,{protocol:this.protocol,lan:this.lan}),this.queryManager=new rse(e,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:c}),this.peerRouting=new Yne(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new Hne(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,network:this.network,lan:this.lan}),this.contentRouting=new Gne(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new wne({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new Ise(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new Ase(e,{protocol:this.protocol,lan:this.lan}),this.querySelf=new Cse(e,{peerRouting:this.peerRouting,interval:a,lan:this.lan}),this.network.addEventListener("peer",h=>{const p=h.detail;this.onPeerConnect(p).catch(w=>{this.log.error("could not add %p to routing table",p.id,w)}),this.dispatchEvent(new Z("peer",{detail:p}))}),this.topologyListener.addEventListener("peer",h=>{const p=h.detail;Promise.resolve().then(async()=>{const w=await this.components.peerStore.addressBook.get(p),y={id:p,multiaddrs:w.map(_=>_.multiaddr),protocols:[]};await this.onPeerConnect(y)}).catch(w=>{this.log.error("could not add %p to routing table",p,w)})})}get[ad](){return!0}get[Symbol.toStringTag](){return"@libp2p/kad-dht"}async onPeerConnect(e){if(this.log("peer %p connected with protocols %s",e.id,e.protocols),this.lan?e=dp(e):e=up(e),e.multiaddrs.length===0){this.log("ignoring %p as they do not have any %s addresses in %s",e.id,this.lan?"private":"public",e.multiaddrs.map(t=>t.toString()));return}try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start(),this.querySelf.start()]),await this.routingTableRefresh.start()}async stop(){this.running=!1,await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop(),this.querySelf.stop()])}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){await this.routingTableRefresh.refreshTable(!0)}};const Pse=O("libp2p:kad-dht");class kse extends st{constructor(e,t,n){super(),this.components=e,this.wan=t,this.lan=n,this.wan.addEventListener("peer",s=>{this.dispatchEvent(new Z("peer",{detail:s.detail}))}),this.lan.addEventListener("peer",s=>{this.dispatchEvent(new Z("peer",{detail:s.detail}))})}get[ad](){return!0}get[Symbol.toStringTag](){return"@libp2p/dual-kad-dht"}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return await this.wan.getMode()}async setMode(e){await this.wan.setMode(e)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(e,t,n={}){for await(const s of qt(this.lan.put(e,t,n),this.wan.put(e,t,n)))yield s}async*get(e,t={}){let n=!1,s=!1;for await(const i of qt(this.lan.get(e,t),this.wan.get(e,t)))yield i,i.name==="DIALING_PEER"&&(n=!0),i.name==="VALUE"&&(n=!0,i.value!=null&&(s=!0)),i.name==="SENDING_QUERY"&&(n=!0);if(!n)throw E(new Error("No peers found in routing table!"),"ERR_NO_PEERS_IN_ROUTING_TABLE");s||(yield vn({from:this.components.peerId,error:E(new Error("Not found"),"ERR_NOT_FOUND")}))}async*provide(e,t={}){let n=0,s=0;const i=[],o=[this.lan];await this.wan.getMode()==="server"&&o.push(this.wan);for await(const a of qt(...o.map(c=>c.provide(e,t))))yield a,a.name==="SENDING_QUERY"&&n++,a.name==="QUERY_ERROR"&&i.push(a.error),a.name==="PEER_RESPONSE"&&a.messageName==="ADD_PROVIDER"&&(Pse("sent provider record for %s to %p",e,a.from),s++);if(s===0)throw i.length>0?E(new Error(`Failed to provide to ${i.length} of ${n} peers`),"ERR_PROVIDES_FAILED",{errors:i}):E(new Error("Failed to provide - no peers found"),"ERR_PROVIDES_FAILED")}async*findProviders(e,t={}){yield*qt(this.lan.findProviders(e,t),this.wan.findProviders(e,t))}async*findPeer(e,t={}){let n=!1;for await(const s of qt(this.lan.findPeer(e,t),this.wan.findPeer(e,t)))yield s,(s.name==="SENDING_QUERY"||s.name==="FINAL_PEER")&&(n=!0);if(!n)throw E(new Error("Peer lookup failed"),"ERR_LOOKUP_FAILED")}async*getClosestPeers(e,t={}){yield*qt(this.lan.getClosestPeers(e,t),this.wan.getClosestPeers(e,t))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}}class Ose extends kse{constructor(e,t){super(e,new K4(e,{protocolPrefix:"/ipfs",...t,lan:!1}),new K4(e,{protocolPrefix:"/ipfs",...t,clientMode:!1,lan:!0}))}}function Nse(r){return e=>new Ose(e,r)}const Gc=O("libp2p:bootstrap"),xse="bootstrap",$se=50,Lse=12e4,Mse=1e3;class m9 extends st{constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.timeout=t.timeout??Mse,this.list=[];for(const n of t.list){if(!CE.matches(n)){Gc.error("Invalid multiaddr");continue}const s=X(n),i=s.getPeerId();if(i==null){Gc.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:re(i),multiaddrs:[s],protocols:[]};this.list.push(o)}this._init=t}get[ad](){return!0}get[Symbol.toStringTag](){return"@libp2p/bootstrap"}isStarted(){return Boolean(this.timer)}start(){this.isStarted()||(Gc("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{Gc.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.tagPeer(e.id,this._init.tagName??xse,{value:this._init.tagValue??$se,ttl:this._init.tagTTL??Lse}),this.timer==null)return;this.dispatchEvent(new Z("peer",{detail:e}))}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}m9.tag="bootstrap";function Use(r){return e=>new m9(e,r)}function q4(r){return new Uint8Array(r)}var de;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(de||(de={}));const fp=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),H4=Object.freeze({NEW_STREAM:de.NEW_STREAM,MESSAGE:de.MESSAGE_INITIATOR,CLOSE:de.CLOSE_INITIATOR,RESET:de.RESET_INITIATOR}),Bse=Object.freeze({MESSAGE:de.MESSAGE_RECEIVER,CLOSE:de.CLOSE_RECEIVER,RESET:de.RESET_RECEIVER}),G4=1024*1024,zse=(r,e)=>e.append(r);async function*Fse(r,e={}){let t=new Pt,n=!1,s=Bt(),i=Number(e.size??G4);(isNaN(i)||i===0||i<0)&&(i=G4);const o=e.yieldAfter??0,a=e.serialize??zse;for(Promise.resolve().then(async()=>{try{let c;for await(const u of r){if(a(u,t),t.byteLength>=i){clearTimeout(c),s.resolve();continue}c=setTimeout(()=>{s.resolve()},o)}clearTimeout(c),s.resolve()}catch(c){s.reject(c)}finally{n=!0}});!n;)if(await s.promise,s=Bt(),t.byteLength>0){const c=t;t=new Pt,yield c.subarray()}}const of=10*1024;let Vse=class{constructor(){this._pool=q4(of),this._poolOffset=0}write(e,t){const n=this._pool;let s=this._poolOffset;ze.encode(e.id<<3|e.type,n,s),s+=ze.encode.bytes??0,(e.type===de.NEW_STREAM||e.type===de.MESSAGE_INITIATOR||e.type===de.MESSAGE_RECEIVER)&&e.data!=null?ze.encode(e.data.length,n,s):ze.encode(0,n,s),s+=ze.encode.bytes??0;const i=n.subarray(this._poolOffset,s);of-s<100?(this._pool=q4(of),this._poolOffset=0):this._poolOffset=s,t.append(i),(e.type===de.NEW_STREAM||e.type===de.MESSAGE_INITIATOR||e.type===de.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const W4=new Vse;async function*jse(r,e=0){if(e==null||e===0){for await(const t of r){const n=new Pt;for(const s of t)W4.write(s,n);yield n.subarray()}return}yield*Fse(r,{size:e,serialize:(t,n)=>{for(const s of t)W4.write(s,n)}})}const b9=1<<20,Kse=4<<20;let qse=class{constructor(e=b9,t=Kse){this._buffer=new Pt,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(u){if(u.code==="ERR_MSG_TOO_BIG")throw u;break}const{id:n,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;const c={id:n,type:s};(s===de.NEW_STREAM||s===de.MESSAGE_INITIATOR||s===de.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),t.push(c),this._buffer.consume(o+i),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=Q4(e),{value:s,offset:i}=Q4(e,n),o=t&7;if(fp[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+i,length:s}}};const Hse=128,Y4=127;function Q4(r,e=0){let t=0,n=0,s=e,i;const o=r.length;do{if(s>=o||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(s++),t+=n<28?(i&Y4)<<n:(i&Y4)*Math.pow(2,n),n+=7}while(i>=Hse);return e=s-e,{value:t,offset:e}}const mr=O("libp2p:mplex:stream"),af="ERR_STREAM_RESET",Gse="ERR_STREAM_ABORT",Wse="ERR_SINK_ENDED",Yse="ERR_DOUBLE_SINK";function Qse(r){const{id:e,name:t,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=b9}=r,a=new AbortController,c=new AbortController,u=new AbortController,l=i==="initiator"?H4:Bse,d=i==="initiator"?`i${e}`:`r${e}`,f=`${t??e}`;let g=!1,h=!1,p=!1,w;const y={open:Date.now()},_=R=>{g||(g=!0,mr.trace("%s stream %s source end - err: %o",i,f,R),R!=null&&w==null&&(w=R),h&&(S.stat.timeline.close=Date.now(),s?.(w)))},b=R=>{h||(h=!0,mr.trace("%s stream %s sink end - err: %o",i,f,R),R!=null&&w==null&&(w=R),g&&(y.close=Date.now(),s?.(w)))},m=dr({onEnd:_}),S={close:()=>{mr.trace("%s stream %s close",i,f),S.closeRead(),S.closeWrite()},closeRead:()=>{mr.trace("%s stream %s closeRead",i,f),!g&&m.end()},closeWrite:()=>{if(mr.trace("%s stream %s closeWrite",i,f),!h){u.abort();try{n({id:e,type:l.CLOSE})}catch(R){mr.trace("%s stream %s error sending close",i,t,R)}b()}},abort:R=>{mr.trace("%s stream %s abort",i,f,R),m.end(R),a.abort(),b(R)},reset:()=>{const R=E(new Error("stream reset"),af);c.abort(),m.end(R),b(R)},sink:async R=>{if(p)throw E(new Error("sink already called on stream"),Yse);if(p=!0,h)throw E(new Error("stream closed for writing"),Wse);R=Ps(R,Jr([a.signal,c.signal,u.signal]));try{i==="initiator"&&n({id:e,type:H4.NEW_STREAM,data:new Pt(M(f))});for await(let v of R)for(;v.length>0;){if(v.length<=o){n({id:e,type:l.MESSAGE,data:v instanceof Uint8Array?new Pt(v):v});break}v=v instanceof Uint8Array?new Pt(v):v,n({id:e,type:l.MESSAGE,data:v.sublist(0,o)}),v.consume(o)}}catch(v){if(v.type==="aborted"&&v.message==="The operation was aborted"){if(u.signal.aborted)return;c.signal.aborted&&(v.message="stream reset",v.code=af),a.signal.aborted&&(v.message="stream aborted",v.code=Gse)}if(v.code===af)mr.trace("%s stream %s reset",i,t);else{mr.trace("%s stream %s error",i,t,v);try{n({id:e,type:l.RESET})}catch(A){mr.trace("%s stream %s error sending reset",i,t,A)}}m.end(v),b(v);return}try{n({id:e,type:l.CLOSE})}catch(v){mr.trace("%s stream %s error sending close",i,t,v)}b()},source:m,sourcePush:R=>{m.push(R)},sourceReadableLength(){return m.readableLength},stat:{direction:i==="initiator"?"outbound":"inbound",timeline:y},metadata:{},id:d};return S}const br=O("libp2p:mplex"),Jse=1024,Xse=1024,Zse=1024*1024*4,eie=5;function J4(r){const e={...r,type:`${fp[r.type]} (${r.type})`};return r.type===de.NEW_STREAM&&(e.data=q(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===de.MESSAGE_INITIATOR||r.type===de.MESSAGE_RECEIVER)&&(e.data=q(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class tie{constructor(e){this.protocol="/mplex/6.7.0",e=e??{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.sink=this._createSink();const t=this._createSource();this._source=t,this.source=t,this.closeController=new AbortController,this.rateLimiter=new Ab.RateLimiterMemory({points:e.disconnectThreshold??eie,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}close(e){this.closeController.signal.aborted||(e!=null?this.streams.forEach(t=>t.abort(e)):this.streams.forEach(t=>t.close()),this.closeController.abort())}_newReceiverStream(e){const{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){const{id:t,name:n,type:s,registry:i}=e;if(br("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??Xse))throw E(new Error("Too many outbound streams open"),"ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(t))throw new Error(`${s} stream ${t} already exists!`);const c=Qse({id:t,name:n,send:u=>{br.enabled&&br.trace("%s stream %s send",s,t,J4(u)),this._source.push(u)},type:s,onEnd:()=>{br("%s stream with id %s and protocol %s ended",s,t,c.stat.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize});return i.set(t,c),c}_createSink(){return async t=>{const n=[this.closeController.signal];this._init.signal!=null&&n.push(this._init.signal),t=Ps(t,js(n));try{const s=new qse(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const i of t)for(const o of s.write(i))await this._handleIncoming(o);this._source.end()}catch(s){br("error in sink",s),this._source.end(s)}}}_createSource(){const t=mE({objectMode:!0,onEnd:n=>{this.close(n)}});return Object.assign(jse(t,this._init.minSendBytes),{push:t.push,end:t.end,return:t.return})}async _handleIncoming(e){const{id:t,type:n}=e;if(br.enabled&&br.trace("incoming message",J4(e)),e.type===de.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??Jse)){br("too many inbound streams open"),this._source.push({id:t,type:de.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{br("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this._source.end(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:q(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){br("missing stream %s for message type %s",t,fp[n]);return}const o=this._init.maxStreamBufferSize??Zse;switch(n){case de.MESSAGE_INITIATOR:case de.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o){this._source.push({id:e.id,type:n===de.MESSAGE_INITIATOR?de.RESET_RECEIVER:de.RESET_INITIATOR});const a=E(new Error("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers"),"ERR_STREAM_INPUT_BUFFER_FULL");i.abort(a);return}i.sourcePush(e.data);break;case de.CLOSE_INITIATOR:case de.CLOSE_RECEIVER:i.closeRead();break;case de.RESET_INITIATOR:case de.RESET_RECEIVER:i.reset();break;default:br("unknown message type %s",n)}}}class rie{constructor(e={}){this.protocol="/mplex/6.7.0",this._init=e}createStreamMuxer(e={}){return new tie({...e,...this._init})}}function nie(r={}){return()=>new rie(r)}const sie=Le.bind({ignoreUndefined:!0,concatArrays:!0});function pp({options:r={},peerId:e,multiaddrs:t=[],repo:n,keychainConfig:s={},config:i={}}){const{datastore:o}=n,a=iie({options:r,config:i,datastore:o,keychainConfig:s,peerId:e,multiaddrs:t});return typeof r.libp2p=="function"?r.libp2p({libp2pOptions:a,options:r,config:i,datastore:o,peerId:e}):Ere(a)}function iie({options:r,config:e,datastore:t,keychainConfig:n,peerId:s,multiaddrs:i}){const o=()=>{const g=oe(e,"Pubsub.Router")||"gossipsub",h=gq();if(!h[g])throw E(new Error(`Router unavailable. Configure libp2p.modules.pubsub to use the ${g} router.`),"ERR_NOT_SUPPORTED");return h[g]},a={datastore:t,peerId:s},c={addresses:{listen:i.map(g=>g.toString()),announce:oe(r,"addresses.announce",oe(e,"Addresses.Announce",[])),noAnnounce:oe(r,"addresses.noAnnounce",oe(e,"Addresses.NoAnnounce",[]))},connectionManager:oe(r,"connectionManager",{maxConnections:oe(r,"config.Swarm.ConnMgr.HighWater",oe(e,"Swarm.ConnMgr.HighWater")),minConnections:oe(r,"config.Swarm.ConnMgr.LowWater",oe(e,"Swarm.ConnMgr.LowWater"))}),keychain:n,identify:{host:{agentVersion:`js-ipfs/${nu}`}},contentRouters:[],peerRouters:[],peerDiscovery:[],transports:[],streamMuxers:[nie({maxInboundStreams:256,maxOutboundStreams:1024})],connectionEncryption:[bE()],relay:{enabled:oe(r,"relay.enabled",oe(e,"relay.enabled",!0)),hop:{enabled:oe(r,"relay.hop.enabled",oe(e,"relay.hop.enabled",!1)),active:oe(r,"relay.hop.active",oe(e,"relay.hop.active",!1))}},nat:{enabled:!oe(e,"Swarm.DisableNatPortMap",!1)}};oe(r,"config.Pubsub.Enabled",oe(e,"Pubsub.Enabled",!0))&&(c.pubsub=o()),oe(e,"Routing.Type","dhtclient")!=="none"&&(c.dht=Nse({clientMode:oe(e,"Routing.Type","dht")!=="dhtserver",kBucketSize:oe(r,"dht.kBucketSize",20),validators:{ipns:G0},selectors:{ipns:j8}}));const u=oe(r,"config.Bootstrap",oe(e,"Bootstrap",[]));u.length>0&&c.peerDiscovery?.push(Use({list:u}));let l=oe(r,"libp2p",void 0);typeof l=="function"&&(l=void 0);const d=sie(a,rJ(),c,l),f=oe(r,"config.Addresses.Delegates",oe(e,"Addresses.Delegates",[]));if(f.length>0){const g=f[Math.floor(Math.random()*f.length)],h=X(g).toOptions(),p={host:h.host,protocol:parseInt(h.port)===443?"https":"http",port:h.port},w=tJ(p);d.contentRouters?.push(sH(w)),d.peerRouters?.push(eH(w))}return oe(r,"config.Discovery.MDNS.Enabled",oe(e,"Discovery.MDNS.Enabled",!0))||(d.peerDiscovery=d.peerDiscovery?.filter(g=>{try{if(typeof g=="function")return g({})[Symbol.toStringTag]!=="@libp2p/mdns"}catch{}return!0})),d.transports==null&&(d.transports=[]),d.transports.find(g=>{try{if(typeof g=="function")return g({})[Symbol.toStringTag]==="@libp2p/websockets"}catch{}return!1})==null&&d.transports.push(TE()),d}const E9=Le.bind({ignoreUndefined:!0}),Sa=O("ipfs:components:peer:storage");class gp{constructor(e,t,n,s,i){this.print=s,this.peerId=e,this.keychain=t,this.repo=n,this.print=s,this.isNew=i}static async start(e,t,n){const{repoAutoMigrate:s,repo:i,onMigrationProgress:o}=n,a=typeof i=="string"||i==null?jj(e,t,{path:i,autoMigrate:s,onMigrationProgress:o}):i,{peerId:c,keychain:u,isNew:l}=await oie(e,a,n);return new gp(c,u,a,e,l)}}const oie=async(r,e,t)=>{if(!e.closed)return{...await X4(e,t),isNew:!1};try{return await e.open(),{...await X4(e,t),isNew:!1}}catch(n){if(n.code!==ia)throw n;if(t.init&&t.init.allowNew===!1)throw new lo("Initialization of new repos disabled by config, pass `config.init.isNew: true` to enable it");return{...await aie(r,e,t),isNew:!0}}},aie=async(r,e,t)=>{const n=t.init||{},s=await e.exists();if(Sa("repo exists?",s),s===!0)throw new Error("repo already exists");const i=n.privateKey?await cie(n.privateKey):await lie(r,n),o=uie(i);Sa("peer identity: %s",o.PeerID);const a={...E9(_9($i(),n.profiles),t.config),Identity:o};await e.init(a),await e.open(),Sa("repo opened");const c={pass:t.pass};try{c.dek=await e.config.get("Keychain.DEK")}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}const u=await pp({options:void 0,multiaddrs:void 0,peerId:i,repo:e,config:a,keychainConfig:c});return await e.datastore.has(new J("/info/self"))||await u.keychain.importPeer("self",i),await e.config.set("Keychain",{DEK:u.keychain.init.dek}),{peerId:i,keychain:u.keychain}},cie=async r=>{if(Sa("using user-supplied private-key"),Ys(r))return r;const e=M(r,"base64pad"),t=await oi(e);return await Sn(t.public.bytes,t.bytes)},lie=(r,{algorithm:e="Ed25519",bits:t=2048})=>{if(r("generating %s keypair...",e),e==="Ed25519")return r9();if(e==="RSA")return ore({bits:t});throw E(new Error("Unknown PeerId algorithm"),"ERR_UNKNOWN_PEER_ID_ALGORITHM")},uie=r=>{if(r.privateKey==null)throw E(new Error("Private key missing"),"ERR_MISSING_PRIVATE_KEY");return{PeerID:r.toString(),PrivKey:q(r.privateKey,"base64pad")}},X4=async(r,e)=>{const t=e.config,n=e.init&&e.init.profiles||[],s=e.pass,i=await r.config.getAll(),o=die(_9(i,n),t);if(i!==o&&await r.config.replace(o),!o.Identity||!o.Identity.PrivKey)throw new Ka("No private key was found in the config, please intialize the repo");const a=M(o.Identity.PrivKey,"base64pad"),c=await oi(a),u=await Sn(c.public.bytes,c.bytes),l=await pp({options:void 0,multiaddrs:void 0,peerId:u,repo:r,config:o,keychainConfig:{pass:s,...o.Keychain}});return{peerId:u,keychain:l.keychain}},die=(r,e)=>e?E9(r,e):r,_9=(r,e)=>(e||[]).reduce((t,n)=>{const s=su[n];if(!s)throw new Error(`Could not find profile with name '${n}'`);return Sa("applying profile %s",n),s.transform(t)},r);var hie=v9,Z4=128,fie=127,pie=~fie,gie=Math.pow(2,31);function v9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=gie;)e[t++]=r&255|Z4,r/=128;for(;r&pie;)e[t++]=r&255|Z4,r>>>=7;return e[t]=r|0,v9.bytes=t-n+1,e}var yie=h0,wie=128,e6=127;function h0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw h0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&e6)<<s:(o&e6)*Math.pow(2,s),s+=7}while(o>=wie);return h0.bytes=i-n,t}var mie=Math.pow(2,7),bie=Math.pow(2,14),Eie=Math.pow(2,21),_ie=Math.pow(2,28),vie=Math.pow(2,35),Sie=Math.pow(2,42),Rie=Math.pow(2,49),Iie=Math.pow(2,56),Aie=Math.pow(2,63),Cie=function(r){return r<mie?1:r<bie?2:r<Eie?3:r<_ie?4:r<vie?5:r<Sie?6:r<Rie?7:r<Iie?8:r<Aie?9:10},Tie={encode:hie,decode:yie,encodingLength:Cie},ed=Tie;const f0=(r,e=0)=>[ed.decode(r,e),ed.decode.bytes],td=(r,e,t=0)=>(ed.encode(r,e,t),e),rd=r=>ed.encodingLength(r),Die=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},yp=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},p0=(r,e)=>{const t=e.byteLength,n=rd(r),s=n+rd(t),i=new Uint8Array(s+t);return td(r,i,0),td(t,i,n),i.set(e,s),new wp(r,t,e,i)},Pie=r=>{const e=yp(r),[t,n]=f0(e),[s,i]=f0(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new wp(t,s,o,e)},kie=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Die(r.bytes,t.bytes)}};class wp{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}function Oie(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Nie=Oie,xie=Nie;let $ie=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Lie=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return S9(this,e)}},Mie=class{constructor(e){this.decoders=e}or(e){return S9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const S9=(r,e)=>new Mie({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Uie=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new $ie(e,t,n),this.decoder=new Lie(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const R9=({name:r,prefix:e,encode:t,decode:n})=>new Uie(r,e,t,n),I9=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=xie(t,e);return R9({prefix:r,name:e,encode:n,decode:i=>yp(s(i))})},Bie=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},zie=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Vn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>R9({prefix:e,name:r,encode(s){return zie(s,n,t)},decode(s){return Bie(s,n,t,r)}}),ke=I9({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});I9({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const gl=Vn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Vn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Vn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Vn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Vn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Vn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Vn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Vn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Vn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Fie=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return jie(t,g0(r),e||ke.encoder);default:return Kie(t,g0(r),e||gl.encoder)}},t6=new WeakMap,g0=r=>{const e=t6.get(r);if(e==null){const t=new Map;return t6.set(r,t),t}return e};class ve{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Xo)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==qie)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return ve.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=p0(e,t);return ve.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return ve.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&kie(e.multihash,n.multihash)}toString(e){return Fie(this,e)}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof ve)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new ve(n,s,i,o||r6(n,s,i.bytes))}else if(t[Hie]===!0){const{version:n,multihash:s,code:i}=t,o=Pie(s);return ve.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Xo)throw new Error(`Version 0 CID must use dag-pb (code: ${Xo}) block encoding`);return new ve(e,t,n,n.bytes)}case 1:{const s=r6(e,t,n.bytes);return new ve(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return ve.create(0,Xo,e)}static createV1(e,t){return ve.create(1,e,t)}static decode(e){const[t,n]=ve.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=ve.inspectBytes(e),n=t.size-t.multihashSize,s=yp(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new wp(t.multihashCode,t.digestSize,i,s);return[t.version===0?ve.createV0(o):ve.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=f0(e.subarray(t));return t+=f,d};let s=n(),i=Xo;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Vie(e,t),i=ve.decode(s);return g0(i).set(n,e),i}}const Vie=(r,e)=>{switch(r[0]){case"Q":{const t=e||ke;return[ke.prefix,t.decode(`${ke.prefix}${r}`)]}case ke.prefix:{const t=e||ke;return[ke.prefix,t.decode(r)]}case gl.prefix:{const t=e||gl;return[gl.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},jie=(r,e,t)=>{const{prefix:n}=t;if(n!==ke.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Kie=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Xo=112,qie=18,r6=(r,e,t)=>{const n=rd(r),s=n+rd(e),i=new Uint8Array(s+t.byteLength);return td(r,i,0),td(e,i,n),i.set(t,s),i},Hie=Symbol.for("@ipld/js-cid/CID"),A9=({name:r,code:e,encode:t})=>new Gie(r,e,t);class Gie{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?p0(this.code,t):t.then(n=>p0(this.code,n))}else throw Error("Unknown type, must be binary type")}}const C9=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),cf=A9({name:"sha2-256",code:18,encode:C9("SHA-256")});A9({name:"sha2-512",code:19,encode:C9("SHA-512")});var Wie=T9,n6=128,Yie=127,Qie=~Yie,Jie=Math.pow(2,31);function T9(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Jie;)e[t++]=r&255|n6,r/=128;for(;r&Qie;)e[t++]=r&255|n6,r>>>=7;return e[t]=r|0,T9.bytes=t-n+1,e}var Xie=y0,Zie=128,s6=127;function y0(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw y0.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&s6)<<s:(o&s6)*Math.pow(2,s),s+=7}while(o>=Zie);return y0.bytes=i-n,t}var eoe=Math.pow(2,7),toe=Math.pow(2,14),roe=Math.pow(2,21),noe=Math.pow(2,28),soe=Math.pow(2,35),ioe=Math.pow(2,42),ooe=Math.pow(2,49),aoe=Math.pow(2,56),coe=Math.pow(2,63),loe=function(r){return r<eoe?1:r<toe?2:r<roe?3:r<noe?4:r<soe?5:r<ioe?6:r<ooe?7:r<aoe?8:r<coe?9:10},uoe={encode:Wie,decode:Xie,encodingLength:loe};const i6=uoe;var doe=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=i6.decode(r);e.push(t),r=r.slice(i6.decode.bytes)}return e};function hoe(r){let e=new Uint8Array(r.reduce((n,s)=>n+ze.encodingLength(s),0)),t=0;for(const n of r)e=ze.encode(n,e,t),t+=ze.encodingLength(n);return e}class D9{constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t||1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(ke)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}}const xr=j.Reader,Zo=j.Writer,le=j.util,ie=j.roots["ipfs-bitswap"]||(j.roots["ipfs-bitswap"]={}),Cr=ie.Message=(()=>{function r(e){if(this.blocks=[],this.payload=[],this.blockPresences=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.wantlist=null,r.prototype.blocks=le.emptyArray,r.prototype.payload=le.emptyArray,r.prototype.blockPresences=le.emptyArray,r.prototype.pendingBytes=0,r.encode=function(t,n){if(n||(n=Zo.create()),t.wantlist!=null&&Object.hasOwnProperty.call(t,"wantlist")&&ie.Message.Wantlist.encode(t.wantlist,n.uint32(10).fork()).ldelim(),t.blocks!=null&&t.blocks.length)for(var s=0;s<t.blocks.length;++s)n.uint32(18).bytes(t.blocks[s]);if(t.payload!=null&&t.payload.length)for(var s=0;s<t.payload.length;++s)ie.Message.Block.encode(t.payload[s],n.uint32(26).fork()).ldelim();if(t.blockPresences!=null&&t.blockPresences.length)for(var s=0;s<t.blockPresences.length;++s)ie.Message.BlockPresence.encode(t.blockPresences[s],n.uint32(34).fork()).ldelim();return t.pendingBytes!=null&&Object.hasOwnProperty.call(t,"pendingBytes")&&n.uint32(40).int32(t.pendingBytes),n},r.decode=function(t,n){t instanceof xr||(t=xr.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new ie.Message;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:{i.wantlist=ie.Message.Wantlist.decode(t,t.uint32());break}case 2:{i.blocks&&i.blocks.length||(i.blocks=[]),i.blocks.push(t.bytes());break}case 3:{i.payload&&i.payload.length||(i.payload=[]),i.payload.push(ie.Message.Block.decode(t,t.uint32()));break}case 4:{i.blockPresences&&i.blockPresences.length||(i.blockPresences=[]),i.blockPresences.push(ie.Message.BlockPresence.decode(t,t.uint32()));break}case 5:{i.pendingBytes=t.int32();break}default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof ie.Message)return t;var n=new ie.Message;if(t.wantlist!=null){if(typeof t.wantlist!="object")throw TypeError(".Message.wantlist: object expected");n.wantlist=ie.Message.Wantlist.fromObject(t.wantlist)}if(t.blocks){if(!Array.isArray(t.blocks))throw TypeError(".Message.blocks: array expected");n.blocks=[];for(var s=0;s<t.blocks.length;++s)typeof t.blocks[s]=="string"?le.base64.decode(t.blocks[s],n.blocks[s]=le.newBuffer(le.base64.length(t.blocks[s])),0):t.blocks[s].length>=0&&(n.blocks[s]=t.blocks[s])}if(t.payload){if(!Array.isArray(t.payload))throw TypeError(".Message.payload: array expected");n.payload=[];for(var s=0;s<t.payload.length;++s){if(typeof t.payload[s]!="object")throw TypeError(".Message.payload: object expected");n.payload[s]=ie.Message.Block.fromObject(t.payload[s])}}if(t.blockPresences){if(!Array.isArray(t.blockPresences))throw TypeError(".Message.blockPresences: array expected");n.blockPresences=[];for(var s=0;s<t.blockPresences.length;++s){if(typeof t.blockPresences[s]!="object")throw TypeError(".Message.blockPresences: object expected");n.blockPresences[s]=ie.Message.BlockPresence.fromObject(t.blockPresences[s])}}return t.pendingBytes!=null&&(n.pendingBytes=t.pendingBytes|0),n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.blocks=[],s.payload=[],s.blockPresences=[]),n.defaults&&(s.wantlist=null,s.pendingBytes=0),t.wantlist!=null&&t.hasOwnProperty("wantlist")&&(s.wantlist=ie.Message.Wantlist.toObject(t.wantlist,n)),t.blocks&&t.blocks.length){s.blocks=[];for(var i=0;i<t.blocks.length;++i)s.blocks[i]=n.bytes===String?le.base64.encode(t.blocks[i],0,t.blocks[i].length):n.bytes===Array?Array.prototype.slice.call(t.blocks[i]):t.blocks[i]}if(t.payload&&t.payload.length){s.payload=[];for(var i=0;i<t.payload.length;++i)s.payload[i]=ie.Message.Block.toObject(t.payload[i],n)}if(t.blockPresences&&t.blockPresences.length){s.blockPresences=[];for(var i=0;i<t.blockPresences.length;++i)s.blockPresences[i]=ie.Message.BlockPresence.toObject(t.blockPresences[i],n)}return t.pendingBytes!=null&&t.hasOwnProperty("pendingBytes")&&(s.pendingBytes=t.pendingBytes),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},r.getTypeUrl=function(t){return t===void 0&&(t="type.googleapis.com"),t+"/Message"},r.Wantlist=function(){function e(t){if(this.entries=[],t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.entries=le.emptyArray,e.prototype.full=!1,e.encode=function(n,s){if(s||(s=Zo.create()),n.entries!=null&&n.entries.length)for(var i=0;i<n.entries.length;++i)ie.Message.Wantlist.Entry.encode(n.entries[i],s.uint32(10).fork()).ldelim();return n.full!=null&&Object.hasOwnProperty.call(n,"full")&&s.uint32(16).bool(n.full),s},e.decode=function(n,s){n instanceof xr||(n=xr.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new ie.Message.Wantlist;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.entries&&o.entries.length||(o.entries=[]),o.entries.push(ie.Message.Wantlist.Entry.decode(n,n.uint32()));break}case 2:{o.full=n.bool();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof ie.Message.Wantlist)return n;var s=new ie.Message.Wantlist;if(n.entries){if(!Array.isArray(n.entries))throw TypeError(".Message.Wantlist.entries: array expected");s.entries=[];for(var i=0;i<n.entries.length;++i){if(typeof n.entries[i]!="object")throw TypeError(".Message.Wantlist.entries: object expected");s.entries[i]=ie.Message.Wantlist.Entry.fromObject(n.entries[i])}}return n.full!=null&&(s.full=Boolean(n.full)),s},e.toObject=function(n,s){s||(s={});var i={};if((s.arrays||s.defaults)&&(i.entries=[]),s.defaults&&(i.full=!1),n.entries&&n.entries.length){i.entries=[];for(var o=0;o<n.entries.length;++o)i.entries[o]=ie.Message.Wantlist.Entry.toObject(n.entries[o],s)}return n.full!=null&&n.hasOwnProperty("full")&&(i.full=n.full),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.Wantlist"},e.WantType=function(){const t={},n=Object.create(t);return n[t[0]="Block"]=0,n[t[1]="Have"]=1,n}(),e.Entry=function(){function t(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}return t.prototype.block=le.newBuffer([]),t.prototype.priority=0,t.prototype.cancel=!1,t.prototype.wantType=0,t.prototype.sendDontHave=!1,t.encode=function(s,i){return i||(i=Zo.create()),s.block!=null&&Object.hasOwnProperty.call(s,"block")&&i.uint32(10).bytes(s.block),s.priority!=null&&Object.hasOwnProperty.call(s,"priority")&&i.uint32(16).int32(s.priority),s.cancel!=null&&Object.hasOwnProperty.call(s,"cancel")&&i.uint32(24).bool(s.cancel),s.wantType!=null&&Object.hasOwnProperty.call(s,"wantType")&&i.uint32(32).int32(s.wantType),s.sendDontHave!=null&&Object.hasOwnProperty.call(s,"sendDontHave")&&i.uint32(40).bool(s.sendDontHave),i},t.decode=function(s,i){s instanceof xr||(s=xr.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new ie.Message.Wantlist.Entry;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:{a.block=s.bytes();break}case 2:{a.priority=s.int32();break}case 3:{a.cancel=s.bool();break}case 4:{a.wantType=s.int32();break}case 5:{a.sendDontHave=s.bool();break}default:s.skipType(c&7);break}}return a},t.fromObject=function(s){if(s instanceof ie.Message.Wantlist.Entry)return s;var i=new ie.Message.Wantlist.Entry;switch(s.block!=null&&(typeof s.block=="string"?le.base64.decode(s.block,i.block=le.newBuffer(le.base64.length(s.block)),0):s.block.length>=0&&(i.block=s.block)),s.priority!=null&&(i.priority=s.priority|0),s.cancel!=null&&(i.cancel=Boolean(s.cancel)),s.wantType){case"Block":case 0:i.wantType=0;break;case"Have":case 1:i.wantType=1;break}return s.sendDontHave!=null&&(i.sendDontHave=Boolean(s.sendDontHave)),i},t.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(i.bytes===String?o.block="":(o.block=[],i.bytes!==Array&&(o.block=le.newBuffer(o.block))),o.priority=0,o.cancel=!1,o.wantType=i.enums===String?"Block":0,o.sendDontHave=!1),s.block!=null&&s.hasOwnProperty("block")&&(o.block=i.bytes===String?le.base64.encode(s.block,0,s.block.length):i.bytes===Array?Array.prototype.slice.call(s.block):s.block),s.priority!=null&&s.hasOwnProperty("priority")&&(o.priority=s.priority),s.cancel!=null&&s.hasOwnProperty("cancel")&&(o.cancel=s.cancel),s.wantType!=null&&s.hasOwnProperty("wantType")&&(o.wantType=i.enums===String?ie.Message.Wantlist.WantType[s.wantType]:s.wantType),s.sendDontHave!=null&&s.hasOwnProperty("sendDontHave")&&(o.sendDontHave=s.sendDontHave),o},t.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},t.getTypeUrl=function(s){return s===void 0&&(s="type.googleapis.com"),s+"/Message.Wantlist.Entry"},t}(),e}(),r.Block=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.prefix=le.newBuffer([]),e.prototype.data=le.newBuffer([]),e.encode=function(n,s){return s||(s=Zo.create()),n.prefix!=null&&Object.hasOwnProperty.call(n,"prefix")&&s.uint32(10).bytes(n.prefix),n.data!=null&&Object.hasOwnProperty.call(n,"data")&&s.uint32(18).bytes(n.data),s},e.decode=function(n,s){n instanceof xr||(n=xr.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new ie.Message.Block;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.prefix=n.bytes();break}case 2:{o.data=n.bytes();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof ie.Message.Block)return n;var s=new ie.Message.Block;return n.prefix!=null&&(typeof n.prefix=="string"?le.base64.decode(n.prefix,s.prefix=le.newBuffer(le.base64.length(n.prefix)),0):n.prefix.length>=0&&(s.prefix=n.prefix)),n.data!=null&&(typeof n.data=="string"?le.base64.decode(n.data,s.data=le.newBuffer(le.base64.length(n.data)),0):n.data.length>=0&&(s.data=n.data)),s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.prefix="":(i.prefix=[],s.bytes!==Array&&(i.prefix=le.newBuffer(i.prefix))),s.bytes===String?i.data="":(i.data=[],s.bytes!==Array&&(i.data=le.newBuffer(i.data)))),n.prefix!=null&&n.hasOwnProperty("prefix")&&(i.prefix=s.bytes===String?le.base64.encode(n.prefix,0,n.prefix.length):s.bytes===Array?Array.prototype.slice.call(n.prefix):n.prefix),n.data!=null&&n.hasOwnProperty("data")&&(i.data=s.bytes===String?le.base64.encode(n.data,0,n.data.length):s.bytes===Array?Array.prototype.slice.call(n.data):n.data),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.Block"},e}(),r.BlockPresenceType=function(){const e={},t=Object.create(e);return t[e[0]="Have"]=0,t[e[1]="DontHave"]=1,t}(),r.BlockPresence=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.cid=le.newBuffer([]),e.prototype.type=0,e.encode=function(n,s){return s||(s=Zo.create()),n.cid!=null&&Object.hasOwnProperty.call(n,"cid")&&s.uint32(10).bytes(n.cid),n.type!=null&&Object.hasOwnProperty.call(n,"type")&&s.uint32(16).int32(n.type),s},e.decode=function(n,s){n instanceof xr||(n=xr.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new ie.Message.BlockPresence;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.cid=n.bytes();break}case 2:{o.type=n.int32();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof ie.Message.BlockPresence)return n;var s=new ie.Message.BlockPresence;switch(n.cid!=null&&(typeof n.cid=="string"?le.base64.decode(n.cid,s.cid=le.newBuffer(le.base64.length(n.cid)),0):n.cid.length>=0&&(s.cid=n.cid)),n.type){case"Have":case 0:s.type=0;break;case"DontHave":case 1:s.type=1;break}return s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.cid="":(i.cid=[],s.bytes!==Array&&(i.cid=le.newBuffer(i.cid))),i.type=s.enums===String?"Have":0),n.cid!=null&&n.hasOwnProperty("cid")&&(i.cid=s.bytes===String?le.base64.encode(n.cid,0,n.cid.length):s.bytes===Array?Array.prototype.slice.call(n.cid):n.cid),n.type!=null&&n.hasOwnProperty("type")&&(i.type=s.enums===String?ie.Message.BlockPresenceType[n.type]:n.type),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,j.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.BlockPresence"},e}(),r})(),o6={Block:Cr.Wantlist.WantType.Block,Have:Cr.Wantlist.WantType.Have},foe=(r,e)=>Array.prototype.slice.call(e,0).sort((t,n)=>{const s=r(t),i=r(n);return s<i?-1:s>i?1:0});class cc{constructor(e,t){this.set=t?si({system:"ipfs",component:"bitswap",metric:"wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){const s=e.toString(ke),i=this.set.get(s);i?(i.inc(),i.priority=t,i.wantType===o6.Have&&n===o6.Block&&(i.wantType=n)):(this.set.set(s,new D9(e,t,n)),this._stats&&this._stats.push(null,"wantListSize",1))}remove(e){const t=e.toString(ke),n=this.set.get(t);n&&(n.dec(),!n.hasRefs()&&(this.set.delete(t),this._stats&&this._stats.push(null,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){return this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(foe(e=>e[1].key,Array.from(this.set.entries())))}contains(e){const t=e.toString(ke);return this.set.has(t)}get(e){const t=e.toString(ke);return this.set.get(t)}}cc.Entry=D9;const poe=cc.Entry;class nd{constructor(e,t,n,s,i){this.entry=new poe(e,t,n),this.cancel=Boolean(s),this.sendDontHave=Boolean(i)}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(ke)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}}const bo=(r,e)=>{const t=["bitswap"];return e&&t.push(e),r&&t.push(`${r.toString().slice(0,8)}`),Object.assign(Xt(t.join(":")),{error:Xt(t.concat(["error"]).join(":"))})},lf=(r,e)=>{if(r.size!==e.size)return!1;for(const[t,n]of r){const s=e.get(t);if(s===void 0||n instanceof Uint8Array&&s instanceof Uint8Array&&!Dt(n,s)||n instanceof nd&&s instanceof nd&&!n.equals(s))return!1}return!0};class Oe{constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,n,s,i){n==null&&(n=Oe.WantType.Block);const o=e.toString(ke),a=this.wantlist.get(o);a?(a.wantType===n&&(a.priority=t),s&&(a.cancel=Boolean(s)),i&&(a.sendDontHave=Boolean(i)),n===Oe.WantType.Block&&a.wantType===Oe.WantType.Have&&(a.wantType=n)):this.wantlist.set(o,new nd(e,t,n,s,i))}addBlock(e,t){const n=e.toString(ke);this.blocks.set(n,t)}addHave(e){const t=e.toString(ke);this.blockPresences.has(t)||this.blockPresences.set(t,Oe.BlockPresenceType.Have)}addDontHave(e){const t=e.toString(ke);this.blockPresences.has(t)||this.blockPresences.set(t,Oe.BlockPresenceType.DontHave)}cancel(e){const t=e.toString(ke);this.wantlist.delete(t),this.addEntry(e,0,Oe.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),cancel:Boolean(t.cancel)})),full:this.full?!0:void 0},blocks:Array.from(this.blocks.values())};return Cr.encode(e).finish()}serializeToBitswap110(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:Boolean(t.cancel),sendDontHave:Boolean(t.sendDontHave)})),full:this.full?!0:void 0},blockPresences:[],payload:[],pendingBytes:this.pendingBytes};for(const[t,n]of this.blocks.entries()){const s=ve.parse(t),i=s.version,o=s.code,a=s.multihash.code,c=s.multihash.digest.length,u=hoe([i,o,a,c]);e.payload.push(new Cr.Block({prefix:u,data:n}))}for(const[t,n]of this.blockPresences)e.blockPresences.push(new Cr.BlockPresence({cid:ve.parse(t).bytes,type:n}));return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),Cr.encode(e).finish()}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!lf(this.wantlist,e.wantlist)||!lf(this.blocks,e.blocks)||!lf(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){const e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}}Oe.deserialize=async(r,e)=>{const t=Cr.decode(r),n=t.wantlist&&t.wantlist.full||!1,s=new Oe(n);return t.wantlist&&t.wantlist.entries&&t.wantlist.entries.forEach(i=>{if(!i.block)return;const o=ve.decode(i.block);s.addEntry(o,i.priority||0,i.wantType,Boolean(i.cancel),Boolean(i.sendDontHave))}),t.blockPresences&&t.blockPresences.forEach(i=>{if(!i.cid)return;const o=ve.decode(i.cid);i.type===Oe.BlockPresenceType.Have?s.addHave(o):s.addDontHave(o)}),t.blocks.length>0?(await Promise.all(t.blocks.map(async i=>{const o=await cf.digest(i),a=ve.createV0(o);s.addBlock(a,i)})),s):(t.payload.length>0&&(await Promise.all(t.payload.map(async i=>{if(!i.prefix||!i.data)return;const o=doe(i.prefix),a=o[0],c=o[1],u=o[2],l=u===cf.code?cf:e&&await e.getHasher(u);if(!l)throw E(new Error("Unknown hash algorithm"),"ERR_UNKNOWN_HASH_ALG");const d=await l.digest(i.data),f=ve.create(a,c,d);s.addBlock(f,i.data)})),s.setPendingBytes(t.pendingBytes)),s)};Oe.blockPresenceSize=r=>r.bytes.length+1;Oe.Entry=nd;Oe.WantType={Block:Cr.Wantlist.WantType.Block,Have:Cr.Wantlist.WantType.Have};Oe.BlockPresenceType={Have:Cr.BlockPresenceType.Have,DontHave:Cr.BlockPresenceType.DontHave};const goe=3,yoe=Math.pow(2,31)-1,woe=1e3,moe=1;var boe=Eoe;function Eoe(r,e,t){var n=null,s=null,i=function(){n&&(clearTimeout(n),s=null,n=null)},o=function(){var c=s;i(),c&&c()},a=function(){if(!e)return r.apply(this,arguments);var c=this,u=arguments,l=t&&!n;if(i(),s=function(){r.apply(c,u)},n=setTimeout(function(){if(n=null,!l){var d=s;return s=null,d()}},e),l)return s()};return a.cancel=i,a.flush=o,a}class _oe{constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=bo(e,"msgqueue"),this.sendEntries=boe(this._sendEntries.bind(this),moe)}addMessage(e){e.empty||this.send(e)}addEntries(e){this._entries=this._entries.concat(e),this.sendEntries()}_sendEntries(){if(!this._entries.length)return;const e=new Oe(!1);this._entries.forEach(t=>{t.cancel?e.cancel(t.cid):e.addEntry(t.cid,t.priority)}),this._entries=[],this.addMessage(e)}async send(e){try{await this.network.connectTo(this.peerId)}catch(t){this._log.error("cant connect to peer %s: %s",this.peerId.toString(),t.message);return}this._log("sending message to peer %s",this.peerId.toString()),this.network.sendMessage(this.peerId,e).catch(t=>{this._log.error("send error: %s",t.message)})}}class voe{constructor(e,t,n,s){this.peers=si({system:"ipfs",component:"bitswap",metric:"want-manager-peers",metrics:s.metrics}),this.wantlist=new cc(n,s),this.network=t,this._stats=n,this._peerId=e,this._log=bo(e,"want")}_addEntries(e,t,n){const s=e.map((i,o)=>new Oe.Entry(i,yoe-o,Oe.WantType.Block,t));s.forEach(i=>{i.cancel?n?this.wantlist.removeForce(i.cid.toString(ke)):this.wantlist.remove(i.cid):(this._log("adding to wl"),this.wantlist.add(i.cid,i.priority))});for(const i of this.peers.values())i.addEntries(s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t){t.refcnt++;return}t=new _oe(this._peerId,e,this.network);const n=new Oe(!0);for(const s of this.wantlist.entries())n.addEntry(s[1].cid,s[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){const t=this.peers.get(e.toString());t&&(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>this.disconnected(e.peerId))}}const w0="/ipfs/bitswap/1.0.0",m0="/ipfs/bitswap/1.1.0",b0="/ipfs/bitswap/1.2.0",Soe=32,Roe=128,Ioe=3e4;let Aoe=class{constructor(e,t,n,s={}){this._log=bo(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[w0],s.b100Only||(this._protocols.unshift(m0),this._protocols.unshift(b0)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader,this._maxInboundStreams=s.maxInboundStreams??Soe,this._maxOutboundStreams=s.maxOutboundStreams??Roe,this._incomingStreamTimeout=s.incomingStreamTimeout??Ioe}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});const e=L2({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(const t of this._protocols)this._registrarIds.push(await this._libp2p.registrar.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(const e of this._registrarIds)this._libp2p.registrar.unregister(e);this._registrarIds=[]}}_onConnection({stream:e,connection:t}){if(!this._running)return;const n=new $e.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",e.stat.protocol,t.remotePeer),await ne(Ps(e.source,n.signal),Gr(),async s=>{for await(const i of s){try{const o=await Oe.deserialize(i.subarray(),this._hashLoader);await this._bitswap._receiveMessage(t.remotePeer,o)}catch(o){this._bitswap._receiveError(o);break}n.reset()}})}).catch(s=>{this._log(s),e.abort(s)}).finally(()=>{n.clear(),e.close()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){const n=[];let s=0;for await(const i of this.findProviders(e,t))if(this._log(`connecting to provider ${i.id}`),n.push(this.connectTo(i.id,t).catch(o=>{this._log.error(o)})),s++,s===goe)break;await Promise.all(n)}async provide(e,t){await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t){if(!this._running)throw new Error("network isn't running");const n=e.toString();this._log("sendMessage to %s",n,t);const i=await(await this._libp2p.dial(e)).newStream([b0,m0,w0]);await Coe(i,t,this._log),this._updateSentStats(e,t.blocks)}async connectTo(e,t){if(!this._running)throw new Error("network isn't running");return this._libp2p.dial(e,t)}_updateSentStats(e,t){const n=e.toString();if(this._stats){for(const s of t.values())this._stats.push(n,"dataSent",s.length);this._stats.push(n,"blocksSent",t.size)}}};async function Coe(r,e,t){try{let n;switch(r.stat.protocol){case w0:n=e.serializeToBitswap100();break;case m0:case b0:n=e.serializeToBitswap110();break;default:throw new Error("Unknown protocol: "+r.stat.protocol)}await ne([n],Dr(),r)}catch(n){t(n)}finally{r.close()}}class Toe{constructor(e){this.partner=e,this.wantlist=new cc,this.exchangeCount=0,this.sentToPeer=new Map,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}class P9 extends Map{constructor(e,t){super(),this._cmp=t||this._defaultSort,this._keys=[];for(const[n,s]of e||[])this.set(n,s)}update(e){if(e<0||e>=this._keys.length)return;const t=this._keys[e];this._keys.splice(e,1);const n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){const s=this.indexOf(e);this._keys.splice(s,1)}super.set(e,t);const n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;const t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;const t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){const s=t+n>>>1,i=this._kCmp(this._keys[s],e);if(i<0)t=s+1;else if(i>0)n=s;else return s}return t}*keys(){for(const e of this._keys)yield e}*values(){for(const e of this._keys)yield this.get(e)}*entries(){for(const e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t){if(e)for(const n of this._keys)e.apply(t,[[n,this.get(n)]])}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}}const Doe={hasNewInfo(){return!1},merge(){}};class Poe{constructor(e=Doe){this._taskMerger=e,this._byPeer=new P9([],a6.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n||(n=new a6(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){const t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};const{tasks:n,pendingSize:s}=t.popTasks(e);if(n.length===0)return{tasks:n,pendingSize:s};const i=t.peerId;return t.isIdle()?this._byPeer.delete(i.toString()):this._byPeer.update(0),{peerId:i,tasks:n,pendingSize:s}}_head(){if(this._byPeer.size!==0)for(const[,e]of this._byPeer)return e}remove(e,t){const n=this._byPeer.get(t.toString());n&&n.remove(e)}tasksDone(e,t){const n=this._byPeer.get(e.toString());if(!n)return;const s=this._byPeer.indexOf(e.toString());for(const i of t)n.taskDone(i);this._byPeer.update(s)}}class a6{constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new koe,this._active=new Set}pushTasks(e){for(const t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;const t=this._pending.get(e.topic);if(t){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){const t=[];for(const n of this._active)n.topic===e.topic&&t.push(n);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0;const n=[],s=this._pending.tasks();for(let i=0;i<s.length&&t<e;i++){const o=s[i];n.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}}class koe{constructor(){this._tasks=new P9([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return(this._tasks.get(e)||{}).task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){const n=this._tasks.get(e);if(!n)return;const s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}}const Ooe={hasNewInfo(r,e){let t=!1,n=!1;for(const s of e)s.data.haveBlock&&(t=!0),s.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!t&&r.data.haveBlock)},merge(r,e){const t=r.data,n=e.data;!n.haveBlock&&t.haveBlock&&(n.haveBlock=t.haveBlock,n.blockSize=t.blockSize),!n.isWantBlock&&t.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||t.haveBlock)&&(n.haveBlock=t.haveBlock,e.size=r.size)),n.isWantBlock&&n.haveBlock&&(e.size=n.blockSize)}},c6=Oe.WantType,Noe=16*1024,xoe=1024;class $oe{constructor(e,t,n,s,i,o={}){this._log=bo(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=si({system:"ipfs",component:"bitswap",metric:"ledger-map",metrics:i.metrics}),this._running=!1,this._requestQueue=new Poe(Ooe)}_processOpts(e){return{maxSizeReplaceHasWithBlock:xoe,targetMessageSize:Noe,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks()})}async _processTasks(){if(!this._running)return;const{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;const s=new Oe(!1);s.setPendingBytes(n);const i=[],o=new Map;for(const c of t){const u=ve.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(i.push(u),o.set(c.topic,c.data)):s.addHave(u):s.addDontHave(u)}const a=await this._getBlocks(i);for(const[c,u]of o){const l=ve.parse(c),d=a.get(c);d?s.addBlock(l,d):u.sendDontHave&&s.addDontHave(l)}if(s.empty){e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e&&await this.network.sendMessage(e,s);for(const[c,u]of a.entries())e&&this.messageSent(e,ve.parse(c),u)}catch(c){this._log.error(c)}e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}:null}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(e.length){for(const t of this.ledgerMap.values())for(const n of e){const s=t.wantlistContains(n.cid);if(!s)continue;const i=n.data.length,o=this._sendAsBlock(s.wantType,i);let a=i;o||(a=Oe.blockPresenceSize(s.cid)),this._requestQueue.pushTasks(t.partner,[{topic:s.cid.toString(ke),priority:s.priority,size:a,data:{blockSize:i,isWantBlock:o,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){const n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new cc),this._updateBlockAccounting(t.blocks,n),t.wantlist.size===0){this._scheduleProcessTasks();return}const s=[],i=[];t.wantlist.forEach(o=>{o.cancel?(n.cancelWant(o.cid),s.push(o.cid)):(n.wants(o.cid,o.priority,o.wantType),i.push(o))}),this._cancelWants(e,s),await this._addWants(e,i),this._scheduleProcessTasks()}_cancelWants(e,t){for(const n of t)this._requestQueue.remove(n.toString(ke),e)}async _addWants(e,t){const n=await this._getBlockSizes(t.map(i=>i.cid)),s=[];for(const i of t){const o=i.cid.toString(ke),a=n.get(o);if(a==null)i.sendDontHave&&s.push({topic:o,priority:i.priority,size:Oe.blockPresenceSize(i.cid),data:{isWantBlock:i.wantType===c6.Block,blockSize:0,haveBlock:!1,sendDontHave:i.sendDontHave}});else{const c=this._sendAsBlock(i.wantType,a);let u=a;c||(u=Oe.blockPresenceSize(i.cid)),s.push({topic:o,priority:i.priority,size:u,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:i.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===c6.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){const t=await this._getBlocks(e);return new Map([...t].map(([n,s])=>[n,s.length]))}async _getBlocks(e){const t=new Map;return await Promise.all(e.map(async n=>{try{const s=await this.blockstore.get(n);t.set(n.toString(ke),s)}catch(s){s.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,s)}})),t}_updateBlockAccounting(e,t){for(const n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){const s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){const t=e.toString(),n=this.ledgerMap.get(t);if(n)return n;const s=new Toe(e);return this.ledgerMap.set(t,s),this._stats&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}}const l6=r=>`unwant:${q(r.multihash.bytes,"base64")}`,u6=r=>`block:${q(r.multihash.bytes,"base64")}`;class Loe extends Se.EventEmitter{constructor(e){super(),this.setMaxListeners(woe),this._log=bo(e,"notif")}hasBlock(e,t){const n=u6(e);this._log(n),this.emit(n,t)}wantBlock(e,t={}){if(!e)throw new Error("Not a valid cid");const n=u6(e),s=l6(e);return this._log(`wantBlock:${e}`),new Promise((i,o)=>{const a=()=>{this.removeListener(n,c),o(new Error(`Block for ${e} unwanted`))},c=u=>{this.removeListener(s,a),i(u)};this.once(s,a),this.once(n,c),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(s,a),o(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){const t=l6(e);this._log(t),this.emit(t)}}var sd={},Moe={get exports(){return sd},set exports(r){sd=r}};(function(r,e){const t=Math.exp;r.exports=function(s){if(typeof s!="number")throw new Error("must provide a timespan to the moving average constructor");if(s<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let i,o=0,a=0,c=0,u,l={};function d(f,g){return 1-t(-(f-g)/s)}return l.push=function(g,h){if(u){const p=d(g,u),w=h-i,y=p*w;i=p*h+(1-p)*i,o=(1-p)*(o+w*y),a=Math.sqrt(o),c=i+p*w}else i=h;u=g},l.movingAverage=function(){return i},l.variance=function(){return o},l.deviation=function(){return a},l.forecast=function(){return c},l}})(Moe);class d6 extends Se.EventEmitter{constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(s=>{(this._movingAverages[n][s]=sd(s)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._disabled=!0}stop(){this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){const e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=null,this._queue.length){let e;for(;this._queue.length;){const t=e=this._queue.shift();t&&this._applyOp(t)}e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){const t=e-this._frequencyLastTime;t&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){const s=this._frequencyAccumulators[e]||0;this._frequencyAccumulators[e]=0;const i=s/t*1e3;let o=this._movingAverages[e];o||(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c||(c=o[a]=sd(a)),c.push(n,i)})}_applyOp(e){const t=e[0],n=e[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]||(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}}const h6={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]};class Uoe extends Se.EventEmitter{constructor(e,t=[],n=h6){super();const s=Object.assign({},h6,n);if(typeof s.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof s.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new d6(t,s),this._global.on("update",i=>this.emit("update",i)),this._peers=si({system:"ipfs",component:"bitswap",metric:"stats-peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(const e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){const t=typeof e!="string"&&e.toString?e.toString():`${e}`;return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e)){let s=this._peers.get(e);s||(s=new d6(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){const t=e.toString(),n=this._peers.get(t);n&&(n.stop(),this._peers.delete(t))}}const Boe={statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},zoe=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"];class Foe extends x2{constructor(e,t,n={}){super(),this._libp2p=e,this._log=bo(this.peerId),this._options=Object.assign({},Boe,n),this._stats=new Uoe(e,zoe,{enabled:this._options.statsEnabled,computeThrottleTimeout:this._options.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:this._options.statsComputeThrottleMaxQueueSize}),this.network=new Aoe(e,this,this._stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new $oe(this.peerId,t,this.network,this._stats,e),this.wm=new voe(this.peerId,this.network,this._stats,e),this.notifications=new Loe(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;const n=[];for(const[s,i]of t.blocks.entries()){const o=ve.parse(s);n.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:i})}this.wm.cancelWants(n.filter(({wasWanted:s})=>s).map(({cid:s})=>s)),await Promise.all(n.map(({cid:s,wasWanted:i,data:o})=>this._handleReceivedBlock(e,s,o,i)))}async _handleReceivedBlock(e,t,n,s){this._log("received block");const i=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,i),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this._stats.push(e,"blocksReceived",1),this._stats.push(e,"dataReceived",n.length),s&&(this._stats.push(e,"dupBlksReceived",1),this._stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError: %s",e.message)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this._stats.disconnected(e)}enableStats(){this._stats.enable()}disableStats(){this._stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async get(e,t={}){const n=(c,u)=>(this.wm.wantBlocks([c],u),this.notifications.wantBlock(c,u));let s=!1;const i=async(c,u)=>{try{return await this.blockstore.get(c,u)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l;return s||(s=!0,this.network.findAndConnect(c,u).catch(d=>this._log.error(d))),n(c,u)}},o=new AbortController,a=t.signal?Jr([t.signal,o.signal]):o.signal;try{return await Promise.race([this.notifications.wantBlock(e,{signal:a}),i(e,{signal:a})])}finally{o.abort()}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}unwant(e){const t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(n=>this.notifications.unwantBlock(n))}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this._sendHaveBlockNotifications(e,t)}async*putMany(e,t){for await(const{key:n,value:s}of this.blockstore.putMany(e,t))this._sendHaveBlockNotifications(n,s),yield{key:n,value:s}}_sendHaveBlockNotifications(e,t){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,data:t}]),this.network.provide(e).catch(n=>{this._log.error("Failed to provide: %s",n.message)})}getWantlist(){return this.wm.wantlist.entries()}peers(){return this.engine.peers()}stat(){return this._stats}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this._stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}unwrap(){return this.blockstore}}const Voe=(r,e,t={})=>new Foe(r,e,t);function joe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,_=h.length;y!==_&&h[y]===0;)y++,p++;for(var b=(_-y)*l+1>>>0,m=new Uint8Array(b);y!==_;){for(var S=h[y],R=0,v=b-1;(S!==0||R<w)&&v!==-1;v--,R++)S+=256*m[v]>>>0,m[v]=S%a>>>0,S=S/a>>>0;if(S!==0)throw new Error("Non-zero carry");w=R,y++}for(var A=b-w;A!==b&&m[A]===0;)A++;for(var C=c.repeat(p);A<b;++A)C+=r.charAt(m[A]);return C}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var _=(h.length-p)*u+1>>>0,b=new Uint8Array(_);h[p];){var m=t[h.charCodeAt(p)];if(m===255)return;for(var S=0,R=_-1;(m!==0||S<y)&&R!==-1;R--,S++)m+=a*b[R]>>>0,b[R]=m%256>>>0,m=m/256>>>0;if(m!==0)throw new Error("Non-zero carry");y=S,p++}if(h[p]!==" "){for(var v=_-y;v!==_&&b[v]===0;)v++;for(var A=new Uint8Array(w+(_-v)),C=w;v!==_;)A[C++]=b[v++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Koe=joe,qoe=Koe;const Hoe=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};class Goe{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Woe{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return k9(this,e)}}class Yoe{constructor(e){this.decoders=e}or(e){return k9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const k9=(r,e)=>new Yoe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class Qoe{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Goe(e,t,n),this.decoder=new Woe(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const O9=({name:r,prefix:e,encode:t,decode:n})=>new Qoe(r,e,t,n),N9=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=qoe(t,e);return O9({prefix:r,name:e,encode:n,decode:i=>Hoe(s(i))})},Joe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Xoe=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},jn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>O9({prefix:e,name:r,encode(s){return Xoe(s,n,t)},decode(s){return Joe(s,n,t,r)}});jn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});jn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});jn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});jn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});jn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});jn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});jn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});jn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});jn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});N9({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});N9({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});class Zoe extends x2{constructor(e,t){super(),this.child=e,this.bitswap=t}open(){return this.child.open()}close(){return this.child.close()}unwrap(){return this.child}async put(e,t,n={}){await this.has(e)||(this.bitswap.isStarted()?await this.bitswap.put(e,t,n):await this.child.put(e,t,n))}async*putMany(e,t={}){const n=Ze(e,async({key:s})=>!await this.has(s));this.bitswap.isStarted()?yield*this.bitswap.putMany(n,t):yield*this.child.putMany(n,t)}async get(e,t={}){return!await this.has(e)&&this.bitswap.isStarted()?this.bitswap.get(e,t):this.child.get(e,t)}async*getMany(e,t={}){const n=dr({objectMode:!0}),s=dr({objectMode:!0});Promise.resolve().then(async()=>{for await(const i of e)!await this.has(i)&&this.bitswap.isStarted()?n.push(i):s.push(i);n.end(),s.end()}),yield*qt(this.bitswap.getMany(n,t),this.child.getMany(s,t))}async delete(e,t){await this.child.delete(e,t)}async*deleteMany(e,t){yield*this.child.deleteMany(e,t)}async has(e,t={}){return this.child.has(e,t)}async*query(e,t={}){yield*this.child.query(e,t)}async*queryKeys(e,t={}){yield*this.child.queryKeys(e,t)}}class mp{constructor(e,t,n,s,i){this.peerId=e,this.libp2p=t,this.bitswap=n,this.repo=s,this.blockstore=i}static async start({peerId:e,repo:t,print:n,hashers:s,options:i}){t.closed&&await t.open();const o=await t.config.getAll(),a=await pp({options:i,repo:t,peerId:e,multiaddrs:eae(e,o),config:o,keychainConfig:void 0});await a.start();for(const l of a.getMultiaddrs())n(`Swarm listening on ${l.toString()}`);const c=Voe(a,t.blocks,{statsEnabled:!0,hashLoader:s,maxInboundStreams:1024,maxOutboundStreams:1024});await c.start();const u=new Zoe(t.blocks,c);return t.blocks=u,t.pins.blockstore=u,new mp(e,a,c,t,u)}static async stop(e){e.repo.blocks=e.blockstore.unwrap(),e.repo.pins.blockstore=e.blockstore.unwrap(),await e.bitswap.stop(),await e.libp2p.stop()}}const eae=(r,e)=>{const t=r.toString(),n=[],s=e.Addresses&&e.Addresses.Swarm||[];for(const i of s){let o=X(i);if(o.protoCodes().includes(tae))throw E(new Error("websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779"),"ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED");const a=o.getPeerId();a&&a!==t&&(o=o.encapsulate(`/p2p/${t}`)),n.push(o)}return n},tae=479;function rae({network:r}){async function e(t={}){const n=[],{libp2p:s}=await r.use(t);return await s.peerStore.forEach(i=>{n.push({id:i.id,addrs:i.addresses.map(o=>o.multiaddr)})}),n}return x(e)}function nae({network:r}){async function e(t,n={}){const{libp2p:s}=await r.use(n);await s.dial(t,n)}return x(e)}function sae({network:r}){async function e(t,n={}){const{libp2p:s}=await r.use(n);await s.hangUp(t)}return x(e)}function iae({network:r}){async function e(t={}){const{libp2p:n}=await r.use(t);return n.getMultiaddrs()}return x(e)}function oae({network:r}){async function e(t={}){const{libp2p:n}=await r.use(t);if(t.verbose){const i=[];for(const o of n.getConnections()){const a={addr:o.remoteAddr,peer:o.remotePeer};(t.verbose||t.direction)&&(a.direction=o.stat.direction),t.verbose&&(a.muxer=o.stat.multiplexer,a.latency="n/a",a.streams=[]),i.push(a)}return i}const s=new Map;for(const i of n.getConnections()){const o={addr:i.remoteAddr,peer:i.remotePeer};s.set(i.remotePeer.toString(),o)}return Array.from(s.values())}return x(e)}class aae{constructor({network:e}){this.addrs=rae({network:e}),this.connect=nae({network:e}),this.disconnect=sae({network:e}),this.localAddrs=iae({network:e}),this.peers=oae({network:e})}}const ea={success:!0,time:0,text:""};function cae({network:r}){async function*e(t,n={}){const{libp2p:s}=await r.use();n.count=n.count||10;const i=await s.peerStore.get(t);let o=i&&i.id;if(!o){yield{...ea,text:`Looking up peer ${t}`};const u=await s.peerRouting.findPeer(t);o=u&&u.id}if(!o)throw new Error("Peer was not found");yield{...ea,text:`PING ${o.toString()}`};let a=0,c=0;for(let u=0;u<n.count;u++)try{const l=await s.ping(o);c+=l,a++,yield{...ea,time:l}}catch(l){yield{...ea,success:!1,text:l.toString()}}if(a){const u=c/a;yield{...ea,text:`Average latency: ${u}ms`}}}return x(e)}const uf="/ipns/";function f6(r){r.startsWith(uf)&&(r=r.substring(uf.length));let e;if((r[0]==="1"||r[0]==="Q")&&(r=`z${r}`),r[0]==="z"&&(e=Ht.decode(r)),r[0]==="k"&&(e=$l.decode(r)),!e)throw new Error("Could not parse string");if(e[0]!==1&&e[1]!==114&&(e=Jt([[1,114],e])),e.length!==40)throw new Error("Incorrect length "+e.length);return Jt([M(uf),e.subarray(2)])}function lae({network:r,repo:e,peerId:t}){const{get:n,put:s,findProvs:i,findPeer:o,provide:a,query:c}={async*get(u,l={}){const{libp2p:d}=await Ii(r,t,l),f=u instanceof Uint8Array?u:f6(u);if(d.dht==null)throw E(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.get(f,l)},async*put(u,l,d){const{libp2p:f}=await Ii(r,t,d),g=u instanceof Uint8Array?u:f6(u);if(f.dht==null)throw E(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*f.dht.put(g,l,d)},async*findProvs(u,l={}){const{libp2p:d}=await Ii(r,t,l);if(d.dht==null)throw E(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.findProviders(u,{signal:l.signal})},async*findPeer(u,l={}){const{libp2p:d}=await Ii(r,t,l);if(d.dht==null)throw E(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.findPeer(u,{signal:l.signal})},async*provide(u,l={recursive:!1}){const{libp2p:d}=await Ii(r,t,l);if(!await e.blocks.has(u))throw E(new Error("block(s) not found locally, cannot provide"),"ERR_BLOCK_NOT_FOUND");if(l.recursive)throw E(new Error("not implemented yet"),"ERR_NOT_IMPLEMENTED_YET");if(d.dht==null)throw E(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.provide(u)},async*query(u,l={}){const{libp2p:d}=await Ii(r,t,l);let f;const g=V.asCID(u);if(g!=null?f=g.multihash.bytes:f=re(u.toString()).toBytes(),d.dht==null)throw E(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.getClosestPeers(f,l)}};return{get:x(n),put:x(s),findProvs:x(i),findPeer:x(o),provide:x(a),query:x(c)}}const Ii=async(r,e,t)=>{const n=await r.use(t);if(n.libp2p.dht!=null)return n;{const s=async function*(){yield{from:e,name:"QUERY_ERROR",type:3,error:new lo("dht not enabled")}};return{libp2p:{dht:{get:s,put:s,findProviders:s,findPeer:s,provide:s,getClosestPeers:s}}}}};function uae({network:r,config:e}){const t=oe(e||{},"Pubsub.Enabled",!0),n={};let s;return{subscribe:t?x(i):ta,unsubscribe:t?x(o):ta,publish:t?x(a):ta,ls:t?x(c):ta,peers:t?x(u):ta};async function i(l,d,f={}){const{libp2p:g}=await r.use(f);g.pubsub.subscribe(l),s==null&&(s=h=>{const p=h.detail;n[p.topic]&&n[p.topic].forEach(w=>{if(typeof w=="function"){w(p);return}w!=null&&w.handleEvent!=null&&w.handleEvent(p)})},g.pubsub.addEventListener("message",s)),d!=null&&(n[l]==null&&(n[l]=[]),n[l].push(d))}async function o(l,d,f={}){const{libp2p:g}=await r.use(f);d!=null&&n[l]!=null&&(n[l]=n[l].filter(h=>h!==d),n[l].length===0&&delete n[l]),typeof d!="function"&&delete n[l],n[l]==null&&g.pubsub.unsubscribe(l),Object.keys(n).length===0&&(g.pubsub.removeEventListener("message",s),s=void 0)}async function a(l,d,f={}){const{libp2p:g}=await r.use(f);if(!d)throw E(new Error('argument "data" is required'),"ERR_ARG_REQUIRED");await g.pubsub.publish(l,d)}async function c(l={}){const{libp2p:d}=await r.use(l);return d.pubsub.getTopics()}async function u(l,d={}){const{libp2p:f}=await r.use(d);return f.pubsub.getSubscribers(l)}}const ta=async()=>{throw new lo("pubsub not enabled")},dae=Le.bind({ignoreUndefined:!0}),Yn=O("ipfs"),hae=3e4;class fae{constructor({print:e,storage:t,codecs:n,options:s}){const{peerId:i,repo:o,keychain:a}=t,c=_r.create(mp),u=EU(s.preload),l=NC(),d=xC({network:c}),f=new iD(s),g=Object.values(qI);(s.ipld&&s.ipld.hashers?s.ipld.hashers:[]).forEach(Q=>g.push(Q)),this.hashers=new Y7({hashers:g,loadHasher:s.ipld&&s.ipld.loadHasher});const h=Object.values(KI);(s.ipld&&s.ipld.bases?s.ipld.bases:[]).forEach(Q=>h.push(Q)),this.bases=new G7({bases:h,loadBase:s.ipld&&s.ipld.loadBase});const p=new VC({repo:o,codecs:n}),w=new FD({codecs:n,hashers:this.hashers,preload:u,repo:o}),y=new wD({dns:l,ipns:f,repo:o,codecs:n,peerId:i,isOnline:d,keychain:a,options:s}),_=$C({repo:o,codecs:n,bases:this.bases,name:y}),b=new pU({repo:o,codecs:n,hashers:this.hashers,preload:u}),m=Object.assign(bD({repo:o,codecs:n,resolve:_,preload:u}),{local:ID({repo:t.repo})}),{add:S,addAll:R,cat:v,get:A,ls:C}=new zL({preload:u,repo:o,options:s.EXPERIMENTAL,hashers:this.hashers}),P=LB({repo:o,preload:u,hashers:this.hashers,options:s}),$=_U({files:P,preload:u,options:s.preload});this.preload=u,this.name=y,this.ipns=f,this.pin=p,this.resolve=_,this.block=w,this.refs=m,this.start=IC({network:c,peerId:i,repo:o,preload:u,ipns:f,mfsPreload:$,print:e,keychain:a,hashers:this.hashers,options:s}),this.stop=AC({network:c,preload:u,mfsPreload:$,ipns:f,repo:o}),this.dht=lae({network:c,repo:o,peerId:i}),this.pubsub=uae({network:c,config:s.config}),this.dns=l,this.isOnline=d,this.id=qL({network:c,peerId:i}),this.version=jL({repo:o}),this.bitswap=new DD({network:c}),this.bootstrap=new $D({repo:o}),this.config=QL({repo:o}),this.ping=cae({network:c}),this.add=S,this.addAll=R,this.cat=v,this.get=A,this.ls=C,this.dag=b,this.files=P,this.key=new KB({keychain:a}),this.object=new ez({preload:u,codecs:n,repo:o}),this.repo=new sz({repo:o,hashers:this.hashers}),this.stats=new oz({repo:o,network:c}),this.swarm=new aae({network:c}),Object.defineProperty(this,"libp2p",{get(){const Q=c.try();return Q?Q.libp2p:void 0}});const F=()=>Promise.reject(E(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")),W=async function*(){throw E(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")};this.commands=F,this.diag={cmds:F,net:F,sys:F},this.log={level:F,ls:F,tail:W},this.mount=F,this.codecs=n}async init(){throw new Zs}}const pae=async r=>{const e=Re({Data:new Ce({type:"directory"}).marshal(),Links:[]}),t=await r.block.put(e,{mhtype:"sha2-256",format:"dag-pb"});return await r.pin.add(t),t},gae=()=>({start:!0,EXPERIMENTAL:{},preload:{enabled:!Ds.isTest,addresses:["/dns4/node0.preload.ipfs.io/https","/dns4/node1.preload.ipfs.io/https","/dns4/node2.preload.ipfs.io/https","/dns4/node3.preload.ipfs.io/https"]}});async function yae(r={}){r=dae(gae(),r);const e=r.init||{},t={name:kf.name,code:kf.code,encode:u=>u,decode:u=>u},n=Object.values(HI);[ks,$6,q6,e8,t].concat(r.ipld&&r.ipld.codecs||[]).forEach(u=>n.push(u));const s=new W7({codecs:n,loadCodec:r.ipld&&r.ipld.loadCodec}),i=r.silent?Yn:console.log;Yn("creating repo");const o=await gp.start(i,s,r);Yn("getting repo config");const a=await o.repo.config.getAll(),c=new fae({storage:o,print:i,codecs:s,options:{...r,config:a}});if(Yn("starting preload"),await c.preload.start(),Yn("starting storage"),c.ipns.startOffline(o),o.isNew&&!e.emptyRepo){const u=await pae(c);if(Yn("adding default assets"),await(c.addAll,void 0),Yn("initializing IPNS keyspace"),o.peerId.publicKey==null)throw E(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");const l=new $e.TimeoutController(hae);try{await c.ipns.initializeKeyspace(o.peerId,M(`/ipfs/${u}`),{signal:l.signal})}finally{l.clear()}}return r.start!==!1&&(Yn("starting node"),await c.start()),c}const wae=yae,mae=wE,bae=eJ;function Eae(){throw new Error("Not supported in browsers")}const Tue=wae,Due=mae,Pue=bae,kue=Eae;export{Tue as create,Due as globSource,kue as path,Pue as urlSource};
//# sourceMappingURL=index-ad6376b5.js.map
